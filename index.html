<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Connect - Professional</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1523.0/aws-sdk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
<script src="https://js.paystack.co/v1/inline.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- PROFESSIONAL CSS VARIABLES & RESET --- */
        :root {
            --primary: #ff4b7d;
            --secondary: #6c5ce7;
            --bg: #f0f2f5;
            --white: #ffffff;
            --dark: #1a1a1a;
            --gray: #888888;
            --danger: #ff4757;
            --nav-height: 65px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); height: 100vh; width: 100vw; overflow: hidden; display: flex; justify-content: center; }
        #app-frame { width: 100%; height: 100%; background: var(--white); position: relative; overflow: hidden; max-width: 500px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* --- PAGE MANAGEMENT --- */
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); display: none; flex-direction: column; overflow-y: auto; padding-bottom: var(--nav-height); animation: fadeIn 0.3s ease; }
        .page.active { display: flex; z-index: 10; }
        .page.full-screen { padding-bottom: 0; z-index: 100; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- COMMON UI ELEMENTS --- */
        .btn { width: 90%; padding: 15px; border-radius: 30px; border: none; font-size: 16px; font-weight: bold; margin: 10px auto; cursor: pointer; display: block; text-align: center; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(255, 75, 125, 0.3); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-google { background: white; border: 1px solid #ddd; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .input-box { width: 90%; padding: 15px; margin: 10px auto; border: 1px solid #eee; border-radius: 15px; background: #f9f9f9; font-size: 16px; display: block; }
        textarea.input-box { resize: none; }
        .hidden { display: none !important; }

        /* --- NAV BARS --- */
        .top-nav { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: white; z-index: 50; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .bottom-nav { height: var(--nav-height); position: absolute; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 50; }
        .nav-item { font-size: 24px; color: #ccc; cursor: pointer; position: relative; padding: 10px; }
        .nav-item.active { color: var(--primary); }
        .badge { position: absolute; top: 5px; right: 5px; background: red; color: white; font-size: 10px; padding: 3px 6px; border-radius: 50%; }

        /* --- PAGE SPECIFIC STYLES --- */
        #landing-page { justify-content: center; align-items: center; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .welcome-box { text-align: center; padding: 20px; color: white; }
        .welcome-box img { width: 120px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .onboard-header { padding: 20px; text-align: center; }
        .progress-bar { width: 100%; height: 5px; background: #eee; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; }

        .card-stack { flex: 1; position: relative; padding: 10px; display: flex; justify-content: center; overflow: hidden; }
        .user-card { width: 100%; height: 100%; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: #000; }
        .user-card img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); color: white; padding: 20px; padding-bottom: 30px; }
        .card-actions { position: absolute; bottom: 100px; right: 20px; display: flex; flex-direction: column; gap: 15px; }
        .action-btn { width: 50px; height: 50px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.2); cursor: pointer; transition: 0.2s; }
        .action-btn:active { transform: scale(0.9); }
        
        .settings-list { flex: 1; overflow-y: auto; }
        .settings-item { padding: 15px 20px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 16px; }
        .settings-item:hover { background: #f9f9f9; }
        .settings-category { font-weight: 700; color: var(--primary); margin: 25px 0 10px; padding-left: 20px; text-transform: uppercase; font-size: 13px; letter-spacing: 1px; }
        .list-item { display: flex; padding: 15px; border-bottom: 1px solid #f0f0f0; align-items: center; cursor: pointer; }
        .list-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        
                /* --- CHAT ROOM & MESSAGES --- */
        #chat-room { 
            background-color: #e5ddd5; /* Fallback color */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background: transparent !important; /* ðŸŒŸ Remove solid color to fix the "line" */
        }
        
        .message { max-width: 75%; padding: 10px 15px; border-radius: 15px; position: relative; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .message.sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .message.received { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .message-img { width: 100%; border-radius: 10px; margin-top: 5px; }

        /* --- INPUT AREA --- */
        .chat-input-area { 
            background: rgba(255, 255, 255, 0.9); /* ðŸŒŸ Semi-transparent for modern feel */
            padding: 10px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-top: 1px solid rgba(0,0,0,0.05); /* Subtle divider */
            backdrop-filter: blur(10px); 
        }
        .chat-btn { color: var(--primary); font-size: 22px; cursor: pointer; padding: 5px; }

        /* --- CALL OVERLAYS --- */
        #call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 200; display: none; flex-direction: column; }
        #remoteVideo { width: 100%; flex: 1; object-fit: cover; }
        #localVideo { position: absolute; bottom: 100px; right: 20px; width: 120px; height: 160px; background: #000; border: 2px solid white; border-radius: 10px; object-fit: cover; z-index: 210; }
        .call-controls { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 220; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 24px; cursor: pointer; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); }
        .call-btn.hangup { background: var(--danger); }
        .call-info { position: absolute; top: 50px; width: 100%; text-align: center; color: white; z-index: 210; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        
        #incoming-call-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .caller-avatar { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 20px; border: 3px solid var(--primary); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 125, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 75, 125, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 125, 0); } }

        .disclaimer { background: #fff3cd; color: #856404; padding: 10px; font-size: 12px; text-align: center; border-bottom: 1px solid #ffeeba; }

        /* --- NEW VOICE NOTE & VIEW ONCE STYLES --- */
        .recording-ui { display: none; flex: 1; align-items: center; gap: 15px; animation: fadeIn 0.2s; }
        .recording-active .text-ui { display: none; }
        .recording-active .recording-ui { display: flex; }
        .rec-dot { width: 10px; height: 10px; background: red; border-radius: 50%; animation: pulse 1s infinite; }
        .view-once-active { border-color: var(--primary) !important; color: var(--primary) !important; background: rgba(255, 75, 125, 0.1); }

        /* Message Bubble for View Once */
        .view-once-bubble { display: flex; align-items: center; gap: 10px; padding: 5px; cursor: pointer; }
        .view-once-icon { border: 2px solid #888; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
        .message.sent .view-once-icon { border-color: #555; }

        /* CUSTOM AUDIO PLAYER (Like Screenshot) */
        .audio-player { display: flex; align-items: center; gap: 10px; padding: 5px 0; min-width: 200px; }
        .audio-avatar-container { position: relative; width: 40px; height: 40px; flex-shrink: 0; }
        .audio-avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .audio-mic-badge { position: absolute; bottom: -2px; right: -2px; background: var(--secondary); color: white; width: 16px; height: 16px; border-radius: 50%; font-size: 9px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }

        .audio-controls { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 5px; }
        .audio-top { display: flex; align-items: center; gap: 10px; }
        .play-pause-btn { cursor: pointer; color: #555; font-size: 18px; width: 20px; text-align: center; }
        .audio-slider-container { flex: 1; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; position: relative; overflow: hidden; }
        .audio-slider-fill { height: 100%; background: #555; width: 0%; transition: width 0.1s linear; }

        /* Adjust colors for Sent messages */
        .message.sent .play-pause-btn { color: #333; }
        .message.sent .audio-slider-fill { background: #333; }
        .message.sent .audio-mic-badge { background: #00C853; }

        /* Locked Mic Animation */
        .mic-locked { transform: translateY(-50px); transition: 0.3s; background: var(--primary); color: white; padding: 15px; border-radius: 50%; }
        
        /* Online Dot for Chat List */
        .online-dot { width: 12px; height: 12px; background: #00C853; border-radius: 50%; border: 2px solid white; position: absolute; bottom: 0; right: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .chat-online-text { font-size: 11px; color: #00C853; font-weight: bold; animation: fadeIn 0.5s; }
        /* --- BOT STYLES --- */
.bot-badge {
    background: #5865F2; /* Discord/Telegram Blue */
    color: white;
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 5px;
    vertical-align: middle;
    font-weight: bold;
    text-transform: uppercase;
}
.message.bot-reply {
    background: #2b2d31;
    color: #e0e0e0;
    border-left: 4px solid #5865F2;
    font-family: monospace;
    white-space: pre-wrap; /* Keeps formatting */
}
/* --- MOVIE PAGE / TIKTOK STYLE --- */
.movie-overlay-top {
    position: absolute; top: 10px; left: 0; width: 100%; 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 10px 20px; z-index: 20; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}
.movie-tabs { display: flex; gap: 15px; font-weight: bold; font-size: 16px; color: rgba(255,255,255,0.6); }
.movie-tabs .active { color: white; border-bottom: 2px solid white; padding-bottom: 3px; }

.movie-right-bar {
    position: absolute; right: 10px; bottom: 80px; 
    display: flex; flex-direction: column; align-items: center; gap: 20px; z-index: 20;
}
.movie-action { text-align: center; color: white; }
.movie-action i { font-size: 30px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); margin-bottom: 5px; display: block;}
.movie-action span { font-size: 12px; font-weight: 600; text-shadow: 0 1px 2px black; }

.movie-bottom-info {
    position: absolute; bottom: 70px; left: 10px; width: 70%; z-index: 20; color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
}

.movie-nav-bar {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    display: flex; justify-content: space-around; align-items: center; z-index: 30;
    border-top: 1px solid rgba(255,255,255,0.1);
}
.movie-nav-item { color: rgba(255,255,255,0.7); font-size: 10px; text-align: center; cursor: pointer; }
.movie-nav-item.active { color: white; }
.movie-nav-item i { font-size: 22px; margin-bottom: 3px; display: block; }

/* Rotating Disc Animation */
.music-disc { width: 45px; height: 45px; border-radius: 50%; border: 8px solid #222; animation: spin 4s linear infinite; background: #333; }
@keyframes spin { 100% { transform: rotate(360deg); } }
/* --- UPLOAD / CAMERA PAGE --- */
#camera-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } /* Mirror mode */

.camera-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }

.camera-top { display: flex; justify-content: space-between; align-items: flex-start; color: white; text-shadow: 0 1px 2px black; }
.camera-close { font-size: 24px; padding: 10px; cursor: pointer; }
.camera-sound { background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 5px; }

.camera-sidebar { display: flex; flex-direction: column; gap: 20px; align-items: center; }
.camera-tool { display: flex; flex-direction: column; align-items: center; gap: 5px; color: white; font-size: 10px; cursor: pointer; text-shadow: 0 1px 2px black; }
.camera-tool i { font-size: 24px; }

.camera-bottom { display: flex; flex-direction: column; align-items: center; gap: 15px; }
.record-btn-outer { width: 80px; height: 80px; border: 4px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.record-btn-inner { width: 70px; height: 70px; background: #ff4b7d; border-radius: 50%; transition: 0.2s; }
.recording .record-btn-outer { transform: scale(1.2); border-color: #ff4b7d; }
.recording .record-btn-inner { transform: scale(0.5); border-radius: 10px; }

.upload-gallery { width: 40px; height: 40px; border-radius: 8px; border: 2px solid white; overflow: hidden; cursor: pointer; }
.upload-gallery img { width: 100%; height: 100%; object-fit: cover; }

.camera-modes { display: flex; gap: 20px; color: rgba(255,255,255,0.6); font-weight: bold; font-size: 14px; margin-bottom: 10px; }
.camera-modes .active { color: white; }

/* EDITOR PAGE */
.editor-preview { width: 100%; height: 100%; background: black; object-fit: contain; }
.editor-timeline { height: 60px; background: #222; width: 100%; display: flex; align-items: center; padding: 0 10px; gap: 5px; overflow-x: auto; }
.timeline-frame { height: 50px; width: 40px; background: #444; border-radius: 4px; }
    </style>
    <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>

<style>
/* --- PAGE VISIBILITY LOGIC (Critical) --- */
.page { display: none !important; }
.page.active { display: flex !important; }

/* --- STATUS RAIL (Chat Page) --- */
.stories-rail {
    display: flex;
    gap: 15px;
    padding: 15px;
    background: white;
    border-bottom: 1px solid #f0f0f0;
    overflow-x: auto;
    min-height: 110px;
    flex-shrink: 0;
    white-space: nowrap;
}
.story-item { display: flex; flex-direction: column; align-items: center; width: 70px; cursor: pointer; }
.story-circle-container { position: relative; width: 65px; height: 65px; margin-bottom: 5px; }
.story-circle-container img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

/* --- STATUS EDITOR (Camera Page) --- */

/* 1. Recents Gallery */
.gallery-rail {
    position: absolute; bottom: 120px; left: 0; width: 100%; z-index: 10;
}
.gallery-scroll {
    display: flex; gap: 8px; overflow-x: auto; padding: 10px; scrollbar-width: none;
}
.gallery-item {
    min-width: 60px; height: 60px; border-radius: 12px; background: #333;
    display: flex; align-items: center; justify-content: center;
    color: white; border: 1px solid rgba(255,255,255,0.2); overflow: hidden;
}
.gallery-item img { width: 100%; height: 100%; object-fit: cover; }

/* 2. Shutter Button */
.shutter-button {
    position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
    width: 75px; height: 75px; border: 5px solid white; border-radius: 50%;
    cursor: pointer; z-index: 20; background: transparent;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.1s;
}
.shutter-button:active { background: white; transform: translateX(-50%) scale(0.9); }

/* 3. Bottom Pills (The Fix for Plain Text) */
.status-pill-container {
    display: flex !important;
    justify-content: center;
    gap: 15px;
    background: rgba(20, 20, 20, 0.6) !important;
    padding: 10px 20px !important;
    border-radius: 30px !important;
    width: fit-content !important;
    margin: 0 auto;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}
.status-pill {
    color: #ccc !important;
    font-size: 13px !important;
    font-weight: 700 !important;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 6px 16px !important;
    border-radius: 20px !important;
    background: transparent;
}
.status-pill.active {
    color: black !important;
    background: white !important;
    transform: scale(1.05);
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

/* 4. Text Mode Input */
#status-text-input::placeholder { color: rgba(255,255,255,0.5); }

/* --- STATUS VIEWER --- */
#status-progress-bar {
    position: absolute; top: 10px; left: 0; width: 100%; padding: 0 10px;
    display: flex; gap: 5px; z-index: 220;
}
.status-bar-segment {
    flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;
}
.status-bar-fill {
    height: 100%; background: white; width: 0%; transition: width 0.1s linear;
}

/* Loading Spinner */
.sending-spinner {
    width: 30px; height: 30px; border: 3px solid #ccc;
    border-top: 3px solid #00a884; border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Utility */
.hidden { display: none !important; }
/* --- 1. STATUS REACTION BAR (The Emojis) --- */
.reaction-bar {
    position: absolute;
    bottom: 80px; /* Sits above the reply input */
    left: 0;
    width: 100%;
    padding: 10px;
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    z-index: 230;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease, bottom 0.2s ease;
}
.reaction-bar.visible {
    opacity: 1;
    pointer-events: auto;
    bottom: 90px;
}
.reaction-emoji {
    font-size: 28px;
    cursor: pointer;
    transition: transform 0.2s;
    background: rgba(0,0,0,0.4);
    border-radius: 50%;
    width: 45px; height: 45px;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
}
.reaction-emoji:active { transform: scale(1.4); }

/* --- 2. CHAT REPLY BUBBLE (The "Quoted" Status) --- */
.reply-context {
    background: rgba(0,0,0,0.05);
    border-radius: 8px;
    padding: 5px;
    margin-bottom: 5px;
    display: flex;
    justify-content: space-between;
    border-left: 4px solid #00a884; /* WhatsApp Green Line */
    cursor: pointer;
    overflow: hidden;
}
.reply-info { display: flex; flex-direction: column; justify-content: center; padding-left: 5px; }
.reply-author { color: #00a884; font-size: 12px; font-weight: bold; margin-bottom: 2px; }
.reply-snippet { font-size: 11px; color: gray; display: flex; align-items: center; gap: 4px; }
.reply-thumb { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #ddd; }

/* --- 3. DASHBOARD LIKES --- */
.dashboard-heart { color: #00C853; margin-left: 5px; font-size: 12px; display: inline-flex; align-items: center; gap: 3px; }
.loved-anim { animation: popHeart 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #ff4757 !important; }
@keyframes popHeart { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
/* --- 3-DOT MENU STYLES --- */
.chat-menu {
    position: absolute;
    top: 50px;
    right: 10px;
    background: white;
    width: 220px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    transform-origin: top right;
    transform: scale(0); /* Hidden start state */
    opacity: 0;
    transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy animation */
    z-index: 1000;
    overflow: hidden;
    padding: 5px 0;
}

/* Active State (Shown) */
.chat-menu.active {
    transform: scale(1);
    opacity: 1;
}

.chat-menu .menu-item {
    padding: 14px 20px;
    color: #111;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: background 0.1s;
}

.chat-menu .menu-item:hover {
    background: #f5f5f5;
}

.chat-menu .menu-item i {
    color: #54656f;
    font-size: 18px;
    width: 24px;
    text-align: center;
}
/* CONTACT SELECTION STYLES */
.contact-select-item {
    display: flex; align-items: center; padding: 15px; cursor: pointer; transition: 0.2s;
}
.contact-select-item:hover { background: #f5f5f5; }
.contact-select-item.selected .select-checkbox {
    background: var(--primary); border-color: var(--primary);
}
.contact-select-item.selected .select-checkbox::after {
    content: 'âœ”'; font-size: 10px; color: white;
}

.select-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
.select-checkbox {
    width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; margin-top: auto; margin-bottom: auto;
}

/* TOP STRIP (Avatar Bubbles) */
.mini-avatar-bubble {
    display: flex; flex-direction: column; align-items: center; width: 50px; flex-shrink: 0; animation: fadeIn 0.2s;
}
.mini-avatar-bubble img {
    width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white;
}
.mini-avatar-bubble span {
    font-size: 10px; color: #333; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;
}
.mini-avatar-bubble .remove-x {
    position: absolute; top: 0; right: 0; background: grey; color: white; 
    border-radius: 50%; width: 14px; height: 14px; font-size: 8px; display: flex; align-items: center; justify-content: center;
}
/* --- CLEAN CHAT LIST (WhatsApp Style) --- */
.list-item {
    border-bottom: none !important; /* Removes the line */
    padding: 12px 15px; /* More breathing room */
    transition: background 0.2s;
}

.list-item:hover {
    background: #f5f5f5; /* Subtle hover effect */
}

/* Optional: Add a very faint inset line only next to avatar (Like real WhatsApp) */
/* If you want purely no lines, ignore this comment. */
/* Selected Message Highlight */
.message.selected-msg {
    background-color: #dcf8c6cc !important; /* Light green overlay */
    position: relative;
}

.message.selected-msg::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 128, 105, 0.1); /* Teal tint */
    border-radius: 10px;
    pointer-events: none;
}
/* Admin Badge */
.admin-badge {
    background: #e9edef;
    color: #008069;
    border: 1px solid #008069;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    margin-left: 8px;
    vertical-align: middle;
}

/* Toggle Switch (iOS Style) */
.switch {
  position: relative; display: inline-block; width: 40px; height: 24px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc; transition: .4s; border-radius: 34px;
}
.slider:before {
  position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px;
  background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: #008069; }
input:checked + .slider:before { transform: translateX(16px); }

/* Input Bar Blocked State */
.chat-input-area.blocked {
    background: #f0f2f5;
    justify-content: center;
    pointer-events: none; /* Disable clicking */
}
.chat-input-area.blocked * { display: none; } /* Hide all buttons */
.chat-input-area.blocked::after {
    content: "Only admins can send messages";
    display: block !important;
    color: gray;
    font-size: 14px;
    padding: 15px;
}
/* CSS for Disappearing Radio Buttons */
.radio-option { display: flex; align-items: center; gap: 15px; padding: 15px 0; cursor: pointer; color: #e9edef; font-size: 16px; }
.radio-circle { width: 20px; height: 20px; border: 2px solid #8696a0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.radio-dot { width: 10px; height: 10px; background: #00a884; border-radius: 50%; display: none; }
.radio-active .radio-circle { border-color: #00a884; }
.radio-active .radio-dot { display: block; }
/* MODAL OVERLAY */
.modal-overlay { 
    display: none; 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.6); 
    z-index: 2000; 
    align-items: center; 
    justify-content: center; 
}

/* BOTTOM SHEET (Notify) */
.modal-content.bottom-sheet { 
    background: #1f2c34; 
    width: 100%; 
    border-radius: 15px 15px 0 0; 
    padding: 20px; 
    position: absolute; bottom: 0; 
    animation: slideUp 0.3s;
}
.modal-handle {
    width: 40px; height: 4px; background: #374248; 
    border-radius: 2px; margin: 0 auto 20px auto;
}

/* CENTER BOX (Vibrate, Light) */
.modal-content.center-box { 
    background: #1f2c34; 
    width: 85%; max-width: 300px; 
    border-radius: 3px; 
    padding: 24px; 
    animation: fadeIn 0.2s;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* RADIO ITEMS */
.radio-simple { 
    padding: 12px 0; 
    font-size: 16px; 
    color: #e9edef;
    display: flex; align-items: center; gap: 15px; 
    cursor: pointer; 
}
.radio-simple:before {
    content: ''; width: 20px; height: 20px; 
    border-radius: 50%; border: 2px solid #8696a0; 
    display: block; box-sizing: border-box;
}

/* ANIMATIONS */
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* SWITCH COLOR OVERRIDE */
.switch input:checked + .slider { background-color: #00a884; }

/* CSS FOR ICON MENU */
.icon-option { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; color: #aebac1; }
.icon-circle { 
    width: 60px; height: 60px; border-radius: 50%; 
    border: 1px solid #2a3942; 
    display: flex; align-items: center; justify-content: center; 
    font-size: 24px; color: #00a884;
    transition: 0.2s;
}
.icon-option:active .icon-circle { background: rgba(0, 168, 132, 0.1); border-color: #00a884; }
.icon-option span { font-size: 12px; }
/* CSS FOR EMOJI EDITOR */
.color-dot { width: 40px; height: 40px; border-radius: 50%; display: inline-block; margin-right: 10px; border: 2px solid transparent; cursor: pointer; }
.color-dot.selected { border-color: white; }
.emoji-item { font-size: 30px; text-align: center; cursor: pointer; padding: 5px; }

/* CSS FOR WEB SEARCH */
.web-img-result { width: 100%; aspect-ratio: 1; object-fit: cover; cursor: pointer; background: #2a3942; }
/* --- 1. FOOTER CONTAINER (Wraps Input + Drawer) --- */
.chat-footer-container {
    position: absolute; 
    bottom: 0; 
    left: 0; 
    width: 100%;
    display: flex; 
    flex-direction: column;
    z-index: 100;
    /* Transparent so you can see wallpaper behind input, 
       but drawer will have its own background */
    background: transparent; 
}

/* --- 2. INPUT BAR STYLES --- */
/* Override existing if needed to ensure flex layout */
.chat-input-area {
    width: 100%; 
    box-sizing: border-box;
}

/* --- 3. EMOJI/STICKER DRAWER --- */
#emoji-drawer {
    height: 300px; /* Standard keyboard height */
    background: #111b21; /* Dark Mode Background */
    display: none; /* Hidden by default */
    flex-direction: column;
    border-top: 1px solid #2a3942;
    overflow: hidden;
}

/* Class added by JS to show it */
#emoji-drawer.open {
    display: flex;
}

/* --- 4. DRAWER TABS (Emoji, Sticker, GIF) --- */
.drawer-tab {
    cursor: pointer;
    transition: all 0.2s ease;
    color: #8696a0; /* Inactive Color */
}

.drawer-tab.active {
    color: #e9edef; /* Active Text Color */
    background: rgba(255, 255, 255, 0.05); /* Slight highlight */
}

/* Icons inside tabs */
.drawer-tab i {
    font-size: 20px;
}

/* --- 5. GRIDS (Emoji & Stickers) --- */
#chat-emoji-grid {
    /* 8 emojis per row */
    grid-template-columns: repeat(8, 1fr); 
}

#chat-emoji-grid span {
    font-size: 28px;
    padding: 5px;
    cursor: pointer;
    user-select: none;
}

.sticker-grid {
    /* 4 stickers per row */
    grid-template-columns: repeat(4, 1fr); 
}

/* Animation for the Reply Bar sliding up */
@keyframes slideUp {
    from { transform: translateY(10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
/* Bottom Sheet Styles */
.bottom-sheet-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 300;
    display: flex; align-items: flex-end;
    animation: fadeIn 0.2s ease-out;
}
.bottom-sheet-content {
    width: 100%; background: #1f2c34; border-radius: 15px 15px 0 0;
    animation: slideUp 0.3s ease-out; padding-bottom: 20px;
}
.menu-option {
    padding: 15px 20px; display: flex; align-items: center; gap: 20px;
    color: #e9edef; font-size: 16px; cursor: pointer; transition: 0.1s;
}
.menu-option:active { background: #2a3942; }
.menu-option i { font-size: 20px; width: 30px; text-align: center; color: #8696a0; }

/* Sticker Maker Styles */
.editor-tool-btn {
    width: 55px; height: 55px; background: #2a3942; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #e9edef; font-size: 22px; cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
/* SCANNER BOX STYLES */
.scan-frame {
    width: 250px; height: 250px; position: relative;
    box-shadow: 0 0 0 100vh rgba(0, 0, 0, 0.6); /* This darkens the area outside the box */
    border-radius: 4px;
}

/* Green Corners */
.scan-corner-tl, .scan-corner-tr, .scan-corner-bl, .scan-corner-br {
    position: absolute; width: 40px; height: 40px; border-color: white; border-style: solid;
}
.scan-corner-tl { top: 0; left: 0; border-width: 4px 0 0 4px; }
.scan-corner-tr { top: 0; right: 0; border-width: 4px 4px 0 0; }
.scan-corner-bl { bottom: 0; left: 0; border-width: 0 0 4px 4px; }
.scan-corner-br { bottom: 0; right: 0; border-width: 0 4px 4px 0; }

/* Moving Laser Animation */
.scan-laser {
    position: absolute; width: 100%; height: 2px;
    background: #00C853; 
    box-shadow: 0 0 4px #00C853;
    top: 0;
    animation: scanMove 2.5s infinite linear;
}

@keyframes scanMove {
    0% { top: 10px; opacity: 0; }
    50% { top: 240px; opacity: 1; }
    100% { top: 10px; opacity: 0; }
}
  /* Scoped Discord Theme Styles */
    #edit-profile-page {
        background-color: #1e1f22 !important; /* Discord Dark Background */
        padding: 0 !important;
        overflow-y: auto;
        font-family: 'gg sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    /* 1. Banner */
    .d-banner {
        height: 120px;
        background: rgb(255,0,204);
        background: linear-gradient(90deg, rgba(255,0,204,1) 0%, rgba(51,51,153,1) 100%);
        width: 100%;
    }

    /* 2. Header (Avatar + Names) */
    .d-header {
        padding: 0 16px;
        position: relative;
        margin-bottom: 16px;
    }

    .d-avatar-container {
        width: 88px;
        height: 88px;
        border-radius: 50%;
        background: #1e1f22; /* Matches bg to create cutout effect */
        padding: 6px; 
        position: absolute;
        top: -50px; /* Pulls it up into banner */
        left: 16px;
    }

    .d-avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .d-status-indicator {
        width: 26px;
        height: 26px;
        background: #23a559; /* Online Green */
        border: 4px solid #1e1f22;
        border-radius: 50%;
        position: absolute;
        bottom: 0;
        right: 0;
    }

    .d-names {
        margin-top: 50px; /* Pushes text down below avatar */
    }

    .d-display-name {
        color: #ffffff;
        font-size: 22px;
        font-weight: 800;
        margin: 0;
        line-height: 1.2;
    }

    .d-username {
        color: #b5bac1;
        font-size: 14px;
        margin: 2px 0 0 0;
    }

    /* 3. Body Content */
    .d-body {
        padding: 0 16px 100px 16px; /* Bottom padding for scroll */
    }

    /* Edit Profile Button */
    .d-btn-edit {
        background-color: #5865F2; /* Blurple */
        color: white;
        width: 100%;
        padding: 7px 0;
        border-radius: 20px;
        border: none;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* Nitro Banner */
    .d-nitro-banner {
        background: linear-gradient(90deg, #3c4276, #2b2d31);
        border: 1px solid #5865F2;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        color: white;
    }

    .d-nitro-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-weight: 700;
        font-size: 13px;
    }

    .d-nitro-btns {
        display: flex;
        gap: 10px;
    }

    .d-nitro-btn {
        flex: 1;
        background: #4e5058;
        color: white;
        border: none;
        padding: 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .d-nitro-btn.primary {
        background: white;
        color: black;
    }

    /* Standard Cards */
    .d-card {
        background-color: #2b2d31;
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
    }

    .d-card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .d-label-small {
        color: #b5bac1;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        margin-bottom: 6px;
    }

    .d-value-row {
        color: #dbdee1;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Friends Faces */
    .d-friend-faces {
        display: flex;
        align-items: center;
    }
    .d-face {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #2b2d31;
        margin-left: -6px;
    }
    .d-face:first-child { margin-left: 0; }
    /* --- EDITOR STYLES --- */
.d-input-group {
    margin-bottom: 20px;
}
.d-input-group label {
    display: block;
    color: #b5bac1;
    font-size: 11px;
    font-weight: 800;
    margin-bottom: 8px;
    text-transform: uppercase;
}
.d-input-group input, 
.d-input-group textarea {
    width: 100%;
    background: #111214;
    border: none;
    padding: 15px;
    border-radius: 4px;
    color: white;
    font-size: 16px;
    outline: none;
    font-family: inherit;
}
.d-input-group input:focus, 
.d-input-group textarea:focus {
    background: #000;
}
/* --- SHOP STYLES --- */
.shop-section-title {
    color: #b5bac1;
    font-size: 11px;
    font-weight: 800;
    margin: 20px 0 10px 0;
    letter-spacing: 0.5px;
}

.shop-item {
    display: flex;
    align-items: center;
    background: #2b2d31;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
}

.shop-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-right: 15px;
}

.shop-info {
    flex: 1;
}

.shop-name {
    color: white;
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 2px;
}

.shop-desc {
    color: #b5bac1;
    font-size: 12px;
}

.shop-btn {
    background: #4e5058;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 13px;
    cursor: pointer;
    transition: 0.2s;
}
.shop-btn:active {
    transform: scale(0.95);
    background: #5865F2;
}
/* --- CHANNEL PROFILE STYLES --- */
.channel-action-btn {
    flex: 1;
    background: white;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.channel-action-btn i {
    font-size: 20px;
    color: #008069;
}
.channel-action-btn span {
    font-size: 14px;
    font-weight: 500;
    color: #111b21;
}

.insight-box {
    flex: 1;
    background: #f0f2f5;
    border-radius: 10px;
    padding: 15px;
}
.insight-num {
    font-size: 18px;
    font-weight: bold;
    color: #111b21;
    margin-bottom: 5px;
}
.insight-label {
    font-size: 13px;
    color: #54656f;
}
/* Prevent all pages from showing until the 'active' class is added by JS */
.page { 
    display: none !important; 
}
.page.active { 
    display: flex !important; 
}

/* Optional: WhatsApp-style Splash Screen while app loads */
#app-frame {
    background-color: white;
}
#app-frame:empty::after {
    content: "Global Connect";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    color: #ff4b7d;
    font-size: 22px;
}
/* --- MESSAGE REACTION UI --- */
.reaction-overlay {
    position: absolute;
    top: -55px;
    left: 10px;
    background: white;
    padding: 6px 12px;
    border-radius: 30px;
    display: flex;
    gap: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.reaction-overlay span { font-size: 24px; cursor: pointer; transition: transform 0.1s; }
.reaction-overlay span:active { transform: scale(1.5); }

.reaction-plus {
    width: 30px; height: 30px; background: #f0f2f5; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #54656f; font-size: 20px; cursor: pointer;
}

/* --- 1. MESSAGE CONTAINER FIXES --- */
.message {
    position: relative;
    /* ðŸŒŸ CRITICAL: Allows the reaction badge and menu to "pop out" of the bubble ðŸŒŸ */
    overflow: visible !important; 
    z-index: 1;
}

/* Push the message being reacted to the very front so the menu is on top of other chats */
.message.selected-msg {
    z-index: 9999 !important;
}

/* --- 2. THE REACTION MENU (The floating bar) --- */
.reaction-overlay {
    position: absolute;
    top: -55px;
    background: white;
    padding: 6px 12px;
    border-radius: 30px;
    display: flex;
    gap: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 10000 !important;
    animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* --- 3. TELEGRAM STYLE REACTION BADGE (The permanent icon) --- */
.msg-reaction-badge {
    position: absolute;
    bottom: -10px; 
    right: -2px;   
    background: #ffffff;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 13px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border: 2px solid var(--white); 
    z-index: 30;
    display: flex;
    align-items: center;
    pointer-events: none;
    user-select: none;
}

/* --- 4. ANIMATIONS --- */

/* Badge Zoom-Burst (When it appears) */
@keyframes telegramBurst {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    50% { transform: scale(1.4) rotate(10deg); opacity: 1; }
    100% { transform: scale(1) rotate(0); opacity: 1; }
}
.msg-reaction-badge.new-react {
    animation: telegramBurst 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* Particle Burst (The 5 flying emojis) */
@keyframes telegramParticle {
    0% { transform: translate(0, 0) scale(0.5); opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(1.2); opacity: 0; }
}
.floating-reaction {
    position: absolute;
    bottom: 5px;
    right: 5px;
    font-size: 22px;
    pointer-events: none;
    z-index: 1000;
    animation: telegramParticle 0.6s ease-out forwards;
}

/* Physical Shake of the bubble */
@keyframes bubbleShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(3px); }
    75% { transform: translateX(-3px); }
}
.message.shaking { animation: bubbleShake 0.2s ease-in-out; }

/* Menu Pop-in */
@keyframes popIn {
    from { opacity: 0; transform: translateY(10px) scale(0.8); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

#link-preview-bar {
    animation: slideUp 0.3s ease-out;
}
/* --- PROFESSIONAL SINGLE-BUBBLE REACTIONS --- */

/* 1. Ensure the message bubble allows the badge to sit on its edge */
.message {
    position: relative;
    margin-bottom: 12px;
    overflow: visible !important; /* VITAL: Prevents cutting off the pill */
}

/* 2. Add extra space below bubbles that have reactions to prevent overlapping */
.message.has-reactions {
    margin-bottom: 35px; /* Increased to ensure clearance for the pill */
}

/* 3. Unified Badge Positioning */
.multi-reaction-badge.single-bubble {
    position: absolute;
    bottom: -20px; /* Pulls the pill completely off the message text */
    display: flex;
    z-index: 50;
    pointer-events: auto; /* Allows the pill to be clickable */
}

/* 4. Align Sent messages to the right, Received to the left */
.message.sent .multi-reaction-badge.single-bubble {
    right: 8px;
}

.message.received .multi-reaction-badge.single-bubble {
    left: 8px;
}

/* 5. The Unified Pill Design */
.reaction-pill {
    background: #ffffff;
    border: 1px solid #e9edef;
    padding: 3px 10px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
}

/* 6. Overlapping "Half-Emoji" Container */
.emoji-overlap-container {
    display: flex;
    align-items: center;
    padding-right: 4px;
}

.emoji-overlap-container span {
    font-size: 15px;
    position: relative;
    background: white; /* Prevents seeing the emoji underneath */
    border-radius: 50%;
}

/* Every emoji after the first one shifts left to overlap */
.emoji-overlap-container span:not(:first-child) {
    margin-left: -10px; 
}

/* 7. Vertical Divider and Total Count */
.reaction-count {
    font-size: 11px;
    font-weight: 700;
    color: #54656f;
    border-left: 1px solid #eee; /* The vertical line you requested */
    padding-left: 8px;
    margin-left: 2px;
    line-height: 1.2;
}

/* 8. Pop Animation for new reactions */
.new-react {
    animation: telegramBurst 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes telegramBurst {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
/* Bottom Sheet for Reaction Details */
.bottom-sheet {
    position: fixed;
    bottom: -100%;
    left: 0;
    width: 100%;
    background: white;
    border-radius: 20px 20px 0 0;
    transition: bottom 0.3s ease;
    z-index: 1000;
    padding: 15px;
    max-height: 70vh;
    overflow-y: auto;
}
.bottom-sheet.show { bottom: 0; }

#sheet-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 999;
}

.sheet-handle {
    width: 40px; height: 5px; background: #ccc;
    border-radius: 10px; margin: 0 auto 15px;
}

.react-tabs-container {
    display: flex; gap: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;
}

.react-tab {
    background: #f0f2f5; padding: 6px 12px; border-radius: 15px; font-size: 14px;
}

.react-user-row {
    display: flex; align-items: center; padding: 10px 0; gap: 12px;
}

.react-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
.react-user-name { flex: 1; font-weight: 500; }
.react-anonymous-note { padding: 20px; text-align: center; color: #888; font-style: italic; }
.lang-dropdown {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 14px;
    outline: none;
    cursor: pointer;
}
.lang-dropdown option {
    color: black;
}
#auth-page .lang-dropdown {
    color: #54656f;
    border-color: #ddd;
}
/* Replace Input Bar with Status Text */
.chat-input-area.blocked {
    background: #f0f2f5 !important;
    min-height: 60px;
    justify-content: center !important;
    border-top: 1px solid #ddd;
}
.chat-input-area.blocked * { display: none !important; }
.chat-input-area.blocked::after {
    content: attr(data-status);
    display: block;
    color: #667781;
    font-size: 14px;
    font-weight: 500;
}
/* Top Archive Pill */
.archive-pill-container {
    display: flex;
    align-items: center;
    background: #f0f2f5;
    padding: 5px 10px;
    border-radius: 20px;
    cursor: pointer;
    gap: 8px;
    margin-right: 10px;
}

.archive-expanded {
    display: flex;
    gap: 10px;
    max-width: 0;
    overflow: hidden;
    transition: max-width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
    opacity: 0;
    color: #54656f;
}

.archive-expanded.show {
    max-width: 100px;
    opacity: 1;
}

/* Background for selected items */
.list-item.selected-msg {
    background-color: rgba(0, 168, 132, 0.1) !important;
}
/* Ensure the PIN page can actually be seen */
#pin-screen-page.active {
    display: flex !important;
}

/* Telegram-style PIN Dots */
.pin-dot {
    width: 14px; height: 14px;
    border: 2px solid #5288c1;
    border-radius: 50%;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.pin-dot.filled {
    background: #5288c1;
    transform: scale(1.2);
}

/* Telegram-style Keypad */
.pin-key {
    width: 75px; height: 75px;
    background: rgba(255,255,255,0.08);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; cursor: pointer;
    transition: all 0.1s ease;
}
.pin-key:active { 
    background: rgba(255,255,255,0.2); 
    transform: scale(0.9);
}

/* Shake animation for wrong PIN */
@keyframes pinShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-15px); }
    75% { transform: translateX(15px); }
}
.shaking { animation: pinShake 0.4s ease-in-out; }
/* WhatsApp-style Toggle Switches */
.switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 34px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}
input:checked + .slider { background-color: #008069; } 
input:checked + .slider:before { transform: translateX(20px); }
/* Themes Grid */
.theme-selection-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    padding: 0 20px;
}

.theme-card {
    aspect-ratio: 9/16;
    border-radius: 12px;
    background-size: cover;
    background-position: center;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.theme-card.active { border-color: #00a884; }
.theme-card .check-overlay {
    position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
    background: white; border-radius: 50%; width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center; color: #111; font-size: 10px;
}

/* Swipeable Preview */
.preview-container {
    display: flex;
    width: 100%;
    height: 100%;
    transition: transform 0.3s ease-out;
}

.preview-slide {
    min-width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 80px 20px;
    background-size: cover;
}

/* Color Circles */
.color-picker-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    padding: 20px;
}

.color-circle {
    width: 80px; height: 80px; border-radius: 50%; margin: auto;
    border: 3px solid transparent; cursor: pointer; display: flex;
}

.color-circle.active { border-color: white; outline: 1px solid #888; }

/* Wallpaper Grid */
.wallpaper-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
    padding: 10px;
}

.wall-thumb { aspect-ratio: 9/16; background-size: cover; border-radius: 8px; }
.slider-wrapper {
    height: 180px;
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#wallpaper-dimmer-input {
    -webkit-appearance: none;
    width: 150px;
    height: 35px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    outline: none;
    transform: rotate(-90deg); /* Makes it vertical */
}

#wallpaper-dimmer-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 25px;
    height: 25px;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
/* --- UNSAVED CONTACT CARD --- */
.unsaved-profile-card {
    background: #1f2c34;
    border-radius: 28px;
    padding: 24px;
    margin: 10px auto 25px auto;
    width: 90%;
    text-align: center;
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.up-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
    border: 2px solid #2a3942;
}

.up-name { font-size: 22px; font-weight: 500; margin-bottom: 5px; }
.up-phone { font-size: 16px; color: #8696a0; margin-bottom: 10px; }
.up-status { font-size: 14px; color: #8696a0; margin-bottom: 20px; }

.up-info-line {
    font-size: 13px;
    color: #8696a0;
    margin-bottom: 15px;
    padding: 0 10px;
}

.safety-tools {
    color: #00a884;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 20px;
    cursor: pointer;
}

.up-actions {
    display: flex;
    gap: 12px;
}

.up-btn {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-block-red { background: rgba(255, 71, 87, 0.1); color: #ff4757; }
.btn-add-green { background: rgba(0, 168, 132, 0.1); color: #00a884; }
.attachment-menu {
    position: fixed;
    bottom: 80px; /* Adjust based on your input bar height */
    left: 10px;
    right: 10px;
    background: #121b22; /* WhatsApp Dark Theme */
    border-radius: 16px;
    padding: 20px;
    display: none;
    z-index: 9999;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.5);
    transform-origin: bottom center;
}

/* ðŸŒŸ POP-UP ANIMATION */
.attachment-menu.active {
    display: block;
    animation: menuPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes menuPop {
    from { transform: scale(0.4) translateY(50px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
}

.attachment-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px 10px;
}

.attach-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.attach-icon {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.attach-item span {
    color: #8696a0;
    font-size: 11px;
    font-weight: 500;
}
.live-comment-pill {
    background: rgba(0, 0, 0, 0.4);
    padding: 6px 12px;
    border-radius: 15px;
    color: white;
    font-size: 13px;
    width: fit-content;
    animation: slideUpFade 0.3s ease-out;
}
@keyframes slideUpFade {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
/* ðŸ’– Floating Heart Animation */
.floating-heart {
    position: absolute;
    font-size: 30px;
    color: #ff4b7d;
    pointer-events: none;
    z-index: 1000;
    animation: heartFly 1s ease-out forwards;
    text-shadow: 0 0 10px rgba(255, 75, 125, 0.8);
}

@keyframes heartFly {
    0% { transform: scale(0.5) translate(0, 0) rotate(0deg); opacity: 1; }
    100% { 
        /* Randomizes the flight path slightly using the variables set in JS */
        transform: scale(1.5) translate(var(--tx), var(--ty)) rotate(var(--tr)); 
        opacity: 0; 
    }
}

/* ðŸŽŠ Milestone Celebration Toast */
.milestone-toast {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(45deg, #ff4b7d, #6c5ce7);
    color: white;
    padding: 15px 30px;
    border-radius: 50px;
    font-weight: 900;
    font-size: 24px;
    z-index: 2000;
    animation: popAndFade 2s ease-in-out forwards;
    white-space: nowrap;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

@keyframes popAndFade {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -200%) scale(0.8); opacity: 0; }
}
/* ðŸ”´ LIVE PROFILE STYLES */
.live-border {
    box-shadow: 0 0 0 2px white, 0 0 0 4px #ff4757 !important;
}

.live-tag-chat {
    background: #ff4757;
    color: white;
    font-size: 9px;
    font-weight: 900;
    padding: 1px 4px;
    border-radius: 4px;
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    border: 1px solid white;
    z-index: 5;
}

.live-badge-home {
    background: #ff4757;
    color: white;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 800;
    margin-left: 10px;
    animation: pulse-red 1.5s infinite;
}

@keyframes pulse-red {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}
/* --- ARENA STYLES --- */
.arena-header {
    position: absolute; top: 40px; left: 0; width: 100%; padding: 0 20px; z-index: 100;
}
.battle-timer {
    text-align: center; color: white; font-weight: 900; font-size: 14px; margin-bottom: 10px;
    background: rgba(0,0,0,0.5); width: fit-content; margin: 0 auto 10px; padding: 2px 12px; border-radius: 10px;
}
.tug-of-war-container {
    height: 35px; width: 100%; background: #222; border-radius: 20px; overflow: hidden; 
    display: flex; position: relative; border: 2px solid rgba(255,255,255,0.1);
}
.power-fill {
    height: 100%; transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex; align-items: center; padding: 0 15px;
}
.p1 { background: linear-gradient(90deg, #ff4b7d, #ff7675); justify-content: flex-start; }
.p2 { background: linear-gradient(90deg, #a29bfe, #6c5ce7); justify-content: flex-end; }
.score-label { color: white; font-weight: 900; font-size: 14px; text-shadow: 0 1px 3px black; }
.vs-badge {
    position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
    background: #fff; color: #000; font-size: 10px; font-weight: 900; 
    padding: 4px 8px; border-radius: 5px; z-index: 10;
}

.arena-stage {
    height: 100vh; width: 100%; display: flex; align-items: center; justify-content: space-around;
    background: radial-gradient(circle, #1a1f25 0%, #000 100%);
}
.fighter { position: relative; display: flex; flex-direction: column; align-items: center; }
.fighter-img {
    width: 120px; height: 120px; border-radius: 50%; object-fit: cover; z-index: 5;
    border: 3px solid white;
}
.fighter-aura {
    position: absolute; top: -10px; width: 140px; height: 140px; border: 4px solid;
    border-radius: 50%; animation: auraPulse 2s infinite; opacity: 0.5;
}
@keyframes auraPulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }

.fighter-tag {
    margin-top: 15px; background: rgba(255,255,255,0.1); color: white; 
    padding: 4px 15px; border-radius: 20px; font-size: 10px; font-weight: bold;
}

.arena-footer {
    position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; 
    background: linear-gradient(transparent, rgba(0,0,0,0.9)); z-index: 100;
}
.arena-actions { display: flex; gap: 10px; align-items: center; }
.arena-gift-btn {
    width: 50px; height: 50px; background: #ffd700; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 22px; color: #000;
}
.arena-chat-input {
    flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 25px; padding: 12px 20px; color: white; outline: none;
}
/* Stat Pill helper */
.stat-pill {
    background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; 
    font-size: 11px; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(10px);
}

.arena-follow-btn {
    margin-top: 10px; background: #ff4b7d; border: none; color: white; 
    padding: 6px 15px; border-radius: 20px; font-size: 10px; font-weight: bold; cursor: pointer;
}

/* Slide in animation */
.slide-in-up {
    animation: slideInUp 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
}

@keyframes slideInUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
@keyframes heartExplode {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -100%) scale(1); opacity: 0; }
}
/* Fix the syntax error here */
#movie-page {
    overflow: hidden !important;
    touch-action: none; 
}

#movie-container {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background: black;
    z-index: 1;
}

#movie-player {
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none; /* ðŸŒŸ THIS IS THE KEY: Swipes go THROUGH the video to the container */
}

/* Re-enable clicks for the buttons on the right so you can still like/comment */
.movie-right-bar, .movie-bottom-info, .movie-overlay-top {
    pointer-events: auto;
    z-index: 100;
}
/* --- MOVIE COMMENT DRAWER --- */
.comment-drawer {
    position: absolute; bottom: -100%; left: 0; width: 100%; height: 70%;
    background: white; border-radius: 20px 20px 0 0; z-index: 1000;
    transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex; flex-direction: column; color: #1a1a1a;
}
.comment-drawer.open { bottom: 0; }

.comment-header {
    padding: 15px; text-align: center; font-weight: 800; border-bottom: 1px solid #eee;
    position: relative; font-size: 14px;
}
.close-comment { position: absolute; right: 15px; top: 15px; font-size: 20px; cursor: pointer; }

.comment-list { flex: 1; overflow-y: auto; padding: 10px; }

.comment-item { display: flex; gap: 12px; margin-bottom: 20px; position: relative; }
.comment-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
.comment-content { flex: 1; }
.comment-user-name { font-weight: 700; font-size: 12px; color: #666; margin-bottom: 2px; }
.comment-text { font-size: 14px; line-height: 1.4; color: #111; }

/* Forced Sticker Size for Image Comments */
.comment-image { 
    width: 80px !important; 
    height: 80px !important; 
    border-radius: 12px; 
    object-fit: cover; 
    margin-top: 8px; 
    border: 2px solid #f0f2f5;
    display: block;
}

.comment-meta { display: flex; gap: 15px; font-size: 11px; color: #999; margin-top: 5px; font-weight: 600; }
.comment-like-btn { position: absolute; right: 5px; top: 5px; text-align: center; color: #ccc; cursor: pointer; }
.comment-like-btn.active { color: var(--primary); }

#comment-img-preview-bar {
    display: none; padding: 10px; background: #f8f9fa; border-top: 1px solid #eee; align-items: center; gap: 10px;
}

.comment-input-area {
    padding: 10px 15px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px;
    background: white; padding-bottom: 25px;
}

/* Mention Popover Style */
#mention-popover {
    position: absolute; bottom: 80px; left: 10px; background: white; width: 220px;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.1); border-radius: 10px; display: none;
    max-height: 150px; overflow-y: auto; z-index: 1100; border: 1px solid #eee;
}
.mention-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; }
.mention-item:hover { background: #f0f2f5; }
/* --- ðŸŽ MINI GIFT DRAWER FIX --- */
#gift-drawer-mini {
    display: none; /* Controlled by JS */
    height: 200px;
    background: #fdfdfd;
    border-top: 1px solid #eee;
    padding: 10px;
    /* Forces 5 items per row at the bottom */
    grid-template-columns: repeat(5, 1fr); 
    gap: 12px;
    overflow-y: auto;
    flex-shrink: 0; /* Prevents it from being squeezed */
    z-index: 10;
}

.mini-gift-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 0;
    cursor: pointer;
    transition: transform 0.1s;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
.mini-gift-item:active { transform: scale(1.2); }

.mini-gift-item img {
    width: 25px; /* Exact size requested */
    height: 25px;
    object-fit: contain;
}

.mini-gift-price {
    font-size: 10px;
    font-weight: 800;
    color: #ff4b7d;
    margin-top: 4px;
}
/* --- ðŸ“± TIKTOK STYLE PROFILE GRID --- */
#pp-video-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    padding: 10px 2px;
}

.profile-video-item {
    aspect-ratio: 9 / 16;
    background: #000;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    border-radius: 4px;
}

.profile-video-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-video-stats {
    position: absolute;
    bottom: 5px;
    left: 5px;
    color: white;
    font-size: 10px;
    font-weight: bold;
    text-shadow: 0 1px 2px black;
    display: flex;
    align-items: center;
    gap: 3px;
}
/* --- POST MANAGEMENT MENU --- */
.post-menu-drawer {
    position: absolute; bottom: -100%; left: 0; width: 100%;
    background: #1c1c1e; border-radius: 20px 20px 0 0; z-index: 2000;
    padding: 20px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.post-menu-drawer.active { bottom: 0; }

/* --- Branded Outro Animation --- */
#download-outro-overlay {
    animation: fadeIn 0.4s ease;
}

.outro-logo {
    width: 90px; height: 90px; border-radius: 20px;
    margin-bottom: 20px; animation: pulse 1.5s infinite;
    box-shadow: 0 0 30px rgba(255, 75, 125, 0.5);
}

.outro-text {
    color: white; font-size: 24px; font-weight: 900;
    letter-spacing: 2px; text-transform: uppercase;
}

.outro-corner-brand {
    position: absolute; bottom: 40px; right: 30px;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
}

.outro-corner-logo { width: 35px; height: 35px; border-radius: 8px; }
.outro-corner-text { color: white; font-size: 10px; font-weight: bold; opacity: 0.7; }

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}
/* --- OWNER STATUS HUD --- */
.status-owner-footer {
    position: absolute;
    bottom: 30px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: space-between;
    padding: 0 30px;
    z-index: 230;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

.owner-stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

.owner-stat-item i {
    font-size: 20px;
}

.owner-stat-item span {
    font-size: 12px;
    font-weight: 600;
}
/* --- BOOST WIZARD STYLES --- */
#boost-wizard-page { background: #f0f2f5; z-index: 1000; color: #111; }
.boost-card { background: white; margin: 15px; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.boost-step-title { font-size: 20px; font-weight: 800; margin-bottom: 10px; color: var(--primary); }
.boost-option { display: flex; align-items: center; gap: 15px; padding: 15px; border: 2px solid #eee; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
.boost-option.active { border-color: var(--primary); background: rgba(255, 75, 125, 0.05); }
.boost-footer { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }

/* --- AD STATUS UI --- */
.ad-tag { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-top: 3px; border: 1px solid rgba(255,255,255,0.3); }
.ad-action-bar { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 230; }
.btn-ad-message { background: var(--primary); color: white; padding: 12px 30px; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 75, 125, 0.4); display: flex; align-items: center; gap: 10px; border: none; cursor: pointer; }
/* --- ðŸ“± PROFESSIONAL COMPACT GROUP BUBBLES --- */

/* Wrapper for received messages to align avatar and bubble */
.msg-row {
    display: flex;
    align-items: flex-end; /* Pushes avatar to the bottom corner of the bubble */
    gap: 8px;
    margin-bottom: 12px;
    width: 100%;
}

/* The small profile picture in the corner */
.msg-avatar-corner {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* The Message Bubble: Narrow and compact like the screenshot */
.message {
    max-width: 70% !important; 
    padding: 6px 10px !important;
    font-size: 14.5px !important;
    line-height: 1.3;
    border-radius: 12px;
    position: relative;
}

/* Sender Name inside bubble (Distinct Blue color) */
.message-sender-name {
    display: block;
    font-size: 12px;
    font-weight: 800;
    margin-bottom: 2px;
    color: #34b7f1; /* WhatsApp Light Blue */
    cursor: pointer;
}

/* Sent vs Received Corner Logic */
.message.sent { 
    align-self: flex-end; 
    border-bottom-right-radius: 2px !important; 
}

.message.received { 
    align-self: flex-start; 
    border-bottom-left-radius: 2px !important; 
}

/* Hide Kelvin's own name in his sent bubbles */
.message.sent .message-sender-name { 
    display: none; 
}

/* Fix for system messages (center them, remove background) */
.message.is-system {
    align-self: center;
    max-width: 90% !important;
    background: transparent !important;
    color: #8696a0;
    font-size: 12px !important;
    text-align: center;
}
/* --- STATUS RING STYLES --- */
.avatar-status-wrapper {
    position: relative;
    width: 58px;
    height: 58px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.status-ring {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2px;
    transition: 0.3s;
}

/* Green when there is a new status */
.ring-unread {
    border: 2px solid #25D366;
}

/* Gray when all statuses are viewed */
.ring-viewed {
    border: 2px solid #ccc;
}

/* No border if they haven't posted a status */
.ring-none {
    border: 2px solid transparent;
}

/* Ensure the avatar stays centered inside the ring */
.list-avatar-chat {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white; /* The gap effect */
}
/* --- ðŸ“¥ REPLY PREVIEW (Above Input) --- */
#reply-preview-bar {
    display: none;
    background: #1f2c34; /* Darker grey like screenshot */
    padding: 10px 15px;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
    margin: 0 10px;
    border-left: 4px solid #a29bfe; /* Purple border like screenshot */
    position: relative;
    animation: slideUp 0.2s ease;
}

.reply-preview-name { color: #a29bfe; font-size: 13px; font-weight: bold; margin-bottom: 2px; }
.reply-preview-text { color: #8696a0; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.close-reply { position: absolute; top: 8px; right: 10px; color: #8696a0; cursor: pointer; }

/* --- ðŸ’¬ QUOTED MESSAGE (Inside Bubble) --- */
.quoted-container {
    background: rgba(0, 0, 0, 0.2);
    border-left: 4px solid #ffffff; /* White border for sent, or use purple for received */
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 5px;
    font-size: 13px;
}
.message.sent .quoted-container { border-left-color: #a29bfe; } /* Purple border on your replies */
.quoted-name { font-weight: bold; color: #a29bfe; margin-bottom: 2px; font-size: 12px; }
.quoted-text { color: #d1d7db; }

/* Swipe Animation */
.message { transition: transform 0.1s ease-out; }
/* --- STATUS PRIVACY UI --- */
.privacy-desc {
    padding: 15px 20px;
    font-size: 13px;
    color: #667781;
    line-height: 1.6;
}

.check-mark-green {
    color: #00a884;
    font-size: 18px;
}

.exclusion-item.selected {
    background: rgba(255, 71, 87, 0.05);
}

.exclusion-item.selected .select-checkbox {
    background: #ff4757;
    border-color: #ff4757;
}
/* --- STORAGE & DATA PROFESSIONAL STYLES --- */
.storage-usage-card { padding: 20px; background: white; border-bottom: 1px solid #f0f0f0; }
.usage-bar { height: 6px; background: #e9edef; border-radius: 10px; overflow: hidden; display: flex; margin: 15px 0; }
.usage-fill-app { background: #00a884; height: 100%; }
.usage-fill-other { background: #ffd279; height: 100%; }

.storage-detail-item { display: flex; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #f8f9fa; }
.storage-size-label { color: #667781; font-size: 14px; margin-left: auto; }

/* Media Grid for Deletion Page */
.media-manager-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; background: #fff; }
.manager-item { aspect-ratio: 1; position: relative; cursor: pointer; }
.manager-item img { width: 100%; height: 100%; object-fit: cover; }
.manager-check { position: absolute; bottom: 8px; right: 8px; color: white; display: none; }
.manager-item.selected { filter: brightness(0.7); }
.manager-item.selected .manager-check { display: block; }

/* ðŸŒŸ APP-STYLE DARK DIALOG ðŸŒŸ */
.app-dialog-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.7); z-index: 5000; 
    display: none; align-items: center; justify-content: center; 
}
.app-dialog { 
    background: #1f2c34; color: white; width: 85%; max-width: 320px; 
    border-radius: 28px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
}
.dialog-title { font-size: 20px; font-weight: 500; margin-bottom: 20px; }
.check-row { display: flex; align-items: center; gap: 15px; padding: 12px 0; cursor: pointer; }
.check-box-ui { width: 20px; height: 20px; border: 2px solid #8696a0; border-radius: 2px; position: relative; }
.check-row.active .check-box-ui { background: #00a884; border-color: #00a884; }
.check-row.active .check-box-ui::after { content: 'âœ”'; position: absolute; top: -2px; left: 2px; font-size: 14px; color: #1f2c34; }
.dialog-btns { display: flex; justify-content: flex-end; gap: 25px; margin-top: 20px; color: #00a884; font-weight: 600; font-size: 14px; }
/* --- BOT MANAGEMENT UI --- */
.bot-setup-card { background: white; margin: 15px; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.command-item { 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 15px 0; border-bottom: 1px solid #f0f2f5; cursor: pointer; 
}
.command-info { flex: 1; margin-right: 15px; }
.command-title { font-weight: 600; color: #111b21; font-size: 15px; }
.command-desc { font-size: 12px; color: #667781; margin-top: 2px; }

.bot-config-icon {
    width: 45px; height: 45px; background: #e8f5e9; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: #008069;
}
/* --- FULL-SCREEN IMAGE PREVIEW OVERLAY --- */
.image-viewer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    animation: fadeIn 0.2s ease-out;
}

.viewer-header {
    height: 65px;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    color: white;
    z-index: 10;
}

.viewer-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.viewer-meta .viewer-name {
    font-weight: 600;
    font-size: 16px;
}

.viewer-meta .viewer-time {
    font-size: 12px;
    opacity: 0.8;
}

.viewer-actions {
    display: flex;
    gap: 22px;
    font-size: 18px;
}

.viewer-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.viewer-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

/* --- DROPDOWN MENU SYSTEM --- */

/* 1. Define the Hidden class */
.hidden {
    display: none !important;
}

/* 2. Style the Menu to Float over the header */
.iv-menu {
    position: absolute;   /* Takes it out of the flex flow */
    top: 50px;            /* Adjusted to sit below the header icons */
    right: 10px;          
    background: #232d36;  /* Dark WhatsApp Business background color */
    width: 200px;
    border-radius: 4px;
    padding: 8px 0;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5); /* Shadow for depth against black */
    z-index: 20000;       /* Higher than the overlay z-index to stay on top */
}

/* 3. Style the items inside the menu */
.iv-menu-item {
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    color: #e9edef;
    font-size: 15px;
    cursor: pointer;
    transition: background 0.2s;
}

.iv-menu-item:active {
    background: #374048; /* Highlight when tapped on mobile */
}

.iv-menu-item i {
    width: 20px;
    color: #8696a0; /* Greyish icon color */
    font-size: 18px;
    text-align: center;
}
.status-caption-style {
    position: absolute;
    bottom: 90px; /* Sits above the reply/owner footer */
    width: 100%;
    text-align: center;
    color: white;
    padding: 20px 15px;
    font-size: 18px;
    z-index: 250;
    word-wrap: break-word;
    /* Soft dark gradient background for readability */
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
    pointer-events: none; /* Allows clicks to pass through to the tap-to-next logic */
}
/* --- WHATSAPP-STYLE LOGO ANIMATION --- */

/* 1. Container to center everything */
.logo-container {
    position: relative;
    width: 120px; /* Total width occupied by pulses */
    height: 120px;
    margin: 0 auto 30px; /* Center horizontally, margin bottom */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 2. The Main Green Circle holding your image */
.logo-anim {
    width: 90px;
    height: 90px;
    /* WhatsApp Green Gradient */
    background: linear-gradient(135deg, #25D366, #128C7E); 
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10; /* Ensures it stays on top of pulses */
    box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4); /* Nice green shadow */
    /* Subtle breathing animation */
    animation: floatLogo 3s ease-in-out infinite;
}

/* 3. The Pulsing Rings */
.pulse-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(37, 211, 102, 0.6); /* Semi-transparent green */
    opacity: 0;
    z-index: 1; /* Behind the main logo */
    animation: pulseOut 2.5s infinite ease-out;
}

/* Delays the second ring for a ripple effect */
.pulse-ring.delay {
    animation-delay: 1s;
}

/* --- KEYFRAMES (The Animation Logic) --- */

/* Makes the main logo breathe gently */
@keyframes floatLogo {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Makes the rings expand and fade out */
@keyframes pulseOut {
    0% {
        transform: scale(0.8);
        opacity: 0.7;
    }
    100% {
        transform: scale(2); /* Expands to double size */
        opacity: 0; /* Fades away */
    }
}
/* Media Grid Layout */
#storage-media-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 images per row */
    gap: 3px;
    align-content: start;
}

/* Individual Media Item Wrapper */
.storage-item {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1; /* Perfect square */
    cursor: pointer;
    overflow: hidden;
}

.storage-item img, .storage-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Selection Overlay (Hidden by default) */
.storage-item .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    display: none; /* Show when selected */
    align-items: center;
    justify-content: center;
}

/* The Checkmark */
.storage-item .checkmark {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid white;
    background: transparent;
}

/* ðŸŒŸ WHEN SELECTED STATE */
.storage-item.selected .overlay {
    display: flex;
}

.storage-item.selected .checkmark {
    background: #00a884; /* WhatsApp Green */
    border-color: #00a884;
    display: flex;
    align-items: center;
    justify-content: center;
}

.storage-item.selected .checkmark::after {
    content: 'âœ”';
    font-size: 12px;
    color: white;
}
/* Forces the modal to overlay EVERYTHING including live video players */
#battle-invite-modal, #cohost-invite-modal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.8) !important;
    display: none; /* Controlled by JS flex */
    justify-content: center;
    align-items: center;
    z-index: 100000 !important;
}
@keyframes winPop {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

#arena-timer-display.pulse-red {
    color: #ff4757;
    animation: pulse 0.5s infinite alternate;
}
/* --- PROFILE QUICK VIEW POPUP --- */
.profile-popup-overlay {
    display: none; 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); 
    z-index: 10000; 
    justify-content: center; 
    align-items: center;
}

.profile-popup-box {
    width: 280px; 
    background: white; 
    border-radius: 4px; 
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
    animation: popIn 0.2s ease-out;
}

.popup-img-container {
    width: 100%; 
    height: 280px; 
    position: relative; 
    cursor: pointer;
}

.popup-img-container img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}

.popup-name-bar {
    position: absolute; 
    top: 0; left: 0; 
    width: 100%; 
    padding: 10px 15px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent); 
    color: white; 
    font-weight: 500; 
    font-size: 17px;
}

.popup-action-bar {
    display: flex; 
    justify-content: space-around; 
    padding: 5px 0; 
    background: white;
}

.popup-btn {
    font-size: 18px; 
    color: #008069; 
    padding: 12px; 
    cursor: pointer;
    transition: 0.2s;
}

.popup-btn:active {
    background: #f0f0f0;
}

@keyframes popIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
/* Blurs content when a screenshot is attempted on web */
.security-blur {
    filter: blur(25px) grayscale(1);
    pointer-events: none;
    user-select: none;
    transition: filter 0.2s ease;
}

/* Dark overlay for blocked content */
#security-lock-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 100000;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-align: center;
    padding: 30px;
}
/* --- ðŸŽµ FLOATING MUSIC PILL STYLE --- */
.music-pill {
    background: rgba(20, 20, 20, 0.7);
    backdrop-filter: blur(8px);
    border-radius: 20px;
    padding: 6px 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.1);
    max-width: 220px;
    margin: 0 auto;
}

.music-pill span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.music-pill i.remove-music {
    font-size: 16px;
    margin-left: 5px;
    opacity: 0.7;
    padding: 4px;
    cursor: pointer;
}
.effect-item {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    margin: 0 15px;
    opacity: 0.6;
    transition: 0.3s;
}

.effect-item.active {
    opacity: 1;
    transform: scale(1.1);
}

.effect-icon {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    margin-bottom: 5px;
    border: 2px solid transparent;
}

.effect-item.active .effect-icon {
    border-color: #ffeb3b;
    background: rgba(255, 235, 59, 0.2);
}
/* --- TIKTOK STYLE LOADER --- */
.video-loader-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.2);
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: center;
    z-index: 200;
    pointer-events: none;
}

.tiktok-spinner {
    width: 45px;
    height: 45px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
.pill-btn {
    background: #f1f1f2;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 14px;
    font-weight: 600;
    color: #111;
    cursor: pointer;
}

.tag-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #111;
    font-weight: 500;
    cursor: pointer;
}

.tag-row i {
    color: #ccc;
    font-size: 14px;
}
/* --- ðŸ¦ BANK WITHDRAWAL STYLES --- */
.bank-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 25px;
}

.bank-card {
    background: #1c2733;
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 20px 10px;
    text-align: center;
    cursor: pointer;
    transition: 0.3s;
}

.bank-card.active {
    border-color: #00a884;
    background: rgba(0, 168, 132, 0.1);
    box-shadow: 0 0 15px rgba(0, 168, 132, 0.2);
}

.bank-logo {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    margin-bottom: 10px;
    object-fit: contain;
    background: white;
    padding: 5px;
}

.bank-name {
    color: white;
    font-size: 13px;
    font-weight: 700;
}

.withdraw-form-group {
    background: #1c2733;
    border-radius: 20px;
    padding: 20px;
    margin-top: 10px;
    animation: fadeIn 0.3s ease;
}

.payout-label {
    font-size: 11px;
    color: #8696a0;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: block;
}
/* Filter Preview Styling */
.filter-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    min-width: 70px;
    cursor: pointer;
    transition: 0.2s;
}

.filter-preview-circle {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    border: 2px solid transparent;
    overflow: hidden;
    background: #333;
}

.filter-item.active .filter-preview-circle {
    border-color: #ff4b7d; /* Highlight color */
}

.filter-label {
    color: white;
    font-size: 11px;
    font-weight: 600;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

#filter-categories span {
    white-space: nowrap;
    cursor: pointer;
}
@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
.timer-pill {
    background: transparent;
    border: none;
    color: #8e8e93;
    padding: 6px 16px;
    border-radius: 18px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: 0.2s;
}
.timer-pill.active {
    background: white;
    color: black;
}
#countdown-number {
    animation: zoomPulse 1s infinite;
}
@keyframes zoomPulse {
    0% { transform: scale(1.5); opacity: 0; }
    50% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.8); opacity: 0; }
}
/* Vertical slider for Movie Feed vs Horizontal slider for Photos */
#movie-container {
    touch-action: pan-y; /* Allows vertical swipes for next video */
}

#image-slider-track {
    touch-action: pan-x; /* Allows horizontal swipes for photos */
}

.dot {
    transition: all 0.2s ease;
}

/* Scaling dots like John's screenshot */
.dot.active {
    transform: scale(1.3);
    background: white !important;
}
</style>
</head>
<body>

<div id="app-frame">
    <div class="disclaimer">NOTE: This is a functional prototype. Users shown are demos. Real users require app deployment.</div>

    <div id="landing-page" class="page full-screen">
    <div class="lang-container" style="position: absolute; top: 20px; right: 20px; z-index: 10;">
        <select id="lang-select" class="lang-dropdown" onchange="app.changeLanguage(this.value)">
            <option value="en">English ðŸ‡ºðŸ‡¸</option>
            <option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
            <option value="es">EspaÃ±ol ðŸ‡ªðŸ‡¸</option>
            <option value="pt">PortuguÃªs ðŸ‡§ðŸ‡·</option>
        </select>
    </div>

    <div class="welcome-box">
        <div class="logo-container">
            <div class="logo-anim">
                <img src="https://cdn-icons-png.flaticon.com/512/4359/4359959.png" alt="App Logo" style="width: 55px; height: 55px; object-fit: contain;">
            </div>
            <div class="pulse-ring"></div>
            <div class="pulse-ring delay"></div>
        </div>
        <h1 data-i18n="app_name" style="margin-top: 20px;">Global Connect</h1>
        <p data-i18n="app_slogan" style="opacity: 0.9; margin-bottom: 40px; font-size: 18px;">Discover. Chat. Bond.</p>
        <button class="btn btn-primary" data-i18n="btn_started" onclick="app.goToPage('auth-page')">Get Started</button>
        <div class="terms" style="margin-top: 30px; font-size: 13px;">
            <span data-i18n="terms_agree">By continuing, you agree to our</span> <u>Terms</u> & <u>Privacy Policy</u>.
        </div>
    </div>
</div>


<div id="auth-page" class="page full-screen" style="padding-top: 0; background: white;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
        <div style="font-weight: 500; font-size: 18px; color: #008069;"></div> 
        <div style="position: relative;">
            <i class="fa-solid fa-ellipsis-vertical" onclick="app.toggleAuthMenu()" style="font-size: 20px; color: #54656f; padding: 10px; cursor: pointer;"></i>
            <div id="auth-menu-dropdown" class="chat-menu" style="top: 40px; right: 0; width: 260px; transform-origin: top right;">
                <div class="menu-item" data-i18n="menu_companion" onclick="app.openLinkCompanion()">Link as companion device</div>
                <div class="menu-item" data-i18n="menu_help" onclick="alert('Help section coming soon')">Help</div>
            </div>
        </div>
    </div>

    <div style="padding-top: 10px; display: flex; flex-direction: column; align-items: center;">
        <h2 data-i18n="auth_title" style="margin-bottom: 20px; text-align: center; color: #111b21;">Sign in to Global Connect</h2>
        <div style="width: 85%; text-align: center; font-size: 14px; color: #54656f; margin-bottom: 30px; line-height: 1.5;">
            <span data-i18n="auth_desc">Choose a method to verify your account and start chatting.</span> 
        </div>

        <button class="btn btn-google" id="google-login-btn" style="width: 85%;">
            <i class="fa-brands fa-google"></i> 
            <span data-i18n="btn_google">Continue with Google</span>
        </button>

        <div style="text-align: center; margin: 25px; color: #aaa; font-size: 12px; font-weight: bold;">OR</div>
        
        <input type="email" class="input-box" placeholder="Email Address" id="email-input" style="width: 85%;">
        <input type="password" class="input-box" placeholder="Password" id="password-input" style="width: 85%;">
        
        <button class="btn btn-primary" id="email-login-btn" style="width: 85%; background: #008069; margin-top: 20px;" data-i18n="btn_next">Next</button>
        <p data-i18n="auth_footer" style="text-align: center; font-size: 12px; color: #54656f; margin-top: 15px;">(New users automatically signed up)</p>

        <div style="margin-top: 20px; text-align: center; width: 100%;">
            <p style="color: #54656f; font-size: 14px; margin-bottom: 10px;">OR</p>
            <button class="btn" 
                    style="background: transparent; color: #008069; border: 1px solid #ddd; width: 85%; font-weight: 600; border-radius: 30px; padding: 12px;" 
                    onclick="app.goToPage('phone-auth-page')">
                Try another method
            </button>
        </div>
    </div>
</div>
<div id="verification-page" class="page full-screen" style="background: white; z-index: 1000;">
    <div style="padding: 40px 25px; text-align: center;">
        <div style="width: 80px; height: 80px; background: #f0f2f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;">
            <i class="fa-solid fa-envelope-shield" style="font-size: 35px; color: var(--primary);"></i>
        </div>
        <h2 style="color: #111b21; margin-bottom: 10px;">Verify your identity</h2>
        <p style="color: #667781; font-size: 14px; line-height: 1.5; margin-bottom: 30px;">
            We've sent a 6-digit code to <br><b id="display-user-email" style="color: #111;"></b>
        </p>

        <input type="number" id="otp-input" placeholder="000 000" 
               oninput="if(this.value.length === 6) app.verifyEmailOTP()"
               style="width: 200px; text-align: center; font-size: 32px; letter-spacing: 5px; border: none; border-bottom: 3px solid var(--primary); outline: none; margin-bottom: 20px; font-weight: bold;">

        <div id="otp-timer-container" style="font-size: 14px; color: #667781;">
            Resend code in <span id="otp-countdown" style="color: var(--primary); font-weight: bold;">02:00</span>
        </div>

        <button id="resend-btn" class="btn" style="background: transparent; color: #888; font-size: 14px; margin-top: 20px; display: none;" onclick="app.requestNewOTP()">
            Resend Code
        </button>
        
        <p id="lockout-msg" style="color: var(--danger); font-size: 12px; margin-top: 15px; display: none;">
            <i class="fa-solid fa-clock"></i> You must wait 24 hours to request a new code.
        </p>

        <div style="margin-top: 40px; border-top: 1px solid #f0f2f5; padding-top: 20px;">
            <span style="color: #667781; font-size: 14px;">Not your email? </span>
            <span style="color: var(--primary); font-weight: bold; cursor: pointer; text-decoration: underline;" onclick="app.logout()">Sign Out</span>
        </div>
    </div>
</div>

    <div id="onboard-1" class="page full-screen">
        <div class="onboard-header">
            <div class="progress-bar"><div class="progress-fill" style="width: 33%"></div></div>
            <h2>What defines you?</h2>
            <p style="color: grey; margin-top: 10px;">Share your passions and interests.</p>
        </div>
        <textarea class="input-box" rows="6" placeholder="E.g., I love Afrobeats, coding, and trying new foods..." id="onboard-bio"></textarea>
        <button class="btn btn-primary" onclick="app.goToPage('onboard-2')">Next</button>
    </div>
    <div id="onboard-2" class="page full-screen">
        <div class="onboard-header">
            <div class="progress-bar"><div class="progress-fill" style="width: 66%"></div></div>
            <h2>Where are you?</h2>
            <p style="color: grey; margin-top: 10px;">We use this to find people near you.</p>
        </div>
        <button class="btn btn-google" id="get-location-btn" style="margin-top: 40px;"><i class="fa-solid fa-location-arrow"></i> Use Current Location</button>
        <div id="location-status" style="text-align: center; margin-top: 20px; color: var(--primary);"></div>
        <button class="btn btn-primary hidden" id="onboard-2-next" onclick="app.goToPage('onboard-3')">Next</button>
    </div>
    <div id="onboard-3" class="page full-screen">
        <div class="onboard-header">
            <div class="progress-bar"><div class="progress-fill" style="width: 100%"></div></div>
            <h2>Add a Photo</h2>
        </div>
        <div style="text-align: center; padding: 30px;">
            <div style="width: 180px; height: 180px; background: #f0f0f0; border-radius: 50%; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--primary);">
                <img id="profile-preview" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.5;">
            </div>
            <input type="file" id="profile-upload" accept="image/*" style="display: none;">
            <button class="btn btn-google" onclick="document.getElementById('profile-upload').click()">Choose Photo</button>
            <button class="btn btn-primary" onclick="app.completeOnboarding()">Finish</button>
        </div>
    </div>
    <div id="restore-chat-page" class="page full-screen" style="background: #0b141a; color: white; z-index: 190;">
    <div style="padding: 40px 25px; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%;">
        
        <i class="fa-solid fa-clock-rotate-left" style="font-size: 60px; color: #00a884; margin-bottom: 30px;"></i>
        
        <h2 style="font-size: 24px; margin-bottom: 15px;">Restore your chats</h2>
        <p style="color: #8696a0; font-size: 15px; line-height: 1.5; margin-bottom: 40px;">
            Restore your message history and media from your Google Account's storage. If you don't restore now, you won't be able to do it later.
        </p>

        <div id="restore-info-box" style="width: 100%; text-align: left; background: #1f2c34; padding: 20px; border-radius: 15px; margin-bottom: 30px; display: none;">
            <div style="font-size: 14px; color: #00a884; font-weight: bold; margin-bottom: 5px;">Backup found</div>
            <div id="restore-email-label" style="font-size: 16px; margin-bottom: 5px;">email@gmail.com</div>
            <div id="restore-size-label" style="font-size: 13px; color: #8696a0;">Size: 45 MB</div>
        </div>

        <div id="restore-progress-container" style="display: none; width: 100%; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; font-size: 13px; color: #00a884; margin-bottom: 8px;">
                <span>Restoring messages...</span>
                <span id="restore-pct">0%</span>
            </div>
            <div style="width: 100%; height: 4px; background: #232d36; border-radius: 20px; overflow: hidden;">
                <div id="restore-progress-fill" style="width: 0%; height: 100%; background: #00a884; transition: width 0.1s linear;"></div>
            </div>
        </div>

        <button id="restore-start-btn" class="btn" style="background: #00a884; color: #111b21; width: 100%; border-radius: 25px; font-weight: bold;" onclick="app.startRestoreFlow()">Restore</button>
        
        <button id="restore-skip-btn" class="btn" style="background: transparent; color: #8696a0; width: 100%; margin-top: 10px;" onclick="app.goToPage('home-page')">Skip</button>
    </div>
</div>   

    <div id="home-page" class="page">
        <div class="top-nav">
        <!-- PASTE THIS INSIDE <div class="top-nav"> on your Home Page -->
<i class="fa-solid fa-clapperboard nav-icon" 
   style="font-size: 20px; color: var(--primary); margin-right: 15px; cursor: pointer;" 
   onclick="app.openMoviePage()">
</i>
            <div style="font-weight: 800; font-size: 20px; color: var(--primary); letter-spacing: -1px;">Global Connect</div>
            <div class="nav-item" onclick="app.goToPage('settings-page')"><i class="fa-solid fa-sliders"></i></div>
        </div>
        <div class="card-stack">
            <div class="user-card">
                <img src="https://images.unsplash.com/photo-1589156280159-27698a70f29e?auto=format&fit=crop&w=800&q=80">
                <div class="card-info">
                    <h2 style="font-size: 28px;">Nia, 24 <i class="fa-solid fa-circle-check" style="color: #00C853; font-size: 18px;"></i></h2>
                    <p style="font-size: 16px; margin-top: 5px;"><i class="fa-solid fa-location-dot"></i> Lagos, Nigeria</p>
                    <p style="margin-top: 15px; font-size: 15px; opacity: 0.9; line-height: 1.4;">Fashion designer. Lover of art, jazz, and good conversation.</p>
                </div>
                <div class="card-actions">
                    <div class="action-btn" style="color: var(--primary)" onclick="app.likeUser('nia_24')"><i class="fa-solid fa-heart"></i></div>
                    <div class="action-btn" style="color: var(--secondary)" onclick="app.openChat('nia_24', 'Nia')"><i class="fa-solid fa-comment-dots"></i></div>
                </div>
            </div>
        </div>
    </div>

       <div id="settings-page" class="page">
    <div class="top-nav">
        <div class="nav-item" onclick="app.goToPage('chat-list-page')">
            <i class="fa-solid fa-arrow-left"></i>
        </div>
        <div style="font-weight: bold; font-size: 18px;">Settings</div>
        <div class="nav-item" style="opacity: 0">.</div>
    </div>

    <div class="settings-list">
        <div class="settings-category">Account & Privacy</div>
        
        <div class="settings-item" onclick="app.goToPage('account-options-page')">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-circle-user" style="color: #54656f; width: 25px; text-align: center; font-size: 20px;"></i>
                <div>
                    <div style="font-size: 16px; color: #111b21;">Account</div>
                    <div style="font-size: 13px; color: #667781;">Email, password, add account</div>
                </div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>
        <div class="settings-item" onclick="app.openMyProfile()">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-pencil" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>Edit Profile (Full)</span>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>

        <div class="settings-item" onclick="app.openPrivacySettings()">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-lock" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>Privacy</span>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>

        <div class="settings-item" onclick="app.goToPage('chats-settings-page')">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-regular fa-comment-dots" style="color: #54656f; width: 25px; font-size: 20px; text-align: center;"></i>
                <div>
                    <div style="font-size: 16px; color: #111b21;">Chats</div>
                    <div style="font-size: 13px; color: #667781;">Theme, wallpapers, chat history</div>
                </div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>

        <div class="settings-item" onclick="app.goToPage('full-notifications-settings-page')">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-regular fa-bell" style="color: #54656f; width: 25px; text-align: center; font-size: 20px;"></i>
                <div>
                    <div style="font-size: 16px; color: #111b21;">Notifications</div>
                    <div style="font-size: 13px; color: #667781;">Message, group & call tones</div>
                </div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>

        <div class="settings-item" style="justify-content: space-between; padding: 15px 20px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-ghost" style="color: #6c5ce7; width: 25px; text-align: center;"></i>
                <div>
                    <div style="font-size: 16px; color: #111b21;">Private Profile</div>
                    <div style="font-size: 12px; color: #667781;">Hide my profile from others</div>
                </div>
            </div>
            <label class="switch">
                <input type="checkbox" id="global-privacy-switch" onchange="App.toggleMyGlobalPrivacy(this.checked)">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="settings-item" onclick="App.openPrivateSettingsPage()">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-eye-slash" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>Private Chats</span>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>

        <div class="settings-category">Security</div>
        <div class="settings-item" onclick="app.openLockSetup()">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-user-shield" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>App Lock</span>
            </div>
            <div id="lock-status-label" style="font-size: 13px; color: gray;">Off</div>
        </div>

        <div class="settings-category">App Settings</div>
        <div class="settings-item">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-language" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span data-i18n="settings_language">Language</span>
            </div>
            <select id="settings-lang-select" class="lang-dropdown" 
                    style="color: #111; border-color: #ddd; background: #f0f2f5;" 
                    onchange="app.changeLanguage(this.value)">
                <option value="en">English ðŸ‡ºðŸ‡¸</option>
                <option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
                <option value="es">EspaÃ±ol ðŸ‡ªðŸ‡¸</option>
                <option value="pt">PortuguÃªs ðŸ‡§ðŸ‡·</option>
            </select>
        </div>

        <div class="settings-category">Data & Storage</div>
        <div class="settings-item" onclick="app.clearLocalStorage()" style="color: var(--danger);">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-trash" style="width: 25px; text-align: center;"></i>
                <span>Clear Local History & Cache</span>
            </div>
        </div>        

        <div class="settings-category">Support</div>
        
        <div class="settings-item" onclick="app.goToPage('report-page')">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-bug" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>Report a Problem</span>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>
        <div class="settings-item" onclick="app.openStorageData()">
    <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
        <i class="fa-solid fa-database" style="color: #54656f; width: 25px; text-align: center; font-size: 20px;"></i>
        <div>
            <div style="font-size: 16px; color: #111b21;">Storage and data</div>
            <div id="storage-summary-label" style="font-size: 13px; color: #667781;">Calculating...</div>
        </div>
    </div>
    <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
</div>

        <div class="settings-item" onclick="app.goToPage('help-page')">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-regular fa-circle-question" style="color: #54656f; width: 25px; font-size: 20px; text-align: center;"></i>
                <div>
                    <div style="font-size: 16px; color: #111b21;">Help</div>
                    <div style="font-size: 13px; color: #667781;">Help center, contact us, system check</div>
                </div>
            </div>
        </div>

        <div class="settings-item" style="color: var(--danger); margin-top: 20px; border-top: 1px solid #f0f2f5;" onclick="app.logout()">
            <div class="settings-info" style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-right-from-bracket" style="width: 25px; text-align: center;"></i>
                <span>Log Out</span>
            </div>
        </div>
    </div>
</div>

<div id="edit-profile-page" class="page">
    
    <div class="d-banner"></div>
    
    <div class="d-header">
        <div class="d-avatar-container">
            <img id="my-avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="d-avatar-img">
            <div class="d-status-indicator"></div>
        </div>
        
        <div class="d-names">
            <h2 id="my-name" class="d-display-name">Loading...</h2>
            <p id="my-username-top" class="d-username">@user</p>
        </div>
    </div>

    <div class="d-body">
        
        <button class="d-btn-edit" onclick="app.openProfileEditor()">
            <i class="fa-solid fa-pencil" style="font-size:12px;"></i> Edit Profile
        </button>

        <div class="d-nitro-banner" style="background: linear-gradient(135deg, #1e1f22 0%, #2b2d31 100%); border: 1px solid #5865F2;">
            <div class="d-nitro-header">
                <span style="font-weight: 800; letter-spacing: 0.5px;">CREATOR HUB</span>
                <i class="fa-solid fa-xmark" style="color:#b5bac1; font-size:16px;"></i>
            </div>
            <div style="margin-bottom: 15px; font-size: 13px; color: #b5bac1;">Track your gift earnings and withdraw to your account.</div>
            <div class="d-nitro-btns">
                <button class="d-nitro-btn primary" onclick="app.openWalletPage()" style="background: #5865F2; color: white; cursor: pointer;">
                    <i class="fa-solid fa-vault"></i> Wallet 
                </button>
                <button class="d-nitro-btn" onclick="app.openShopPage()" style="cursor: pointer;">
                    <i class="fa-solid fa-shop"></i> Shop
                </button>
            </div>
        </div>

        <div class="d-card" onclick="app.openWalletPage()" style="cursor: pointer; margin-top: 10px;">
            <div class="d-card-row">
                <span>Orbs Balance</span>
                <div style="background:#111; padding:4px 10px; border-radius:12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                    <i class="fa-solid fa-gem" style="color:#ff4b7d; font-size:10px;"></i> 
                    <span id="my-orb-balance">0</span>
                </div>
            </div>
        </div>

        <div class="d-card">
            <div class="d-label-small">Member Since</div>
            <div class="d-value-row">
                <i class="fa-brands fa-discord" style="color:#777;"></i> Loading...
            </div>
        </div>

        <div class="d-card" onclick="app.goToPage('chat-list-page')">
            <div class="d-card-row">
                <span>Friends</span>
                <div style="display:flex; align-items:center; gap:8px;">
                    <div class="d-friend-faces">
                        <span style="color:#b5bac1; font-size:11px;">Loading...</span>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color:#b5bac1; font-size:12px;"></i>
                </div>
            </div>
        </div>

        <div class="d-card">
            <div class="d-card-row">
                <span style="font-weight:400; font-size:13px;">Note (only visible to you)</span>
                <i class="fa-solid fa-note-sticky" style="color:#b5bac1;"></i>
            </div>
        </div>

    </div>
</div>

    <div id="report-page" class="page">
        <div class="top-nav">
            <div class="nav-item" onclick="app.goToPage('settings-page')"><i class="fa-solid fa-arrow-left"></i></div>
            <div style="font-weight: bold;">Report Issue</div>
            <div class="nav-item" style="opacity:0">.</div>
        </div>
        <div style="padding: 20px;">
            <p style="margin-bottom: 20px;">Describe the problem or user you want to report.</p>
            <textarea class="input-box" rows="8" placeholder="Details..."></textarea>
            <button class="btn btn-danger" onclick="alert('Report submitted successfully.'); app.goToPage('settings-page')">Submit Report</button>
        </div>
    </div>

    <div id="chat-list-page" class="page" style="display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: white;">
    
    <div class="top-nav" style="position: relative; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 10;">
        
        <div id="chat-title-text" style="font-weight: 800; font-size: 22px; color: var(--primary);">Global Connect</div>
        
        <div id="chat-search-container" style="display: none; flex: 1; margin: 0 15px;">
            <input type="text" id="chat-user-search-input" placeholder="Search users..." 
                   style="width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 15px;"
                   oninput="app.filterChatList(this.value)">
        </div>

        <div style="display: flex; align-items: center; gap: 20px;">
            <div id="top-archive-icons" style="display: flex; align-items: center;"></div>

            <i class="fa-solid fa-camera" style="font-size: 20px; color: #333; cursor: pointer;" onclick="app.openUploadPage()"></i>
            
            <i class="fa-solid fa-magnifying-glass" id="chat-search-trigger" style="font-size: 20px; color: #333; cursor: pointer;" onclick="app.toggleChatSearch()"></i>
            
            <i class="fa-solid fa-ellipsis-vertical" style="font-size: 20px; color: #333; cursor: pointer; padding: 10px;" onclick="app.toggleChatMenu()"></i>
        </div>

        <div id="chat-selection-header" class="top-nav" style="display: none; background: #008069; color: white; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; padding: 0 15px; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 30px;">
                <i class="fa-solid fa-arrow-left" onclick="app.exitSelectionMode()" style="cursor: pointer;"></i>
                <div id="selection-count" style="font-size: 19px; font-weight: 500;">1</div>
            </div>
            <div style="display: flex; gap: 25px; align-items: center;">
                <i class="fa-solid fa-thumbtack" id="pin-icon" onclick="app.togglePinSelected()" style="cursor: pointer; font-size: 18px;"></i>
                <i class="fa-solid fa-trash" onclick="app.deleteSelectedChats()" style="cursor: pointer; font-size: 18px;"></i>
                <i class="fa-solid fa-volume-xmark" id="mute-icon" onclick="app.toggleMuteSelected()" style="cursor: pointer; font-size: 18px;"></i>
                <i class="fa-solid fa-ellipsis-vertical" onclick="app.toggleSelectionExtraMenu()" style="cursor: pointer; font-size: 18px; padding: 5px;"></i>
            </div>
            
            <div id="selection-extra-menu" class="chat-menu" style="top: 50px; right: 10px;">
                <div class="menu-item" onclick="app.archiveSelected()"><i class="fa-solid fa-box-archive"></i> Archive chat</div>
                <div class="menu-item" id="selection-dynamic-action" onclick="app.confirmActionSelected()" style="color: #d32f2f;">
                    <i class="fa-solid fa-ban" id="selection-dynamic-icon"></i> 
                    <span id="selection-dynamic-text">Block</span>
                </div>
            </div>
        </div>

        <div id="chat-menu-dropdown" class="chat-menu">
            <div class="menu-item" onclick="app.openCreateGroup()"><i class="fa-solid fa-user-group"></i> New group</div>
            <div class="menu-item" onclick="app.openCreateChannel()"><i class="fa-solid fa-bullhorn"></i> New broadcast</div>
            <div class="menu-item" onclick="app.openLinkedDevices()"><i class="fa-solid fa-laptop"></i> Linked devices</div>
            <div class="menu-item" onclick="app.goToPage('settings-page')"><i class="fa-solid fa-gear"></i> Settings</div>
        </div>
    </div> <div class="stories-rail" style="display: flex; gap: 15px; padding: 15px; background: white; border-bottom: 1px solid #f0f0f0; overflow-x: auto; min-height: 110px; flex-shrink: 0; white-space: nowrap; z-index: 5;">
        <div class="story-item" onclick="app.handleMyStatusClick()" style="display: flex; flex-direction: column; align-items: center; width: 70px;">
            <div class="story-circle-container" style="position: relative; width: 65px; height: 65px; margin-bottom: 5px;">
                <img id="my-status-thumb" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" 
                     style="width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 0 0 2px #ddd; padding: 2px;">
                <div id="my-plus-icon" style="position: absolute; bottom: 2px; right: 2px; background: #00a884; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; z-index: 10;">
                    <i class="fa-solid fa-plus"></i>
                </div>
            </div>
            <div class="story-name" style="font-size: 11px; color: #555;">My Status</div>
        </div>
        <div id="other-stories-container" style="display:flex; gap:15px;"></div>
    </div>

    <div id="chat-list-container" style="flex: 1; overflow-y: auto; padding-bottom: 80px; -webkit-overflow-scrolling: touch;">
        </div>

</div> 

</div>
<div id="create-group-select-page" class="page full-screen" style="z-index: 150; background: white;">
    <div class="top-nav" style="background: var(--primary, #008069); color: white;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" id="cg-back-btn" onclick="app.goToPage('chat-list-page')" style="cursor: pointer;"></i>
            <div>
                <div id="cg-page-title" style="font-weight: bold; font-size: 18px;">New Group</div>
                
                <div id="cg-selected-count" style="font-size: 12px; opacity: 0.8;">Add participants</div>
            </div>
        </div>
        <div style="font-size: 14px; font-weight: bold; display:none;">
            <span id="cg-count">0</span>/100
        </div>
    </div>

    <div id="cg-selected-strip" style="background: white; padding: 10px; display: none; gap: 10px; overflow-x: auto; border-bottom: 1px solid #eee;"></div>

    <div style="padding: 10px; background: white; border-bottom: 1px solid #f0f0f0;">
        <input type="text" placeholder="Search name..." oninput="app.filterContacts(this.value)" 
               style="width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; background: #f9f9f9;">
    </div>

    <div id="cg-contact-list" style="flex: 1; overflow-y: auto; background: white; padding-bottom: 80px;">
        </div>

    <div id="cg-next-btn" class="floating-btn" onclick="app.openGroupInfoInput()" 
         style="position: fixed; bottom: 30px; right: 20px; width: 55px; height: 55px; background: var(--primary, #008069); border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; color: white; font-size: 20px; z-index: 160;">
        <i class="fa-solid fa-arrow-right" id="cg-btn-icon"></i>
    </div>
</div>

<div id="create-group-details-page" class="page full-screen" style="z-index: 151; background: #f0f2f5;">
    <div class="top-nav" style="background: var(--primary); color: white;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" onclick="app.goToPage('create-group-select-page')" style="cursor: pointer;"></i>
            <div>
                <div style="font-weight: bold; font-size: 18px;">New Group</div>
                <div style="font-size: 12px; opacity: 0.8;">Add subject</div>
            </div>
        </div>
    </div>

    <div style="padding: 30px 20px; background: white; display: flex; align-items: center; gap: 20px;">
        <div style="position: relative; width: 60px; height: 60px; cursor: pointer;" onclick="document.getElementById('cg-icon-input').click()">
            <img id="cg-icon-preview" src="https://cdn-icons-png.flaticon.com/512/166/166258.png" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #ddd;">
            <div style="position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                <i class="fa-solid fa-camera"></i>
            </div>
        </div>
        <input type="file" id="cg-icon-input" accept="image/*" style="display:none;" onchange="app.handleGroupIcon(this)">

        <div style="flex: 1; border-bottom: 2px solid var(--primary);">
            <input id="cg-name-input" type="text" placeholder="Group Subject (Optional)" maxlength="25" 
                   style="width: 100%; padding: 10px 0; border: none; outline: none; font-size: 16px;">
        </div>
        <i class="fa-regular fa-face-smile" style="color: #888; font-size: 20px;"></i>
    </div>

    <div style="padding: 15px; font-size: 13px; color: #666; font-weight: bold;">PARTICIPANTS: <span id="cg-final-count">0</span></div>
    
    <div id="cg-final-list" style="padding: 0 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
        </div>

    <div onclick="app.createGroup()" 
         style="position: absolute; bottom: 20px; right: 20px; width: 55px; height: 55px; background: #00C853; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; color: white; font-size: 20px;">
        <i class="fa-solid fa-check"></i>
    </div>
</div>

    <div id="matches-page" class="page">
        <div class="top-nav"><div>Matches & Likes</div></div>
        <div id="matches-list-container" style="flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            </div>
    </div>

    <div id="requests-page" class="page">
        <div class="top-nav"><div>Friend Requests</div></div>
        <div style="padding: 20px; text-align: center; color: grey; margin-top: 50px;">No new requests.</div>
    </div>

      <div id="chat-room" class="page full-screen" style="z-index: 60;">
    <div class="top-nav" style="background: var(--primary); color: white; border: none;" onclick="App.viewContactInfo()">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fa-solid fa-arrow-left nav-item" onclick="event.stopPropagation(); app.goToPage('chat-list-page')" style="color: white; cursor: pointer; padding: 10px;"></i>
            <img id="chat-room-avatar" src="" class="list-avatar" style="width: 35px; height: 35px; margin: 0; border: 2px solid white;">
            <div>
                <div id="chat-room-name" style="font-weight: 600; font-size: 17px;"></div>
                <div id="chat-user-status" style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: -2px;">Available</div>
            </div>
        </div>
        <div style="display: flex; gap: 15px;">
            <i class="fa-solid fa-video nav-item" style="color: white; font-size: 20px;" id="start-video-btn"></i>
            <i class="fa-solid fa-phone nav-item" style="color: white; font-size: 18px;" id="start-voice-btn"></i>
        </div>
    </div>

    <div class="chat-messages" id="message-container"></div>
    
    <div id="msg-selection-header" class="top-nav" style="position: absolute; top: 0; left: 0; width: 100%; background: #008069; color: white; z-index: 50; display: none; align-items: center; justify-content: space-between; padding: 0 15px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <i class="fa-solid fa-arrow-left" onclick="app.deselectMessage()"></i>
            <div style="font-size: 18px; font-weight: bold;">1</div>
        </div>
        <div style="display: flex; gap: 20px;">
            <i class="fa-solid fa-reply" style="cursor: pointer;" onclick="app.replyToSelected()"></i>
            <i class="fa-solid fa-trash" style="cursor: pointer;" onclick="app.promptDeleteMessage()"></i>
            <i class="fa-regular fa-copy" style="cursor: pointer;" onclick="app.copySelectedMessage()"></i>
            <i class="fa-solid fa-share" style="cursor: pointer;"></i>
        </div>
    </div>

    <div id="delete-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; width: 85%; max-width: 320px; padding: 20px; border-radius: 3px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <div id="delete-modal-title" style="font-size: 16px; margin-bottom: 20px; color: #333;">Delete message?</div>
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 15px;">
                <div id="del-everyone-btn" style="color: #008069; font-weight: bold; cursor: pointer; display: none;" onclick="app.confirmDelete('everyone')">Delete for everyone</div>
                <div id="del-me-btn" style="color: #008069; font-weight: bold; cursor: pointer;" onclick="app.confirmDelete('me')">Delete for me</div>
                <div style="color: #008069; font-weight: bold; cursor: pointer;" onclick="document.getElementById('delete-modal-overlay').style.display='none'">Cancel</div>
            </div>
        </div>
    </div>

    <div id="blocked-chat-footer" style="display: none; flex-direction: column; background: #f0f2f5; z-index: 110; position: absolute; bottom: 0; width: 100%;">
        <div style="padding: 10px; text-align: center; background: rgba(0,0,0,0.05); color: #667781; font-size: 13px; border-top: 1px solid #ddd;" onclick="App.unblockUser(state.currentChatId)">
            You blocked this contact. Tap to unblock.
        </div>
        <div style="display: flex; height: 60px; border-top: 1px solid #ddd;">
            <div onclick="App.clearChatHistory()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; color: #d32f2f; font-weight: 500; cursor: pointer;">
                <i class="fa-regular fa-trash-can"></i> Delete chat
            </div>
            <div onclick="App.unblockUser(state.currentChatId)" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; color: #00a884; font-weight: 500; cursor: pointer; border-left: 1px solid #ddd;">
                <i class="fa-solid fa-ban"></i> Unblock
            </div>
        </div>
    </div>

    <div class="chat-input-area" id="chat-input-bar" style="flex-direction: column; align-items: stretch; padding: 0; background: transparent;">
        
        <div id="reply-preview-bar" style="display:none; background: #f0f2f5; padding: 8px 10px; border-left: 5px solid #00a884; margin: 5px 10px 0 10px; border-radius: 5px; position: relative;">
            <div class="close-reply" onclick="app.cancelReply()" style="position: absolute; top: 5px; right: 5px; padding: 5px; cursor: pointer; color: #54656f;">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <div class="reply-preview-name" id="reply-to-name" style="font-size: 13px; color: #008069; font-weight: bold; margin-bottom: 3px;">Name</div>
            <div class="reply-preview-text" id="reply-to-text" style="font-size: 13px; color: #54656f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Message snippet...</div>
        </div>

        <div style="display: flex; align-items: center; gap: 8px; width: 100%; padding: 10px;">
            
            <div class="recording-ui" style="display: none; align-items: center; flex: 1; gap: 10px;">
                <div class="rec-dot" style="width: 10px; height: 10px; background: red; border-radius: 50%; animation: pulse 1s infinite;"></div>
                <div id="rec-timer" style="font-variant-numeric: tabular-nums; width: 45px; font-weight:bold;">0:00</div>
                <div id="rec-status" style="flex: 1; color: #999; text-align: center; font-size: 13px; text-transform:uppercase; letter-spacing:1px;">
                    <i class="fa-solid fa-lock" style="margin-right:5px;"></i> Slide up to Lock
                </div>
                <div onclick="app.cancelRecording()" style="color: var(--danger); font-weight: bold; cursor: pointer; padding: 10px;">Cancel</div>
            </div>

            <div class="text-ui" style="display: flex; flex: 1; align-items: center; gap: 8px; background: white; border-radius: 25px; padding: 5px 10px; border: 1px solid #ddd;">
                <i class="fa-regular fa-face-smile" id="input-emoji-btn" onclick="app.toggleEmojiDrawer()" style="color: #8696a0; font-size: 24px; cursor: pointer; padding: 5px;"></i>
                
                <textarea id="msg-input" class="input-box" autocomplete="off" rows="1" 
                          style="margin: 0; flex: 1; border: none; padding: 10px; outline: none; background: transparent; resize: none; max-height: 120px; overflow-y: auto; line-height: 1.5;" 
                          placeholder="Message" 
                          oninput="app.onInputType(); app.handleTyping()" 
                          onfocus="app.closeEmojiDrawer()"></textarea>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="img-upload" accept="image/*" style="display: none;" onchange="app.sendImage(this)">
                    <i class="fa-solid fa-paperclip" onclick="app.toggleAttachMenu()" style="color: #8696a0; font-size: 22px; cursor: pointer; transform: rotate(45deg);"></i>
                    <div id="view-once-btn" onclick="app.toggleViewOnce()" style="border: 2px solid #ccc; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #ccc; cursor: pointer; transition: 0.2s;">1</div>
                </div>
            </div>

            <div id="main-action-btn" class="chat-btn" 
                 style="background: var(--primary); color: white; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; margin-left: 5px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" 
                 onmousedown="app.handleMicStart(event)" 
                 onmouseup="app.handleMicEnd(event)" 
                 ontouchstart="app.handleMicStart(event)" 
                 ontouchend="app.handleMicEnd(event)" 
                 ontouchmove="app.handleMicMove(event)" 
                 onclick="app.handleSendClick()">
                <i class="fa-solid fa-microphone" id="action-icon"></i>
            </div>
        </div>
    </div>
</div>


<div id="emoji-drawer" style="display: none; height: 300px; background: #111b21; flex-direction: column; border-top: 1px solid #2a3942; flex-shrink: 0;">
    
    <div style="display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #2a3942; height: 45px;">
        <div style="padding: 10px;"><i class="fa-solid fa-magnifying-glass" style="color: #8696a0;"></i></div>
        <div style="flex: 1; display: flex; justify-content: center; height: 100%;">
            <div class="drawer-tab active" id="d-tab-emoji" onclick="app.switchDrawerTab('emoji')" style="flex:1; display:flex; justify-content:center; align-items:center; cursor:pointer; border-bottom: 3px solid #00a884; color: #e9edef;">
                <i class="fa-regular fa-face-smile" style="font-size:20px;"></i>
            </div>
            <div class="drawer-tab" id="d-tab-sticker" onclick="app.switchDrawerTab('sticker')" style="flex:1; display:flex; justify-content:center; align-items:center; cursor:pointer; border-bottom: 3px solid transparent; color: #8696a0;">
                <i class="fa-regular fa-note-sticky" style="font-size:20px;"></i>
            </div>
            <div class="drawer-tab" id="d-tab-gif" onclick="app.switchDrawerTab('gif')" style="flex:1; display:flex; justify-content:center; align-items:center; cursor:pointer; border-bottom: 3px solid transparent; color: #8696a0;">
                <span style="border: 1px solid currentColor; border-radius: 4px; padding: 0 4px; font-size: 10px; font-weight: bold;">GIF</span>
            </div>
        </div>
        <div style="padding: 10px;" onclick="document.getElementById('msg-input').value='';"><i class="fa-solid fa-delete-left" style="color: #8696a0;"></i></div>
    </div>

    <div id="drawer-content" style="flex: 1; overflow-y: auto;">
        
        <div id="view-emoji" style="display: block; padding: 10px;">
            <div id="chat-emoji-grid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px;"></div>
        </div>

               <div id="view-sticker" style="display: none; padding: 10px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; justify-items: center;">
                <img src="https://cdn-icons-png.flaticon.com/512/9376/9376999.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712139.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
                <img src="https://cdn-icons-png.flaticon.com/512/166/166258.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
                <img src="https://cdn-icons-png.flaticon.com/512/9376/9376973.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
                <img src="https://cdn-icons-png.flaticon.com/512/9376/9376979.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712009.png" style="width: 64px; height: 64px; object-fit: contain; cursor: pointer;" onclick="app.sendSticker(this.src)">
            </div>
        </div>

        <div id="view-gif" style="display: none; padding: 20px; text-align: center; color: #8696a0;">
            <i class="fa-solid fa-film" style="font-size: 30px;"></i>
            <p style="margin-top: 10px;">GIF Search Coming Soon</p>
        </div>
    </div>
</div>

   </div>
      
    <div id="user-info-page" class="page full-screen" style="z-index: 70; background: #f0f2f5;">
    <div class="top-nav" style="background: white;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('chat-room')" style="color: #54656f;"></i>
        <div style="font-weight: bold; margin-left: 15px;">Contact info</div>
    </div>
    
    <div style="flex:1; overflow-y:auto;">
        <div style="background:white; padding:30px 20px; text-align:center; margin-bottom:10px; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <img id="info-avatar" src="" onclick="App.openProfilePopup()" style="width:120px; height:120px; border-radius:50%; object-fit:cover; margin-bottom:15px; border:1px solid #eee; cursor: pointer;">
            
            <h2 id="info-name" style="margin:0; font-size: 22px; color: #111b21;">User Name</h2>
            <p id="info-phone" style="color:#667781; font-size: 14px; margin-top: 5px;">+00 0000 0000</p>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding: 0 10px;">
                <div class="channel-action-btn" onclick="app.openEditContact()">
                    <i id="save-contact-icon" class="fa-solid fa-user-plus"></i>
                    <span id="save-contact-text">Save</span>
                </div>
                <div class="channel-action-btn" onclick="app.shareContact()">
                    <i class="fa-solid fa-share-nodes"></i>
                    <span>Share</span>
                </div>
                <div class="channel-action-btn" onclick="app.openGiftPage()">
                    <i class="fa-solid fa-gift" style="color: #6c5ce7;"></i>
                    <span>Gift</span>
                </div>
                <div class="channel-action-btn" onclick="app.openContactShop()">
                    <i class="fa-solid fa-bag-shopping"></i>
                    <span>Shop</span>
                </div>
            </div>
        </div>

        <div style="background:white; padding:15px 20px; margin-bottom:10px;">
            <div style="color:#00a884; font-size:13px; font-weight:bold; margin-bottom:10px; text-transform: uppercase;">About</div>
            <div id="info-bio" style="font-size:16px; color:#111b21;">Available</div>
        </div>

        <div style="background:white; padding:5px 0;">
            <div class="list-item" style="color:#d32f2f; border-bottom: none;" onclick="App.openBlockModal()">
                <i class="fa-solid fa-ban" style="width: 30px; text-align: center;"></i>
                <span>Block User</span>
            </div>
            <div class="list-item" style="color:#d32f2f; border-bottom: none;" onclick="app.openReportUserModal()">
                <i class="fa-solid fa-thumbs-down" style="width: 30px; text-align: center;"></i>
                <span>Report User</span>
            </div>
        </div>
    </div>
</div>
      
        <div id="call-overlay">
        <div class="call-info">
            <h2 id="call-status">Connecting...</h2>
            <p id="call-partner"></p>
        </div>
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        
        <div class="call-controls">
            <div class="call-btn" onclick="webrtc.toggleAudio()"><i class="fa-solid fa-microphone" id="mic-icon"></i></div>
            <div class="call-btn hangup" onclick="webrtc.hangUp()"><i class="fa-solid fa-phone-slash"></i></div>
            <div class="call-btn" onclick="webrtc.toggleVideo()"><i class="fa-solid fa-video" id="cam-icon"></i></div>
            
            <div class="call-btn" onclick="app.openAvatarMenu()" style="background: #6c5ce7;">
                <i class="fa-solid fa-mask"></i>
            </div>
        </div>
    </div> <div id="incoming-call-modal">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="caller-avatar" id="incoming-avatar">
        <h2 style="margin-bottom: 10px;" id="incoming-name">Incoming Call...</h2>
        <div style="display: flex; gap: 30px; margin-top: 30px;">
            <div class="call-btn hangup" onclick="webrtc.rejectCall()"><i class="fa-solid fa-phone-slash"></i></div>
            <div class="call-btn" style="background: #00C853;" onclick="webrtc.acceptCall()"><i class="fa-solid fa-phone"></i></div>
        </div>
    </div>

    <div class="bottom-nav" id="main-nav">
        <div class="nav-item" onclick="app.goToPage('home-page')" id="nav-home"><i class="fa-solid fa-house"></i></div>
        <div class="nav-item" onclick="app.goToPage('matches-page')" id="nav-matches"><i class="fa-solid fa-heart"></i></div>
        <div class="nav-item" onclick="app.goToPage('requests-page')" id="nav-requests"><i class="fa-solid fa-user-group"></i><div class="badge">1</div></div>
        <div class="nav-item" onclick="app.goToPage('chat-list-page')" id="nav-chat"><i class="fa-solid fa-comment"></i></div>
    </div>

</div> <canvas id="avatar-canvas" style="position: absolute; top: -9999px; width: 640px; height: 480px;"></canvas>
    <div id="avatar-menu" style="display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 20px; z-index: 300; flex-direction: column; animation: slideUp 0.3s ease;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Choose Avatar</h3>
            <i class="fa-solid fa-xmark" onclick="app.closeAvatarMenu()" style="font-size:24px; cursor:pointer;"></i>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div onclick="app.selectAvatar('man')" style="text-align: center; cursor: pointer;">
                <img src="https://img.freepik.com/free-psd/3d-illustration-person-with-sunglasses_23-2149436188.jpg" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #eee; object-fit:cover;">
                <div style="font-size: 12px; margin-top: 5px;">Man</div>
            </div>
            <div onclick="app.selectAvatar('woman')" style="text-align: center; cursor: pointer;">
                <img src="https://img.freepik.com/free-psd/3d-illustration-person-with-pink-hair_23-2149436186.jpg" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #eee; object-fit:cover;">
                <div style="font-size: 12px; margin-top: 5px;">Woman</div>
            </div>
            <div onclick="app.selectAvatar('business')" style="text-align: center; cursor: pointer;">
                <img src="https://img.freepik.com/free-psd/3d-illustration-business-man-with-glasses_23-2149436194.jpg" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #eee; object-fit:cover;">
                <div style="font-size: 12px; margin-top: 5px;">Boss</div>
            </div>
            <div onclick="app.closeAvatarMenu()" style="text-align: center; cursor: pointer;">
                <div style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #eee; display:flex; align-items:center; justify-content:center; background:#eee;">
                    <i class="fa-solid fa-ban"></i>
                </div>
                <div style="font-size: 12px; margin-top: 5px;">None</div>
            </div>
        </div>
    </div>
    <style>@keyframes slideUp { from { bottom: -200px; } to { bottom: 0; } }</style>
            <div id="movie-page" class="page full-screen" style="background: #000; z-index: 100;">
    
    <div class="movie-overlay-top">
        <i class="fa-solid fa-magnifying-glass" 
           style="font-size: 20px; opacity: 0.9; cursor: pointer;" 
           onclick="app.goToPage('movie-search-page'); app.loadTrendingVideos();">
        </i>
        
        <div class="movie-tabs">
            <span class="${state.feedMode === 'following' ? 'active' : ''}" onclick="app.switchFeedMode('following')">Following</span>
            <span class="${state.feedMode === 'friends' ? 'active' : ''}" onclick="app.switchFeedMode('friends')">Friends</span>
            <span class="${state.feedMode === 'foryou' ? 'active' : ''}" onclick="app.switchFeedMode('foryou')">For You</span>
        </div>
        
        <i class="fa-solid fa-bars" style="font-size: 20px; opacity: 0.9;"></i>
    </div>

    <div id="movie-container" 
         ondblclick="app.handleVideoDoubleTap(event)" 
         style="width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; background: #000;">
        
        <div id="movie-content-wrapper" style="width: 100%; height: 100%;">
            <div id="movie-loader" class="video-loader-overlay">
                <div class="tiktok-spinner"></div>
            </div>
        </div>

        <div id="carousel-dots" style="display: none; position: absolute; bottom: 160px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 20;"></div>
        
        <div id="no-video-msg" style="position: absolute; color: white; text-align: center; display: none;">
            <i class="fa-solid fa-video-slash" style="font-size: 50px; margin-bottom: 15px; opacity: 0.8;"></i>
            <h3>No Clips Yet</h3>
        </div>

        <div class="movie-right-bar">
            <div style="position: relative; margin-bottom: 5px;" onclick="app.openUserProfile(state.clips[state.clipIndex].ownerId)">
                <img id="movie-user-avatar" src="" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid white;">
                <i class="fa-solid fa-circle-plus" style="position: absolute; bottom: -5px; left: 14px; color: #ff4b7d; background: white; border-radius: 50%; font-size: 18px;"></i>
            </div>

            <div class="movie-action" onclick="app.toggleVideoLike()">
                <i class="fa-solid fa-heart" id="movie-like-heart"></i>
                <span id="movie-like-count">0</span>
            </div>

            <div class="movie-action" onclick="app.openComments()">
                <i class="fa-solid fa-comment-dots"></i>
                <span id="movie-comment-count-label">0</span>
            </div>

            <div class="movie-action" onclick="app.toggleVideoFavorite()">
                <i class="fa-solid fa-bookmark" id="movie-favorite-icon"></i>
                <span id="movie-favorite-count">0</span>
            </div>

            <div class="movie-action" onclick="app.openShareMenu()">
                <i class="fa-solid fa-share" style="transform: scaleX(-1);"></i>
                <span>Share</span>
            </div>

            <div class="movie-action" onclick="app.togglePostMenu()">
                <i class="fa-solid fa-ellipsis"></i>
                <span>More</span>
            </div>

            <div class="movie-action" style="margin-top: 10px;">
                <img src="" class="music-disc">
            </div>
        </div>

        <div class="movie-bottom-info">
            <h3 id="movie-username" style="margin-bottom: 5px;">@username</h3>
            <div id="movie-text-overlay-preview"></div> <p id="movie-bio" style="font-size: 14px; margin-bottom: 10px;">Check out this post!</p>
            <div style="font-size: 13px; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-music"></i> 
                <marquee scrollamount="4" style="width: 150px;">Original Sound</marquee>
            </div>
        </div>
    </div>

    <div class="movie-nav-bar">
        <div class="movie-nav-item active" onclick="app.goToPage('home-page')">
            <i class="fa-solid fa-house"></i> Home
        </div>
        
        <div class="movie-nav-item">
            <i class="fa-solid fa-user-group"></i> Friends
        </div>
        
        <div class="movie-nav-item" onclick="app.openUploadPage()">
            <div style="width: 45px; height: 30px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                <div style="position: absolute; left: -3px; top: 0; width: 3px; height: 100%; background: #20D5EC; border-radius: 3px 0 0 3px;"></div>
                <div style="position: absolute; right: -3px; top: 0; width: 3px; height: 100%; background: #ff4b7d; border-radius: 0 3px 3px 0;"></div>
                <i class="fa-solid fa-plus" style="color: black; font-size: 16px; margin: 0;"></i>
            </div>
        </div>

        <div class="movie-nav-item" onclick="app.goToPage('chat-list-page')">
            <i class="fa-regular fa-message"></i> Inbox
        </div>
        
        <div class="movie-nav-item" onclick="app.openMyProfilePage()">
            <i class="fa-regular fa-user"></i> Me
        </div>
    </div>
</div>


        <div id="public-profile-page" class="page full-screen" style="background: #f8f9fa; z-index: 110;">
        
        <div class="top-nav" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div class="nav-item" onclick="app.backToLastPage()"><i class="fa-solid fa-arrow-left"></i></div>
            <div id="pp-username-top" style="font-weight: 800; font-size: 16px;">@username</div>
            <div class="nav-item" onclick="app.openChat(state.viewingProfileId, document.getElementById('pp-name').innerText, document.getElementById('pp-avatar').src)"><i class="fa-solid fa-paper-plane"></i></div>
        </div>

        <div style="flex: 1; overflow-y: auto;">
            <div style="background: white; padding: 25px 20px; border-radius: 0 0 30px 30px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.03);">
                <img id="pp-avatar" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--bg); margin-bottom: 10px;">
                <h2 id="pp-name" style="margin: 0; font-size: 22px;">User Name</h2>
                <p id="pp-bio" style="color: gray; font-size: 14px; margin: 5px 0 15px 0; padding: 0 20px;">Loading bio...</p>
                
                <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div id="pp-following" style="font-weight: 900; font-size: 18px;">0</div>
                        <div style="font-size: 12px; color: gray; text-transform: uppercase;">Following</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="pp-followers" style="font-weight: 900; font-size: 18px;">0</div>
                        <div style="font-size: 12px; color: gray; text-transform: uppercase;">Followers</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="pp-likes" style="font-weight: 900; font-size: 18px;">0</div>
                        <div style="font-size: 12px; color: gray; text-transform: uppercase;">Likes</div>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 10px;">
                    <button id="pp-follow-btn" onclick="app.toggleFollow()" class="btn" style="width: auto; padding: 10px 30px; margin: 0; background: var(--primary); font-size: 14px;">Follow</button>
                    <button onclick="app.openChat(state.viewingProfileId, document.getElementById('pp-name').innerText, document.getElementById('pp-avatar').src)" class="btn" style="width: auto; padding: 10px 15px; margin: 0; background: #eee; color: #333; font-size: 14px;"><i class="fa-solid fa-message"></i></button>
                </div>
            </div>

            <div style="padding: 20px;">
                <h4 style="margin-bottom: 15px; color: #333;">Videos</h4>
                
                <div id="pp-video-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    </div>

                <div id="pp-empty-state" style="display: none; text-align: center; padding: 40px 0; color: gray;">
                    <div style="width: 60px; height: 60px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                        <i class="fa-solid fa-video-slash" style="font-size: 24px; opacity: 0.5;"></i>
                    </div>
                    <p>No videos yet</p>
                </div>
            </div>
        </div>
    </div>
       <div id="my-profile-page" class="page full-screen" style="background: #fff; z-index: 90;">
    <div class="top-nav" style="justify-content: space-between; border-bottom: none;">
        <div class="nav-item" onclick="app.goToPage('settings-page')">
            <i class="fa-solid fa-bars"></i>
        </div>
        <div style="font-weight: 800; font-size: 16px;" id="my-profile-handle">@username</div>
        <div class="nav-item"><i class="fa-regular fa-share-from-square"></i></div>
    </div>

    <div style="flex: 1; overflow-y: auto;">
        <div style="text-align: center; padding: 10px 0 20px 0;">
            <div style="position: relative; width: 100px; height: 100px; margin: 0 auto 10px auto;">
                <img id="my-profile-avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" 
                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 1px solid #eee;">
                
                <div onclick="app.goToPage('edit-profile-page')" 
                     style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; cursor: pointer;">
                    <i class="fa-solid fa-camera" style="font-size: 12px;"></i>
                </div>
            </div>
            
            <h2 id="my-profile-name" style="font-size: 20px; margin-bottom: 5px; font-weight: 700; color: #1a1a1a;">Loading...</h2>
            <p id="my-profile-bio" style="font-size: 13px; color: #666; padding: 0 40px; line-height: 1.4;">Loading bio...</p>

            <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                <div style="text-align: center;">
                    <div id="my-profile-following" style="font-weight: 800; font-size: 18px; color: #1a1a1a;">0</div>
                    <div style="font-size: 12px; color: gray;">Following</div>
                </div>
                <div style="text-align: center;">
                    <div id="my-profile-followers" style="font-weight: 800; font-size: 18px; color: #1a1a1a;">0</div>
                    <div style="font-size: 12px; color: gray;">Followers</div>
                </div>
                <div style="text-align: center;">
                    <div id="my-profile-likes" style="font-weight: 800; font-size: 18px; color: #1a1a1a;">0</div>
                    <div style="font-size: 12px; color: gray;">Likes</div>
                </div>
            </div>

            <button onclick="app.goToPage('edit-profile-page')" class="btn" 
                    style="width: 140px; padding: 10px; background: white; border: 1px solid #ddd; color: #111; font-size: 14px; font-weight: 600; margin: 0 auto; border-radius: 4px;">
                Edit profile
            </button>
        </div>

        <div style="display: flex; border-top: 1px solid #eee; border-bottom: 1px solid #eee;">
            <div style="flex: 1; text-align: center; padding: 12px; cursor: pointer;" id="tab-my-videos" onclick="app.switchProfileTab('posts')">
                <i class="fa-solid fa-grip-vertical"></i>
            </div>
            <div style="flex: 1; text-align: center; padding: 12px; color: #ccc; cursor: pointer;" id="tab-liked-videos" onclick="app.switchProfileTab('liked')">
                <i class="fa-regular fa-heart"></i>
            </div>
            <div style="flex: 1; text-align: center; padding: 12px; color: #ccc; cursor: pointer;" id="tab-private-videos" onclick="app.switchProfileTab('private')">
                <i class="fa-solid fa-lock"></i>
            </div>
        </div>

        <div id="my-video-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; padding-top: 1px;">
            </div>
        
        <div id="my-empty-state" style="text-align: center; padding: 80px 20px; display: none;">
            <i class="fa-solid fa-video-slash" style="font-size: 40px; color: #eee; margin-bottom: 15px;"></i>
            <h4 style="color: #1a1a1a;">Share your first video</h4>
            <p style="color: gray; font-size: 13px; margin-top: 5px;">Tap the + button to record or upload</p>
        </div>
    </div>
</div>
        <div id="upload-page" class="page full-screen" style="background: black; z-index: 200;">
    <video id="camera-preview" autoplay playsinline muted></video>
    
    <div id="video-caption-overlay" style="display: none; position: absolute; bottom: 180px; width: 100%; text-align: center; z-index: 100; pointer-events: none;">
        <span id="caption-text-box" style="background: rgba(0,0,0,0.75); color: white; padding: 8px 15px; border-radius: 12px; font-size: 18px; font-weight: bold; display: inline-block; max-width: 85%; line-height: 1.4; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"></span>
    </div>

    <div class="camera-overlay" style="z-index: 110;">
        <div class="camera-top">
            <div class="camera-close" onclick="app.closeUploadPage()"><i class="fa-solid fa-xmark"></i></div>
            <div class="camera-sound" onclick="app.openMusicPicker()">
                <div id="music-pill-display" style="display: none;" class="music-pill">
                    <i class="fa-solid fa-music"></i>
                    <span id="music-pill-name"></span>
                    <i class="fa-solid fa-xmark remove-music" onclick="event.stopPropagation(); app.removeSelectedMusic()"></i>
                </div>
                <div id="music-add-prompt">
                    <i class="fa-solid fa-music"></i> Add Sound
                </div>
            </div>
            <div style="width: 30px;"></div> 
        </div>

        <div style="position: absolute; right: 10px; top: 60px;" class="camera-sidebar">
            <div class="camera-tool" onclick="app.flipCamera()"><i class="fa-solid fa-rotate"></i><span>Flip</span></div>
            <div class="camera-tool" onclick="app.openCountdownDrawer()"><i class="fa-solid fa-stopwatch"></i><span>Timer</span></div>
            <div class="camera-tool" onclick="app.toggleFiltersUI()"><i class="fa-solid fa-wand-magic-sparkles"></i><span>Filters</span></div>
            <div class="camera-tool" onclick="app.toggleAutoCaptions()"><i class="fa-solid fa-closed-captioning"></i><span id="caption-status-label">Captions</span></div>
        </div>

        <div class="camera-bottom">
            <div id="camera-modes-container" class="camera-modes">
                <span onclick="app.openLivePage()" style="cursor: pointer;">LIVE</span>
                <span class="active">VIDEO</span>
                <span>TEMPLATES</span>
            </div>
            <div style="display: flex; width: 100%; justify-content: space-around; align-items: center; padding-bottom: 30px;">
                <div style="width: 45px;"></div>

                <div class="record-btn-outer" id="shutter-btn" onclick="app.toggleRecording()">
                    <div class="record-btn-inner"></div>
                </div>

                <div class="camera-tool" onclick="document.getElementById('video-upload-input').click()">
                    <div class="upload-gallery">
                        <img src="https://cdn-icons-png.flaticon.com/512/1040/1040241.png">
                    </div>
                    Upload
                </div>
                
                <input type="file" id="video-upload-input" 
                       accept="video/*,image/*" 
                       multiple 
                       style="display: none;" 
                       onchange="app.handleUniversalUpload(this)">
            </div>
        </div>
    </div>

    <div id="filters-drawer" style="display: none; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); padding: 20px 0; z-index: 300; border-radius: 20px 20px 0 0; animation: slideUp 0.3s ease;">
        <div style="padding: 0 40px 15px; display: flex; align-items: center; gap: 15px;">
            <span style="color: white; font-size: 12px; font-weight: bold;">80</span>
            <input type="range" min="0" max="100" value="80" style="flex: 1; accent-color: white;">
        </div>
        <div id="filter-categories" style="display: flex; gap: 20px; padding: 0 20px 15px; overflow-x: auto; color: rgba(255,255,255,0.6); font-weight: bold; font-size: 14px; scrollbar-width: none;">
            <span class="active">Portrait</span>
            <span>Landscape</span>
            <span>Food</span>
            <span>Retro</span>
            <span>Film</span>
        </div>
        <div id="filters-scroll-list" style="display: flex; gap: 15px; padding: 10px 20px; overflow-x: auto; scrollbar-width: none;"></div>
    </div>

    <div id="countdown-drawer" class="modal-overlay" style="display: none; align-items: flex-end; z-index: 400;">
        <div class="modal-content bottom-sheet" style="background: #1c1c1e; color: white; padding: 25px; width: 100%; border-radius: 15px 15px 0 0;">
            <div class="modal-handle" style="width: 40px; height: 4px; background: #374248; border-radius: 2px; margin: 0 auto 20px auto;"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <span style="font-weight: bold; font-size: 16px;">Set countdown</span>
                <div style="background: #3a3a3c; border-radius: 20px; padding: 4px; display: flex; gap: 5px;">
                    <button id="btn-timer-3s" class="timer-pill active" onclick="app.setTimerDuration(3)">3s</button>
                    <button id="btn-timer-10s" class="timer-pill" onclick="app.setTimerDuration(10)">10s</button>
                </div>
            </div>

            <div style="margin-bottom: 40px;">
                <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">Drag to set recording limit</div>
                <div style="color: #8e8e93; font-size: 13px; margin-bottom: 15px;" id="limit-label">0.0s</div>
                <input type="range" id="recording-limit-range" min="0" max="17" value="0" step="1" 
                       style="width: 100%; accent-color: #ff4b7d;" oninput="app.updateLimitLabel(this.value)">
            </div>

            <button class="btn btn-primary" style="background: #ff4b7d; border-radius: 4px; width: 100%; height: 50px; border: none; color: white; font-weight: bold; cursor: pointer;" onclick="app.startCountdownSequence()">
                Start countdown
            </button>
        </div>
    </div>

    <div id="countdown-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 500; align-items: center; justify-content: center; pointer-events: none;">
        <div id="countdown-number" style="font-size: 180px; font-weight: 900; color: white; text-shadow: 0 0 30px rgba(0,0,0,0.5);">3</div>
    </div>
</div>


   <div id="editor-page" class="page full-screen" style="background: #111; z-index: 210;">
    
    <div style="height: 70%; position: relative;">
        <video id="editor-preview" loop playsinline class="editor-preview" style="width: 100%; height: 100%; object-fit: cover;"></video>
        
        <div id="text-overlay-preview" style="display: none; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 10; pointer-events: none; text-align: center; width: 80%;">
            <span id="preview-text-content" style="padding: 8px 15px; border-radius: 8px; font-size: 24px; font-weight: 900; white-space: pre-wrap; word-break: break-word; line-height: 1.2;"></span>
        </div>

        <div style="position: absolute; right: 10px; top: 20px; display: flex; flex-direction: column; gap: 20px; color: white;">
            <div class="camera-tool" onclick="app.openEditorText()">
                <i class="fa-solid fa-font"></i>
                <span>Text</span>
            </div>
            <div class="camera-tool" onclick="app.openStickers()">
                <i class="fa-solid fa-note-sticky"></i>
                <span>Sticker</span>
            </div>
            <div class="camera-tool" onclick="app.openTrimTool()">
                <i class="fa-solid fa-scissors"></i>
                <span>Edit Clip</span>
            </div>
            <div class="camera-tool" onclick="app.openMusicSync()">
                <i class="fa-solid fa-music"></i>
                <span>Edit Music</span>
            </div>
        </div>

        <div style="position: absolute; top: 20px; left: 20px; color: white; cursor: pointer;" onclick="app.exitEditor()">
            <i class="fa-solid fa-chevron-left"></i> Back
        </div>
    </div>

    <div style="height: 30%; background: black; padding: 10px; display: flex; flex-direction: column; justify-content: space-between;">
        <div style="color: white; font-size: 12px; margin-bottom: 5px;">Edit Clip</div>
        
        <div class="editor-timeline" id="trim-timeline" style="position: relative; height: 50px; background: #222; border-radius: 4px; overflow: visible;">
            <div style="display: flex; height: 100%; opacity: 0.5;">
                <div class="timeline-frame"></div><div class="timeline-frame"></div><div class="timeline-frame"></div>
                <div class="timeline-frame"></div><div class="timeline-frame"></div><div class="timeline-frame"></div>
            </div>
            <div id="trim-slider" style="position: absolute; top: 0; left: 0; right: 0; height: 100%; border: 2px solid #ff4b7d; background: rgba(255, 75, 125, 0.1); pointer-events: none;"></div>
            <div id="handle-start" style="position: absolute; left: 0; top: -5px; width: 12px; height: 60px; background: white; border-radius: 2px; cursor: ew-resize; pointer-events: auto;"></div>
            <div id="handle-end" style="position: absolute; right: 0; top: -5px; width: 12px; height: 60px; background: white; border-radius: 2px; cursor: ew-resize; pointer-events: auto;"></div>
        </div>

        <div class="upload-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <button class="btn-draft" style="width: 45%; background: #333; color: white; padding: 12px; border-radius: 4px; border: none; font-weight: bold;">Drafts</button>
            <button id="next-to-post-btn" class="btn-primary" style="width: 45%; background: #ff4b7d; color: white; padding: 12px; border-radius: 4px; border: none; font-weight: bold;" onclick="app.openVideoPostSettings()">Next</button>
        </div>
    </div>

    <div id="text-editor-modal" class="modal-overlay" style="display: none; background: rgba(0,0,0,0.8); z-index: 500; flex-direction: column;">
        <div class="top-nav" style="background: transparent; color: white; border: none;">
            <div onclick="app.cancelTextEdit()" style="cursor: pointer; font-weight: bold;">Cancel</div>
            <div style="flex: 1; text-align: center;">
                <i class="fa-solid fa-font" id="toggle-bg-style" onclick="app.cycleTextBackground()" style="font-size: 22px; cursor: pointer; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;"></i>
            </div>
            <div onclick="app.saveTextToVideo()" style="color: #ff4b7d; font-weight: bold; cursor: pointer;">Done</div>
        </div>

        <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <textarea id="main-text-input" placeholder="Type something..." 
                      style="width: 100%; background: transparent; border: none; color: white; font-size: 32px; font-weight: 900; text-align: center; outline: none; resize: none; overflow: hidden;"
                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
        </div>

        <div style="padding: 20px; overflow-x: auto; white-space: nowrap; background: rgba(0,0,0,0.4);">
            <div id="text-color-rail" style="display: flex; gap: 15px; justify-content: center;">
                </div>
        </div>
    </div>

    <div id="music-edit-drawer" class="modal-overlay" style="display: none; align-items: flex-end; z-index: 400;">
        <div class="modal-content bottom-sheet" style="background: #1c1c1e; color: white; padding: 25px; border-radius: 15px 15px 0 0; width: 100%;">
            <div class="modal-handle" style="width: 40px; height: 4px; background: #374248; border-radius: 2px; margin: 0 auto 20px auto;"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <span style="font-weight: bold; font-size: 16px;">Volume</span>
                <i class="fa-solid fa-check" onclick="app.closeMusicSync()" style="color: #ff4b7d; cursor: pointer; font-size: 20px;"></i>
            </div>
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 10px; color: #8e8e93;">
                    <span>Original sound</span>
                    <span id="label-vol-original">100%</span>
                </div>
                <input type="range" id="vol-original-range" min="0" max="100" value="100" style="width: 100%; accent-color: #fff;" oninput="app.updateSoundVolumes()">
            </div>
            <div id="added-music-control-area"></div>
        </div>
    </div>
</div>



<div id="status-dashboard-page" class="page full-screen" style="background: #f0f2f5; z-index: 120;">
    <div class="top-nav">
        <div class="nav-item" onclick="app.goToPage('chat-list-page')"><i class="fa-solid fa-arrow-left"></i></div>
        <div style="font-weight: bold;">My Status</div>
        <div class="nav-item" style="opacity:0">.</div>
    </div>
    
    <div style="padding: 20px;">
        <div style="background: white; padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; cursor: pointer;" onclick="app.openStatusEditor()">
            <div style="width: 50px; height: 50px; background: #f0f2f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ff4b7d;">
                <i class="fa-solid fa-camera" style="font-size: 20px;"></i>
            </div>
            <div>
                <div style="font-weight: bold; color: #ff4b7d;">Add to my status</div>
                <div style="font-size: 12px; color: gray;">Tap to add photo or video</div>
            </div>
        </div>

        <h4 style="color: gray; margin-bottom: 10px;">My Updates</h4>
        <div id="my-active-statuses" style="background: white; border-radius: 10px; overflow: hidden;">
            <div style="padding: 20px; text-align: center; color: gray; font-size: 13px;">No active status</div>
        </div>
    </div>
</div>

<div id="status-viewer-page" class="page full-screen" style="background: black; z-index: 200; justify-content: center; display: none;">
    
    <div id="status-progress-bar" style="position: absolute; top: 10px; left: 0; width: 100%; padding: 0 10px; display: flex; gap: 5px; z-index: 220;"></div>
    
    <div style="position: absolute; top: 25px; left: 0; width: 100%; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; z-index: 220;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fa-solid fa-arrow-left" onclick="app.closeStatusViewer()" style="color: white; font-size: 20px; cursor: pointer; text-shadow: 0 1px 2px rgba(0,0,0,0.5);"></i>
            <img id="viewer-avatar" src="" style="width: 40px; height: 40px; border-radius: 50%; border: 1px solid white; object-fit: cover;">
            <div style="display: flex; flex-direction: column;">
                <div style="color: white; font-weight: bold; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" id="viewer-name">User</div>
                <div style="color: rgba(255,255,255,0.9); font-size: 11px; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" id="viewer-time">Just now</div>
            </div>
        </div>
        <i class="fa-solid fa-ellipsis-vertical" onclick="App.toggleStatusMenu()" style="color: white; font-size: 20px; padding: 10px; cursor: pointer;"></i>
    </div>

    <img id="status-image-display" src="" style="width: 100%; height: 100%; object-fit: contain; display: none;" onload="app.onStatusImageLoad()">
    
    <video id="status-video-display" style="width: 100%; height: 100%; object-fit: contain; display: none;" playsinline></video>

    <div id="status-text-display" style="width: 100%; height: 100%; display: none; align-items: center; justify-content: center; flex-direction: column; padding: 30px; text-align: center; box-sizing: border-box;"></div>

    <div id="status-caption-display" style="display: none; position: absolute; bottom: 90px; width: 100%; text-align: center; color: white; padding: 20px 15px; font-size: 17px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); z-index: 250; pointer-events: none; word-wrap: break-word;"></div>

    <div id="status-loader" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 225;">
        <div class="sending-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
    </div>

    <div id="status-owner-footer" class="status-owner-footer" style="display: none; position: absolute; bottom: 20px; width: 100%; z-index: 230;">
        <div class="owner-stat-item" onclick="app.openViewerList(state.activeStories[state.storyIndex].id)">
            <i class="fa-solid fa-eye"></i>
            <span id="owner-view-count-label">0 Views</span>
        </div>
        <div class="owner-stat-item" onclick="app.startBoost()">
            <i class="fa-solid fa-bullhorn"></i>
            <span>Boost</span>
        </div>
    </div>

    <div id="reaction-bar" class="reaction-bar">
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸ˜‚')">ðŸ˜‚</div>
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸ˜')">ðŸ˜</div>
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸ˜®')">ðŸ˜®</div>
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸ˜¢')">ðŸ˜¢</div>
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸ™')">ðŸ™</div>
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸ”¥')">ðŸ”¥</div>
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸŽ‰')">ðŸŽ‰</div>
        <div class="reaction-emoji" onclick="app.sendReply('emoji', 'ðŸ’¯')">ðŸ’¯</div>
    </div>

    <div style="position: absolute; bottom: 20px; left: 0; width: 100%; padding: 0 15px; display: flex; align-items: center; gap: 10px; z-index: 220;">
        <div style="flex: 1; height: 50px; background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(10px); border-radius: 25px; display: flex; align-items: center; padding: 0 20px; border: 1px solid rgba(255,255,255,0.1);">
            <input id="status-reply-input" type="text" placeholder="Reply" style="background: transparent; border: none; color: white; width: 100%; font-size: 16px; outline: none; font-weight: 500;"
                onfocus="document.getElementById('reaction-bar').classList.add('visible')"
                onblur="setTimeout(()=>document.getElementById('reaction-bar').classList.remove('visible'), 200)"
                onkeypress="if(event.key === 'Enter') app.sendReply('text', this.value)">
        </div>
        <div id="status-main-action-btn" onclick="app.toggleStatusLove()" style="width: 50px; height: 50px; background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); cursor: pointer;">
            <i id="status-heart-icon" class="fa-regular fa-heart" style="color: white; font-size: 24px;"></i>
        </div>
    </div>

    <div style="position: absolute; left: 0; top: 0; width: 30%; height: 85%; z-index: 215;" onclick="app.prevStatus()"></div>
    <div style="position: absolute; right: 0; top: 0; width: 30%; height: 85%; z-index: 215;" onclick="app.nextStatus()"></div>
</div>

<div id="status-editor-page" class="page full-screen" style="background: black; z-index: 150; flex-direction: column; color: white;">
    <div style="position: absolute; top: 0; left: 0; width: 100%; z-index: 20; padding: 15px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);">
        <i class="fa-solid fa-xmark" onclick="app.closeStatusEditor()" style="font-size: 24px; padding: 10px; cursor: pointer;"></i>
        <div style="display: flex; gap: 20px;">
            <i class="fa-solid fa-bolt" style="font-size: 20px;"></i>
            <i class="fa-solid fa-gear" style="font-size: 20px;"></i>
        </div>
    </div>

    <div id="status-mode-content" style="flex: 1; position: relative;">
        <div id="mode-media" class="status-mode" style="width: 100%; height: 100%;">
            <video id="status-camera-preview" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;"></video>
            
            <div id="camera-start-btn" onclick="app.openStatusEditor()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; text-align: center; cursor: pointer;">
                <div style="width: 60px; height: 60px; background: rgba(50,50,50,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                    <i class="fa-solid fa-camera" style="font-size: 24px; color: white;"></i>
                </div>
                <div style="font-size: 14px; color: #ccc;">Tap to Start Camera</div>
            </div>

            <div class="gallery-rail">
                <div style="padding: 10px; font-size: 12px; font-weight: bold; text-shadow: 0 1px 2px black;">Recents</div>
                <div class="gallery-scroll">
                    <div onclick="document.getElementById('real-file-input').click()" class="gallery-item"><i class="fa-regular fa-image"></i></div>
                    <div class="gallery-item" style="background: #444;"></div>
                    <div class="gallery-item" style="background: #555;"></div>
                </div>
            </div>
            <div onclick="app.captureStatusPhoto()" class="shutter-button"></div>
        </div>

        <div id="mode-text" class="status-mode hidden" style="width: 100%; height: 100%; background: #5c6bc0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;">
            <textarea id="status-text-input" placeholder="Type a status" style="background: transparent; border: none; color: white; font-size: 38px; text-align: center; width: 80%; outline: none; font-weight: bold; font-family: sans-serif; resize: none;" rows="4"></textarea>
            <div style="position: absolute; top: 100px; right: 20px; display: flex; flex-direction: column; gap: 20px;">
                 <i class="fa-solid fa-font" onclick="app.toggleStatusFont()" style="font-size: 24px; cursor: pointer; text-shadow: 0 1px 2px black;"></i>
                 <i class="fa-solid fa-palette" onclick="app.toggleStatusColor()" style="font-size: 24px; cursor: pointer; text-shadow: 0 1px 2px black;"></i>
            </div>
        </div>

        <div id="mode-voice" class="status-mode hidden" style="width: 100%; height: 100%; background: #4caf50; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;">
            <div class="voice-mic-circle"><i class="fa-solid fa-microphone" style="font-size: 40px;"></i></div>
            <p style="margin-top: 20px; opacity: 0.8;">Hold to record</p>
        </div>
    </div>

    <div style="position: absolute; bottom: 0; left: 0; width: 100%; z-index: 20; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding-bottom: 20px; padding-top: 40px;">
        <div id="text-send-btn" class="hidden" style="position: absolute; bottom: 80px; right: 20px; width: 50px; height: 50px; background: #00a884; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;" onclick="app.prepareStatus('text')"><i class="fa-solid fa-paper-plane"></i></div>
        <div class="status-pill-container">
            <div onclick="app.switchStatusMode('media')" class="status-pill active">Video</div>
            <div onclick="app.switchStatusMode('media')" class="status-pill active">Photo</div>
            <div onclick="app.switchStatusMode('text')" class="status-pill">Text</div>
            <div onclick="app.switchStatusMode('voice')" class="status-pill">Voice</div>
        </div>
    </div>
    <input type="file" id="real-file-input" accept="image/*,video/*" style="display: none;" onchange="app.handleStatusFile(this)">
</div>

<div id="status-review-page" class="page full-screen" style="background: black; z-index: 160; flex-direction: column;">
    <div style="padding: 15px; display: flex; justify-content: space-between; color: white;">
        <i class="fa-solid fa-xmark" onclick="app.closeReviewPage()" style="font-size: 24px; cursor: pointer;"></i>
        <div style="display: flex; gap: 20px;">
            <i class="fa-solid fa-crop-simple"></i>
            <i class="fa-regular fa-face-smile"></i>
            <i class="fa-solid fa-font"></i>
        </div>
    </div>

    <div style="flex: 1; display: flex; align-items: center; justify-content: center; background: #111; position: relative;">
        <img id="review-image" src="" style="max-width: 100%; max-height: 100%; display: none;">
        
        <video id="review-video" style="max-width: 100%; max-height: 100%; display: none;" autoplay loop muted playsinline></video>
    </div>

    <div style="padding: 10px; background: black; display: flex; align-items: center; gap: 10px; padding-bottom: 30px;">
        <div style="flex: 1; background: #333; border-radius: 25px; padding: 10px 15px; display: flex; align-items: center;">
            <i class="fa-solid fa-plus-circle" style="color: #ccc; margin-right: 10px;"></i>
            <input id="status-caption" type="text" placeholder="Add a caption..." 
                   style="background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 16px;">
        </div>
        
        <div onclick="app.prepareStatus('media')" 
             style="width: 50px; height: 50px; background: #00a884; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <i class="fa-solid fa-check" style="color: white; font-size: 20px;"></i>
        </div>
    </div>
</div>

<div id="group-info-page" class="page full-screen" style="background: #e9edef; z-index: 100;">
    <div class="top-nav" style="background: white; position:sticky; top:0; z-index:10;">
        <i class="fa-solid fa-arrow-left" onclick="app.backToChat()" style="color: #54656f;"></i>
        <div style="flex:1;"></div>
        <i class="fa-solid fa-ellipsis-vertical" onclick="app.toggleInfoMenu()" style="color: #54656f; cursor:pointer;"></i>
        
        <div id="info-menu-dropdown" class="chat-menu" style="top: 45px; right: 10px;">
            <div class="menu-item" onclick="app.openGroupSettings()">Group permissions</div>
        </div>
    </div>

    <div style="overflow-y: auto; height: calc(100% - 60px); padding-bottom: 50px;">
        
        <div style="background: white; padding: 20px 0; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid #ddd; margin-bottom: 10px;">
            <div style="position: relative; width: 150px; height: 150px; cursor: pointer;" onclick="app.openGroupIconMenu()">
                <img id="gi-icon" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 1px solid #eee;">
                <div style="position: absolute; top: 0; right: 0; background: #00a884; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border: 3px solid white; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    <i class="fa-solid fa-camera" style="font-size: 20px;"></i>
                </div>
            </div>
            <div id="gi-name" style="font-size: 22px; font-weight: 500; color: #111b21; margin-top: 15px;">Group Name</div>
            <div id="gi-count" style="color: #54656f; margin-top: 5px; font-size: 14px;">Group â€¢ 0 members</div>
        </div>

        <div style="background: white; padding: 15px; margin-bottom: 10px; border-bottom: 1px solid #eee;">
            <div id="gi-desc" style="font-size: 15px; color: #111b21;">Add group description...</div>
            <div style="font-size: 12px; color: #54656f; margin-top: 8px;">Created by <span id="gi-creator">You</span></div>
        </div>

        <div style="background: white; margin-bottom: 10px;">
            
            <div id="gi-bot-row" class="list-item" style="display: none; border-bottom: 1px solid #f0f0f0;" onclick="app.openBotManagement()">
                <div class="bot-config-icon"><i class="fa-solid fa-robot"></i></div>
                <div style="flex: 1; margin-left: 15px;">
                    <div style="font-size: 16px; color: #111b21;">Group Bot Control</div>
                    <div style="font-size: 13px; color: #667781;">Setup automation & security</div>
                </div>
            </div>

            <div class="list-item" style="border-bottom:none;" onclick="app.openNotificationsPage()">
                <i class="fa-regular fa-bell" style="color:#54656f; width:25px;"></i>
                <div style="flex:1; font-size:16px;">Notifications</div>
            </div>
            
            <div class="list-item" style="border-bottom:none;" onclick="app.openEncryptionPage()">
                <i class="fa-solid fa-lock" style="color:#54656f; width:25px;"></i>
                <div style="flex:1;">
                    <div style="font-size:16px;">Encryption</div>
                    <div style="font-size:13px; color:#54656f;">Messages are end-to-end encrypted.</div>
                </div>
            </div>
            
            <div class="list-item" style="border-bottom:none;" onclick="app.openDisappearingPage()">
                <i class="fa-solid fa-stopwatch" style="color:#54656f; width:25px;"></i>
                <div style="flex:1;">
                    <div style="font-size:16px;">Disappearing messages</div>
                    <div style="font-size:13px; color:#54656f;">Off</div>
                </div>
            </div>

            <div id="gi-pending-row" class="list-item" onclick="app.openPendingRequestsScreen()" style="display: none; border-bottom: none; cursor: pointer;">
                <i class="fa-solid fa-user-clock" style="color:#54656f; width:25px;"></i>
                <div style="flex:1; display:flex; justify-content:space-between; align-items:center;">
                     <div style="font-size:16px;">Pending requests</div>
                     <div id="gi-pending-badge" style="color:#008069; font-weight:500;"></div>
                </div>
            </div>

            <div class="list-item" style="border-bottom:none;" onclick="app.openGroupSettings()">
                <i class="fa-solid fa-shield-halved" style="color:#54656f; width:25px;"></i>
                <div style="flex:1; font-size:16px;">Group permissions</div>
            </div>
        </div>

        <div style="background: white; padding-top: 10px;">
            <div style="padding: 0 15px 10px; color: #54656f; font-size: 14px;" id="gi-part-count-header">0 members</div>
            
            <div id="gi-add-btn" class="list-item" onclick="app.openAddMemberScreen()" style="display: flex; align-items: center; gap: 15px; cursor: pointer;">
                <div style="width: 40px; height: 40px; background: #008069; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="fa-solid fa-user-plus"></i>
                </div>
                <div style="font-size: 16px; color: #111b21;">Add members</div>
            </div>

            <div class="list-item" style="display: flex; align-items: center; gap: 15px; cursor: pointer;" onclick="app.openInvitePage()">
                <div style="width: 40px; height: 40px; background: #e9edef; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #54656f;">
                    <i class="fa-solid fa-link"></i>
                </div>
                <div style="font-size: 16px; color: #111b21;">Invite via link or QR code</div>
            </div>

            <div id="gi-member-list"></div>
        </div>    
    </div>
</div>


<div id="group-settings-page" class="page full-screen" style="background: #e9edef; z-index: 101;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #ddd;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('group-info-page')" style="color: #54656f;"></i>
        <div style="margin-left: 20px; font-size: 19px; font-weight: 500;">Group permissions</div>
    </div>

    <div style="padding: 15px 20px; color: #54656f; font-size: 14px; font-weight: 500;">Members can:</div>
    
    <div style="background: white; padding: 0 20px;">
        <div class="setting-item" style="padding: 15px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="display:flex; gap:15px; align-items:center;">
                <i class="fa-solid fa-pen" style="color:#54656f;"></i>
                <div>
                    <div style="font-size: 16px; color:#111b21;">Edit group settings</div>
                    <div style="font-size: 13px; color: #54656f;">Name, icon, description, etc.</div>
                </div>
            </div>
            <label class="switch">
                <input type="checkbox" id="set-edit-info" onchange="app.toggleGroupSetting('editInfo')">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="setting-item" style="padding: 15px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
             <div style="display:flex; gap:15px; align-items:center;">
                <i class="fa-regular fa-comment-dots" style="color:#54656f;"></i>
                <div style="font-size: 16px; color:#111b21;">Send new messages</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="set-send-msgs" onchange="app.toggleGroupSetting('sendMessages')">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="setting-item" style="padding: 15px 0; display: flex; justify-content: space-between; align-items: center;">
             <div style="display:flex; gap:15px; align-items:center;">
                <i class="fa-solid fa-user-plus" style="color:#54656f;"></i>
                <div style="font-size: 16px; color:#111b21;">Add other members</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="set-add-members" onchange="app.toggleGroupSetting('addMembers')">
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    <div style="padding: 15px 20px; color: #54656f; font-size: 14px; font-weight: 500;">Admins can:</div>
    
    <div style="background: white; padding: 0 20px;">
        <div class="setting-item" style="padding: 15px 0; display: flex; justify-content: space-between; align-items: center;">
             <div style="display:flex; gap:15px; align-items:center;">
                <i class="fa-solid fa-user-clock" style="color:#54656f;"></i>
                <div>
                    <div style="font-size: 16px; color:#111b21;">Approve new members</div>
                    <div style="font-size: 13px; color: #54656f;">Admins must approve joins</div>
                </div>
            </div>
            <label class="switch">
                <input type="checkbox" id="set-approve" onchange="app.toggleGroupSetting('approveMembers')">
                <span class="slider round"></span>
            </label>
        </div>
    </div>
</div>
<div id="pending-requests-page" class="page full-screen" style="background: white; z-index: 102;">
    <div class="top-nav" style="border-bottom: 1px solid #ddd;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.openGroupInfo()"></i>
        <div style="font-weight: bold; font-size: 18px; margin-left: 15px;">Pending Requests</div>
    </div>
    
    <div id="pending-list-container" style="padding: 10px; overflow-y: auto; flex: 1;">
        </div>
</div>
<div id="invite-link-page" class="page full-screen" style="background: #f0f2f5; z-index: 120;">
    
    <div class="top-nav" style="background: var(--primary); color: white;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" onclick="app.openGroupInfo()" style="cursor: pointer;"></i>
            <div style="font-weight: bold; font-size: 18px;">Group link</div>
        </div>
        <div style="font-size: 14px; font-weight: bold; cursor: pointer;" onclick="app.resetGroupLink()">Reset</div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding-bottom: 20px;">
        
        <div style="background: white; margin: 20px; padding: 30px 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; text-align: center;">
            
            <div style="position: relative; margin-bottom: 10px;">
                <img id="qr-group-icon" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid white;">
                    <i class="fa-solid fa-users"></i>
                </div>
            </div>

            <h3 id="qr-group-name" style="margin-bottom: 5px; color: #111;">Group Name</h3>
            <div style="color: gray; font-size: 13px; margin-bottom: 20px;">WhatsApp group</div>

            <img id="qr-code-img" src="" style="width: 200px; height: 200px; mix-blend-mode: multiply;">

            <div id="invite-link-text" style="margin-top: 20px; color: #008069; font-size: 13px; word-break: break-all; padding: 0 10px;">
                https://globalconnect.app/join/xyz
            </div>
        </div>

        <div style="padding: 0 20px; color: gray; font-size: 13px; margin-bottom: 10px;">
            Anyone with global can follow this link to join this group. Only share it with people you trust.
        </div>

        <div style="background: white; border-top: 1px solid #eee; border-bottom: 1px solid #eee;">
            
            <div class="list-item" onclick="app.shareLinkInternal()">
                <div style="width: 40px; text-align: center;"><i class="fa-solid fa-share" style="color: #111; font-size: 20px;"></i></div>
                <div style="flex: 1; font-size: 16px; margin-left: 10px;">Send link via Global Connect</div>
            </div>

            <div class="list-item" onclick="app.shareLinkToStatus()">
                <div style="width: 40px; text-align: center;"><i class="fa-solid fa-circle-notch" style="color: #111; font-size: 20px;"></i></div>
                <div style="flex: 1; font-size: 16px; margin-left: 10px;">Share to my status</div>
            </div>

            <div class="list-item" onclick="app.copyGroupLink()">
                <div style="width: 40px; text-align: center;"><i class="fa-regular fa-copy" style="color: #111; font-size: 20px;"></i></div>
                <div style="flex: 1; font-size: 16px; margin-left: 10px;">Copy link</div>
            </div>

            <div class="list-item" onclick="app.shareLinkSystem()">
                <div style="width: 40px; text-align: center;"><i class="fa-solid fa-share-nodes" style="color: #111; font-size: 20px;"></i></div>
                <div style="flex: 1; font-size: 16px; margin-left: 10px;">Share link</div>
            </div>

        </div>
    </div>
</div>
<div id="join-group-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; flex-direction: column;">
    
    <div style="position: absolute; top: 40px; left: 20px; color: white; cursor: pointer;" onclick="document.getElementById('join-group-modal').style.display='none'">
        <i class="fa-solid fa-xmark" style="font-size: 24px;"></i>
    </div>

    <div style="background: #1f2c34; padding: 40px 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        
        <div style="width: 120px; height: 120px; border-radius: 50%; background: #008069; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 4px solid #121b22;">
            <img id="join-group-icon" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
            <i id="join-group-placeholder" class="fa-solid fa-users" style="font-size: 50px; color: rgba(255,255,255,0.6);"></i>
        </div>

        <h2 id="join-group-name" style="margin-bottom: 5px; font-size: 22px;">Group Name</h2>
        <p id="join-group-meta" style="color: #8696a0; font-size: 14px; margin-bottom: 30px;">Created by ...</p>

        <div onclick="app.confirmJoinGroup()" style="background: #00a884; color: #111b21; padding: 12px; border-radius: 25px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s;">
            Join group
        </div>
    </div>
</div>
<div id="notifications-page" class="page full-screen" style="background: #111b21; color: white; z-index: 130;">
    
    <div class="top-nav" style="background: #1f2c34; border-bottom: 1px solid #2a3942;">
        <i class="fa-solid fa-arrow-left" onclick="app.openGroupInfo()" style="cursor: pointer; color: #aebac1;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 20px; color: #e9edef;">Notifications</div>
    </div>
    
    <div style="flex: 1; overflow-y: auto;">
        
        <div style="padding: 15px 20px 5px; color: #8696a0; font-size: 14px; font-weight: 500;">Message</div>
        
        <div style="padding: 0 20px;">
            
            <div class="setting-item" style="padding: 15px 0; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 16px; color: #e9edef;">Mute</div>
                <label class="switch">
                    <input type="checkbox" onchange="app.toggleLocalSetting('mute')">
                    <span class="slider round" style="background-color: #37404a;"></span>
                </label>
            </div>

            <div onclick="app.openNotifyModal()" style="cursor: pointer; padding: 15px 0;">
                <div style="font-size: 16px; color: #e9edef;">Notify for</div>
                <div id="disp-notify" style="font-size: 14px; color: #8696a0;">All</div>
            </div>
            
            <div style="padding: 15px 0; border-top: 1px solid #2a3942;">
                <div style="font-size: 16px; color: #e9edef;">Notification tone</div>
                <div style="font-size: 14px; color: #8696a0;">Default (Gentle)</div>
            </div>

            <div onclick="app.openVibrateModal()" style="padding: 15px 0; cursor: pointer; border-top: 1px solid #2a3942;">
                <div style="font-size: 16px; color: #e9edef;">Vibrate</div>
                <div id="disp-vibrate" style="font-size: 14px; color: #8696a0;">Default</div>
            </div>

            <div style="padding: 15px 0 5px; color: #8696a0; font-size: 14px; font-weight: 500; margin-top: 10px;">Advanced settings</div>
            
            <div onclick="app.openLightModal()" style="padding: 15px 0; cursor: pointer;">
                <div style="font-size: 16px; color: #e9edef;">Light</div>
                <div id="disp-light" style="font-size: 14px; color: #8696a0;">White</div>
            </div>

            <div style="padding: 15px 0; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #2a3942;">
                <div>
                    <div style="font-size: 16px; color: #e9edef;">Use high priority notifications</div>
                    <div style="font-size: 13px; color: #8696a0; max-width: 250px;">Show previews of notifications at the top of the screen</div>
                </div>
                <label class="switch">
                    <input type="checkbox" checked>
                    <span class="slider round" style="background-color: #37404a;"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<div id="modal-notify" class="modal-overlay" onclick="app.closeModal('modal-notify')">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <h3 style="margin-bottom: 20px; font-size: 18px; color: #e9edef;">What do you want to be notified for?</h3>
        
        <div class="radio-option" onclick="app.setNotificationSetting('notify', 'All')">
            <div class="radio-circle"><div class="radio-dot"></div></div>
            <div>
                <div style="font-size: 16px; color: #e9edef;">All</div>
                <div style="font-size: 13px; color: #8696a0;">Every group message</div>
            </div>
        </div>
        <div class="radio-option" onclick="app.setNotificationSetting('notify', 'Highlights')">
            <div class="radio-circle"><div class="radio-dot"></div></div>
            <div>
                <div style="font-size: 16px; color: #e9edef;">Highlights</div>
                <div style="font-size: 13px; color: #8696a0;">@mentions, @all, replies and other relevant messages</div>
            </div>
        </div>
    </div>
</div>

<div id="modal-vibrate" class="modal-overlay" onclick="app.closeModal('modal-vibrate')">
    <div class="modal-content center-box" onclick="event.stopPropagation()">
        <h3 style="margin-bottom: 15px; color: #e9edef; font-size: 20px;">Vibrate</h3>
        <div class="radio-simple" onclick="app.setNotificationSetting('vibrate', 'Off')">Off</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('vibrate', 'Default')">Default</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('vibrate', 'Short')">Short</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('vibrate', 'Long')">Long</div>
        <div style="text-align: right; margin-top: 25px; color: #00a884; font-weight: 500; cursor: pointer; font-size: 14px;" onclick="app.closeModal('modal-vibrate')">Cancel</div>
    </div>
</div>

<div id="modal-light" class="modal-overlay" onclick="app.closeModal('modal-light')">
    <div class="modal-content center-box" onclick="event.stopPropagation()">
        <h3 style="margin-bottom: 15px; color: #e9edef; font-size: 20px;">Light</h3>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'None')">None</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'White')">White</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'Red')">Red</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'Yellow')">Yellow</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'Green')">Green</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'Cyan')">Cyan</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'Blue')">Blue</div>
        <div class="radio-simple" onclick="app.setNotificationSetting('light', 'Purple')">Purple</div>
        <div style="text-align: right; margin-top: 25px; color: #00a884; font-weight: 500; cursor: pointer; font-size: 14px;" onclick="app.closeModal('modal-light')">Cancel</div>
    </div>
</div>

<div id="encryption-page" class="page full-screen" style="background: #111b21; color: white; z-index: 130;">
    <div class="top-nav" style="background: #111b21; border-bottom: 1px solid #333; color: white;">
        <i class="fa-solid fa-arrow-left" onclick="app.openGroupInfo()" style="cursor: pointer;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 20px;">Advanced chat privacy</div>
    </div>

    <div style="padding: 20px; text-align: center;">
        <div style="background: #003d33; padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: flex-start; gap: 10px; text-align: left;">
            <i class="fa-solid fa-lock" style="color: #00a884; font-size: 20px; margin-top: 2px;"></i>
            <div style="font-size: 14px; line-height: 1.4; color: #e9edef;">
                All chats are private by default. <b>This is true whether you turn this setting on or not.</b> <span style="color: #00a884;">Learn more</span>
            </div>
        </div>

        <i class="fa-solid fa-user-lock" style="font-size: 80px; color: #00a884; margin-bottom: 30px;"></i>

        <h3 style="margin-bottom: 15px;">Limit how messages can be shared</h3>
        
        <div style="text-align: left; margin-bottom: 30px;">
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <i class="fa-regular fa-image" style="color: #8696a0; font-size: 20px;"></i>
                <div style="color: #e9edef; font-size: 14px;">Can't save media to their device gallery automatically</div>
            </div>
            <div style="display: flex; gap: 15px;">
                <i class="fa-solid fa-share" style="color: #8696a0; font-size: 20px;"></i>
                <div style="color: #e9edef; font-size: 14px;">Can't export the chat</div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #333; padding-top: 20px;">
            <div style="font-size: 16px;">Advanced chat privacy</div>
            <label class="switch">
                <input type="checkbox" onchange="app.showToast('Privacy settings updated')">
                <span class="slider round" style="background-color: #333;"></span>
            </label>
        </div>
    </div>
</div>

<div id="disappearing-page" class="page full-screen" style="background: #111b21; color: white; z-index: 130;">
    <div class="top-nav" style="background: #111b21; border-bottom: none; color: white;">
        <i class="fa-solid fa-arrow-left" onclick="app.openGroupInfo()" style="cursor: pointer;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 20px;">Disappearing messages</div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding: 20px; text-align: center;">
        <img src="https://cdn-icons-png.flaticon.com/512/2983/2983796.png" style="width: 100px; height: 100px; margin-bottom: 20px; filter: invert(1);">
        
        <div style="color: #e9edef; font-size: 14px; line-height: 1.5; margin-bottom: 30px; text-align: left;">
            For more privacy and storage, new messages will disappear from this chat for everyone after the selected duration. Anyone in the chat can change this setting. <span style="color: #53bdeb;">Learn more</span>
        </div>

        <div style="text-align: left;">
            <div style="color: #8696a0; font-size: 14px; margin-bottom: 15px; font-weight: bold;">Message timer</div>
            
            <div class="radio-option" onclick="app.setDisappearingTimer('24 hours')">
                <div class="radio-circle"><div class="radio-dot" id="timer-24h"></div></div>
                <span>24 hours</span>
            </div>
            <div class="radio-option" onclick="app.setDisappearingTimer('7 days')">
                <div class="radio-circle"><div class="radio-dot" id="timer-7d"></div></div>
                <span>7 days</span>
            </div>
            <div class="radio-option" onclick="app.setDisappearingTimer('90 days')">
                <div class="radio-circle"><div class="radio-dot" id="timer-90d"></div></div>
                <span>90 days</span>
            </div>
            <div class="radio-option" onclick="app.setDisappearingTimer('Off')">
                <div class="radio-circle"><div class="radio-dot" id="timer-off"></div></div>
                <span>Off</span>
            </div>
        </div>
        
        <div style="margin-top: 40px; display: flex; gap: 15px; align-items: center; text-align: left; background: #1f2c34; padding: 15px; border-radius: 10px;">
            <i class="fa-regular fa-clock" style="color: #00a884; font-size: 20px;"></i>
            <div style="font-size: 13px; color: #8696a0;">
                <span style="color: #e9edef; font-weight: bold;">Try a default message timer</span><br>
                Start new chats with a disappearing timer set.
            </div>
        </div>
    </div>
</div>
<div id="modal-group-icon" class="modal-overlay" onclick="app.closeModal('modal-group-icon')">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: #1f2c34; border-radius: 15px 15px 0 0;">
        <div class="modal-handle"></div>
        <h3 style="margin-bottom: 25px; color: #e9edef; font-size: 18px; text-align: center;">Group icon</h3>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
            <div class="icon-option" onclick="document.getElementById('icon-cam-input').click()">
                <div class="icon-circle"><i class="fa-solid fa-camera"></i></div>
                <span>Camera</span>
            </div>
            <div class="icon-option" onclick="document.getElementById('icon-file-input').click()">
                <div class="icon-circle"><i class="fa-regular fa-image"></i></div>
                <span>Gallery</span>
            </div>
            <div class="icon-option" onclick="app.openEmojiEditor()">
                <div class="icon-circle"><i class="fa-regular fa-face-smile"></i></div>
                <span>Emoji & stickers</span>
            </div>
            <div class="icon-option" onclick="app.openWebSearch()">
                <div class="icon-circle"><i class="fa-solid fa-magnifying-glass"></i></div>
                <span>Search web</span>
            </div>
        </div>

        <input type="file" id="icon-cam-input" accept="image/*" capture="environment" style="display: none;" onchange="app.handleIconFile(this)">
        <input type="file" id="icon-file-input" accept="image/*" style="display: none;" onchange="app.handleIconFile(this)">
    </div>
</div>

<div id="emoji-editor-page" class="page full-screen" style="background: #111b21; z-index: 140;">
    <div class="top-nav" style="background: #1f2c34; color: white;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('group-info-page')" style="cursor: pointer;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 20px;">Emoji & stickers</div>
        <div style="flex: 1;"></div>
        <i class="fa-solid fa-check" onclick="app.saveEmojiIcon()" style="cursor: pointer; font-size: 20px;"></i>
    </div>

    <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: #0b141a;">
        <div id="emoji-preview-bg" style="width: 200px; height: 200px; border-radius: 50%; background: #a5bfe2; display: flex; align-items: center; justify-content: center; transition: 0.2s;">
            <div id="emoji-preview-text" style="font-size: 100px;">ðŸ˜‚</div>
        </div>
    </div>

    <div style="padding: 20px; overflow-x: auto; white-space: nowrap; background: #111b21;">
        <div class="color-dot selected" style="background: #a5bfe2;" onclick="app.setEmojiBg('#a5bfe2')"></div>
        <div class="color-dot" style="background: #aeeac2;" onclick="app.setEmojiBg('#aeeac2')"></div>
        <div class="color-dot" style="background: #f7dca4;" onclick="app.setEmojiBg('#f7dca4')"></div>
        <div class="color-dot" style="background: #fbc6b7;" onclick="app.setEmojiBg('#fbc6b7')"></div>
        <div class="color-dot" style="background: #fbb6ce;" onclick="app.setEmojiBg('#fbb6ce')"></div>
        <div class="color-dot" style="background: #d5bdfc;" onclick="app.setEmojiBg('#d5bdfc')"></div>
        <div class="color-dot" style="background: #e9edef;" onclick="app.setEmojiBg('#e9edef')"></div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
        <div class="emoji-item" onclick="app.setEmoji('ðŸ˜‚')">ðŸ˜‚</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ˜')">ðŸ˜</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ˜Ž')">ðŸ˜Ž</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ¤“')">ðŸ¤“</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ¤–')">ðŸ¤–</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ‘»')">ðŸ‘»</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ‘½')">ðŸ‘½</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸŽƒ')">ðŸŽƒ</div>
        <div class="emoji-item" onclick="app.setEmoji('âš½')">âš½</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ€')">ðŸ€</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸš€')">ðŸš€</div>
        <div class="emoji-item" onclick="app.setEmoji('ðŸ±')">ðŸ±</div>
        </div>
</div>

<div id="web-search-page" class="page full-screen" style="background: #111b21; z-index: 140;">
    <div class="top-nav" style="background: #1f2c34; gap: 10px; padding: 10px;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('group-info-page')" style="color: #aebac1; cursor: pointer;"></i>
        <div style="flex: 1; background: #2a3942; border-radius: 20px; padding: 0 15px; display: flex; align-items: center; height: 40px;">
            <input id="web-search-input" type="text" placeholder="Search web..." style="background: transparent; border: none; color: white; width: 100%; outline: none;" onkeypress="if(event.key === 'Enter') app.performWebSearch(this.value)">
            <i class="fa-solid fa-xmark" style="color: #8696a0; cursor: pointer;" onclick="document.getElementById('web-search-input').value=''"></i>
        </div>
    </div>

    <div id="web-search-results" style="padding: 5px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; overflow-y: auto;">
        <div style="color: #8696a0; grid-column: span 3; text-align: center; margin-top: 50px;">Type to search...</div>
    </div>
</div>

<div id="sticker-options-menu" class="bottom-sheet-modal" style="display: none;">
    <div class="bottom-sheet-content">
        <div style="display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #2a3942;">
            <img id="menu-sticker-preview" src="" style="width: 60px; height: 60px; object-fit: contain; margin-right: 15px;">
            <div style="flex: 1; color: #e9edef; font-weight: 500;">Sticker Options</div>
            <i class="fa-solid fa-xmark" onclick="app.closeStickerMenu()" style="font-size: 20px; cursor: pointer; color: #8696a0;"></i>
        </div>
        
        <div class="menu-option" onclick="app.handleStickerMenuAction('favorite')">
            <i id="menu-fav-icon" class="fa-regular fa-star"></i>
            <span id="menu-fav-text">Add to Favorites</span>
        </div>
        <div class="menu-option" onclick="app.openCreatePackModal()">
            <i class="fa-solid fa-folder-plus"></i>
            <span>Add to sticker pack</span>
        </div>
        <div class="menu-option" onclick="app.handleStickerMenuAction('edit')">
            <i class="fa-solid fa-pen-to-square"></i>
            <span>Edit sticker</span>
        </div>
        <div class="menu-option" onclick="app.openStickerMaker()">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            <span>Create your own</span>
        </div>
        <div class="menu-option" style="color: #ff4757;" onclick="app.closeStickerMenu()">
            <i class="fa-solid fa-ban"></i>
            <span>Cancel</span>
        </div>
    </div>
</div>

<div id="modal-create-pack" class="modal-overlay" style="display: none;">
    <div style="background: #1f2c34; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; color: #e9edef;">
        <h3 style="margin-top: 0; font-weight: 500;">Create sticker pack</h3>
        <input type="text" id="new-pack-name" placeholder="Pack name (e.g. My Funny Cat)" 
               style="width: 100%; background: #111b21; border: none; border-bottom: 2px solid #00a884; padding: 10px 5px; color: white; outline: none; margin: 20px 0;">
        <div style="display: flex; justify-content: flex-end; gap: 20px; font-weight: 500; margin-top: 20px;">
            <div onclick="document.getElementById('modal-create-pack').style.display='none'" style="color: #00a884; cursor: pointer;">Cancel</div>
            <div onclick="app.createNewStickerPack()" style="color: #00a884; cursor: pointer;">Save</div>
        </div>
    </div>
</div>

<div id="sticker-maker-page" class="page full-screen" style="background: #111b21; z-index: 250; display: none; flex-direction: column;">
    <div class="top-nav" style="background: #1f2c34; color: white;">
        <i class="fa-solid fa-xmark" onclick="app.closeStickerMaker()" style="cursor: pointer; font-size: 20px;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 20px;">Sticker Maker</div>
        <div style="flex: 1;"></div>
        <div onclick="app.saveNewSticker()" style="color: #00a884; font-weight: bold; cursor: pointer;">Save</div>
    </div>

    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
        <div style="width: 300px; height: 300px; background: #1f2c34; border-radius: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; border: 2px dashed #2a3942; position: relative;">
            <img id="sticker-editor-preview" src="" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
            <div id="editor-placeholder" style="text-align: center; color: #8696a0;">
                <i class="fa-solid fa-image" style="font-size: 40px; margin-bottom: 10px;"></i>
                <div>Upload Image/Video</div>
            </div>
        </div>

        <div style="display: flex; gap: 25px;">
            <div class="editor-tool-btn" onclick="document.getElementById('maker-upload').click()">
                <i class="fa-solid fa-upload"></i>
                <input type="file" id="maker-upload" accept="image/*" style="display: none;" onchange="app.loadMakerImage(this)">
            </div>
            
            <div class="editor-tool-btn" onclick="app.openStickerTextTool()">
                <i class="fa-solid fa-font"></i>
            </div>
            
            <div class="editor-tool-btn" onclick="alert('Cut tool coming soon')">
                <i class="fa-solid fa-scissors"></i>
            </div>
            
            <div class="editor-tool-btn" onclick="app.openStickerColorTool()">
                <i class="fa-solid fa-palette"></i>
            </div>
        </div>
    </div>
</div>


<div id="linked-devices-page" class="page full-screen" style="background: #f0f2f5; z-index: 120;">
    <div class="top-nav" style="background: #f0f2f5; border-bottom: 1px solid #d1d7db;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chat-list-page')" style="cursor: pointer; color: #111b21;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 20px; color: #111b21;">Linked devices</div>
    </div>

    <div style="flex: 1; overflow-y: auto;">
        <div style="background: white; padding: 40px 20px; text-align: center; border-bottom: 1px solid #e9edef; margin-bottom: 10px;">
            <img src="https://cdn-icons-png.flaticon.com/512/2909/2909679.png" style="width: 140px; margin-bottom: 25px; opacity: 0.9;">
            <div style="font-size: 20px; color: #111b21; margin-bottom: 10px; font-weight: 500;">Use WhatsApp on other devices</div>
            <div style="font-size: 14px; color: #54656f; margin-bottom: 30px; line-height: 1.5;">
                Link up to 4 devices to your account.<br>
                <span style="color: #008069; font-weight: 500; cursor: pointer;">Learn more</span>
            </div>
            
            <button onclick="app.startRealScanner()" class="btn" style="background: #008069; color: white; width: 90%; border-radius: 25px; font-size: 15px; padding: 12px; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">Link a device</button>
        </div>

        <div style="padding: 15px 20px 10px; font-size: 14px; color: #54656f; font-weight: 500;">DEVICE STATUS</div>
        <div style="font-size: 13px; color: #54656f; padding: 0 20px 10px;">Tap a device to log out.</div>
        
        <div id="linked-devices-list" style="background: white; border-top: 1px solid #e9edef; border-bottom: 1px solid #e9edef;">
            </div>
    </div>
</div>

<div id="real-scanner-page" class="page full-screen" style="background: black; z-index: 500;">
    <div style="position: absolute; top: 15px; left: 15px; z-index: 20; color: white; display: flex; align-items: center; width: 100%;">
        <i class="fa-solid fa-arrow-left" onclick="app.stopRealScanner()" style="font-size: 24px; cursor: pointer;"></i>
        <div style="flex: 1; text-align: center; font-size: 20px; font-weight: 500; padding-right: 24px;">Scan QR code</div>
    </div>

    <div id="reader" style="width: 100%; height: 100%; background: black;"></div>

    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        
        <div style="color: rgba(255,255,255,0.7); margin-bottom: 30px; text-align: center; font-size: 14px; padding: 0 40px;">
            To use WhatsApp Web, go to <br><b>web.whatsapp.com</b> on your computer.
        </div>

        <div class="scan-frame">
            <div class="scan-corner-tl"></div>
            <div class="scan-corner-tr"></div>
            <div class="scan-corner-bl"></div>
            <div class="scan-corner-br"></div>
            <div class="scan-laser"></div> </div>

        <div style="position: absolute; bottom: 40px; color: white; font-weight: 500; font-size: 14px;">
            Link with phone number instead
        </div>
    </div>
</div>
<div id="companion-qr-page" class="page full-screen" style="background: white; z-index: 200;">
    <div style="padding: 40px 20px; text-align: center; display: flex; flex-direction: column; height: 100%;">
        
        <h2 style="color: #111b21; font-size: 20px; margin-bottom: 10px;">Use Global Connect on this device</h2>
        <div style="color: #54656f; font-size: 14px; margin-bottom: 30px; line-height: 1.5;">
            Open Global Connect on your primary phone and tap <b>Menu > Linked devices > Link a device</b>
        </div>

        <div style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div style="width: 260px; height: 260px; border: 1px solid #e9edef; padding: 5px; display: flex; align-items: center; justify-content: center; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <img id="companion-qr-display" src="" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
            
            <div style="color: #008069; font-weight: 500; margin-top: 30px; cursor: pointer;" onclick="app.generateLoginQR()">
                Reload QR code
            </div>
        </div>

        <button class="btn" style="background: #f0f2f5; color: #008069; width: auto; padding: 10px 30px; margin: 0 auto;" onclick="app.goToPage('auth-page')">Cancel</button>
    </div>
</div>
<div id="privacy-settings-page" class="page full-screen" style="background: #f0f2f5; z-index: 130;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #e9edef;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('settings-page')"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 15px;">Privacy</div>
    </div>

    <div style="flex: 1; overflow-y: auto;">
        
        <div style="padding: 20px 20px 10px; font-size: 14px; color: #54656f; font-weight: 500;">
            Who can see my personal info
        </div>

        <div style="background: white; border-top: 1px solid #e9edef; border-bottom: 1px solid #e9edef;">
            
            <div class="list-item" onclick="app.openPrivacyOption('lastSeen')" style="border-bottom: 1px solid #f0f0f0;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #111;">Last seen and online</div>
                    <div id="priv-disp-lastSeen" style="font-size: 13px; color: #54656f;">Everyone</div>
                </div>
            </div>

            <div class="list-item" onclick="app.openPrivacyOption('profilePhoto')" style="border-bottom: 1px solid #f0f0f0;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #111;">Profile photo</div>
                    <div id="priv-disp-profilePhoto" style="font-size: 13px; color: #54656f;">Everyone</div>
                </div>
            </div>

            <div class="list-item" onclick="app.openPrivacyOption('about')" style="border-bottom: 1px solid #f0f0f0;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #111;">About</div>
                    <div id="priv-disp-about" style="font-size: 13px; color: #54656f;">Everyone</div>
                </div>
            </div>

            <div class="list-item" onclick="app.openStatusPrivacy()" style="border-bottom: none;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #111;">Status</div>
                    <div id="priv-disp-status" style="font-size: 13px; color: #54656f;">My contacts</div>
                </div>
            </div>
        </div>

        <div style="background: white; margin-top: 10px; border-top: 1px solid #e9edef; border-bottom: 1px solid #e9edef;">
            <div class="list-item" style="display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
                <div style="flex: 1; padding-right: 10px;">
                    <div style="font-size: 16px; color: #111;">Read receipts</div>
                    <div style="font-size: 13px; color: #54656f; line-height: 1.4; margin-top: 3px;">
                        If turned off, you won't send or receive Read receipts. Read receipts are always sent for group chats.
                    </div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="priv-read-receipts" checked onchange="app.toggleReadReceipts()">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div style="background: white; margin-top: 10px; border-top: 1px solid #e9edef; border-bottom: 1px solid #e9edef;">
            <div class="list-item" onclick="app.openBlockedContacts()">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #111;">Blocked contacts</div>
                    <div id="priv-disp-blocked" style="font-size: 13px; color: #54656f;">0</div>
                </div>
            </div>
        </div>

        <div style="padding: 20px; text-align: center; color: #54656f; font-size: 13px;">
            <i class="fa-solid fa-lock" style="font-size: 12px; margin-right: 5px;"></i> End-to-end encrypted
        </div>
    </div>
</div>

<div id="blocked-contacts-page" class="page full-screen" style="background: white; z-index: 140;">
    <div class="top-nav" style="border-bottom: 1px solid #e9edef;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('privacy-settings-page')"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 15px;">Blocked contacts</div>
        <div style="flex: 1;"></div>
        <i class="fa-solid fa-user-plus nav-item" onclick="app.openBlockPicker()"></i>
    </div>
    
    <div style="padding: 15px; background: #f0f2f5; color: #54656f; font-size: 13px;">
        Blocked contacts will no longer be able to call you or send you messages.
    </div>

    <div id="blocked-list-container"></div>
</div>

<div id="privacy-option-modal" class="modal-overlay" onclick="document.getElementById('privacy-option-modal').style.display='none'">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: white; border-radius: 15px 15px 0 0;">
        <div class="modal-handle" style="background: #ddd;"></div>
        <h3 id="priv-modal-title" style="margin-bottom: 20px; font-size: 18px; color: #111; padding: 0 10px;">Setting Title</h3>
        
        <div class="radio-option" onclick="app.setPrivacyValue('Everyone')" style="color: #111;">
            <div class="radio-circle"><div class="radio-dot" id="dot-Everyone"></div></div>
            <span>Everyone</span>
        </div>
        <div class="radio-option" onclick="app.setPrivacyValue('My Contacts')" style="color: #111;">
            <div class="radio-circle"><div class="radio-dot" id="dot-Contacts"></div></div>
            <span>My contacts</span>
        </div>
        <div class="radio-option" onclick="app.setPrivacyValue('Nobody')" style="color: #111;">
            <div class="radio-circle"><div class="radio-dot" id="dot-Nobody"></div></div>
            <span>Nobody</span>
        </div>
    </div>
</div>
<div id="profile-editor-page" class="page full-screen" style="background: #1e1f22; z-index: 200;">
    
    <div class="top-nav" style="background: #111214; border-bottom: 1px solid #2a2b2f; padding: 0 15px;">
        <div onclick="app.closeProfileEditor()" style="color: #dbdee1; font-size: 14px; cursor: pointer;">Cancel</div>
        <div style="font-weight: bold; color: white; font-size: 16px;">Edit Profile</div>
        <div onclick="app.saveProfileChanges()" style="color: #5865F2; font-weight: bold; font-size: 14px; cursor: pointer;">Save</div>
    </div>

    <div style="padding: 20px; overflow-y: auto; flex: 1;">
        
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="position: relative; width: 100px; height: 100px; margin: 0 auto;">
                <img id="editor-avatar-preview" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid #2b2d31;">
                
                <div onclick="document.getElementById('editor-file-input').click()" 
                     style="position: absolute; top: 0; right: 0; background: #5865F2; width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid #1e1f22;">
                    <i class="fa-solid fa-pencil" style="color: white; font-size: 14px;"></i>
                </div>
            </div>
            <p style="color: #b5bac1; font-size: 12px; margin-top: 10px;">Tap pencil to change icon</p>
        </div>

        <div class="d-input-group">
            <label>DISPLAY NAME</label>
            <input type="text" id="editor-name" placeholder="Enter your name">
        </div>

        <div class="d-input-group">
            <label>ABOUT ME / BIO</label>
            <textarea id="editor-bio" rows="4" placeholder="Tell us about yourself..."></textarea>
        </div>

        <input type="file" id="editor-file-input" accept="image/*" style="display: none;" onchange="app.handleEditImage(this)">

    </div>
</div>
<div id="shop-page" class="page full-screen" style="background: #1e1f22; z-index: 150;">
    
    <div class="top-nav" style="background: #111214; border-bottom: 1px solid #2a2b2f; padding: 0 15px; position: sticky; top: 0; z-index: 10;">
        <div onclick="app.openMyProfile()" style="color: #dbdee1; font-size: 20px; cursor: pointer;">
            <i class="fa-solid fa-arrow-left"></i>
        </div>
        <div style="font-weight: 800; color: white; font-size: 18px; margin-left: 15px;">Premium Store</div>
        <div style="flex: 1;"></div>
        <div style="background: #2b2d31; padding: 5px 10px; border-radius: 15px; font-size: 12px; color: #aaa; font-weight: bold;">
            <i class="fa-solid fa-gem" style="color: #e91e63;"></i> <span id="shop-balance">0</span>
        </div>
    </div>

    <div style="padding: 20px; overflow-y: auto;">
        
        <div style="background: linear-gradient(90deg, #5865F2, #9b59b6); border-radius: 12px; padding: 20px; color: white; margin-bottom: 25px; position: relative; overflow: hidden;">
            <i class="fa-brands fa-google-play" style="position: absolute; right: -10px; bottom: -20px; font-size: 100px; opacity: 0.2; transform: rotate(-20deg);"></i>
            <h2 style="margin-bottom: 5px;">Get Verified</h2>
            <p style="font-size: 13px; margin-bottom: 15px; opacity: 0.9;">Stand out with the blue checkmark.</p>
            <button onclick="app.buyItem('verification')" style="background: white; color: #5865F2; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 12px;">$4.99 / Month</button>
        </div>

        <div class="shop-section-title">PROFILE UPGRADES</div>
        
        <div class="shop-item">
            <div class="shop-icon" style="background: #202225; color: #00C853;"><i class="fa-solid fa-check-circle"></i></div>
            <div class="shop-info">
                <div class="shop-name">Verification Badge</div>
                <div class="shop-desc">Get the blue tick on your profile.</div>
            </div>
            <button class="shop-btn" onclick="app.buyItem('verification')">$4.99</button>
        </div>

        <div class="shop-item">
            <div class="shop-icon" style="background: #202225; color: #FFD700;"><i class="fa-solid fa-crown"></i></div>
            <div class="shop-info">
                <div class="shop-name">Golden Name</div>
                <div class="shop-desc">Make your name shine in gold.</div>
            </div>
            <button class="shop-btn" onclick="app.buyItem('gold_name')">$2.99</button>
        </div>

        <div class="shop-item">
            <div class="shop-icon" style="background: #202225; color: #ff4b7d;"><i class="fa-solid fa-image"></i></div>
            <div class="shop-info">
                <div class="shop-name">Custom Banner</div>
                <div class="shop-desc">Upload a custom image header.</div>
            </div>
            <button class="shop-btn" onclick="app.buyItem('banner')">$1.99</button>
        </div>

        <div class="shop-section-title">PRIVACY & TOOLS</div>

        <div class="shop-item">
            <div class="shop-icon" style="background: #202225; color: #dbdee1;"><i class="fa-solid fa-ghost"></i></div>
            <div class="shop-info">
                <div class="shop-name">Ghost Mode</div>
                <div class="shop-desc">Read messages without blue ticks.</div>
            </div>
            <button class="shop-btn" onclick="app.buyItem('ghost')">$3.99</button>
        </div>

        <div class="shop-item">
            <div class="shop-icon" style="background: #202225; color: #5865F2;"><i class="fa-solid fa-rocket"></i></div>
            <div class="shop-info">
                <div class="shop-name">Profile Boost</div>
                <div class="shop-desc">10x visibility in Matches for 1h.</div>
            </div>
            <button class="shop-btn" onclick="app.buyItem('boost')">$0.99</button>
        </div>

        <div class="shop-section-title">ORBS CURRENCY</div>
        
        <div class="shop-item">
            <div class="shop-icon" style="background: #202225; color: #e91e63;"><i class="fa-solid fa-gem"></i></div>
            <div class="shop-info">
                <div class="shop-name">500 Orbs</div>
                <div class="shop-desc">Use to send virtual gifts.</div>
            </div>
            <button class="shop-btn" onclick="app.buyItem('orbs_500')">$4.99</button>
        </div>

    </div>
</div>
<div id="create-channel-page" class="page full-screen" style="background: #f0f2f5; z-index: 160;">
    
    <div class="top-nav" style="background: #008069; color: white;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chat-list-page')" style="cursor: pointer;"></i>
            <div style="font-weight: bold; font-size: 18px;">Create Channel</div>
        </div>
    </div>

    <div style="padding: 30px 20px; display: flex; flex-direction: column; align-items: center;">
        
        <div style="text-align: center; color: #54656f; font-size: 14px; margin-bottom: 30px; line-height: 1.5; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <img src="https://cdn-icons-png.flaticon.com/512/3050/3050525.png" style="width: 60px; margin-bottom: 15px;">
            <br>
            Create a channel to reach unlimited followers. Anyone can discover your channel and see 30 days of history.
        </div>

        <div style="position: relative; width: 100px; height: 100px; margin-bottom: 30px; cursor: pointer;" onclick="document.getElementById('channel-icon-input').click()">
            <img id="channel-icon-preview" src="https://cdn-icons-png.flaticon.com/512/3050/3050525.png" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; background: #e9edef;">
            <div style="position: absolute; bottom: 0; right: 0; background: #008069; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white;">
                <i class="fa-solid fa-camera" style="font-size: 14px;"></i>
            </div>
        </div>
        <input type="file" id="channel-icon-input" accept="image/*" style="display: none;" onchange="app.handleChannelIcon(this)">

        <input id="channel-name-input" type="text" placeholder="Channel Name" class="input-box" style="background: white; border: none; border-bottom: 2px solid #008069; border-radius: 0; padding: 10px 0; font-size: 16px; margin-bottom: 20px;">
        
        <textarea id="channel-desc-input" rows="3" placeholder="Describe your channel (optional)" class="input-box" style="background: #e9edef; border: none; border-radius: 10px; padding: 15px; font-size: 14px;"></textarea>

    </div>

    <div style="position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center;">
        <button onclick="app.createNewChannel()" class="btn" style="background: #008069; color: white; width: 90%; border-radius: 25px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">Create Channel</button>
    </div>
</div>
<div id="channel-profile-page" class="page full-screen" style="background: #e9edef; z-index: 110;">
    
    <div class="top-nav" style="background: white; border-bottom: 1px solid #ddd;">
        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
            <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chat-room')" style="color: #54656f; font-size: 20px; cursor: pointer;"></i>
        </div>
        <div style="display: flex; gap: 20px; color: #54656f;">
            <i class="fa-solid fa-chart-simple"></i> 
            <i class="fa-solid fa-link" onclick="app.openChannelLinkPage()"></i>
            <i class="fa-solid fa-ellipsis-vertical"></i>
        </div>
    </div>

    <div style="flex: 1; overflow-y: auto;">
        
        <div style="background: white; padding: 20px 0; display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 10px;">
            <img id="cp-icon" src="" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px;">
            <h2 id="cp-name" style="color: #111b21; font-size: 22px; margin-bottom: 5px;">Channel Name</h2>
            <div id="cp-followers" style="color: #54656f; font-size: 14px;">Channel â€¢ 0 followers</div>

            <div style="display: flex; gap: 15px; width: 90%; margin-top: 20px;">
                <div class="channel-action-btn" onclick="alert('Forward feature')">
                    <i class="fa-solid fa-share" style="transform: scaleX(-1);"></i>
                    <span>Forward</span>
                </div>
                <div class="channel-action-btn" onclick="app.shareChannelSystem()">
                    <i class="fa-solid fa-share-nodes"></i>
                    <span>Share</span>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 15px 20px; margin-bottom: 10px;">
            <div style="font-weight: 500; color: #111b21; font-size: 15px; margin-bottom: 5px;">Channel description</div>
            <div id="cp-desc" style="color: #54656f; font-size: 14px; margin-bottom: 10px;">No description</div>
            <div id="cp-date" style="color: #54656f; font-size: 13px;">Created on ...</div>
        </div>

        <div style="background: white; padding: 15px 20px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-weight: 500; color: #111b21; font-size: 15px;">Insights for last 30 days</div>
                <div style="color: #008069; font-size: 14px; font-weight: 500;">See all ></div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <div class="insight-box">
                    <div class="insight-num">0</div>
                    <div class="insight-label">Accounts reached</div>
                </div>
                <div class="insight-box">
                    <div class="insight-num" id="cp-net-follows">0</div>
                    <div class="insight-label">Net follows</div>
                </div>
            </div>
        </div>

        <div id="cp-settings-container" style="background: white; padding: 5px 0; margin-bottom: 10px;">
            </div>

        <div style="background: white; padding-top: 15px; padding-bottom: 40px;">
            <div style="padding: 0 20px 10px; color: #54656f; font-size: 14px; display: flex; justify-content: space-between;">
                <span id="cp-followers-title">0 followers</span>
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>

            <div class="list-item" onclick="app.openChannelLinkPage()" style="cursor: pointer;">
                <div style="width: 40px; height: 40px; background: #e9edef; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #54656f;">
                    <i class="fa-solid fa-link"></i>
                </div>
                <div style="flex: 1; margin-left: 15px; font-size: 16px; color: #111b21;">Channel link</div>
            </div>

            <div id="cp-admin-list"></div>
            
            <div id="cp-delete-btn" style="padding: 20px; text-align: center; color: #d32f2f; font-size: 16px; font-weight: 500; cursor: pointer; display: none;" onclick="alert('Delete logic')">
                <i class="fa-regular fa-trash-can"></i> Delete Channel
            </div>
        </div>
    </div>
</div>

<div id="channel-link-page" class="page full-screen" style="background: white; z-index: 120;">
    
    <div class="top-nav" style="border-bottom: none; background: white;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" onclick="app.openChannelProfile()" style="color: #111b21; cursor: pointer; font-size: 20px;"></i>
            <div style="font-weight: 500; font-size: 20px; color: #111b21;">Channel link</div>
        </div>
    </div>

    <div style="padding: 0 20px;">
        
        <div style="color: #54656f; font-size: 14px; margin: 10px 0 20px 0;">
            People with this link can view and follow this channel
        </div>

        <div style="display: flex; align-items: center; background: #f0f2f5; padding: 15px; border-radius: 15px; margin-bottom: 30px;">
            <img id="cl-icon" src="" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px;">
            <div style="flex: 1; overflow: hidden;">
                <div id="cl-name" style="font-weight: 500; color: #111b21; font-size: 16px; margin-bottom: 2px;">Channel Name</div>
                <div id="cl-link-text" style="color: #008069; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">https://globalconnect.app/channel/...</div>
            </div>
        </div>

        <div class="list-item" onclick="app.shareChannelLinkInternal()">
            <div style="width: 24px; text-align: center;"><i class="fa-solid fa-share" style="color: #54656f; font-size: 20px; transform: scaleX(-1);"></i></div>
            <div style="flex: 1; font-size: 16px; margin-left: 20px; color: #111b21;">Send link via Global Connect</div>
        </div>

        <div class="list-item" onclick="app.shareChannelToStatus()">
            <div style="width: 24px; text-align: center;"><i class="fa-solid fa-circle-notch" style="color: #54656f; font-size: 20px;"></i></div>
            <div style="flex: 1; font-size: 16px; margin-left: 20px; color: #111b21;">Share to my status</div>
        </div>

        <div class="list-item" onclick="app.copyChannelLink()">
            <div style="width: 24px; text-align: center;"><i class="fa-regular fa-copy" style="color: #54656f; font-size: 20px;"></i></div>
            <div style="flex: 1; font-size: 16px; margin-left: 20px; color: #111b21;">Copy link</div>
        </div>

        <div class="list-item" onclick="app.shareChannelSystem()">
            <div style="width: 24px; text-align: center;"><i class="fa-solid fa-share-nodes" style="color: #54656f; font-size: 20px;"></i></div>
            <div style="flex: 1; font-size: 16px; margin-left: 20px; color: #111b21;">Share link</div>
        </div>

        <div class="list-item" onclick="alert('QR Code coming soon')">
            <div style="width: 24px; text-align: center;"><i class="fa-solid fa-qrcode" style="color: #54656f; font-size: 20px;"></i></div>
            <div style="flex: 1; font-size: 16px; margin-left: 20px; color: #111b21;">QR code</div>
        </div>

    </div>
</div>
<div id="link-preview-bar" style="display:none; background: white; padding: 10px; border-top: 1px solid #eee; border-radius: 15px 15px 0 0; margin: 0 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: relative; animation: slideUp 0.3s ease;">
    <div style="display: flex; gap: 12px; align-items: center;">
        <img id="lp-image" src="" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #f0f2f5;">
        <div style="flex: 1; overflow: hidden;">
            <div id="lp-title" style="font-weight: bold; font-size: 14px; color: #111b21; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Group Name</div>
            <div id="lp-desc" style="font-size: 12px; color: #54656f;">Group chat invite</div>
        </div>
        <i class="fa-solid fa-xmark" onclick="app.closeLinkPreview()" style="padding: 10px; cursor: pointer; color: #8696a0;"></i>
    </div>
</div>
<div id="channel-settings-admin-page" class="page full-screen" style="background: #f0f2f5; z-index: 170;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #ddd; padding: 0 15px;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <i class="fa-solid fa-arrow-left" onclick="app.openChannelProfile()" style="color: #54656f; cursor: pointer; font-size: 20px;"></i>
        <div style="font-weight: 500; font-size: 19px; color: #111b21;">Channel settings</div>
    </div>
</div>

    <div style="flex: 1; overflow-y: auto;">
        <div style="padding: 20px 20px 10px; color: #54656f; font-size: 14px; font-weight: 500;">Settings</div>

        <div style="background: white; border-top: 1px solid #e9edef; border-bottom: 1px solid #e9edef;">
            <div class="list-item" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #111;">Edit channel info</div>
                    <div style="font-size: 13px; color: #54656f;">Control who can change name, icon, and description</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="chan-set-edit" checked onchange="app.toggleChannelSetting('editInfo')">
                    <span class="slider round"></span>
                </label>
            </div>

            <div class="list-item" onclick="app.openEmojiPolicyModal()" style="cursor: pointer;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #111;">Reactions</div>
                    <div id="chan-disp-emoji" style="font-size: 13px; color: #54656f;">Any emoji</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
            </div>
        </div>
    </div>
</div>

<div id="modal-emoji-policy" class="modal-overlay" onclick="app.closeModal('modal-emoji-policy')">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: white; border-radius: 15px 15px 0 0;">
        <div class="modal-handle" style="background: #ddd;"></div>
        <h3 style="margin-bottom: 25px; font-size: 18px; color: #111; padding: 0 10px; font-weight: 500;">Which reactions can followers send</h3>
        
        <div class="radio-option" onclick="app.setChannelEmojiPolicy('any')" style="color: #111; padding: 15px 10px; display: flex; align-items: center; gap: 15px; cursor: pointer;">
            <div class="radio-circle" id="rd-any"><div class="radio-dot"></div></div>
            <div style="font-size: 16px;">Any emoji</div>
        </div>

        <div class="radio-option" onclick="app.setChannelEmojiPolicy('default')" style="color: #111; padding: 15px 10px; display: flex; align-items: center; gap: 15px; cursor: pointer;">
            <div class="radio-circle" id="rd-default"><div class="radio-dot"></div></div>
            <div style="font-size: 16px;">Default only (ðŸ‘ â¤ï¸ ðŸ˜‚ ðŸ˜® ðŸ˜¢ ðŸ™)</div>
        </div>

        <div class="radio-option" onclick="app.setChannelEmojiPolicy('none')" style="color: #111; padding: 15px 10px; display: flex; align-items: center; gap: 15px; cursor: pointer;">
            <div class="radio-circle" id="rd-none"><div class="radio-dot"></div></div>
            <div style="font-size: 16px;">None</div>
        </div>
    </div>
</div>
<div id="member-options-modal" class="modal-overlay" onclick="app.closeModal('member-options-modal')">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: #1f2c34; border-radius: 20px 20px 0 0;">
        <div class="modal-handle"></div>
        
        <div style="display: flex; justify-content: center; gap: -10px; margin-bottom: 20px;" id="mo-avatar-row">
            <img id="mo-img-1" src="" class="list-avatar" style="width: 55px; height: 55px; border: 3px solid #1f2c34; z-index: 5;">
            <img id="mo-img-2" src="" class="list-avatar" style="width: 55px; height: 55px; border: 3px solid #1f2c34; margin-left: -15px; opacity: 0.6; z-index: 4;">
            <img id="mo-img-3" src="" class="list-avatar" style="width: 55px; height: 55px; border: 3px solid #1f2c34; margin-left: -15px; opacity: 0.4; z-index: 3;">
            <img id="mo-img-4" src="" class="list-avatar" style="width: 55px; height: 55px; border: 3px solid #1f2c34; margin-left: -15px; opacity: 0.2; z-index: 2;">
            <img id="mo-img-5" src="" class="list-avatar" style="width: 55px; height: 55px; border: 3px solid #1f2c34; margin-left: -15px; opacity: 0.1; z-index: 1;">
        </div>

        <h3 id="mo-user-name" style="color: white; text-align: center; margin-bottom: 20px; font-weight: 500;">User Name</h3>
        
        <div id="mo-admin-toggle" class="menu-option" style="border-top: 1px solid #2a3942;">
            <i class="fa-solid fa-shield-halved"></i>
            <span id="mo-admin-text">Make group admin</span>
        </div>
        
        <div id="mo-remove-user" class="menu-option" style="color: #ff4757;">
            <i class="fa-solid fa-user-minus"></i>
            <span>Remove from group</span>
        </div>
        
        <div class="menu-option" onclick="app.closeModal('member-options-modal')" style="padding-bottom: 30px;">
            <i class="fa-solid fa-xmark"></i>
            <span>Cancel</span>
        </div>
    </div>
</div>
<div id="report-group-modal" class="modal-overlay" style="display: none; align-items: center;">
    <div style="background: white; width: 85%; max-width: 320px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: fadeIn 0.2s;">
        <div style="padding: 24px; text-align: center;">
            <h3 style="font-size: 20px; color: #111; margin-bottom: 12px;">Report this group to Global Connect?</h3>
            <p style="font-size: 14px; color: #667781; line-height: 1.5; margin-bottom: 20px;">
                The last 5 messages from this group will be forwarded to Global Connect. No one in this group will be notified.
            </p>
            
            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; justify-content: center; margin-bottom: 10px;">
                <input type="checkbox" id="report-exit-checkbox" style="width: 18px; height: 18px; accent-color: #00a884;">
                <span style="font-size: 14px; color: #111;">Exit group and delete chat</span>
            </label>
        </div>
        
        <div style="display: flex; border-top: 1px solid #eee;">
            <button onclick="app.closeReportModal()" style="flex: 1; padding: 15px; border: none; background: none; color: #00a884; font-weight: 600; font-size: 14px; cursor: pointer; border-right: 1px solid #eee;">Cancel</button>
            <button onclick="app.submitGroupReport()" style="flex: 1; padding: 15px; border: none; background: none; color: #00a884; font-weight: 600; font-size: 14px; cursor: pointer;">Report</button>
        </div>
    </div>
</div>
<div id="locked-chats-page" class="page full-screen" style="background: white; z-index: 150;">
    <div class="top-nav" style="border-bottom: 1px solid #e9edef;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('chat-list-page')"></i>
            <div style="font-weight: 500; font-size: 19px;">Locked Chats</div>
        </div>
        <div style="color: #54656f; font-size: 14px; cursor: pointer;" onclick="app.exitLockedPage()">Done</div>
    </div>

    <div style="padding: 20px; background: #f0f2f5; text-align: center; color: #667781; font-size: 13px;">
        <i class="fa-solid fa-lock" style="margin-right: 5px;"></i>
        These chats are locked and hidden. Use your fingerprint or passcode to view them.
    </div>

    <div id="locked-list-container" style="flex: 1; overflow-y: auto;">
        </div>
</div>
<div id="archived-chats-page" class="page full-screen" style="background: white; z-index: 145;">
    <div class="top-nav" style="border-bottom: 1px solid #e9edef;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('chat-list-page')"></i>
            <div style="font-weight: 500; font-size: 19px;">Archived Chats</div>
        </div>
    </div>
    <div id="archived-list-container" style="flex: 1; overflow-y: auto;">
        </div>
</div>

<div id="fingerprint-lock-page" class="page full-screen" style="background: #000; z-index: 10000; justify-content: center; align-items: center; color: white;">
    <div style="text-align: center;">
        <h2 style="margin-bottom: 50px; font-weight: 300; letter-spacing: 2px; color: var(--primary);">GLOBAL CONNECT</h2>
        
        <div id="scan-container" 
             style="width: 160px; height: 160px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; margin: 0 auto;"
             onmousedown="app.startAppFingerprintScan()"
             onmouseup="app.cancelAppFingerprintScan()"
             ontouchstart="app.startAppFingerprintScan()"
             ontouchend="app.cancelAppFingerprintScan()">
            
            <div id="scan-ring" style="position: absolute; width: 100%; height: 100%; border: 4px solid var(--primary); border-radius: 50%; opacity: 0; transform: scale(0.8); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);"></div>
            <i class="fa-solid fa-fingerprint" style="font-size: 80px; color: rgba(255,255,255,0.2); transition: 0.3s;" id="finger-icon"></i>
        </div>

        <p id="scan-instruction" style="margin-top: 40px; color: #888; font-size: 14px; min-height: 20px;">Press and hold to unlock</p>

        <div onclick="app.useBackupPIN()" style="margin-top: 80px; color: var(--primary); font-weight: bold; cursor: pointer; font-size: 14px; opacity: 0.8;">
            <i class="fa-solid fa-key" style="margin-right: 5px;"></i> Use Backup PIN
        </div>
    </div>
</div> <div id="pin-screen-page" class="page full-screen" style="background: #0e1621; z-index: 10001; justify-content: center; align-items: center; color: white;">
    <div style="text-align: center; width: 100%;">
        <i class="fa-solid fa-lock" style="font-size: 30px; margin-bottom: 20px; color: #5288c1;"></i>
        <h3 style="font-weight: 500; margin-bottom: 10px;">Enter your PIN</h3>
        <p style="color: #7f91a4; font-size: 14px; margin-bottom: 30px;">Your PIN is required to unlock</p>

        <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 50px;">
            <div id="pin-dot-1" class="pin-dot"></div>
            <div id="pin-dot-2" class="pin-dot"></div>
            <div id="pin-dot-3" class="pin-dot"></div>
            <div id="pin-dot-4" class="pin-dot"></div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 280px; margin: 0 auto;">
            <div class="pin-key" onclick="app.enterPinDigit('1')">1</div>
            <div class="pin-key" onclick="app.enterPinDigit('2')">2</div>
            <div class="pin-key" onclick="app.enterPinDigit('3')">3</div>
            <div class="pin-key" onclick="app.enterPinDigit('4')">4</div>
            <div class="pin-key" onclick="app.enterPinDigit('5')">5</div>
            <div class="pin-key" onclick="app.enterPinDigit('6')">6</div>
            <div class="pin-key" onclick="app.enterPinDigit('7')">7</div>
            <div class="pin-key" onclick="app.enterPinDigit('8')">8</div>
            <div class="pin-key" onclick="app.enterPinDigit('9')">9</div>
            <div style="padding: 20px;"></div> 
            <div class="pin-key" onclick="app.enterPinDigit('0')">0</div>
            <div class="pin-key" onclick="app.deletePinDigit()" style="font-size: 18px;"><i class="fa-solid fa-delete-left"></i></div>
        </div>

        <div style="margin-top: 40px; color: #5288c1; font-weight: 500; cursor: pointer;" onclick="app.closePinScreen()">Cancel</div>
    </div>
</div>
<div id="edit-contact-page" class="page full-screen" style="background: white; z-index: 1000; color: #111;">
    <div class="top-nav" style="background: white; border-bottom: none;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <i class="fa-solid fa-arrow-left" onclick="app.goToPage('user-info-page')" style="font-size: 20px; cursor: pointer;"></i>
            <h2 style="font-size: 20px; font-weight: 500;">Edit contact</h2>
        </div>
        <div style="position: relative;">
            <i class="fa-solid fa-ellipsis-vertical" id="contact-edit-menu-trigger" onclick="app.toggleEditContactMenu()" style="font-size: 20px; cursor: pointer; padding: 10px;"></i>
            <div id="contact-delete-dropdown" class="chat-menu" style="top: 40px; right: 0; width: 180px; display: none;">
                <div class="menu-item" style="color: #d32f2f;" onclick="app.deleteSavedContact()">Delete contact</div>
            </div>
        </div>
    </div>

    <div style="padding: 20px; flex: 1; overflow-y: auto;">
        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 25px;">
            <i class="fa-regular fa-user" style="margin-top: 15px; color: #667781; font-size: 20px;"></i>
            <div style="flex: 1; border-bottom: 1px solid #e9edef;">
                <label style="font-size: 12px; color: #008069; font-weight: 500;">First name</label>
                <input type="text" id="edit-contact-firstname" style="width: 100%; border: none; padding: 8px 0; outline: none; font-size: 16px;">
            </div>
        </div>

        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 25px;">
            <i class="fa-solid fa-shop" style="margin-top: 15px; color: #667781; font-size: 18px;"></i>
            <div style="flex: 1; border-bottom: 1px solid #e9edef;">
                <label style="font-size: 12px; color: #667781;">Business name</label>
                <input type="text" id="edit-contact-business" style="width: 100%; border: none; padding: 8px 0; outline: none; font-size: 16px;">
            </div>
        </div>

        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 25px;">
            <i class="fa-solid fa-phone" style="margin-top: 15px; color: #667781; font-size: 18px;"></i>
            <div style="display: flex; gap: 10px; flex: 1;">
                <div style="flex: 0.4; border-bottom: 1px solid #e9edef;">
                    <label style="font-size: 12px; color: #667781;">Country</label>
                    <div style="padding: 8px 0; font-size: 16px;">NG +234 <i class="fa-solid fa-caret-down" style="font-size: 12px; margin-left: 5px;"></i></div>
                </div>
                <div style="flex: 1; border-bottom: 1px solid #e9edef;">
                    <label style="font-size: 12px; color: #667781;">Phone</label>
                    <input type="text" id="edit-contact-phone" readonly style="width: 100%; border: none; padding: 8px 0; outline: none; font-size: 16px; color: #667781;">
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <i class="fa-solid fa-arrows-rotate" style="color: #667781; font-size: 18px;"></i>
                <span style="font-size: 16px;">Sync contact to phone</span>
            </div>
            <label class="switch">
                <input type="checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    <div style="padding: 20px;">
        <button class="btn" style="background: #111; color: white; width: 100%; border-radius: 30px; font-weight: 600; padding: 15px;" onclick="app.saveContactLogic()">Save</button>
    </div>
</div>
<div id="phone-auth-page" class="page full-screen" style="background: white; z-index: 1000;">
    <div style="padding: 20px;">
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
            <i class="fa-solid fa-arrow-left" onclick="app.goToPage('auth-page')" style="font-size: 20px; color: #54656f; cursor: pointer;"></i>
            <h2 style="font-size: 20px; font-weight: 600; color: #111b21;">Verify your phone number</h2>
        </div>
        
        <p style="text-align: center; font-size: 14px; color: #54656f; margin-bottom: 25px; padding: 0 10px;">
            Global Connect will send an SMS message to verify your phone number. Enter your country code and phone number.
        </p>

        <div style="width: 85%; margin: 0 auto; border-bottom: 1px solid #00a884; padding-bottom: 5px; margin-bottom: 20px;">
            <select id="country-code" onchange="document.getElementById('display-code').innerText = this.value" style="width: 100%; border: none; font-size: 16px; outline: none; background: transparent; cursor: pointer;">
                <option value="+234">Nigeria</option>
                <option value="+1">United States</option>
                <option value="+44">United Kingdom</option>
                <option value="+27">South Africa</option>
                <option value="+91">India</option>
            </select>
        </div>

        <div style="width: 85%; margin: 0 auto; display: flex; gap: 10px; border-bottom: 1px solid #00a884; padding-bottom: 5px;">
            <span id="display-code" style="font-size: 18px; color: #111; font-weight: 500;">+234</span>
            <input type="tel" id="phone-number-input" placeholder="phone number" style="flex: 1; border: none; font-size: 18px; outline: none; letter-spacing: 1px;">
        </div>

        <div id="recaptcha-container"></div>

        <div style="display: flex; justify-content: center; margin-top: 50px;">
            <button class="btn" style="background: #008069; color: white; border-radius: 3px; width: 80px; padding: 10px; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onclick="app.sendOTP()">NEXT</button>
        </div>
    </div>
</div>

<div id="otp-verification-page" class="page full-screen" style="background: white; z-index: 1001;">
    <div style="padding: 20px; text-align: center;">
        <h2 style="font-size: 20px; color: #008069; margin-top: 40px; font-weight: 600;">Verifying your number</h2>
        <p style="font-size: 14px; color: #54656f; margin: 20px 0; line-height: 1.5;">
            Waiting to automatically detect an SMS sent to <br><b id="display-full-number" style="color: #111;"></b>. <span style="color: #008069; cursor: pointer;" onclick="app.goToPage('phone-auth-page')">Wrong number?</span>
        </p>

        <div style="display: flex; justify-content: center; margin-bottom: 10px;">
            <input type="number" id="otp-code" placeholder="--- ---" 
                   oninput="if(this.value.length === 6) app.verifyOTP()"
                   style="width: 180px; text-align: center; font-size: 32px; letter-spacing: 5px; border: none; border-bottom: 2px solid #00a884; outline: none; font-family: monospace;">
        </div>

        <p style="font-size: 13px; color: #8696a0; margin-top: 10px;">Enter 6-digit code</p>
        
        <div style="margin-top: 50px; display: flex; flex-direction: column; gap: 20px; align-items: center; color: #8696a0; font-size: 14px;">
            <div style="display: flex; align-items: center; gap: 15px; cursor: pointer;" onclick="app.sendOTP()">
                <i class="fa-solid fa-message"></i>
                <span style="color: #008069; font-weight: 500;">Resend SMS</span>
            </div>
            <div style="border-top: 1px solid #eee; width: 80%; padding-top: 15px; display: flex; align-items: center; gap: 15px; opacity: 0.6;">
                <i class="fa-solid fa-phone"></i>
                <span>Call me</span>
            </div>
        </div>
    </div>
</div>
<div id="chats-settings-page" class="page full-screen" style="background: white; z-index: 150;">
    <div class="top-nav" style="background: white; border-bottom: none; justify-content: flex-start; gap: 25px; height: 60px;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('settings-page')" style="cursor: pointer; color: #54656f; font-size: 20px; margin-left: 5px;"></i>
        <div style="font-weight: 500; font-size: 20px; color: #111b21;">Chats</div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding-bottom: 20px;">
        <div style="padding: 15px 20px 10px 20px; font-size: 14px; font-weight: 600; color: #667781;">Display</div>
        
        <div class="settings-item" onclick="app.openThemeDialog()" style="border: none; padding: 12px 20px; cursor: pointer;">
    <div style="display: flex; gap: 20px; align-items: center;">
        <i class="fa-solid fa-brightness-low" style="color: #54656f; font-size: 20px; width: 25px; text-align: center;"></i>
        <div>
            <div style="font-size: 16px; color: var(--text-primary);">Theme</div>
            <div id="current-theme-label" style="font-size: 14px; color: var(--text-secondary);">Light</div>
        </div>
    </div>
</div>

        <div class="settings-item" style="border: none; padding: 12px 20px;" onclick="app.goToPage('chat-theme-page')">
    <div style="display: flex; gap: 20px; align-items: center;">
        <i class="fa-solid fa-palette" style="color: #54656f; font-size: 20px; width: 25px; text-align: center;"></i>
        <div style="font-size: 16px; color: var(--text-primary);">Default chat theme</div>
    </div>
</div>

        <hr style="border: 0; border-top: 1px solid #f0f2f5; margin: 10px 0;">

        <div style="padding: 15px 20px 10px 20px; font-size: 14px; font-weight: 600; color: #667781;">Chat settings</div>

        <div class="settings-item" style="border: none; justify-content: space-between; padding: 12px 20px;">
            <div style="margin-left: 45px;">
                <div style="font-size: 16px; color: #111b21;">Enter is send</div>
                <div style="font-size: 14px; color: #667781;">Enter key will send your message</div>
            </div>
            <label class="switch">
                <input type="checkbox">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="settings-item" style="border: none; justify-content: space-between; padding: 12px 20px;">
            <div style="margin-left: 45px;">
                <div style="font-size: 16px; color: #111b21;">Media visibility</div>
                <div style="font-size: 14px; color: #667781;">Show newly downloaded media in your device's gallery</div>
            </div>
            <label class="switch">
                <input type="checkbox" checked>
                <span class="slider round"></span>
            </label>
        </div>

        <div class="settings-item" style="border: none; padding: 12px 20px;">
            <div style="margin-left: 45px;">
                <div style="font-size: 16px; color: #111b21;">Font size</div>
                <div style="font-size: 14px; color: #667781;">Medium</div>
            </div>
        </div>

        <div class="settings-item" style="border: none; justify-content: space-between; padding: 12px 20px; cursor: pointer;" onclick="app.openTranscriptLanguageModal()">
    <div style="margin-left: 45px;">
        <div style="font-size: 16px; color: #111b21;">Voice message transcripts</div>
        <div id="transcript-status-label" style="font-size: 14px; color: #667781;">translate voice note form user</div>
    </div>
    <label class="switch" onclick="event.stopPropagation()">
        <input type="checkbox" id="transcript-toggle" onchange="app.handleTranscriptToggle(this.checked)">
        <span class="slider round"></span>
    </label>
</div>

        <hr style="border: 0; border-top: 1px solid #f0f2f5; margin: 10px 0;">

        <div style="padding: 15px 20px 10px 20px; font-size: 14px; font-weight: 600; color: #667781;">Archived chats</div>
        <div class="settings-item" style="border: none; justify-content: space-between; padding: 12px 20px;">
            <div style="margin-left: 45px;">
                <div style="font-size: 16px; color: #111b21;">Keep chats archived</div>
                <div style="font-size: 14px; color: #667781;">Archived chats will remain archived when you receive a new message</div>
            </div>
            <label class="switch">
                <input type="checkbox" checked>
                <span class="slider round"></span>
            </label>
        </div>

       <hr style="border: 0; border-top: 1px solid #f0f2f5; margin: 10px 0;">

<div class="settings-item" style="border: none; padding: 15px 20px; cursor: pointer;" onclick="app.goToPage('chat-backup-page')">
    <div style="display: flex; gap: 20px; align-items: center;">
        <i class="fa-solid fa-cloud-arrow-up" style="color: #54656f; font-size: 20px; width: 25px; text-align: center;"></i>
        <div>
            <div style="font-size: 16px; color: #111b21;">Chat backup</div>
            <div style="font-size: 13px; color: #667781;">Last backup: <span id="last-backup-status-label">None</span></div>
        </div>
    </div>
</div>

        <div class="settings-item" style="border: none; padding: 15px 20px;">
            <div style="display: flex; gap: 20px; align-items: center;">
                <i class="fa-solid fa-clock-rotate-left" style="color: #54656f; font-size: 20px; width: 25px; text-align: center;"></i>
                <div style="font-size: 16px; color: #111b21;">Chat history</div>
            </div>
        </div>
    </div>
</div>
<div id="theme-dialog-overlay" class="modal-overlay" style="display: none; align-items: center; justify-content: center;" onclick="app.closeThemeDialog()">
    <div class="modal-content" style="background: white; width: 85%; max-width: 320px; border-radius: 28px; padding: 24px; animation: fadeIn 0.2s;" onclick="event.stopPropagation()">
        <h3 style="margin-bottom: 20px; font-size: 20px; color: var(--text-primary); font-weight: 500;">Choose theme</h3>
        
        <div class="radio-option" onclick="app.setTheme('system')" style="padding: 12px 0;">
            <div class="radio-circle" id="theme-system-radio"><div class="radio-dot"></div></div>
            <span style="font-size: 16px; color: var(--text-primary);">System default</span>
        </div>
        <div class="radio-option" onclick="app.setTheme('light')" style="padding: 12px 0;">
            <div class="radio-circle" id="theme-light-radio"><div class="radio-dot"></div></div>
            <span style="font-size: 16px; color: var(--text-primary);">Light</span>
        </div>
        <div class="radio-option" onclick="app.setTheme('dark')" style="padding: 12px 0;">
            <div class="radio-circle" id="theme-dark-radio"><div class="radio-dot"></div></div>
            <span style="font-size: 16px; color: var(--text-primary);">Dark</span>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 24px; margin-top: 20px;">
            <button onclick="app.closeThemeDialog()" style="background: none; border: none; color: #008069; font-weight: 600; font-size: 14px; cursor: pointer;">Cancel</button>
            <button onclick="app.confirmTheme()" style="background: none; border: none; color: #008069; font-weight: 600; font-size: 14px; cursor: pointer;">OK</button>
        </div>
    </div>
</div>
<div id="chat-theme-page" class="page full-screen" style="z-index: 160;">
    <div class="top-nav" style="border-bottom: none;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chats-settings-page')"></i>
        <div style="font-weight: 500; font-size: 20px; margin-left: 20px;">Chat theme</div>
        <div style="flex: 1;"></div>
        <i class="fa-solid fa-ellipsis-vertical"></i>
    </div>

    <div style="padding: 15px 20px; color: var(--text-secondary); font-size: 14px;">Themes</div>
    
    <div id="theme-grid" class="theme-selection-grid">
        </div>

    <div style="margin-top: 20px; padding: 0 20px;">
        <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">
            The chat color and wallpaper will both change.
        </div>
        
        <div style="font-weight: 600; font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">Customize</div>
        
        <div class="settings-item" onclick="app.goToPage('chat-color-page')" style="border: none; padding: 12px 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <i class="fa-regular fa-comment-dots" style="color: #54656f; width: 25px; font-size: 20px; text-align: center;"></i>
            <div style="font-size: 16px; color: var(--text-primary);">Chat color</div>
        </div>
    </div>
        <div class="settings-item" onclick="app.goToPage('wallpaper-selection-page')" style="border: none;">
            <i class="fa-regular fa-image" style="width: 30px; font-size: 20px;"></i>
            <div style="flex: 1; margin-left: 10px;">Wallpaper</div>
        </div>
    </div>
</div>

<div id="theme-preview-page" class="page full-screen" style="z-index: 170; background: black; overflow: hidden;">
    <div id="preview-dimmer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0.4; z-index: 2; pointer-events: none;"></div>

    <div class="top-nav" style="position: absolute; top: 0; left: 0; width: 100%; background: transparent; color: white; z-index: 10; border: none;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chat-theme-page')"></i>
        <div style="font-weight: 500; font-size: 20px; margin-left: 20px;">Preview</div>
        <div style="flex: 1;"></div>
        <div class="check-btn" onclick="app.applySelectedTheme()" style="background: white; color: black; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
            <i class="fa-solid fa-check"></i>
        </div>
    </div>

    <div class="dimmer-controls" style="position: absolute; right: 20px; bottom: 100px; z-index: 15; display: flex; flex-direction: column; align-items: center; gap: 10px;">
        <i class="fa-solid fa-sun" style="color: white; font-size: 14px;"></i>
        <div class="slider-wrapper">
            <input type="range" id="wallpaper-dimmer-input" min="0" max="100" value="40" oninput="app.adjustPreviewDimming(this.value)">
        </div>
        <i class="fa-solid fa-moon" style="color: white; font-size: 14px;"></i>
    </div>

    <div id="preview-slider" class="preview-container" style="z-index: 1;">
        </div>
</div>


<div id="chat-color-page" class="page full-screen" style="z-index: 165; background: #0b141a;">
    <div class="top-nav" style="background: #0b141a; border: none;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chat-theme-page')" style="color: white;"></i>
        <div style="font-weight: 500; font-size: 20px; margin-left: 20px; color: white;">Chat color</div>
        <div style="flex: 1;"></div>
        <i class="fa-solid fa-ellipsis-vertical" style="color: white;"></i>
    </div>
    
    <div id="color-picker-grid" class="color-picker-grid" style="padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px;">
        </div>
</div>
<div id="wallpaper-selection-page" class="page full-screen" style="z-index: 161; background: #f0f2f5;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #e9edef;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chat-theme-page')" style="color: #54656f;"></i>
        <div style="font-weight: 500; font-size: 20px; margin-left: 20px; color: #111b21;">Custom wallpaper</div>
    </div>

    <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div onclick="app.openWallpaperGallery('bright')" style="cursor: pointer;">
            <div style="aspect-ratio: 1; border-radius: 15px; background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=300') center/cover; border: 1px solid #ddd;"></div>
            <div style="text-align: center; margin-top: 8px; font-weight: 500; color: #111b21;">Bright</div>
        </div>

        <div onclick="app.openWallpaperGallery('dark')" style="cursor: pointer;">
            <div style="aspect-ratio: 1; border-radius: 15px; background: url('https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=300') center/cover; border: 1px solid #ddd; filter: brightness(0.6);"></div>
            <div style="text-align: center; margin-top: 8px; font-weight: 500; color: #111b21;">Dark</div>
        </div>

        <div onclick="app.goToPage('chat-color-page')" style="cursor: pointer;">
            <div style="aspect-ratio: 1; border-radius: 15px; background: #005c4b; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                <i class="fa-solid fa-palette"></i>
            </div>
            <div style="text-align: center; margin-top: 8px; font-weight: 500; color: #111b21;">Solid colors</div>
        </div>

        <div onclick="document.getElementById('wallpaper-upload-input').click()" style="cursor: pointer;">
            <div style="aspect-ratio: 1; border-radius: 15px; background: white; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; color: #54656f; font-size: 24px;">
                <i class="fa-regular fa-image"></i>
            </div>
            <div style="text-align: center; margin-top: 8px; font-weight: 500; color: #111b21;">My photos</div>
        </div>
    </div>

    <input type="file" id="wallpaper-upload-input" accept="image/*" style="display: none;" onchange="app.handleWallpaperUpload(this)">
    
    <div style="margin-top: 10px;">
        <div style="padding: 15px 20px; font-size: 14px; color: #54656f; background: white;">
            Default Wallpaper
        </div>
    </div>
</div>
<div id="chat-backup-page" class="page full-screen" style="background: #0b141a; color: white; z-index: 180;">
    <div class="top-nav" style="background: #0b141a; border-bottom: 1px solid #232d36;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('chats-settings-page')"></i>
        <div style="font-weight: 500; font-size: 20px; margin-left: 20px;">Chat backup</div>
    </div>

    <div style="padding: 20px; overflow-y: auto; flex: 1;">
        <div style="font-size: 14px; color: #8696a0; margin-bottom: 20px; line-height: 1.5;">
            Back up your chats and media to your Google Account's storage. You can restore them on a new phone after you download Global Connect on it.
        </div>

        <div style="margin-bottom: 30px; font-size: 14px;">
            <div style="color: #8696a0;">Local: <span id="backup-local-time">Calculating...</span></div>
            <div style="color: #8696a0;">Last Backup: <span id="backup-cloud-time">None</span></div>
        </div>

        <button id="backup-now-btn" class="btn" style="background: #00a884; color: #111b21; width: 120px; border-radius: 20px; margin: 0; font-weight: bold;" onclick="app.startManualBackup()">Back up</button>

        <div id="backup-progress-container" style="display: none; margin-top: 25px; width: 100%;">
            <div style="display: flex; justify-content: space-between; font-size: 13px; color: #00a884; margin-bottom: 8px; font-weight: 500;">
                <span>Uploading to Google Drive...</span>
                <span id="backup-pct">0%</span>
            </div>
            <div style="width: 100%; height: 4px; background: #232d36; border-radius: 20px; overflow: hidden;">
                <div id="backup-progress-fill" style="width: 0%; height: 100%; background: #00a884; transition: width 0.1s linear;"></div>
            </div>
        </div>

        <div style="margin-top: 40px;">
            <div style="color: #00a884; font-weight: bold; font-size: 14px; margin-bottom: 15px;">Manage Google storage</div>
            <div style="font-size: 13px; color: #8696a0;">Storage info synced with your Google Account.</div>
        </div>

        <div style="margin-top: 30px; border-top: 1px solid #232d36; padding-top: 20px;">
            <div onclick="app.openAccountChooser()" style="cursor: pointer; margin-bottom: 25px;">
                <div style="font-size: 16px;">Google Account</div>
                <div id="selected-backup-email" style="font-size: 14px; color: #8696a0;">Select an account</div>
            </div>

            <div class="settings-item" style="border: none; padding: 0; margin-bottom: 25px; justify-content: space-between;">
                <div>
                    <div style="font-size: 16px;">Automatic backups</div>
                    <div id="auto-backup-status" style="font-size: 14px; color: #8696a0;">Off</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="auto-backup-toggle" onchange="app.toggleAutoBackup(this.checked)">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<div id="modal-account-chooser" class="modal-overlay" onclick="app.closeModal('modal-account-chooser')">
    <div class="modal-content center-box" style="background: #1f2c34; border-radius: 20px; padding: 0; width: 85%; max-width: 320px;" onclick="event.stopPropagation()">
        <div style="padding: 24px 24px 10px; font-size: 22px; color: white;">Choose an account</div>
        <div id="email-list-container" style="max-height: 400px; overflow-y: auto; padding: 10px 0;">
            </div>
        <div style="padding: 15px 24px; text-align: right;">
            <span style="color: #00a884; font-weight: bold; cursor: pointer;" onclick="app.closeModal('modal-account-chooser')">Cancel</span>
        </div>
    </div>
</div>

<div id="modal-transcript-lang" class="modal-overlay" onclick="app.closeModal('modal-transcript-lang')">
    <div class="modal-content bottom-sheet" style="background: #1f2c34; border-radius: 20px 20px 0 0;" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <h3 style="padding: 0 20px 15px; font-size: 18px; color: white;">Download AI Voice Pack</h3>
        
        <div id="transcript-lang-list" style="max-height: 400px; overflow-y: auto;">
            </div>

        <div id="download-progress-container" style="display: none; padding: 20px; border-top: 1px solid #2a3942;">
            <div style="display: flex; justify-content: space-between; color: #00a884; font-size: 13px; margin-bottom: 8px;">
                <span id="download-status-text">Downloading...</span>
                <span id="download-pct">0%</span>
            </div>
            <div style="width: 100%; height: 4px; background: #232d36; border-radius: 10px; overflow: hidden;">
                <div id="download-progress-fill" style="width: 0%; height: 100%; background: #00a884; transition: width 0.1s linear;"></div>
            </div>
        </div>

        <div style="padding: 15px 24px; text-align: right;">
            <span style="color: #00a884; font-weight: bold; cursor: pointer;" onclick="app.closeModal('modal-transcript-lang')">Cancel</span>
        </div>
    </div>
</div>
<div id="help-page" class="page full-screen" style="background: #f0f2f5; z-index: 180;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #ddd;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('settings-page')" style="cursor: pointer; color: #54656f;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 20px; color: #111b21;">Help</div>
    </div>

    <div style="flex: 1; overflow-y: auto;">
        <div style="background: white; margin-bottom: 10px;">
            <div class="list-item" onclick="app.runSystemCheck()">
                <i class="fa-solid fa-microchip" style="width: 30px; color: #54656f;"></i>
                <div style="flex: 1;">System Health Check</div>
                <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
            </div>
            <div class="list-item" onclick="app.openSupportChat()">
                <i class="fa-solid fa-comment-dots" style="width: 30px; color: #54656f;"></i>
                <div style="flex: 1;">Contact us <br><small style="color: gray;">Questions? Help is a chat away.</small></div>
            </div>
        </div>

        <div style="background: white; margin-bottom: 10px;">
            <div class="list-item"><i class="fa-solid fa-phone" style="width:30px; color:#54656f;"></i> Call Support</div>
            <div class="list-item"><i class="fa-solid fa-video" style="width:30px; color:#54656f;"></i> Video Help</div>
            <div class="list-item"><i class="fa-solid fa-file-lines" style="width:30px; color:#54656f;"></i> Terms and Privacy Policy</div>
        </div>

        <div style="padding: 20px; text-align: center; color: #667781;">
            <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">Global Connect</div>
            <div style="font-size: 12px;">Version 2.25.12.78-pro</div>
        </div>
    </div>
</div>

<div id="modal-system-check" class="modal-overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal-content center-box" style="background: white; border-radius: 15px; text-align: center; padding: 30px;">
        <div id="check-icon-container">
            <div class="sending-spinner" style="margin: 0 auto 20px;"></div>
        </div>
        <h3 id="check-status-title" style="color: #111; margin-bottom: 10px;">Checking system...</h3>
        <p id="check-status-desc" style="color: #667781; font-size: 14px;">Analyzing app cache and connection.</p>
        <button id="check-done-btn" class="btn btn-primary" style="display: none; margin-top: 20px;" onclick="app.closeModal('modal-system-check')">Finish</button>
    </div>
</div>
<div id="attachment-menu" class="attachment-menu">
    <div class="attachment-grid">
        <div class="attach-item" onclick="document.getElementById('doc-upload-input').click(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #7f66ff;"><i class="fa-solid fa-file-lines"></i></div>
            <span>Document</span>
        </div>

        <div class="attach-item" onclick="App.openCamera(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #ff2e74;"><i class="fa-solid fa-camera"></i></div>
            <span>Camera</span>
        </div>

        <div class="attach-item" onclick="document.getElementById('img-upload').click(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #007aff;"><i class="fa-solid fa-image"></i></div>
            <span>Gallery</span>
        </div>

        <div class="attach-item" onclick="document.getElementById('video-dm-upload').click(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #ff4757;"><i class="fa-solid fa-video"></i></div>
            <span>Video</span>
        </div>

        <div class="attach-item" onclick="document.getElementById('audio-upload-input').click(); App.toggleAttachMenu()">
    <div class="attach-icon" style="background: #ff9500;"><i class="fa-solid fa-headphones"></i></div>
    <span>Audio</span>
</div>

        <div class="attach-item" onclick="App.openGameFrame(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #ffcc00;"><i class="fa-solid fa-gamepad"></i></div>
            <span>Game</span> 
        </div>

        <div class="attach-item" onclick="App.openCatalogPicker(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #00c7be;"><i class="fa-solid fa-shop"></i></div>
            <span>Catalog</span>
        </div>

        <div class="attach-item" onclick="App.openPollCreator(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #ffbc38;"><i class="fa-solid fa-square-poll-vertical"></i></div>
            <span>Poll</span>
        </div>

        <div class="attach-item" onclick="App.openLocationPage(); App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #34c759;">
                <i class="fa-solid fa-location-dot"></i>
            </div>
            <span>Location</span>
        </div>

        <div class="attach-item" onclick="App.toggleAttachMenu()">
            <div class="attach-icon" style="background: #02a0e3;"><i class="fa-solid fa-user"></i></div>
            <span>Contact</span>
        </div>
    </div>
</div>

<input type="file" id="video-dm-upload" accept="video/mp4,video/quicktime" style="display: none;" onchange="app.handleDMVideoUpload(this)">
<input type="file" id="img-upload" accept="image/*" style="display: none;" onchange="app.sendImage(this)">
<input type="file" id="doc-upload-input" style="display: none;" onchange="App.handleDocFile(this)">
<input type="file" id="audio-upload-input" accept="audio/*" style="display: none;" onchange="App.handleAudioFile(this)">

<div id="poll-creator-page" class="page" style="display:none; background: #121b22; color: white;">
    <div class="header" style="background: #202c33; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #2f3b43;">
        <i class="fa-solid fa-xmark" onclick="App.goToPage('chat-room')" style="cursor:pointer; font-size: 20px;"></i>
        <span style="font-weight: bold; font-size: 18px; flex: 1;">Create Poll</span>
        <button onclick="App.submitPoll()" style="background: #00a884; border: none; color: white; padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer;">Send</button>
    </div>

    <div style="padding: 20px;">
        <div style="margin-bottom: 30px;">
            <label style="color: #00a884; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Question</label>
            <input type="text" id="poll-question" placeholder="Ask a question" 
                   style="width: 100%; background: transparent; border: none; border-bottom: 2px solid #00a884; color: white; padding: 12px 0; outline: none; font-size: 16px;">
        </div>

        <div id="poll-options-container">
            <label style="color: #8696a0; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Options</label>
            </div>
        
        <button onclick="App.addPollOption()" style="background: transparent; border: none; color: #00a884; font-size: 15px; margin-top: 20px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 10px;">
            <i class="fa-solid fa-plus" style="background: rgba(0, 168, 132, 0.1); padding: 8px; border-radius: 50%;"></i> 
            Add Option
        </button>
    </div>
</div>
<div id="location-page" class="page full-screen" style="display:none; background: #121b22; color: white;">
    <div class="header" style="background: #202c33; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #2f3b43;">
        <i class="fa-solid fa-arrow-left" onclick="App.goToPage('chat-room')" style="cursor:pointer; font-size: 20px;"></i>
        <span style="font-weight: bold; font-size: 18px;">Send location</span>
    </div>

    <div id="location-map-container" style="width: 100%; height: 300px; background: #2a2f32; position: relative;">
        <div id="map-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #8696a0; text-align: center;">
            <div class="sending-spinner" style="margin: 0 auto 10px;"></div>
            Finding location...
        </div>
        <iframe id="loc-iframe" width="100%" height="100%" frameborder="0" style="border:0; display:none;" allowfullscreen></iframe>
    </div>

    <div style="padding: 20px;">
        <div onclick="App.sendCurrentLocation()" style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; cursor: pointer;">
            <div style="width: 45px; height: 45px; background: #00a884; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fa-solid fa-location-crosshairs" style="color: white; font-size: 20px;"></i>
            </div>
            <div>
                <div style="font-weight: bold; color: #e9edef; font-size: 16px;">Send your current location</div>
                <div style="font-size: 13px; color: #8696a0;">Accurate to 15 meters</div>
            </div>
        </div>
        
        <div onclick="App.startLiveLocation('1h')" style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; cursor: pointer;">
            <div style="width: 45px; height: 45px; background: #25D366; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: relative;">
                <i class="fa-solid fa-location-dot" style="color: white; font-size: 20px;"></i>
                <div style="position: absolute; width: 100%; height: 100%; border: 2px solid white; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
            </div>
            <div>
                <div style="font-weight: bold; color: #e9edef; font-size: 16px;">Share live location</div>
                <div style="font-size: 13px; color: #8696a0;">Updates as you move â€¢ 1 hour</div>
            </div>
        </div>

        <div style="color: #8696a0; font-size: 12px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; margin-bottom: 15px;">Nearby places</div>
        <div style="color: #00a884; font-size: 14px; opacity: 0.8;"><i class="fa-solid fa-rotate-right fa-spin"></i> Loading nearby places...</div>
    </div>
</div>
<div id="audio-picker-page" class="page full-screen" style="display:none; background: #121b22; color: white;">
    <div class="header" style="background: #202c33; padding: 15px; display: flex; align-items: center; gap: 15px;">
        <i class="fa-solid fa-arrow-left" onclick="App.goToPage('chat-room')" style="cursor:pointer;"></i>
        <span style="font-weight: bold;">Send Audio</span>
    </div>
    <div style="padding: 20px;">
        <div onclick="document.getElementById('audio-upload-input').click()" style="background: #202c33; padding: 20px; border-radius: 15px; text-align: center; border: 2px dashed #2f3b43;">
            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 30px; color: #00a884; margin-bottom: 10px;"></i>
            <div>Choose from Music Library</div>
        </div>
        <input type="file" id="audio-upload-input" accept="audio/*" style="display:none;" onchange="App.handleAudioFile(this)">
    </div>
</div>

<div id="catalog-page" class="page full-screen" style="display:none; background: #121b22; color: white;">
    <div class="header" style="background: #202c33; padding: 15px; display: flex; align-items: center; gap: 15px;">
        <i class="fa-solid fa-xmark" onclick="App.goToPage('chat-room')" style="cursor:pointer;"></i>
        <span style="font-weight: bold;">Select Product</span>
    </div>
    <div id="catalog-list" style="padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        </div>
</div>

<input type="file" id="doc-upload-input" style="display:none;" onchange="App.handleDocFile(this)">
<div id="private-chat-page" class="page full-screen" style="background: #f0f2f5; z-index: 1000;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #e9edef;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="App.goToPage('settings-page')"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 15px;">Private Chats</div>
    </div>

    <div style="padding: 20px;">
        <div id="private-user-info-box" style="text-align: center; margin-bottom: 30px;">
            <div style="width: 70px; height: 70px; background: #e9edef; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                <i class="fa-solid fa-user-secret" style="font-size: 30px; color: #54656f;"></i>
            </div>
            <h3 id="private-user-name" style="margin-bottom: 20px;">User Name</h3>
            
            <div style="background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                <div style="text-align: left;">
                    <div style="font-size: 15px; font-weight: 500;">Hide this chat</div>
                    <div style="font-size: 11px; color: #667781;">Remove from Home Screen</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="private-chat-switch" onchange="App.togglePrivateStatus(this.checked)">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div id="hidden-users-list" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            </div>

        <p style="color: #8696a0; font-size: 12px; margin-top: 20px; text-align: center; line-height: 1.4; padding: 0 20px;">
            Hidden chats are removed from the home screen, cards, and matches. Turn them back on to see them again.
        </p>
    </div>
</div>
<div id="gift-page" class="page full-screen" style="background: #17212b; color: white; z-index: 1000;">
    <div class="top-nav" style="background: #232e3c; border-bottom: 1px solid #17212b; padding: 0 15px;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('user-info-page')" style="cursor:pointer; font-size: 18px;"></i>
        <div style="font-weight: 600; font-size: 18px; flex: 1; margin-left: 20px;">Send Gift to <span id="gift-target-name">User</span></div>
        <div style="background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px;">
            <i class="fa-solid fa-gem" style="color: #ff4b7d; font-size: 12px;"></i> 
            <span id="gift-balance" style="font-weight: bold; font-size: 14px;">0</span>
        </div>
    </div>

    <div style="padding: 20px; overflow-y: auto; height: calc(100% - 60px);">
        <div id="gift-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>

        <div id="premium-gift-card" style="margin-top: 15px;"></div>
    </div>
</div>
<div id="wallet-page" class="page full-screen" style="background: #0f171e; color: white; z-index: 1000;">
    <div class="top-nav" style="background: #1c2733; border-bottom: 1px solid #232e3c; padding: 0 15px; display: flex; align-items: center; height: 60px;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('edit-profile-page')" style="color: white; font-size: 18px; cursor: pointer;"></i>
        <div style="font-weight: 600; font-size: 17px; flex: 1; margin-left: 15px;">Earnings & Wallet</div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <i class="fa-solid fa-clock-rotate-left" style="color: #8696a0; font-size: 18px; cursor: pointer;" onclick="app.renderTransactionHistory(); app.renderWithdrawalHistory();"></i>
            <div style="background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px; font-size: 13px; color: #8696a0;">
                ID: <span id="wallet-user-id">0000</span>
            </div>
        </div>
    </div>

    <div style="padding: 25px; overflow-y: auto; height: calc(100% - 60px);">
        
        <div style="background: linear-gradient(180deg, rgba(88,101,242,0.1) 0%, rgba(15,23,30,0) 100%); padding: 40px 20px; border-radius: 30px; border: 1px solid rgba(88,101,242,0.2); margin-bottom: 30px; text-align: center;">
            <p style="color: #8696a0; font-size: 12px; text-transform: uppercase; font-weight: bold; letter-spacing: 1.5px; margin-bottom: 10px;">Withdrawable Earnings</p>
            <h1 style="font-size: 48px; font-weight: 900; margin-bottom: 8px;">$<span id="wallet-usd-balance">0.00</span></h1>
            <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(255, 75, 125, 0.1); padding: 6px 15px; border-radius: 20px; color: #ff4b7d; font-weight: bold; font-size: 14px;">
                <i class="fa-solid fa-gem"></i> <span id="wallet-orb-balance">0</span> Orbs
            </div>
        </div>

        <button class="btn btn-primary" onclick="app.withdrawFunds()" style="width: 100%; height: 55px; border-radius: 15px; background: #00a884; font-size: 16px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,168,132,0.2); border: none; color: white;">
            Withdraw to Account
        </button>

        <div style="margin-top: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #fff; font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Quick Top-up</h4>
                <span style="color: #5865F2; font-size: 12px; font-weight: bold; cursor: pointer;" onclick="app.openShopPage()">Store</span>
            </div>
            <div id="wallet-topup-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                </div>
        </div>

        <div style="margin-top: 40px;">
            <h4 style="color: #fff; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;">Recent Gifts</h4>
            <div id="wallet-history-list" style="background: rgba(255,255,255,0.03); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
                <div style="padding: 30px; text-align: center; color: #8696a0; font-size: 13px;">No recent transactions.</div>
            </div>
        </div>

        <div style="margin-top: 40px; padding-bottom: 50px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #fff; font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Withdrawal Status</h4>
                <i class="fa-solid fa-rotate" style="color: #5865F2; font-size: 14px; cursor: pointer;" onclick="app.renderWithdrawalHistory()"></i>
            </div>
            <div id="withdrawal-status-list" style="background: rgba(255,255,255,0.03); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden;">
                <div style="padding: 30px; text-align: center; color: #8696a0; font-size: 12px;">
                    <i class="fa-solid fa-clock-rotate-left" style="font-size: 24px; display: block; margin-bottom: 10px; opacity: 0.3;"></i>
                    No withdrawal requests found.
                </div>
            </div>
        </div>

    </div>
</div>

<div id="withdrawal-methods-page" class="page full-screen" style="background: #0f171e; color: white; z-index: 1100;">
    <div class="top-nav" style="background: #1c2733; border-bottom: 1px solid #232e3c;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('wallet-page')" style="cursor:pointer;"></i>
        <div style="font-weight: 800; font-size: 18px; margin-left: 15px;">Withdraw Funds</div>
    </div>

    <div style="padding: 20px; overflow-y: auto;">
        <div style="text-align: center; margin-bottom: 30px;">
            <p style="color: #8696a0; font-size: 12px;">AVAILABLE TO WITHDRAW</p>
            <h1 style="font-size: 32px;">$<span id="draw-usd-amount">0.00</span></h1>
        </div>

        <p class="payout-label">Select Payout Method</p>
        
        <div class="bank-grid">
            <div class="bank-card" onclick="app.selectBank('OPay', 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Opay_logo.png/640px-Opay_logo.png', this)">
                <img src="https://logowik.com/content/uploads/images/opay3983.logowik.com.webp" class="bank-logo">
                <div class="bank-name">OPay</div>
            </div>
            <div class="bank-card" onclick="app.selectBank('PalmPay', 'https://pbs.twimg.com/profile_images/1615998188144070657/m1XU7Kk-_400x400.jpg', this)">
                <img src="https://static.startuptalky.com/2021/11/palmpay-success-story-startuptalky.jpg" class="bank-logo">
                <div class="bank-name">PalmPay</div>
            </div>
            <div class="bank-card" onclick="app.selectBank('UBA Bank', '', this)">
                <div class="bank-logo" style="background: #d32f2f; color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px;">UBA</div>
                <div class="bank-name">UBA Bank</div>
            </div>
            <div class="bank-card" onclick="app.selectBank('First Bank', '', this)">
                <div class="bank-logo" style="background: #003366; color: #ffd700; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px;">FBN</div>
                <div class="bank-name">First Bank</div>
            </div>
            <div class="bank-card" onclick="app.selectBank('US Global Transfer', '', this)" style="grid-column: span 2;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <i class="fa-solid fa-earth-americas" style="font-size: 24px; color: #5865F2;"></i>
                    <div class="bank-name">US Online Bank (Swift/Routing)</div>
                </div>
            </div>
        </div>

        <div id="bank-form-area" style="display: none;">
            <div class="withdraw-form-group">
                <label class="payout-label">Account Details</label>
                <input type="number" id="bank-acc-number" placeholder="Account Number" class="input-box" style="background: #0f171e; border-color: #232e3c; color: white; width: 100%;">
                <input type="text" id="bank-acc-name" placeholder="Account Holder Name" class="input-box" style="background: #0f171e; border-color: #232e3c; color: white; width: 100%;">
                
                <div id="us-bank-fields" style="display: none;">
                    <input type="text" id="bank-routing" placeholder="Routing Number (ABA)" class="input-box" style="background: #0f171e; border-color: #232e3c; color: white; width: 100%;">
                </div>

                <div style="background: rgba(0,255,136,0.05); padding: 15px; border-radius: 12px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #8696a0;">
                        <span>Processing Fee:</span>
                        <span>$1.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
                        <span>You will receive:</span>
                        <span style="color: #00ff88;">$<span id="net-payout-display">0.00</span></span>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="app.submitBankWithdrawal()" style="width: 100%; border-radius: 12px; background: #00a884; margin-top: 20px;">Confirm Cashout</button>
            </div>
        </div>
    </div>
</div>


<div id="live-selection-page" class="page full-screen" style="background: linear-gradient(180deg, #1a1a1a 0%, #000 100%); z-index: 300;">
    <div style="padding: 40px 20px;">
        <i class="fa-solid fa-chevron-left" style="color: white; font-size: 22px; cursor: pointer;" onclick="app.goToPage('home-page')"></i>
        
        <div style="text-align: center; margin-top: 40px;">
            <h1 style="color: white; font-size: 28px; font-weight: 800; letter-spacing: -1px;">Start your session</h1>
            <p style="color: #888; font-size: 14px; margin-top: 10px;">Choose how you want to connect with your audience</p>
        </div>

        <div style="margin-top: 40px; display: flex; flex-direction: column; gap: 15px;">
            
            <div onclick="app.startLive('battle')" style="background: rgba(255,255,255,0.08); border: 2px solid #ffd700; border-radius: 24px; padding: 25px; display: flex; align-items: center; gap: 20px; cursor: pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f1c40f, #e67e22); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                    <i class="fa-solid fa-hand-fist"></i>
                </div>
                <div style="flex: 1;">
                    <div style="color: #ffd700; font-weight: 800; font-size: 18px;">The Arena (Battle)</div>
                    <div style="color: #bbb; font-size: 13px; margin-top: 4px;">1v1 Avatar combat. Win through gifts!</div>
                </div>
                <i class="fa-solid fa-bolt" style="color: #ffd700; animation: pulse 1s infinite;"></i>
            </div>

            <div onclick="app.startLive('streaming')" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; display: flex; align-items: center; gap: 20px; cursor: pointer;">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #ff4b7d, #ff7675); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                    <i class="fa-solid fa-camera"></i>
                </div>
                <div style="flex: 1;">
                    <div style="color: white; font-weight: 700; font-size: 18px;">Device Camera</div>
                    <div style="color: #777; font-size: 13px; margin-top: 4px;">Standard video live stream</div>
                </div>
            </div>

            <div onclick="app.startLive('gaming')" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; display: flex; align-items: center; gap: 20px; cursor: pointer;">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #6c5ce7, #a29bfe); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                    <i class="fa-solid fa-gamepad"></i>
                </div>
                <div style="flex: 1;">
                    <div style="color: white; font-weight: 700; font-size: 18px;">Mobile Gaming</div>
                    <div style="color: #777; font-size: 13px; margin-top: 4px;">Share your screen & play games</div>
                </div>
            </div>

        </div>
    </div>
</div>


<div id="live-broadcast-page" class="page full-screen" style="background: #000; z-index: 310;">
    
    <div id="video-canvas-container" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;">
        <video id="live-video-element" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 1;"></video>
        
        <iframe id="youtube-player" style="width: 100%; height: 100%; border: none; display: none; position: absolute; z-index: 2;" allow="autoplay; encrypted-media"></iframe>
    </div>
    
    <div id="live-tap-area" style="position: absolute; top: 0; left: 0; width: 100%; height: 80%; z-index: 10;" ondblclick="app.sendLiveHeart(event)"></div>

    <div id="cohost-container" style="display: none; position: absolute; bottom: 100px; right: 15px; width: 110px; height: 160px; background: #222; border: 2px solid white; border-radius: 12px; overflow: hidden; z-index: 50; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        <video id="cohost-video-element" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
        <div onclick="app.exitCoHost()" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;">
            <i class="fa-solid fa-xmark"></i>
        </div>
    </div>

    <div style="position: absolute; top: 45px; left: 15px; right: 15px; display: flex; align-items: flex-start; justify-content: space-between; z-index: 100;">
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="display: flex; align-items: center; background: rgba(0,0,0,0.4); padding: 4px; border-radius: 30px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15); width: fit-content;">
                <img id="live-host-avatar" src="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                <div style="padding: 0 10px;">
                    <div style="color: white; font-size: 11px; font-weight: 800; max-width: 75px; overflow: hidden; text-overflow: ellipsis; line-height: 1.1;" id="live-host-name">Host</div>
                    <div style="color: #00ff88; font-size: 9px; font-weight: 900; letter-spacing: 0.5px;">LIVE</div>
                </div>
                <button id="live-follow-btn" style="background: #ff4b7d; border: none; color: white; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 800;">Follow</button>
            </div>

            <div id="host-exclusive-controls" style="display: none; flex-direction: column; gap: 15px; align-items: center; width: 45px;">
                <div onclick="app.openShareContactPicker()" class="action-btn-circle"><i class="fa-solid fa-share"></i></div>
                <div onclick="app.openViewerInviteList()" class="action-btn-circle"><i class="fa-solid fa-plus"></i></div>
                <div onclick="app.toggleOpenJoin()" class="action-btn-circle"><i class="fa-solid fa-user-group"></i></div>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="stat-pill"><i class="fa-solid fa-eye" style="color: #ff4b7d;"></i> <span id="live-viewer-count">0</span></div>
                <div class="stat-pill"><i class="fa-solid fa-heart" style="color: #ff4b7d;"></i> <span id="live-like-count">0</span></div>
            </div>
            <button id="live-end-btn" style="display: none; background: #ff4757; border: none; color: white; padding: 10px 20px; border-radius: 25px; font-size: 12px; font-weight: 800; cursor: pointer;" onclick="app.endLiveSession()">END LIVE</button>
        </div>
    </div>

    <div id="live-comments-container" style="position: absolute; bottom: 85px; left: 15px; width: 75%; max-height: 180px; overflow-y: hidden; display: flex; flex-direction: column; gap: 6px; z-index: 100; mask-image: linear-gradient(transparent, black 30%);"></div>

    <div style="position: absolute; bottom: 20px; left: 0; width: 100%; padding: 0 15px; z-index: 100;">
        <div style="background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); border-radius: 30px; display: flex; align-items: center; padding: 4px; backdrop-filter: blur(20px);">
            <div onclick="app.openGiftPage()" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: #ffd700; font-size: 22px; cursor: pointer;"><i class="fa-solid fa-gift"></i></div>
            <input type="text" id="live-comment-input" placeholder="Add comment..." style="flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 14px; height: 40px; padding-left: 10px;">
            <div onclick="app.sendLiveComment()" style="width: 38px; height: 38px; background: #ff4b7d; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer;"><i class="fa-solid fa-paper-plane" style="font-size: 14px;"></i></div>
        </div>
    </div>
</div>

<div id="viewer-invite-modal" class="modal-overlay" style="display:none;" onclick="this.style.display='none'">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: #1c1c1e; color: white;">
        <div class="modal-handle"></div>
        <h3 style="text-align: center; margin-bottom: 20px; font-size: 16px;">Invite Viewers to Co-Host</h3>
        <div id="active-viewer-list" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
</div>

<div id="cohost-invite-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; z-index: 5000;">
    <div style="background: #1c1c1e; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px; text-align: center; color: white; border: 1px solid #333;">
        <div style="width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 24px;"><i class="fa-solid fa-video"></i></div>
        <h3 id="invite-host-name">Host Name</h3>
        <p style="font-size: 13px; color: #888; margin-bottom: 25px;">Has invited you to join their live stream as a co-host.</p>
        <div style="display: flex; gap: 10px;">
            <button onclick="app.declineCoHostInvite()" style="flex: 1; background: #333; border: none; color: white; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer;">Decline</button>
            <button onclick="app.acceptCoHostInvite()" style="flex: 1; background: var(--primary); border: none; color: white; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer;">Accept</button>
        </div>
    </div>
</div>
<div id="arena-broadcast-page" class="page full-screen" style="background: #0b0e11; z-index: 315; display: none; overflow: hidden;">
    <audio id="arena-remote-audio" autoplay playsinline style="display:none;"></audio>
    
    <div style="position: absolute; top: 45px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 110;">
        <div style="display: flex; gap: 8px;">
            <div class="stat-pill"><i class="fa-solid fa-eye" style="color: #ff4b7d;"></i> <span id="arena-viewer-count">0</span></div>
            
            <div id="arena-mic-control" class="stat-pill" style="display: none; cursor: pointer; background: rgba(255,255,255,0.2);" onclick="app.toggleArenaMic()">
                <i id="arena-mic-icon" class="fa-solid fa-microphone"></i>
            </div>

            <div id="arena-host-tools" style="display: none; gap: 8px;">
                <div class="stat-pill" style="cursor: pointer; background: #f1c40f; color: black;" onclick="app.openViewerInviteList()">
                    <i class="fa-solid fa-user-plus"></i>
                </div>
                <div class="stat-pill" style="cursor: pointer; background: rgba(255,255,255,0.15);" onclick="app.openBattleSettings()">
                    <i class="fa-solid fa-gear"></i>
                </div>
            </div>
        </div>
        <button id="arena-end-btn" style="background: #ff4757; border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: 800; display: none;" onclick="app.endLiveSession()">END BATTLE</button>
    </div>

    <div class="arena-header" id="arena-scoreboard" style="opacity: 0; transition: 0.5s;">
        <div class="battle-timer" id="arena-timer-display">05:00</div>
        <div class="tug-of-war-container">
            <div id="p1-power-bar" class="power-fill p1" style="width: 50%;"><span class="score-label" id="p1-score-val">0</span></div>
            <div id="p2-power-bar" class="power-fill p2" style="width: 50%;"><span class="score-label" id="p2-score-val">0</span></div>
            <div class="vs-badge">VS</div>
        </div>
    </div>

    <div class="arena-stage">
        <div class="fighter host-side">
            <div id="host-pulse" class="fighter-aura" style="border-color: #ff4b7d; display: none;"></div>
            <img id="arena-host-img" src="" class="fighter-img" style="border: 3px solid #ff4b7d; background: #222;">
            <div class="fighter-tag">HOST</div>
        </div>

        <div class="fighter opponent-side" id="p2-fighter-area" style="opacity: 0.4;">
            <div id="opp-pulse" class="fighter-aura" style="border-color: #6c5ce7; display: none;"></div>
            <img id="arena-opponent-img" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="fighter-img" style="filter: grayscale(1);">
            <div class="fighter-tag" id="p2-status-label">WAITING...</div>
            <button id="follow-p2" class="arena-follow-btn" style="display:none;" onclick="app.likeUser(state.currentOpponentId)">Follow</button>
        </div>
    </div>

    <div class="arena-footer">
        <div id="arena-comments-container" style="height: 120px; overflow-y: hidden; margin-bottom: 15px; mask-image: linear-gradient(transparent, black 20%);"></div>
        <div class="arena-actions">
            <div onclick="app.openGiftPage()" class="arena-gift-btn"><i class="fa-solid fa-gift"></i></div>
            <input type="text" id="arena-comment-input" placeholder="Support your side..." class="arena-chat-input">
            <div onclick="app.sendArenaComment()" class="arena-send-btn"><i class="fa-solid fa-paper-plane"></i></div>
        </div>
    </div>
</div>
<div id="battle-invite-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: #1c1c1e; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px; text-align: center; color: white; border: 1px solid #ffd700; box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);">
        <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #f1c40f, #e67e22); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px; color: white; border: 3px solid white;">
            <i class="fa-solid fa-hand-fist"></i>
        </div>
        <h3 style="color: #ffd700; font-size: 20px; margin-bottom: 5px;" id="battle-challenger-name">Host Name</h3>
        <p style="font-size: 14px; color: #bbb; margin-bottom: 25px;">Has challenged you to a 1v1 Arena Battle! Win through gifts!</p>
        <div style="display: flex; gap: 12px;">
            <button onclick="document.getElementById('battle-invite-modal').style.display='none'" style="flex: 1; background: #333; border: none; color: white; padding: 14px; border-radius: 15px; font-weight: bold; cursor: pointer;">IGNORE</button>
            <button id="battle-confirm-btn" style="flex: 1; background: #f1c40f; border: none; color: black; padding: 14px; border-radius: 15px; font-weight: bold; cursor: pointer;">ACCEPT</button>
        </div>
    </div>
</div>
<div id="movie-comment-drawer" class="comment-drawer">
    <div class="comment-header">
        <span id="comment-count-title">0 Comments</span>
        <i class="fa-solid fa-xmark close-comment" onclick="app.closeComments()"></i>
    </div>

    <div class="comment-list" id="movie-comment-list"></div>

    <div id="mention-popover"></div>
    <div id="gift-drawer-mini"></div>

    <div id="comment-img-preview-bar">
        <img id="comment-preview-target" src="" style="width:40px; height:40px; border-radius:5px; object-fit:cover;">
        <span style="font-size:12px; color:gray; flex:1;">Sticker attached...</span>
        <i class="fa-solid fa-circle-xmark" style="color:#ff4b7d; cursor:pointer;" onclick="app.cancelCommentImage()"></i>
    </div>

    <div class="comment-input-area">
        <i id="comment-gift-btn" class="fa-solid fa-gift" style="color: #ffd700; font-size: 20px; cursor: pointer;" onclick="app.toggleGiftDrawer()"></i>
        <i class="fa-regular fa-image" style="color: #888; font-size: 20px;" onclick="document.getElementById('comment-img-input').click()"></i>
        <input type="file" id="comment-img-input" hidden accept="image/*" onchange="app.handleCommentImage(this)">
        
        <input type="text" id="movie-comment-input" placeholder="Add a comment..." 
               style="flex:1; border:none; background:#f0f2f5; padding:10px 15px; border-radius:20px; outline:none;"
               oninput="app.handleCommentInput(this)" onkeypress="if(event.key === 'Enter') app.postComment()">
        
        <i class="fa-solid fa-paper-plane" style="color:var(--primary); font-size: 20px;" onclick="app.postComment()"></i>
    </div>
</div>
<div id="download-outro-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center;">
    </div>

<div id="post-management-menu" class="post-menu-drawer">
    <div style="width: 40px; height: 5px; background: #333; border-radius: 10px; margin: 0 auto 20px;"></div>
    
    <div class="menu-option" onclick="app.downloadVideo()">
        <i class="fa-solid fa-download"></i> Save Video
    </div>
    
    <div class="menu-option" onclick="app.hidePost()">
        <i class="fa-solid fa-eye-slash"></i> Hide Post
    </div>
    
    <div id="delete-post-btn" class="menu-option" style="color: #ff4757; display: none;" onclick="app.deletePost()">
        <i class="fa-solid fa-trash"></i> Delete Post
    </div>
</div>

<div id="status-viewer-menu" class="chat-menu" style="top: 60px; right: 10px;">
        <div class="menu-item" onclick="App.handleStatusMenuAction('message')">Message</div>
        <div class="menu-item" onclick="App.handleStatusMenuAction('voice')">Voice call</div>
        <div class="menu-item" onclick="App.handleStatusMenuAction('video')">Video call</div>
        <div class="menu-item" onclick="App.handleStatusMenuAction('info')">View contact</div>
        <div class="menu-item" onclick="App.handleStatusMenuAction('hide')">Hide</div>
        <div class="menu-item" onclick="App.handleStatusMenuAction('report')" style="color: #ff4757;">Report</div>
</div>

<div id="status-report-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; z-index: 3000;">
        <div style="background: white; width: 85%; max-width: 320px; border-radius: 20px; overflow: hidden; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <div style="text-align: center; margin-bottom: 15px;">
                        <i class="fa-regular fa-thumbs-down" style="font-size: 30px; color: #54656f;"></i>
                </div>
                <h3 style="font-size: 20px; color: #111; margin-bottom: 12px; text-align: center;">Report to Global Connect</h3>
                <p style="font-size: 14px; color: #667781; line-height: 1.5; margin-bottom: 20px;">
                        This status will be sent to Global Connect. This person won't know you reported or blocked them. <span style="color: #00a884;">Learn more</span>
                </p>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; margin-bottom: 25px;">
                        <input type="checkbox" id="report-block-user" style="width: 18px; height: 18px; accent-color: #00a884; margin-top: 3px;">
                        <div>
                                <div style="font-size: 15px; color: #111; font-weight: 500;">Block User</div>
                                <div style="font-size: 12px; color: #667781;">This person won't be able to message or call you.</div>
                        </div>
                </label>
                
                <div style="display: flex; justify-content: flex-end; gap: 20px; font-weight: 600; font-size: 14px;">
                        <span onclick="document.getElementById('status-report-modal').style.display='none'; App.startStatusTimer(true);" style="color: #00a884; cursor: pointer;">Cancel</span>
                        <span onclick="App.submitStatusReport()" style="color: #00a884; cursor: pointer;">Report</span>
                </div>
        </div>
</div>
<div id="user-block-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; z-index: 4000;">
        <div style="background: white; width: 85%; max-width: 320px; border-radius: 28px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="text-align: center; margin-bottom: 15px;">
                        <i class="fa-solid fa-ban" style="font-size: 30px; color: #54656f;"></i>
                </div>
                <h3 id="block-modal-title" style="font-size: 20px; color: #111; margin-bottom: 12px; text-align: center;">Block User?</h3>
                <p style="font-size: 14px; color: #667781; line-height: 1.5; margin-bottom: 20px; text-align: center;">
                        This person won't be able to message or call you. They won't know you blocked or reported them.
                </p>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; margin-bottom: 25px; padding: 10px; background: #f8f9fa; border-radius: 12px;">
                        <input type="checkbox" id="block-report-check" style="width: 18px; height: 18px; accent-color: #00a884; margin-top: 3px;">
                        <div>
                                <div style="font-size: 14px; color: #111; font-weight: 600;">Report to Global Connect</div>
                                <div style="font-size: 12px; color: #667781;">The last 5 messages will be forwarded.</div>
                        </div>
                </label>
                
                <div style="display: flex; justify-content: flex-end; gap: 24px; font-weight: 600; font-size: 14px;">
                        <span onclick="App.closeBlockModal()" style="color: #00a884; cursor: pointer;">Cancel</span>
                        <span onclick="App.executeUserBlock()" style="color: #00a884; cursor: pointer;">Block</span>
                </div>
        </div>
</div>
<div id="modal-status-viewers" class="modal-overlay" onclick="app.closeModal('modal-status-viewers')">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: white; border-radius: 20px 20px 0 0;">
        <div class="modal-handle" style="background: #ddd;"></div>
        <div style="padding: 0 20px 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 18px; color: #111;">Viewed by</h3>
            <span id="viewer-count-total" style="font-size: 14px; color: #8696a0;">0</span>
        </div>
        <div id="status-viewers-list" style="max-height: 400px; overflow-y: auto; padding: 10px 0;"></div>
    </div>
</div>
<div id="boost-wizard-page" class="page full-screen">
    <div class="top-nav">
       <i class="fa-solid fa-xmark" onclick="app.exitBoostWizard()" style="font-size: 22px; cursor: pointer;"></i>
        <div style="font-weight: bold;">Boost Status</div>
        <div id="boost-step-indicator" style="font-size: 13px; color: gray;">Step 1/9</div>
    </div>

    <div id="boost-content-area" style="flex: 1; overflow-y: auto; padding-bottom: 100px;">
        </div>

    <div class="boost-footer">
        <button class="btn" style="background: #eee; color: #333; width: 30%;" onclick="app.prevBoostStep()">Back</button>
        <button id="boost-next-btn" class="btn btn-primary" style="width: 70%;" onclick="app.nextBoostStep()">Continue</button>
    </div>
</div>
<div id="account-options-page" class="page full-screen" style="background: #f0f2f5;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #eee;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('settings-page')" style="color: #54656f; cursor: pointer; padding: 5px;"></i>
        <div style="font-weight: bold; margin-left: 15px; font-size: 18px; color: #111;">Account</div>
    </div>

    <div class="settings-list" style="margin-top: 10px;">
        <div class="settings-item" onclick="app.openMyAccountDetail()">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-user-gear" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>My Account</span>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>

        <div class="settings-item" onclick="app.openMultiAccountPicker()">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-user-plus" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>Add Account</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <small style="color: #00a884; font-weight: bold;">New</small>
                <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
            </div>
        </div>

        <div class="settings-item" onclick="app.openDevicesPage()">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fa-solid fa-laptop-mobile" style="color: #54656f; width: 25px; text-align: center;"></i>
                <span>Devices</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <small style="color: #00a884; font-weight: bold;">Secure</small>
                <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
            </div>
        </div>
    </div>

    <div style="padding: 20px; color: #8696a0; font-size: 13px; line-height: 1.5;">
        Manage your security settings and logged-in sessions to keep your Global Connect account safe.
    </div>
</div>


<div id="my-account-page" class="page full-screen" style="background: white;">
    <div class="top-nav">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('account-options-page')"></i>
        <div style="font-weight: bold; margin-left: 15px;">My Account</div>
    </div>
    <div style="padding: 20px;">
        <label style="font-size: 12px; color: var(--primary); font-weight: bold; text-transform: uppercase;">Current Email</label>
        <div id="acc-display-email" style="font-size: 18px; padding: 15px 0; border-bottom: 1px solid #eee; margin-bottom: 30px; color: #111;">loading...</div>
        
        <button class="btn btn-primary" onclick="app.initSecurityChange('email')">Change Email Address</button>
        <button class="btn" style="background: #eee; color: #333;" onclick="app.initSecurityChange('password')">Change Password</button>
    </div>
</div>

<div id="account-security-otp-page" class="page full-screen" style="background: #000; color: white;">
    <div style="padding: 60px 30px; text-align: center;">
        <div style="width: 60px; height: 60px; border: 2px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;">
            <i class="fa-solid fa-shield-halved" style="color: var(--primary); font-size: 24px;"></i>
        </div>
        <h2 style="font-weight: 300; letter-spacing: 1px;">Security Check</h2>
        <p style="color: #888; font-size: 14px; margin-top: 15px;">To protect your account, enter the code sent to your current email.</p>
        
        <input type="number" id="acc-otp-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" 
               oninput="if(this.value.length === 6) app.verifyAccountOTP()"
               style="background: transparent; border: none; border-bottom: 2px solid #333; color: white; width: 100%; text-align: center; font-size: 40px; letter-spacing: 10px; margin: 50px 0; outline: none;">
        
        <div style="color: #555; font-size: 12px; cursor: pointer;" onclick="app.resendAccountOTP()">Didn't get a code? <span style="color: var(--primary);">Resend</span></div>
        <div style="margin-top: 100px; color: #444; font-size: 13px; cursor: pointer;" onclick="app.goToPage('my-account-page')">Cancel</div>
    </div>
</div>

<div id="account-update-input-page" class="page full-screen" style="background: #f8f9fa;">
    <div class="top-nav" style="background: white;">
        <i class="fa-solid fa-xmark nav-item" onclick="app.goToPage('my-account-page')"></i>
        <div id="update-page-title" style="font-weight: bold; margin-left: 15px;">Update Email</div>
    </div>
    <div style="padding: 30px 20px;">
        <p id="update-page-desc" style="font-size: 14px; color: #666; margin-bottom: 20px;">Enter your new email address below.</p>
        <input type="text" id="acc-new-value-input" class="input-box" style="background: white; border: 1px solid #ddd; border-radius: 10px;">
        <button class="btn btn-primary" id="acc-update-final-btn">Save Changes</button>
    </div>
</div>
<div id="devices-management-page" class="page full-screen" style="background: #f0f2f5;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #ddd;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('account-options-page')" style="color: #54656f;"></i>
        <div style="font-weight: bold; margin-left: 15px; color: #111;">Where you're logged in</div>
    </div>

    <div style="padding: 20px;">
        <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 13px; font-weight: bold; color: #666;">ACTIVE SESSIONS</div>
            <div id="device-list-container">
                </div>
        </div>
        
        <p style="margin-top: 20px; font-size: 12px; color: #888; padding: 0 10px; line-height: 1.5;">
            If you see a device you don't recognize, tap it to log out and secure your account by changing your password.
        </p>
    </div>
</div>

<div id="modal-device-logout" class="modal-overlay" onclick="app.closeModal('modal-device-logout')">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: white; border-radius: 20px 20px 0 0;">
        <div class="modal-handle" style="background: #ddd;"></div>
        <div style="text-align: center; padding: 10px 20px 30px;">
            <div id="logout-device-icon" style="font-size: 40px; margin-bottom: 15px; color: #54656f;"></div>
            <h3 id="logout-device-name" style="margin-bottom: 5px; color: #111;">Device Name</h3>
            <p id="logout-device-meta" style="color: #667781; font-size: 14px; margin-bottom: 25px;">Logged in: Date/Time</p>
            
            <button class="btn btn-danger" id="confirm-device-logout-btn" style="border-radius: 10px;">Log Out Device</button>
            <div style="margin-top: 15px; color: #008069; font-weight: bold; cursor: pointer;" onclick="app.closeModal('modal-device-logout')">Cancel</div>
        </div>
    </div>
</div>
<div id="multi-account-page" class="page full-screen" style="background: #f0f2f5; z-index: 1000;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #ddd;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('account-options-page')" style="color: #54656f; cursor: pointer;"></i>
        <div style="font-weight: bold; margin-left: 15px; color: #111;">Switch Account</div>
    </div>

    <div style="padding: 20px;">
        <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div id="linked-accounts-list">
                </div>
            
            <div id="add-account-row" class="list-item" style="padding: 15px; border-top: 1px solid #f0f0f0;" onclick="app.startNewAccountAuth()">
                <div style="width: 45px; height: 45px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: #008069;">
                    <i class="fa-solid fa-plus" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #008069;">Add account</div>
                </div>
            </div>
        </div>
        
        <p style="margin-top: 20px; font-size: 13px; color: #667781; padding: 0 10px; line-height: 1.5;">
            You can add one more account. Switching between them happens instantly without re-entering your password.
        </p>
    </div>
</div>
<div id="full-notifications-settings-page" class="page full-screen" style="background: #0b141a; color: #e9edef; z-index: 1000;">
    <div class="top-nav" style="background: #1f2c34; border-bottom: 1px solid #2a3942;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('settings-page')" style="color: #aebac1; cursor: pointer;"></i>
        <div style="font-weight: bold; margin-left: 15px; font-size: 19px;">Notifications</div>
    </div>

    <div style="overflow-y: auto; flex: 1; padding-bottom: 40px;">
        <div style="padding: 25px 20px 10px; color: #00a884; font-size: 13px; font-weight: bold; text-transform: uppercase;">Messages</div>
        
        <div class="settings-item" onclick="app.triggerSystemTonePicker('msg')" style="padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #1f2c34; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex:1;">
                <div style="font-size: 16px;">Notification tone</div>
                <div id="disp-msg-tone-label" style="font-size: 14px; color: #8696a0;">Default (Gentle)</div>
            </div>
        </div>

        <div style="padding: 25px 20px 10px; color: #00a884; font-size: 13px; font-weight: bold; text-transform: uppercase;">Groups</div>
        
        <div class="settings-item" onclick="app.triggerSystemTonePicker('group')" style="padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #1f2c34; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex:1;">
                <div style="font-size: 16px;">Notification tone</div>
                <div id="disp-group-tone-label" style="font-size: 14px; color: #8696a0;">Default (Gentle)</div>
            </div>
        </div>

        <div style="padding: 25px 20px 10px; color: #00a884; font-size: 13px; font-weight: bold; text-transform: uppercase;">Calls</div>
        
        <div class="settings-item" onclick="app.triggerSystemTonePicker('call')" style="padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #1f2c34; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex:1;">
                <div style="font-size: 16px;">Ringtone</div>
                <div id="disp-call-tone-label" style="font-size: 14px; color: #8696a0;">Default (Global Connect)</div>
            </div>
        </div>
    </div>

    <input type="file" id="hidden-tone-input" accept="audio/*" style="display: none;" onchange="app.processSelectedSystemTone(this)">
</div>
<div id="status-privacy-page" class="page full-screen" style="background: #f0f2f5;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #eee;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('privacy-settings-page')"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 15px;">Status privacy</div>
    </div>

    <div class="privacy-desc">Who can see my status updates</div>

    <div style="background: white; border-top: 1px solid #eee; border-bottom: 1px solid #eee;">
        <div class="list-item" onclick="app.setStatusPrivacy('all')" style="border-bottom: 1px solid #f0f0f0;">
            <div style="flex: 1;">
                <div style="font-size: 16px; color: #111;">My contacts</div>
            </div>
            <i id="status-check-all" class="fa-solid fa-check check-mark-green hidden"></i>
        </div>

        <div class="list-item" onclick="app.openStatusExclusionPicker()">
            <div style="flex: 1;">
                <div style="font-size: 16px; color: #111;">My contacts except...</div>
                <div id="status-exclude-count" style="font-size: 13px; color: #667781;">None excluded</div>
            </div>
            <i id="status-check-except" class="fa-solid fa-check check-mark-green hidden"></i>
        </div>
    </div>

    <div class="privacy-desc">
        Changes to your privacy settings won't affect status updates that you've sent already.
    </div>
</div>

<div id="status-exclusion-picker" class="page full-screen" style="background: white;">
    <div class="top-nav" style="background: #ff4757; color: white;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" onclick="app.goToPage('status-privacy-page')"></i>
            <div>
                <div style="font-weight: bold; font-size: 18px;">Hide status from...</div>
                <div id="exclusion-count-label" style="font-size: 12px; opacity: 0.9;">0 contacts selected</div>
            </div>
        </div>
    </div>

    <div id="exclusion-list-container" style="flex: 1; overflow-y: auto;">
        </div>

    <div onclick="app.saveStatusExclusions()" style="position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #ff4757; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;">
        <i class="fa-solid fa-check"></i>
    </div>
</div>
<div id="storage-data-page" class="page full-screen" style="background: #f0f2f5;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #eee;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('settings-page')" style="color: #54656f;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 15px;">Storage and data</div>
    </div>
    <div style="flex: 1; overflow-y: auto;">
        <div class="list-item" onclick="app.openManageStorage()" style="background: white; margin-top: 10px;">
            <i class="fa-regular fa-folder-open" style="width: 30px; color: #54656f; font-size: 18px;"></i>
            <div style="flex: 1;">
                <div style="font-size: 16px;">Manage storage</div>
                <div id="storage-summary-mb" style="font-size: 13px; color: #667781;">Calculating...</div>
            </div>
        </div>

        <div class="settings-category">Media auto-download</div>
        <div style="background: white; border-top: 1px solid #eee;">
            <div class="list-item" onclick="app.openAutoDownloadDialog('mobile')">
                <div style="flex: 1;">
                    <div>When using mobile data</div>
                    <div id="label-auto-mobile" style="font-size: 13px; color: #667781;">No media</div>
                </div>
            </div>
            <div class="list-item" onclick="app.openAutoDownloadDialog('wifi')">
                <div style="flex: 1;">
                    <div>When connected on Wi-Fi</div>
                    <div id="label-auto-wifi" style="font-size: 13px; color: #667781;">All media</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="manage-storage-page" class="page full-screen" style="background: var(--bg-main);">
    <div class="top-nav" style="border-bottom: 1px solid var(--divider); background: var(--bg-secondary);">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('storage-data-page')" style="color: var(--text-secondary);"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 15px; color: var(--text-primary);">Manage storage</div>
    </div>
    
    <div style="flex: 1; overflow-y: auto;">
        <div class="storage-usage-card" style="padding: 20px; border-bottom: 8px solid var(--bg-secondary);">
            <div style="display: flex; align-items: baseline; gap: 5px;">
                <h2 id="total-app-mb" style="margin:0; color: var(--text-primary);">0</h2>
                <span style="color: var(--text-secondary);">MB Used</span>
            </div>
            <div class="usage-bar" style="height: 8px; background: var(--divider); border-radius: 4px; margin: 15px 0; overflow: hidden; display: flex;">
                <div id="app-bar-fill" style="width: 10%; background: #00a884;"></div>
                <div style="width: 40%; background: #34b7f1;"></div>
            </div>
            <div style="display: flex; gap: 20px; font-size: 12px; color: var(--text-secondary);">
                <span><i class="fa-solid fa-circle" style="font-size: 8px; color: #00a884;"></i> Global Connect</span>
                <span><i class="fa-solid fa-circle" style="font-size: 8px; color: #34b7f1;"></i> Other apps</span>
            </div>
        </div>

        <div class="settings-category" style="padding: 15px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">Chats</div>
        
        <div id="chat-usage-list"></div>
    </div>
</div>


<div id="media-dialog-overlay" class="app-dialog-overlay" onclick="app.closeMediaDialog()">
    <div class="app-dialog" onclick="event.stopPropagation()">
        <div class="dialog-title" id="media-dialog-title">When using mobile data</div>
        <div id="dialog-options">
            <div class="check-row" onclick="app.toggleDialogCheck('photos')">
                <div class="check-box-ui"></div><span>Photos</span>
            </div>
            <div class="check-row" onclick="app.toggleDialogCheck('audio')">
                <div class="check-box-ui"></div><span>Audio</span>
            </div>
            <div class="check-row" onclick="app.toggleDialogCheck('videos')">
                <div class="check-box-ui"></div><span>Videos</span>
            </div>
            <div class="check-row" onclick="app.toggleDialogCheck('docs')">
                <div class="check-box-ui"></div><span>Documents</span>
            </div>
        </div>
        <div class="dialog-btns">
            <span onclick="app.closeMediaDialog()">Cancel</span>
            <span onclick="app.saveMediaDialog()">OK</span>
        </div>
    </div>
</div>
<div id="bot-management-page" class="page full-screen" style="background: #f0f2f5;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #eee;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.openGroupInfo()" style="color: #54656f;"></i>
        <div style="font-weight: 500; font-size: 19px; margin-left: 15px;">Bot Settings</div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding-bottom: 30px;">
        <div class="bot-setup-card">
            <label style="font-size: 12px; color: #008069; font-weight: bold;">BOT AUTH TOKEN</label>
            <input type="text" id="group-bot-token" placeholder="Paste Bot Token here..." 
                   style="width: 100%; border: none; border-bottom: 2px solid #eee; padding: 10px 0; outline: none; margin-top: 5px; font-family: monospace;">
            <p style="font-size: 11px; color: #8696a0; margin-top: 8px;">Bot must be an Admin to execute commands.</p>
        </div>

        <div class="settings-category">Active Commands</div>
        
        <div class="bot-setup-card" style="padding: 0 20px;">
            <div class="command-item" onclick="app.toggleBotCommand('tagall')">
                <div class="command-info">
                    <div class="command-title">Tag All Members</div>
                    <div class="command-desc">Command: .tagall</div>
                </div>
                <div class="select-checkbox" id="check-bot-tagall"></div>
            </div>

            <div class="command-item" onclick="app.goToPage('bot-welcome-setup')">
                <div class="command-info">
                    <div class="command-title">Welcome System</div>
                    <div class="command-desc">Sends image & tag when user joins</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
            </div>

            <div class="command-item" onclick="app.toggleBotCommand('lock')">
                <div class="command-info">
                    <div class="command-title">Group Lock</div>
                    <div class="command-desc">Command: .lock group / .unlock</div>
                </div>
                <div class="select-checkbox" id="check-bot-lock"></div>
            </div>

            <div class="command-item" onclick="app.toggleBotCommand('pp')">
                <div class="command-info">
                    <div class="command-title">Change Group Pic</div>
                    <div class="command-desc">Command: .changepp (reply to image)</div>
                </div>
                <div class="select-checkbox" id="check-bot-pp"></div>
            </div>

            <div class="command-item" onclick="app.toggleBotCommand('kick')">
                <div class="command-info">
                    <div class="command-title">Remove Members</div>
                    <div class="command-desc">Command: .remove (reply to user)</div>
                </div>
                <div class="select-checkbox" id="check-bot-kick"></div>
            </div>

            <div class="command-item" onclick="app.goToPage('bot-filter-setup')">
                <div class="command-info">
                    <div class="command-title">Bad Words Filter</div>
                    <div class="command-desc">Auto-kick users sending bad words</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
            </div>

            <div class="command-item" onclick="app.toggleBotCommand('antilink')">
                <div class="command-info">
                    <div class="command-title">Anti-Link Protection</div>
                    <div class="command-desc">Delete & warn users sending links</div>
                </div>
                <div class="select-checkbox" id="check-bot-antilink"></div>
            </div>
        </div>

        <div style="padding: 0 20px 20px;">
            <button class="btn" 
                    style="background: #e8f5e9; color: #008069; border: 1px solid #008069; margin-bottom: 0;" 
                    onclick="app.testGroupBot()">
                <i class="fa-solid fa-vial-circle-check" style="margin-right: 8px;"></i> Test Bot Connection
            </button>
        </div>

        <button class="btn btn-primary" onclick="app.saveGroupBotConfig()">Save Bot Config</button>
    </div>
</div>


<div id="bot-welcome-setup" class="page full-screen" style="background: white;">
    <div class="top-nav">
        <i class="fa-solid fa-xmark nav-item" onclick="app.goToPage('bot-management-page')"></i>
        <div style="font-weight: bold;">Set Welcome Message</div>
    </div>
    <div style="padding: 20px; text-align: center;">
        <div style="width: 100%; aspect-ratio: 16/9; background: #f0f2f5; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed #ccc; margin-bottom: 20px;" onclick="document.getElementById('welcome-img-input').click()">
            <img id="welcome-preview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
            <div id="welcome-placeholder"><i class="fa-solid fa-image" style="font-size: 30px; color: #8696a0;"></i><br>Upload Picture</div>
        </div>
        <input type="file" id="welcome-img-input" hidden accept="image/*" onchange="app.handleWelcomeImage(this)">
        
        <textarea id="welcome-msg-input" class="input-box" rows="4" placeholder="Hello @user, welcome to our group!"></textarea>
        <button class="btn btn-primary" onclick="app.goToPage('bot-management-page')">Done</button>
    </div>
</div>

<div id="bot-filter-setup" class="page full-screen" style="background: #f0f2f5;">
    <div class="top-nav"><i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('bot-management-page')"></i><div>Bad Words</div></div>
    <div style="padding: 20px;">
        <p style="font-size: 13px; color: #667781; margin-bottom: 15px;">Enter words or phrases (separated by commas) that will trigger an automatic kick.</p>
        <textarea id="bad-words-input" class="input-box" rows="6" placeholder="scam, hack, insult, badword1..."></textarea>
        <button class="btn btn-primary" onclick="app.goToPage('bot-management-page')">Done</button>
    </div>
</div>
<div id="sticker-text-tool-overlay" class="page full-screen" style="background: rgba(0,0,0,0.9); z-index: 300; display: none; align-items: center; justify-content: center; flex-direction: column;">
    <div class="top-nav" style="background: transparent; color: white;">
        <i class="fa-solid fa-xmark" onclick="app.closeStickerTextTool()" style="cursor:pointer; font-size:24px;"></i>
        <div onclick="app.applyStickerText()" style="color: #00a884; font-weight: bold; cursor: pointer;">Done</div>
    </div>
    
    <input type="text" id="sticker-text-input" placeholder="Type text..." 
           style="width: 80%; background: transparent; border: none; color: white; text-align: center; font-size: 32px; font-weight: bold; outline: none; margin-bottom: 50px;">
    
    <div class="status-pill-container" style="background: rgba(255,255,255,0.1);">
        <div onclick="app.setStickerTextSize('20px', this)" class="status-pill">Small</div>
        <div onclick="app.setStickerTextSize('35px', this)" class="status-pill active">Middle</div>
        <div onclick="app.setStickerTextSize('55px', this)" class="status-pill">Big</div>
    </div>
</div>
<div id="sticker-color-tool-page" class="page full-screen" style="background: #5c6bc0; z-index: 300; display: none; flex-direction: column;">
    <div class="top-nav" style="background: transparent; color: white;">
        <i class="fa-solid fa-arrow-left" onclick="app.closeStickerColorTool()" style="cursor:pointer; font-size:24px;"></i>
        <i class="fa-solid fa-palette" onclick="app.toggleStickerBgColor()" style="cursor:pointer; font-size:24px;"></i>
        <div onclick="app.saveColorSticker()" style="color: white; font-weight: bold; cursor: pointer;">Save</div>
    </div>
    
    <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
        <textarea id="color-sticker-text" placeholder="Write message..." 
                  style="width: 85%; background: transparent; border: none; color: white; text-align: center; font-size: 40px; font-weight: bold; outline: none; resize: none;"></textarea>
    </div>
</div>
<div id="user-report-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; z-index: 4500;">
    <div style="background: white; width: 85%; max-width: 320px; border-radius: 28px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div style="text-align: center; margin-bottom: 15px;">
            <i class="fa-solid fa-flag" style="font-size: 30px; color: #ff4757;"></i>
        </div>
        <h3 id="report-modal-title" style="font-size: 20px; color: #111; margin-bottom: 12px; text-align: center;">Report User?</h3>
        <p style="font-size: 14px; color: #667781; line-height: 1.5; margin-bottom: 20px; text-align: center;">
            The last 5 messages from this chat will be forwarded to Global Connect. This user will not be notified.
        </p>
        
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 25px; padding: 10px; background: #f8f9fa; border-radius: 12px;">
            <input type="checkbox" id="report-also-block" style="width: 18px; height: 18px; accent-color: #00a884;">
            <span style="font-size: 14px; color: #111; font-weight: 600;">Block user and delete chat</span>
        </label>
        
        <div style="display: flex; justify-content: flex-end; gap: 24px; font-weight: 600; font-size: 14px;">
            <span onclick="app.closeReportUserModal()" style="color: #00a884; cursor: pointer;">Cancel</span>
            <span onclick="app.submitUserReport()" style="color: #ff4757; cursor: pointer;">Report</span>
        </div>
    </div>
</div>
<div id="game-picker-page" class="page full-screen" style="display:none; background: #0f171e; color: white;">
    <div class="top-nav" style="background: #1c2733; border-bottom: 1px solid #232e3c;">
        <i class="fa-solid fa-arrow-left" onclick="App.goToPage('chat-room')" style="cursor:pointer;"></i>
        <span style="font-weight: bold; margin-left: 15px;">Game Center</span>
    </div>
    <div style="padding: 15px;">
        <div style="background: linear-gradient(45deg, #6c5ce7, #a29bfe); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h3 style="margin:0;">Play with Friends</h3>
            <p style="font-size: 12px; opacity: 0.9;">Select a game to send a challenge in this chat.</p>
        </div>
        <div id="game-list-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            </div>
    </div>
</div>

<div id="game-player-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:10000;">
    <div style="height: 50px; background: #111; display:flex; align-items:center; padding: 0 15px; justify-content: space-between;">
        <span id="playing-game-title" style="color:white; font-size:14px; font-weight:bold;">Game</span>
        <i class="fa-solid fa-xmark" onclick="App.closeGame()" style="color:white; font-size:20px; cursor:pointer;"></i>
    </div>
    <iframe id="game-iframe" src="" style="width:100%; height:calc(100% - 50px); border:none;"></iframe>
</div>
<div id="leaderboard-page" class="page full-screen" style="background: #0f171e; color: white; z-index: 1000;">
    <div class="top-nav" style="background: #1c2733; border-bottom: 1px solid #232e3c;">
        <i class="fa-solid fa-arrow-left nav-item" onclick="app.goToPage('home-page')" style="color: white; cursor: pointer;"></i>
        <div style="font-weight: 800; font-size: 18px; flex: 1; margin-left: 20px;">Battle League âš”ï¸</div>
        <i class="fa-solid fa-circle-info" style="color: #8696a0;" onclick="alert('Ranks refresh every 24h based on Arena wins.')"></i>
    </div>

    <div style="padding: 20px; overflow-y: auto; height: calc(100% - 60px);">
        <div id="league-podium" style="display: flex; justify-content: space-around; align-items: flex-end; margin-bottom: 30px; height: 200px;">
            </div>

        <div id="league-list" style="background: rgba(255,255,255,0.03); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
            </div>
    </div>
</div>
<div id="profile-popup-overlay" class="profile-popup-overlay" onclick="App.closeProfilePopup()">
    <div class="profile-popup-box" onclick="event.stopPropagation()">
        <div class="popup-img-container" onclick="App.viewContactInfo()">
            <div class="popup-name-bar" id="popup-user-name">User Name</div>
            <img id="popup-user-img" src="">
        </div>
        <div class="popup-action-bar">
            <i class="fa-solid fa-comment popup-btn" onclick="App.openChatFromPopup()"></i>
            <i class="fa-solid fa-phone popup-btn" onclick="webrtc.startCall(state.currentChatId, false); App.closeProfilePopup();"></i>
            <i class="fa-solid fa-video popup-btn" onclick="webrtc.startCall(state.currentChatId, true); App.closeProfilePopup();"></i>
            <i class="fa-solid fa-circle-info popup-btn" onclick="App.viewContactInfo()"></i>
        </div>
    </div>
</div>
<div id="security-lock-overlay">
    <i class="fa-solid fa-shield-slash" style="font-size: 60px; color: #ff4b7d; margin-bottom: 20px;"></i>
    <h2 style="font-weight: 900;">PROTECTED CONTENT</h2>
    <p style="font-size: 15px; opacity: 0.8; margin-top: 15px; line-height: 1.5;">
        Screenshots and screen recordings are disabled <br> to protect user privacy.
    </p>
</div>
<div id="music-picker-page" class="page full-screen" style="background: white; z-index: 5000;">
    <div class="top-nav" style="border-bottom: 1px solid #eee;">
        <i class="fa-solid fa-arrow-left" onclick="app.closeMusicPicker()" style="cursor:pointer; color:#333;"></i>
        <div style="font-weight: bold; flex: 1; text-align: center;">Add Sound</div>
        <div style="width: 30px;"></div>
    </div>

    <div style="padding: 15px;">
        <div style="background: #f0f2f5; border-radius: 10px; display: flex; align-items: center; padding: 10px 15px;">
            <i class="fa-solid fa-magnifying-glass" style="color: #888; margin-right: 10px;"></i>
            <input type="text" id="music-search-input" placeholder="Search music..." 
                   style="border: none; background: transparent; flex: 1; outline: none; font-size: 15px;"
                   oninput="app.searchMusic(this.value)">
        </div>
    </div>

    <div style="display: flex; border-bottom: 1px solid #eee; margin-bottom: 10px;">
        <div class="music-tab active" id="tab-foryou" onclick="app.switchMusicTab('foryou')" style="flex: 1; text-align: center; padding: 12px; font-weight: bold; color: #ff4b7d; border-bottom: 2px solid #ff4b7d; cursor: pointer;">For You</div>
        <div class="music-tab" id="tab-hot" onclick="app.switchMusicTab('hot')" style="flex: 1; text-align: center; padding: 12px; color: #888; cursor: pointer;">Hot Favorite</div>
        <div class="music-tab" id="tab-recent" onclick="app.switchMusicTab('recent')" style="flex: 1; text-align: center; padding: 12px; color: #888; cursor: pointer;">Recent</div>
    </div>

    <div id="music-results-list" style="flex: 1; overflow-y: auto; padding: 0 15px;">
        <div style="text-align: center; padding: 50px; color: #ccc;">
            <i class="fa-solid fa-music fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i>
            <p>Loading sounds...</p>
        </div>
    </div>
</div>
<div id="music-detail-page" class="page full-screen" style="background: #fff; z-index: 1000;">
    <div class="top-nav" style="background: white; border-bottom: none; justify-content: space-between;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('movie-page')" style="font-size: 20px; cursor: pointer; color: #111;"></i>
        <div style="display: flex; gap: 20px; color: #111;">
            <i class="fa-solid fa-magnifying-glass"></i>
            <i class="fa-solid fa-share-nodes"></i>
        </div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding-bottom: 100px;">
        <div style="display: flex; padding: 15px 20px; gap: 20px; align-items: center;">
            <div style="width: 100px; height: 100px; border-radius: 12px; overflow: hidden; position: relative; background: #000;">
                <img id="md-image" src="" style="width: 100%; height: 100%; object-fit: cover;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px;">
                    <i class="fa-solid fa-play"></i>
                </div>
            </div>
            <div style="flex: 1;">
                <h2 id="md-title" style="font-size: 18px; font-weight: 800; margin-bottom: 4px;">Original Sound</h2>
                <div id="md-artist" style="font-size: 14px; color: #111; margin-bottom: 8px;">Artist Name ></div>
                <div id="md-post-count" style="font-size: 13px; color: #888;">0 posts</div>
            </div>
        </div>

        <div style="padding: 0 20px;">
            <button class="btn" style="background: #f1f1f1; color: #111; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; width: auto; padding: 8px 25px;">
                <i class="fa-regular fa-bookmark"></i> Add to Favorites
            </button>
        </div>

        <div id="md-video-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; margin-top: 20px;">
            </div>
    </div>

    <div style="position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; gap: 10px; padding: 0 20px; pointer-events: none; z-index: 10;">
        <button onclick="app.addMusicToStory()" class="btn" style="pointer-events: auto; flex: 1; background: white; color: black; border-radius: 30px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-weight: bold;">
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" style="width: 24px; height: 24px; border-radius: 50%;"> Add to Story
        </button>
        <button onclick="app.useSoundFromDetail()" class="btn" style="pointer-events: auto; flex: 1; background: #ff4b7d; color: white; border-radius: 30px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(255, 75, 125, 0.3); font-weight: bold; border: none;">
            <i class="fa-solid fa-video"></i> Use sound
        </button>
    </div>
</div>
<div id="share-modal-overlay" class="modal-overlay" onclick="app.closeShareMenu()">
    <div class="modal-content bottom-sheet" onclick="event.stopPropagation()" style="background: #fff; color: #111; padding-bottom: 30px;">
        <div class="modal-handle" style="background: #ddd;"></div>
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px 15px;">
            <i class="fa-solid fa-magnifying-glass" style="font-size: 18px; color: #111;"></i>
            <h3 style="font-size: 16px; font-weight: 800;">Send to</h3>
            <i class="fa-solid fa-xmark" onclick="app.closeShareMenu()" style="font-size: 20px;"></i>
        </div>

        <div id="share-contacts-rail" style="display: flex; gap: 15px; overflow-x: auto; padding: 10px; scrollbar-width: none; border-bottom: 1px solid #f5f5f5;">
            </div>

        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px 10px; padding: 20px 10px;">
            <div class="attach-item" onclick="app.repostCurrentVideo()">
                <div class="attach-icon" style="background: #ffcc00;"><i class="fa-solid fa-arrows-rotate"></i></div>
                <span>Repost</span>
            </div>
            <div class="attach-item" onclick="app.shareToWhatsApp('business')">
                <div class="attach-icon" style="background: #25D366;"><i class="fa-brands fa-whatsapp"></i></div>
                <span style="font-size: 9px;">WA Business</span>
            </div>
            <div class="attach-item" onclick="app.shareToWhatsApp('normal')">
                <div class="attach-icon" style="background: #25D366;"><i class="fa-brands fa-whatsapp"></i></div>
                <span>WhatsApp</span>
            </div>
            <div class="attach-item" onclick="app.copyVideoLink()">
                <div class="attach-icon" style="background: #007aff;"><i class="fa-solid fa-link"></i></div>
                <span>Copy link</span>
            </div>
            <div class="attach-item" onclick="app.shareToApp('instagram')">
                <div class="attach-icon" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);"><i class="fa-brands fa-instagram"></i></div>
                <span>Instagram</span>
            </div>
            <div class="attach-item" onclick="app.shareToApp('telegram')">
                <div class="attach-icon" style="background: #0088cc;"><i class="fa-brands fa-telegram"></i></div>
                <span>Telegram</span>
            </div>
            <div class="attach-item" onclick="app.shareToApp('discord')">
                <div class="attach-icon" style="background: #5865F2;"><i class="fa-brands fa-discord"></i></div>
                <span>Discord</span>
            </div>
            <div class="attach-item" onclick="app.addMusicToStory()">
                <div class="attach-icon" style="background: #111;"><i class="fa-solid fa-plus-circle"></i></div>
                <span>Story</span>
            </div>
            <div class="attach-item" onclick="app.downloadVideo()">
                <div class="attach-icon" style="background: #eee; color: #111;"><i class="fa-solid fa-download"></i></div>
                <span>Download</span>
            </div>
            <div class="attach-item" onclick="app.goToPage('report-page')">
                <div class="attach-icon" style="background: #eee; color: #111;"><i class="fa-solid fa-flag"></i></div>
                <span>Report</span>
            </div>
        </div>
    </div>
</div>
<div id="movie-search-page" class="page full-screen" style="background: #fff; z-index: 1500;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #f1f1f1; gap: 10px; padding: 10px 15px;">
        <i class="fa-solid fa-arrow-left" onclick="app.goToPage('movie-page')" style="font-size: 20px; cursor: pointer; color: #111;"></i>
        
        <div style="flex: 1; background: #f1f1f2; border-radius: 4px; padding: 0 12px; display: flex; align-items: center; height: 38px;">
            <i class="fa-solid fa-magnifying-glass" style="color: #8a8b91; font-size: 14px; margin-right: 8px;"></i>
            <input id="global-movie-search-input" type="text" placeholder="Search" 
                   style="background: transparent; border: none; color: #111; width: 100%; outline: none; font-size: 15px;">
            <i class="fa-solid fa-circle-xmark" style="color: #bdbe1; cursor: pointer; display: none;" id="clear-movie-search" onclick="document.getElementById('global-movie-search-input').value=''; this.style.display='none';"></i>
        </div>

        <div style="color: #ff4b7d; font-weight: 600; font-size: 15px; cursor: pointer;" onclick="app.performGlobalSearch()">Search</div>
    </div>

    <div id="movie-search-results" style="flex: 1; overflow-y: auto; padding: 15px; background: #fff;">
        
        <div id="initial-search-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="color: #111; font-size: 15px; font-weight: 800;">Trending</div>
                <div style="color: #ff4b7d; font-size: 13px; font-weight: 600; cursor: pointer;" onclick="app.loadTrendingVideos()">See all</div>
            </div>
            
            <div id="trending-video-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                </div>

            <div style="color: #8a8b91; font-size: 13px; font-weight: 600; margin-top: 25px; margin-bottom: 15px;">Recent searches</div>
            <div id="recent-searches-list">
                <p style="color: #ccc; font-size: 12px; text-align: center; margin-top: 20px;">Type to discover videos and creators</p>
            </div>
        </div>

        <div id="search-results-view" class="hidden">
            <div style="color: #8a8b91; font-size: 13px; font-weight: 600; margin-bottom: 15px;">Search Results</div>
            <div id="active-search-list">
                </div>
        </div>

    </div>
</div>
<div id="video-post-page" class="page full-screen" style="background: #fff; z-index: 2000;">
    <div class="top-nav" style="background: white; border-bottom: 1px solid #f1f1f1; justify-content: space-between; padding: 10px 15px;">
        <i class="fa-solid fa-chevron-left" onclick="app.goToPage('upload-page')" style="font-size: 20px; cursor: pointer; color: #111;"></i>
        <button id="final-post-btn" onclick="app.handleFinalPost(event)" style="background: #ff4b7d; color: white; border: none; padding: 8px 25px; border-radius: 4px; font-weight: bold; cursor: pointer;">Post</button>
    </div>

    <div style="flex: 1; overflow-y: auto; padding: 15px;">
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <textarea id="video-description-input" placeholder="Add a catchy title" 
                      style="flex: 1; border: none; outline: none; font-size: 16px; resize: none; height: 120px; color: #111;"></textarea>
            
            <div style="width: 80px; height: 110px; background: #000; border-radius: 4px; overflow: hidden; position: relative;">
                <canvas id="video-thumbnail-preview" style="width: 100%; height: 100%; object-fit: cover;"></canvas>
                <div style="position: absolute; bottom: 0; background: rgba(0,0,0,0.5); color: white; width: 100%; text-align: center; font-size: 10px; padding: 2px;">Select cover</div>
            </div>
        </div>

        <div style="font-size: 13px; color: #8a8b91; margin-bottom: 20px;">Writing a long description can help get 3x more views on average.</div>

        <div style="display: flex; gap: 10px; margin-bottom: 25px;">
            <button class="pill-btn" onclick="app.insertTag('#')"># Hashtags</button>
            <button class="pill-btn" onclick="app.insertTag('@')">@ Mention</button>
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-top: 1px solid #f5f5f5; border-bottom: 1px solid #f5f5f5; cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 10px; color: #111; font-weight: 500;">
                <i class="fa-solid fa-location-dot"></i> Location
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc;"></i>
        </div>

        <div style="margin-top: 25px;">
            <div id="hashtag-suggestions" style="display: flex; flex-direction: column; gap: 15px;">
                <div class="tag-row" onclick="app.insertTag('#Thriller')"><span>#Thriller</span> <i class="fa-regular fa-clock"></i></div>
                <div class="tag-row" onclick="app.insertTag('#MustWatch')"><span>#MustWatch</span> <i class="fa-regular fa-clock"></i></div>
            </div>
        </div>
    </div>
</div>
<div id="live-prep-page" class="page full-screen" style="background: black; z-index: 250;">
    <video id="live-prep-video" autoplay playsinline muted style="position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
    
    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 40%; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); pointer-events: none; z-index: 1;"></div>
    <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); pointer-events: none; z-index: 1;"></div>

    <div class="camera-overlay" style="z-index: 10;">
        <div class="camera-top" style="padding: 15px 20px;">
            <i class="fa-solid fa-xmark" onclick="app.goToPage('chat-list-page')" style="font-size: 24px; color: white; cursor: pointer;"></i>
        </div>

        <div style="padding: 0 20px; margin-top: 10px;">
            <div style="background: rgba(40,40,40,0.6); border-radius: 12px; padding: 12px; display: flex; gap: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);">
                <div style="position: relative; width: 60px; height: 60px; border-radius: 8px; overflow: hidden; background: #333;">
                    <img id="live-cover-preview" src="https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=100" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;">
                    <div style="position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 9px; text-align: center; padding: 2px;">Change</div>
                </div>
                <div style="flex: 1;">
                    <input type="text" id="live-title-input" placeholder="Add a title to your LIVE..." 
                           style="width: 100%; background: transparent; border: none; color: white; font-size: 15px; font-weight: 700; outline: none;">
                    <div style="margin-top: 8px; display: flex; gap: 10px;">
                        <span style="background: rgba(255,255,255,0.2); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px;">+ Add goal</span>
                        <span style="background: rgba(255,255,255,0.2); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px;">Topic</span>
                    </div>
                </div>
            </div>
        </div>

        <div style="flex: 1; display: flex; align-items: flex-end; padding-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); width: 100%; gap: 20px; padding: 0 10px;">
                <div class="camera-tool"><i class="fa-solid fa-house-signal"></i><span>Center</span></div>
                <div class="camera-tool"><i class="fa-solid fa-user-group"></i><span>Play with</span></div>
                <div class="camera-tool"><i class="fa-solid fa-square-poll-vertical"></i><span>Poll</span></div>
                <div class="camera-tool"><i class="fa-solid fa-star"></i><span>Subs</span></div>
                <div class="camera-tool"><i class="fa-solid fa-gear"></i><span>Settings</span></div>
                <div class="camera-tool"><i class="fa-solid fa-fire"></i><span>Promote</span></div>
                <div class="camera-tool"><i class="fa-solid fa-gift"></i><span>Rewards</span></div>
                <div class="camera-tool" onclick="app.flipCamera()"><i class="fa-solid fa-rotate"></i><span>Flip</span></div>
            </div>
        </div>

        <div style="padding: 0 20px 20px; text-align: center;">
            <button class="btn btn-primary" style="width: 100%; height: 50px; border-radius: 25px; background: #ff4b7d; font-size: 17px; font-weight: 800; border: none; color: white;" 
                    onclick="app.openLiveSelection()">
                Go LIVE
            </button>
            
            <div style="display: flex; justify-content: center; gap: 25px; margin-top: 20px; color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 700;">
                <span class="active" style="color: white;"><i class="fa-solid fa-camera" style="margin-right: 5px;"></i> Device camera</span>
                <span onclick="app.startLive('gaming')"><i class="fa-solid fa-mobile-screen" style="margin-right: 5px;"></i> Mobile gaming</span>
                <span><i class="fa-solid fa-clapperboard" style="margin-right: 5px;"></i> LIVE Studio</span>
            </div>
        </div>

        <div class="camera-bottom" style="padding-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="camera-modes">
                <span onclick="app.goToPage('chat-list-page')">POST</span>
                <span onclick="app.goToPage('upload-page')">TEMPLATES</span>
                <span class="active">LIVE</span>
            </div>
        </div>
    </div>
</div>
<div id="discord-game-frame" class="page full-screen" style="display: none; background: #2b2d31; z-index: 700; flex-direction: column;">
    <div style="height: 48px; background: #1e1f22; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid rgba(0,0,0,0.2);">
        <div onclick="app.closeGameFrame()" style="cursor: pointer; color: #dbdee1; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px;">
            <i class="fa-solid fa-chevron-left"></i> Back to Chat
        </div>
        <div style="flex: 1; text-align: center; color: white; font-weight: 700; letter-spacing: 0.5px;">
            <i class="fa-solid fa-fire" style="color: #ff4b7d; margin-right: 8px;"></i> FREE FIRE 3D LOBBY
        </div>
        <div style="display: flex; gap: 15px; color: #b5bac1;">
            <i class="fa-solid fa-user-plus" onclick="app.inviteFriendsToGame()" style="cursor: pointer;"></i>
            <i class="fa-solid fa-gear"></i>
        </div>
    </div>

    <div style="flex: 1; display: flex; overflow: hidden;">
        <div id="activity-stage" style="flex: 1; background: #000; position: relative;">
            <div id="threejs-canvas-target" style="width: 100%; height: 100%;"></div>

            <div id="game-start-modal" style="position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10;">
                <div style="background: #313338; width: 85%; padding: 24px; border-radius: 8px; text-align: center; border: 1px solid #4e5058;">
                    <h2 style="color: white; margin-bottom: 8px;">Combat Zone</h2>
                    <p style="color: #b5bac1; font-size: 13px; margin-bottom: 24px;">Invite your squad or go solo to dominate the field.</p>
                    
                    <button onclick="app.launchGame('single')" style="width: 100%; background: #5865f2; color: white; border: none; padding: 12px; border-radius: 3px; font-weight: bold; margin-bottom: 10px;">Play Single Player</button>
                    <button onclick="app.launchGame('multi')" style="width: 100%; background: #4e5058; color: white; border: none; padding: 12px; border-radius: 3px; font-weight: bold;">Multiplayer Mode</button>
                </div>
            </div>
        </div>

        <div style="width: 220px; background: #2b2d31; border-left: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column;">
            <div style="padding: 16px; color: #949ba4; font-size: 11px; font-weight: 800; text-transform: uppercase;">Participants â€” 1</div>
            <div id="participant-list" style="flex: 1; padding: 0 8px;">
                <div style="display: flex; align-items: center; gap: 12px; padding: 6px 8px; border-radius: 4px; background: rgba(255,255,255,0.05);">
                    <img id="game-frame-avatar" src="" style="width: 32px; height: 32px; border-radius: 50%;">
                    <div style="color: white; font-size: 14px; font-weight: 500;">Kelvin (You)</div>
                </div>
            </div>
            
            <div style="padding: 16px; background: #232428;">
                <button onclick="app.inviteFriendsToGame()" style="width: 100%; background: #248046; color: white; border: none; padding: 8px; border-radius: 3px; font-weight: bold; cursor: pointer;">Invite to Play</button>
            </div>
        </div>
    </div>
</div>


<script src="i18n.js"></script>
<script type="module">
    // --- IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, getDoc, getDocs, query, where, orderBy, limit, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyC6KkYzeoJGlZkXO0c2lqPPCXQffj8XzfQ",
        authDomain: "heatless-ed281.firebaseapp.com",
        projectId: "heatless-ed281",
        storageBucket: "heatless-ed281.firebasestorage.app",
        messagingSenderId: "650210275070",
        appId: "1:650210275070:web:323ec32ae5cdd92ebdbfaf"
    };

    let appInstance, auth, db;
    try {
        appInstance = initializeApp(firebaseConfig);
        auth = getAuth(appInstance);
        db = getFirestore(appInstance);
        console.log("Firebase Initialized.");
    } catch (e) {
        alert("CRITICAL ERROR: Firebase Config Failed. " + e.message);
    }

    // ðŸŒŸ GLOBAL API KEYS 
    const YT_KEY = "AIzaSyAA7J6hNZ7rp3jddwh2H5nINeAYoyU5vGM";


    // ðŸŽ Professional High-Quality Animated Gift Items
const GiftItems = [
    // --- ðŸ† ELITE GIFTS (High Value) ---
    { id: 'private_jet', name: 'Private Jet', price: 10000, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f6eb/512.gif' },
    { id: 'lion_king', name: 'Golden Lion', price: 5000, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f981/512.gif' },
    { id: 'infinite_fire', name: 'Infinite Fire', price: 2500, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f525/512.gif' },

    // --- ðŸŽ‚ Food & Celebration ---
    { id: 'cake', name: 'Birthday Cake', price: 50, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f382/512.gif' },
    { id: 'champagne', name: 'Champagne', price: 60, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f37e/512.gif' },
    { id: 'pizza', name: 'Pizza Slice', price: 10, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f355/512.gif' },
    { id: 'burger', name: 'Burger', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f354/512.gif' },
    { id: 'ice_cream', name: 'Ice Cream', price: 10, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f366/512.gif' },
    { id: 'doughnut', name: 'Doughnut', price: 10, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f369/512.gif' },
    { id: 'cocktail', name: 'Cocktail', price: 20, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f378/512.gif' },
    { id: 'chocolate', name: 'Chocolate Bar', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f36b/512.gif' },
    { id: 'beer', name: 'Beer Mug', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f37a/512.gif' },
    { id: 'taco', name: 'Taco', price: 12, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f32e/512.gif' },

    // --- â¤ï¸ Love & Romance ---
    { id: 'rose', name: 'Magic Rose', price: 25, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f339/512.gif' },
    { id: 'heart_fire', name: 'Heart on Fire', price: 40, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/2764_fe0f_200d_1f525/512.gif' },
    { id: 'kiss', name: 'Kiss', price: 30, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f48b/512.gif' },
    { id: 'love_letter', name: 'Love Letter', price: 20, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f48c/512.gif' },
    { id: 'ring', name: 'Diamond Ring', price: 200, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f48d/512.gif' },
    { id: 'couple', name: 'Romantic Couple', price: 80, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f491/512.gif' },
    { id: 'bouquet', name: 'Flower Bouquet', price: 45, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f490/512.gif' },
    { id: 'sparkling_heart', name: 'Sparkle Heart', price: 25, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f496/512.gif' },

    // --- ðŸ’Ž Luxury & Status ---
    { id: 'diamond', name: 'Big Diamond', price: 100, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f48e/512.gif' },
    { id: 'crown', name: 'King Crown', price: 500, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f451/512.gif' },
    { id: 'money_bag', name: 'Money Bag', price: 150, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f4b0/512.gif' },
    { id: 'gold_medal', name: 'Gold Medal', price: 75, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f947/512.gif' },
    { id: 'trophy', name: 'Champion Trophy', price: 300, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f3c6/512.gif' },
    { id: 'gem', name: 'Rare Gem', price: 120, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f4a0/512.gif' },
    { id: 'credit_card', name: 'Black Card', price: 400, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f4b3/512.gif' },

    // --- ðŸ§¸ Animals & Toys ---
    { id: 'teddy', name: 'Teddy Bear', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f004/512.gif' },
    { id: 'unicorn', name: 'Magic Unicorn', price: 50, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f984/512.gif' },
    { id: 'cat_heart', name: 'Love Cat', price: 20, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f63b/512.gif' },
    { id: 'panda', name: 'Cute Panda', price: 25, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f43c/512.gif' },
    { id: 'dog', name: 'Happy Dog', price: 25, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f436/512.gif' },
    { id: 'butterfly', name: 'Butterfly', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f98b/512.gif' },
    { id: 'dove', name: 'Peace Dove', price: 35, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f54a/512.gif' },
    { id: 'monkey', name: 'Funny Monkey', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f64a/512.gif' },
    { id: 'dragon', name: 'Golden Dragon', price: 1000, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f409/512.gif' },

    // --- ðŸš€ Activities & Fun ---
    { id: 'rocket', name: 'Rocket Launch', price: 100, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f680/512.gif' },
    { id: 'fireworks', name: 'Celebration', price: 90, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f386/512.gif' },
    { id: 'party_popper', name: 'Party Popper', price: 30, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f389/512.gif' },
    { id: 'balloon', name: 'Red Balloon', price: 10, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f388/512.gif' },
    { id: 'gift_box', name: 'Surprise Gift', price: 40, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f381/512.gif' },
    { id: 'video_game', name: 'Game On', price: 60, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f3ae/512.gif' },
    { id: 'music_notes', name: 'Vibe', price: 20, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f3b6/512.gif' },
    { id: 'basketball', name: 'Slam Dunk', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f3c0/512.gif' },
    { id: 'football', name: 'Touchdown', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f3c8/512.gif' },

    // --- ðŸŒ Nature & Weather ---
    { id: 'sun', name: 'Bright Sun', price: 20, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/2600/512.gif' },
    { id: 'rainbow', name: 'Rainbow', price: 50, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f308/512.gif' },
    { id: 'star', name: 'Shooting Star', price: 40, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f320/512.gif' },
    { id: 'lightning', name: 'Storm', price: 30, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/26a1/512.gif' },
    { id: 'crystal_ball', name: 'Future', price: 70, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f52e/512.gif' },
    { id: 'moon', name: 'Crescent Moon', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f319/512.gif' },

    // --- ðŸ”® Mystery & Cool ---
    { id: 'alien', name: 'Alien Friend', price: 45, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f47d/512.gif' },
    { id: 'ghost', name: 'Spooky Ghost', price: 25, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f47b/512.gif' },
    { id: 'robot', name: 'Robot Bot', price: 55, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f916/512.gif' },
    { id: 'skull', name: 'Doom', price: 30, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f480/512.gif' },
    { id: 'bomb', name: 'The Bomb', price: 65, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f4a3/512.gif' },
    { id: 'eyes', name: 'Watching You', price: 10, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f440/512.gif' },
    { id: 'medal_military', name: 'Hero Medal', price: 110, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f396/512.gif' },
    { id: 'clover', name: 'Good Luck', price: 15, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f340/512.gif' },
    { id: 'hourglass', name: 'Eternal Time', price: 45, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/231b/512.gif' },
    { id: 'super_fire', name: 'Solar Flare', price: 1200, anim: 'https://fonts.gstatic.com/s/e/notoemoji/latest/1f525/512.gif' }
    ];
    const emailConfig = [
    { service: "service_sn4gr4t", template: "template_bmv9fva", userId: "a5kAk-ktmTEhKCo54" }, // First (Original)
    { service: "service_yk076ua", template: "template_iexxuof", userId: "0UmcqayrO6Nvz7xux" }, // Second
    { service: "service_sydanl5", template: "template_qkjeluh", userId: "VRknlm2rOD6rP669_" }  // Third
 ];
// 1. Keep this as a constant at the very top (outside the state)
const filterPresetsList = [
    { name: 'Normal', filter: 'none' },
    { name: 'Calm', filter: 'brightness(1.1) contrast(0.9) saturate(0.8)' },
    { name: 'Vivid', filter: 'saturate(1.8) contrast(1.1)' },
    { name: 'Dark Teal', filter: 'hue-rotate(150deg) saturate(1.2) brightness(0.9)' },
    { name: 'Retro', filter: 'sepia(0.5) contrast(1.2) brightness(1.1)' },
    { name: 'Enhance', filter: 'contrast(1.3) brightness(1.1) saturate(1.1)' },
    { name: 'B&W', filter: 'grayscale(1)' },
    { name: 'Focus', filter: 'brightness(1.2) contrast(1.1)' },
    { name: 'Cold', filter: 'hue-rotate(190deg) saturate(1.1)' },
    { name: 'Warm', filter: 'sepia(0.3) saturate(1.4)' },
    { name: 'Film', filter: 'contrast(0.8) brightness(1.1) sepia(0.2)' }
];

// 2. Generate the rest of the 50
for (let i = 1; i <= 39; i++) {
    filterPresetsList.push({ 
        name: `Style ${i}`, 
        filter: `hue-rotate(${i * 12}deg) contrast(1.05) brightness(1.1)` 
    });
};


 
 const GameEngine = {
    // ðŸŒŸ High-Quality Games (Solo + Multiplayer capable)
    library: [
        { id: 'ludo', name: 'Ludo Hero', img: 'https://cdn.pixabay.com/photo/2021/01/11/18/41/ludo-5909335_1280.png', url: 'https://www.gamepix.com/live/ludo-hero' },
        { id: 'uno', name: 'Color Cards', img: 'https://cdn-icons-png.flaticon.com/512/3513/3513824.png', url: 'https://www.gamepix.com/live/four-colors' },
        { id: 'pool', name: '8 Ball Pro', img: 'https://cdn-icons-png.flaticon.com/512/2855/2855219.png', url: 'https://www.gamepix.com/live/8-ball-pool-billiard' },
        { id: 'chess', name: '3D Chess', img: 'https://cdn-icons-png.flaticon.com/512/2855/2855365.png', url: 'https://www.gamepix.com/live/master-chess' }
    ],
    renderHub: () => {
        const grid = document.getElementById('game-list-grid');
        const partnerName = state.currentChatPartner ? state.currentChatPartner.name : "Play Solo";
        document.getElementById('game-partner-name').innerText = partnerName;

        grid.innerHTML = GameEngine.library.map(game => `
            <div class="mini-gift-item" onclick="App.startGame('${game.id}')" style="background: #1f2c34; border: 1px solid #2a3942; height: 140px;">
                <img src="${game.img}" style="width: 50px; height: 50px; border-radius: 12px; margin-bottom: 10px;">
                <div style="font-weight: bold; font-size: 13px; color: white;">${game.name}</div>
                <div style="font-size: 10px; color: #00a884; margin-top: 5px;">TAP TO START</div>
            </div>
        `).join('');
        App.goToPage('game-picker-page');
    }
 };

 


    // --- STATE ---
    const state = { 
    // 1. User & Navigation
    currentUser: null, 
    currentChatId: null, 
    currentChatPartner: null,
    pendingMessages: [], 
    lastMsgCount: 0, 
    forceMessageRefresh: false,

    // 2. Feed / Movie Page
    feed: [],        
    feedIndex: 0,
    movieViewMode: 'discovery', // ðŸŒŸ Added: 'discovery' or 'profile'
    
            // 3. Profile Data
    profileBase64: null, 
    settingsBase64: null, 
    locationData: null,
    generatedOTP: null,
    otpTimer: null,
    userEmail: null,
    isSendingEmail: false,
    activeEmailAcc: 0,
    activeToneType: 'msg',

    
    // 4. Online / Offline & Audio Playback
    onlineUsers: {}, 
    pendingQueue: [], 
    activeAudio: null, 
    partnerUnsubscribe: null,
    activeChatListener: null, 

    // 5. Voice Note Recording
    isRecording: false,
    isLocked: false,
    mediaRecorder: null,
    audioChunks: [],
    recStartTime: 0,
    recTimerInterval: null, 
    touchStartY: 0,     
    isViewOnce: false,  

    // 6. Avatar System
    avatarMode: false,
    avatarScene: null,
    avatarCamera: null,
    avatarRenderer: null,
    avatarModel: null,
    avatarMixer: null,
    THREE: null,        
    GLTFLoader: null,   
    mouseX: 0, 
    mouseY: 0,

    // 7. Video Camera / Uploads
    isRecordingVideo: false,
    cameraStream: null,
    videoRecorder: null,
    videoChunks: [],
    currentUploadFile: null,

    // 8. STATUS SYSTEM 
    activeStories: [],
    storyIndex: 0,
    storyTimer: null,
    pendingStatuses: [],
    tempStatusImage: null,
    statusCameraStream: null,
    hasActiveStatus: false, 

    // 9. GROUPS 
    isAddingMember: false,
    groupParticipants: [],
    groupIconBase64: null,
    currentGroupData: null,
    currentInviteLink: null,
    allContacts: [], 
    pendingJoinGroupId: null, 
    pendingJoinGroupData: null, 
    
    // 10. REPLY, SELECTION & LINK PREVIEWS
    replyContextData: null,
    selectedMessage: null,
    activeLinkPreview: null, 

    // ðŸŒŸ NEW: Selection Mode & Archive/Lock Persistence
    selectedChats: new Set(),
    pinnedChats: JSON.parse(localStorage.getItem('pinned_chats') || '[]'),
    mutedChats: JSON.parse(localStorage.getItem('muted_chats') || '[]'),
    archivedChats: JSON.parse(localStorage.getItem('archived_chats') || '[]'),
    lockedChats: JSON.parse(localStorage.getItem('locked_chats') || '[]'),
    isArchiveExpanded: false, 

    // ðŸŒŸ APP LOCK / BIOMETRIC TRACKING
    isScanning: false,
    scanTimer: null,

    // 11. STICKER DATA 
    menuTargetSrc: null, 
    stickerData: {
        favorites: new Set(), 
        recents: [],          
        packs: []             
    },

    // ðŸ”´ 12. LIVE TRACKER
    activeLiveHosts: {}, // Format: { userId: liveId }

    // 13. UTILS & AUTH 
    html5QrCode: null,       
    confirmationResult: null, 
    lastPage: null,          
    currentPrivacyKey: null, 
    blockedUsers: [],
    currentChannelLink: null,
    currentPinInput: "",

        // ðŸš€ 14. BOOST SYSTEM
    boostStep: 1,
    boostData: { goal: '', audience: 'Auto', budget: 5, duration: 1 }, // Added comma here

        // ðŸ“¦ 15. STORAGE SYSTEM
    storageSelection: [],
    currentStorageChatId: null,

     // ðŸŽ¨ 16. FILTER & CAMERA
    filterPresets: filterPresetsList, 
    facingMode: 'user', 
    
        // ðŸ•’ 17. COUNTDOWN & RECORD LIMIT
    countdownDuration: 3, 
    recordingLimit: 0, 

    // ðŸŽ¨ 18. TEXT OVERLAY STATE
    textOverlay: {
        content: "",
        color: "#ffffff",
        background: "transparent",
        bgMode: 0 // 0: None, 1: Solid, 2: Glass
    }
 };
 


        // --- ðŸ“¦ INDEXED DB ENGINE (For 300MB+ Videos) ---
    const DB_NAME = "GlobalConnect_Cinema";
    const STORE_NAME = "local_movies";

    const initMovieDB = () => {
        return new Promise((resolve,  reject) => {
            const request = indexedDB.open(DB_NAME,  1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                // FIX: Used STORE_NAME (caps) to match the constant above
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e.target.error);
        });
    };

    const saveToLocalDB = async (id,  blob) => {
        const db = await initMovieDB();
        const tx = db.transaction(STORE_NAME,  "readwrite");
        tx.objectStore(STORE_NAME).put(blob,  id);
        return new Promise((res) => tx.oncomplete = res);
    };

    const getFromLocalDB = async (id) => {
        const db = await initMovieDB();
        const tx = db.transaction(STORE_NAME,  "readonly");
        const request = tx.objectStore(STORE_NAME).get(id);
        return new Promise((res) => request.onsuccess = () => res(request.result));
    };
    
        // --- DATA MANAGER (Updated for Badges & Mentions) ---
    const DataManager = {
    // ðŸŒŸ Tracks message IDs already processed in this session to prevent duplicate UI triggers
    processedMsgIds: new Set(),

    get: (key) => JSON.parse(localStorage.getItem(key) || 'null'),
    set: (key, value) => localStorage.setItem(key, JSON.stringify(value)),
    clear: () => localStorage.clear(),
    
    saveMessage: (chatId, msg) => {
        if (!chatId) return;
        let history = DataManager.getMessages(chatId);
        // Ensure we don't save the same message twice
        const index = history.findIndex(m => m.id === msg.id || (m.timestamp === msg.timestamp && m.senderId === msg.senderId));
        if (index !== -1) history[index] = msg; 
        else history.push(msg);
        localStorage.setItem(`chat_${chatId}`, JSON.stringify(history));
    },
    
    getMessages: (chatId) => {
        return JSON.parse(localStorage.getItem(`chat_${chatId}`) || '[]');
    },

    getChatList: () => JSON.parse(localStorage.getItem('wa_chats_array') || '[]'),

    saveProfile: (data) => DataManager.set('user_profile', data),
    getProfile: () => DataManager.get('user_profile') || {},

    // ðŸŒŸ HELPER: Fetches user info for Reactions/Viewers
    getUserInfo: async (uid) => {
        const cached = DataManager.getChatList().find(c => c.id === uid);
        if (cached) return { name: cached.name, photo: cached.avatar };
        try {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const snap = await getDoc(doc(db, "users", uid));
            if (snap.exists()) return snap.data();
        } catch (e) { console.error(e); }
        return { name: "User", photo: "https://cdn-icons-png.flaticon.com/512/847/847969.png" };
    },

    // ðŸŒŸ FIXED: updateChatList (Re-calculates instead of just adding +1)
    updateChatList: (chatId, lastMsg, partnerName, partnerAvatar, incrementUnread = false, isMention = false) => {
        if (!chatId || chatId === "undefined") return;
        
        let chats = DataManager.getChatList(); 
        const existingIndex = chats.findIndex(c => c.id === chatId);
        let existingData = { unread: 0, hasMention: false, isVerified: false };
        
        if (existingIndex > -1) {
            existingData = chats[existingIndex];
            chats.splice(existingIndex, 1);
        }

        // --- ðŸ›¡ï¸ THE UNREAD FIX ---
        // Instead of incrementing (unread + 1), we look at the message history 
        // and count how many messages are NOT from us and are NOT 'read'.
        const history = DataManager.getMessages(chatId);
        const myUid = state.currentUser ? state.currentUser.uid : null;
        
        const realUnreadCount = history.filter(m => 
            m.senderId !== myUid && 
            m.status !== 'read' && 
            !m.isSystem
        ).length;

        // --- ðŸ›¡ï¸ DUPLICATE ID PROTECTION ---
        // If this is a live incoming message (incrementUnread is true), 
        // we add it to the processed set so we don't flash the UI twice.
        if (lastMsg.id) DataManager.processedMsgIds.add(lastMsg.id);

        const name = partnerName || existingData.name || "User";
        const avatar = partnerAvatar || existingData.avatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        const isVerified = (state.onlineUsers && state.onlineUsers[chatId]?.isVerified) || existingData.isVerified || false;

        let previewText = lastMsg.text;
        if(!previewText && lastMsg.audio) previewText = "ðŸŽ¤ Voice Note";
        if(!previewText && lastMsg.img) previewText = "ðŸ“· Image";
        if(!previewText && lastMsg.type === 'sticker') previewText = "ðŸ“„ Sticker";

        const newEntry = { 
            id: chatId,
            name: name, 
            avatar: avatar, 
            isVerified: isVerified, 
            lastMsg: previewText || 'Message', 
            time: lastMsg.time,
            timestamp: lastMsg.timestamp || Date.now(),
            unread: realUnreadCount, // ðŸŒŸ Uses the calculated count
            hasMention: isMention || existingData.hasMention
        };

        chats.unshift(newEntry);
        localStorage.setItem('wa_chats_array', JSON.stringify(chats));
        
        if (document.getElementById('chat-list-container')) {
            App.renderChatList();
        }
    },
    
    clearBadges: (chatId) => {
        let chats = DataManager.getChatList();
        const index = chats.findIndex(c => c.id === chatId);
        if (index > -1) {
            chats[index].unread = 0;
            chats[index].hasMention = false;
            localStorage.setItem('wa_chats_array', JSON.stringify(chats));
            App.renderChatList();
        }
    },


        getChatList: () => JSON.parse(localStorage.getItem('wa_chats_array') || '[]'),
        getChatInfo: (id) => DataManager.getChatList().find(c => c.id === id) || null,
        saveProfile: (data) => DataManager.set('user_profile', data),
        getProfile: () => DataManager.get('user_profile') || {},
        likeUser: (userId) => { /* ... keep existing ... */ },
        getLikes: () => DataManager.get('liked_users') || []
    };

               // --- BOT ENGINE (Updated: Auto-add Bot to DM) ---
    const BotEngine = {
        MASTER_ID: "botfather_official", 

        init: async () => {
            const ref = doc(db, "users", BotEngine.MASTER_ID);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                await setDoc(ref, {
                    uid: BotEngine.MASTER_ID,
                    name: "BotFather",
                    bio: "I am the father of all bots. Type .help to start.",
                    photo: "https://cdn-icons-png.flaticon.com/512/4712/4712035.png",
                    isBot: true, isVerified: true, isOnline: true
                });
            }
        },

        isMaster: (id) => id === BotEngine.MASTER_ID,

        processCommand: async (text, senderId) => {
            const args = text.trim().split(" ");
            const command = args[0].toLowerCase();
            let response = "";

            switch (command) {
                case ".help":
                    response = "ðŸ¤– **BotFather Commands:**\n\n`.create <Name>`\n`.mybots`\n`.delete <Token>`";
                    break;

                case ".create":
                    if (!args[1]) {
                        response = "âŒ **Error:** Missing name.\nUsage: `.create MyCoolBot`";
                    } else {
                        const botName = args.slice(1).join(" "); 
                        const botId = "bot_" + Date.now(); 
                        const token = "TOK-" + Math.random().toString(36).substr(2, 12).toUpperCase();
                        const botAvatar = "https://cdn-icons-png.flaticon.com/512/4712/4712109.png";

                        // 1. Save Public Profile
                        await setDoc(doc(db, "users", botId), {
                            uid: botId, name: botName, bio: "Automated Bot",
                            photo: botAvatar, isBot: true, ownerId: senderId, isOnline: true
                        });

                        // 2. Save Token
                        await setDoc(doc(db, "bot_tokens", token), {
                            token: token, botId: botId, ownerId: senderId, created: Date.now()
                        });

                        // 3. INSTANTLY ADD TO USER'S DM LIST (Local Update)
                        DataManager.updateChatList(
                            botId, 
                            { text: "ðŸ¤– I am ready!", time: "Now", timestamp: Date.now() }, 
                            botName, 
                            botAvatar
                        );

                        // 4. SAVE WELCOME MESSAGE TO DB (Permanent Storage)
                        await addDoc(collection(db, "messages"), {
                            text: `Hello! I am **${botName}**. \nUse my token to control me.`,
                            senderId: botId,
                            receiverId: senderId,
                            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                            timestamp: Date.now(),
                            status: 'read',
                            isBotMsg: true
                        });

                        response = `âœ… **Bot Created!**\n\nName: ${botName}\nCheck your DMs to talk to it!\n\nðŸ”‘ **TOKEN:**\n${token}`;
                    }
                    break;

                case ".mybots":
                    const q = query(collection(db, "bot_tokens"), where("ownerId", "==", senderId));
                    const snap = await getDocs(q);
                    if (snap.empty) response = "You have no bots.";
                    else {
                        response = "ðŸ¤– **Your Bots:**\n";
                        for (const d of snap.docs) {
                            const bSnap = await getDoc(doc(db, "users", d.data().botId));
                            const name = bSnap.exists() ? bSnap.data().name : "Unknown";
                            response += `\nName: ${name}\nToken: ${d.data().token}\n----------------`;
                        }
                    }
                    break;

                case ".delete":
                    const delToken = args[1];
                    if (!delToken) response = "âŒ Usage: `.delete <Token>`";
                    else {
                        const tRef = doc(db, "bot_tokens", delToken);
                        const tSnap = await getDoc(tRef);
                        if (tSnap.exists() && tSnap.data().ownerId === senderId) {
                            await deleteDoc(doc(db, "users", tSnap.data().botId));
                            await deleteDoc(tRef);
                            response = "ðŸ—‘ï¸ Bot deleted.";
                        } else response = "âŒ Invalid token.";
                    }
                    break;

                default:
                    response = "âŒ Unknown command. Type `.help`.";
                    break;
            }

            // Send BotFather's Reply
            setTimeout(() => {
                const reply = {
                    text: response,
                    senderId: BotEngine.MASTER_ID,
                    receiverId: senderId,
                    time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                    timestamp: Date.now(),
                    status: 'read',
                    isBotMsg: true 
                };
                DataManager.saveMessage(BotEngine.MASTER_ID, reply);
                if (state.currentChatId === BotEngine.MASTER_ID) App.renderMessages(BotEngine.MASTER_ID);
                else App.renderChatList();
            }, 500);
        }
    };
    const BoostEngine = {
    steps: [
        { title: "Select Goal", desc: "What results would you like from this boost?", options: ["More Views", "More Messages", "More Profile Visits"] },
        { title: "Define Audience", desc: "Who should see your status?", options: ["Automatic (Global Connect picks)", "Local (People near you)", "Custom Interests"] },
        { title: "Target Gender", desc: "Select specific demographics", options: ["All", "Men", "Women"] },
        { title: "Age Range", desc: "Choose target age", options: ["18 - 24", "25 - 34", "35+"] },
        { title: "Duration", desc: "How many days should this run?", options: ["1 Day", "3 Days", "7 Days", "30 Days"] },
        { title: "Daily Budget", desc: "Spend more to reach more people", options: ["$5/day", "$10/day", "$25/day", "$50/day"] },
        { title: "Review Ad", desc: "Preview your official ad status", options: ["Looks Good!"] },
        { title: "Payment Method", desc: "Choose how to pay", options: ["App Wallet Balance", "Google Play Store"] },
        { title: "Finalizing", desc: "Processing your promotion...", options: [] }
    ],

    renderStep: () => {
        const area = document.getElementById('boost-content-area');
        const step = BoostEngine.steps[state.boostStep - 1];
        document.getElementById('boost-step-indicator').innerText = `Step ${state.boostStep}/9`;

        if (state.boostStep === 9) {
            area.innerHTML = `<div style="text-align:center; padding-top:50px;"><div class="sending-spinner" style="margin:0 auto 20px;"></div><h3>Publishing Ads...</h3></div>`;
            document.getElementById('boost-next-btn').style.display = 'none';
            setTimeout(BoostEngine.finishBoost, 3000);
            return;
        }

        let optionsHtml = step.options.map(opt => `
            <div class="boost-option" onclick="app.selectBoostOption('${opt}', this)">
                <i class="fa-regular fa-circle"></i>
                <span>${opt}</span>
            </div>
        `).join('');

        area.innerHTML = `
            <div class="boost-card">
                <div class="boost-step-title">${step.title}</div>
                <p style="color:gray; font-size:14px; margin-bottom:20px;">${step.desc}</p>
                ${optionsHtml}
            </div>
        `;
    },

    nextStep: () => {
        if (state.boostStep === 8) {
            BoostEngine.processPayment();
        } else {
            state.boostStep++;
            BoostEngine.renderStep();
        }
    },

    processPayment: async () => {
    const method = state.boostData.paymentMethod;
    const totalCost = state.boostData.budget * state.boostData.duration;
    const orbCost = totalCost * 100; // 100 orbs = $1

    if (method === "App Wallet Balance") {
        const profile = DataManager.getProfile();
        
        // 1. Check if user has enough orbs
        if ((profile.orbs || 0) < orbCost) {
            alert(`Insufficient Orbs. You need ${orbCost} Orbs for this boost.`);
            return;
        }

        // 2. Deduct Orbs from Database
        try {
            const { doc, updateDoc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const userRef = doc(db, "users", state.currentUser.uid);
            
            await updateDoc(userRef, { 
                orbs: increment(-orbCost) 
            });

            // Update local profile memory
            profile.orbs -= orbCost;
            DataManager.saveProfile(profile);
            
            App.showToast(`âœ… ${orbCost} Orbs deducted from Wallet`);
            
            // Move to final step
            state.boostStep = 9;
            BoostEngine.renderStep();
        } catch (e) {
            console.error("Wallet deduction failed:", e);
            App.showToast("Connection error. Try again.");
        }

    } else {
        // ðŸ’³ CASE 2: DIRECT PAYMENT VIA PAYSTACK
        App.showToast("Opening Secure Payment...");
        
        PaymentEngine.pay(totalCost, "Status Boost Promotion", { 
            boost_goal: state.boostData.goal,
            duration_days: state.boostData.duration 
        }, () => {
            // This runs only after Paystack success
            state.boostStep = 9;
            BoostEngine.renderStep();
        });
    }
 },


    finishBoost: async () => {
        const originalStatus = state.activeStories[state.storyIndex];
        const myProfile = DataManager.getProfile();

        try {
            const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            await addDoc(collection(db, "statuses"), {
                uid: "official_global_connection",
                name: "Official Global Connection",
                photo: "https://cdn-icons-png.flaticon.com/512/4359/4359959.png",
                image: originalStatus.image,
                type: originalStatus.type,
                isAd: true, 
                advertiserId: state.currentUser.uid,
                advertiserName: myProfile.name,
                advertiserPhoto: myProfile.photo,
                timestamp: Date.now(),
                views: []
            });

            App.showToast("âœ… Boost Successful! Ad is Live.");
            App.goToPage('chat-list-page');
            state.boostStep = 1;
        } catch (e) { console.error(e); }
      }
  };
  const PaymentEngine = {
    publicKey: "pk_live_d3be9817807304de1adbcab8433ba113eee96b98",

    pay: (amountInUSD, purpose, metadata = {}, callback) => {
        // ðŸ‡³ðŸ‡¬ Convert USD to Naira (Baseline: 1500)
        // Paystack requires the amount in KOBO (Naira * 100)
        const nairaAmount = Math.round(amountInUSD * 1500 * 100);

        const handler = PaystackPop.setup({
            key: PaymentEngine.publicKey,
            email: state.currentUser.email,
            amount: nairaAmount,
            currency: "NGN",
            metadata: {
                custom_fields: [
                    { display_name: "Purpose", variable_name: "purpose", value: purpose },
                    ...Object.entries(metadata).map(([k, v]) => ({
                        display_name: k.replace('_', ' '),
                        variable_name: k,
                        value: v
                    }))
                ]
            },
            callback: (response) => {
                // response.reference is the transaction ID
                App.showToast("Payment Successful! Verifying...");
                callback(response);
            },
            onClose: () => {
                App.showToast("Payment Cancelled");
            }
        });
        handler.openIframe();
    }
 };


    // --- APP LOGIC ---
    const App = {

init: () => {
        emailjs.init("a5kAk-ktmTEhKCo54");
        App.setupListeners();
        App.injectStyles(); // Inject CSS for online dots
        
        // ðŸŒŸ 1. INITIALIZE THEME SYSTEM ðŸŒŸ
        // This ensures the color picker grid and wallpapers are prepared immediately
        App.initThemeSystem(); 

        // --- 2. THE WHATSAPP LOGIC (INSTANT OFFLINE ACCESS) ---
        // Look at the phone's local memory BEFORE checking the internet.
        const localProfile = DataManager.getProfile();
        const isLockEnabled = localStorage.getItem('lock_enabled') === 'true';
        
        if (localProfile && localProfile.uid && !isLockEnabled) {
            console.log("Instant Access: Found local session. Entering app...");
            App.goToPage('chat-list-page');
            App.renderChatList();
            App.loadStoriesRail(); 
        }

        // --- 3. NETWORK LISTENERS ---
        window.addEventListener('online', App.handleNetworkRecovery);
        window.addEventListener('offline', () => App.showToast("Working Offline"));

        // --- 4. BACKGROUND AUTH SYNC ---
        // This runs quietly to verify the session with the server
                                onAuthStateChanged(auth, async (user) => {
    state.currentUser = user;
    
    // ðŸŒŸ 1. INSTANT THEME & UI RECOVERY ðŸŒŸ
    const savedTheme = localStorage.getItem('app-theme');
    if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
    } else {
        document.documentElement.removeAttribute('data-theme');
    }

    const savedWallpaper = localStorage.getItem('chat-wallpaper');
    const savedBubbleColor = localStorage.getItem('chat-bubble-color');
    
    if (savedWallpaper) App.applyWallpaperToUI(savedWallpaper);
    if (savedBubbleColor) {
        document.documentElement.style.setProperty('--bubble-sent', savedBubbleColor);
    }

    // ðŸŒŸ 2. AUTHENTICATED USER LOGIC ðŸŒŸ
    if (user) {
        // --- ðŸ›¡ï¸ SAFETY FIX 1: STOP CORRUPTED EMAIL ERROR (422) ---
        App.initInviteRadar();
        const validEmail = user.email ? String(user.email).trim() : null;

        if (!validEmail || !validEmail.includes('@')) {
            console.error("Firebase Auth: Email address is missing or corrupted.");
            App.showToast("Account error: Email not found");
            return; 
        }

        // --- ðŸ›¡ï¸ SAFETY FIX 2: THE PERMANENT SESSION WALL ---
        const isVerifiedPermanently = localStorage.getItem('gc_otp_verified') === 'true';

        if (!isVerifiedPermanently) {
            document.getElementById('display-user-email').innerText = validEmail;
            App.goToPage('verification-page');
            
            if (!state.generatedOTP && !state.isSendingEmail) {
                console.log("Centralized OTP trigger for:", validEmail);
                state.isSendingEmail = true; 
                await App.sendVerificationEmail(validEmail);
                state.isSendingEmail = false;
            }
            return; 
        }

        // ðŸš€ 3. VERIFIED USER LOGIC (Only runs after OTP is correct) ðŸš€
        const userRef = doc(db, "users", user.uid);
        
        if (typeof BotEngine !== 'undefined') BotEngine.init(); 

        try {
            // Update Online Status
            await updateDoc(userRef, { isOnline: true });
            window.addEventListener("beforeunload", () => updateDoc(userRef, { isOnline: false }));

            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                const userData = docSnap.data();
                
                // ðŸ”„ ðŸŒŸ DATABASE SYNC ðŸŒŸ ðŸ”„
                if (user.email !== userData.email) {
                    console.log("Syncing new verified email to database...");
                    await updateDoc(userRef, { email: user.email });
                    userData.email = user.email; 
                }

                DataManager.saveProfile(userData); 

                // ðŸ‘¥ ðŸŒŸ MULTI-ACCOUNT STASHING ðŸŒŸ ðŸ‘¥
                let accounts = JSON.parse(localStorage.getItem('gc_linked_accounts') || '[]');
                if (!accounts.find(a => a.uid === user.uid)) {
                    accounts.push({
                        uid: user.uid,
                        name: userData.name,
                        photo: userData.photo,
                        email: user.email 
                    });
                    localStorage.setItem('gc_linked_accounts', JSON.stringify(accounts));
                }

                // ðŸ›¡ï¸ SECURITY & SESSION TRACKING
                App.trackSession(); 

                // ðŸ”´ 2.5 YOUTUBE CDN RETURN LOGIC ðŸ”´
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('videoId')) {
                    const vId = urlParams.get('videoId');
                    const sKey = urlParams.get('streamKey');
                    const rtmp = urlParams.get('rtmpUrl');

                    alert(`âœ… YouTube Ready!\n\nRTMP URL: ${rtmp}\nKey: ${sKey}\n\nPaste these into your streaming app!`);

                    const liveId = "live_" + user.uid;
                    await setDoc(doc(db, "lives", liveId), {
                        hostId: user.uid,
                        hostName: userData.name,
                        hostAvatar: userData.photo,
                        active: true,
                        youtubeVideoId: vId,
                        viewerCount: 1,
                        timestamp: Date.now()
                    });

                    window.history.replaceState({}, document.title, "/");
                    App.goToPage('live-broadcast-page');
                }

                // ðŸ”´ REAL-TIME LIVE TRACKER ðŸ”´
                const qLive = query(collection(db, "lives"), where("active", "==", true));
                onSnapshot(qLive, (snapshot) => {
                    state.activeLiveHosts = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        state.activeLiveHosts[data.hostId] = doc.id;
                    });
                    
                    if (document.getElementById('chat-list-page').classList.contains('active')) App.renderChatList();
                    if (document.getElementById('home-page').classList.contains('active')) App.renderCard();
                    if (document.getElementById('matches-page').classList.contains('active')) App.renderVerification();
                });
                
                // ðŸŒŸ 3. BACKGROUND DATA SYNC & NATIVE LISTENERS ðŸŒŸ
                if (typeof webrtc !== 'undefined') webrtc.init(); 
                App.loadFeed(); 
                App.loadProfileData();
                App.loadBlockedUsers(); 
                App.syncGroups(); 
                App.loadStoriesRail(); 

                // ðŸ”” NATIVE NOTIFICATION LISTENER ðŸ””
                // This handles professional "Heads-up" interactions like Reply and Mark as Read
                const isNative = window.Capacitor && window.Capacitor.isNativePlatform();
                if (isNative && !state.notificationListenerAdded) {
                    const { LocalNotifications } = await import('@capacitor/local-notifications');
                    
                    LocalNotifications.addListener('localNotificationActionPerformed', (notification) => {
                        const { actionId, inputValue, notification: { extra } } = notification;

                        // ðŸš€ Handle Quick Reply directly from the notification tray
                        if (actionId === 'reply' && inputValue) {
                            const originalId = state.currentChatId;
                            state.currentChatId = extra.chatId;
                            App.sendMessage(inputValue);
                            state.currentChatId = originalId;
                            App.showToast("Reply sent âœ…");
                        }

                        // âœ… Handle Mark as Read without opening the app
                        if (actionId === 'read') {
                            App.markMessagesRead(extra.chatId);
                            DataManager.clearBadges(extra.chatId);
                            App.showToast("Marked as read");
                        }
                        
                        // ðŸ“± Handle tapping the notification itself to open the chat
                        if (actionId === 'tap' || actionId === 'default') {
                            App.openChat(extra.chatId);
                        }
                    });
                    
                    state.notificationListenerAdded = true; 
                }

                App.startSmartMessageListener(); 
                App.initMovieGestures();
                App.checkDeepLinks();
                App.checkInviteLink();
                App.startPresenceSystem();
                App.listenToGlobalOnlineStatus();
                

                // ðŸŒŸ 4. SECURITY GATEKEEPER ðŸŒŸ
                const isLockEnabled = localStorage.getItem('lock_enabled') === 'true';

                if (isLockEnabled) {
                    App.goToPage('fingerprint-lock-page');
                    const label = document.getElementById('lock-status-label');
                    if (label) label.innerText = "Enabled";
                } else {
                    if (!urlParams.has('videoId')) {
                        App.goToPage('chat-list-page');
                    }
                }
                
            } else {
                App.goToPage('onboard-1');
            }
        } catch (e) {
            console.log("Offline mode or Sync Error:", e);
            if (localStorage.getItem('lock_enabled') === 'true') {
                App.goToPage('fingerprint-lock-page');
            } else {
                App.goToPage('chat-list-page');
            }
        }
    } else {
        // ðŸŒŸ 5. UNAUTHENTICATED PATH (With Switch Shield) ðŸŒŸ
        const isSwitching = localStorage.getItem('gc_switch_intent') === 'true';

        if (isSwitching) {
            App.goToPage('landing-page');
            App.renderAccountPicker(); 
        } else {
            localStorage.removeItem('gc_otp_verified'); 
            App.goToPage('landing-page');
        }
    }
 });
},


        injectStyles: () => {
            const style = document.createElement('style');
            style.innerHTML = `
                .online-dot {
                    width: 12px; height: 12px; 
                    background: #00C853; 
                    border-radius: 50%; 
                    border: 2px solid white; 
                    position: absolute; 
                    bottom: 0; right: 0;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                }
                .chat-online-text {
                    font-size: 11px; 
                    color: #00C853; 
                    font-weight: bold;
                    animation: fadeIn 0.5s;
                }
                @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
            `;
            document.head.appendChild(style);
        },
        
        setupListeners: () => {
    // 1. Google Login (Standard)
    document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

       // 2. ðŸ›¡ï¸ Hardened Email Login (Single-Trigger Mode)
    document.getElementById('email-login-btn').onclick = async () => {
        const email = document.getElementById('email-input').value.trim();
        const pass = document.getElementById('password-input').value;
        
        if(!email || !pass) return alert("Enter email & password");

        try {
            // Step 1: Just attempt to sign in. 
            // The logic in onAuthStateChanged will detect the login and trigger the OTP.
            await signInWithEmailAndPassword(auth, email, pass);
            
        } catch (error) {
            // Handle New User Signup (Auto-detected)
            if(error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                 if(confirm("Account not recognized. Create a new account with these details?")) {
                     try { 
                         // Step 2: Create user. 
                         // Again, the listener will handle the OTP trigger once creation is successful.
                         await createUserWithEmailAndPassword(auth, email, pass);
                     }
                     catch (signupError) { 
                        if (signupError.code === 'auth/email-already-in-use') {
                            alert("âŒ Incorrect password for this email.");
                        } else {
                            alert("Signup Error: " + signupError.message);
                        }
                     }
                 }
            } else { 
                alert("Login Error: " + error.message); 
            }
        }
    };
    
    // 3. Page & Feature Listeners
    document.getElementById('get-location-btn').onclick = App.getLocation;
    document.getElementById('profile-upload').onchange = App.handleProfileUpload;
    document.getElementById('msg-input').onkeypress = (e) => { 
        if(e.key === 'Enter') App.sendMessage(); 
    };
    
    // 4. WebRTC Call Listeners
    document.getElementById('start-video-btn').onclick = () => webrtc.startCall(state.currentChatId, true);
    document.getElementById('start-voice-btn').onclick = () => webrtc.startCall(state.currentChatId, false);
    
    // 5. Settings Listener
    const saveBtn = document.getElementById('save-btn');
    if(saveBtn) saveBtn.onclick = App.saveSettings;
        },

        // --- PRESENCE SYSTEM (ONLINE STATUS) ---
        startPresenceSystem: () => {
            const updateStatus = async () => {
                if(state.currentUser) {
                    const userRef = doc(db, "users", state.currentUser.uid);
                    await updateDoc(userRef, { lastActive: Date.now() });
                }
            };
            updateStatus(); // Immediate
            setInterval(updateStatus, 60000); // Heartbeat every 1 minute
        },

        listenToGlobalOnlineStatus: () => {
            // Listen to users collection to update green dots in real-time
            // Note: In production with millions of users, do not listen to entire collection. 
            // Query only friends/chats. For this prototype, we listen to all.
            const q = query(collection(db, "users")); 
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    state.onlineUsers[change.doc.id] = data.lastActive || 0;
                });
                // Re-render chat list to update dots if visible
                if(document.getElementById('chat-list-page').classList.contains('active')) {
                    App.renderChatList();
                }
                // Update active chat header if open
                if(state.currentChatId && document.getElementById('chat-room').classList.contains('active')) {
                    App.updateChatHeaderStatus();
                }
            });
        },

        isUserOnline: (uid) => {
            const lastActive = state.onlineUsers[uid];
            if(!lastActive) return false;
            // Online if active in last 2 minutes
            return (Date.now() - lastActive) < 120000; 
        },

        // --- NETWORK & OFFLINE QUEUE ---
        handleNetworkRecovery: async () => {
            App.showToast("Back online! Sending pending messages...");
            const queue = [...state.pendingMessages];
            state.pendingMessages = []; // Clear queue locally
            
            for(const msg of queue) {
                await App.sendMessage(msg.text, msg.img, msg.isSystem, msg.audio, true); // true = retry
            }
        },

                                goToPage: (pageId) => {
            // 1. Handle Page Visibility
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
            
            // 2. Handle Bottom Navigation Item Highlighting
            document.querySelectorAll('.bottom-nav .nav-item').forEach(i => i.classList.remove('active'));
            
            if(pageId === 'home-page') document.getElementById('nav-home').classList.add('active');
            if(pageId === 'matches-page') { document.getElementById('nav-matches').classList.add('active'); App.renderMatches(); }
            if(pageId === 'requests-page') { 
                document.getElementById('nav-requests').classList.add('active'); 
                App.loadRequests(); 
            }
            if(pageId === 'chat-list-page') { 
                document.getElementById('nav-chat').classList.add('active'); 
                App.clearNotificationBadge();
                App.renderChatList(); 
            }
            
            // ðŸŒŸ DATA REFRESH: Ensures screens are never blank when opened
            if (pageId === 'chat-color-page') {
                App.renderColorPicker();
            }
            
            if (pageId === 'chat-backup-page') {
                App.initBackupUI(); // Refresh emails and timestamps
            }

            // ðŸŒŸ RESTORE PAGE RESET: Ensures the UI is fresh when entering
            if (pageId === 'restore-chat-page') {
                if(document.getElementById('restore-info-box')) document.getElementById('restore-info-box').style.display = 'none';
                if(document.getElementById('restore-progress-container')) document.getElementById('restore-progress-container').style.display = 'none';
                if(document.getElementById('restore-start-btn')) document.getElementById('restore-start-btn').style.display = 'block';
                if(document.getElementById('restore-skip-btn')) document.getElementById('restore-skip-btn').style.display = 'block';
            }

            // ðŸŒŸ HELP PAGE LOGIC: Ensure it doesn't conflict with main-nav
            if (pageId === 'help-page') {
                // Add any specific help-page initialization here if needed
            }
            
            // ðŸŒŸ NAVIGATION BAR VISIBILITY LOGIC ðŸŒŸ
            if (targetPage) {
                const nav = document.getElementById('main-nav');
                if (nav) {
                    // If the target page is 'full-screen', we hide the bottom bar.
                    // If you want the bar to show on the Help page, make sure the Help page 
                    // DOES NOT have the 'full-screen' class in your HTML.
                    nav.style.display = targetPage.classList.contains('full-screen') ? 'none' : 'flex';
                }
            }
        },

                    // --- ðŸ“¹ NAVIGATION & CAMERA ENGINE ---
    openUploadPage: async () => {
    // 1. Switch UI to Upload Page
    App.goToPage('upload-page');
    
    // 2. Persistent Stream: Reuse hardware if already active
    const video = document.getElementById('camera-preview');
    try {
        if (!state.cameraStream) {
            state.cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: state.facingMode || 'user' }, 
                audio: true 
            });
        }
        
        if (video) {
            video.srcObject = state.cameraStream;
            // Apply mirror effect based on camera facing
            video.style.transform = state.facingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
        }
    } catch (e) {
        console.error("Camera Error:", e);
        App.showToast("Camera access denied");
    }
 },


    closeUploadPage: () => {
        if (state.cameraStream) {
            state.cameraStream.getTracks().forEach(track => track.stop());
        }
        App.goToPage('home-page');
    },

    handleUniversalUpload: (input) => {
    const files = Array.from(input.files);
    if (files.length === 0) return;

    // 1. ðŸ›¡ï¸ LIMIT CHECK: up to 17 pictures
    if (files.length > 17) {
        alert("You can only upload up to 17 items at once.");
        return;
    }

    const firstFile = files[0];

    // 2. ðŸ“¹ PATH A: VIDEO UPLOAD (Single)
    if (firstFile.type.startsWith('video/')) {
        state.currentUploadFile = firstFile;
        const url = URL.createObjectURL(firstFile);
        App.openEditor(url); // Redirects to video editor
        return;
    }

    // 3. ðŸ–¼ï¸ PATH B: MULTI-IMAGE CAROUSEL
    if (firstFile.type.startsWith('image/')) {
        state.pendingImages = [];
        let processed = 0;

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.pendingImages.push(e.target.result);
                processed++;
                
                // Once all images are converted to Base64/DataURL
                if (processed === files.length) {
                    App.showToast(`${files.length} images ready`);
                    // Open editor with the first image as preview
                    App.openEditor(state.pendingImages[0], false, true); 
                }
            };
            reader.readAsDataURL(file);
        });
    }
 },


        // --- ðŸ“¹ SYNCED EDITOR ENGINE ---
    openEditor: (videoUrl) => {
        // 1. Stop the camera hardware to prevent conflicts
        if (state.cameraStream) {
            state.cameraStream.getTracks().forEach(track => track.stop());
            state.cameraStream = null;
        }

        // 2. Navigate to the editor screen
        App.goToPage('editor-page');
        
        const video = document.getElementById('editor-preview');
        if (!video) return;

        video.src = videoUrl;
        video.loop = true; // TikTok style infinite loop

        // ðŸŒŸ 3. AUDIO SYNC LOGIC
        if (state.selectedMusicId) {
            // Mute the raw video audio so only the background music plays
            video.muted = true; 
            
            // Trigger the hidden YouTube player
            App.previewSong(state.selectedMusicId);
            App.showToast(`Previewing with: ${state.selectedMusicName}`);
        } else {
            // If no background music, keep the video's original sound
            video.muted = false; 
        }

        // Play the preview
        video.play().catch(e => console.log("Preview autoplay was blocked by browser."));

        // ðŸŒŸ 4. HANDLE RE-SYNC ON LOOP
        // If the video restarts, we ensure the music stays in sync
        video.onplay = () => {
            if (state.selectedMusicId) {
                App.previewSong(state.selectedMusicId);
            }
        };
    },


        // --- ðŸŽ¬ INTEGRATED MOVIE ENGINE (With CORS Fix & Trim Logic) ---
publishVideo: async (event) => {
    let blob = null;
    let isPhotoSlide = false;

    // ðŸŒŸ 1. DYNAMIC MEDIA DETECTION (Fixes "No media found")
    if (state.pendingImages && state.pendingImages.length > 0) {
        // SCENARIO A: 17-Picture Photo Slide
        isPhotoSlide = true;
    } else if (state.currentUploadFile) {
        // SCENARIO B: Recorded Video or Gallery Upload
        blob = state.currentUploadFile;
    } else if (state.videoChunks && state.videoChunks.length > 0) {
        // SCENARIO C: Recorded Video Chunks Fallback
        blob = new Blob(state.videoChunks, { type: 'video/mp4' });
    } else {
        return alert("No media found! Please record, upload a video, or select pictures.");
    }

    const btn = event.target;
    const originalBtnText = btn.innerText;
    btn.innerText = "Connecting...";
    btn.disabled = true;

    try {
        let finalMediaUrl = "";
        let carouselImages = null;

        // ðŸŒŸ 2. BRANCHING LOGIC: PROCESSING & UPLOADING
        if (isPhotoSlide) {
            carouselImages = state.pendingImages;
            finalMediaUrl = "carousel_post"; 
        } else {
            // VIDEO PATH: Binary Upload to Gumlet
            const GUMLET_API_KEY = "gumlet_d8f29a865416f3207ef09f6a2572ab98";
            const COLLECTION_ID = "6954531ff3928b38fc05f1f7";

            const gumletUrl = `https://api.gumlet.com/v1/video/assets/upload`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(gumletUrl)}`;

            const assetRes = await fetch(proxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${GUMLET_API_KEY}`, 
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({ format: "mp4", collection_id: COLLECTION_ID })
                })
            });

            const proxyData = await assetRes.json();
            const assetData = JSON.parse(proxyData.contents);
            if (!assetData.upload_url) throw new Error("Gumlet handshake failed.");

            const uploadUrl = assetData.upload_url;
            const assetId = assetData.asset_id;

            // Execute Binary S3 Upload
            await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', uploadUrl);
                xhr.setRequestHeader('Content-Type', blob.type);
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        btn.innerText = `Uploading ${pct}%`;
                    }
                };
                xhr.onload = () => (xhr.status === 200 || xhr.status === 201) ? resolve() : reject();
                xhr.onerror = reject;
                xhr.send(blob);
            });

            finalMediaUrl = `https://video.gumlet.io/${COLLECTION_ID}/${assetId}/main.mp4`;
        }

        // ðŸŒŸ 3. SAVE TO FIRESTORE (Now Includes Persistent Filters)
        const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        await addDoc(collection(db, "videos"), {
            ownerId: state.currentUser.uid,
            type: isPhotoSlide ? 'images' : 'video',
            videoUrl: !isPhotoSlide ? finalMediaUrl : "",
            images: isPhotoSlide ? carouselImages : null,
            caption: state.pendingCaption || "",
            
            // âœ¨ THE FILTER FIX: Saves your chosen effect string (e.g., grayscale(1))
            filter: state.activeFilter || "none", 
            
            textOverlay: state.pendingTextMetadata || null,
            trimStart: state.trimStart || 0,
            trimEnd: state.trimEnd || 17,
            musicId: state.selectedMusicId || null,
            timestamp: Date.now(),
            likes: [],
            views: 0
        });

        // ðŸŒŸ 4. CLEANUP & RESET
        state.pendingCaption = "";
        state.pendingTextMetadata = null;
        state.pendingImages = [];
        state.videoChunks = [];
        state.currentUploadFile = null;
        state.activeFilter = "none"; // Reset filter after post
        
        App.showToast("âœ… Published successfully!");
        App.goToPage('movie-page');
        await App.loadClips(); 

    } catch (e) {
        console.error("Critical Publish Error:", e);
        App.showToast("Upload failed. Check connection.");
        btn.innerText = originalBtnText;
        btn.disabled = false;
    }
 },
                                 // --- VOICE & INPUT LOGIC (FIXED) ---
        
        // 1. Detect Typing
            // 1. Detect Typing & Link Previews
    onInputType: () => {
    const input = document.getElementById('msg-input');
    const icon = document.getElementById('action-icon');
    const val = input.value;
    const maxChars = 1000; // Professional character limit

    // --- 1. Character Limit Protection ---
    // Instantly stops adding text if the limit is reached
    if (val.length > maxChars) {
        input.value = val.substring(0, maxChars);
        App.showToast("Message too long");
        if (navigator.vibrate) navigator.vibrate(50);
    }

    // --- 2. Multiline Auto-Resize ---
    // Forces the textarea to grow vertically based on content
    input.style.height = 'auto';
    input.style.height = (input.scrollHeight) + 'px';

    // --- 3. Toggle Send/Mic Icon ---
    const trimmedVal = input.value.trim();
    if(icon) icon.className = trimmedVal.length > 0 ? "fa-solid fa-paper-plane" : "fa-solid fa-microphone";

    // --- 4. Rich Link Detection Logic ---
    // Checks for specific join/channel parameters to show previews
    if (trimmedVal.includes("?join=") || trimmedVal.includes("?channel=")) {
        const match = trimmedVal.match(/https?:\/\/[^\s]+/);
        if (match) {
            try {
                const url = new URL(match[0]);
                const groupId = url.searchParams.get('join');
                const channelId = url.searchParams.get('channel');
                
                // Trigger the fetch for the preview card
                App.fetchLinkPreview(groupId || channelId);
            } catch (e) {
                console.error("Link detection error:", e);
            }
        }
    } else {
        // Hide the preview bar if the link is removed
        App.closeLinkPreview();
    }
 },


    // 2. Toggle View Once Mode
    toggleViewOnce: () => {
        state.isViewOnce = !state.isViewOnce;
        const btn = document.getElementById('view-once-btn');
        if(btn) {
            if(state.isViewOnce) btn.classList.add('view-once-active');
            else btn.classList.remove('view-once-active');
        }
    },

    // 3. Handle Click (Send Text)
    handleSendClick: () => {
        const input = document.getElementById('msg-input');
        const icon = document.getElementById('action-icon');
        const val = input.value.trim();

        if (val.length > 0) {
            // VITAL: The 4th argument is null so the system doesn't confuse text for audio
            App.sendMessage(val, null, false, null);
            
            // UI Reset
            input.value = "";
            if(icon) icon.className = "fa-solid fa-microphone"; 
            
            // Ensure the link preview bar closes after the message is sent
            App.closeLinkPreview();
        } else if (state.isLocked) {
            // If no text but mic is locked, stop and send the audio instead
            App.stopRecording(true);
        }
    },

        // 5. Swipe to Lock
        handleMicMove: (e) => {
            // Only run if actually recording and not yet locked
            if (!state.isRecording || state.isLocked) return;
            
            const currentY = e.touches[0].clientY;
            const diff = state.touchStartY - currentY; 
            if (diff > 50) App.lockRecording();
        },

        // 6. Release to Send
        handleMicEnd: (e) => {
            const val = document.getElementById('msg-input').value.trim();
            
            // SAFETY CHECK: If text exists, ignore this event
            if (val.length > 0) return; 

            // If locked, don't stop on release (wait for click)
            if (state.isLocked) return; 
            
            // Only send if we were actually recording
            if (state.isRecording) {
                App.stopRecording(true); 
            }
        },

        getLocation: () => {
            if (!navigator.geolocation) return alert("Not supported");
            document.getElementById('location-status').innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(
                pos => {
                    state.locationData = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    document.getElementById('location-status').innerHTML = `<i class="fa-solid fa-check"></i> Found!`;
                    document.getElementById('onboard-2-next').classList.remove('hidden');
                },
                err => { document.getElementById('location-status').innerText = "Error: " + err.message; }
            );
        },

        handleProfileUpload: (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profile-preview').src = e.target.result;
                    state.profileBase64 = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        },

        handleSettingsImage: (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if(document.getElementById('edit-profile-preview')) {
                        document.getElementById('edit-profile-preview').src = e.target.result;
                    }
                    state.settingsBase64 = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        },

            completeOnboarding: async () => {
        const bio = document.getElementById('onboard-bio').value;
        const name = document.getElementById('onboard-name') ? document.getElementById('onboard-name').value : (state.currentUser.displayName || "User");
        const photo = state.profileBase64 || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        try {
            const userData = {
                uid: state.currentUser.uid,
                name: name,
                bio: bio,
                photo: photo, 
                email: state.currentUser.email,
                location: state.locationData || "Unknown",
                isVerified: false,
                lastActive: Date.now()
            };

            // 1. Save to Firebase
            await setDoc(doc(db, "users", state.currentUser.uid), userData);
            
            // 2. Save to Phone Memory
            DataManager.saveProfile(userData); 

            // ðŸŒŸ 3. REDIRECT TO RESTORE PAGE (Instead of home-page) ðŸŒŸ
            App.goToPage('restore-chat-page');
            
            // Start background sync so data is ready if they skip
            App.syncGroups();
            App.loadFeed();
            
        } catch (e) {
            alert("Error saving: " + e.message);
        }
    },

        saveSettings: async () => {
            if(!state.currentUser) return alert("Not logged in");
            const btn = document.getElementById('save-btn');
            if(btn) btn.innerText = "Saving...";
            try {
                const bio = document.getElementById('edit-bio').value;
                const job = document.getElementById('edit-job').value;
                const company = document.getElementById('edit-company').value;
                const school = document.getElementById('edit-school').value;
                const city = document.getElementById('edit-city').value;
                let newPhoto = state.settingsBase64;
                if(!newPhoto) {
                     const existing = DataManager.getProfile();
                     newPhoto = existing.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                }
                await updateDoc(doc(db, "users", state.currentUser.uid), {
                    bio: bio, photo: newPhoto, job: job, company: company, school: school, city: city
                });
                DataManager.saveProfile({ 
                    uid: state.currentUser.uid, name: DataManager.getProfile().name, 
                    bio, job, company, school, city, photo: newPhoto 
                });
                alert("Profile Updated!");
                if(btn) btn.innerText = "Save";
            } catch (e) {
                alert("SAVE FAILED: " + e.message); 
                if(btn) btn.innerText = "Save";
            }
        },

                // --- Discovery Feed Logic ---
        loadFeed: async () => {
        try {
            const container = document.querySelector('.card-stack');
            if (container) {
                container.innerHTML = '<div style="padding-top:100px; text-align:center; color:grey;"><i class="fa-solid fa-spinner fa-spin" style="font-size:30px; margin-bottom:15px;"></i><br>Finding new people...</div>';
            }
            
            // ðŸ  HOME PAGE LOGIC: Only load users for Matching/Cards
            const { getDocs, collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const querySnapshot = await getDocs(collection(db, "users"));
            let tempFeed = [];

            querySnapshot.forEach((docSnap) => {
                const u = docSnap.data();
                const uid = u.uid || docSnap.id;
                // Filter out myself and private profiles
                if (uid !== state.currentUser.uid && u.isPrivate !== true) {
                    tempFeed.push({ ...u, uid: uid });
                }
            });

            state.feed = tempFeed;
            state.feedIndex = 0;
            App.renderCard(); 
        } catch(e) { 
            console.error("Feed Load Error: ", e.message); 
        }
    } ,

    loadClips: async () => {
        try {
            const { getDocs, collection, query, orderBy, getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // ðŸŽ¬ MOVIE PAGE LOGIC: Load documents from "videos" collection
            const videoQuery = query(collection(db, "videos"), orderBy("timestamp", "desc"));
            const videoSnapshot = await getDocs(videoQuery);
            let tempClips = [];

            for (const videoDoc of videoSnapshot.docs) {
                const v = videoDoc.data();
                const userSnap = await getDoc(doc(db, "users", v.ownerId));
                const userData = userSnap.exists() ? userSnap.data() : {};

                tempClips.push({
                    id: videoDoc.id, // ðŸŒŸ Unique ID per video post
                    ...v,
                    uid: v.ownerId, 
                    name: userData.name || "User",
                    photo: userData.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                    likes: v.likes || [] // ðŸŒŸ Persistent real likes from DB
                });
            }

            state.clips = tempClips; // Movie page uses a separate "clips" array
            state.clipIndex = 0;
            App.renderMovie();
        } catch(e) { 
            console.error("Clips Load Error: ", e.message); 
        }
    } ,
    
    refreshFeed: () => App.loadFeed() ,



        renderCard: () => {
        const container = document.querySelector('.card-stack');
        if (!container) return;

        // ðŸŒŸ LOCAL HIDDEN FILTER ðŸŒŸ
        const hiddenChats = JSON.parse(localStorage.getItem('hidden_chats') || '[]');

        // Skip users that Kelvin specifically chose to hide
        while (state.feedIndex < state.feed.length && hiddenChats.includes(state.feed[state.feedIndex].uid)) {
            state.feedIndex++;
        }

        // Check if we reached the end
        if (state.feedIndex >= state.feed.length) {
            container.innerHTML = `
                <div style="text-align:center; margin: auto; padding: 20px;">
                    <i class="fa-solid fa-person-rays" style="font-size: 50px; color: #ddd; margin-bottom: 15px;"></i>
                    <h3>No more users found</h3>
                    <p style="color: gray; font-size: 14px; margin-bottom: 20px;">We've run out of people to show you for now.</p>
                    <button class="btn btn-primary" onclick="app.loadFeed()" style="width: auto; padding: 10px 30px;">Refresh Discovery</button>
                </div>`;
            return;
        }

        const user = state.feed[state.feedIndex];
        
        // ðŸ”´ LIVE HUD LOGIC ðŸ”´
        const liveId = state.activeLiveHosts[user.uid];
        // THE FIX: Use app.joinLiveAsViewer (lowercase)
        const liveBadge = liveId ? `<span class="live-badge-home" onclick="event.stopPropagation(); app.joinLiveAsViewer('${liveId}')">LIVE</span>` : '';
        
        const badgeHtml = user.isVerified 
            ? `<i class="fa-solid fa-circle-check" style="color: #00a884; font-size: 18px; margin-left:5px;"></i>` 
            : '';
            
        const safeName = user.name ? user.name.replace(/'/g, "\\'") : "User";
        const safePhoto = user.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
        
        // Update UI
        container.innerHTML = `
            <div class="user-card" onclick="${liveId ? `app.joinLiveAsViewer('${liveId}')` : ''}">
                <img src="${safePhoto}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'">
                <div class="card-info">
                    <h2 style="font-size: 28px; display: flex; align-items: center; gap:10px;">
                        ${safeName} ${badgeHtml} ${liveBadge}
                    </h2>
                    <p style="font-size: 16px; margin-top: 5px;"><i class="fa-solid fa-quote-left" style="font-size: 12px; opacity: 0.5; margin-right: 8px;"></i>${user.bio || 'Discover. Chat. Bond.'}</p>
                </div>
                <div class="card-actions">
                    <div class="action-btn" style="color: var(--danger)" onclick="event.stopPropagation(); app.nextCard()">
                        <i class="fa-solid fa-xmark"></i>
                    </div>
                    <div class="action-btn" style="color: var(--primary)" onclick="event.stopPropagation(); app.likeUser('${user.uid}')">
                        <i class="fa-solid fa-heart"></i>
                    </div>
                    <div class="action-btn" style="color: var(--secondary)" onclick="event.stopPropagation(); app.openChat('${user.uid}', '${safeName}', '${safePhoto}')">
                        <i class="fa-solid fa-comment-dots"></i>
                    </div>
                </div>
            </div>`;
    } ,

    nextCard: () => {
        state.feedIndex++;
        app.renderCard(); 
    } ,

        likeUser: async (targetUid) => {
            try {
                await addDoc(collection(db, "likes"), {
                    from: state.currentUser.uid,
                    to: targetUid,
                    timestamp: Date.now()
                });
                DataManager.likeUser(targetUid);
                alert("Request Sent!");
            } catch(e) { console.error("Like failed", e); }
            App.nextCard();
        },

        loadRequests: async () => {
            const page = document.getElementById('requests-page');
            const nav = page.querySelector('.top-nav').outerHTML;
            page.innerHTML = nav + '<div style="padding:20px; text-align:center; color:gray;">Loading requests...</div>';

            try {
                const q = query(collection(db, "likes"), where("to", "==", state.currentUser.uid));
                const snapshot = await getDocs(q);
                let contentHTML = '<div style="flex:1; overflow-y:auto;">';
                if (snapshot.empty) {
                    contentHTML += '<p style="text-align:center; color:grey; margin-top:50px;">No new requests.</p>';
                } else {
                    for (const docSnap of snapshot.docs) {
                        const likeData = docSnap.data();
                        const userSnap = await getDoc(doc(db, "users", likeData.from));
                        if(userSnap.exists()){
                            const u = userSnap.data();
                            const safeName = u.name ? u.name.replace(/'/g, "\\'") : "User";
                            const safePhoto = u.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                            contentHTML += `
                                <div class="list-item">
                                    <img src="${safePhoto}" class="list-avatar">
                                    <div style="flex:1;">
                                        <b>${safeName}</b><br><small>Sent you a request</small>
                                    </div>
                                    <div class="action-btn" style="width:40px; height:40px; color:white; background:var(--primary); font-size:14px; margin-left:10px;" onclick="app.openChat('${u.uid}', '${safeName}', '${safePhoto}')"><i class="fa-solid fa-comment"></i></div>
                                </div>`;
                        }
                    }
                }
                contentHTML += '</div>';
                page.innerHTML = nav + contentHTML;
            } catch (e) { console.log(e); }
        },

        markMessagesRead: async (partnerId) => {
            const q = query(collection(db, "messages"), 
                where("senderId", "==", partnerId), 
                where("receiverId", "==", state.currentUser.uid),
                where("status", "!=", "read")
            );
            const snapshot = await getDocs(q);
            snapshot.forEach(async (docSnap) => {
                await updateDoc(doc(db, "messages", docSnap.id), { status: "read" });
            });
        },

            viewContactInfo: async () => {
    const partner = state.currentChatPartner;
    if (!partner) return;

    // ðŸŒŸ Close popup if it was open (handles "tap on box again to view profile" logic)
    if (typeof App.closeProfilePopup === 'function') {
        App.closeProfilePopup();
    }

    App.goToPage('user-info-page');

    // 1. Set temporary loading state
    document.getElementById('info-name').innerText = partner.name;
    document.getElementById('info-avatar').src = partner.avatar;
    document.getElementById('info-bio').innerText = "Loading...";
    const phoneEl = document.getElementById('info-phone');
    if (phoneEl) phoneEl.innerText = "Loading...";

    try {
        // 2. Fetch fresh data from Firestore to get verification and phone details
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const snap = await getDoc(doc(db, "users", partner.id));
        
        if (snap.exists()) {
            const u = snap.data();
            
            // ðŸŒŸ VERIFICATION BADGE LOGIC ðŸŒŸ
            const badgeHtml = u.isVerified 
                ? ` <i class="fa-solid fa-circle-check" style="color: #00a884; font-size: 18px; margin-left: 8px;" title="Verified Profile"></i>` 
                : '';

            document.getElementById('info-name').innerHTML = u.name + badgeHtml;
            document.getElementById('info-bio').innerText = u.bio || "Available";
            
            if (phoneEl) phoneEl.innerText = u.phone || "No phone listed";

            // 3. Update UI state based on Local Saved Contacts
            const savedContacts = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
            const isSaved = savedContacts.includes(partner.id);
            
            const saveIcon = document.getElementById('save-contact-icon');
            const saveText = document.getElementById('save-contact-text');
            
            if (saveIcon && saveText) {
                saveIcon.className = isSaved ? "fa-solid fa-user-check" : "fa-solid fa-user-plus";
                saveText.innerText = isSaved ? "Saved" : "Save";
            }
        }
        
        // ðŸŒŸ BLOCK / UNBLOCK BUTTON SYNC ðŸŒŸ
        // Updates the Block button text and color based on current status
        App.updateInfoPageButtons(partner.id);
    } catch (e) {
        console.error("Error loading contact info:", e);
        App.showToast("Failed to load profile details");
    }
 },


           // --- UPDATED: HIDE ONLINE STATUS BASED ON PRIVACY ---
        updateChatHeaderStatus: async () => {
            const nameEl = document.getElementById('chat-room-name');
            const avatarEl = document.getElementById('chat-room-avatar');
            const partnerId = state.currentChatId;

            if (!partnerId || partnerId.startsWith('group_')) return;

            // 1. Get Partner's Privacy Settings from Firestore
            let privacy = {};
            try {
                const snap = await getDoc(doc(db, "users", partnerId));
                if (snap.exists()) privacy = snap.data().privacy || {};
            } catch (e) {}

            const isOnline = App.isUserOnline(partnerId);
            const partnerName = state.currentChatPartner.name;

            // 2. CHECK PRIVACY RULES
            let showOnline = true;
            if (privacy.lastSeen === 'Nobody') {
                showOnline = false;
            } else if (privacy.lastSeen === 'My Contacts') {
                // WhatsApp Rule: Only show if the user is in my local saved list
                const saved = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
                showOnline = saved.includes(partnerId);
            }

            // 3. RENDER UI
            const existingDot = avatarEl.parentElement.querySelector('.online-dot');
            
            if (isOnline && showOnline) {
                if (!existingDot) {
                    const dot = document.createElement('div');
                    dot.className = 'online-dot';
                    avatarEl.parentElement.style.position = 'relative';
                    avatarEl.parentElement.appendChild(dot);
                }
                nameEl.innerHTML = `${partnerName} <div class="chat-online-text">Online</div>`;
            } else {
                if (existingDot) existingDot.remove();
                nameEl.innerText = partnerName;
            }
        },
                                               openChat: async (partnerId, partnerName, avatarUrl) => {
    if(!partnerId) return alert("Error: User ID is missing.");
    
    // ðŸŒŸ 1. UI RESET & STATE SYNC
    DataManager.clearBadges(partnerId);
    state.currentChatId = partnerId;
    state.currentChatPartner = { id: partnerId, name: partnerName, avatar: avatarUrl };
    
    const msgInput = document.getElementById('msg-input');
    if (msgInput) msgInput.value = "";
    
    const nameEl = document.getElementById('chat-room-name');
    const avatarEl = document.getElementById('chat-room-avatar');
    
    // ðŸŒŸ 2. PERSISTENT VERIFICATION BADGE LOGIC
    let badgeHtml = "";
    const { doc, getDoc, onSnapshot, query, collection, orderBy, where, or, and } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    try {
        const snap = await getDoc(doc(db, "users", partnerId));
        
        // --- âœ… NEW SCALLOPED BADGE INTEGRATION ---
        if (snap.exists() && snap.data().isVerified) {
            badgeHtml = `<span class="verified-badge" style="background-color: white; filter: brightness(0) invert(1);"></span>`;
        }
    } catch(e) { 
        console.error("Header verification check failed", e); 
    }

    if (nameEl) nameEl.innerHTML = partnerName + badgeHtml;
    if (avatarEl) avatarEl.src = avatarUrl || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
    
    // --- ðŸŒŸ 3. TYPING STATUS LISTENER ---
    if (state.chatListener) state.chatListener();

    state.chatListener = onSnapshot(doc(db, "chats", partnerId), (docSnap) => {
        if (!docSnap.exists()) return;
        
        const chatData = docSnap.data();
        const otherUid = partnerId; 
        const statusLabel = document.getElementById('chat-user-status');

        if (statusLabel) {
            if (chatData.typing && chatData.typing[otherUid] === true) {
                statusLabel.innerText = "typing...";
                statusLabel.style.color = "#ff4b7d"; 
            } else {
                statusLabel.innerText = "Available";
                statusLabel.style.color = "rgba(255,255,255,0.8)";
            }
        }
    });

    // --- ðŸŒŸ 4. SMART HEADER DYNAMIC ROUTING ---
    const headerNav = nameEl.parentElement.parentElement; 
    if (partnerId.startsWith('group_')) {
        headerNav.onclick = () => App.openGroupInfo();
    } else if (partnerId.startsWith('channel_')) {
        headerNav.onclick = () => App.openChannelProfile();
    } else {
        headerNav.onclick = () => App.viewContactInfo();
    }
    headerNav.style.cursor = "pointer";

    // --- 5. HIDE CALL ICONS FOR CHANNELS ---
    const videoBtn = document.getElementById('start-video-btn');
    const voiceBtn = document.getElementById('start-voice-btn');
    if (partnerId.startsWith('channel_')) {
        if(videoBtn) videoBtn.style.display = 'none';
        if(voiceBtn) voiceBtn.style.display = 'none';
    } else {
        if(videoBtn) videoBtn.style.display = 'block';
        if(voiceBtn) voiceBtn.style.display = 'block';
    }

    // --- 6. RESET UI & BLOCK CHECKS ---
    const inputArea = document.querySelector('.chat-input-area');
    if(inputArea) {
        inputArea.classList.remove('blocked'); 
        inputArea.style.display = 'flex'; 
    }
    
    if (!partnerId.startsWith('group_') && !partnerId.startsWith('channel_') && state.blockedUsers && state.blockedUsers.includes(partnerId)) {
        if(inputArea) inputArea.classList.add('blocked');
    }

    App.clearNotificationBadge();
    App.refreshChatFooter();
    App.markMessagesRead(partnerId);
    App.renderMessages(partnerId);
    App.goToPage('chat-room');
    
    // --- 7. START REAL-TIME MESSAGE LISTENER ---
    if (state.activeChatListener) {
        state.activeChatListener(); 
        state.activeChatListener = null;
    }

    let q;
    if (partnerId.startsWith('group_') || partnerId.startsWith('channel_')) {
        q = query(collection(db, "chats", partnerId, "messages"), orderBy("timestamp", "asc"));
    } else {
        q = query(
            collection(db, "messages"),
            or(
                and(where("senderId", "==", state.currentUser.uid), where("receiverId", "==", partnerId)),
                and(where("senderId", "==", partnerId), where("receiverId", "==", state.currentUser.uid))
            ),
            orderBy("timestamp", "asc")
        );
    }
    
    state.activeChatListener = onSnapshot(q, (snapshot) => {
        let hasNew = false;
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const data = change.doc.data();
                DataManager.saveMessage(partnerId, { id: change.doc.id, ...data });
                hasNew = true;
            }
        });
        
        if(hasNew) {
            App.renderMessages(partnerId);
            const container = document.getElementById('message-container');
            if(container) container.scrollTop = container.scrollHeight;
        }
    });
 },
    
                                                            // --- SEND MESSAGE (Final Version with Gift Logic Fix) ---
sendMessage: async (text = null, imgData = null, isSystem = false, audioData = null, isRetry = false, isSticker = false, msgTypeOverride = null, payload = null) => {
    const input = document.getElementById('msg-input');
    
    // 1. Resolve Message Text (handles Voice-to-Text transcriptions)
    const msgText = (audioData && typeof audioData === 'string' && audioData.startsWith('data:audio')) 
        ? (state.lastTranscription || "") 
        : (text || (input ? input.value.trim() : ""));
    
    // ðŸ›¡ï¸ Official Support Ticket Logic (Logs to 'reports' collection)
    if (state.currentChatId === "global_connect_official" && !isSystem) {
        try {
            const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            await addDoc(collection(db, "reports"), {
                userId: state.currentUser.uid,
                message: msgText,
                timestamp: Date.now(),
                type: "support_ticket"
            });
        } catch (e) { console.error("Report log failed", e); }
    }
    
    // Safety Validation
    if ((!msgText && !imgData && !audioData && !payload) || !state.currentChatId) return;

    // 2. CHECK IF I AM BLOCKED (Direct Messages Only)
    if (!state.currentChatId.startsWith('group_') && !state.currentChatId.startsWith('channel_') && state.currentChatId !== BotEngine.MASTER_ID) {
        try {
            const partnerRef = doc(db, "users", state.currentChatId);
            const partnerSnap = await getDoc(partnerRef);
            if (partnerSnap.exists()) {
                const blockedList = partnerSnap.data().blocked || [];
                if (blockedList.includes(state.currentUser.uid)) {
                    // FAKE SEND: Local optimistic UI for blocked state
                    const fakeMsg = {
                        text: msgText, type: 'text', senderId: state.currentUser.uid, 
                        receiverId: state.currentChatId, timestamp: Date.now(), status: 'sent', time: 'Now'
                    };
                    DataManager.saveMessage(state.currentChatId, fakeMsg);
                    App.renderMessages(state.currentChatId);
                    if(input) input.value = "";
                    return; 
                }
            }
        } catch(e) { console.error("Block check failed", e); }
    }

    // 3. MASTER BOT LOGIC (BotFather)
    if (state.currentChatId === BotEngine.MASTER_ID && msgText && !isSystem) {
        BotEngine.processCommand(msgText, state.currentUser.uid);
    }
    
    // 4. âš™ï¸ DATA PREPARATION âš™ï¸
    let msgType = msgTypeOverride; 

    if (!msgType) {
        if (audioData && typeof audioData === 'string' && audioData.startsWith('data:audio')) {
            msgType = 'audio';
        } else if (imgData) {
            msgType = isSticker ? 'sticker' : 'image';
        } else {
            msgType = 'text';
        }
    }

    // 5. DATABASE PATH SELECTION
    const isGroupOrChannel = state.currentChatId.startsWith('group_') || state.currentChatId.startsWith('channel_');
    const collectionRef = isGroupOrChannel 
        ? collection(db, "chats", state.currentChatId, "messages") 
        : collection(db, "messages");

    const newDocRef = doc(collectionRef); 

    // ðŸŒŸ SENDER METADATA
    const myProfile = DataManager.getProfile();

    // 6. ðŸ› ï¸ CONSTRUCT FINAL MESSAGE OBJECT
    const msgData = {
        id: newDocRef.id, 
        text: msgText, 
        img: imgData, 
        audio: audioData, 
        type: msgType, 
        senderId: state.currentUser.uid, 
        senderName: myProfile.name || "User", 
        senderPhoto: myProfile.photo || "", 
        receiverId: state.currentChatId,
        // ðŸŒŸ 'video' type now correctly stashes the URL/R2Key in pollData
        pollData: (['poll', 'gift_anim', 'game_invite', 'video'].includes(msgType)) ? payload : null, 
        locationData: msgType === 'location' ? payload : null, 
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: Date.now(), 
        status: 'sent', 
        isSystem: isSystem,
        replyContext: state.replyingTo ? state.replyingTo : null,
        linkPreview: state.activeLinkPreview || null 
    };

    // 7. OFFLINE QUEUE HANDLING
    if (!navigator.onLine && !isSystem) {
        msgData.status = 'pending'; 
        if (!isRetry) {
            state.pendingMessages.push(msgData); 
            DataManager.saveMessage(state.currentChatId, msgData);
            DataManager.updateChatList(state.currentChatId, msgData, state.currentChatPartner?.name, state.currentChatPartner?.avatar);
            App.renderMessages(state.currentChatId);
            if(input) input.value = "";
            if (typeof App.cancelReply === 'function') App.cancelReply();
        }
        return;
    }

    // 8. LOCAL OPTIMISTIC RENDER (Immediate UI response)
    if(!isSystem && !isRetry && input) input.value = "";
    DataManager.saveMessage(state.currentChatId, msgData);
    DataManager.updateChatList(state.currentChatId, msgData, state.currentChatPartner?.name, state.currentChatPartner?.avatar);
    App.renderMessages(state.currentChatId);

    // 9. FIREBASE SYNCHRONIZATION
    try {
        const { setDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await setDoc(newDocRef, msgData);

        // ðŸ¤– TRIGGER GROUP BOT ENGINE
        if (isGroupOrChannel) {
            App.processGroupBot(state.currentChatId, msgData);
            
            // Update "Last Message" preview on Home screen
            let previewText = msgText;
            if (msgType === 'sticker') previewText = 'ðŸ“„ Sticker';
            else if (msgType === 'image') previewText = 'ðŸ“· Photo';
            else if (msgType === 'gift_anim') previewText = 'ðŸŽ Gift';
            else if (msgType === 'video') previewText = 'ðŸŽ¥ Video';
            else if (msgType === 'audio') previewText = 'ðŸŽ¤ Voice Note';

            await updateDoc(doc(db, "chats", state.currentChatId), {
                lastMsg: previewText || "Activity",
                timestamp: Date.now(),
                lastSenderId: state.currentUser.uid 
            });
        }

        // ðŸŒŸ SENDER AUTO-SAVE LOGIC ðŸŒŸ
        // If we just sent a video, trigger a silent download to the phone
        if (msgType === 'video' && payload && payload.url) {
            console.log("Auto-saving sent video locally...");
            // Force the handleFileInteraction to save this to the sender's device memory
            App.handleFileInteraction(
                newDocRef.id, 
                payload.url, 
                payload.fileName || `VID_${Date.now()}.mp4`, 
                payload.r2Key, 
                'video'
            );
        }

        if (isRetry) {
            state.pendingMessages = state.pendingMessages.filter(m => m.timestamp !== msgData.timestamp);
        }
        state.lastTranscription = null; 

    } catch(e) { 
        console.error("Firebase Send Error:", e);
        if (!isSystem && !isRetry) {
             msgData.status = 'pending';
             state.pendingMessages.push(msgData);
             App.renderMessages(state.currentChatId);
        }
    }

    // 10. FINAL CLEANUP
    if (typeof App.closeLinkPreview === 'function') App.closeLinkPreview(); 
    if (typeof App.cancelReply === 'function') App.cancelReply();
 },



               // --- ðŸŽ™ï¸ UNIFIED PROFESSIONAL VOICE NOTE ENGINE ---

handleMicStart: async (e) => {
    // 1. SAFETY CHECK: If Kelvin is currently typing text, don't record
    const val = document.getElementById('msg-input').value.trim();
    if (val.length > 0) return;

    if (e.cancelable) e.preventDefault();
    
    // 2. Initial State & Position Tracking
    const touch = e.touches ? e.touches[0] : e;
    state.touchStartY = touch.clientY;
    state.touchStartX = touch.clientX;
    state.isLocked = false;
    
    // 3. Visual Setup: Reveal the Lock Pill
    const micBtn = document.getElementById('main-action-btn');
    const lockPill = document.getElementById('mic-lock-pill');
    micBtn.style.transition = "none";
    if (lockPill) lockPill.style.display = "flex";

    try {
        // 4. Initialize Hardware
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        state.mediaRecorder = new MediaRecorder(stream);
        state.audioChunks = [];
        
        state.mediaRecorder.ondataavailable = (ev) => state.audioChunks.push(ev.data);
        state.mediaRecorder.onstop = () => {
            // Process chunks only if Kelvin didn't cancel
            if (state.audioChunks.length > 0) {
                const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob); 
                reader.onloadend = () => App.sendMessage(null, null, false, reader.result);
            }
            // Release microphone hardware
            stream.getTracks().forEach(track => track.stop());
        };

        // 5. Start Recording & UI Timers
        state.mediaRecorder.start();
        state.isRecording = true;
        state.recordingStartTime = Date.now();
        
        document.querySelector('.chat-input-area').classList.add('recording-active');
        const statusText = document.getElementById('rec-status');
        if (statusText) statusText.style.opacity = "1";

        state.recordingTimerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - state.recordingStartTime) / 1000);
            const timeStr = `${Math.floor(diff/60)}:${(diff%60).toString().padStart(2,'0')}`;
            const recTimer = document.getElementById('rec-timer');
            const lockTimer = document.getElementById('lock-timer');
            if (recTimer) recTimer.innerText = timeStr;
            if (lockTimer) lockTimer.innerText = timeStr;
        }, 1000);

        // 6. Global Listeners for smoother tracking across the whole screen
        window.addEventListener('mousemove', App.handleMicMove);
        window.addEventListener('touchmove', App.handleMicMove, {passive: false});
        window.addEventListener('mouseup', App.handleMicEnd);
        window.addEventListener('touchend', App.handleMicEnd);

    } catch (err) {
        App.showToast("Microphone access denied");
    }
},

handleMicMove: (e) => {
    if (!state.isRecording || state.isLocked) return;
    
    const touch = e.touches ? e.touches[0] : e;
    const diffY = state.touchStartY - touch.clientY; 
    const diffX = state.touchStartX - touch.clientX;
    const micBtn = document.getElementById('main-action-btn');

    // ðŸŒŸ 1. VERTICAL MOVEMENT (Lock Logic)
    if (diffY > 0 && diffY < 130) {
        micBtn.style.transform = `translateY(-${diffY}px) scale(${1 + (diffY/300)})`;
    }

    // ðŸŒŸ 2. HORIZONTAL MOVEMENT (Cancel Logic)
    if (diffX > 60) {
        App.cancelRecording(); 
        return;
    }

    // ðŸ”’ 3. TRIGGER LOCK THRESHOLD
    if (diffY > 100) {
        App.lockRecording();
    }
},

lockRecording: () => {
    state.isLocked = true;
    const micBtn = document.getElementById('main-action-btn');
    const lockPill = document.getElementById('mic-lock-pill');
    const manageBar = document.getElementById('locked-manage-bar');

    // Snap UI to Locked State
    if (lockPill) lockPill.style.display = "none";
    micBtn.style.transform = "translateY(0) scale(1)";
    
    if (manageBar) manageBar.classList.remove('hidden');
    document.querySelector('.recording-ui').classList.add('hidden');
    document.querySelector('.text-ui').classList.add('hidden');

    // Haptic Feedback for Lock
    if (navigator.vibrate) navigator.vibrate([40, 30]);
},

handleMicEnd: (e) => {
    // Cleanup global listeners immediately
    window.removeEventListener('mousemove', App.handleMicMove);
    window.removeEventListener('touchmove', App.handleMicMove);
    window.removeEventListener('mouseup', App.handleMicEnd);
    window.removeEventListener('touchend', App.handleMicEnd);

    // If Kelvin didn't swipe up to lock, send the audio on release
    if (!state.isLocked && state.isRecording) {
        App.stopRecorder(); 
    }
},

stopRecorder: () => {
    if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
        state.mediaRecorder.stop();
    }
    App.resetMicUI();
},

cancelRecording: () => {
    if (state.mediaRecorder) {
        // Wipe audio data before stopping so nothing is sent
        state.mediaRecorder.onstop = () => { state.audioChunks = []; }; 
        state.mediaRecorder.stop();
    }
    App.resetMicUI();
    App.showToast("Recording cancelled ðŸ—‘ï¸");
},

resetMicUI: () => {
    state.isRecording = false;
    state.isLocked = false;
    clearInterval(state.recordingTimerInterval);
    
    const micBtn = document.getElementById('main-action-btn');
    micBtn.style.transform = "translateY(0) scale(1)";
    micBtn.style.background = ""; 
    
    // Return UI to normal input state
    document.getElementById('mic-lock-pill').style.display = "none";
    const manageBar = document.getElementById('locked-manage-bar');
    if (manageBar) manageBar.classList.add('hidden');
    
    document.querySelector('.recording-ui').classList.remove('hidden');
    document.querySelector('.text-ui').classList.remove('hidden');
    document.querySelector('.chat-input-area').classList.remove('recording-active');
    
    const recTimer = document.getElementById('rec-timer');
    if (recTimer) recTimer.innerText = "0:00";
 },
       

                                         // --- SMART LISTENER (Final Fix: Ignores Own Messages) ---
        startSmartMessageListener: () => {
    // 1. LISTEN FOR DIRECT MESSAGES (Includes Security Alerts)
    const qDM = query(collection(db, "messages"), where("receiverId", "==", state.currentUser.uid));
    onSnapshot(qDM, async (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
            const data = change.doc.data();
            const msg = { id: change.doc.id, ...data }; 
            
            if (change.type === "added") {
                // Auto-mark as delivered
                if (msg.status === 'sent' || msg.status === 'pending') {
                    updateDoc(doc(db, "messages", change.doc.id), { status: "delivered" }).catch(()=>{});
                }
                
                let existingChat = DataManager.getChatInfo(msg.senderId);
                let senderName = "User";
                let senderPhoto = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

                // ðŸ›¡ï¸ HARDCODED SECURITY BOT FALLBACK
                if (msg.senderId === "global_connect_security") {
                    senderName = "Global Connect Security";
                    senderPhoto = "https://cdn-icons-png.flaticon.com/512/4359/4359959.png";
                } else if (existingChat) {
                    senderName = existingChat.name;
                    senderPhoto = existingChat.avatar;
                } else {
                    try {
                        const userSnap = await getDoc(doc(db, "users", msg.senderId));
                        if (userSnap.exists()) {
                            const u = userSnap.data();
                            senderName = u.name || "Unknown";
                            senderPhoto = u.photo || senderPhoto;
                        }
                    } catch (err) {}
                }

                // Save message to local phone memory
                DataManager.saveMessage(msg.senderId, msg);

                // ðŸŒŸ BADGE & NOTIFICATION LOGIC ðŸŒŸ
                const isChatOpen = state.currentChatId === msg.senderId;
                const isMyMsg = msg.senderId === state.currentUser.uid;
                
                // Determine if we should notify the user
                const incrementUnread = !isChatOpen && msg.status !== 'read' && !isMyMsg; 
                
                // Mention Detection
                const myProfile = DataManager.getProfile();
                const myName = myProfile.name || "User";
                const isMention = msg.text && msg.text.toLowerCase().includes("@" + myName.toLowerCase());

                // ðŸ”” CAPACITOR NATIVE NOTIFICATION TRIGGER ðŸ””
                if (incrementUnread || isMention) {
                    const isNative = window.Capacitor && window.Capacitor.isNativePlatform();
                    
                    if (isNative) {
                        const { LocalNotifications } = await import('@capacitor/local-notifications');
                        
                        await LocalNotifications.schedule({
                            notifications: [
                                {
                                    title: senderName,
                                    body: msg.text || "Sent a file",
                                    id: Math.floor(Math.random() * 10000), // Unique ID for the OS
                                    schedule: { at: new Date(Date.now() + 100) },
                                    sound: 'notification_tone.wav', 
                                    attachments: msg.img ? [{ id: 'img', url: msg.img }] : [],
                                    actionTypeId: 'MESSAGE_ACTION', // Connects to 'Reply'/'Mark Read' buttons
                                    extra: {
                                        chatId: msg.senderId
                                    }
                                }
                            ]
                        });
                    } else {
                        // Web fallback badge
                        App.showNotificationBadge();
                    }
                }

                // Update the Home Screen Chat List UI
                DataManager.updateChatList(msg.senderId, msg, senderName, senderPhoto, incrementUnread, isMention);

                if (isChatOpen) {
                    const myPrivacy = myProfile.privacy || {};
                    if (myPrivacy.readReceipts !== false) {
                        updateDoc(doc(db, "messages", change.doc.id), { status: "read" }).catch(()=>{});
                    }
                    App.renderMessages(msg.senderId);
                }
            }
        });
    });

    // 2. LISTEN FOR GROUPS
    const qGroups = query(collection(db, "chats"), where("participants", "array-contains", state.currentUser.uid));
    onSnapshot(qGroups, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
            const groupData = change.doc.data();
            const groupId = change.doc.id;

            if (change.type === "added" || change.type === "modified") {
                if (groupData.isGroup && groupData.groupInfo) {
                    const previewMsg = {
                        text: groupData.lastMsg || "Group Activity",
                        time: "Just now", 
                        timestamp: groupData.timestamp || Date.now()
                    };

                    const isChatOpen = state.currentChatId === groupId;
                    const isMyMsg = groupData.lastSenderId === state.currentUser.uid;
                    const incrementUnread = !isChatOpen && !isMyMsg;

                    const myName = (DataManager.getProfile().name || "User").toLowerCase();
                    const isMention = groupData.lastMsg && groupData.lastMsg.toLowerCase().includes("@" + myName);

                    // ðŸ”” NATIVE NOTIFICATION FOR GROUPS ðŸ””
                    if ((incrementUnread || isMention) && window.Capacitor?.isNativePlatform()) {
                        const { LocalNotifications } = await import('@capacitor/local-notifications');
                        await LocalNotifications.schedule({
                            notifications: [{
                                title: groupData.groupInfo.name,
                                body: groupData.lastMsg || "New group message",
                                id: Math.floor(Math.random() * 10000),
                                actionTypeId: 'MESSAGE_ACTION',
                                extra: { chatId: groupId }
                            }]
                        });
                    }

                    DataManager.updateChatList(
                        groupId, 
                        previewMsg, 
                        groupData.groupInfo.name, 
                        groupData.groupInfo.photo,
                        incrementUnread, 
                        isMention
                    );
                    
                    if(!isChatOpen) {
                        App.renderChatList();
                    }
                }
            }
        });
    });

    // 3. LISTEN FOR READ RECEIPTS
    const qSent = query(collection(db, "messages"), where("senderId", "==", state.currentUser.uid));
    onSnapshot(qSent, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === "modified") {
                const data = change.doc.data();
                const msg = { id: change.doc.id, ...data }; 
                DataManager.saveMessage(msg.receiverId, msg);
                if (state.currentChatId === msg.receiverId) {
                    App.renderMessages(msg.receiverId);
                }
            }
        });
    });
 },


        showNotificationBadge: () => {
            const chatNav = document.getElementById('nav-chat');
            if(chatNav && !document.getElementById('msg-badge')) {
                const badge = document.createElement('div');
                badge.id = 'msg-badge';
                badge.style.cssText = "position:absolute; top:10px; right:20px; width:12px; height:12px; background:red; border-radius:50%; border:2px solid white;";
                chatNav.style.position = 'relative';
                chatNav.appendChild(badge);
            }
        },

        clearNotificationBadge: () => {
            const badge = document.getElementById('msg-badge');
            if(badge) badge.remove();
        },
        
        showToast: (text) => {
            const toast = document.createElement('div');
            toast.innerText = text;
            toast.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:30px; z-index:1000; font-size:14px; box-shadow:0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.5s;";
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        },

        sendImage: (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => App.sendMessage(null, e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
        },

                                                               // --- CORE STATUS VIEWER LOGIC ---

renderStatusSlide: async () => {
    // 1. Safety Check
    if (state.storyIndex >= state.activeStories.length) { 
        App.closeStatusViewer(); 
        return; 
    }
    
    const s = state.activeStories[state.storyIndex];
    const myUid = state.currentUser.uid;
    const isOwner = s.uid === myUid; 
    
    // 2. Get Elements
    const displayImg = document.getElementById('status-image-display');
    const displayText = document.getElementById('status-text-display');
    const displayVid = document.getElementById('status-video-display'); 
    const captionEl = document.getElementById('status-caption-display'); 
    const loader = document.getElementById('status-loader');
    const nameEl = document.getElementById('viewer-name');
    const timeEl = document.getElementById('viewer-time');
    const avatarEl = document.getElementById('viewer-avatar');
    const heartIcon = document.getElementById('status-heart-icon');

    // HUD Elements: Toggle based on ownership
    const viewerFooter = document.getElementById('status-reply-input').parentElement.parentElement;
    const ownerFooter = document.getElementById('status-owner-footer');

    if (isOwner) {
        viewerFooter.style.display = 'none'; 
        ownerFooter.style.display = 'flex';  
        document.getElementById('owner-view-count-label').innerText = (s.views ? s.views.length : 0) + " Views";
    } 
    else {
        viewerFooter.style.display = 'flex'; 
        ownerFooter.style.display = 'none';  
    }

    // 3. Update Header Info
    nameEl.innerText = s.name;
    timeEl.innerText = App.getTimeAgo(s.timestamp);
    avatarEl.src = s.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 

    // ðŸŒŸ 3.5 NEW SUB-COLLECTION VIEW TRACKING LOGIC ðŸŒŸ
    if (!isOwner) {
        try {
            const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const myProfile = DataManager.getProfile();
            
            // Save detailed viewer info to the sub-collection for the viewer list to read
            await setDoc(doc(db, "statuses", s.id, "viewers", myUid), {
                uid: myUid,
                name: myProfile.name || "User",
                photo: myProfile.photo || "",
                timestamp: Date.now()
            });
        } catch (e) {
            console.log("View tracking failed:", e);
        }
    }

    // 4. RESET SCREEN
    displayImg.style.display = 'none';
    displayText.style.display = 'none';
    displayVid.style.display = 'none'; 
    captionEl.style.display = 'none'; 
    displayVid.pause();                 
    loader.style.display = 'none';

    // 5. SHOW CONTENT & CAPTION
    if (s.type === 'text') {
        displayText.style.display = 'flex';
        displayText.style.background = s.background || '#b02766'; 
        displayText.style.zIndex = "210"; 
        displayText.innerHTML = `
            <div style="font-size: 32px; font-weight: bold; color: white; line-height: 1.4; word-wrap: break-word; font-family: sans-serif; text-align: center; padding: 20px;">
                ${s.image}
            </div>`;
        App.startStatusTimer();
    } 
    else if (s.type === 'video') {
        displayVid.src = s.image;
        displayVid.style.display = 'block';
        displayVid.style.zIndex = "210";
        displayVid.play();

        if (s.caption) {
            captionEl.innerText = s.caption;
            captionEl.style.display = 'block';
        }
        
        displayVid.onended = () => App.nextStatus();
        if(state.storyTimer) clearTimeout(state.storyTimer);
    }
    else if (s.type === 'voice') {
        displayText.style.display = 'flex';
        displayText.style.background = '#00a884'; 
        displayText.style.zIndex = "210"; 
        displayText.innerHTML = `
            <div style="width: 100px; height: 100px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                <i class="fa-solid fa-microphone" style="font-size: 50px; color: white;"></i>
            </div>
            <h3 style="color: white; margin-bottom: 20px;">Voice Note</h3>
            <audio controls autoplay src="${s.image}"></audio>`;
        App.startStatusTimer();
    } 
    else {
        // IMAGE STATUS
        loader.style.display = 'block'; 
        displayImg.src = s.image;

        if (s.caption) {
            captionEl.innerText = s.caption;
            captionEl.style.display = 'block';
        }

        if (displayImg.complete) {
            App.onStatusImageLoad();
        }
    }

    // 6. UPDATE HEART ICON
    if (!isOwner) {
        if (!s.likes) s.likes = [];
        if (s.likes.includes(myUid)) {
            heartIcon.classList.replace('fa-regular', 'fa-solid');
            heartIcon.style.color = '#ff4757';
        } 
        else {
            heartIcon.classList.replace('fa-solid', 'fa-regular');
            heartIcon.style.color = 'white';
        }
    }

    // 7. RENDER PROGRESS BARS
    const bar = document.getElementById('status-progress-bar');
    bar.innerHTML = "";
    state.activeStories.forEach((_, i) => {
        const width = i < state.storyIndex ? '100%' : '0%';
        bar.innerHTML += `
            <div class="status-bar-segment">
                <div class="status-bar-fill" id="fill-${i}" style="width:${width}"></div>
            </div>`;
    });

    // --- TAP & HOLD LOGIC ---
    const viewerPage = document.getElementById('status-viewer-page');
    
    viewerPage.onmousedown = viewerPage.ontouchstart = (e) => {
        state.isStatusPaused = true;
        clearTimeout(state.storyTimer);
        const fill = document.getElementById(`fill-${state.storyIndex}`);
        if (fill) fill.style.transition = "none"; 
        if (s.type === 'video') displayVid.pause(); 
    };

    viewerPage.onmouseup = viewerPage.ontouchend = () => {
        if (state.isStatusPaused) {
            state.isStatusPaused = false;
            if (s.type === 'video') {
                displayVid.play(); 
            } else {
                App.startStatusTimer(true); 
            }
        }
    };
},

onStatusImageLoad: () => {
    document.getElementById('status-loader').style.display = 'none';
    document.getElementById('status-image-display').style.display = 'block';
    App.startStatusTimer();
},

startStatusTimer: (isResume = false) => {
    if (state.storyTimer) clearTimeout(state.storyTimer);
    
    const fill = document.getElementById(`fill-${state.storyIndex}`);
    if (fill) {
        // Reset the transition to ensure it starts fresh
        fill.style.transition = "none";
        fill.style.width = "0%";
        // Trigger reflow
        void fill.offsetWidth; 
        fill.style.transition = "width 5s linear";
        fill.style.width = "100%";
    }
    
    state.storyTimer = setTimeout(() => {
        if (!state.isStatusPaused) App.nextStatus();
    }, 5000);
},

nextStatus: () => { 
    state.storyIndex++; 
    App.renderStatusSlide(); 
},

prevStatus: () => { 
    state.storyIndex--; 
    if (state.storyIndex < 0) state.storyIndex = 0; 
    App.renderStatusSlide(); 
},

closeStatusViewer: () => { 
    clearTimeout(state.storyTimer); 
    // Stop video if it's playing
    const displayVid = document.getElementById('status-video-display');
    if(displayVid) displayVid.pause();
    App.goToPage('chat-list-page'); 
 },




        // --- 4. TIME HELPER ---
        getTimeAgo: (timestamp) => {
                const seconds = Math.floor((Date.now() - timestamp) / 1000);
                if (seconds < 60) return "Just now";
                const interval = Math.floor(seconds / 60);
                if (interval > 60) return Math.floor(interval / 60) + "h ago";
                return interval + "m ago";
        },

        // --- 5. SEND REPLY LOGIC ---
        sendReply: async (type, content) => {
                if (!content) return;
                const s = state.activeStories[state.storyIndex];
                const input = document.getElementById('status-reply-input');
                
                // ðŸŒŸ Screenshot Style Context: Author Green, Snippet with Icon, Thumb Right
                const replyContext = {
                        id: s.id,
                        thumb: s.type === 'text' ? null : s.image,
                        textType: s.type === 'text' ? 'Status' : (s.type === 'video' ? 'Video' : 'Photo'),
                        author: s.name,
                        isStatus: true
                };

                // WhatsApp Rule: Status replies are always Direct Messages
                const partnerId = s.uid;
                
                try {
                        const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                        
                        await addDoc(collection(db, "messages"), {
                                text: content,
                                senderId: state.currentUser.uid,
                                receiverId: partnerId,
                                timestamp: Date.now(),
                                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                                status: 'sent',
                                type: 'text',
                                replyContext: replyContext
                        });

                        if (type === 'text') input.value = "";
                        App.showToast("Reply sent");
                        
                        // Close the viewer so Kelvin returns to the chat list or chat room
                        App.closeStatusViewer();
                        
                } catch (e) {
                        console.error("Reply failed", e);
                        App.showToast("Failed to send reply");
                }
        },

        // --- 6. LIKE LOGIC ---
        toggleStatusLove: async () => {
                const s = state.activeStories[state.storyIndex];
                const heartIcon = document.getElementById('status-heart-icon');
                const myUid = state.currentUser.uid;
                
                if (!s.likes) s.likes = [];
                
                if (s.likes.includes(myUid)) {
                        s.likes = s.likes.filter(id => id !== myUid);
                        heartIcon.classList.replace('fa-solid', 'fa-regular');
                        heartIcon.style.color = 'white';
                } else {
                        s.likes.push(myUid);
                        heartIcon.classList.replace('fa-regular', 'fa-solid');
                        heartIcon.classList.add('loved-anim'); 
                        heartIcon.style.color = '#ff4757';
                        if (navigator.vibrate) navigator.vibrate(40);
                }

                const statusRef = doc(db, "statuses", s.id);
                await updateDoc(statusRef, { likes: s.likes });
        },
    
    // Helper for "17 minutes ago"
    getTimeAgo: (timestamp) => {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        let interval = seconds / 60;
        if (interval > 60) return Math.floor(interval/60) + " hours ago";
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return "Just now";
    },

    onStatusImageLoad: () => {
        document.getElementById('status-loader').style.display = 'none';
        document.getElementById('status-image-display').style.display = 'block';
        App.startStatusTimer();
    },

    startStatusTimer: () => {
        setTimeout(() => {
            const fill = document.getElementById(`fill-${state.storyIndex}`);
            if(fill) fill.style.cssText = "width:100%; transition: width 5s linear;";
        }, 50);
        if(state.storyTimer) clearTimeout(state.storyTimer);
        state.storyTimer = setTimeout(() => App.nextStatus(), 5000);
    },
                                                             // --- ðŸ’¬ CORE MESSAGE RENDERING ENGINE ---
    renderMessages: async (chatId) => {
        const container = document.getElementById('message-container');
        if (!container) return; 
        container.innerHTML = ''; 
        
        const messages = DataManager.getMessages(chatId);
        const myUid = state.currentUser.uid;
        const partnerId = state.currentChatId;
        const isGroup = chatId.startsWith('group_'); 
        
        state.currentMessages = messages;
        messages.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
        
        const myPrivacy = DataManager.getProfile().privacy || {};

        // --- 1. UNSAVED CONTACT PROFILE CARD ---
        const savedContacts = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
        const isSaved = savedContacts.includes(partnerId);
        const isGroupOrChannel = partnerId.startsWith('group_') || partnerId.startsWith('channel_');

        if (!isSaved && !isGroupOrChannel && partnerId !== "botfather_official" && partnerId !== "global_connect_official" && partnerId !== "global_connect_security") {
            try {
                const uSnap = await getDoc(doc(db, "users", partnerId));
                if (uSnap.exists()) {
                    const u = uSnap.data();
                    const card = document.createElement('div');
                    card.className = "unsaved-profile-card";
                    card.innerHTML = `
                        <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="up-avatar">
                        <div class="up-name">${u.name || 'User'}</div>
                        <div class="up-status">~ âœŽ ${u.bio || 'Available'}</div>
                        <div class="up-info-line">Not a contact â€¢ No common groups</div>
                        <div class="safety-tools" onclick="App.goToPage('help-page')"><i class="fa-solid fa-shield-halved"></i> Safety tools</div>
                        <div class="up-actions">
                            <button class="up-btn btn-block-red" onclick="App.confirmBlockUser()"><i class="fa-solid fa-ban"></i> Block</button>
                            <button class="up-btn btn-add-green" onclick="App.openEditContact()"><i class="fa-solid fa-user-plus"></i> Add</button>
                        </div>
                    `;
                    container.appendChild(card);
                }
            } catch (e) { console.error("Error loading unsaved card:", e); }
        }

        // --- 2. RENDER MESSAGE LOOP ---
        messages.forEach(msg => {
            if (msg.hiddenFor && msg.hiddenFor.includes(myUid)) return;

            const isMe = msg.senderId === myUid;

            // --- ðŸš€ ROW WRAPPER LOGIC ---
            const row = document.createElement('div');
            if (isGroup && !isMe && !msg.isSystem) {
                row.className = "msg-row";
            }

            const div = document.createElement('div');
            div.style.position = 'relative'; 
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.style.transition = "transform 0.1s ease-out"; 
            if(msg.id) div.id = `msg-${msg.id}`; 
            
            // --- ðŸ“¥ SWIPE TO REPLY & GESTURES ---
            let startX = 0;
            let currentX = 0;
            let lastTap = 0;

            div.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0 && !msg.isSystem && msg.type !== 'deleted') {
                    state.selectedMessage = { id: msg.id, senderId: msg.senderId };
                    App.reactToMessage('â¤ï¸'); 
                }
                lastTap = currentTime;
                window.pressTimer = setTimeout(() => App.handleMessageLongPress(msg.id, msg.senderId, msg.text), 600); 
            }, {passive: true});

            div.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                let diff = currentX - startX;
                if (diff > 0 && diff < 80) {
                    div.style.transform = `translateX(${diff}px)`;
                }
            }, {passive: true});

            div.addEventListener('touchend', () => {
                clearTimeout(window.pressTimer);
                let diff = currentX - startX;
                div.style.transform = `translateX(0px)`; 
                if (diff > 50) App.initiateReply(msg); 
                startX = 0; currentX = 0;
            });

            // --- ðŸŒŸ GROUP SENDER ASSETS ---
            let avatarHtml = "";
            let senderNameHtml = "";
            if (isGroup && !isMe && !msg.isSystem) {
                const photo = msg.senderPhoto || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                avatarHtml = `<img src="${photo}" class="msg-avatar-corner" onclick="app.openUserProfile('${msg.senderId}')">`;
                senderNameHtml = `<span class="message-sender-name" onclick="app.openUserProfile('${msg.senderId}')">${msg.senderName || 'Member'}</span>`;
            }

            // --- ðŸ“¦ QUOTED CONTEXT ---
            let quotedHtml = "";
            if (msg.replyContext) {
                quotedHtml = `<div class="quoted-container"><div class="quoted-name">${msg.replyContext.senderName}</div><div class="quoted-text">${msg.replyContext.text}</div></div>`;
            }

            // --- 3. TRANSPARENCY FIX (Includes 'image' and 'game_invite') ---
            const cardTypes = ['poll', 'sticker', 'location', 'audio_file', 'document', 'product_card', 'security_alert', 'game_invite', 'image', 'gift_anim', 'video'];
            if (cardTypes.includes(msg.type) || (msg.text && msg.text.includes('?user_card='))) {
                div.style.background = 'transparent';
                div.style.boxShadow = 'none';
                div.style.padding = '0';
            }

            // --- 4. CONTENT CONSTRUCTION ---
            let replyHtml = ""; 
            if (msg.replyContext && msg.replyContext.isStatus) {
                const r = msg.replyContext;
                const thumbHtml = r.thumb ? `<img src="${r.thumb}" class="reply-thumb">` : "";
                const typeIcon = (r.textType === 'Photo' || r.textType === 'Video') ? '<i class="fa-solid fa-camera" style="font-size:10px; margin-right:3px;"></i> ' : '';
                replyHtml = `<div class="reply-context" onclick="App.jumpToStatus('${r.id}', '${isMe ? msg.receiverId : msg.senderId}')"><div class="reply-info"><div class="reply-author">${r.author}</div><div class="reply-snippet">${typeIcon}${r.textType}</div></div>${thumbHtml}</div>`;
            }
            
            let contentHtml = "";

            // --- ðŸ–¼ï¸ IMAGE (WHATSAPP STYLE WITH OVERLAY) ---
            if (msg.type === 'image') {
                // Build internal metadata (time + ticks)
                let overlayInfo = `<span style="text-shadow: 0 1px 2px rgba(0,0,0,0.6);">${msg.time}</span>`;
                if (isMe && !msg.isBotMsg) {
                    if (msg.status === 'read' || msg.viewed) {
                        overlayInfo += ` <i class="fa-solid fa-check-double" style="color: #53bdeb; margin-left: 4px; font-size: 11px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.5));"></i>`;
                    } else {
                        overlayInfo += ` <i class="fa-solid fa-check" style="color: white; margin-left: 4px; font-size: 11px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.5));"></i>`;
                    }
                }
                
                contentHtml = `
                    <div style="position: relative; border-radius: 12px; overflow: hidden; background: #000; display: inline-block; max-width: 100%;">
                        <img src="${msg.img}" style="display: block; width: 100%; height: auto; max-height: 400px; object-fit: cover; cursor: pointer;" 
                             onclick="App.openImagePreview('${msg.img}', '${isMe ? 'You' : (msg.senderName || 'Contact')}', '${msg.time}')">
                        <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 50px; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); pointer-events: none;"></div>
                        <div style="position: absolute; bottom: 6px; right: 10px; color: white; font-size: 11px; display: flex; align-items: center; z-index: 2;">${overlayInfo}</div>
                    </div>`;
            }
            // --- ðŸŽ® GAME INVITE (DISCORD STYLE) ---
            else if (msg.type === 'game_invite') {
                const game = msg.pollData || {}; 
                contentHtml = `
                    <div style="background: #1c2733; border-radius: 15px; overflow: hidden; min-width: 240px; border: 1px solid #6c5ce7; color: white;">
                        <div style="padding: 15px; display: flex; align-items: center; gap: 12px;">
                            <img src="${game.img}" style="width: 50px; height: 50px; border-radius: 10px;">
                            <div style="flex:1;">
                                <div style="font-weight: bold; font-size: 15px;">${game.name}</div>
                                <div style="font-size: 11px; color: #a29bfe;">Multiplayer Challenge</div>
                            </div>
                        </div>
                        <button onclick="App.startGame('${game.id || 'ludo'}')" style="width: 100%; padding: 12px; background: #6c5ce7; border: none; color: white; font-weight: bold; cursor: pointer;">JOIN ACTIVITY</button>
                    </div>`;
            }
            // --- ðŸŽ VIRTUAL GIFT CARD ---
else if (msg.type === 'gift_anim') {
    contentHtml = `
        <div style="background: linear-gradient(90deg, rgba(255, 75, 125, 0.15), rgba(108, 92, 231, 0.15)); border: 1.5px solid #ff4b7d; padding: 12px; border-radius: 20px; display: flex; align-items: center; gap: 12px; min-width: 220px; box-shadow: 0 4px 12px rgba(255, 75, 125, 0.2);">
            <div style="position: relative;">
                <img src="${msg.senderPhoto || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" style="width: 35px; height: 35px; border-radius: 50%; border: 2px solid white;">
                <div style="position: absolute; bottom: -2px; right: -2px; background: #ffd700; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; border: 1px solid white;">
                    <i class="fa-solid fa-gift" style="font-size: 8px; color: #000;"></i>
                </div>
            </div>
            <div style="flex: 1;">
                <div style="font-size: 11px; color: #888; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">Virtual Gift</div>
                <div style="font-size: 14px; color: #ff4b7d; font-weight: 800;">${msg.text.replace("ðŸŽ Sent a ", "")}</div>
            </div>
            <img src="${msg.img}" style="width: 50px; height: 50px; object-fit: contain; animation: bounce 2s infinite;">
        </div>
    `;
 }

            // --- ðŸ“Š POLLS ---
            else if (msg.type === 'poll' && msg.pollData) {
                const poll = msg.pollData;
                let optionsHtml = "";
                const totalVotes = poll.options.reduce((sum, opt) => sum + (opt.votes ? opt.votes.length : 0), 0);
                poll.options.forEach((opt, index) => {
                    const votes = opt.votes || [];
                    const isSelected = votes.includes(myUid);
                    const percent = totalVotes > 0 ? Math.round((votes.length / totalVotes) * 100) : 0;
                    let voterBadge = votes.length > 0 ? `<div style="width: 16px; height: 16px; background: #23a559; border-radius: 50%; color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid #121b22; margin-right: 5px;">${votes[0].charAt(0).toUpperCase()}</div>` : "";
                    optionsHtml += `
                        <div onclick="event.stopPropagation(); App.castVote('${msg.id}', ${index})" style="margin-top: 15px; cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="width: 20px; height: 20px; border: 2px solid ${isSelected ? '#25D366' : '#8696a0'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${isSelected ? '<div style="width: 10px; height: 10px; background: #25D366; border-radius: 50%;"></div>' : ''}</div>
                                <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;"><span style="color: white; font-size: 15px;">${opt.text}</span><div style="display: flex; align-items: center;">${voterBadge}<span style="color: #8696a0; font-size: 12px;">${votes.length}</span></div></div>
                            </div>
                            <div style="height: 4px; background: #2a3942; border-radius: 2px; width: 100%; position: relative; overflow: hidden;"><div style="position: absolute; top: 0; left: 0; height: 100%; width: ${percent}%; background: #25D366; transition: width 0.3s ease;"></div></div>
                        </div>`;
                });
                const viewVotesBtn = isMe ? `<div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 12px; text-align: center;"><div onclick="event.stopPropagation(); App.openPollDetails('${msg.id}')" style="color: #25D366; font-weight: bold; font-size: 14px; cursor: pointer;">View votes</div></div>` : "";
                contentHtml = `<div style="min-width: 260px; padding: 12px; background: #121b22; border-radius: 12px; margin-bottom: 5px;"><div style="font-weight: 500; margin-bottom: 4px; color: white; font-size: 16px;">${poll.question}</div><div style="font-size: 12px; color: #8696a0; display: flex; align-items: center; gap: 5px; margin-bottom: 5px;"><i class="fa-solid fa-chart-simple" style="font-size: 10px;"></i> Select one or more</div>${optionsHtml}${viewVotesBtn}</div>`;
            }
            // --- ðŸ“ LOCATION ---
            else if (msg.type === 'location') {
                contentHtml = `<div onclick="window.open('${msg.locationData || msg.text}', '_blank')" style="cursor: pointer; border-radius: 12px; overflow: hidden; background: #121b22; border: 1px solid #3b4a54; min-width: 250px;"><div style="width: 100%; height: 120px; background: #2a2f32; display: flex; align-items: center; justify-content: center; position: relative;"><i class="fa-solid fa-map-location-dot" style="font-size: 35px; color: #00a884;"></i></div><div style="padding: 10px;"><div style="font-size: 14px; color: white; font-weight: bold;">Shared Location</div><div style="font-size: 12px; color: #8696a0;">Tap to view on map</div></div></div>`;
            }
            // --- ðŸŽµ AUDIO FILE ---
            else if (msg.type === 'audio_file') {
    const data = msg.pollData || {};
    const isLocal = localStorage.getItem(`file_ready_${msg.id}`) === 'true';
    const localPath = localStorage.getItem(`file_path_${msg.id}`);
    
    // ðŸŒŸ THE INSTANT PLAY UI: 
    // We always show the Play icon. If it's not local, handleFileInteraction handles the silent download.
    contentHtml = `
        <div class="audio-file-card" style="background: #202c33; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 15px; min-width: 240px; border: 1px solid #3b4a54;">
            <div style="width: 45px; height: 45px; background: #ff9500; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-music" style="color: white;"></i>
            </div>
            <div style="flex: 1; overflow: hidden;">
                <div style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden; color: white; font-size: 14px; font-weight: bold;">${data.fileName || msg.text}</div>
                <div style="color: #8696a0; font-size: 11px;">Audio File</div>
            </div>
            
            <div class="audio-action-area" style="min-width: 45px; text-align: center;">
                <i id="play-btn-${msg.id}" class="fa-solid fa-play" 
                   onclick="App.handleFileInteraction('${msg.id}', '${data.url}', '${data.fileName}', '${data.r2Key}', 'audio_file')" 
                   style="color: #00a884; cursor: pointer; font-size: 26px;"></i>
            </div>
        </div>`;
 }


            // --- ðŸ“„ DOCUMENT ---
            else if (msg.type === 'document') {
    const docData = msg.pollData || {};
    const isReady = localStorage.getItem(`file_ready_${msg.id}`);
    
    contentHtml = `
        <div class="file-card" onclick="App.handleFileInteraction('${msg.id}', '${docData.url}', '${docData.fileName}')" 
             style="background: #202c33; padding: 12px; border-radius: 10px; display: flex; align-items: center; gap: 12px; min-width: 220px; cursor: pointer; border-bottom: 3px solid #00a884;">
            <div style="font-size: 24px; color: ${isReady ? '#00a884' : '#ff4757'};">
                <i class="fa-solid ${isReady ? 'fa-file-circle-check' : 'fa-file-arrow-down'}"></i>
            </div>
            <div style="flex: 1; overflow: hidden;">
                <div style="color: white; font-size: 14px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">${docData.fileName || msg.text}</div>
                <div style="color: #8696a0; font-size: 11px;">${docData.fileSize} â€¢ ${isReady ? 'Local' : 'Tap to Download'}</div>
            </div>
        </div>`;
 }

            // --- ðŸ›ï¸ PRODUCT ---
            else if (msg.type === 'product_card') {
                const p = msg.pollData || {};
                contentHtml = `<div style="background: white; border-radius: 12px; overflow: hidden; min-width: 240px; color: #111;"><img src="${p.img}" style="width: 100%; height: 150px; object-fit: cover; background: #f0f2f5;"><div style="padding: 12px;"><div style="font-weight: bold; font-size: 16px;">${p.name}</div><div style="color: #008069; font-weight: bold; margin: 4px 0;">${p.price}</div><button onclick="App.openShopPage()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 20px; background: none; font-weight: bold; margin-top: 10px; color: #008069; cursor: pointer;">View Product</button></div></div>`;
            }
            // --- ðŸ›¡ï¸ SECURITY ALERT ---
            else if (msg.type === 'security_alert') {
                const hasChoice = msg.choice !== null && msg.choice !== undefined;
                const choiceLabel = msg.choice === 'keep' ? 'âœ… Verified' : 'ðŸš« Investigated';
                contentHtml = `<div style="background: #fff; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; color: #111; min-width: 260px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);"><div style="padding: 15px; line-height: 1.5; font-size: 14px;">${App.formatMessageText(msg.text)}</div>${!hasChoice ? `<div style="display: flex; border-top: 1px solid #eee;"><button onclick="app.handleSecurityAction('${msg.id}', 'logout')" style="flex: 1; padding: 12px; border: none; background: #fdfdfd; color: #d32f2f; font-weight: bold; border-right: 1px solid #eee; cursor: pointer; font-size: 12px; text-transform: uppercase;">LOGOUT DEVICE</button><button onclick="app.handleSecurityAction('${msg.id}', 'keep')" style="flex: 1; padding: 12px; border: none; background: #fdfdfd; color: #008069; font-weight: bold; cursor: pointer; font-size: 12px; text-transform: uppercase;">KEEP</button></div>` : `<div style="padding: 10px; text-align: center; background: #f8f9fa; color: #888; font-size: 12px; font-weight: bold; text-transform: uppercase;">${choiceLabel}</div>`}</div>`;
            }
            // --- ðŸ‘¤ USER CARD ---
            else if (msg.text && msg.text.includes('?user_card=')) {
                const cardUid = msg.text.split('=')[1];
                const cardUser = DataManager.getChatInfo(cardUid) || { name: "User", avatar: "https://cdn-icons-png.flaticon.com/512/847/847969.png" };
                contentHtml = `<div style="background: white; border-radius: 12px; border: 1px solid #ddd; overflow: hidden; min-width: 220px; color: #111; margin-top: 5px;"><div style="padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; background: #f8f9fa;"><img src="${cardUser.avatar}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"><div style="font-weight: bold; margin-top: 8px; font-size: 15px;">${cardUser.name}</div><div style="font-size: 11px; color: #00a884; margin-top: 2px; font-weight: 600;">Global Connect Contact</div></div><div style="display: flex; border-top: 1px solid #eee;"><button onclick="app.openUserProfile('${cardUid}')" style="flex: 1; padding: 12px; border: none; background: none; color: #54656f; font-size: 12px; font-weight: 700; border-right: 1px solid #eee; cursor: pointer;">VIEW PROFILE</button><button onclick="app.openChat('${cardUid}', '${cardUser.name}', '${cardUser.avatar}')" style="flex: 1; padding: 12px; border: none; background: none; color: #ff4b7d; font-size: 12px; font-weight: 800; cursor: pointer;">MESSAGE</button></div></div>`;
            }
            // --- Inside renderMessages loop ---
else if (msg.type === 'video') {
    const data = msg.pollData || {};
    const isLocal = localStorage.getItem(`file_ready_${msg.id}`);
    
    // ðŸŒŸ Use local phone path if downloaded, otherwise use the R2 URL
    const vidUrl = isLocal ? localStorage.getItem(`file_path_${msg.id}`) : data.url;
    const progress = state.downloadProgress?.[msg.id] || 0;

    // Check if the link exists
    if (!vidUrl || vidUrl === "ðŸŽ¥ Video" || (!isLocal && !vidUrl.includes('http'))) {
        contentHtml = `<div class="broken-vid-link" style="padding:15px; color:#888; background:#f0f0f0; border-radius:12px; text-align:center; font-size:12px;">
            <i class="fa-solid fa-video-slash"></i> Video Expired from Cloud
        </div>`;
    } else {
        contentHtml = `
            <div class="video-msg-bubble" style="position: relative; border-radius: 12px; overflow: hidden; background: #000; width: 220px; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <video src="${vidUrl}${isLocal ? '' : '#t=0.1'}" style="width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline></video>
                
                <div class="vid-overlay" style="position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                    ${isLocal ? `
                        <div onclick="App.openFullVideoPlayer('${vidUrl}', '${msg.senderName}', '${msg.time}', '${msg.id}', false)" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); cursor: pointer; border: 1px solid rgba(255,255,255,0.4);">
                            <i class="fa-solid fa-play" style="color: white; font-size: 20px; margin-left: 3px;"></i>
                        </div>
                    ` : `
                        <div id="dl-btn-${msg.id}" onclick="App.handleFileInteraction('${msg.id}', '${data.url}', 'video_${msg.id}.mp4', '${data.r2Key}', 'video')" 
                             style="width: 55px; height: 55px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; cursor: pointer; border: 2px solid rgba(255,255,255,0.3);">
                            ${progress > 0 ? `
                                <span style="font-size: 12px; font-weight: 900;">${progress}%</span>
                            ` : `
                                <i class="fa-solid fa-arrow-down" style="font-size: 18px;"></i>
                                <span style="font-size: 8px; margin-top: 2px; font-weight: bold;">DOWNLOAD</span>
                            `}
                        </div>
                    `}
                </div>

                ${data.viewOnce ? `<div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: bold;"><i class="fa-solid fa-eye-slash"></i> View Once</div>` : ''}

                <div style="position: absolute; bottom: 5px; right: 8px; color: white; font-size: 10px; display: flex; align-items: center; gap: 4px; text-shadow: 0 1px 2px black;">
                    ${msg.time} 
                    ${isMe ? (msg.status === 'read' ? '<i class="fa-solid fa-check-double" style="color:#34b7f1;"></i>' : '<i class="fa-solid fa-check"></i>') : ''}
                </div>
            </div>`;
    }
 }



            // --- ðŸŽ¤ AUDIO RECORDING ---
            else if (msg.type === 'audio') {
                const avatar = isMe ? DataManager.getProfile().photo : (msg.senderPhoto || state.currentChatPartner.avatar);
                contentHtml = `<div class="audio-player"><div class="audio-avatar-container"><img src="${avatar||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="audio-avatar-img"><div class="audio-mic-badge"><i class="fa-solid fa-microphone"></i></div></div><div class="audio-controls"><div class="audio-top"><i id="play-btn-${msg.timestamp}" class="fa-solid fa-play play-pause-btn" onclick="App.playAudio('${msg.timestamp}', '${msg.audio}')"></i><div class="audio-slider-container"><div id="bar-fill-${msg.timestamp}" class="audio-slider-fill"></div></div></div></div></div>`;
            } 
            // --- ðŸ¤  STICKER ---
            else if (msg.type === 'sticker') {
                contentHtml = `<img src="${msg.img}" style="width: 130px; height: 130px; object-fit: contain; cursor: pointer;" onclick="App.openStickerMenu('${msg.img}')">`;
            } 
            // --- ðŸ“ TEXT ---
            else {
                contentHtml = `<div style="line-height: 1.4;">${App.formatMessageText((msg.text || '').replace(/\n/g, '<br>'))}</div>`;
            }

            // --- 5. REACTION PILL ---
            let reactionHtml = "";
            if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                const activeEmojis = Object.keys(msg.reactions).filter(e => msg.reactions[e] > 0);
                const totalCount = Object.values(msg.reactions).reduce((a, b) => a + b, 0);
                if (activeEmojis.length > 0) {
                    div.classList.add('has-reactions');
                    const emojiSpans = activeEmojis.map(emoji => `<span>${emoji}</span>`).join('');
                    reactionHtml = `<div class="multi-reaction-badge single-bubble" onclick="app.openReactionDetails('${msg.id}')"><div class="reaction-pill new-react"><div class="emoji-overlap-container">${emojiSpans}</div><span class="reaction-count">${totalCount}</span></div></div>`;
                }
            }

            // --- 6. META DATA (Conditional: Hide for Image) ---
            let metaHtml = "";
            if (msg.type !== 'image') {
                metaHtml = `<div style="font-size:10px; color:#999; text-align:right; margin-top:2px; display:flex; align-items:center; justify-content:flex-end; gap:3px;">${msg.time}`;
                if (isMe && !msg.isBotMsg) {
                    if (msg.status === 'read' || msg.viewed) metaHtml += ` <i class="fa-solid fa-check-double" style="color:#34b7f1;"></i>`;
                    else metaHtml += ` <i class="fa-solid fa-check"></i>`;
                }
                metaHtml += `</div>`;
            }

            // --- ðŸŒŸ FINAL ASSEMBLY ðŸŒŸ ---
            div.innerHTML = (senderNameHtml || "") + (quotedHtml || "") + (replyHtml || "") + (contentHtml || "") + (metaHtml || "") + (reactionHtml || "");

            if (isGroup && !isMe && !msg.isSystem) {
                row.innerHTML = avatarHtml;
                row.appendChild(div);
                container.appendChild(row);
            } else {
                container.appendChild(div);
            }
        });

        container.scrollTop = container.scrollHeight;
    },



            // --- RENDER CHAT LIST (With Badges) ---
renderChatList: async () => {
    const container = document.getElementById('chat-list-container');
    if (!container) return; 
    
    container.innerHTML = '';
    const lang = state.currentLanguage || 'en';
    const myUid = state.currentUser.uid;

    // ðŸŒŸ 1. HANDLE TOP BAR ARCHIVE/LOCK PILL
    const archiveArea = document.getElementById('top-archive-icons');
    if (archiveArea) {
        const hasArchived = state.archivedChats && state.archivedChats.length > 0;
        const hasLocked = state.lockedChats && state.lockedChats.length > 0;
        
        if (hasArchived || hasLocked) {
            archiveArea.innerHTML = `
                <div class="archive-pill-container">
                    <div id="archive-icons-expanded" class="archive-expanded ${state.isArchiveExpanded ? 'show' : ''}">
                        ${hasArchived ? `<i class="fa-solid fa-box-archive" onclick="event.stopPropagation(); app.openArchivedChats()"></i>` : ''}
                        ${hasLocked ? `<i class="fa-solid fa-lock" onclick="event.stopPropagation(); app.unlockLockedChats()"></i>` : ''}
                    </div>
                    <span style="font-size: 12px; font-weight: bold; color: #54656f; cursor: pointer;" onclick="app.toggleArchiveIcons()">((</span>
                </div>`;
        } else {
            archiveArea.innerHTML = '';
        }
    }

    // ðŸŒŸ 2. RENDER BIOMETRIC "LOCKED CHATS" ROW
    if (state.lockedChats && state.lockedChats.length > 0) {
        const lockRow = document.createElement('div');
        lockRow.className = "list-item";
        lockRow.style.cssText = "background: #fff; display: flex; align-items: center; padding: 12px 15px; cursor: pointer;";
        lockRow.onclick = () => app.unlockLockedChats();
        
        lockRow.innerHTML = `
            <div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: #00a884;">
                <i class="fa-solid fa-lock" style="font-size: 22px;"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: bold; font-size: 16px; color: #111;">Locked Chats</div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
        `;
        container.appendChild(lockRow); 
    }

    // ðŸŒŸ 3. GET & FILTER CHATS
    let chats = DataManager.getChatList();
    chats = chats.filter(c => !state.archivedChats.includes(c.id) && !state.lockedChats.includes(c.id));

    // ðŸŒŸ 4. SORTING: Pinned first, then by Timestamp
    chats.sort((a, b) => {
        const aPinned = state.pinnedChats.includes(a.id);
        const bPinned = state.pinnedChats.includes(b.id);
        if (aPinned !== bPinned) return aPinned ? -1 : 1;
        return (b.timestamp || 0) - (a.timestamp || 0);
    });

    if (chats.length === 0 && (!state.lockedChats || state.lockedChats.length === 0)) {
        const emptyMsg = translations[lang]["start_conversation"] || "Start a conversation!";
        container.innerHTML = `<div style='text-align:center; padding:20px; color:grey; margin-top:50px;'>${emptyMsg}</div>`;
        return;
    }

    // ðŸŒŸ 5. RENDER CHAT ITEMS
    chats.forEach(data => {
        const id = data.id;
        const isOnline = App.isUserOnline(id); 
        const isSelected = state.selectedChats.has(id);
        const isPinned = state.pinnedChats.includes(id);
        const isMuted = state.mutedChats.includes(id);
        
        // --- ðŸŒŸ INTEGRATED: TYPING LOGIC ---
        const isTyping = data.typing && data.typing[id] === true;
        
        const liveId = state.activeLiveHosts ? state.activeLiveHosts[id] : null;
        const dotHtml = isOnline ? `<div class="online-dot" style="border: 2px solid white;"></div>` : '';
        const isBot = id === "botfather_official" || id.startsWith("bot_");
        const botBadge = isBot ? '<span class="bot-badge">BOT</span>' : '';

        // --- âœ… NEW SCALLOPED VERIFICATION BADGE LOGIC ---
        const isVerified = data.isVerified === true; 
        const verificationBadge = isVerified 
            ? `<span class="verified-badge"></span>` 
            : '';

        let badgeHtml = "";
        if (data.unread > 0) {
            badgeHtml = `<div style="background: #25D366; color: white; font-size: 11px; font-weight: bold; min-width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0 4px;">${data.unread}</div>`;
        }

        let mentionHtml = "";
        if (data.hasMention) {
            mentionHtml = `<div style="background: #ffffff; color: #00a884; font-size: 14px; font-weight: bold; margin-right: 5px;">@</div>`;
        }

        const timeColor = data.unread > 0 ? '#25D366' : '#888';
        const msgColor = isTyping ? '#ff4b7d' : (data.unread > 0 ? '#111' : 'gray');
        const msgWeight = (isTyping || data.unread > 0) ? '600' : '400';

        let displayMsg = data.lastMsg;
        if (isTyping) {
            displayMsg = "typing...";
        } else if (displayMsg === "No messages yet") {
            displayMsg = translations[lang]["no_messages"] || displayMsg;
        }

        const statusState = app.getStatusState(id);

        const div = document.createElement('div');
        div.className = `list-item ${isSelected ? 'selected-msg' : ''}`;
        div.style.cssText = "display:flex; align-items:center; gap:15px; cursor:pointer; padding: 12px 15px; position: relative;";

        let pressTimer;
        div.onmousedown = () => pressTimer = setTimeout(() => app.enterSelectionMode(id), 600);
        div.ontouchstart = () => pressTimer = setTimeout(() => app.enterSelectionMode(id), 600);
        div.onmouseup = () => clearTimeout(pressTimer);
        div.ontouchend = () => clearTimeout(pressTimer);
        
        div.onclick = () => {
            if (state.selectedChats.size > 0) app.toggleSelection(id);
            else app.openChat(id, data.name, data.avatar);
        };

                div.innerHTML = `
            <div class="avatar-status-wrapper" style="position: relative;" onclick="event.stopPropagation(); ${statusState !== 'none' ? `app.viewUserStatus('${id}')` : (liveId ? `app.joinLiveAsViewer('${liveId}')` : '')}">
                
                <div class="status-ring ring-${statusState}">
                    <img src="${data.avatar}" class="list-avatar-chat ${liveId ? 'live-border' : ''}" style="width:48px; height:48px; border-radius:50%; object-fit:cover; border: 2px solid white;">
                </div>

                ${liveId ? '<span class="live-tag-chat">LIVE</span>' : (isOnline ? '<div class="online-dot" style="border: 2px solid white;"></div>' : '')}
                
                ${isSelected ? '<div style="position:absolute; bottom:0; right:0; background:#00a884; color:white; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-size:10px; border:2px solid white;"><i class="fa-solid fa-check"></i></div>' : ''}
            </div>

            <div style="flex: 1; padding-bottom: 12px;"> 
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 4px;">
                    <h4 style="margin:0; font-size:16px; font-weight:500; color:#111;">${data.name}${verificationBadge} ${botBadge}</h4>
                    <div style="font-size: 11px; color: ${timeColor}; font-weight: ${msgWeight}; display: flex; align-items: center; gap: 5px;">
                        ${isMuted ? '<i class="fa-solid fa-volume-xmark" style="font-size: 12px; color: #888;"></i>' : ''}
                        ${data.time || ''}
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <p style="margin:0; color: ${msgColor}; font-weight: ${msgWeight}; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">
                        ${displayMsg}
                    </p>
                    <div style="display:flex; align-items:center; gap:8px;">
                        ${isPinned ? '<i class="fa-solid fa-thumbtack" style="font-size:12px; color:#888; transform: rotate(45deg);"></i>' : ''}
                        ${mentionHtml}
                        ${badgeHtml}
                    </div>
                </div>
            </div>`;
        
        container.appendChild(div);
    });
 },


        // --- PLAY AUDIO LOGIC ---
        playAudio: (msgId, audioSrc) => {
            const btn = document.getElementById(`play-btn-${msgId}`);
            const fill = document.getElementById(`bar-fill-${msgId}`);
            
            if(state.activeAudio && state.activeAudio.id === msgId) {
                if(state.activeAudio.obj.paused) {
                    state.activeAudio.obj.play();
                    btn.className = "fa-solid fa-pause play-pause-btn";
                } else {
                    state.activeAudio.obj.pause();
                    btn.className = "fa-solid fa-play play-pause-btn";
                }
                return;
            }

            if(state.activeAudio) {
                state.activeAudio.obj.pause();
                const prevBtn = document.getElementById(`play-btn-${state.activeAudio.id}`);
                if(prevBtn) prevBtn.className = "fa-solid fa-play play-pause-btn";
            }

            const audio = new Audio(audioSrc);
            state.activeAudio = { id: msgId, obj: audio };
            
            audio.play();
            btn.className = "fa-solid fa-pause play-pause-btn";
            
            audio.ontimeupdate = () => {
                const pct = (audio.currentTime / audio.duration) * 100;
                if(fill) fill.style.width = pct + "%";
            };
            
            audio.onended = () => {
                btn.className = "fa-solid fa-play play-pause-btn";
                if(fill) fill.style.width = "0%";
                state.activeAudio = null;
            };
        },
                                // --- 3D AVATAR & MENU LOGIC (Updated) ---
        
        // 1. Setup the 3D World
        init3D: async () => {
            if (state.avatarScene) return; 

            // Load Three.js
            const THREE = await import('https://unpkg.com/three@0.160.0/build/three.module.js');
            
            // Setup Canvas
            const canvas = document.getElementById('avatar-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, preserveDrawingBuffer: true });
            renderer.setSize(640, 480);
            
            // Setup Scene
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222); 

            // Setup Camera
            const camera = new THREE.PerspectiveCamera(45, 640/480, 0.1, 1000);
            camera.position.set(0, 1.4, 1.0); 
            
            // Setup Lights
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2.0);
            scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(0, 2, 2);
            scene.add(dirLight);

            // Save to state
            state.avatarScene = scene;
            state.avatarRenderer = renderer;
            state.avatarCamera = camera;
            state.THREE = THREE;
        },

        // 2. Open the Menu
        openAvatarMenu: () => {
            document.getElementById('avatar-menu').style.display = 'flex';
        },

        // 3. Close Menu & Remove Avatar
        closeAvatarMenu: async () => {
            document.getElementById('avatar-menu').style.display = 'none';
            
            // Switch back to Real Camera
            if(state.avatarMode) {
                state.avatarMode = false;
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const sender = webrtc.pc.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.replaceTrack(stream.getVideoTracks()[0]);
                document.getElementById('localVideo').srcObject = stream;
            }
        },

                               // --- 3D AVATAR LOGIC (FIXED CAMERA) ---
        init3D: async () => {
            if (state.avatarScene) return; 

            const THREE = await import('https://unpkg.com/three@0.160.0/build/three.module.js');
            
            // 1. Setup Canvas
            const canvas = document.getElementById('avatar-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, preserveDrawingBuffer: true });
            renderer.setSize(640, 480);
            
            // 2. Setup Scene
            const scene = new THREE.Scene();
            // Dark Grey Background (Neutral for video call)
            scene.background = new THREE.Color(0x222222); 

            // 3. Setup Camera (MOVED BACK TO SEE FACE)
            const camera = new THREE.PerspectiveCamera(50, 640/480, 0.1, 1000);
            // x=0 (center), y=1.5 (eye level), z=3 (distance)
            camera.position.set(0, 1.5, 3); 
            
            // 4. Setup Lights (Brighter)
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2.5);
            scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(2, 2, 5);
            scene.add(dirLight);

            // Save to state
            state.avatarScene = scene;
            state.avatarRenderer = renderer;
            state.avatarCamera = camera;
            state.THREE = THREE;
        },

               // --- 3D AVATAR LOGIC (With Interaction) ---
        init3D: async () => {
            if (state.avatarScene) return; 

            const THREE = await import('https://unpkg.com/three@0.160.0/build/three.module.js');
            const { GLTFLoader } = await import('https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js');

            const canvas = document.getElementById('avatar-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, preserveDrawingBuffer: true });
            renderer.setSize(640, 480);
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222); 

            const camera = new THREE.PerspectiveCamera(45, 640/480, 0.1, 1000);
            camera.position.set(0, 1.5, 3.5); // Moved camera back to see more
            
            // Brighter Lights
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2.5);
            scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(2, 2, 5);
            scene.add(dirLight);

            // --- MOUSE/TOUCH TRACKING SETUP ---
            state.mouseX = 0;
            state.mouseY = 0;
            const updateMouse = (e) => {
                const x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const y = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                // Convert to -1 to +1 range
                state.mouseX = (x / window.innerWidth) * 2 - 1;
                state.mouseY = -(y / window.innerHeight) * 2 + 1;
            };
            document.addEventListener('mousemove', updateMouse);
            document.addEventListener('touchmove', updateMouse);

            state.avatarScene = scene;
            state.avatarRenderer = renderer;
            state.avatarCamera = camera;
            state.THREE = THREE;
            state.GLTFLoader = GLTFLoader;
        },

        // --- SELECT AVATAR (With Movement Tracking) ---
        selectAvatar: async (type) => {
            document.getElementById('avatar-menu').style.display = 'none';
            App.showToast("Loading Interactive Avatar...");

            await App.init3D();

            // Stable GitHub Models
            const models = {
                'man': 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
                // Switched to a SciFi Girl (More human-like than soldier)
                'woman': 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/PrimaryIonDrive.glb', 
                'business': 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf'
            };
            
            const url = models[type] || models['man'];
            const loader = new state.GLTFLoader();

            loader.load(url, (gltf) => {
                if (state.avatarModel) state.avatarScene.remove(state.avatarModel);
                
                const model = gltf.scene;
                
                // Adjustments per model
                if(type === 'woman') {
                    model.scale.set(0.8, 0.8, 0.8);
                    model.position.set(0, 0.5, 0);
                } else if(type === 'man') {
                    model.scale.set(0.4, 0.4, 0.4);
                    model.position.set(0, -1.0, 0);
                } else {
                    model.scale.set(1.5, 1.5, 1.5);
                    model.position.set(0, 0, 0);
                }

                state.avatarScene.add(model);
                state.avatarModel = model;
                state.avatarMode = true;

                // --- ANIMATION LOOP (MAKES IT FOLLOW YOU) ---
                const clock = new state.THREE.Clock();
                const animate = () => {
                    if(!state.avatarMode) return;
                    requestAnimationFrame(animate);
                    const t = clock.getElapsedTime();
                    
                    if(state.avatarModel) {
                        // 1. Breathing (Idle)
                        const breathe = Math.sin(t * 2) * 0.02;
                        state.avatarModel.position.y += Math.sin(t * 5) * 0.001; // Tiny jitter

                        // 2. FOLLOW THE USER (Look at Mouse/Finger)
                        // We smoothly interpolate the rotation so it's not jerky
                        const targetRotX = state.mouseY * 0.5; // Look Up/Down
                        const targetRotY = state.mouseX * 0.8; // Look Left/Right
                        
                        state.avatarModel.rotation.x += (targetRotX - state.avatarModel.rotation.x) * 0.1;
                        state.avatarModel.rotation.y += (targetRotY - state.avatarModel.rotation.y) * 0.1;
                    }
                    state.avatarRenderer.render(state.avatarScene, state.avatarCamera);
                };
                animate();

                // Swap Stream
                const canvas = document.getElementById('avatar-canvas');
                const stream = canvas.captureStream(30);
                const videoTrack = stream.getVideoTracks()[0];
                
                const sender = webrtc.pc && webrtc.pc.getSenders().find(s => s.track && s.track.kind === 'video');
                if (sender) sender.replaceTrack(videoTrack);
                
                document.getElementById('localVideo').srcObject = stream;
                App.showToast("Avatar is Active & Following You!");

            }, undefined, (e) => {
                console.error(e);
                alert("Model failed to load. Try a different one.");
            });
        },
                // --- MOVIE / SHORTS LOGIC ---
                openMoviePage: () => {
        // Reset to discovery mode so tabs and bottom nav are visible
        state.movieViewMode = 'discovery';

        App.goToPage('movie-page');
        
        // ðŸŒŸ INITIALIZE GESTURES EVERY TIME PAGE OPENS
        setTimeout(() => {
            App.initMovieGestures();
        }, 100);

        if (!state.clips || state.clips.length === 0) {
            App.loadClips().then(() => App.renderMovie());
        } else {
            state.clipIndex = 0;
            App.renderMovie();
        }
    },


                // --- RENDER MOVIE (With Clickable Profile) ---
                                renderMovie: async () => {
    // 1. Safety Check & Initial State
    if (!state.clips || state.clips.length === 0) return;
    if (state.clipIndex >= state.clips.length) state.clipIndex = 0;

    const video = state.clips[state.clipIndex];
    const wrapper = document.getElementById('movie-content-wrapper'); // ðŸŒŸ The Dynamic Container
    const loader = document.getElementById('movie-loader');
    const dotsCont = document.getElementById('carousel-dots');
    const myUid = state.currentUser.uid;
    const safeName = (video.name || "user").replace(/\s/g, "").toLowerCase();

    // --- ðŸŒŸ 1. DYNAMIC MUSIC ICON & TEXT (Disc Logic) ---
    const discImg = document.querySelector('.music-disc');
    const marquee = document.querySelector('.movie-bottom-info marquee');
    
    if (video.musicId) {
        discImg.src = video.musicImage || "https://cdn-icons-png.flaticon.com/512/461/461238.png";
        marquee.innerText = video.musicName || "Trending Sound";
    } else {
        discImg.src = video.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        marquee.innerText = `Original Sound - @${safeName}`;
    }

    // --- ðŸ”— 1.5 NAVIGATION HOOK: Open Music Detail Page ---
    discImg.onclick = () => {
        const mId = video.musicId || `original_${video.ownerId}`;
        const mName = video.musicId ? video.musicName : `Original Sound - @${safeName}`;
        const mImg = video.musicId ? video.musicImage : video.photo;
        const mArtist = video.musicId ? "Trending Artist" : `@${safeName}`;
        
        app.openMusicDetail(mId, mName, mImg, mArtist);
    };

    // --- ðŸŒŸ 2. PRE-FLIGHT RESET ---
    if (loader) loader.style.display = 'flex'; 
    if (dotsCont) {
        dotsCont.style.display = 'none';
        dotsCont.innerHTML = "";
    }

    // --- ðŸŒŸ 3. UNIVERSAL MUSIC PREPARATION ---
    if (video.musicId) {
        App.previewSong(video.musicId, 'play');
    } else {
        const ytFrame = document.getElementById('hidden-youtube-audio');
        if (ytFrame) ytFrame.innerHTML = ""; 
    }

    // --- ðŸ“Š 4. METADATA, ANALYTICS & TEXT OVERLAY ---
    app.incrementViewCount(video.id); 
    app.renderMovieText(video); // Trigger the Yellow/Blue Text Overlay

    document.getElementById('movie-username').innerText = "@" + safeName;
    document.getElementById('movie-bio').innerText = video.caption || "";
    document.getElementById('movie-user-avatar').src = video.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";

    // â¤ï¸ LIKE UI SYNC
    const heartIcon = document.getElementById('movie-like-heart');
    const likeCountLabel = document.getElementById('movie-like-count');
    if (heartIcon) heartIcon.style.color = video.likes && video.likes.includes(myUid) ? "#ff4b7d" : "white";
    if (likeCountLabel) likeCountLabel.innerText = app.formatLikeCount(video.likes ? video.likes.length : 0);

    // â­ FAVORITE UI SYNC
    const favIcon = document.getElementById('movie-favorite-icon');
    const favCountLabel = document.getElementById('movie-favorite-count');
    if (!video.favorites) video.favorites = [];
    if (favIcon) favIcon.style.color = video.favorites.includes(myUid) ? "#face15" : "white";
    if (favCountLabel) favCountLabel.innerText = app.formatLikeCount(video.favorites.length);

    // ðŸ’¬ REAL COMMENT COUNT
    const { collection, query, getCountFromServer } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const commSnap = await getCountFromServer(query(collection(db, "videos", video.id, "comments")));
    const commLabel = document.getElementById('movie-comment-count-label');
    if (commLabel) commLabel.innerText = commSnap.data().count || 0;

    // --- ðŸ›¡ï¸ 5. BRANDING & UI NAVIGATION ---
    const isOwner = video.ownerId === myUid;
    const delBtn = document.getElementById('delete-post-btn');
    if (delBtn) delBtn.style.display = isOwner ? 'flex' : 'none';

    const videoContainer = document.getElementById('movie-container');
    const existingBrand = videoContainer.querySelector('.video-watermark-corner');
    if (existingBrand) existingBrand.remove();

    const brand = document.createElement('div');
    brand.className = "video-watermark-corner";
    brand.style.cssText = `position: absolute; top: 70px; left: 20px; display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.8); font-weight: bold; font-size: 13px; z-index: 10; pointer-events: none; text-shadow: 0 1px 3px rgba(0,0,0,0.8);`;
    brand.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/4359/4359959.png" style="width:18px;"> Global Connection`;
    videoContainer.appendChild(brand);

    const topOverlay = document.querySelector('.movie-overlay-top');
    const movieNav = document.querySelector('.movie-nav-bar');

    if (state.movieViewMode === 'profile') {
        if (topOverlay) {
            topOverlay.innerHTML = `<i class="fa-solid fa-arrow-left" onclick="app.closeProfilePlayer()" style="font-size: 22px; cursor: pointer; padding: 10px;"></i><div style="font-weight: 800; font-size: 16px;">Video</div><i class="fa-solid fa-ellipsis-vertical" onclick="app.togglePostMenu()" style="font-size: 20px; padding: 10px; cursor: pointer;"></i>`;
        }
        if (movieNav) movieNav.style.display = 'none';
    } else {
        if (topOverlay) {
            topOverlay.innerHTML = `
                <i class="fa-solid fa-magnifying-glass" style="font-size: 20px; opacity: 0.9; cursor: pointer;" onclick="app.goToPage('movie-search-page')"></i>
                <div class="movie-tabs">
                    <span class="${state.feedMode === 'following' ? 'active' : ''}" onclick="app.switchFeedMode('following')">Following</span>
                    <span class="${state.feedMode === 'friends' ? 'active' : ''}" onclick="app.switchFeedMode('friends')">Friends</span>
                    <span class="${state.feedMode === 'foryou' ? 'active' : ''}" onclick="app.switchFeedMode('foryou')">For You</span>
                </div>
                <i class="fa-solid fa-bars" style="font-size: 20px;"></i>
            `;
        }
        if (movieNav) movieNav.style.display = 'flex';
    }

    // --- ðŸ–¼ï¸ 6. MULTI-IMAGE CAROUSEL PATH (The Photo Slide Logic) ---
    if (video.type === 'images' && Array.isArray(video.images)) {
        if (dotsCont) dotsCont.style.display = 'flex';
        state.currentSlideIndex = 0;

        wrapper.innerHTML = `
            <div id="image-slider-track" style="display: flex; height: 100%; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);">
                ${video.images.map(src => `
                    <div style="min-width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: black;">
                        <img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                `).join('')}
            </div>
        `;

        video.images.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.cssText = `width: 6px; height: 6px; border-radius: 50%; background: ${i === 0 ? 'white' : 'rgba(255,255,255,0.4)'}; transition: 0.2s;`;
            if (dotsCont) dotsCont.appendChild(dot);
        });

        App.initCarouselGestures();
        if (loader) loader.style.display = 'none';
        return; // Skip video-specific logic
    }

    // --- ðŸŽžï¸ 7. VIDEO PATH: MASTER-SLAVE SYNC & HANDSHAKE ---
    // ðŸŒŸ THE FIX: Injected 'object-fit: contain' and saved 'filter' string
    else {
        wrapper.innerHTML = `
            <video id="movie-player" loop playsinline 
                   style="width: 100%; height: 100%; object-fit: contain; opacity: 0; background: #000; filter: ${video.filter || 'none'};">
            </video>`;
        
        // ðŸ›¡ï¸ RE-QUERY: Re-find element after wrapper update
        const videoEl = document.getElementById('movie-player');

        // Music Sync Handlers
        videoEl.onplay = () => { if (video.musicId) App.previewSong(video.musicId, 'play'); };
        videoEl.onpause = () => { if (video.musicId) App.previewSong(video.musicId, 'pause'); };
        videoEl.onseeked = () => {
            if (video.musicId && videoEl.currentTime <= (video.trimStart || 0.2)) {
                App.previewSong(video.musicId, 'restart');
            }
        };

        videoEl.oncanplay = () => {
            videoEl.oncanplay = null; 
            setTimeout(() => {
                if (loader) loader.style.display = 'none';
                videoEl.style.opacity = "1";
                videoEl.play().catch(e => console.log("Autoplay blocked"));
                if (video.musicId) App.previewSong(video.musicId, 'play');
            }, 300); 
        };

        // --- ðŸŽžï¸ 8. TRIGGER SOURCE LOADING & APPLY CUT LOGIC ---
        let localBlob = null;
        if (video.movieId) { try { localBlob = await getFromLocalDB(video.movieId); } catch (err) {} }

        videoEl.src = localBlob ? URL.createObjectURL(localBlob) : (video.videoUrl || ""); 

        // ðŸŒŸ APPLY THE CUT LOGIC ðŸŒŸ
        videoEl.onloadedmetadata = () => {
            videoEl.currentTime = video.trimStart || 0; 
        };

        videoEl.ontimeupdate = () => {
            // If we reach the end of the cut, loop back to the start of the cut
            if (video.trimEnd && videoEl.currentTime >= video.trimEnd) {
                videoEl.currentTime = video.trimStart || 0;
                videoEl.play();
            }
        };

        videoEl.style.display = 'block';
        videoEl.load(); 
    }
 },

// --- ðŸŽžï¸ MOVIE PAGE RENDER UPDATE HELPER ---
renderMovieText: (videoData) => {
    const container = document.getElementById('movie-container');
    const oldText = document.getElementById('movie-text-overlay');
    if (oldText) oldText.remove();

    // Check if current video has saved text metadata
    if (videoData.textOverlay && videoData.textOverlay.content) {
        const div = document.createElement('div');
        div.id = 'movie-text-overlay';
        div.style.cssText = `
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            z-index: 5; pointer-events: none; text-align: center; width: 80%;
        `;
        div.innerHTML = `
            <span style="padding: 8px 15px; border-radius: 8px; font-size: 24px; font-weight: 900; 
                         color: ${videoData.textOverlay.color}; background: ${videoData.textOverlay.background};">
                ${videoData.textOverlay.content}
            </span>
        `;
        container.appendChild(div);
    }
 },

nextMovie: () => {
    state.clipIndex++;
    if (state.clipIndex >= state.clips.length) state.clipIndex = 0;

    const videoEl = document.getElementById('movie-player');
    if (videoEl) {
        videoEl.pause();
        // Clear memory/source to prevent overlapping audio/video on slow connections
        videoEl.removeAttribute('src'); 
        videoEl.load();
    }

    App.renderMovie();
 },



   
                // --- PROFILE PAGE LOGIC ---
        
            // --- ðŸ‘¤ PUBLIC PROFILE ENGINE ---
    
        // --- ðŸ‘¤ PUBLIC PROFILE ENGINE (Fixed Stats & Videos) ---
        openUserProfile: async (userId) => {
    state.viewingProfileId = userId;
    state.lastPage = document.querySelector('.page.active').id;
    App.goToPage('public-profile-page');
    
    // Reset UI to loading state
    document.getElementById('pp-name').innerText = "Loading...";
    document.getElementById('pp-video-grid').innerHTML = "";
    document.getElementById('pp-empty-state').style.display = 'none';
    document.getElementById('pp-followers').innerText = "0";
    document.getElementById('pp-following').innerText = "0";

    try {
        const { doc, getDoc, getDocs, collection, query, where, orderBy, getCountFromServer } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // 1. Load User Profile Data
        const userSnap = await getDoc(doc(db, "users", userId));
        if (!userSnap.exists()) return;
        const user = userSnap.data();

        // ðŸŒŸ 2. PRIVACY SHIELD (Block Logic)
        // Check if Kelvin blocked them OR if they blocked Kelvin
        const myProfile = DataManager.getProfile();
        const iBlockedThem = myProfile.blocked && myProfile.blocked.includes(userId);
        const theyBlockedMe = user.blocked && user.blocked.includes(state.currentUser.uid);

        if (iBlockedThem || theyBlockedMe) {
            document.getElementById('pp-name').innerText = "Global Connect User";
            document.getElementById('pp-bio').innerText = "Details hidden due to privacy settings.";
            document.getElementById('pp-avatar').src = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            document.getElementById('pp-video-grid').innerHTML = '<div style="grid-column: span 2; text-align:center; padding:40px; color:gray;">No posts available</div>';
            
            // Hide follow/message buttons if blocked
            const followBtn = document.getElementById('pp-follow-btn');
            if (followBtn) followBtn.style.display = 'none';
            return;
           }

        // 3. Render Public Info (Only if not blocked)
        document.getElementById('pp-name').innerText = user.name;
        document.getElementById('pp-avatar').src = user.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        document.getElementById('pp-bio').innerText = user.bio || "Available";

        // 4. Load Social Stats
        const followersSnap = await getCountFromServer(query(collection(db, "likes"), where("to", "==", userId)));
        document.getElementById('pp-followers').innerText = followersSnap.data().count;

        const followingSnap = await getCountFromServer(query(collection(db, "likes"), where("from", "==", userId)));
        document.getElementById('pp-following').innerText = followingSnap.data().count;

        // 5. Load Videos
        try {
            const vQuery = query(
                collection(db, "videos"), 
                where("ownerId", "==", userId), 
                orderBy("timestamp", "desc")
            );
            
            const vSnap = await getDocs(vQuery);
            const grid = document.getElementById('pp-video-grid');
            
            if (vSnap.empty) {
                document.getElementById('pp-empty-state').style.display = 'block';
            } else {
                state.tempProfileClips = [];
                vSnap.forEach((vDoc, index) => {
                    const v = vDoc.data();
                    state.tempProfileClips.push({ id: vDoc.id, ...v, name: user.name, photo: user.photo });

                    const item = document.createElement('div');
                    item.className = "profile-video-item";
                    item.onclick = () => app.playProfileVideo(index);
                    item.innerHTML = `
                        <video src="${v.videoUrl}#t=0.1" muted playsinline></video>
                        <div class="profile-video-stats">
                            <i class="fa-solid fa-play"></i> ${app.formatLikeCount(v.likes ? v.likes.length : 0)}
                        </div>`;
                    grid.appendChild(item);
                });
               }
        } catch (indexError) {
            console.error("Video Query Error:", indexError);
            document.getElementById('pp-empty-state').innerHTML = `<p style="padding:20px;">Index is building... check back in 2 mins.</p>`;
            document.getElementById('pp-empty-state').style.display = 'block';
           }

    } catch (e) {
        console.error("General Profile Error:", e);
       }
   },

    // --- ðŸŽ¥ PROFILE TO PLAYER TRANSITION ---
        playProfileVideo: (index) => {
        if (!state.tempProfileClips) return;

        // Force the movie page to play ONLY this user's videos
        state.clips = state.tempProfileClips;
        state.clipIndex = index;
        
        // ðŸŒŸ Set mode to hide discovery tabs and bottom nav
        state.movieViewMode = 'profile';

        App.goToPage('movie-page');
        App.renderMovie();
        
        App.showToast(`Playing videos from profile`);
    },


        toggleFollow: async () => {
            const targetId = state.viewingProfileId;
            if(!targetId || targetId === state.currentUser.uid) return;
            
            const btn = document.getElementById('pp-follow-btn');
            
            if (btn.innerText === "Follow") {
                // Follow logic (Same as Like)
                await App.likeUser(targetId);
                btn.innerText = "Following";
                btn.style.background = "#333";
                // Update Count locally
                let count = parseInt(document.getElementById('pp-followers').innerText);
                document.getElementById('pp-followers').innerText = count + 1;
            } else {
                // Unfollow logic would go here (requires deleting the specific like doc)
                alert("Already following!");
            }
        },

        backToLastPage: () => {
            if(state.lastPage) App.goToPage(state.lastPage);
            else App.goToPage('home-page');
        },
                                      // --- MY PROFILE (Targets 'edit-profile-page' + Shows Badges) ---
    openMyProfile: async () => {
        // 1. Open the exact page ID you provided
        App.goToPage('edit-profile-page');
        
        const uid = state.currentUser.uid;
        const profile = DataManager.getProfile();
        const u = state.currentUser;

        // 2. Update Name & Badges (Targets id="my-name")
        if(document.getElementById('my-name')) {
            const nameEl = document.getElementById('my-name');
            const safeName = profile.name || "User";
            
            // A. Check Verification Status
            const badgeHtml = profile.isVerified 
                ? ' <i class="fa-solid fa-circle-check" style="color:#5865F2; font-size: 16px; vertical-align: middle; margin-left: 4px;" title="Verified"></i>' 
                : '';

            // B. Check Gold Name Status
            if (profile.nameColor === 'gold') {
                nameEl.style.color = "#FFD700";
                nameEl.style.textShadow = "0 0 5px rgba(255, 215, 0, 0.5)";
            } else {
                nameEl.style.color = "white";
                nameEl.style.textShadow = "none";
            }

            // Use innerHTML so the Icon renders
            nameEl.innerHTML = safeName + badgeHtml;
        }
        
        // Update Username Tag
        if(document.getElementById('my-username-top')) {
            // Create tag using first 5 digits of ID: e.g. kelvin07371
            const tag = uid.substring(0, 5).toLowerCase(); 
            const handle = (profile.name ? profile.name.replace(/\s/g, '').toLowerCase() : "user") + tag;
            document.getElementById('my-username-top').innerText = handle;
        }

        // 3. Update Avatar (Targets id="my-avatar")
        if(document.getElementById('my-avatar')) {
            const photoUrl = profile.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            document.getElementById('my-avatar').src = photoUrl;
        }

        // 4. Update "Member Since" Date (Targets class="d-value-row")
        const dateContainer = document.querySelector('#edit-profile-page .d-value-row');
        if (dateContainer && u.metadata.creationTime) {
            const dateObj = new Date(u.metadata.creationTime);
            const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            // Keep the Discord icon, just update the text
            dateContainer.innerHTML = `<i class="fa-brands fa-discord" style="color:#777; margin-right:5px;"></i> ${dateStr}`;
        }

        // 5. Update Friends Faces (Real Database Query)
        const friendsContainer = document.querySelector('#edit-profile-page .d-friend-faces');
        
        if (friendsContainer) {
            try {
                const { collection, query, where, limit, getDocs, getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Find people I follow (My Friends)
                const q = query(collection(db, "likes"), where("from", "==", uid), limit(3));
                const snap = await getDocs(q);
                
                let facesHtml = "";
                
                if (!snap.empty) {
                    for (const docSnap of snap.docs) {
                        const targetId = docSnap.data().to;
                        const userSnap = await getDoc(doc(db, "users", targetId));
                        if (userSnap.exists()) {
                            const pic = userSnap.data().photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                            // Use your exact class 'd-face'
                            facesHtml += `<img src="${pic}" class="d-face">`;
                        }
                    }
                    friendsContainer.innerHTML = facesHtml;
                } else {
                    facesHtml = `<span style="color:#b5bac1; font-size:11px;">No friends yet</span>`;
                    friendsContainer.innerHTML = facesHtml;
                }

            } catch (e) {
                console.error("Friends Error:", e);
            }
        }
    },

        openSettings: () => {
             App.goToPage('settings-page');
        },
            // --- STATUS SYSTEM (REWRITE) ---
    
    // 1. Load the Rail (Checks if I have status)
        loadStoriesRail: async () => {
        const otherContainer = document.getElementById('other-stories-container');
        const myThumb = document.getElementById('my-status-thumb');
        const myPlus = document.getElementById('my-plus-icon');
        const profile = DataManager.getProfile();
        const defaultPic = profile.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        // ðŸŒŸ 1. PRIVACY GATEKEEPER: Get Kelvin's saved contact IDs ðŸŒŸ
        const savedContacts = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
        
        // Query last 24h
        const yesterday = Date.now() - (24 * 60 * 60 * 1000);
        const q = query(collection(db, "statuses"), where("timestamp", ">", yesterday), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);

        // ðŸŒŸ 2. GLOBAL STATE SYNC ðŸŒŸ
        // Saves all fetched status data into a global array for the Ring Logic to check
        state.activeStoriesGlobal = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const grouped = {};
        let myActiveStatus = null;

        snap.forEach(doc => {
            const s = doc.data();

            // ðŸŒŸ 3. THE PRIVACY FILTER ðŸŒŸ
            // If the person who posted (s.uid) has a blacklist, 
            // and I (state.currentUser.uid) am in it, SKIP this status.
            if (s.privacy?.statusBlacklist && s.privacy.statusBlacklist.includes(state.currentUser.uid)) {
                return; // Don't show this status to me
            }
            
            // 4. Logic: Show if it's mine OR if the sender is in my saved list
            if (s.uid === state.currentUser.uid) {
                if (!myActiveStatus) myActiveStatus = s;
            } else if (savedContacts.includes(s.uid)) {
                // ðŸŒŸ MUTUAL CONTACT FILTER ðŸŒŸ
                if(!grouped[s.uid]) grouped[s.uid] = { name: s.name, statuses: [] };
                grouped[s.uid].statuses.push(s);
            }
        });

        // Handle My Status Thumbnail (Kelvin's personal view)
        if (myActiveStatus) {
            myThumb.src = myActiveStatus.type === 'text' ? "https://cdn-icons-png.flaticon.com/512/3003/3003004.png" : myActiveStatus.image;
            myThumb.style.boxShadow = "0 0 0 2px #00a884"; 
            myPlus.style.display = 'none'; 
            state.hasActiveStatus = true;
        } else {
            myThumb.src = defaultPic;
            myThumb.style.boxShadow = "0 0 0 2px #ddd"; 
            myPlus.style.display = 'flex'; 
            state.hasActiveStatus = false;
        }

        // Render Filtered Stories (Only contacts Kelvin has saved)
        otherContainer.innerHTML = "";
        Object.keys(grouped).forEach(uid => {
            const userStories = grouped[uid];
            const thumbUrl = userStories.statuses[0].type === 'text' ? "https://cdn-icons-png.flaticon.com/512/3003/3003004.png" : userStories.statuses[0].image;
            otherContainer.innerHTML += `
                <div class="story-item" onclick="app.viewUserStatus('${uid}')" style="display: flex; flex-direction: column; align-items: center; width: 70px;">
                    <div class="story-circle-container" style="position: relative; width: 65px; height: 65px; margin-bottom: 5px;">
                        <img src="${thumbUrl}" style="width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 0 0 2px #00a884; padding: 2px;">
                    </div>
                    <div class="story-name" style="font-size: 11px; color: #555; max-width: 100%; overflow: hidden; text-overflow: ellipsis;">${userStories.name}</div>
                </div>`;
        });
    },


    // 2. Logic to Decide: Camera vs Dashboard
    handleMyStatusClick: () => {
    // ðŸŒŸ Logic: If Kelvin has an active status, open dashboard. Else, open camera.
    if (state.hasActiveStatus) {
        App.openMyStatusDashboard();
       } 
    else {
        App.openStatusEditor();
       }
   },

openStatusEditor: async () => {
    App.goToPage('status-editor-page');
    App.switchStatusMode('media');
    
    const videoElement = document.getElementById('status-camera-preview');
    const startBtn = document.getElementById('camera-start-btn');
    
    if (videoElement) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            videoElement.srcObject = stream;
            videoElement.onloadedmetadata = () => { 
                videoElement.play(); 
                if(startBtn) startBtn.style.display = 'none'; 
               };
            state.statusCameraStream = stream;
           } 
        catch (err) {
            if(startBtn) startBtn.style.display = 'block';
            App.showToast("Camera blocked. Check permissions.");
           }
       }
   },

closeStatusEditor: () => {
    if (state.statusCameraStream) {
        state.statusCameraStream.getTracks().forEach(track => track.stop());
        state.statusCameraStream = null;
       }
    App.goToPage('chat-list-page');
   },

    switchStatusMode: (mode) => {
        document.querySelectorAll('.status-mode').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.status-pill').forEach(el => el.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.remove('hidden');
        if(mode === 'text') { document.getElementById('text-send-btn').classList.remove('hidden'); }
        else { document.getElementById('text-send-btn').classList.add('hidden'); }
    },

    toggleStatusColor: () => {
        const colors = ['#5c6bc0', '#e91e63', '#00a884', '#8c9eff', '#546e7a'];
        const current = document.getElementById('mode-text').style.background;
        let next = (colors.indexOf(rgbToHex(current)) + 1) % colors.length;
        if(isNaN(next)) next = 0;
        document.getElementById('mode-text').style.background = colors[next];
    },

    toggleStatusFont: () => {
        const fonts = ['sans-serif', 'serif', 'monospace', 'cursive'];
        const el = document.getElementById('status-text-input');
        const curr = el.style.fontFamily;
        let next = (fonts.indexOf(curr) + 1) % fonts.length;
        el.style.fontFamily = fonts[next];
    },

    handleStatusFile: (input) => {
    const file = input.files[0];
    if (!file) return;

    // ðŸŒŸ Detect if the file is a video
    const isVideo = file.type.includes('video');
    const reader = new FileReader();

    reader.onload = (e) => {
        state.tempStatusImage = e.target.result;
        // ðŸŒŸ Save the type so prepareStatus knows how to mark it in the DB
        state.tempStatusFileType = isVideo ? 'video' : 'media'; 

        const previewImg = document.getElementById('review-image');
        const previewVid = document.getElementById('review-video');

        if (isVideo) {
            // Show video, hide image
            if (previewImg) previewImg.style.display = 'none';
            if (previewVid) {
                previewVid.style.display = 'block';
                previewVid.src = e.target.result;
                previewVid.play();
            }
        } else {
            // Show image, hide video
            if (previewVid) {
                previewVid.style.display = 'none';
                previewVid.pause();
            }
            if (previewImg) {
                previewImg.style.display = 'block';
                previewImg.src = e.target.result;
            }
        }
        
        App.goToPage('status-review-page');
    };
    reader.readAsDataURL(file);
  },


    captureStatusPhoto: () => {
        const video = document.getElementById('status-camera-preview');
        if (!video || !video.srcObject) return;
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        state.tempStatusImage = canvas.toDataURL('image/jpeg');
        document.getElementById('review-image').src = state.tempStatusImage;
        App.closeStatusEditor(); // Stop camera
        App.goToPage('status-review-page');
    },
    
    closeReviewPage: () => App.openStatusEditor(),

    prepareStatus: (type) => {
        let content, caption = "", bg = "";
        
        // ðŸŒŸ THE FIX: Differentiate between 'video' and 'media' (image) using state
        const finalType = (type === 'media') ? (state.tempStatusFileType || 'media') : type;

        if (type === 'text') {
            content = document.getElementById('status-text-input').value;
            if(!content.trim()) return;
            bg = document.getElementById('mode-text').style.background;
        } else {
            content = state.tempStatusImage;
            caption = document.getElementById('status-caption').value;
        }
        
        const newStatus = {
            id: "temp_" + Date.now(),
            uid: state.currentUser.uid,
            name: state.currentUser.displayName || "User",
            image: content, 
            caption: caption, 
            background: bg, 
            type: finalType, // ðŸŒŸ Now correctly passes 'video', 'media', or 'text'
            timestamp: Date.now(), 
            views: [], 
            status: 'sending'
        };

        if (!state.pendingStatuses) state.pendingStatuses = [];
        state.pendingStatuses.unshift(newStatus);
        
        App.openMyStatusDashboard(); // Show dashboard

        // ðŸ›‘ Stop and clear the review video playback if it exists
        const rv = document.getElementById('review-video');
        if(rv) { rv.pause(); rv.src = ""; }

        setTimeout(() => App.actuallyUploadStatus(newStatus), 1500);
    },


    actuallyUploadStatus: async (s) => {
    const idx = state.pendingStatuses.findIndex(x => x.id === s.id);
    if (idx === -1) return;

    try {
        let finalMediaUrl = s.image;
        let finalType = s.type; 

        // âœ… FIX: Include 'video' in the check, OR check if it's a local data string
        const needsUpload = s.type === 'media' || s.type === 'voice' || s.type === 'video' || s.image.startsWith('data:') || s.image.startsWith('blob:');

        if (needsUpload) {
            const r2 = new AWS.S3({
                accessKeyId: "d3c4e9280ab513d82ff398d1188167bb",
                secretAccessKey: "b40a8a94728b2c7b936b551ff80568b9b54c4cc82d474c7ef2f7a14ceec4fdd0",
                endpoint: "https://773287539c2ce124da8a4dd8df9822e8.r2.cloudflarestorage.com",
                signatureVersion: 'v4',
                s3ForcePathStyle: true,
                computeChecksums: false 
            });

            const response = await fetch(s.image);
            const blob = await response.blob();
            
            const isVideo = blob.type.includes('video');
            const isAudio = blob.type.includes('audio');
            
            let extension = 'jpg';
            if (isVideo) {
                extension = 'mp4';
                finalType = 'video'; // Ensures it stays 'video' for Firebase
            } else if (isAudio || s.type === 'voice') {
                extension = 'webm';
                finalType = 'voice';
            }
            
            const fileName = `status/${Date.now()}-${s.uid}.${extension}`;

            await r2.upload({
                Bucket: "global-connect-status",
                Key: fileName,
                Body: blob,
                ContentType: blob.type
            }).promise();

            // âœ… This overwrites the massive string with the short R2 URL
            finalMediaUrl = `https://pub-bcf9f1e4b9d842598005a7d242f13bf6.r2.dev/${fileName}`;
        }

        // ðŸ›¡ï¸ SAFETY CHECK: If it's still a massive string, don't call Firebase
        if (finalMediaUrl.length > 10000) {
            throw new Error("Upload to R2 failed: URL is too long for Firebase.");
        }

        const expiryTime = Date.now() + (24 * 60 * 60 * 1000);
        
        await addDoc(collection(db, "statuses"), {
            uid: s.uid, 
            name: s.name, 
            photo: DataManager.getProfile().photo || "",
            image: finalMediaUrl, 
            caption: s.caption || "",
            background: s.background || "", 
            type: finalType,
            timestamp: Date.now(),
            expiresAt: expiryTime, 
            views: []
        });

        // UI Cleanup
        state.pendingStatuses.splice(idx, 1);
        App.renderMyStatusDashboard();
        App.loadStoriesRail();
        App.showToast("Status Live! ðŸš€");

    } catch (e) {
        console.error("Status Error:", e);
        state.pendingStatuses[idx].status = 'failed';
        App.renderMyStatusDashboard();
        App.showToast("Upload failed. Video might be too large.");
    }
 },



    
    openMyStatusDashboard: async () => {
        App.goToPage('status-dashboard-page');
        App.renderMyStatusDashboard();
    },
    

        viewUserStatus: async (uid) => {
        const yesterday = Date.now() - (24 * 60 * 60 * 1000);
        const q = query(collection(db, "statuses"), where("uid", "==", uid), where("timestamp", ">", yesterday), orderBy("timestamp", "asc"));
        const snap = await getDocs(q);
        
        if (snap.empty) return;

        // 1. Populate the viewer state
        state.activeStories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        state.storyIndex = 0;

        // 2. ðŸŒŸ MARK AS VIEWED LOCALLY ðŸŒŸ
        // This ensures the green ring turns gray on the chat list instantly
        const viewedIds = JSON.parse(localStorage.getItem('viewed_status_ids') || '[]');
        state.activeStories.forEach(s => {
            if (!viewedIds.includes(s.id)) viewedIds.push(s.id);
        });
        localStorage.setItem('viewed_status_ids', JSON.stringify(viewedIds));
        
        // 3. Refresh the UI
        if (typeof app.renderChatList === 'function') app.renderChatList();

        // 4. Launch Viewer
        App.goToPage('status-viewer-page');
        App.renderStatusSlide();
    },

    // 3. UPDATED DASHBOARD RENDER (Shows Hearts)
    renderMyStatusDashboard: async () => {
        const container = document.getElementById('my-active-statuses');
        const yesterday = Date.now() - (24 * 60 * 60 * 1000);
        
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const q = query(collection(db, "statuses"), where("uid", "==", state.currentUser.uid), where("timestamp", ">", yesterday), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        
        if (snap.empty && (!state.pendingStatuses || state.pendingStatuses.length === 0)) {
            container.innerHTML = '<div style="padding:20px;text-align:center;color:gray;">No active status</div>';
            return;
        }

        container.innerHTML = "";
        const dbStatuses = snap.docs.map(d => ({...d.data(), id: d.id}));
        const all = [...(state.pendingStatuses || []), ...dbStatuses];

        all.forEach(s => {
            const viewsCount = s.views ? s.views.length : 0;
            const isVideo = s.type === 'video';
            
            // ðŸŒŸ Logic: Set different thumbnails for Text vs Video vs Image
            let thumb = s.image;
            if (isVideo) {
                thumb = "https://cdn-icons-png.flaticon.com/512/1179/1179069.png"; // Video Play Icon
            } else if (s.type === 'text') {
                thumb = "https://cdn-icons-png.flaticon.com/512/3003/3003004.png"; // Text Icon
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = "list-item";
            itemDiv.style.cssText = "display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; background: white;";
            
            itemDiv.innerHTML = `
                <div style="display: flex; align-items: center; flex: 1;" onclick="app.viewMyOwnStatus('${s.id}')">
                    <div style="position: relative; width: 50px; height: 50px; margin-right: 15px;">
                        <img src="${thumb}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        ${isVideo ? '<i class="fa-solid fa-play" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 10px; text-shadow: 0 0 3px black;"></i>' : ''}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #111;">${s.caption || (isVideo ? 'Video Status' : (s.type === 'text' ? 'Text Status' : 'Photo Status'))}</div>
                        <div style="color: gray; font-size: 12px;">${new Date(s.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                    </div>
                </div>
                <div style="color: #8696a0; font-size: 14px; padding: 10px; display: flex; align-items: center; gap: 8px; border-left: 1px solid #eee;" onclick="app.openViewerList('${s.id}')">
                    <i class="fa-solid fa-eye"></i> ${viewsCount}
                </div>`;
                
            container.appendChild(itemDiv);
        });
    }, 



        // --- 3-DOT MENU LOGIC ---
    toggleChatMenu: () => {
        const menu = document.getElementById('chat-menu-dropdown');
        menu.classList.toggle('active');
        
        // Auto-close if clicking outside
        if (menu.classList.contains('active')) {
            setTimeout(() => {
                document.addEventListener('click', App.closeChatMenuOutside, { once: true });
            }, 100);
        }
    },

    closeChatMenuOutside: (e) => {
        const menu = document.getElementById('chat-menu-dropdown');
        // Close if click is NOT on the menu and NOT on the 3-dot icon
        if (menu && !e.target.closest('.chat-menu') && !e.target.closest('.fa-ellipsis-vertical')) {
            menu.classList.remove('active');
        }
    },

        openCreateGroup: async () => {
        const menu = document.getElementById('chat-menu-dropdown');
        if(menu) menu.classList.remove('active');

        state.isAddingMember = false; 
        state.groupParticipants = [];
        App.goToPage('create-group-select-page');
        
        // ðŸŒŸ RESET UI ELEMENTS ðŸŒŸ
        document.getElementById('cg-page-title').innerText = "New Group";
        document.getElementById('cg-selected-count').innerText = "Add participants";
        document.getElementById('cg-btn-icon').className = "fa-solid fa-arrow-right";
        document.getElementById('cg-back-btn').onclick = () => App.goToPage('chat-list-page');
        
        const nextBtn = document.getElementById('cg-next-btn');
        nextBtn.onclick = () => App.goToGroupDetails();
        nextBtn.style.display = 'none';

        const list = document.getElementById('cg-contact-list');
        list.innerHTML = '<div style="padding:20px; text-align:center; color:gray;">Loading contacts...</div>';
        
        // ðŸŒŸ 1. PRIVACY GATEKEEPER: Get IDs Kelvin is allowed to see ðŸŒŸ
        const savedContacts = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
        const recentChatIds = DataManager.getChatList().map(chat => chat.id);
        
        // Combine both into a unique set of "Allowed IDs"
        const allowedIds = [...new Set([...savedContacts, ...recentChatIds])];

        try {
            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            state.allContacts = []; 
            list.innerHTML = "";

            snap.forEach(doc => {
                const u = doc.data();
                if (!u.uid) u.uid = doc.id; 
                
                // Skip myself
                if (u.uid === state.currentUser.uid) return;

                // ðŸŒŸ THE PRIVACY FILTER: Only show if they are Saved or Recent ðŸŒŸ
                if (allowedIds.includes(u.uid)) {
                    state.allContacts.push(u);
                    App.renderContactItem(u, list);
                }
            });

            // ðŸŒŸ 2. EMPTY STATE LOGIC ðŸŒŸ
            if (state.allContacts.length === 0) {
                list.innerHTML = `
                    <div style="padding:40px; text-align:center; color:#8696a0;">
                        <i class="fa-solid fa-user-shield" style="font-size:40px; margin-bottom:15px; opacity:0.3;"></i>
                        <p style="font-size:14px;">Only saved contacts or people you have recently chatted with can be added to groups.</p>
                    </div>`;
            }
        } catch(e) { 
            console.error("Filter Error:", e);
            list.innerHTML = "Error loading contacts.";
        }
    },

    openCreateChannel: () => {
        App.toggleChatMenu();
        App.goToPage('create-channel-page');
        // Reset channel inputs for a fresh start
        const nameInput = document.getElementById('channel-name-input');
        if(nameInput) nameInput.value = "";
    },

    // 2. Render Single Contact
    renderContactItem: (u, container) => {
        const isSelected = state.groupParticipants.find(p => p.uid === u.uid);
        const div = document.createElement('div');
        div.className = `contact-select-item ${isSelected ? 'selected' : ''}`;
        div.onclick = () => App.toggleGroupParticipant(u, div);
        div.innerHTML = `
            <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="select-avatar">
            <div style="flex:1;">
                <div style="font-weight:bold;">${u.name}</div>
                <div style="font-size:12px; color:gray;">${u.bio || 'Available'}</div>
            </div>
            <div class="select-checkbox"></div>
        `;
        container.appendChild(div);
    },

       // --- FIX: SEARCH CRASH ---
    filterContacts: (text) => {
        const list = document.getElementById('cg-contact-list');
        list.innerHTML = "";
        // Safety: ensure text is a string
        const lower = text ? text.toLowerCase() : "";
        
        if (!state.allContacts) return;

        state.allContacts.forEach(u => {
            // SAFETY CHECK: If user has no name, use "Unknown"
            const name = u.name ? u.name : "Unknown User";
            
            if (name.toLowerCase().includes(lower)) {
                App.renderContactItem(u, list);
            }
        });
    },

    // 4. Toggle Selection
    toggleGroupParticipant: (u, element) => {
        const index = state.groupParticipants.findIndex(p => p.uid === u.uid);
        
        if (index === -1) {
            // Add
            state.groupParticipants.push(u);
            element.classList.add('selected');
        } else {
            // Remove
            state.groupParticipants.splice(index, 1);
            element.classList.remove('selected');
        }
        
        App.updateGroupUI();
    },

        // --- UPDATE GROUP UI (Safe Version) ---
    updateGroupUI: () => {
        const count = state.groupParticipants.length;
        
        // 1. Update Hidden Counter (if exists)
        const countEl = document.getElementById('cg-count');
        if(countEl) countEl.innerText = count;

        // 2. Update Subtitle text (Create Group / Add Members)
        const subtitle = document.getElementById('cg-selected-count');
        if(subtitle) {
            subtitle.innerText = count > 0 ? `${count} selected` : "Add participants";
        }
        
        // 3. Show/Hide Floating Button
        const btn = document.getElementById('cg-next-btn');
        if(btn) btn.style.display = count > 0 ? 'flex' : 'none';

        // 4. Update Selected Strip
        const strip = document.getElementById('cg-selected-strip');
        if(strip) {
            strip.style.display = count > 0 ? 'flex' : 'none';
            strip.innerHTML = "";
            
            state.groupParticipants.forEach(u => {
                strip.innerHTML += `
                    <div class="mini-avatar-bubble">
                        <div style="position:relative;">
                            <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}">
                            <div class="remove-x" onclick="event.stopPropagation(); App.removeParticipant('${u.uid}')">x</div>
                        </div>
                        <span>${u.name.split(' ')[0]}</span>
                    </div>`;
            });
        }
    },

    removeParticipant: (uid) => {
        // Find user object from cache
        const u = state.allContacts.find(c => c.uid === uid);
        // Find element in list to uncheck visually
        // (For simplicity in this demo we just re-render list if needed, or just toggle logic)
        // Re-run filter to refresh view
        const searchVal = document.querySelector('#create-group-select-page input').value;
        const index = state.groupParticipants.findIndex(p => p.uid === uid);
        if(index > -1) state.groupParticipants.splice(index, 1);
        
        App.updateGroupUI();
        App.filterContacts(searchVal); // Re-renders the list with correct checkbox state
    },

    // 6. Go to Page 2 (Details)
    goToGroupDetails: () => {
        App.goToPage('create-group-details-page');
        document.getElementById('cg-final-count').innerText = state.groupParticipants.length;
        
        // Render Avatar Grid
        const grid = document.getElementById('cg-final-list');
        grid.innerHTML = "";
        state.groupParticipants.forEach(u => {
            grid.innerHTML += `
                <div style="text-align:center;">
                    <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                    <div style="font-size:11px; margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${u.name}</div>
                </div>`;
        });
    },

    handleGroupIcon: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('cg-icon-preview').src = e.target.result;
                state.groupIconBase64 = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    },

                // --- 7. CREATE GROUP (Fixed: Sets You as Admin) ---
    createGroup: async () => {
        const name = document.getElementById('cg-name-input').value.trim();
        if (!name) return alert("Please enter a group name.");
        
        const myUid = state.currentUser.uid;
        
        // 1. Get my name safely
        const myProfile = DataManager.getProfile() || {};
        const myName = myProfile.name || "Admin";

        // 2. Clean Participants (Remove nulls/undefined)
        const participantIds = state.groupParticipants
            .map(u => u.uid)
            .filter(uid => uid); 
            
        // Add myself if I'm not in the list
        if (!participantIds.includes(myUid)) {
            participantIds.push(myUid);
        }

        App.showToast("Creating group...");

        try {
            const groupId = "group_" + Date.now();
            const systemMsgText = `You were added to this group by ${myName}`;
            const safePhoto = state.groupIconBase64 || "https://cdn-icons-png.flaticon.com/512/166/166258.png";

            const groupData = {
                name: name,
                photo: safePhoto,
                description: "Welcome to " + name,
                participants: participantIds, // Everyone
                admins: [myUid],              // <--- THIS MAKES YOU THE OWNER
                createdBy: myUid,
                createdAt: Date.now(),
                type: 'group'
            };

            // 3. Create Group Document
            await setDoc(doc(db, "chats", groupId), {
                participants: participantIds,
                admins: [myUid], // Important: Save admins at top level too
                settings: {
                    sendMessages: true,
                    editInfo: true,
                    addMembers: true,
                    approveMembers: false
                },
                isGroup: true,
                groupInfo: groupData,
                lastMsg: systemMsgText,
                timestamp: Date.now()
            });

            // 4. Send System Message
            await addDoc(collection(db, "chats", groupId, "messages"), {
                text: systemMsgText,
                senderId: myUid,
                isSystem: true,
                timestamp: Date.now()
            });

            // 5. Reset & Open
            state.groupParticipants = [];
            state.groupIconBase64 = null;
            document.getElementById('cg-name-input').value = "";
            document.getElementById('cg-icon-preview').src = "https://cdn-icons-png.flaticon.com/512/166/166258.png";
            
            // Update my local list
            DataManager.updateChatList(groupId, { text: "You created this group", time: "Just now" }, name, safePhoto);
            
            App.openChat(groupId, name, safePhoto);

        } catch(e) {
            console.error(e);
            alert("Error creating group: " + e.message);
        }
    },
    
        // --- FORCE SYNC GROUPS (Fixes User B not seeing groups) ---
    syncGroups: async () => {
        if(!state.currentUser) return;
        try {
            // Find all chats where I am a participant
            const q = query(collection(db, "chats"), where("participants", "array-contains", state.currentUser.uid));
            const snap = await getDocs(q);
            
            snap.forEach(doc => {
                const data = doc.data();
                if(data.isGroup && data.groupInfo) {
                    // Force update local list
                    DataManager.updateChatList(
                        doc.id, 
                        { 
                            text: data.lastMsg || "Group", 
                            time: data.time || "Just now", 
                            timestamp: data.timestamp 
                        }, 
                        data.groupInfo.name, 
                        data.groupInfo.photo
                    );
                }
            });
            App.renderChatList(); // Update the screen
        } catch(e) { 
            console.log("Group Sync Error:", e); 
        }
    },
        // --- MESSAGE SELECTION LOGIC ---
    
    // 1. Handle Long Press (Triggered from renderMessages)
                        handleMessageLongPress: async (msgId, senderId, text) => {
        // 1. Haptic feedback
        if (navigator.vibrate) navigator.vibrate(50);
        
        // 2. Identify the current chat policy
        const chatId = state.currentChatId;
        let policy = 'any'; // Default
        
        try {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const chatSnap = await getDoc(doc(db, "chats", chatId));
            if (chatSnap.exists()) {
                const chatData = chatSnap.data();
                // Check if a specific emoji policy is set in settings
                policy = (chatData.settings && chatData.settings.emojiPolicy) ? chatData.settings.emojiPolicy : 'any';
            }
        } catch (e) { console.error("Policy fetch failed", e); }

        // ðŸŒŸ POLICY CHECK: If set to 'none', stop here and don't show the menu
        if (policy === 'none') return;

        state.selectedMessage = { id: msgId, senderId: senderId, text: text };
        
        // Remove existing menus
        const oldBar = document.getElementById('active-reaction-bar');
        if(oldBar) oldBar.remove();

        const el = document.getElementById(`msg-${msgId}`);
        if(el) {
            el.classList.add('selected-msg');
            
            const bar = document.createElement('div');
            bar.className = 'reaction-overlay';
            bar.id = 'active-reaction-bar';
            
            // Positioning logic
            const isMe = senderId === state.currentUser.uid;
            if(!isMe) bar.style.left = "0px";
            else bar.style.right = "0px";

            // ðŸŒŸ DYNAMIC EMOJI LIST
            const defaultEmojis = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™'];
            let emojiHtml = defaultEmojis.map(emoji => 
                `<span onclick="app.reactToMessage('${emoji}')">${emoji}</span>`
            ).join('');

            // ðŸŒŸ PLUS BUTTON LOGIC: Only show if policy is 'any'
            let plusButton = "";
            if (policy === 'any') {
                plusButton = `<div class="reaction-plus" onclick="app.openReactionEmojiDrawer()">+</div>`;
            }

            bar.innerHTML = emojiHtml + plusButton;
            el.appendChild(bar);

            // Close when clicking anywhere else
            setTimeout(() => {
                const autoClose = (e) => {
                    if (!e.target.closest('.reaction-overlay')) {
                        bar.remove();
                        el.classList.remove('selected-msg');
                        document.getElementById('msg-selection-header').style.display = 'none';
                        document.removeEventListener('click', autoClose);
                    }
                };
                document.addEventListener('click', autoClose);
            }, 10);
        }
        document.getElementById('msg-selection-header').style.display = 'flex';
    },

    animateReaction: (msgId, emoji) => {
        const msgEl = document.getElementById(`msg-${msgId}`);
        if (!msgEl) return;

        // ðŸŒŸ TELEGRAM BURST: Spawn 5 particles in random directions ðŸŒŸ
        for(let i = 0; i < 5; i++) {
            const floater = document.createElement('div');
            floater.className = 'floating-reaction';
            floater.innerText = emoji;
            
            // Random burst coordinates
            const x = (Math.random() * 140 - 70) + 'px';
            const y = (Math.random() * -140 - 50) + 'px';
            floater.style.setProperty('--tx', x);
            floater.style.setProperty('--ty', y);
            
            msgEl.appendChild(floater);
            setTimeout(() => floater.remove(), 600);
        }
        
        App.playReactionSound();
        msgEl.classList.add('shaking');
        setTimeout(() => msgEl.classList.remove('shaking'), 200);
    },

    openReactionEmojiDrawer: () => {
        state.isReactionMode = true;
        App.toggleEmojiDrawer();
    },

    // 2. Deselect / Close Header
    deselectMessage: () => {
        state.selectedMessage = null;
        document.querySelectorAll('.message').forEach(m => m.classList.remove('selected-msg'));
        document.getElementById('msg-selection-header').style.display = 'none';
        document.getElementById('delete-modal-overlay').style.display = 'none';
    },

    // 3. Show Delete Modal (The Logic you asked for!)
        promptDeleteMessage: () => {
        if(!state.selectedMessage) return;
        
        const modal = document.getElementById('delete-modal-overlay');
        const btnEveryone = document.getElementById('del-everyone-btn');
        
        // 1. Am I the sender? (In channels, this is usually only the admin)
        const isMyMessage = state.selectedMessage.senderId === state.currentUser.uid;
        
        // 2. Optional: Are you an admin? 
        // (If you want to let other admins delete posts too)

        if (isMyMessage) {
            btnEveryone.style.display = 'block'; // Let me delete my own post
        } else {
            btnEveryone.style.display = 'none';  // Followers can't delete for others
        }
        
        modal.style.display = 'flex';
    },

        // --- CONFIRM DELETE (Fixed for Channels & Pathing) ---
    confirmDelete: async (type) => {
        if (!state.selectedMessage) return;

        const msgId = state.selectedMessage.id;
        const chatId = state.currentChatId;
        
        // ðŸŒŸ FIX: Include channel check here
        const isGroupOrChannel = chatId.startsWith('group_') || chatId.startsWith('channel_');
        
        App.deselectMessage(); // Close UI immediately
        
        try {
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

            // ðŸŒŸ FIX: Construct the correct collection path
            const collectionPath = isGroupOrChannel ? `chats/${chatId}/messages` : `messages`;
            const msgRef = doc(db, collectionPath, msgId);

            if (type === 'everyone') {
                // Global "Soft Delete"
                await updateDoc(msgRef, {
                    text: "ðŸš« This message was deleted",
                    type: "deleted",
                    img: null,
                    audio: null
                });
                App.showToast("Message deleted for everyone");
            } 
            else if (type === 'me') {
                // Local "Hide" using the hiddenFor array
                const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await updateDoc(msgRef, {
                    hiddenFor: arrayUnion(state.currentUser.uid)
                });
                
                // Remove from local screen immediately
                const el = document.getElementById(`msg-${msgId}`);
                if(el) el.remove();
                App.showToast("Message deleted for me");
            }
        } catch(e) {
            console.error("Delete Error:", e);
            // If it still fails, the path below will help you debug
            const debugPath = isGroupOrChannel ? `chats/${chatId}/messages/${msgId}` : `messages/${msgId}`;
            alert("Delete failed. System path tried: " + debugPath);
        }
    },

    // 5. Copy Text
    copySelectedMessage: () => {
        if(state.selectedMessage && state.selectedMessage.text) {
            navigator.clipboard.writeText(state.selectedMessage.text);
            App.showToast("Message copied");
            App.deselectMessage();
        } else {
            App.showToast("Nothing to copy");
        }
    },
    
    // 6. Reply (Connects to your existing reply logic)
    replyToSelected: () => {
        // Find the message object
        const msg = DataManager.getMessages(state.currentChatId).find(m => m.id === state.selectedMessage.id);
        if(!msg) return;

        // Simulate Swipe Reply
        // Assuming you handle replies via state.replyingTo... 
        // We will manually trigger a visual indicator here if you don't have a specific function.
        // For now, let's just focus the input:
        document.getElementById('msg-input').focus();
        App.showToast("Replying to: " + msg.text.substring(0,20) + "...");
        App.deselectMessage();
    },
            // --- GROUP INFO LOGIC ---

        // --- OPEN GROUP INFO (Updated with Pending Requests Logic) ---
                openGroupInfo: async () => {
        const chatId = state.currentChatId;
        if (!chatId || !chatId.startsWith('group_')) return; 
        
        app.goToPage('group-info-page');
        
        try {
            // 1. Fetch Fresh Group Data
            const snap = await getDoc(doc(db, "chats", chatId));
            if (!snap.exists()) return;
            const g = snap.data();
            state.currentGroupData = g; // Save for settings

            // Safety Checks
            const participants = g.participants || [];
            const admins = g.admins || []; 
            const ownerId = g.groupInfo.createdBy; 
            const myUid = state.currentUser.uid;
            const amIAdmin = admins.includes(myUid);
            const settings = g.settings || {};

            // 2. Render Header
            document.getElementById('gi-name').innerText = g.groupInfo.name;
            document.getElementById('gi-count').innerText = "Group â€¢ " + participants.length + " members";
            document.getElementById('gi-part-count-header').innerText = participants.length + " members";
            document.getElementById('gi-icon').src = g.groupInfo.photo || "https://cdn-icons-png.flaticon.com/512/166/166258.png";
            document.getElementById('gi-desc').innerText = g.groupInfo.description || "No description";

            // Toggle Pending Requests Row
            const pendingRow = document.getElementById('gi-pending-row');
            const pendingBadge = document.getElementById('gi-pending-badge');
            if (settings.approveMembers === true && amIAdmin && g.pendingMembers && g.pendingMembers.length > 0) {
                 pendingRow.style.display = 'flex'; 
                 pendingBadge.innerText = g.pendingMembers.length; 
            } else {
                 pendingRow.style.display = 'none'; 
            }

            // ðŸŒŸ 3. BOT CONTROL ROW (Admin Only) ðŸŒŸ
            // FIXED: We show/hide the static row instead of creating a new one to prevent duplication.
            const botRow = document.getElementById('gi-bot-row');
            if (botRow) {
                botRow.style.display = amIAdmin ? 'flex' : 'none';
            }

            // 4. Render Members List
            const list = document.getElementById('gi-member-list');
            list.innerHTML = "";

            const canAdd = settings.addMembers !== false || amIAdmin; 
            document.getElementById('gi-add-btn').style.display = canAdd ? 'flex' : 'none';

            for (const uid of participants) {
                let u = { uid: uid, name: "Loading...", photo: "https://cdn-icons-png.flaticon.com/512/847/847969.png" };
                const localUser = state.allContacts ? state.allContacts.find(c => c.uid === uid) : null;
                if (localUser) u = localUser;
                else {
                    try { const uSnap = await getDoc(doc(db, "users", uid)); if(uSnap.exists()) u = uSnap.data(); } catch(e){}
                }

                const isAdmin = admins.includes(uid);
                const isOwner = uid === ownerId;
                const isMe = uid === myUid;
                
                const div = document.createElement('div');
                div.className = "list-item";
                div.style.padding = "10px 0";
                div.style.borderBottom = "none";
                
                // Passes data to management menu
                div.onclick = () => app.showMemberOptions(uid, u.name, u.photo, amIAdmin, isAdmin, isOwner);
                
                div.innerHTML = `
                    <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="list-avatar" style="width:40px; height:40px;">
                    <div style="flex:1;">
                        <div style="font-size:16px; color:#111b21; display:flex; justify-content:space-between;">
                            <span>${isMe ? "You" : u.name}</span>
                            ${isOwner ? '<span class="admin-badge" style="color:#ff4b7d; border-color:#ff4b7d;">Group Owner</span>' : (isAdmin ? '<span class="admin-badge">Group Admin</span>' : '')}
                        </div>
                        <div style="font-size:13px; color:#54656f;">${u.bio || "Available"}</div>
                    </div>
                `;
                list.appendChild(div);
            }

            // ðŸŒŸ 5. RENDER FOOTER BUTTONS (Prevents Duplication)
            const footerContainer = list.parentElement; 
            
            // CLEANUP: Remove any existing action box before adding a new one
            const oldActions = document.getElementById('gi-action-box');
            if (oldActions) oldActions.remove();

            const actionContainer = document.createElement('div');
            actionContainer.id = 'gi-action-box'; 
            actionContainer.style.background = "white";
            actionContainer.style.marginTop = "10px";
            actionContainer.style.paddingBottom = "20px";
            
            actionContainer.innerHTML = `
                <div class="list-item" onclick="app.leaveGroup()" style="color: #d32f2f; font-size: 16px; font-weight: 500; border-bottom: none;">
                    <i class="fa-solid fa-arrow-right-from-bracket" style="width: 25px;"></i> Exit group
                </div>
                <div class="list-item" style="color: #d32f2f; font-size: 16px; font-weight: 500;" onclick="app.openReportModal()">
                    <i class="fa-regular fa-thumbs-down" style="width: 25px;"></i> Report group
                </div>
            `;
            footerContainer.appendChild(actionContainer);

        } catch (e) { console.error("Info Error:", e); }
    },



        // --- OPEN ADD MEMBER SCREEN (Fixed: Does not delete Navbar IDs) ---
    openAddMemberScreen: async () => {
        state.isAddingMember = true; 
        state.groupParticipants = []; 
        
        App.goToPage('create-group-select-page');
        
        // ðŸŒŸ FIX: Select elements by ID instead of overwriting innerHTML ðŸŒŸ
        const title = document.getElementById('cg-page-title');
        const backBtn = document.getElementById('cg-back-btn');
        const nextBtn = document.getElementById('cg-next-btn');
        const icon = document.getElementById('cg-btn-icon');
        const subtitle = document.getElementById('cg-selected-count');

        // Safely update texts
        if(title) title.innerText = "Add Members";
        if(subtitle) subtitle.innerText = "Add participants";
        
        // Change Back Button behavior
        if(backBtn) {
            backBtn.onclick = () => App.openGroupInfo();
        }
        
        // Setup "Done" Button
        if(nextBtn) {
            nextBtn.onclick = App.confirmAddMembers;
            nextBtn.style.display = 'none'; // Hide initially
        }
        if(icon) icon.className = "fa-solid fa-check"; // Change arrow to checkmark
        
        // Load Contacts (Filter out existing members)
        const list = document.getElementById('cg-contact-list');
        list.innerHTML = '<div style="padding:20px; text-align:center; color:gray;">Loading...</div>';
        
        // Fetch contacts if needed
        if (!state.allContacts || state.allContacts.length === 0) {
            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            state.allContacts = [];
            snap.forEach(d => state.allContacts.push({uid: d.id, ...d.data()}));
        }

        list.innerHTML = "";
        const currentMembers = state.currentGroupData ? state.currentGroupData.participants : [];
        
        state.allContacts.forEach(u => {
            if (currentMembers.includes(u.uid)) return; // Don't show already added users
            App.renderContactItem(u, list);
        });
    },

        // --- CONFIRM ADD MEMBERS (Smart Version: Checks Permissions) ---
            confirmAddMembers: async () => {
                const g = state.currentGroupData;
                const chatId = state.currentChatId;

                // ðŸ›¡ï¸ CRASH PROTECTOR: If we are not in a group context, exit safely
                if (!g || !chatId) {
                        console.warn("confirmAddMembers called without active group data.");
                        return; 
                }

                if (state.groupParticipants.length === 0) return;
                
                const newIds = state.groupParticipants.map(u => u.uid);
                const myUid = state.currentUser.uid;
                
                // Now it's safe to check for admins because we verified 'g' exists
                const admins = g.admins || [];
                const amIAdmin = admins.includes(myUid);
                
                App.showToast("Processing...");
                
                const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

                try {
                        // SCENARIO 1: Approval is ON and I am NOT an Admin -> Send to Pending
                        if (g.settings && g.settings.approveMembers === true && !amIAdmin) {
                                 await updateDoc(doc(db, "chats", chatId), {
                                         pendingMembers: arrayUnion(...newIds)
                                 });

                                 await addDoc(collection(db, "chats", chatId, "messages"), {
                                         text: `Requested to add ${newIds.length} members`, 
                                         isSystem: true, 
                                         timestamp: Date.now()
                                 });

                                 alert("Request sent to admins for approval.");
                        } else {
                                 // SCENARIO 2: I am Admin OR Approval is OFF -> Add Directly
                                 await updateDoc(doc(db, "chats", chatId), {
                                         participants: arrayUnion(...newIds)
                                 });

                                 const names = state.groupParticipants.map(u => u.name).join(", ");
                                 await addDoc(collection(db, "chats", chatId, "messages"), {
                                         text: `You added ${names}`, 
                                         isSystem: true, 
                                         timestamp: Date.now()
                                 });
                        }

                        // 3. Cleanup & Return
                        state.isAddingMember = false;
                        state.groupParticipants = [];
                        App.openGroupInfo(); 

                } catch (e) {
                        console.error(e);
                        alert("Error adding members: " + e.message);
                }
        },


    // --- MISSING FUNCTION 2: Leave Group ---
        leaveGroup: async (passedId = null) => {
        // 1. Determine which chat to leave (Current or selected from list)
        const chatId = passedId || state.currentChatId;
        if (!chatId) return;

        if (!confirm("Exit group?")) return;
        
        const myUid = state.currentUser.uid;
        const myName = state.currentUser.displayName || "A user";
        
        try {
            // 2. Dynamic Firebase Imports
            const { updateDoc, doc, arrayRemove, addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            const chatRef = doc(db, "chats", chatId);

            // 3. Remove your ID from both participants and admins arrays
            await updateDoc(chatRef, {
                participants: arrayRemove(myUid),
                admins: arrayRemove(myUid)
            });
            
            // 4. Send a System Message to the group so others see you left
            await addDoc(collection(db, "chats", chatId, "messages"), {
                text: `${myName} left`, 
                isSystem: true, 
                timestamp: Date.now()
            });
            
            // 5. UI Feedback and Navigation
            App.showToast("You left the group");
            App.goToPage('chat-list-page');

            // 6. Refresh the chat list to remove the group from view
            if (typeof App.renderChatList === 'function') {
                App.renderChatList();
            }

        } catch (e) {
            console.error("Leave Group Error:", e);
            App.showToast("Failed to leave group.");
        }
    },

      // --- CHECK PERMISSIONS (Handles Groups & Channels) ---
    checkGroupPermissions: async (chatId) => {
    const inputArea = document.getElementById('chat-input-bar');
    if (!inputArea) return;

    // 1. Reset UI to default state (Standard for DMs and Admins)
    inputArea.classList.remove('blocked');
    inputArea.style.display = 'flex';

    // 2. Remove any existing "MUTE" bar to prevent duplicates
    const oldOverlay = document.getElementById('channel-mute-overlay');
    if (oldOverlay) oldOverlay.remove();

    // 3. Exit early if it's a Direct Message (no group/channel restrictions apply)
    if (!chatId.startsWith('group_') && !chatId.startsWith('channel_')) return;

    try {
        const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const snap = await getDoc(doc(db, "chats", chatId));
        if (!snap.exists()) return;

        const g = snap.data();
        const myUid = state.currentUser.uid;
        const amIAdmin = g.admins && g.admins.includes(myUid);
        const isChannel = g.isChannel === true;
        const settings = g.settings || {};

        // 4. CHANNEL LOGIC: Followers see the MUTE bar instead of the input
        if (isChannel && !amIAdmin) {
            inputArea.style.display = 'none';

            const muteBar = document.createElement('div');
            muteBar.id = 'channel-mute-overlay';
            muteBar.style.cssText = "height:60px; background:#f0f2f5; display:flex; align-items:center; justify-content:center; color:#54656f; font-weight:500; border-top:1px solid #ddd; width:100%;";
            muteBar.innerHTML = `MUTE`;

            // Append to the chat room container so it sits at the bottom
            const chatRoom = document.getElementById('chat-room');
            if (chatRoom) chatRoom.appendChild(muteBar);
        } 
        
        // 5. GROUP LOGIC: Restricted messaging applies a grey overlay
        else if (!isChannel && settings.sendMessages === false && !amIAdmin) {
            inputArea.classList.add('blocked');
            inputArea.setAttribute('data-status', "Only admins can send messages");
        }

        // 6. DEFAULT STATE: If user is admin or group is open, input remains flex
        else {
            inputArea.style.display = 'flex';
        }

    } catch (e) {
        console.error("Permission check error:", e);
    }
 },


    // --- SETTINGS LOGIC ---
    openGroupSettings: () => {
        const g = state.currentGroupData;
        const myUid = state.currentUser.uid;
        const admins = g.admins || [];
        
        if (!admins.includes(myUid)) return alert("Only admins can access settings");

        App.goToPage('group-settings-page');
        
        const s = g.settings || {};
        
        // Map DB settings to Toggles
        // Default (undefined) means TRUE (Everyone)
        // Checked means Everyone, Unchecked means Admins Only
        document.getElementById('set-edit-info').checked = s.editInfo !== false; 
        document.getElementById('set-send-msgs').checked = s.sendMessages !== false;
        document.getElementById('set-add-members').checked = s.addMembers !== false;
        
        // Approve is reverse: Default false (off). Checked means ON.
        document.getElementById('set-approve').checked = s.approveMembers === true;
    },

    toggleGroupSetting: async (key) => {
        const chatId = state.currentChatId;
        const val = event.target.checked;
        
        await updateDoc(doc(db, "chats", chatId), {
            [`settings.${key}`]: val
        });
        // Update local cache
        if(!state.currentGroupData.settings) state.currentGroupData.settings = {};
        state.currentGroupData.settings[key] = val;
    },

    toggleInfoMenu: () => {
         const menu = document.getElementById('info-menu-dropdown');
         if(menu) menu.classList.toggle('active');
    },

    backToChat: () => {
        App.openChat(state.currentChatId, state.currentChatPartner.name, state.currentChatPartner.avatar);
    },
        // --- PENDING REQUESTS SCREEN (Admin Only) ---
    openPendingRequestsScreen: async () => {
        App.goToPage('pending-requests-page');
        const container = document.getElementById('pending-list-container');
        container.innerHTML = '<div style="padding:20px; text-align:center; color:gray;">Loading requests...</div>';
        
        const chatId = state.currentChatId;
        
        try {
            // 1. Get Fresh Data
            const snap = await getDoc(doc(db, "chats", chatId));
            if (!snap.exists()) return;
            const g = snap.data();
            state.currentGroupData = g; // Update local data

            const pendingIds = g.pendingMembers || [];
            
            container.innerHTML = ""; // Clear loader

            if (pendingIds.length === 0) {
                container.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:50vh; color:gray;">
                        <i class="fa-solid fa-check-circle" style="font-size:50px; margin-bottom:15px; color:#ddd;"></i>
                        <div>No pending requests</div>
                    </div>`;
                return;
            }

            // 2. Render Each Pending User
            for (const uid of pendingIds) {
                let u = { name: "Unknown User", photo: "https://cdn-icons-png.flaticon.com/512/847/847969.png" };
                
                // Try fetch user profile
                try { 
                    const s = await getDoc(doc(db, "users", uid)); 
                    if(s.exists()) u = s.data(); 
                } catch(e) { console.error(e); }
                
                const div = document.createElement('div');
                div.className = "list-item";
                div.style.background = "white";
                div.style.marginBottom = "1px";
                div.innerHTML = `
                    <img src="${u.photo}" class="list-avatar" style="width:45px; height:45px;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:16px;">${u.name}</div>
                        <div style="font-size:13px; color:gray;">Requesting to join</div>
                    </div>
                    <div style="display:flex; gap:15px;">
                        <div onclick="app.handlePending('${uid}', false)" style="width:35px; height:35px; background:#ffebee; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#d32f2f; cursor:pointer;">
                            <i class="fa-solid fa-xmark"></i>
                        </div>
                        <div onclick="app.handlePending('${uid}', true)" style="width:35px; height:35px; background:#e8f5e9; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#2e7d32; cursor:pointer;">
                            <i class="fa-solid fa-check"></i>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
        } catch(e) {
            console.error("Error loading pending:", e);
            container.innerHTML = "Error loading data.";
        }
    },

    // --- HANDLE DECISION (Approve/Reject) ---
    handlePending: async (targetUid, isApproved) => {
        const chatId = state.currentChatId;
        const { arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        App.showToast(isApproved ? "Approving..." : "Rejecting...");

        try {
            const chatRef = doc(db, "chats", chatId);

            if (isApproved) {
                // Remove from Pending -> Add to Participants
                await updateDoc(chatRef, {
                    pendingMembers: arrayRemove(targetUid),
                    participants: arrayUnion(targetUid)
                });

                // Notify Chat
                await addDoc(collection(db, "chats", chatId, "messages"), {
                    text: "A new member was approved by admin",
                    isSystem: true, 
                    timestamp: Date.now()
                });
            } else {
                // Just remove from Pending
                await updateDoc(chatRef, {
                    pendingMembers: arrayRemove(targetUid)
                });
            }

            // Refresh the screen to remove the person from list
            App.openPendingRequestsScreen();

        } catch(e) {
            console.error("Error handling pending:", e);
            alert("Action failed: " + e.message);
        }
    },
        // Update or Replace 'toggleGroupParticipant' or 'toggleSelection' with this:
    toggleSelection: (u) => {
        // 1. Update Array
        const index = state.groupParticipants.findIndex(p => p.uid === u.uid);
        if (index > -1) state.groupParticipants.splice(index, 1);
        else state.groupParticipants.push(u);
        
        // 2. Refresh List
        const list = document.getElementById('cg-contact-list');
        if(list) {
            list.innerHTML = "";
            state.allContacts.forEach(contact => {
                if (state.isAddingMember && state.currentGroupData && state.currentGroupData.participants.includes(contact.uid)) return;
                App.renderContactItem(contact, list);
            });
        }

        // 3. Update Header & Button (WITH SAFETY CHECK)
        const btn = document.getElementById('cg-next-btn');
        const subtitle = document.getElementById('cg-selected-count'); // This was null before
        
        if (subtitle) {
            if (state.groupParticipants.length > 0) {
                subtitle.innerText = `${state.groupParticipants.length} selected`;
            } else {
                subtitle.innerText = "Add participants";
            }
        }

        if (btn) {
            btn.style.display = state.groupParticipants.length > 0 ? 'flex' : 'none';
        }
    },
        // --- INVITE LINK & QR LOGIC ---
    
        openInvitePage: async () => {
        const chatId = state.currentChatId;
        const g = state.currentGroupData;
        if(!chatId || !g) return;

        App.goToPage('invite-link-page');

        // ðŸŒŸ FIX: Use the REAL current URL (Vercel) + a Query Parameter
        // This creates a link like: https://your-app.vercel.app/?join=group_12345
        const link = `${window.location.origin}/?join=${chatId}`;
        
        state.currentInviteLink = link;

        // Update UI
        document.getElementById('qr-group-name').innerText = g.groupInfo.name;
        document.getElementById('qr-group-icon').src = g.groupInfo.photo || "https://cdn-icons-png.flaticon.com/512/166/166258.png";
        document.getElementById('invite-link-text').innerText = link;

        // Generate QR Code
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(link)}`;
        document.getElementById('qr-code-img').src = qrUrl;
    },

    copyGroupLink: () => {
        if(state.currentInviteLink) {
            navigator.clipboard.writeText(state.currentInviteLink);
            App.showToast("Link copied");
        }
    },

    shareLinkToStatus: () => {
        // Go to Status Editor with link as text
        const link = state.currentInviteLink;
        App.openStatusEditor(); 
        App.switchStatusMode('text');
        
        // Pre-fill text input
        setTimeout(() => {
            document.getElementById('status-text-input').value = link;
            // Optionally change background color
            document.getElementById('mode-text').style.background = "#008069"; 
        }, 300);
    },

    shareLinkInternal: () => {
        // Re-use "Add Member" screen logic but as a "Forward" picker
        // Ideally you'd build a separate Forward screen, but for this prototype:
        alert("Select a contact to forward to (Simulated)");
        App.goToPage('chat-list-page'); 
        // In a real app: Open a contact list -> On click -> Send Message(link) -> Go back
    },

    shareLinkSystem: async () => {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Join my group',
                    text: 'Follow this link to join my Global Connect group:',
                    url: state.currentInviteLink
                });
            } catch (err) {
                console.log('Share failed:', err);
            }
        } else {
            App.copyGroupLink(); // Fallback
        }
    },

    resetGroupLink: () => {
        if(confirm("Reset link? The old link will stop working.")) {
            // In real backend: Server generates new token
            // Simulated:
            const newSuffix = Date.now().toString().slice(-5);
            const newLink = `https://globalconnect.app/join/${state.currentChatId}_${newSuffix}`;
            
            state.currentInviteLink = newLink;
            document.getElementById('invite-link-text').innerText = newLink;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(newLink)}`;
            document.getElementById('qr-code-img').src = qrUrl;
            
            App.showToast("Link reset");
        }
    },
                // --- CHECK FOR INVITE LINKS (Groups & Channels) ---
    checkInviteLink: async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get('join');
        const channelId = urlParams.get('channel'); 

        // 1. GROUP LOGIC (Existing)
        if (joinId) {
            // Remove from URL to prevent loop
            window.history.replaceState({}, document.title, "/");

            if (!state.currentUser) {
                console.log("User not logged in yet."); 
                return;
            }

            App.showToast("Checking invite...");

            try {
                // Import Firestore functions dynamically
                const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const groupSnap = await getDoc(doc(db, "chats", joinId));
                
                if (groupSnap.exists()) {
                    const g = groupSnap.data();
                    
                    // Check if already a member
                    if (g.participants && g.participants.includes(state.currentUser.uid)) {
                        App.showToast("You are already in this group.");
                        App.openChat(joinId, g.groupInfo.name, g.groupInfo.photo);
                    } else {
                        // Show the JOIN MODAL
                        state.pendingJoinGroupId = joinId; 
                        state.pendingJoinGroupData = g;     
                        
                        document.getElementById('join-group-name').innerText = g.groupInfo.name;
                        
                        // Handle Icon
                        const iconImg = document.getElementById('join-group-icon');
                        const iconPlace = document.getElementById('join-group-placeholder');
                        
                        if (g.groupInfo.photo) {
                            iconImg.src = g.groupInfo.photo;
                            iconImg.style.display = 'block';
                            iconPlace.style.display = 'none';
                        } else {
                            iconImg.style.display = 'none';
                            iconPlace.style.display = 'block';
                        }
                        
                        const date = g.createdAt ? new Date(g.createdAt).toLocaleDateString() : "Recently";
                        document.getElementById('join-group-meta').innerText = `Created ${date}`;

                        document.getElementById('join-group-modal').style.display = 'flex';
                    }
                } else {
                    alert("This group link is invalid or expired.");
                }
            } catch (e) {
                console.error("Invite Error:", e);
            }
        }

        // 2. CHANNEL LOGIC (New)
        if (channelId) {
            window.history.replaceState({}, document.title, "/");
            
            if (!state.currentUser) return; 

            App.showToast("Loading channel...");

            try {
                const { getDoc, doc, updateDoc, arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const snap = await getDoc(doc(db, "chats", channelId));
                if (snap.exists()) {
                    const c = snap.data();
                    const myUid = state.currentUser.uid;

                    // Check if already following
                    if (c.participants && c.participants.includes(myUid)) {
                        App.openChat(channelId, c.groupInfo.name, c.groupInfo.photo);
                    } else {
                        // ASK TO FOLLOW
                        if(confirm(`Follow channel "${c.groupInfo.name}"?`)) {
                            // Add to participants list
                            await updateDoc(doc(db, "chats", channelId), {
                                participants: arrayUnion(myUid)
                            });
                            App.showToast("Following!");
                            App.openChat(channelId, c.groupInfo.name, c.groupInfo.photo);
                        }
                    }
                } else {
                    alert("Channel not found.");
                }
            } catch (e) {
                console.error("Channel Link Error", e);
            }
        }
    },

    // --- BUTTON CLICK ACTION (For the Modal) ---
    confirmJoinGroup: async () => {
        const groupId = state.pendingJoinGroupId;
        const groupData = state.pendingJoinGroupData;
        if(!groupId || !groupData) return;

        // Hide Modal
        document.getElementById('join-group-modal').style.display = 'none';
        App.showToast("Joining...");

        // Reuse existing join logic
        await App.joinGroup(groupId, groupData);
    },

    // --- LOGIC TO ACTUALLY JOIN ---
    joinGroup: async (groupId, groupData) => {
        const myUid = state.currentUser.uid;
        const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        // Check settings: Does it require approval?
        const settings = groupData.settings || {};
        
        if (settings.approveMembers === true) {
            // Send to Pending
            await updateDoc(doc(db, "chats", groupId), {
                pendingMembers: arrayUnion(myUid)
            });
            alert("Request sent to admins for approval.");
        } else {
            // Join Immediately
            await updateDoc(doc(db, "chats", groupId), {
                participants: arrayUnion(myUid)
            });
            
            // ðŸŒŸ TRIGGER THE BOT WELCOME ðŸŒŸ
            // This runs the logic to send your custom message/image as the Bot
            App.triggerBotWelcome(groupId, myUid);

            // Add System Message
            await addDoc(collection(db, "chats", groupId, "messages"), {
                text: `${state.currentUser.displayName || "User"} joined via invite link`,
                isSystem: true, 
                timestamp: Date.now()
            });
            
            // Open the Group
            App.openChat(groupId, groupData.groupInfo.name, groupData.groupInfo.photo);
        }
    },

                // --- HELPER: SMART LINK FORMATTER ---
    formatMessageText: (text) => {
        if (!text) return "";
        
        // 1. Detect URLs
        const urlRegex = /(\b(https?:\/\/)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6})\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*))/gi;

        return text.replace(urlRegex, (match) => {
            let url = match;
            if (!match.match(/^https?:\/\//i)) url = 'https://' + match;

            // 2. CHECK: IS THIS MY APP LINK?
            // We check if the link contains "vercel.app" or your current domain
            const isInternal = url.includes(window.location.hostname);

            if (isInternal) {
                // ðŸŒŸ INTERNAL LINK: Use onclick to handle it INSTANTLY (No reload)
                return `<span onclick="app.handleInternalLink('${url}')" style="color: #039be5; text-decoration: underline; cursor: pointer; word-break: break-all;">${match}</span>`;
            } else {
                // ðŸŒ EXTERNAL LINK: Open in new tab (Normal behavior)
                return `<a href="${url}" target="_blank" style="color: #039be5; text-decoration: underline; word-break: break-all;">${match}</a>`;
            }
        });
    },
            // 1. Updated Link Handler
handleInternalLink: (url) => {
    try {
        const urlObj = new URL(url);
        const groupId = urlObj.searchParams.get('join');
        const channelId = urlObj.searchParams.get('channel');
        const liveId = urlObj.searchParams.get('live');
        const userId = urlObj.searchParams.get('user_card');

        // A. Handle User Profile Cards
        if (userId) {
            app.openUserProfile(userId);
        } 
        // B. Handle Group or Channel Invites (Professional Modal Logic)
        else if (groupId || channelId) {
            App.triggerJoinPreview(groupId || channelId);
        } 
        // C. Handle Live Stream Links
        else if (liveId) {
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('live', liveId);
            window.history.pushState({}, '', newUrl);
            App.checkInviteLink();
        } 
        // D. Default fallback
        else {
            App.goToPage('home-page');
        }
    } catch (e) {
        console.error("Link Error:", e);
        // If parsing fails, try opening it as a standard link
        window.open(url, '_blank');
    }
},

// 2. New Helper Function for Join Previews
triggerJoinPreview: async (id) => {
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const snap = await getDoc(doc(db, "chats", id));
        
        if (snap.exists()) {
            const data = snap.data();
            state.pendingJoinGroupId = id;
            state.pendingJoinGroupData = data;
            
            // Populate Modal UI
            const nameLabel = document.getElementById('join-group-name');
            const iconImg = document.getElementById('join-group-icon');
            const placeholder = document.getElementById('join-group-placeholder');
            const modal = document.getElementById('join-group-modal');

            if (nameLabel) nameLabel.innerText = data.groupInfo.name;
            
            if (iconImg && data.groupInfo.photo) {
                iconImg.src = data.groupInfo.photo;
                iconImg.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';
            } else if (placeholder) {
                iconImg.style.display = 'none';
                placeholder.style.display = 'block';
            }

            // Show the modal
            if (modal) modal.style.display = 'flex';
        } else {
            App.showToast("Invite link invalid or expired");
        }
    } catch (e) {
        console.error("Join Preview Error:", e);
        App.showToast("Connection error");
    }
 },


    
            // --- 1. NOTIFICATIONS PAGE LOGIC (Saves to Local Storage) ---
    openNotificationsPage: () => {
        App.goToPage('notifications-page');
        
        // Load saved settings from Local Storage
        const saved = JSON.parse(localStorage.getItem('user_notif_settings')) || {};
        
        // Update UI with saved values (or defaults)
        document.getElementById('disp-notify').innerText = saved.notify || 'All';
        document.getElementById('disp-vibrate').innerText = saved.vibrate || 'Default';
        document.getElementById('disp-light').innerText = saved.light || 'White';
        
        // Update the Mute Switch
        const muteSwitch = document.querySelector('#notifications-page input[type="checkbox"]');
        if(muteSwitch) muteSwitch.checked = saved.mute || false;
    },

    // OPEN MODALS
    openNotifyModal: () => {
        document.getElementById('modal-notify').style.display = 'flex'; 
        document.getElementById('modal-notify').querySelector('.bottom-sheet').style.display = 'block';
    },
    openVibrateModal: () => {
        document.getElementById('modal-vibrate').style.display = 'flex';
    },
    openLightModal: () => {
        document.getElementById('modal-light').style.display = 'flex';
    },

    // CLOSE MODAL
    closeModal: (id) => {
        document.getElementById(id).style.display = 'none';
    },

    // SET SETTING & SAVE
    setNotificationSetting: (type, value) => {
        // 1. Update UI Text
        document.getElementById(`disp-${type}`).innerText = value;
        
        // 2. Close Modal
        App.closeModal(`modal-${type}`);
        
        // 3. Save to Local Storage
        const saved = JSON.parse(localStorage.getItem('user_notif_settings')) || {};
        saved[type] = value;
        localStorage.setItem('user_notif_settings', JSON.stringify(saved));
        
        // App.showToast(`${type} set to ${value}`);
    },

    toggleLocalSetting: (key) => {
        const checkbox = event.target;
        const saved = JSON.parse(localStorage.getItem('user_notif_settings')) || {};
        saved[key] = checkbox.checked;
        localStorage.setItem('user_notif_settings', JSON.stringify(saved));
        
        App.showToast(checkbox.checked ? "Muted" : "Unmuted");
    },

    // --- 2. ENCRYPTION PAGE LOGIC ---
    openEncryptionPage: () => {
        App.goToPage('encryption-page');
    },

    // --- 3. DISAPPEARING MESSAGES LOGIC (Syncs with Database) ---
    openDisappearingPage: () => {
        App.goToPage('disappearing-page');
        
        // 1. Reset Visual Selection
        document.querySelectorAll('.radio-dot').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.radio-circle').forEach(el => el.style.borderColor = '#8696a0');

        // 2. Get Real Setting from Group Data
        const g = state.currentGroupData;
        const current = (g.settings && g.settings.disappearing) ? g.settings.disappearing : 'Off';
        
        // 3. Find which ID matches the setting
        let id = 'timer-off';
        if(current === '24 hours') id = 'timer-24h';
        if(current === '7 days') id = 'timer-7d';
        if(current === '90 days') id = 'timer-90d';

        // 4. Highlight the Active Option
        const activeDot = document.getElementById(id);
        if(activeDot) {
            activeDot.style.display = 'block';
            activeDot.parentElement.style.borderColor = '#00a884';
        }
    },

    setDisappearingTimer: async (value) => {
        // 1. Update UI Selection immediately (for speed)
        document.querySelectorAll('.radio-dot').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.radio-circle').forEach(el => el.style.borderColor = '#8696a0');
        
        const targetId = value === 'Off' ? 'timer-off' : (value === '24 hours' ? 'timer-24h' : (value === '7 days' ? 'timer-7d' : 'timer-90d'));
        const dot = document.getElementById(targetId);
        if(dot) {
            dot.style.display = 'block';
            dot.parentElement.style.borderColor = '#00a884';
        }

        // 2. Save to Database
        const chatId = state.currentChatId;
        App.showToast(`Updating timer...`);
        
        try {
            // Import Firestore functions if not globally available
            const { updateDoc, doc, addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

            // Update the Chat Settings
            await updateDoc(doc(db, "chats", chatId), {
                "settings.disappearing": value
            });
            
            // Update local state so it remembers without reloading
            if(state.currentGroupData && state.currentGroupData.settings) {
                state.currentGroupData.settings.disappearing = value;
            }

            // 3. Send System Notification to the Group Chat
            const text = value === 'Off' 
                ? `You turned off disappearing messages.` 
                : `You updated the disappearing message timer to ${value}.`;
                
            await addDoc(collection(db, "chats", chatId, "messages"), {
                text: text,
                isSystem: true,
                timestamp: Date.now()
            });
            
            App.showToast("Timer updated");

        } catch(e) {
            console.error(e);
            alert("Failed to update setting. Check your internet.");
        }
    },
            // --- GROUP ICON & MENU LOGIC ---

    // 1. OPEN THE MENU (This fixes your error)
    openGroupIconMenu: () => {
        const modal = document.getElementById('modal-group-icon');
        if(modal) {
            modal.style.display = 'flex';
            modal.querySelector('.bottom-sheet').style.display = 'block';
        } else {
            console.error("Modal HTML missing!");
        }
    },

    // 2. HANDLE CAMERA / GALLERY INPUT
    handleIconFile: (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                App.setGroupIcon(e.target.result); // Save it
                App.closeModal('modal-group-icon'); // Close menu
            };
            reader.readAsDataURL(file);
        }
    },

    // 3. OPEN EMOJI EDITOR PAGE
    openEmojiEditor: () => {
        App.closeModal('modal-group-icon');
        App.goToPage('emoji-editor-page');
        // Reset defaults
        document.getElementById('emoji-preview-bg').style.background = '#a5bfe2';
        document.getElementById('emoji-preview-text').innerText = 'ðŸ˜‚';
    },

    // 4. EMOJI EDITOR HELPERS
    setEmojiBg: (color) => {
        document.getElementById('emoji-preview-bg').style.background = color;
        // Visual selection logic
        document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('selected'));
        event.target.classList.add('selected');
    },

    setEmoji: (emoji) => {
        document.getElementById('emoji-preview-text').innerText = emoji;
    },

    saveEmojiIcon: () => {
        // Create an image from the emoji HTML
        const canvas = document.createElement('canvas');
        canvas.width = 500;
        canvas.height = 500;
        const ctx = canvas.getContext('2d');
        
        // Draw Circle
        const color = document.getElementById('emoji-preview-bg').style.background;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(250, 250, 250, 0, Math.PI * 2);
        ctx.fill();
        
        // Draw Text
        const emoji = document.getElementById('emoji-preview-text').innerText;
        ctx.font = "250px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(emoji, 250, 270);
        
        const base64 = canvas.toDataURL('image/png');
        App.setGroupIcon(base64);
        App.goToPage('group-info-page');
    },

    // 5. OPEN WEB SEARCH PAGE
    openWebSearch: () => {
        App.closeModal('modal-group-icon');
        App.goToPage('web-search-page');
        const input = document.getElementById('web-search-input');
        if(input) input.focus();
    },

    performWebSearch: (query) => {
        const container = document.getElementById('web-search-results');
        container.innerHTML = '<div style="grid-column:span 3;text-align:center;margin-top:20px;color:gray;">Searching...</div>';
        
        // SIMULATED RESULTS (For Demo)
        setTimeout(() => {
            container.innerHTML = "";
            const mocks = [
                `https://dummyimage.com/400x400/222/fff&text=${query}`,
                `https://dummyimage.com/400x400/444/fff&text=Image+2`,
                `https://dummyimage.com/400x400/666/fff&text=Image+3`,
                "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                "https://cdn-icons-png.flaticon.com/512/166/166258.png"
            ];
            
            mocks.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = "web-img-result";
                img.onclick = () => {
                    App.setGroupIcon(src);
                    App.goToPage('group-info-page');
                };
                container.appendChild(img);
            });
        }, 1000);
    },

    // 6. SAVE ICON TO DATABASE
    setGroupIcon: async (base64OrUrl) => {
        // Update UI immediately
        const iconEl = document.getElementById('gi-icon');
        if(iconEl) iconEl.src = base64OrUrl;
        
        const chatId = state.currentChatId;
        if(chatId) {
            try {
                const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await updateDoc(doc(db, "chats", chatId), {
                    "groupInfo.photo": base64OrUrl
                });
                
                App.showToast("Group icon updated");
                
                // Update local chat list
                DataManager.updateChatList(chatId, null, null, base64OrUrl);
                
            } catch(e) {
                console.error("Save Error:", e);
                App.showToast("Error saving icon");
            }
        }
    },
        // --- DRAWER LOGIC ---
    toggleEmojiDrawer: () => {
        const drawer = document.getElementById('emoji-drawer');
        const icon = document.getElementById('input-emoji-btn');
        
        if (drawer.style.display === 'flex') {
            drawer.style.display = 'none';
            icon.className = "fa-regular fa-face-smile";
            document.getElementById('msg-input').focus();
        } else {
            drawer.style.display = 'flex';
            icon.className = "fa-solid fa-keyboard"; // Switch icon to keyboard
            App.renderChatEmojiGrid(); 
        }
    },

    closeEmojiDrawer: () => {
        document.getElementById('emoji-drawer').style.display = 'none';
        document.getElementById('input-emoji-btn').className = "fa-regular fa-face-smile";
    },

        switchDrawerTab: (tabName) => {
        document.getElementById('view-emoji').style.display = tabName === 'emoji' ? 'block' : 'none';
        document.getElementById('view-sticker').style.display = tabName === 'sticker' ? 'block' : 'none';
        document.getElementById('view-gif').style.display = tabName === 'gif' ? 'flex' : 'none';
        
        // Update Borders
        document.getElementById('d-tab-emoji').style.borderBottomColor = tabName === 'emoji' ? '#00a884' : 'transparent';
        document.getElementById('d-tab-sticker').style.borderBottomColor = tabName === 'sticker' ? '#00a884' : 'transparent';
        document.getElementById('d-tab-gif').style.borderBottomColor = tabName === 'gif' ? '#00a884' : 'transparent';
    },

        renderChatEmojiGrid: () => {
        const container = document.getElementById('chat-emoji-grid');
        
        // Prevent duplicating the grid if it's already built
        if (container.innerHTML !== "") return;

        const list = "ðŸ˜‚ ðŸ˜ ðŸ˜­ ðŸ˜Ž ðŸ¤£ ðŸ˜Š ðŸ™ ðŸ¥° ðŸ˜’ ðŸ˜˜ ðŸ˜¡ ðŸ¤” ðŸ™„ ðŸ˜¬ ðŸ¤¯ ðŸ¥³ ðŸ¥º ðŸ¤  ðŸ˜ˆ ðŸ‘» ðŸ’€ ðŸ‘½ ðŸ¤– ðŸŽƒ".split(" ");

        list.forEach(char => {
            const span = document.createElement('span');
            span.style.cssText = "font-size: 28px; text-align: center; cursor: pointer; padding: 5px;";
            span.innerText = char;

            // ðŸŒŸ SMART CLICK LOGIC ðŸŒŸ
            span.onclick = () => { 
                if (state.isReactionMode) {
                    // Scenario A: Opened via the "+" on a message reaction bar
                    App.reactToMessage(char); 
                    
                    // Reset the flag so the next time it works for typing
                    state.isReactionMode = false; 
                } else {
                    // Scenario B: Opened via the smiley icon in the input bar
                    document.getElementById('msg-input').value += char; 
                }
            };

            container.appendChild(span);
        });
    },

        sendSticker: (src) => {
        // The last 'true' tells sendMessage this is a sticker
        App.sendMessage(null, src, false, null, false, true); 
        App.closeEmojiDrawer();
    },
        // --- STICKER MENU & LOGIC ---

        // --- STICKER MENU & MAKER LOGIC ---

    openStickerMenu: (src) => {
        state.menuTargetSrc = src;
        document.getElementById('menu-sticker-preview').src = src;
        const isFav = state.stickerData.favorites.has(src);
        document.getElementById('menu-fav-text').innerText = isFav ? "Remove from Favorites" : "Add to Favorites";
        document.getElementById('menu-fav-icon').className = isFav ? "fa-solid fa-star" : "fa-regular fa-star";
        document.getElementById('menu-fav-icon').style.color = isFav ? "#FFD700" : "#8696a0";
        document.getElementById('sticker-options-menu').style.display = 'flex';
    },

    closeStickerMenu: () => {
        document.getElementById('sticker-options-menu').style.display = 'none';
        state.menuTargetSrc = null;
    },

    handleStickerMenuAction: (action) => {
    const src = state.menuTargetSrc;
    if (!src) return;

    if (action === 'favorite') {
        const isFav = state.stickerData.favorites.has(src);
        if (isFav) {
            state.stickerData.favorites.delete(src);
            // Also remove from the default "Favorites" pack
            state.stickerData.packs = state.stickerData.packs.filter(p => p.src !== src);
            App.showToast("Removed from Favorites");
        } else {
            state.stickerData.favorites.add(src);
            // ðŸŒŸ SYNC TO PACKS: Add to the persistent pack array
            state.stickerData.packs.push({ 
                name: "Favorites", 
                src: src, 
                id: "fav_" + Date.now() 
            });
            App.showToast("Added to Sticker Pack âœ…");
        }
    } else if (action === 'edit') {
        App.openStickerMaker(src);
    }
    App.closeStickerMenu();
 },


    openCreatePackModal: () => {
        App.closeStickerMenu();
        document.getElementById('modal-create-pack').style.display = 'flex';
    },

    createNewStickerPack: () => {
        const name = document.getElementById('new-pack-name').value;
        const src = state.menuTargetSrc;
        if(name && src) {
            state.stickerData.packs.push({ name: name, stickers: [src] });
            App.showToast(`Sticker added to pack "${name}"`);
            document.getElementById('modal-create-pack').style.display = 'none';
        }
    },

    openStickerMaker: (editSrc = null) => {
        // 1. Clear overlays
        App.closeStickerMenu();
        App.closeEmojiDrawer();

        // 2. Use the Page Router to override the CSS !important rule
        App.goToPage('sticker-maker-page');
        
        const preview = document.getElementById('sticker-editor-preview');
        const placeholder = document.getElementById('editor-placeholder');

        if(editSrc && typeof editSrc === 'string') {
            preview.src = editSrc;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            preview.src = "";
            preview.style.display = 'none';
            placeholder.style.display = 'block';
        }
    },

    closeStickerMaker: () => {
        // Return to the chat room using the router
        App.goToPage('chat-room');
    },

    loadMakerImage: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('sticker-editor-preview');
                const placeholder = document.getElementById('editor-placeholder');
                
                preview.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    },

    saveNewSticker: () => {
        const preview = document.getElementById('sticker-editor-preview');
        const src = preview.src;

        // Validation: Ensure an image exists and isn't just the page URL
        if(!src || src === window.location.href || src.includes('index.html')) {
            return alert("Please upload an image first");
        }
        
        // Add to local state favorites if available
        if(state.stickerData && state.stickerData.favorites) {
            state.stickerData.favorites.add(src);
        }
        
        // Send to chat and close the editor
        App.sendSticker(src); 
        App.closeStickerMaker();
    },

              // --- REAL LINKED DEVICE LOGIC ---

    // 1. Open Page & Render List
    openLinkedDevices: () => {
        const menu = document.getElementById('chat-menu-dropdown');
        if(menu) menu.classList.remove('active');
        App.goToPage('linked-devices-page');
        App.renderLinkedDevices();
    },

    // 2. Start the Real Camera
    startRealScanner: () => {
        App.goToPage('real-scanner-page');
        
        // Initialize HTML5 QR Library
        if(!state.html5QrCode) {
            state.html5QrCode = new Html5Qrcode("reader");
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        state.html5QrCode.start(
            { facingMode: "environment" }, // Back Camera
            config,
            (decodedText, decodedResult) => {
                // SUCCESS: QR Code Read!
                App.handleRealScanSuccess(decodedText);
            },
            (errorMessage) => {
                // Scanning... (ignore errors while scanning)
            }
        ).catch(err => {
            alert("Camera error: " + err);
            App.stopRealScanner();
        });
    },

    // 3. Stop Camera
    stopRealScanner: () => {
        if(state.html5QrCode) {
            state.html5QrCode.stop().then(() => {
                state.html5QrCode.clear();
                App.goToPage('linked-devices-page');
            }).catch(err => console.log(err));
        } else {
            App.goToPage('linked-devices-page');
        }
    },

    // 4. Handle Successful Scan
    handleRealScanSuccess: async (qrData) => {
        // Stop scanning immediately
        if(state.html5QrCode) {
            await state.html5QrCode.stop();
            state.html5QrCode.clear();
        }

        App.goToPage('linked-devices-page');
        App.showToast("Linking device...");

        // ðŸŒŸ REAL LOGIC:
        // In a real app, the QR code contains a Session ID from the computer.
        // We pretend the QR code text is the Device Name or ID.
        
        const newDevice = {
            id: "dev_" + Date.now(),
            name: "Chrome (Windows)", // In production, you'd parse this from the QR
            icon: "fa-brands fa-chrome",
            active: true,
            time: "Active"
        };

        // Save to LocalStorage (or Firebase)
        let list = JSON.parse(localStorage.getItem('linked_devices') || '[]');
        list.unshift(newDevice);
        localStorage.setItem('linked_devices', JSON.stringify(list));

        App.renderLinkedDevices();
        App.showToast("Device Linked Successfully!");
    },

    // 5. Render the List
    renderLinkedDevices: () => {
        const list = document.getElementById('linked-devices-list');
        const devices = JSON.parse(localStorage.getItem('linked_devices') || '[]');
        list.innerHTML = "";

        if (devices.length === 0) return;

        devices.forEach(d => {
            const statusColor = d.active ? '#008069' : '#666';
            const statusWeight = d.active ? 'bold' : 'normal';
            
            list.innerHTML += `
                <div class="list-item" onclick="app.logoutDevice('${d.id}')">
                    <div style="width: 45px; height: 45px; background: #e9edef; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: #54656f; font-size: 20px;">
                        <i class="${d.icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; font-size: 16px; color: #111;">${d.name}</div>
                        <div style="font-size: 13px; color: ${statusColor}; font-weight: ${statusWeight};">
                            ${d.time}
                        </div>
                    </div>
                </div>`;
        });
    },

    // 6. Logout
    logoutDevice: (id) => {
        if(confirm("Log out this device?")) {
            let list = JSON.parse(localStorage.getItem('linked_devices') || '[]');
            list = list.filter(d => d.id !== id);
            localStorage.setItem('linked_devices', JSON.stringify(list));
            App.renderLinkedDevices();
        }
    },
        // --- AUTH MENU & COMPANION LOGIC ---

    // 1. Toggle the 3-dot menu on Auth Page
    toggleAuthMenu: () => {
        const menu = document.getElementById('auth-menu-dropdown');
        menu.classList.toggle('active');
        
        // Auto-close when clicking away
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('#auth-menu-dropdown') && !e.target.closest('.fa-ellipsis-vertical')) {
                    menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            }, { once: true }); // Ensure it only runs once
        }, 100);
    },

    // 2. Open the Companion QR Page
    openLinkCompanion: () => {
        // Close the menu
        document.getElementById('auth-menu-dropdown').classList.remove('active');
        
        // Go to the QR Page
        App.goToPage('companion-qr-page');
        
        // Generate a new code
        App.generateLoginQR();
    },

    // 3. Generate the QR Code (Simulated)
    generateLoginQR: () => {
        const qrImg = document.getElementById('companion-qr-display');
        qrImg.style.opacity = "0.5"; // Visual loading state
        
        // Simulate a unique Session ID
        const sessionID = "session_" + Date.now();
        const link = `https://globalconnect.app/auth/${sessionID}`;
        
        // Use QR Server API to generate the image
        setTimeout(() => {
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(link)}`;
            qrImg.style.opacity = "1";
            App.showToast("Scan with your main phone");
        }, 500);
    },
        // --- PRIVACY SETTINGS LOGIC ---

    // 1. Open Main Privacy Page
    openPrivacySettings: async () => {
        App.goToPage('privacy-settings-page');
        
        // Load current settings from DB User Profile
        const u = state.currentUser;
        if (!u) return;

        // Fetch fresh data if needed (optional optimization)
        const docRef = doc(db, "users", u.uid);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
            const data = snap.data();
            const p = data.privacy || {}; // { lastSeen: 'Everyone', ... }

            // Update UI Text
            document.getElementById('priv-disp-lastSeen').innerText = p.lastSeen || 'Everyone';
            document.getElementById('priv-disp-profilePhoto').innerText = p.profilePhoto || 'Everyone';
            document.getElementById('priv-disp-about').innerText = p.about || 'Everyone';
            
            // Update Read Receipts Toggle
            document.getElementById('priv-read-receipts').checked = p.readReceipts !== false; // Default true
            
            // Update Blocked Count
            const blockedCount = data.blocked ? data.blocked.length : 0;
            document.getElementById('priv-disp-blocked').innerText = blockedCount > 0 ? blockedCount : "None";
        }
    },

    // 2. Open Selection Modal
    openPrivacyOption: (settingKey) => {
        state.currentPrivacyKey = settingKey; // Remember what we are editing
        
        // Set Title
        const titles = {
            'lastSeen': 'Last seen and online',
            'profilePhoto': 'Profile photo',
            'about': 'About'
        };
        document.getElementById('priv-modal-title').innerText = titles[settingKey];

        // Highlight current selection
        const currentVal = document.getElementById(`priv-disp-${settingKey}`).innerText;
        document.querySelectorAll('.radio-dot').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.radio-circle').forEach(el => el.style.borderColor = '#ccc');
        
        // Find matching dot (Simulated logic)
        let dotId = 'dot-Everyone';
        if(currentVal === 'My contacts') dotId = 'dot-Contacts';
        if(currentVal === 'Nobody') dotId = 'dot-Nobody';
        
        const dot = document.getElementById(dotId);
        if(dot) {
            dot.style.display = 'block';
            dot.parentElement.style.borderColor = '#008069';
        }

        // Show Modal
        document.getElementById('privacy-option-modal').style.display = 'flex';
        document.getElementById('privacy-option-modal').querySelector('.bottom-sheet').style.display = 'block';
    },

    // 3. Save Selection
    setPrivacyValue: async (value) => {
        const key = state.currentPrivacyKey;
        if(!key) return;

        // Update UI immediately
        document.getElementById(`priv-disp-${key}`).innerText = value;
        document.getElementById('privacy-option-modal').style.display = 'none';

        // Update Database
        try {
            await updateDoc(doc(db, "users", state.currentUser.uid), {
                [`privacy.${key}`]: value
            });
        } catch(e) {
            console.error("Privacy Save Error:", e);
        }
    },

    // 4. Toggle Read Receipts
    toggleReadReceipts: async () => {
        const val = document.getElementById('priv-read-receipts').checked;
        try {
            await updateDoc(doc(db, "users", state.currentUser.uid), {
                "privacy.readReceipts": val
            });
            App.showToast(val ? "Read receipts on" : "Read receipts off");
        } catch(e) { console.error(e); }
    },

    // --- BLOCKED CONTACTS LOGIC ---

    // 5. Open Blocked List
    openBlockedContacts: async () => {
        App.goToPage('blocked-contacts-page');
        const container = document.getElementById('blocked-list-container');
        container.innerHTML = '<div style="padding:20px;text-align:center;">Loading...</div>';

        try {
            const userSnap = await getDoc(doc(db, "users", state.currentUser.uid));
            const blockedIds = userSnap.data().blocked || [];
            
            container.innerHTML = "";
            
            if(blockedIds.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:gray;">No blocked contacts</div>';
                return;
            }

            // Load details for each blocked user
            for (const uid of blockedIds) {
                // Try cache first, then DB
                let u = { name: "Unknown", photo: "https://cdn-icons-png.flaticon.com/512/847/847969.png" };
                try {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(snap.exists()) u = snap.data();
                } catch(e){}

                const div = document.createElement('div');
                div.className = "list-item";
                div.innerHTML = `
                    <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="list-avatar">
                    <div style="flex:1; font-weight:500;">${u.name}</div>
                    <div onclick="app.unblockUser('${uid}')" style="color:#d32f2f; font-size:13px; font-weight:bold; cursor:pointer;">Unblock</div>
                `;
                container.appendChild(div);
            }
        } catch(e) {
            container.innerHTML = "Error loading list.";
        }
    },

    // 6. Open Picker to Block Someone
    openBlockPicker: () => {
        // Reuse your existing contact list logic but change the click action
        // For simplicity in this step, we'll use a prompt or reuse the 'create-group-select-page' logic
        const target = prompt("Enter User ID to block (Simulated Picker):");
        if(target) App.blockUser(target);
    },

    // 7. Block Action
    blockUser: async (targetUid) => {
        if(!targetUid) return;
        const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        try {
            await updateDoc(doc(db, "users", state.currentUser.uid), {
                blocked: arrayUnion(targetUid)
            });
            App.showToast("Contact blocked");
            App.openBlockedContacts(); // Refresh list
        } catch(e) { alert("Error: " + e.message); }
    },

    // 8. Unblock Action
    unblockUser: async (targetUid) => {
        if(!confirm("Unblock this contact?")) return;
        const { arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        try {
            await updateDoc(doc(db, "users", state.currentUser.uid), {
                blocked: arrayRemove(targetUid)
            });
            App.showToast("Contact unblocked");
            App.openBlockedContacts(); // Refresh list
        } catch(e) { alert("Error: " + e.message); }
    },
        // 1. Open the Editor and Pre-fill Data
    openProfileEditor: () => {
        App.goToPage('profile-editor-page');
        
        const profile = DataManager.getProfile();
        
        // Fill inputs with current data
        document.getElementById('editor-name').value = profile.name || "";
        document.getElementById('editor-bio').value = profile.bio || "";
        document.getElementById('editor-avatar-preview').src = profile.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        // Reset temp image logic
        state.tempProfileImage = null; 
    },

    // 2. Close Editor (Cancel)
    closeProfileEditor: () => {
        // Go back to your display page
        App.goToPage('edit-profile-page'); 
    },

    // 3. Handle Image Selection (Preview only)
    handleEditImage: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('editor-avatar-preview').src = e.target.result;
                state.tempProfileImage = e.target.result; // Save temporarily
            };
            reader.readAsDataURL(input.files[0]);
        }
    },

    // 4. SAVE CHANGES (The Real Work)
    saveProfileChanges: async () => {
        const btn = event.target;
        btn.innerText = "Saving...";
        
        const newName = document.getElementById('editor-name').value.trim();
        const newBio = document.getElementById('editor-bio').value.trim();
        // Use new image if selected, otherwise keep old one
        const newPhoto = state.tempProfileImage || DataManager.getProfile().photo; 

        if (!newName) {
            alert("Name cannot be empty");
            btn.innerText = "Save";
            return;
        }

        try {
            // A. Update Firebase Database
            const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            await updateDoc(doc(db, "users", state.currentUser.uid), {
                name: newName,
                bio: newBio,
                photo: newPhoto
            });

            // B. Update Local Storage
            const currentProfile = DataManager.getProfile();
            const updatedProfile = { 
                ...currentProfile, 
                name: newName, 
                bio: newBio, 
                photo: newPhoto 
            };
            DataManager.saveProfile(updatedProfile);

            // C. Success!
            App.showToast("Profile Saved!");
            btn.innerText = "Save";
            
            // D. Go back and Refresh
            App.openMyProfile(); 

        } catch (e) {
            console.error(e);
            alert("Save failed: " + e.message);
            btn.innerText = "Save";
        }
    },
        // --- 1. OPEN SHOP ---
    openShopPage: () => {
        App.goToPage('shop-page');
        // Update balance display
        const profile = DataManager.getProfile();
        document.getElementById('shop-balance').innerText = profile.orbs || 0;
    },
        // --- CREATE CHANNEL LOGIC ---

    // 1. Open the Page
    openCreateChannel: () => {
        // Close menu if open
        const menu = document.getElementById('chat-menu-dropdown');
        if(menu) menu.classList.remove('active');

        App.goToPage('create-channel-page');
        
        // Reset Inputs
        document.getElementById('channel-name-input').value = "";
        document.getElementById('channel-desc-input').value = "";
        document.getElementById('channel-icon-preview').src = "https://cdn-icons-png.flaticon.com/512/3050/3050525.png";
        state.tempChannelIcon = null;
    },

    // 2. Handle Icon Selection
    handleChannelIcon: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('channel-icon-preview').src = e.target.result;
                state.tempChannelIcon = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    },

    // 3. Create in Firebase
    createNewChannel: async () => {
        const name = document.getElementById('channel-name-input').value.trim();
        const desc = document.getElementById('channel-desc-input').value.trim();
        const photo = state.tempChannelIcon || "https://cdn-icons-png.flaticon.com/512/3050/3050525.png";
        
        if (!name) return alert("Please enter a channel name.");

        const btn = event.target;
        btn.innerText = "Creating...";

        try {
            const myUid = state.currentUser.uid;
            const channelId = "channel_" + Date.now(); // Distinct ID prefix

            // A. Create Channel Document
            const { setDoc, doc, addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            await setDoc(doc(db, "chats", channelId), {
                participants: [myUid], // Start with just me
                admins: [myUid],       // I am the owner
                isGroup: true,         // Reuses group logic...
                isChannel: true,       // ...but this flag makes it special
                groupInfo: {
                    name: name,
                    description: desc,
                    photo: photo,
                    createdBy: myUid
                },
                // ðŸŒŸ VITAL: Channel Permissions (Admins only)
                settings: {
                    sendMessages: false, // Only admins can send
                    editInfo: false,
                    addMembers: false,   // People subscribe, not added
                    disappearing: 'Off'
                },
                lastMsg: "Channel created",
                timestamp: Date.now()
            });

            // B. Send Welcome Message
            await addDoc(collection(db, "chats", channelId, "messages"), {
                text: `ðŸ“¢ Welcome to **${name}**!\n${desc}`,
                senderId: myUid,
                isSystem: true,
                timestamp: Date.now()
            });

            // C. Update Local List & Open
            DataManager.updateChatList(channelId, { text: "Channel created", time: "Just now" }, name, photo);
            App.openChat(channelId, name, photo);
            
            btn.innerText = "Create Channel"; // Reset button

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
            btn.innerText = "Create Channel";
        }
    },
                    // --- OPEN CHANNEL PROFILE (Now with Working Settings Button) ---
    openChannelProfile: async () => {
        const chatId = state.currentChatId;
        if(!chatId) return;

        // 1. Switch to the page
        App.goToPage('channel-profile-page');
        
        try {
            const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // 2. Fetch Fresh Data from Firestore
            const snap = await getDoc(doc(db, "chats", chatId));
            if(!snap.exists()) return;
            const g = snap.data();
            
            const info = g.groupInfo || {};
            const participants = g.participants || [];
            const admins = g.admins || [];
            const settings = g.settings || {}; // Load settings for labels
            
            // Check if current user is an admin
            const myUid = state.currentUser.uid;
            const amIAdmin = admins.includes(myUid);

            // 3. Populate Header UI
            document.getElementById('cp-name').innerText = info.name || "Channel";
            document.getElementById('cp-icon').src = info.photo || "https://cdn-icons-png.flaticon.com/512/3050/3050525.png";
            
            const followerCount = participants.length;
            document.getElementById('cp-followers').innerText = `Channel â€¢ ${followerCount} followers`;
            document.getElementById('cp-followers-title').innerText = `${followerCount} followers`;
            document.getElementById('cp-net-follows').innerText = followerCount;
            
            document.getElementById('cp-desc').innerText = info.description || "No description provided.";
            
            const createdDate = g.createdAt ? new Date(g.createdAt).toLocaleDateString() : "Recently";
            document.getElementById('cp-date').innerText = `Created on ${createdDate}`;

            // 4. DYNAMIC SETTINGS (Hides Admin tools from Followers)
            const settingsContainer = document.getElementById('cp-settings-container');
            if (settingsContainer) {
                // Determine current emoji label for the display
                const policy = settings.emojiPolicy || 'any';
                const policyLabel = policy === 'any' ? 'Any emoji' : (policy === 'default' ? 'Default only' : 'None');

                // Standard items everyone sees
                let html = `
                    <div class="list-item" style="border-bottom: none;">
                        <i class="fa-regular fa-bell" style="width: 30px; text-align: center; color: #54656f; font-size: 20px;"></i>
                        <div style="flex: 1; font-size: 16px;">Notifications</div>
                    </div>
                    <div class="list-item" style="border-bottom: none;">
                        <i class="fa-solid fa-earth-americas" style="width: 30px; text-align: center; color: #54656f; font-size: 20px;"></i>
                        <div style="flex: 1;">
                            <div style="font-size: 16px;">Public channel</div>
                        </div>
                    </div>
                `;

                // Add Admin-only items ONLY if user is Admin
                if (amIAdmin) {
                    html += `
                        <div class="list-item" style="border-bottom: none;" onclick="app.goToPage('channel-settings-admin-page')">
                            <i class="fa-solid fa-gear" style="width: 30px; text-align: center; color: #54656f; font-size: 20px;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 16px;">Channel settings</div>
                                <div style="font-size: 13px; color: #54656f;">Reactions: ${policyLabel}</div>
                            </div>
                            <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
                        </div>
                        <div class="list-item" style="border-bottom: none;" onclick="alert('Alerts coming soon')">
                            <i class="fa-solid fa-triangle-exclamation" style="width: 30px; text-align: center; color: #54656f; font-size: 20px;"></i>
                            <div style="flex: 1; font-size: 16px;">Channel alerts</div>
                        </div>
                    `;
                    // Show Delete Button
                    document.getElementById('cp-delete-btn').style.display = 'block';
                } else {
                    // Hide Delete Button for Followers
                    document.getElementById('cp-delete-btn').style.display = 'none';
                }

                settingsContainer.innerHTML = html;
            }

            // 5. ADMIN LIST SECTION
            const adminList = document.getElementById('cp-admin-list');
            if (adminList) {
                adminList.innerHTML = "";
                
                if (amIAdmin) {
                    const myProfile = DataManager.getProfile();
                    adminList.innerHTML = `
                        <div class="list-item" style="padding: 10px 20px; border-bottom: none;">
                            <img src="${myProfile.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="list-avatar" style="width:40px; height:40px;">
                            <div style="flex: 1;">
                                <div style="font-size:16px; color:#111b21;">You</div>
                                <div style="font-size:13px; color:#54656f;">You're not visible to followers</div>
                            </div>
                            <div class="admin-badge" style="background:#e9edef; color:#54656f; border:none;">Admin</div>
                        </div>`;
                } else {
                    // Privacy: User B doesn't see admin details
                    adminList.innerHTML = `<div style="padding:20px; color:gray; font-size:13px; text-align:center;">Admin information is private</div>`;
                }
            }
            
        } catch(e) {
            console.error("Profile Logic Error:", e);
            App.showToast("Error loading channel info");
        }
    },

        // --- CHANNEL LINK PAGE LOGIC ---

    // 1. Open the Link Page
    openChannelLinkPage: async () => {
        const chatId = state.currentChatId;
        if(!chatId) return;

        App.goToPage('channel-link-page');

        // Fetch basic info (Try local cache first)
        let name = "Channel";
        let photo = "https://cdn-icons-png.flaticon.com/512/3050/3050525.png";

        // Try to get data from the currently open chat header first
        const headerName = document.getElementById('cp-name');
        if(headerName) name = headerName.innerText;
        const headerIcon = document.getElementById('cp-icon');
        if(headerIcon) photo = headerIcon.src;

        // Generate Real Link
        // Creates a link like: https://your-site.com/?channel=channel_12345
        const link = `${window.location.origin}/?channel=${chatId}`;
        state.currentChannelLink = link;

        // Update UI
        document.getElementById('cl-name').innerText = name;
        document.getElementById('cl-icon').src = photo;
        document.getElementById('cl-link-text').innerText = link;
    },

    // 2. Copy Link
    copyChannelLink: () => {
        if(state.currentChannelLink) {
            navigator.clipboard.writeText(state.currentChannelLink);
            App.showToast("Link copied");
        }
    },

    // 3. Share to Status
    shareChannelToStatus: () => {
        const link = state.currentChannelLink;
        App.openStatusEditor(); 
        App.switchStatusMode('text');
        setTimeout(() => {
            document.getElementById('status-text-input').value = link;
            document.getElementById('mode-text').style.background = "#e9edef"; // Light background like screenshot
            document.getElementById('status-text-input').style.color = "#008069";
        }, 300);
    },

    // 4. Share System
    shareChannelSystem: async () => {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Follow my channel',
                    text: 'Follow this channel on Global Connect:',
                    url: state.currentChannelLink
                });
            } catch (err) {}
        } else {
            App.copyChannelLink();
        }
    },

    shareChannelLinkInternal: () => {
        alert("Forwarding to contacts... (Select contact logic here)");
        App.goToPage('chat-list-page');
    },
        // 1. Pop Sound
    playReactionSound: () => {
        const pop = new Audio("https://www.soundjay.com/buttons/sounds/button-20.mp3");
        pop.volume = 0.4;
        pop.play().catch(e => {}); 
    },

    // 2. Shake & Float Animation
        // --- ANIMATE REACTION (Telegram-Style Particle Burst) ---
    animateReaction: (msgId, emoji) => {
        const msgEl = document.getElementById(`msg-${msgId}`);
        if (!msgEl) return;

        // 1. Physical Feedback: Shake the bubble
        msgEl.classList.add('shaking');
        setTimeout(() => msgEl.classList.remove('shaking'), 200);

        // 2. Visual Feedback: Spawn 5 particles for the "burst" effect
        for (let i = 0; i < 5; i++) {
            const floater = document.createElement('div');
            floater.className = 'floating-reaction';
            floater.innerText = emoji;

            // Generate random burst directions using CSS variables
            // tx: horizontal spread (-70px to 70px)
            // ty: vertical height (-50px to -140px)
            const x = (Math.random() * 140 - 70) + 'px';
            const y = (Math.random() * -140 - 50) + 'px';
            
            floater.style.setProperty('--tx', x);
            floater.style.setProperty('--ty', y);

            msgEl.appendChild(floater);

            // Clean up each particle after the animation ends (600ms)
            setTimeout(() => floater.remove(), 600);
        }

        // 3. Audio Feedback: Play the pop sound
        if (typeof App.playReactionSound === 'function') {
            App.playReactionSound();
        }
    },

              // --- REACT TO MESSAGE (One Reaction Per User) ---
    reactToMessage: async (emoji) => {
        if (!state.selectedMessage) return;
        
        const msgId = state.selectedMessage.id;
        const chatId = state.currentChatId;
        const myUid = state.currentUser.uid;
        const isGroupOrChannel = chatId.startsWith('group_') || chatId.startsWith('channel_');
        
        // 1. Get the message from local storage to check for Kelvin's PREVIOUS reaction
        let history = DataManager.getMessages(chatId);
        const msgIndex = history.findIndex(m => m.id === msgId);
        if (msgIndex === -1) return;

        const msg = history[msgIndex];
        const reactionDetails = msg.reactionDetails || {}; 
        const oldEmoji = reactionDetails[myUid]; // Find Kelvin's previous choice

        // 2. Prepare Database Updates
        const { doc, updateDoc, increment, deleteField } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const collectionPath = isGroupOrChannel ? `chats/${chatId}/messages` : `messages`;
        const msgRef = doc(db, collectionPath, msgId);
        
        let updates = {};

        // --- SCENARIO A: REMOVE REACTION (Tapped the same emoji again) ---
        if (oldEmoji === emoji) {
            updates[`reactions.${emoji}`] = increment(-1);
            updates[`reactionDetails.${myUid}`] = deleteField();
            
            // Local Update
            if (msg.reactions[emoji]) msg.reactions[emoji]--;
            delete reactionDetails[myUid];
        } 
        // --- SCENARIO B: CHANGE REACTION (Picked a different emoji) ---
        else if (oldEmoji) {
            updates[`reactions.${oldEmoji}`] = increment(-1);
            updates[`reactions.${emoji}`] = increment(1);
            updates[`reactionDetails.${myUid}`] = emoji;
            
            // Local Update
            if (msg.reactions[oldEmoji]) msg.reactions[oldEmoji]--;
            msg.reactions[emoji] = (msg.reactions[emoji] || 0) + 1;
            reactionDetails[myUid] = emoji;
        } 
        // --- SCENARIO C: NEW REACTION (First time reacting) ---
        else {
            updates[`reactions.${emoji}`] = increment(1);
            updates[`reactionDetails.${myUid}`] = emoji;
            
            // Local Update
            msg.reactions = msg.reactions || {};
            msg.reactions[emoji] = (msg.reactions[emoji] || 0) + 1;
            reactionDetails[myUid] = emoji;
        }

        // 3. OPTIMISTIC UI UPDATE (Instantly update Kelvin's screen)
        msg.reactionDetails = reactionDetails;
        localStorage.setItem(`chat_${chatId}`, JSON.stringify(history));
        App.renderMessages(chatId);

        // 4. FEEDBACK (Only if adding/changing, not if removing)
        if (oldEmoji !== emoji) {
            if (typeof App.animateReaction === 'function') App.animateReaction(msgId, emoji);
            if (typeof App.playReactionSound === 'function') App.playReactionSound();
            if (navigator.vibrate) navigator.vibrate([40, 30, 40]);
        }

        // 5. SEND TO FIREBASE
        try {
            await updateDoc(msgRef, updates);
            
            // Close UI
            App.deselectMessage(); 
            if (state.isReactionMode) {
                App.closeEmojiDrawer();
                state.isReactionMode = false;
            }
        } catch(e) {
            console.error("Reaction Error:", e);
            App.showToast("Connection failed");
        }
    },
    
    // ðŸŒŸ 1. FETCH LINK PREVIEW (Queries Firestore for Group/Channel data)
    fetchLinkPreview: async (id) => {
        try {
            const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // Look for the group/channel in your 'chats' collection
            const snap = await getDoc(doc(db, "chats", id));
            
            if (snap.exists()) {
                const data = snap.data();
                const info = data.groupInfo || {};

                // Show the floating bar above the keyboard
                const previewBar = document.getElementById('link-preview-bar');
                if(previewBar) {
                    previewBar.style.display = 'block';
                    document.getElementById('lp-title').innerText = info.name || "Group Chat";
                    document.getElementById('lp-image').src = info.photo || "https://cdn-icons-png.flaticon.com/512/166/166258.png";
                    
                    // Save to state so sendMessage can attach it to the message document
                    state.activeLinkPreview = {
                        title: info.name,
                        photo: info.photo,
                        id: id,
                        type: data.isChannel ? 'Channel' : 'Group'
                    };
                }
            }
        } catch (e) { 
            console.error("Link fetch failed:", e); 
        }
    },

    // ðŸŒŸ 2. CLOSE LINK PREVIEW (Hides the bar and clears state)
    closeLinkPreview: () => {
        const previewBar = document.getElementById('link-preview-bar');
        if(previewBar) previewBar.style.display = 'none';
        state.activeLinkPreview = null;
    },
        // 1. OPEN THE MODAL
    openEmojiPolicyModal: () => {
        const modal = document.getElementById('modal-emoji-policy');
        modal.style.display = 'flex';
        // Highlight the current setting
        const current = (state.currentGroupData && state.currentGroupData.settings) ? state.currentGroupData.settings.emojiPolicy : 'any';
        App.updateEmojiRadioVisuals(current || 'any');
    },

    // 2. VISUAL FEEDBACK FOR RADIOS
    updateEmojiRadioVisuals: (policy) => {
        document.querySelectorAll('.radio-circle').forEach(el => el.classList.remove('radio-active'));
        const activeCircle = document.getElementById(`rd-${policy}`);
        if(activeCircle) activeCircle.classList.add('radio-active');
        
        const displayLabel = policy === 'any' ? 'Any emoji' : (policy === 'default' ? 'Default only' : 'None');
        document.getElementById('chan-disp-emoji').innerText = displayLabel;
    },

    // 3. SAVE POLICY TO DATABASE
    setChannelEmojiPolicy: async (policy) => {
        const chatId = state.currentChatId;
        if (!chatId) return;

        App.updateEmojiRadioVisuals(policy);
        App.closeModal('modal-emoji-policy');

        try {
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            await updateDoc(doc(db, "chats", chatId), {
                "settings.emojiPolicy": policy
            });
            
            App.showToast(`Reactions updated to: ${policy}`);
            
            // Sync local state
            if(state.currentGroupData) {
                if(!state.currentGroupData.settings) state.currentGroupData.settings = {};
                state.currentGroupData.settings.emojiPolicy = policy;
            }
        } catch (e) {
            console.error("Save Policy Error:", e);
        }
    },

    // 4. TOGGLE CHANNEL SETTINGS (Edit Info Switch)
    toggleChannelSetting: async (key) => {
        const chatId = state.currentChatId;
        const val = event.target.checked;
        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        await updateDoc(doc(db, "chats", chatId), {
            [`settings.${key}`]: val
        });
        App.showToast("Settings updated");
    },
            // ðŸŒŸ Standardized to lowercase 'o' to match your onclick
    openReactionDetails: async (msgId) => {
    // 1. SAFETY CHECK: Prevent the "find" error if state is empty
    if (!state.currentMessages) {
        console.error("state.currentMessages is undefined. Ensure renderMessages saves the array.");
        return;
    }

    const msg = state.currentMessages.find(m => m.id === msgId);
    if (!msg || !msg.reactions) return;

    const totalCount = Object.values(msg.reactions).reduce((a, b) => a + b, 0);
    
    // ðŸŒŸ PRIVACY CHECK: Determine if we are in a Channel or Group
    const isChannel = state.currentChatId?.startsWith('channel_'); 

    // 2. Prepare Emoji Tabs (Aggregate counts always visible)
    const emojiTabs = Object.entries(msg.reactions)
        .filter(([_, count]) => count > 0)
        .map(([emoji, count]) => `<div class="react-tab" style="background:#f0f2f5; padding:6px 12px; border-radius:15px; font-size:14px; display:flex; align-items:center; gap:5px;">${emoji} <b>${count}</b></div>`)
        .join('');

    // 3. Prepare User List (Identity Logic)
    let userListHtml = "";
    if (!isChannel) {
        // âœ… GROUP MODE: Fetch and show names/avatars
        const details = msg.reactionDetails || {};
        
        for (const [uid, emoji] of Object.entries(details)) {
            // Get user info from DataManager cache or DB
            const user = await DataManager.getUserInfo(uid);
            userListHtml += `
                <div class="react-user-row" style="display:flex; align-items:center; padding:12px 20px; gap:15px;">
                    <img src="${user.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                    <div style="flex:1;">
                        <div style="font-weight:600; color:#111;">${user.name || 'User'}</div>
                        <div style="font-size:12px; color:gray;">Reacted to message</div>
                    </div>
                    <div style="font-size:22px;">${emoji}</div>
                </div>`;
        }
    } else {
        // ðŸ”’ CHANNEL MODE: Strictly anonymous aggregate view
        userListHtml = `
            <div style="padding:40px 20px; text-align:center; color:#8696a0;">
                <i class="fa-solid fa-eye-slash" style="font-size:30px; margin-bottom:15px; opacity:0.5;"></i>
                <p style="font-size:14px; font-style:italic;">Reactions in channels are anonymous to protect follower privacy.</p>
            </div>`;
    }

    // 4. Render Bottom Sheet
    const modalHtml = `
        <div id="sheet-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;" onclick="app.closeReactionDetails()"></div>
        <div id="reaction-details-sheet" class="bottom-sheet show" style="position:fixed; bottom:0; left:0; width:100%; background:white; z-index:10000; border-radius:20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div class="sheet-handle" style="width:40px; height:4px; background:#ddd; border-radius:2px; margin:12px auto;"></div>
            <div style="padding:0 20px 15px; font-weight:bold; border-bottom:1px solid #f0f0f0;">Reactions (${totalCount})</div>
            <div class="react-tabs-container" style="display:flex; gap:10px; padding:10px 20px; border-bottom:1px solid #f8f9fa; overflow-x:auto; scrollbar-width:none;">${emojiTabs}</div>
            <div class="react-users-list" style="max-height:60vh; overflow-y:auto; padding-bottom:30px;">${userListHtml}</div>
        </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
},

closeReactionDetails: () => {
    const sheet = document.getElementById('reaction-details-sheet');
    const overlay = document.getElementById('sheet-overlay');
    
    // Add logic to slide down before removing
    if (sheet) {
        sheet.style.transform = "translateY(100%)";
        sheet.style.transition = "transform 0.3s ease-in";
    }
    
    if (overlay) overlay.style.opacity = "0";

    setTimeout(() => {
        sheet?.remove();
        overlay?.remove();
    }, 300); 
 },

        // 1. Function to switch the app language
            // 1. Standardized function name (lowercase 'c')
    changeLanguage: (lang) => {
        localStorage.setItem('userLanguage', lang);
        state.currentLanguage = lang;

        // Update all static text tags
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                el.innerText = translations[lang][key];
            }
        });

        // Sync both dropdowns (Landing Page and Settings Page)
        const landingSelect = document.getElementById('lang-select');
        const settingsSelect = document.getElementById('settings-lang-select');
        if (landingSelect) landingSelect.value = lang;
        if (settingsSelect) settingsSelect.value = lang;

        // Update Input Placeholders
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        if (emailInput) {
            const placeholders = { "en": "Email Address", "fr": "Adresse e-mail", "es": "Correo electrÃ³nico", "pt": "EndereÃ§o de e-mail" };
            emailInput.placeholder = placeholders[lang] || placeholders["en"];
        }

        // ðŸŒŸ THE FIX: Call the correct function name (lowercase 'r')
        if (App.renderChatList) {
            App.renderChatList();
        }
    },

    // 2. Load saved language on startup
    initLanguage: () => {
        const savedLang = localStorage.getItem('userLanguage') || 'en';
        // Apply it using the standard function
        App.changeLanguage(savedLang);
    },
        // 1. SHOW OPTIONS MODAL
    showMemberOptions: (targetUid, name, photo, amIAdmin, isTargetAdmin) => {
        const group = state.currentGroupData;
        const ownerId = group.groupInfo.createdBy; 
        
        if (targetUid === state.currentUser.uid || !amIAdmin) return;
        if (navigator.vibrate) navigator.vibrate(40);

        state.selectedMemberId = targetUid;
        document.getElementById('mo-user-name').innerText = name;
        
        // Update the 5 avatars with the user's photo
        for(let i=1; i<=5; i++) {
            const imgEl = document.getElementById(`mo-img-${i}`);
            if(imgEl) imgEl.src = photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        }

        document.getElementById('member-options-modal').style.display = 'flex';

        const adminBtn = document.getElementById('mo-admin-toggle');
        const adminText = document.getElementById('mo-admin-text');
        const removeBtn = document.getElementById('mo-remove-user');

        if (targetUid === ownerId) {
            adminText.innerText = "Group Creator";
            adminBtn.onclick = null;
            removeBtn.style.display = "none";
        } else {
            adminText.innerText = isTargetAdmin ? "Dismiss as admin" : "Make group admin";
            adminBtn.onclick = () => app.toggleMemberAdmin(targetUid, isTargetAdmin);
            removeBtn.style.display = "flex";
            removeBtn.onclick = () => app.removeMemberFromGroup(targetUid, name);
        }
    },

    // 2. TOGGLE ADMIN STATUS
        // 2. TOGGLE ADMIN STATUS (With Security Check)
    toggleMemberAdmin: async (uid, isCurrentlyAdmin) => {
        const group = state.currentGroupData;
        const ownerId = group.groupInfo.createdBy; 

        // ðŸ›¡ï¸ SECURITY SHIELD: Reject if target is the owner
        if (uid === ownerId) {
            App.showToast("Error: Cannot demote the group owner.");
            return;
        }

        const { arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        App.closeModal('member-options-modal');
        
        await updateDoc(doc(db, "chats", state.currentChatId), {
            admins: isCurrentlyAdmin ? arrayRemove(uid) : arrayUnion(uid)
        });
        App.OpenGroupInfo(); 
    },

    // 3. REMOVE FROM GROUP (With Security Check)
    removeMemberFromGroup: async (uid, name) => {
        const group = state.currentGroupData;
        const ownerId = group.groupInfo.createdBy;

        // ðŸ›¡ï¸ SECURITY SHIELD: Reject if target is the owner
        if (uid === ownerId) {
            App.showToast("Action Denied: Cannot remove the owner.");
            return;
        }

        if (!confirm(`Remove ${name} from group?`)) return;
        const { arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        App.closeModal('member-options-modal');
        const chatId = state.currentChatId;

        await updateDoc(doc(db, "chats", chatId), {
            participants: arrayRemove(uid),
            admins: arrayRemove(uid),
            lastMsg: `${name} was removed` 
        });

        await addDoc(collection(db, "chats", chatId, "messages"), {
            text: `An admin removed ${name}`, isSystem: true, timestamp: Date.now()
        });

        App.OpenGroupInfo();
    },

        // 1. Trigger the Modal from Group Info Page
    openReportModal: () => {
        document.getElementById('report-group-modal').style.display = 'flex';
    },

    closeReportModal: () => {
        document.getElementById('report-group-modal').style.display = 'none';
    },

    // 2. The Main Reporting Logic
    submitGroupReport: async () => {
        const chatId = state.currentChatId;
        const myUid = state.currentUser.uid;
        const shouldExit = document.getElementById('report-exit-checkbox').checked;

        App.showToast("Submitting report...");

        try {
            const { collection, query, orderBy, limit, getDocs, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

            // A. Fetch last 5 messages
            const msgQuery = query(
                collection(db, "chats", chatId, "messages"),
                orderBy("timestamp", "desc"),
                limit(5)
            );
            const msgSnap = await getDocs(msgQuery);
            const reportMessages = msgSnap.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            // B. Create Report Document in Firebase
            await addDoc(collection(db, "reports"), {
                reportedGroupId: chatId,
                reportedBy: myUid,
                timestamp: Date.now(),
                type: "group_report",
                evidence: reportMessages, // Contains text, senderId, and timestamps
                status: "pending"
            });

            App.closeReportModal();
            App.showToast("Report sent. Thank you.");

            // C. Optional: Exit and Delete logic
            if (shouldExit) {
                await App.leaveGroup(); 
                // Note: leaveGroup handles removing you from participants
            }

        } catch (e) {
            console.error("Report Error:", e);
            App.showToast("Failed to send report.");
        }
    },
        // --- SELECTION CORE ---
    enterSelectionMode: (id) => {
        if (navigator.vibrate) navigator.vibrate(50);
        state.selectedChats.add(id);
        document.getElementById('chat-selection-header').style.display = 'flex';
        app.updateSelectionUI();
        app.renderChatList();
    },

    toggleSelection: (id) => {
        if (state.selectedChats.has(id)) state.selectedChats.delete(id);
        else state.selectedChats.add(id);
        
        if (state.selectedChats.size === 0) app.exitSelectionMode();
        else {
            app.updateSelectionUI();
            app.renderChatList();
        }
    },

        // --- SELECTION UI & NAVIGATION ---
    updateSelectionUI: () => {
        const count = state.selectedChats.size;
        document.getElementById('selection-count').innerText = count;

        if (count === 0) return;

        // ðŸŒŸ DYNAMIC LABELS: Group vs Channel vs User
        const firstId = Array.from(state.selectedChats)[0];
        const actionText = document.getElementById('selection-dynamic-text');
        const actionIcon = document.getElementById('selection-dynamic-icon');

        if (actionText && actionIcon) {
            if (firstId.startsWith('group_')) {
                actionText.innerText = "Exit group";
                actionIcon.className = "fa-solid fa-arrow-right-from-bracket";
            } else if (firstId.startsWith('channel_')) {
                actionText.innerText = "Unfollow";
                actionIcon.className = "fa-solid fa-user-minus";
            } else {
                actionText.innerText = "Block";
                actionIcon.className = "fa-solid fa-ban";
            }
        }

        // Update Pin icon state
        const isPinned = state.pinnedChats.includes(firstId);
        document.getElementById('pin-icon').className = isPinned ? "fa-solid fa-thumbtack-slash" : "fa-solid fa-thumbtack";
    },

    exitSelectionMode: () => {
        state.selectedChats.clear();
        document.getElementById('chat-selection-header').style.display = 'none';
        const extraMenu = document.getElementById('selection-extra-menu');
        if (extraMenu) extraMenu.classList.remove('active');
        app.renderChatList();
    },

    // --- SELECTION ACTIONS ---
    togglePinSelected: () => {
        state.selectedChats.forEach(id => {
            if (state.pinnedChats.includes(id)) {
                state.pinnedChats = state.pinnedChats.filter(p => p !== id);
            } else {
                state.pinnedChats.push(id);
            }
        });
        localStorage.setItem('pinned_chats', JSON.stringify(state.pinnedChats));
        app.exitSelectionMode();
    },

    toggleMuteSelected: () => {
        state.selectedChats.forEach(id => {
            if (state.mutedChats.includes(id)) state.mutedChats = state.mutedChats.filter(m => m !== id);
            else state.mutedChats.push(id);
        });
        localStorage.setItem('muted_chats', JSON.stringify(state.mutedChats));
        app.exitSelectionMode();
    },

    archiveSelected: () => {
        state.selectedChats.forEach(id => {
            if (!state.archivedChats.includes(id)) state.archivedChats.push(id);
        });
        localStorage.setItem('archived_chats', JSON.stringify(state.archivedChats));
        app.showToast("Chat archived");
        app.exitSelectionMode();
    },

    lockSelected: () => {
        state.selectedChats.forEach(id => {
            if (!state.lockedChats.includes(id)) state.lockedChats.push(id);
            // Locked chats are usually moved to archive as well
            if (!state.archivedChats.includes(id)) state.archivedChats.push(id);
        });
        localStorage.setItem('locked_chats', JSON.stringify(state.lockedChats));
        app.showToast("Chat locked");
        app.exitSelectionMode();
    },

    confirmActionSelected: async () => {
        const selectedIds = Array.from(state.selectedChats);
        if (selectedIds.length === 0) return;

        const targetId = selectedIds[0];
        app.toggleSelectionExtraMenu(); // Close menu

        if (targetId.startsWith('group_')) {
            if (confirm("Exit selected group?")) {
                await app.leaveGroup(targetId);
                app.exitSelectionMode();
            }
        } else if (targetId.startsWith('channel_')) {
            if (confirm("Unfollow this channel?")) {
                const { updateDoc, doc, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await updateDoc(doc(db, "chats", targetId), {
                    participants: arrayRemove(state.currentUser.uid)
                });
                app.showToast("Unfollowed channel");
                app.exitSelectionMode();
            }
        } else {
            if (confirm("Block this contact? They won't be able to call you or see your status.")) {
                await app.blockUser(targetId);
                app.exitSelectionMode();
            }
        }
    },

    // --- UI ANIMATIONS ---
    toggleArchiveIcons: () => {
        state.isArchiveExpanded = !state.isArchiveExpanded;
        app.renderChatList();
    },

    toggleSelectionExtraMenu: () => {
        const menu = document.getElementById('selection-extra-menu');
        if (menu) menu.classList.toggle('active');
    },
        // 1. TRIGGER NATIVE LOCK
    unlockLockedChats: async () => {
        if (!window.PublicKeyCredential) {
            alert("Biometrics not supported. Please use a modern browser on your phone.");
            return;
        }

        try {
            // Trigger the native Fingerprint/FaceID/Passcode prompt
            const credential = await navigator.credentials.get({
                publicKey: {
                    challenge: new Uint8Array([11, 44, 77, 99]), // Dummy challenge
                    allowCredentials: [],
                    userVerification: "required" // This forces the phone UI to appear
                }
            });

            if (credential) {
                App.renderLockedChats();
                App.goToPage('locked-chats-page');
            }
        } catch (e) {
            console.error("Auth failed:", e);
            App.showToast("Authentication required to view chats");
        }
    },

    // 2. RENDER THE SECRET LIST
    renderLockedChats: () => {
        const container = document.getElementById('locked-list-container');
        container.innerHTML = '';
        
        const allChats = DataManager.getChatList();
        // Filter: Show ONLY IDs found in state.lockedChats
        const secretChats = allChats.filter(c => state.lockedChats.includes(c.id));

        if (secretChats.length === 0) {
            container.innerHTML = `<div style="text-align:center; margin-top:100px; color:gray;">No locked chats</div>`;
            return;
        }

        secretChats.forEach(data => {
            const div = document.createElement('div');
            div.className = "list-item";
            div.onclick = () => App.openChat(data.id, data.name, data.avatar);
            div.innerHTML = `
                <img src="${data.avatar}" class="list-avatar">
                <div style="flex: 1; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;"> 
                    <div style="display:flex; justify-content:space-between;">
                        <h4 style="margin:0;">${data.name}</h4>
                        <div style="font-size:11px; color:gray;">${data.time}</div>
                    </div>
                    <p style="margin:0; color:gray; font-size:14px;">${data.lastMsg}</p>
                </div>
                <div onclick="event.stopPropagation(); app.unlockChatPrompt('${data.id}')" style="padding: 10px; color: #00a884;">
                    <i class="fa-solid fa-lock-open"></i>
                </div>`;
            container.appendChild(div);
        });
    },

    // 3. UNLOCK/REVEAL A CHAT
    unlockChatPrompt: (chatId) => {
        if(confirm("Move this chat out of the Locked folder?")) {
            state.lockedChats = state.lockedChats.filter(id => id !== chatId);
            localStorage.setItem('locked_chats', JSON.stringify(state.lockedChats));
            App.renderLockedChats(); // Refresh secret list
            App.renderChatList();   // Refresh main list
        }
    },

    exitLockedPage: () => {
        App.goToPage('chat-list-page');
    },
        // --- 1. ARCHIVE FOLDER LOGIC ---
    openArchivedChats: () => {
        app.renderArchivedChats(); // Populate the list first
        app.goToPage('archived-chats-page');
    },

    renderArchivedChats: () => {
        const container = document.getElementById('archived-list-container');
        if (!container) return;
        container.innerHTML = '';
        
        const allChats = DataManager.getChatList();
        // Show chats that are in archived array BUT NOT in locked array
        const archived = allChats.filter(c => state.archivedChats.includes(c.id) && !state.lockedChats.includes(c.id));

        if (archived.length === 0) {
            container.innerHTML = `<div style="text-align:center; margin-top:100px; color:gray;">No archived chats</div>`;
            return;
        }

        archived.forEach(data => {
            const div = document.createElement('div');
            div.className = "list-item";
            div.onclick = () => app.openChat(data.id, data.name, data.avatar);
            div.innerHTML = `
                <img src="${data.avatar}" class="list-avatar">
                <div style="flex: 1; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;"> 
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0;">${data.name}</h4>
                        <div style="font-size:11px; color:gray;">${data.time}</div>
                    </div>
                    <p style="margin:0; color:gray; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${data.lastMsg}</p>
                </div>
                <div onclick="event.stopPropagation(); app.unarchiveChat('${data.id}')" style="padding: 10px; color: #54656f;">
                    <i class="fa-solid fa-box-open"></i>
                </div>`;
            container.appendChild(div);
        });
    },

    unarchiveChat: (id) => {
        state.archivedChats = state.archivedChats.filter(cId => cId !== id);
        localStorage.setItem('archived_chats', JSON.stringify(state.archivedChats));
        app.renderArchivedChats();
        app.renderChatList(); // Update main view
    },

    // --- 2. LOCKED FOLDER LOGIC (BIOMETRIC) ---
    // This overrides your placeholder function to ensure it renders the list upon success
    unlockLockedChats: async () => {
        if (!window.PublicKeyCredential) {
            alert("Biometric unlocking requires a secure connection (HTTPS).");
            return;
        }

        try {
            const credential = await navigator.credentials.get({
                publicKey: {
                    challenge: new Uint8Array([1, 2, 3, 4]),
                    allowCredentials: [],
                    userVerification: "required"
                }
            });

            if (credential) {
                app.renderLockedChats(); // Populate the secret list
                app.goToPage('locked-chats-page');
            }
        } catch (e) {
            console.error("Authentication failed:", e);
            app.showToast("Verification failed");
        }
    },

    renderLockedChats: () => {
        const container = document.getElementById('locked-list-container');
        if (!container) return;
        container.innerHTML = '';
        
        const allChats = DataManager.getChatList();
        const locked = allChats.filter(c => state.lockedChats.includes(c.id));

        if (locked.length === 0) {
            container.innerHTML = `<div style="text-align:center; margin-top:100px; color:gray;">No locked chats</div>`;
            return;
        }

        locked.forEach(data => {
            const div = document.createElement('div');
            div.className = "list-item";
            div.onclick = () => app.openChat(data.id, data.name, data.avatar);
            div.innerHTML = `
                <img src="${data.avatar}" class="list-avatar">
                <div style="flex: 1; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;"> 
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0;">${data.name}</h4>
                        <div style="font-size:11px; color:gray;">${data.time}</div>
                    </div>
                    <p style="margin:0; color:gray; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${data.lastMsg}</p>
                </div>
                <div onclick="event.stopPropagation(); app.unlockChatPrompt('${data.id}')" style="padding: 10px; color: #00a884;">
                    <i class="fa-solid fa-lock-open"></i>
                </div>`;
            container.appendChild(div);
        });
    }, 

    // --- APP LOCK SETUP ---
    openLockSetup: () => {
        const pin = prompt("Set a 4-digit backup PIN for Global Connect:");
        if (pin && pin.length === 4) {
            localStorage.setItem('app_lock_pin', pin); // Standardized Name
            localStorage.setItem('lock_enabled', 'true');
            document.getElementById('lock-status-label').innerText = "Enabled";
            app.showToast("App Lock is now active");
        } else {
            alert("PIN must be exactly 4 digits.");
        }
    },

    // --- FINGERPRINT UI LOGIC ---
    startAppFingerprintScan: () => {
        state.isScanning = true;
        const ring = document.getElementById('scan-ring');
        const icon = document.getElementById('finger-icon');
        const text = document.getElementById('scan-instruction');

        icon.style.color = "var(--primary)";
        text.style.color = "#888";
        ring.style.opacity = "1";
        ring.style.transform = "scale(1.1)";
        text.innerText = "Scanning fingerprint...";
        
        if(navigator.vibrate) navigator.vibrate(60);

        state.scanTimer = setTimeout(() => {
            if(state.isScanning) {
                app.triggerHardwareVerify(); 
            }
        }, 1200); 
    },

    triggerHardwareVerify: async () => {
        if (!window.PublicKeyCredential) {
            app.useBackupPIN(); // Fallback to PIN if hardware fails
            return;
        }
        try {
            const challenge = new Uint8Array([11, 22, 33, 44]); 
            const credential = await navigator.credentials.get({
                publicKey: {
                    challenge: challenge,
                    userVerification: "required",
                    authenticatorSelection: { authenticatorAttachment: "platform" }
                }
            });
            if (credential) app.completeScanSuccess();
        } catch (e) {
            document.getElementById('scan-instruction').innerText = "Not Recognized";
            document.getElementById('scan-instruction').style.color = "red";
            document.getElementById('finger-icon').style.color = "red";
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            app.cancelAppFingerprintScan();
        }
    },

    completeScanSuccess: () => {
        if(navigator.vibrate) navigator.vibrate([50, 30, 50]); 
        document.getElementById('scan-instruction').innerText = "Identity Verified";
        document.getElementById('scan-instruction').style.color = "#00C853";
        document.getElementById('finger-icon').style.color = "#00C853";
        
        setTimeout(() => {
            app.goToPage('chat-list-page');
            app.cancelAppFingerprintScan(); 
        }, 800);
    },

    cancelAppFingerprintScan: () => {
        state.isScanning = false;
        clearTimeout(state.scanTimer);
        const ring = document.getElementById('scan-ring');
        const icon = document.getElementById('finger-icon');
        const text = document.getElementById('scan-instruction');

        ring.style.opacity = "0";
        ring.style.transform = "scale(0.8)";
        
        if (text.innerText !== "Not Recognized" && text.innerText !== "Identity Verified") {
            icon.style.color = "rgba(255,255,255,0.2)";
            text.innerText = "Press and hold to unlock";
        }
    },

           // --- TELEGRAM PIN LOGIC ---
    useBackupPIN: () => {
        state.currentPinInput = ""; 
        app.updatePinDots();        
        // Use goToPage to handle the .active class and override CSS display rules
        app.goToPage('pin-screen-page'); 
    },

    updatePinDots: () => {
        for (let i = 1; i <= 4; i++) {
            const dot = document.getElementById(`pin-dot-${i}`);
            if (dot) {
                // If the user has typed this digit, fill the dot
                if (i <= state.currentPinInput.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            }
        }
    },

    enterPinDigit: (digit) => {
        if (state.currentPinInput.length >= 4) return;
        state.currentPinInput += digit;
        app.updatePinDots();
        
        // Haptic feedback for a real-app feel
        if (navigator.vibrate) navigator.vibrate(40);

        // Automatically verify as soon as the 4th digit is entered
        if (state.currentPinInput.length === 4) {
            setTimeout(app.verifyPin, 300);
        }
    },

    verifyPin: () => {
        // Must match the key used in app.openLockSetup
        const savedPin = localStorage.getItem('app_lock_pin'); 
        
        if (state.currentPinInput === savedPin) {
            // Success: Double pulse and unlock
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            app.goToPage('chat-list-page');
            app.showToast("Welcome back");
            state.currentPinInput = ""; 
        } else {
            // Failure: Professional shake animation and reset input
            const screen = document.getElementById('pin-screen-page');
            if (screen) screen.classList.add('shaking');
            if (navigator.vibrate) navigator.vibrate(200);
            
            setTimeout(() => {
                if (screen) screen.classList.remove('shaking');
                state.currentPinInput = ""; 
                app.updatePinDots();
            }, 500);
        }
    },

    deletePinDigit: () => {
        state.currentPinInput = state.currentPinInput.slice(0, -1);
        app.updatePinDots();
    },

    closePinScreen: () => {
        // Return to the main fingerprint lock screen
        app.goToPage('fingerprint-lock-page');
    },
                                                    shareContact: async () => {
            const partner = state.currentChatPartner;
            if (!partner) return;

            // 1. Setup specific sharing state
            state.isShareMode = true; 
            state.pendingContactToShare = partner;
            state.groupParticipants = []; 
            state.isAddingMember = false; 

            App.goToPage('create-group-select-page'); 

            // 2. Setup UI specifically for Forwarding
            document.getElementById('cg-page-title').innerText = "Forward Contact"; 
            document.getElementById('cg-selected-count').innerText = "Select recipients";
            document.getElementById('cg-back-btn').onclick = () => {
                state.isShareMode = false;
                App.goToPage('user-info-page');
            };

            const nextBtn = document.getElementById('cg-next-btn');
            const icon = document.getElementById('cg-btn-icon');
            if(icon) icon.className = "fa-solid fa-paper-plane";

            // ðŸŒŸ THE FIX: Point to the safe share function, NOT group logic
            if(nextBtn) {
                nextBtn.style.display = 'none';
                nextBtn.onclick = () => App.executeContactShare();
            }

            // 3. Load the Contact List
            const list = document.getElementById('cg-contact-list');
            list.innerHTML = '<div style="padding:20px; text-align:center; color:gray;"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const { collection, getDocs, query } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                if (!state.allContacts || state.allContacts.length === 0) {
                    const q = query(collection(db, "users"));
                    const snap = await getDocs(q);
                    state.allContacts = [];
                    snap.forEach(d => state.allContacts.push({uid: d.id, ...d.data()}));
                }

                list.innerHTML = "";
                state.allContacts.forEach(u => {
                    // Don't show myself or the person being shared
                    if (u.uid === state.currentUser.uid || u.uid === partner.id) return;
                    App.renderContactItem(u, list);
                });
            } catch (e) {
                console.error("Load Error:", e);
                list.innerHTML = "Failed to load contacts.";
            }
        },



            // 1. OPEN THE EDIT SCREEN
    openEditContact: async () => {
        const partner = state.currentChatPartner;
        if (!partner) return;

        app.goToPage('edit-contact-page');
        
        // Hide delete menu by default
        document.getElementById('contact-delete-dropdown').style.display = 'none';

        try {
            const snap = await getDoc(doc(db, "users", partner.id));
            if (snap.exists()) {
                const u = snap.data();
                
                // Fill inputs
                document.getElementById('edit-contact-firstname').value = u.name || "";
                document.getElementById('edit-contact-business').value = u.bio || "";
                
                // ðŸŒŸ Detect and show phone only if they logged in with one
                const phoneInput = document.getElementById('edit-contact-phone');
                phoneInput.value = u.phone || "No phone listed";

                // ðŸŒŸ Check if already saved to show the 3-dot delete option
                const savedContacts = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
                const isSaved = savedContacts.includes(partner.id);
                document.getElementById('contact-edit-menu-trigger').style.opacity = isSaved ? "1" : "0.3";
                document.getElementById('contact-edit-menu-trigger').style.pointerEvents = isSaved ? "auto" : "none";
            }
        } catch (e) { console.error(e); }
    },

    // 2. TOGGLE DELETE MENU
    toggleEditContactMenu: () => {
        const menu = document.getElementById('contact-delete-dropdown');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    },

    // 3. SAVE LOGIC (WhatsApp Style)
    saveContactLogic: () => {
        const targetId = state.currentChatPartner.id;
        let saved = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
        
        if (!saved.includes(targetId)) {
            saved.push(targetId);
            localStorage.setItem('saved_contacts', JSON.stringify(saved));
        }

        app.showToast("Contact Saved");
        app.viewContactInfo(); // Go back to profile view
    },

    // 4. DELETE LOGIC
    deleteSavedContact: () => {
        const targetId = state.currentChatPartner.id;
        let saved = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
        
        if (confirm("Delete this contact from your saved list?")) {
            saved = saved.filter(id => id !== targetId);
            localStorage.setItem('saved_contacts', JSON.stringify(saved));
            app.showToast("Contact Deleted");
            app.viewContactInfo(); 
        }
    },
            // --- FIXED PHONE AUTH LOGIC ---
    
    initPhoneAuth: async () => {
        try {
            // ðŸŒŸ THE FIX: Import RecaptchaVerifier specifically from the Auth module
            const { RecaptchaVerifier } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");

            if (!window.recaptchaVerifier) {
                // Create the verifier on the 'recaptcha-container' div
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log("reCAPTCHA verified");
                    },
                    'expired-callback': () => {
                        window.recaptchaVerifier.render().then(id => grecaptcha.reset(id));
                    }
                });
            }
        } catch (e) {
            console.error("Recaptcha Init Error:", e);
        }
    },

    sendOTP: async () => {
        const code = document.getElementById('country-code').value;
        const number = document.getElementById('phone-number-input').value.trim();
        
        // Basic validation: ensure number doesn't start with 0 if code is present
        const cleanNumber = number.startsWith('0') ? number.substring(1) : number;
        const fullNumber = code + cleanNumber;

        if (number.length < 7) return alert("Please enter a valid phone number");

        app.showToast("Sending code...");

        // 1. Initialize the fixed Recaptcha
        await app.initPhoneAuth();

        // 2. Import the sending function
        const { signInWithPhoneNumber } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");

        try {
            // 3. Send the SMS
            const confirmationResult = await signInWithPhoneNumber(auth, fullNumber, window.recaptchaVerifier);
            state.confirmationResult = confirmationResult;
            
            // 4. UI Transition
            document.getElementById('display-full-number').innerText = fullNumber;
            app.goToPage('otp-verification-page');
            app.showToast("Code sent to " + fullNumber);
        } catch (error) {
            console.error("SMS Send Error:", error);
            alert("Failed to send SMS: " + error.message);
            // Reset recaptcha for another try
            if (window.recaptchaVerifier) {
                window.recaptchaVerifier.render().then(id => {
                    if (window.grecaptcha) grecaptcha.reset(id);
                });
            }
        }
    },
            // --- 1. GLOBAL THEME DIALOG ---
    openThemeDialog: () => {
        document.getElementById('theme-dialog-overlay').style.display = 'flex';
        const current = localStorage.getItem('app-theme') || 'light';
        App.updateThemeRadioUI(current);
    },

    closeThemeDialog: () => {
        document.getElementById('theme-dialog-overlay').style.display = 'none';
    },

    updateThemeRadioUI: (theme) => {
        document.querySelectorAll('.radio-circle').forEach(el => el.classList.remove('radio-active'));
        const activeRadio = document.getElementById(`theme-${theme}-radio`);
        if(activeRadio) activeRadio.classList.add('radio-active');
    },

    setTheme: (theme) => {
        state.tempTheme = theme; 
        App.updateThemeRadioUI(theme);
    },

    confirmTheme: () => {
        const theme = state.tempTheme || 'light';
        localStorage.setItem('app-theme', theme);
        
        if (theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.removeAttribute('data-theme');
        }
        
        const themeLabel = document.getElementById('current-theme-label');
        if (themeLabel) themeLabel.innerText = theme.charAt(0).toUpperCase() + theme.slice(1);
        
        App.closeThemeDialog();
        App.showToast("Theme applied");
    },

    // --- 2. THEME & COLOR DATA ---
        themes: [
        { id: 1, name: 'Floral', url: 'https://images.unsplash.com/photo-1526047932273-341f2a7631f9?q=80&w=500', bubble: '#8e44ad' },
        { id: 2, name: 'Abstract', url: 'https://images.unsplash.com/photo-1541701494587-cb58502866ab?q=80&w=500', bubble: '#2980b9' },
        { id: 3, name: 'Tropical', url: 'https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=500', bubble: '#27ae60' },
        { id: 4, name: 'Soft Pink', url: 'https://images.unsplash.com/photo-1518112166137-85909569cc0c?q=80&w=500', bubble: '#d63031' },
        // --- ADD THESE 3 NEW ONES BELOW ---
        { id: 5, name: 'spongebob', url: 'https://files.catbox.moe/xt05l0.jpeg?q=80&w=500', bubble: '#1e272e' },
        { id: 6, name: 'superman', url: 'https://files.catbox.moe/w9qd8e.jpg?q=80&w=500', bubble: '#0984e3' },
        { id: 7, name: 'Dont Touch My Phone', url: 'https://files.catbox.moe/5rbpcr.jpg?q=80&w=500', bubble: '#e67e22' }
    ],


    chatColors: [
        '#075e54', '#005c4b', '#4b3c8e', '#2b2d42', '#7209b7', '#4a0e4e',
        '#8d3b23', '#4e342e', '#00695c', '#004d40', '#0d47a1', '#01579b',
        '#1a237e', '#283593', '#33691e', '#37474f', '#880e4f', '#4a148c',
        '#616161', '#212121'
    ],

    initThemeSystem: () => {
        App.renderThemeGrid();
        App.renderColorPicker();
        App.renderWallpaperGallery();
        App.setupSwipePreview();
    },

    // --- 3. RENDERERS ---
    renderThemeGrid: () => {
        const container = document.getElementById('theme-grid');
        if (!container) return;
        container.innerHTML = App.themes.map(t => `
            <div class="theme-card" style="background-image: url('${t.url}')" onclick="app.openThemePreview(${t.id})">
                ${localStorage.getItem('current-theme-id') == t.id ? '<div class="check-overlay"><i class="fa-solid fa-check"></i></div>' : ''}
            </div>
        `).join('');
    },

    renderColorPicker: () => {
        const container = document.getElementById('color-picker-grid');
        if (!container) return;
        const activeColor = localStorage.getItem('chat-bubble-color');
        container.innerHTML = App.chatColors.map(color => `
            <div class="color-circle" onclick="app.selectSolidColor('${color}')"
                 style="background-color: ${color}; width: 80px; height: 80px; border-radius: 50%; margin: auto; position: relative; cursor: pointer; border: 3px solid ${activeColor === color ? 'white' : 'transparent'};">
                ${activeColor === color ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-check" style="color: black; font-size: 14px;"></i></div>' : ''}
            </div>
        `).join('');
    },

    renderWallpaperGallery: () => {
        const container = document.getElementById('wallpaper-grid');
        if (!container) return;
        const walls = [
            'https://images.unsplash.com/photo-1579546929518-9e396f3cc809',
            'https://images.unsplash.com/photo-1557683316-973673baf926',
            'https://images.unsplash.com/photo-1506744038136-46273834b3fb',
            'https://images.unsplash.com/photo-1534067783941-51c9c23ecefd'
        ];
        container.innerHTML = walls.map(url => `
            <div class="wall-thumb" style="background-image: url('${url}')" onclick="app.selectGalleryWallpaper('${url}')"></div>
        `).join('');
    },

    renderPreviewSlides: () => {
        const slider = document.getElementById('preview-slider');
        if (!slider) return;
        slider.innerHTML = App.themes.map(t => `
            <div class="preview-slide" style="background-image: url('${t.url}'); background-size: cover; background-position: center;">
                <div class="message received" style="align-self: flex-start; margin-bottom: 10px;">Swipe to preview themes ðŸŽ¨</div>
                <div class="message sent" style="align-self: flex-end; background-color: ${t.bubble}; color: white;">This looks amazing!</div>
            </div>
        `).join('');
    },

    // --- 4. NAVIGATION & SWIPE LOGIC ---
    openThemePreview: (id) => {
        state.previewIndex = App.themes.findIndex(t => t.id === id);
        App.renderPreviewSlides();
        App.goToPage('theme-preview-page');
        App.updatePreviewPosition();
    },

    setupSwipePreview: () => {
        const slider = document.getElementById('preview-slider');
        if (!slider) return;
        let startX = 0;
        slider.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        slider.addEventListener('touchend', e => {
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) state.previewIndex = Math.min(state.previewIndex + 1, App.themes.length - 1);
                else state.previewIndex = Math.max(state.previewIndex - 1, 0);
                App.updatePreviewPosition();
            }
        });
    },

    updatePreviewPosition: () => {
        const slider = document.getElementById('preview-slider');
        if (slider) slider.style.transform = `translateX(-${state.previewIndex * 100}%)`;
    },

    // --- 5. APPLICATION LOGIC ---
    adjustPreviewDimming: (value) => {
        const opacity = value / 100;
        const dimmer = document.getElementById('preview-dimmer');
        if (dimmer) dimmer.style.opacity = opacity;
    },

    applySelectedTheme: () => {
        const selected = App.themes[state.previewIndex];
        const dimmingLevel = document.getElementById('wallpaper-dimmer-input').value;

        localStorage.setItem('chat-wallpaper', selected.url);
        localStorage.setItem('chat-bubble-color', selected.bubble);
        localStorage.setItem('chat-wallpaper-dim', dimmingLevel);
        localStorage.setItem('current-theme-id', selected.id);
        
        App.applyWallpaperToUI(selected.url);
        App.showToast("Theme applied");
        App.goToPage('chat-theme-page');
        App.renderThemeGrid();
    },

        // --- 1. APPLY WALLPAPER (Sharp & Seamless) ---
    applyWallpaperToUI: (url) => {
        const chatRoom = document.getElementById('chat-room');
        if (!chatRoom) return;

        // Default to 0 (Clear) if no dimming value is found in memory
        const dim = localStorage.getItem('chat-wallpaper-dim') || 0; 
        const overlayOpacity = dim / 100;

        // Apply background to the entire page container
        // 'fixed' attachment prevents the "line" effect when scrolling
        chatRoom.style.backgroundImage = `linear-gradient(rgba(0,0,0,${overlayOpacity}), rgba(0,0,0,${overlayOpacity})), url('${url}')`;
        chatRoom.style.backgroundSize = 'cover';
        chatRoom.style.backgroundPosition = 'center';
        chatRoom.style.backgroundAttachment = 'fixed'; 
    },

    // --- 2. SELECT SOLID COLOR ---
    selectSolidColor: (color) => {
        // Clear previous wallpaper to show solid color
        localStorage.removeItem('chat-wallpaper'); 
        localStorage.setItem('chat-bubble-color', color);
        
        const chatRoom = document.getElementById('chat-room');
        if (chatRoom) {
            chatRoom.style.backgroundImage = 'none';
            chatRoom.style.backgroundColor = 'var(--bg)'; 
            // Apply the bubble color to the CSS variable
            document.documentElement.style.setProperty('--bubble-sent', color);
        }
        
        // Refresh UI components
        App.renderColorPicker(); 
        App.goToPage('chat-theme-page');
        App.showToast("Color applied");
    },

    selectGalleryWallpaper: (url) => {
        localStorage.setItem('chat-wallpaper', url);
        App.applyWallpaperToUI(url);
        App.showToast("Wallpaper updated");
        App.goToPage('chat-theme-page');
    },

    handleGalleryUpload: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('chat-wallpaper', e.target.result);
                App.applyWallpaperToUI(e.target.result);
                App.showToast("Gallery wallpaper applied");
                App.goToPage('chat-room');
            };
            reader.readAsDataURL(input.files[0]);
        }
    },
        // --- OPEN CATEGORY GALLERY ---
    openWallpaperGallery: (type) => {
        App.goToPage('wallpaper-selection-page'); // Navigation
        const container = document.getElementById('wallpaper-grid'); // Reuses your existing grid ID
        
        // Dynamic image sets based on category
        const brightWalls = [
            'https://images.unsplash.com/photo-1506744038136-46273834b3fb',
            'https://images.unsplash.com/photo-1501785888041-af3ef285b470',
            'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05'
        ];
        
        const darkWalls = [
            'https://images.unsplash.com/photo-1534067783941-51c9c23ecefd',
            'https://images.unsplash.com/photo-1518112166137-85909569cc0c',
            'https://images.unsplash.com/photo-1541701494587-cb58502866ab'
        ];

        const activeList = (type === 'dark') ? darkWalls : brightWalls;
        
        // Populate the grid and show it
        App.renderWallpaperGrid(activeList);
        App.goToPage('chat-theme-page'); // Or create a new category grid page
    },

    // --- RE-USABLE GRID RENDERER ---
    renderWallpaperGrid: (walls) => {
        const container = document.getElementById('wallpaper-grid');
        if (!container) return;
        
        container.innerHTML = walls.map(url => `
            <div class="wall-thumb" style="background-image: url('${url}')" 
                 onclick="app.selectGalleryWallpaper('${url}')"></div>
        `).join('');
    },

    // --- HANDLE USER UPLOAD ---
    handleWallpaperUpload: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgUrl = e.target.result;
                localStorage.setItem('chat-wallpaper', imgUrl);
                App.applyWallpaperToUI(imgUrl);
                app.showToast("Personal wallpaper applied");
                app.goToPage('chat-room');
            };
            reader.readAsDataURL(input.files[0]);
        }
    },
        // 1. Initialize the UI with real stored data
    initBackupUI: () => {
        const savedEmail = localStorage.getItem('backup-email') || "None selected";
        const lastBackup = localStorage.getItem('last-backup-cloud') || "Never";
        const autoOn = localStorage.getItem('auto-backup-enabled') === 'true';

        // Update Backup Page Labels
        if(document.getElementById('selected-backup-email')) document.getElementById('selected-backup-email').innerText = savedEmail;
        if(document.getElementById('backup-cloud-time')) document.getElementById('backup-cloud-time').innerText = lastBackup;
        if(document.getElementById('backup-local-time')) document.getElementById('backup-local-time').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Update Settings Page Label (The one that was blank)
        if(document.getElementById('last-backup-status-label')) document.getElementById('last-backup-status-label').innerText = lastBackup;
        
        // Sync the Toggle
        if(document.getElementById('auto-backup-toggle')) document.getElementById('auto-backup-toggle').checked = autoOn;
        if(document.getElementById('auto-backup-status')) document.getElementById('auto-backup-status').innerText = autoOn ? "Daily" : "Off";
    },

    // 2. Open Real Google Account Chooser
    openAccountChooser: async () => {
        const { GoogleAuthProvider, signInWithPopup } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        try {
            App.showToast("Fetching real accounts...");
            const result = await signInWithPopup(auth, provider);
            const email = result.user.email;
            
            localStorage.setItem('backup-email', email);
            App.initBackupUI(); // Refresh the screen
            App.showToast("Account linked");
        } catch (e) {
            console.error(e);
            App.showToast("Selection cancelled");
        }
    },

        // --- CHAT BACKUP LOGIC ---
    startManualBackup: () => {
        const email = localStorage.getItem('backup-email');
        if (!email) return App.openAccountChooser();

        const btn = document.getElementById('backup-now-btn');
        const progressCont = document.getElementById('backup-progress-container');
        const progressFill = document.getElementById('backup-progress-fill');
        const progressPct = document.getElementById('backup-pct');

        // 1. Initial UI state
        btn.disabled = true;
        btn.innerText = "Backing up...";
        progressCont.style.display = 'block';
        progressFill.style.width = '0%';
        progressPct.innerText = '0%';

        let progress = 0;
        
        // 2. Animate the progress bar
        const interval = setInterval(() => {
            // Simulated upload speed: random increments between 5 and 15
            progress += Math.floor(Math.random() * 10) + 5; 
            
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);

                // 3. Finalize Backup
                const now = new Date().toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                localStorage.setItem('last-backup-cloud', now);
                App.initBackupUI();

                btn.innerText = "Back up";
                btn.disabled = false;
                App.showToast("Backup saved to " + email);

                // Hide progress bar after 2 seconds
                setTimeout(() => { 
                    progressCont.style.display = 'none'; 
                }, 2000);
            }

            // Update UI elements
            progressFill.style.width = progress + '%';
            progressPct.innerText = progress + '%';
        }, 300); // Updates every 300ms
    },

    toggleAutoBackup: (enabled) => {
        localStorage.setItem('auto-backup-enabled', enabled);
        App.initBackupUI();
        if(enabled) App.showToast("Automatic daily backups enabled");
    },
        // --- AI VOICE TRANSLATION LOGIC ---
    transcriptLangs: [
        { name: 'English', code: 'en-US', size: '12 MB' },
        { name: 'Spanish', code: 'es-ES', size: '15 MB' },
        { name: 'French', code: 'fr-FR', size: '14 MB' },
        { name: 'Portuguese', code: 'pt-BR', size: '13 MB' },
        { name: 'German', code: 'de-DE', size: '16 MB' },
        { name: 'Italian', code: 'it-IT', size: '14 MB' }
    ],

    openTranscriptLanguageModal: () => {
        const container = document.getElementById('transcript-lang-list');
        const selected = localStorage.getItem('transcript-lang') || 'en-US';
        
        container.innerHTML = App.transcriptLangs.map(lang => `
            <div class="menu-option" onclick="app.selectTranscriptLang('${lang.code}', '${lang.name}', '${lang.size}')">
                <i class="fa-solid fa-microphone-lines" style="color: #8696a0; width: 30px; text-align: center;"></i>
                <div style="flex:1;">
                    <div style="color: white; font-weight: 500;">${lang.name} AI Voice</div>
                    <div style="font-size: 12px; color: #8696a0;">${lang.size}</div>
                </div>
                ${selected === lang.code ? '<i class="fa-solid fa-check" style="color: #00a884;"></i>' : ''}
            </div>
        `).join('');
        
        document.getElementById('modal-transcript-lang').style.display = 'flex';
    },

    selectTranscriptLang: (code, name, size) => {
        const progressCont = document.getElementById('download-progress-container');
        const fill = document.getElementById('download-progress-fill');
        const pctText = document.getElementById('download-pct');
        const statusText = document.getElementById('download-status-text');

        progressCont.style.display = 'block';
        statusText.innerText = `Installing ${name} AI...`;
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.floor(Math.random() * 12) + 2;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                
                // Save AI Language Config
                localStorage.setItem('transcript-lang', code);
                localStorage.setItem('transcript-lang-name', name);
                localStorage.setItem('transcript-enabled', 'true');
                
                // Activate UI
                document.getElementById('transcript-toggle').checked = true;
                document.getElementById('transcript-status-label').innerText = `Voice: ${name}`;
                
                App.showToast(`${name} Voice AI Installed`);
                setTimeout(() => {
                    progressCont.style.display = 'none';
                    App.closeModal('modal-transcript-lang');
                }, 800);
            }
            fill.style.width = progress + '%';
            pctText.innerText = progress + '%';
        }, 150);
    },

    handleTranscriptToggle: (enabled) => {
        if (enabled && !localStorage.getItem('transcript-lang')) {
            document.getElementById('transcript-toggle').checked = false;
            App.openTranscriptLanguageModal();
        } else {
            localStorage.setItem('transcript-enabled', enabled);
            const langName = localStorage.getItem('transcript-lang-name') || "On";
            document.getElementById('transcript-status-label').innerText = enabled ? `Voice: ${langName}` : "Off";
        }
    },
        // --- UPDATED PLAYER WITH AI VOICE ---
    playAudio: (msgId, audioSrc) => {
        const btn = document.getElementById(`play-btn-${msgId}`);
        const fill = document.getElementById(`bar-fill-${msgId}`);
        
        // Setup original audio
        const audio = new Audio(audioSrc);
        state.activeAudio = { id: msgId, obj: audio };
        
        audio.play();
        btn.className = "fa-solid fa-pause play-pause-btn";
        
        audio.ontimeupdate = () => {
            const pct = (audio.currentTime / audio.duration) * 100;
            if(fill) fill.style.width = pct + "%";
        };
        
        audio.onended = () => {
            btn.className = "fa-solid fa-play play-pause-btn";
            if(fill) fill.style.width = "0%";
            
            // ðŸŒŸ TRIGGER AI TRANSLATION VOICE ðŸŒŸ
            const isTransEnabled = localStorage.getItem('transcript-enabled') === 'true';
            const targetLang = localStorage.getItem('transcript-lang');
            
            // Only translate voice notes FROM other users
            const messages = DataManager.getMessages(state.currentChatId);
            const msgObj = messages.find(m => m.timestamp === msgId);
            
            if (isTransEnabled && targetLang && msgObj && msgObj.senderId !== state.currentUser.uid) {
                App.showToast("AI Translating...");
                
                // In a real app, 'textToSpeak' comes from an AI translation of the audio
                const textToSpeak = msgObj.text || "This is a translated message in your selected language.";
                
                // Use Web Speech Synthesis
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = targetLang; // Uses the downloaded 'es-ES', 'fr-FR' etc.
                utterance.rate = 0.9;        // Slightly slower for better understanding
                
                window.speechSynthesis.speak(utterance);
            }
        };
    },
        // --- HELP & SUPPORT LOGIC ---
    
    // 1. Official Support Chat
    openSupportChat: () => {
        const supportId = "global_connect_official";
        const supportName = "Global Connect Support";
        const supportAvatar = "https://cdn-icons-png.flaticon.com/512/4359/4359959.png";
        
        App.openChat(supportId, supportName, supportAvatar);
        
        setTimeout(() => {
            const welcomeMsg = {
                text: "ðŸ‘‹ Hello! This is Global Connect Official Support. \n\nHow can we help you today? Your message has been logged as a technical report.",
                senderId: supportId,
                time: "System",
                timestamp: Date.now(),
                isBotMsg: true,
                status: 'read'
            };
            DataManager.saveMessage(supportId, welcomeMsg);
            App.renderMessages(supportId);
        }, 1000);
    }, // <--- Correct comma

    // 2. Automated Troubleshooter
    runSystemCheck: () => {
        const modal = document.getElementById('modal-system-check');
        const title = document.getElementById('check-status-title');
        const desc = document.getElementById('check-status-desc');
        const iconCont = document.getElementById('check-icon-container');
        const doneBtn = document.getElementById('check-done-btn');

        modal.style.display = 'flex';
        title.innerText = "Checking system...";
        desc.innerText = "Analyzing app cache and connection.";
        iconCont.innerHTML = '<div class="sending-spinner" style="margin: 0 auto 20px;"></div>';
        doneBtn.style.display = 'none';

        setTimeout(() => {
            const randomIssue = Math.random() > 0.7; 
            
            if (randomIssue) {
                title.innerText = "Issue Fixed";
                desc.innerText = "We found and optimized 12MB of temporary cache files.";
            } else {
                title.innerText = "Verified";
                desc.innerText = "We have viewed everything and verified your app is running perfectly.";
            }
            
            iconCont.innerHTML = '<i class="fa-solid fa-circle-check" style="font-size: 50px; color: #00a884; margin-bottom: 20px;"></i>';
            doneBtn.style.display = 'block';
            if(navigator.vibrate) navigator.vibrate([50, 30, 50]);
        }, 3000);
    }, // <--- Correct comma

    // 3. Integration with Firebase Reports
    sendReportToFirebase: async (text) => {
        try {
            await addDoc(collection(db, "reports"), {
                userId: state.currentUser.uid,
                message: text,
                timestamp: Date.now(),
                type: "support_ticket"
            });
            console.log("Report logged to Firebase.");
        } catch (e) { 
            console.error(e); 
        }
    },
        // --- GIPHY INTEGRATION ---
    giphyApiKey: 'U7DGpbP2wsPKgFyj0RuWec6L7YAWxMxJ', // ðŸŒŸ Put your key here

    searchGiphy: async (query) => {
        const grid = document.getElementById('giphy-results-grid');
        grid.innerHTML = '<div style="grid-column: span 2; text-align: center; color: #8696a0; padding: 20px;">Searching...</div>';

        try {
            const url = `https://api.giphy.com/v1/gifs/search?api_key=${App.giphyApiKey}&q=${encodeURIComponent(query)}&limit=20&rating=g`;
            const response = await fetch(url);
            const content = await response.json();

            grid.innerHTML = ""; // Clear loader

            content.data.forEach(gif => {
                // Use a smaller version for the preview grid
                const imgUrl = gif.images.fixed_height_small.url;
                
                const img = document.createElement('img');
                img.src = imgUrl;
                img.style.cssText = "width: 100%; border-radius: 8px; cursor: pointer; background: #2a3942;";
                
                // When clicked, send the high-quality GIF URL
                img.onclick = () => {
                    App.sendSticker(gif.images.fixed_height.url); 
                    App.closeEmojiDrawer();
                };

                grid.appendChild(img);
            });

            if (content.data.length === 0) {
                grid.innerHTML = '<div style="grid-column: span 2; text-align: center; color: #8696a0; padding: 20px;">No GIFs found.</div>';
            }

        } catch (err) {
            console.error("Giphy Error:", err);
            grid.innerHTML = '<div style="grid-column: span 2; text-align: center; color: #ff4757; padding: 20px;">Error connecting to GIPHY.</div>';
        }
    },
        toggleAttachMenu: () => {
        const menu = document.getElementById('attachment-menu');
        if (menu) {
            menu.classList.toggle('active');
        }
    },

    // ðŸŒŸ Close menu if Kelvin taps anywhere else (like the chat messages)
    // Note: This is now a method inside the object so it can be called safely
    setupAttachmentClosing: () => {
        const msgContainer = document.getElementById('message-container');
        if (msgContainer) {
            msgContainer.addEventListener('click', () => {
                const menu = document.getElementById('attachment-menu');
                if (menu && menu.classList.contains('active')) {
                    menu.classList.remove('active');
                }
            });
        }
    },
            // 1. Open the Poll Page and Reset everything
    openPollCreator: () => {
        // Reset question field
        const qInput = document.getElementById('poll-question');
        if(qInput) qInput.value = "";
        
        // Reset options container to start with 2 empty options
        const container = document.getElementById('poll-options-container');
        container.innerHTML = '<label style="color: #8696a0; font-size: 12px; font-weight: bold; text-transform: uppercase;">Options</label>';
        
        App.addPollOption();
        App.addPollOption();
        
        App.goToPage('poll-creator-page');
    },

    // 2. Function to add a new option input dynamically
    addPollOption: () => {
        const container = document.getElementById('poll-options-container');
        const input = document.createElement('input');
        input.type = "text";
        input.className = "poll-option-input";
        input.placeholder = "Add option";
        input.style.cssText = "width: 100%; background: transparent; border: none; border-bottom: 1px solid #2f3b43; color: white; padding: 12px 0; outline: none; margin-top: 10px; font-size: 16px;";
        
        container.appendChild(input);
        input.focus(); // Focus the new input so Kelvin can type immediately
    },

    // 3. Collect data and send via the main sendMessage engine
        submitPoll: async () => {
        const question = document.getElementById('poll-question').value.trim();
        const optionInputs = document.querySelectorAll('.poll-option-input');
        const options = [];

        optionInputs.forEach(input => {
            if (input.value.trim() !== "") {
                options.push({ text: input.value.trim(), votes: [] });
            }
        });

        if (!question || options.length < 2) return alert("Please enter a question and at least 2 options.");

        const pollData = { question, options, timestamp: Date.now() };

        // ðŸŒŸ Passing 8 arguments to match sendMessage:
        // (text, img, isSystem, audio, isRetry, isSticker, msgTypeOverride, payload)
        await App.sendMessage(question, null, false, null, false, false, 'poll', pollData);
        
        App.goToPage('chat-room');
    },
        cancelReply: () => {
        state.replyContextData = null;
        const replyBar = document.getElementById('reply-preview-bar');
        if (replyBar) {
            replyBar.style.display = 'none';
        }
    },
        openPollDetails: (msgId) => {
        const messages = DataManager.getMessages(state.currentChatId);
        const msg = messages.find(m => m.id === msgId);
        if (!msg) return;

        // For now, show a toast. You can build a separate page or modal for this.
        const total = msg.pollData.options.reduce((s, o) => s + (o.votes ? o.votes.length : 0), 0);
        App.showToast(`Total votes collected: ${total}`);
    },
        castVote: async (messageId, optionIndex) => {
        const myUid = state.currentUser.uid;
        const chatId = state.currentChatId;
        const isGroupOrChannel = chatId.startsWith('group_') || chatId.startsWith('channel_');
        
        // Use the correct folder path for the database
        const collectionPath = isGroupOrChannel ? `chats/${chatId}/messages` : `messages`;
        
        try {
            const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const msgRef = doc(db, collectionPath, messageId);
            
            const snap = await getDoc(msgRef);
            if (!snap.exists()) return;

            let poll = snap.data().pollData;
            if (!poll) return;

            // WhatsApp single-choice logic: remove vote from all other options
            poll.options.forEach(opt => {
                if (!opt.votes) opt.votes = [];
                opt.votes = opt.votes.filter(id => id !== myUid);
            });

            // Add vote to the clicked option
            poll.options[optionIndex].votes.push(myUid);

            await updateDoc(msgRef, { pollData: poll });
            
            if (navigator.vibrate) navigator.vibrate(40); // Haptic feedback
        } catch (e) { 
            console.error("Vote failed:", e); 
            App.showToast("Connection failed");
        }
    },
        castVote: async (messageId, optionIndex) => {
        const myUid = state.currentUser.uid;
        const chatId = state.currentChatId;
        
        // ðŸŒŸ Path detection
        const isGroup = chatId.startsWith('group_') || chatId.startsWith('channel_');
        const collectionPath = isGroup ? `chats/${chatId}/messages` : `messages`;
        
        try {
            const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const msgRef = doc(db, collectionPath, messageId);
            
            const snap = await getDoc(msgRef);
            if (!snap.exists()) return;

            let poll = snap.data().pollData;
            if (!poll) return;

            // Remove my previous vote (Single choice)
            poll.options.forEach(opt => {
                if (!opt.votes) opt.votes = [];
                opt.votes = opt.votes.filter(id => id !== myUid);
            });

            // Add my new vote
            poll.options[optionIndex].votes.push(myUid);

            // Update Firebase
            await updateDoc(msgRef, { pollData: poll });
            
            if (navigator.vibrate) navigator.vibrate(40); 
        } catch (e) { console.error("Vote Error:", e); }
    },
        // --- LOCATION LOGIC ---
    openLocationPage: () => {
        App.goToPage('location-page');
        const iframe = document.getElementById('loc-iframe');
        const loading = document.getElementById('map-loading');
        
        if (iframe) iframe.style.display = 'none';
        if (loading) loading.style.display = 'block';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                state.currentLatLng = { lat, lon };

                // Load live map preview
                // Standard URL: googleusercontent.com/maps.google.com/q=${lat},${lon}...
                iframe.src = `https://maps.google.com/maps?q=${lat},${lon}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
                
                iframe.onload = () => {
                    if(loading) loading.style.display = 'none';
                    if(iframe) iframe.style.display = 'block';
                };
            }, (err) => {
                App.showToast("Please enable location permissions");
                App.goToPage('chat-room');
            }, { enableHighAccuracy: true });
        }
    },

    sendCurrentLocation: () => {
        if (!state.currentLatLng) return App.showToast("Wait for map to load...");
        const { lat, lon } = state.currentLatLng;
        const googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;

        // Send using 8-parameter engine
        App.sendMessage("ðŸ“ Shared location", null, false, null, false, false, 'location', googleMapsLink);
        App.goToPage('chat-room');
    },

    // --- LIVE LOCATION TRACKER ---
    startLiveLocation: async (duration) => {
        if (!state.currentLatLng) return App.showToast("Wait for map to load...");
        
        const { lat, lon } = state.currentLatLng;
        const payload = {
            lat: lat,
            lon: lon,
            active: true,
            expiresAt: Date.now() + (3600 * 1000) // 1 Hour expiry
        };

        // Send initial live message
        await App.sendMessage("Live Location", null, false, null, false, false, 'live_location', payload);
        App.goToPage('chat-room');

        // Start watching Kelvin's movement
        state.liveWatchId = navigator.geolocation.watchPosition(async (pos) => {
            const newLat = pos.coords.latitude;
            const newLon = pos.coords.longitude;

            // Find the last live_location message in the current chat and update it
            const chatId = state.currentChatId;
            const isGroup = chatId.startsWith('group_');
            const path = isGroup ? `chats/${chatId}/messages` : `messages`;

            const q = query(collection(db, path), where("senderId", "==", state.currentUser.uid), where("type", "==", "live_location"), orderBy("timestamp", "desc"), limit(1));
            const snap = await getDocs(q);
            if(!snap.empty) {
                await updateDoc(snap.docs[0].ref, {
                    "payload.lat": newLat,
                    "payload.lon": newLon
                });
            }
        }, null, { enableHighAccuracy: true });
    },

    stopLiveLocation: () => {
        if (state.liveWatchId) {
            navigator.geolocation.clearWatch(state.liveWatchId);
            state.liveWatchId = null;
            App.showToast("Live location stopped");
        }
    },
        handleAudioFile: async (input) => {
    const file = input.files[0];
    if (!file) return;

    App.showToast(`Uploading ${file.name}...`);
    
    try {
        // 1. Generate R2 Key
        const fileKey = `dm_audio_${Date.now()}_${state.currentUser.uid}.mp3`;
        const workerUrl = `https://r2-media-manager.ozokelvin293.workers.dev/?key=${fileKey}`;
        
        // 2. Upload to R2 Basket via Worker
        const res = await fetch(workerUrl, {
            method: 'PUT',
            body: file,
            headers: { 'Content-Type': file.type }
        });

        if (!res.ok) throw new Error("Upload failed");

        const publicUrl = `https://pub-b9751f865fe143b6a091d53cc21895de.r2.dev/${fileKey}`;

        // 3. Send to Firebase as 'audio_file' type
        await App.sendMessage(file.name, null, false, null, false, false, 'audio_file', {
            url: publicUrl,
            fileName: file.name,
            fileSize: (file.size / 1024 / 1024).toFixed(1) + " MB",
            r2Key: fileKey
        });

        App.showToast("Audio Sent âœ…");
    } catch (e) {
        console.error(e);
        App.showToast("Upload Failed");
    }
 },



    // --- CATALOG LOGIC ---
    openCatalogPicker: () => {
        const list = document.getElementById('catalog-list');
        const products = [
            { id: 1, name: "Premium Subscription", price: "$4.99", img: "https://cdn-icons-png.flaticon.com/512/2583/2583344.png" },
            { id: 2, name: "Gold Verification", price: "$9.99", img: "https://cdn-icons-png.flaticon.com/512/1255/1255018.png" }
        ];
        list.innerHTML = products.map(p => `
            <div onclick="App.sendProduct(${JSON.stringify(p).replace(/"/g, '&quot;')})" style="background:#202c33; padding:15px; border-radius:12px; text-align:center;">
                <img src="${p.img}" style="width:60px; margin-bottom:10px;">
                <div style="font-weight:bold; font-size:14px;">${p.name}</div>
                <div style="color:#00a884;">${p.price}</div>
            </div>
        `).join('');
        App.goToPage('catalog-page');
    },

    sendProduct: (product) => {
        App.sendMessage(product.name, null, false, null, false, false, 'product_card', product);
        App.goToPage('chat-room');
    },
        // --- PRIVATE CHAT LOGIC ---
        openPrivateSettingsPage: () => {
        App.goToPage('private-chat-page');
        
        const partner = state.currentChatPartner;
        const infoBox = document.getElementById('private-user-info-box');
        const listContainer = document.getElementById('hidden-users-list');

        // 1. If we ARE currently in a chat, show the toggle for that person
        if (partner) {
            infoBox.style.display = 'block';
            document.getElementById('private-user-name').innerText = partner.name;
            const hiddenChats = JSON.parse(localStorage.getItem('hidden_chats') || '[]');
            document.getElementById('private-chat-switch').checked = hiddenChats.includes(partner.id);
        } else {
            // 2. If we are NOT in a chat, hide the specific toggle box
            infoBox.style.display = 'none';
        }

        // 3. Always render the list of people already hidden
        App.renderHiddenUsersList();
    },

    renderHiddenUsersList: async () => {
        const container = document.getElementById('hidden-users-list');
        const hiddenIds = JSON.parse(localStorage.getItem('hidden_chats') || '[]');
        
        if (hiddenIds.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#8696a0; font-size:13px;">No hidden chats yet.</div>`;
            return;
        }

        container.innerHTML = '<div style="padding:10px; color:#00a884; font-size:12px; font-weight:bold; text-transform:uppercase;">Hidden Users</div>';

        for (const uid of hiddenIds) {
            // Try to find user info in local cache
            const allChats = DataManager.getChatList();
            const cachedUser = allChats.find(c => c.id === uid);
            
            const name = cachedUser ? cachedUser.name : "Unknown User";
            const photo = cachedUser ? cachedUser.avatar : "https://cdn-icons-png.flaticon.com/512/847/847969.png";

            const div = document.createElement('div');
            div.className = "list-item";
            div.style.background = "white";
            div.innerHTML = `
                <img src="${photo}" class="list-avatar" style="width:40px; height:40px;">
                <div style="flex:1; font-weight:500;">${name}</div>
                <button onclick="App.unhideFromList('${uid}')" style="background:none; border:1px solid #ddd; padding:5px 12px; border-radius:15px; font-size:12px; color:#00a884; cursor:pointer;">Show</button>
            `;
            container.appendChild(div);
        }
    },

    unhideFromList: (uid) => {
        let hiddenChats = JSON.parse(localStorage.getItem('hidden_chats') || '[]');
        hiddenChats = hiddenChats.filter(id => id !== uid);
        localStorage.setItem('hidden_chats', JSON.stringify(hiddenChats));
        
        App.showToast("Chat is now visible");
        App.renderHiddenUsersList();
        App.renderChatList(); // Refresh main home screen
    },
        toggleMyGlobalPrivacy: async (isPrivate) => {
        const myUid = state.currentUser.uid;
        App.showToast(isPrivate ? "Profile is now Hidden" : "Profile is now Public");

        try {
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // 1. Update the database so others can't see you
            await updateDoc(doc(db, "users", myUid), {
                isPrivate: isPrivate 
            });

            // 2. Update local profile memory
            const profile = DataManager.getProfile();
            profile.isPrivate = isPrivate;
            DataManager.saveProfile(profile);

        } catch (e) {
            console.error("Privacy Update Failed", e);
            App.showToast("Update failed. Check connection.");
        }
    },
                openGiftPage: () => {
        const partner = state.currentChatPartner;
        const profile = DataManager.getProfile();
        
        // 1. Check if these elements exist before setting innerHTML
        const nameEl = document.getElementById('gift-target-name');
        const balanceEl = document.getElementById('gift-balance');
        const gridEl = document.getElementById('gift-grid');
        const premiumEl = document.getElementById('premium-gift-card');

        if (!gridEl || !premiumEl) {
            console.error("Missing Gift Page elements in HTML!");
            return;
        }

        nameEl.innerText = partner.name;
        balanceEl.innerText = profile.orbs || 0;
        
        gridEl.innerHTML = GiftItems.map(item => `
            <div onclick="app.sendAnimatedGift('${item.id}')" style="background: #232e3c; padding: 20px 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.05);">
                <img src="${item.anim}" style="width: 70px; height: 70px; margin-bottom: 12px; object-fit: contain;">
                <div style="font-weight: 500; font-size: 14px; color: #fff; margin-bottom: 8px;">${item.name}</div>
                <div style="background: rgba(0,0,0,0.2); width: fit-content; margin: 0 auto; padding: 4px 10px; border-radius: 15px; font-size: 12px; color: #ff4b7d; font-weight: bold;">
                    <i class="fa-solid fa-gem" style="font-size: 10px;"></i> ${item.price}
                </div>
            </div>
        `).join('');

        premiumEl.innerHTML = `
            <div onclick="app.buyPremiumForUser()" style="background: linear-gradient(135deg, #5865F2 0%, #9b59b6 100%); padding: 18px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <div style="font-weight: bold; font-size: 15px; color: white;"><i class="fa-solid fa-crown" style="margin-right: 8px;"></i> Buy Premium for ${partner.name}</div>
            </div>`;
            
        app.goToPage('gift-page');
    },

    sendAnimatedGift: async (giftId) => {
        const gift = GiftItems.find(g => g.id === giftId);
        const profile = DataManager.getProfile();
        const myUid = state.currentUser.uid;
        
        if ((profile.orbs || 0) < gift.price) {
            alert("Not enough Orbs! Buy more in the shop.");
            return app.goToPage('shop-page');
        }

        app.showToast(`Sending ${gift.name}...`);

        try {
            const { updateDoc, doc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // 1. Deduct Orbs from Kelvin
            await updateDoc(doc(db, "users", myUid), { orbs: increment(-gift.price) });
            
            // 2. Update local state
            profile.orbs -= gift.price;
            DataManager.saveProfile(profile);

            // 3. Send Message (using msgType 'gift_anim' for transparent bubble)
            app.sendMessage(`ðŸŽ Sent a ${gift.name}`, gift.anim, false, null, false, false, 'gift_anim');
            
            app.goToPage('chat-room');
        } catch (e) {
            console.error("Gift failed:", e);
        }
    },

    buyPremiumForUser: async () => {
        const partner = state.currentChatPartner;
        if(!confirm(`Gift 1 Month Premium to ${partner.name} for $4.99?`)) return;

        app.showToast("Contacting Google Play Store...");
        setTimeout(async () => {
            const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // Give the recipient the Verified Badge
            await updateDoc(doc(db, "users", partner.id), { isVerified: true });
            
            // Send celebration gift to chat
            app.sendMessage(`ðŸ‘‘ Gifted Premium to ${partner.name}!`, "https://cdn-icons-gif.flaticon.com/14545/14545763.gif", false, null, false, false, 'gift_anim');
            
            app.goToPage('chat-room');
            app.showToast("ðŸ’Ž Premium Gifted Successfully!");
        }, 2000);
    },
                            // --- ðŸ’³ WALLET & EARNINGS ENGINE ---
    openWalletPage: () => {
        const profile = DataManager.getProfile();
        
        // 1. Set Balances
        const orbBalance = profile.orbs || 0;
        const usdEarnings = (profile.earnings || 0).toFixed(2);
        
        const userIdEl = document.getElementById('wallet-user-id');
        const orbBalEl = document.getElementById('wallet-orb-balance');
        const usdBalEl = document.getElementById('wallet-usd-balance');

        if(userIdEl) userIdEl.innerText = state.currentUser.uid.substring(0, 5);
        if(orbBalEl) orbBalEl.innerText = orbBalance;
        if(usdBalEl) usdBalEl.innerText = usdEarnings;
        
        // 2. Render Purchase Options (What users pay to get Orbs)
        const topupGrid = document.getElementById('wallet-topup-grid');
        const packs = [
            { id: 'orbs_100', amt: 100, price: '$1.99' }, 
            { id: 'orbs_500', amt: 500, price: '$8.99' },
            { id: 'orbs_1000', amt: 1000, price: '$16.99' },
            { id: 'orbs_5000', amt: 5000, price: '$79.99' }
        ];
        
        if (topupGrid) {
            topupGrid.innerHTML = packs.map(p => `
                <div onclick="app.buyItem('${p.id}')" style="background: #1c2733; padding: 18px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); text-align: center; cursor: pointer;">
                    <div style="font-weight: 800; font-size: 15px; color: #fff;">${p.amt} Orbs</div>
                    <div style="color: #5865F2; font-size: 12px; margin-top: 4px; font-weight: bold;">${p.price}</div>
                </div>
            `).join('');
        }

        // ðŸš€ THE FIX: Call both history functions
        app.renderTransactionHistory(); 
        app.renderWithdrawalHistory();
        
        app.goToPage('wallet-page');
    },

    // --- ðŸŽ GIFT HISTORY ENGINE (Incoming Gifts) ---
    renderTransactionHistory: async () => {
    const container = document.getElementById('wallet-history-list');
    const myUid = state.currentUser.uid;
    if (!container) return;
    
    try {
        const { collection, query, where, orderBy, limit, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // This query requires a Composite Index in Firebase Console!
        const q = query(
            collection(db, "messages"),
            where("receiverId", "==", myUid),
            where("type", "==", "gift_anim"),
            orderBy("timestamp", "desc"),
            limit(10)
        );
        
        const snap = await getDocs(q);
        if (snap.empty) {
            container.innerHTML = `<div style="padding: 30px; text-align: center; color: #8696a0; font-size: 13px;">No gifts received yet.</div>`;
            return;
        }

        container.innerHTML = "";
        snap.forEach(d => {
            const gift = d.data();
            // FIX: Handle timestamp as a number or object
            const dateStr = gift.timestamp ? new Date(gift.timestamp).toLocaleString() : 'Recently';

            const div = document.createElement('div');
            div.style.cssText = "display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); gap: 12px;";
            div.innerHTML = `
                <div style="width: 38px; height: 38px; background: rgba(0,168,132,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #00a884;">
                    <i class="fa-solid fa-gift"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 13px; color: #fff;">Gift Received</div>
                    <div style="font-size: 11px; color: #8696a0;">${dateStr}</div>
                </div>
                <div style="text-align: right;">
                    <div style="color: #00a884; font-weight: bold; font-size: 14px;">+$1.00</div>
                </div>`;
            container.appendChild(div);
        });
    } catch (e) { console.error("Index likely missing. Check Console link:", e); }
 },

    // --- ðŸ•’ WITHDRAWAL STATUS ENGINE (Cash-outs) ---
    renderWithdrawalHistory: async () => {
    const container = document.getElementById('withdrawal-status-list');
    const myUid = state.currentUser.uid;
    if (!container) return;

    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const q = query(
            collection(db, "payouts"),
            where("uid", "==", myUid),
            orderBy("timestamp", "desc")
        );

        const snap = await getDocs(q);
        container.innerHTML = ""; 

        if (snap.empty) {
            container.innerHTML = `<div style="padding: 30px; text-align: center; color: #8696a0; font-size: 12px;">No withdrawal requests found.</div>`;
            return;
        }

        snap.forEach(doc => {
            const data = doc.data();
            const isPaid = data.status === "PAID";
            // FIX: Handle number-based timestamp
            const dateStr = data.timestamp ? new Date(data.timestamp).toLocaleDateString() : '...';

            const div = document.createElement('div');
            div.style.cssText = "padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;";
            div.innerHTML = `
                <div>
                    <div style="color: white; font-weight: 600; font-size: 13px;">$${(data.netPayout || 0).toFixed(2)} Cash Out</div>
                    <div style="color: #8696a0; font-size: 11px;">${data.bankMethod}</div>
                </div>
                <div style="text-align: right;">
                    <span style="background: ${isPaid ? 'rgba(0,168,132,0.1)' : 'rgba(255,171,0,0.1)'}; color: ${isPaid ? '#00a884' : '#ffab00'}; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; text-transform: uppercase;">${data.status}</span>
                    <div style="color: #444; font-size: 9px; margin-top: 4px;">${dateStr}</div>
                </div>`;
            container.appendChild(div);
        });
    } catch (e) { console.error("Withdraw History Error:", e); }
 },


    // --- ðŸ¦ SECURE BANKING & WITHDRAWAL SYSTEM ---

withdrawFunds: () => {
    const profile = DataManager.getProfile();
    const earnings = profile.earnings || 0;

    // 1. Minimum Balance Check
    if (earnings < 10) {
        return alert("Minimum withdrawal is $10.00. Keep collecting gifts!");
    }

    // 2. Setup Display Math ($1.00 standard fee)
    document.getElementById('draw-usd-amount').innerText = earnings.toFixed(2);
    document.getElementById('net-payout-display').innerText = (earnings - 1.0).toFixed(2);
    
    // 3. Reset Form and Navigate
    document.getElementById('bank-form-area').style.display = 'none';
    document.querySelectorAll('.bank-card').forEach(c => c.classList.remove('active'));
    App.goToPage('withdrawal-methods-page');
},

// Updated function to handle three parameters from HTML
selectBank: (name, logoUrl, element) => {
    state.selectedBank = name;
    
    // UI Update: Remove "active" class from all cards first
    document.querySelectorAll('.bank-card').forEach(c => c.classList.remove('active'));
    
    // Now 'element' correctly refers to 'this' from your HTML call
    if (element && element.classList) {
        element.classList.add('active');
    }
    
    // Reveal form with animation
    const formArea = document.getElementById('bank-form-area');
    if (formArea) {
        formArea.style.display = 'block';
    }
    
    // Specific logic for US Global Transfers
    const usFields = document.getElementById('us-bank-fields');
    if (usFields) {
        usFields.style.display = name === 'US Global Transfer' ? 'block' : 'none';
    }
    
    // Premium Haptic feedback (Vibrates on phone if supported)
    if (navigator.vibrate) navigator.vibrate(40);
},


submitBankWithdrawal: async () => {
    const accNum = document.getElementById('bank-acc-number').value.trim();
    const accName = document.getElementById('bank-acc-name').value.trim();
    const routing = document.getElementById('bank-routing').value.trim();
    const profile = DataManager.getProfile();
    const myUid = state.currentUser.uid;

    // Validation
    if (!accNum || !accName || !state.selectedBank) {
        return alert("Please select a bank and enter your account info.");
    }

    App.showToast(`Requesting payout to ${state.selectedBank}...`);

    try {
        const { doc, runTransaction, serverTimestamp, collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        // Execute atomic transaction for safety
        await runTransaction(db, async (transaction) => {
            const userRef = doc(db, "users", myUid);
            const userDoc = await transaction.get(userRef);
            
            const currentEarnings = userDoc.data().earnings || 0;
            if (currentEarnings < 10) throw "Error: Insufficient balance detected.";

            const payoutRef = doc(collection(db, "payouts"));
            transaction.set(payoutRef, {
                uid: myUid,
                username: profile.name,
                amount: parseFloat(currentEarnings),
                netPayout: parseFloat(currentEarnings - 1.0),
                bankMethod: state.selectedBank,
                accountDetails: `No: ${accNum} | Name: ${accName} ${routing ? '| Code: '+routing : ''}`,
                status: "PENDING",
                timestamp: serverTimestamp()
            });

            // Wipe earnings from database
            transaction.update(userRef, { earnings: 0 });
        });

        // Update local memory
        profile.earnings = 0;
        DataManager.saveProfile(profile);
        
        App.showToast("âœ… Success! Check back in 24-48h.");
        App.goToPage('wallet-page');
        App.renderWithdrawalHistory(); // Refresh the status list

    } catch (e) {
        console.error(e);
        alert("Transfer Error: " + e);
    }
 },


    // ðŸŒŸ PROFIT ENGINE: Converting Gifts to Money
    sendAnimatedGift: async (giftId) => {
        const gift = GiftItems.find(g => g.id === giftId);
        const senderProfile = DataManager.getProfile();
        const recipientId = state.currentChatPartner.id;
        const myUid = state.currentUser.uid;
        
        if ((senderProfile.orbs || 0) < gift.price) {
            alert("Insufficient Orbs! Buy more in your wallet.");
            return app.openWalletPage();
        }

        try {
            const { updateDoc, doc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // Deduct from Sender
            await updateDoc(doc(db, "users", myUid), { orbs: increment(-gift.price) });
            // Add to Recipient Earnings (100 Orbs = $1.00)
            const dollarValue = gift.price / 100;
            await updateDoc(doc(db, "users", recipientId), { earnings: increment(dollarValue) });
            
            senderProfile.orbs -= gift.price;
            DataManager.saveProfile(senderProfile);
            app.sendMessage(`ðŸŽ Gifted you a ${gift.name}`, gift.anim, false, null, false, false, 'gift_anim', recipientId);
            app.goToPage('chat-room');
        } catch (e) { console.error(e); }
    },

    // --- ðŸ›’ INTEGRATED SHOP & REWARDS SYSTEM ---

buyItem: async (itemId) => {
    // 1. Define Standard USD Prices
    const prices = {
        'verification': 4.99, // Monthly Subscription
        'gold_name': 2.99,
        'banner': 1.99,
        'ghost': 3.99,
        'boost': 0.99,
        'orbs_100': 1.99,
        'orbs_500': 4.99,
        'orbs_1000': 16.99,
        'orbs_5000': 79.99
    };

    const price = prices[itemId];
    if (!price) return;

    // 2. Initial Confirmation
    const confirmMsg = itemId === 'verification' 
        ? `Confirm $${price} monthly subscription for the Verification Badge?`
        : `Confirm purchase of ${itemId.replace('_', ' ').toUpperCase()} for $${price}?`;

    if (!confirm(confirmMsg)) return;

    // 3. Button State Management
    const btn = event.target;
    const originalText = btn.innerText;
    const originalBg = btn.style.background;
    
    btn.innerText = "Processing...";
    btn.disabled = true;

    App.showToast("Opening Secure Payment...");

    // 4. Trigger Paystack Engine
    PaymentEngine.pay(price, `Purchase: ${itemId}`, { item_id: itemId }, async (res) => {
        try {
            const uid = state.currentUser.uid;
            const { updateDoc, doc, increment, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const userRef = doc(db, "users", uid);

            // --- ðŸ›¡ï¸ APPLY FEATURES BASED ON ITEM ID ---
            if (itemId === 'verification') {
                // ðŸ“… Set expiry to 30 days from now
                const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                const expiry = Date.now() + thirtyDays;
                
                await updateDoc(userRef, { 
                    isVerified: true,
                    verificationExpires: expiry 
                });
                App.showToast("âœ… Verification Active for 30 Days!");
            } 
            else if (itemId === 'gold_name') {
                await updateDoc(userRef, { nameColor: 'gold' });
                App.showToast("âœ… Gold Name Activated!");
            }
            else if (itemId === 'boost') {
                const expiry = Date.now() + (24 * 60 * 60 * 1000);
                await updateDoc(userRef, { 
                    isBoosted: true,
                    boostExpires: expiry
                });
                App.showToast("ðŸš€ 24h Profile Boost Activated!");
            }
            else if (itemId === 'banner') {
                await updateDoc(userRef, { hasCustomBanner: true });
                App.showToast("âœ… Banner Unlocked!");
            }
            else if (itemId === 'ghost') {
                await updateDoc(userRef, { "privacy.ghostMode": true });
                App.showToast("ðŸ‘» Ghost Mode Active");
            }
            else if (itemId.startsWith('orbs_')) {
                const amount = parseInt(itemId.split('_')[1]);
                await updateDoc(userRef, { orbs: increment(amount) });
                App.showToast(`âœ… Added ${amount} Orbs to Wallet!`);
            }

            // 5. Sync Database to Local Memory
            const newSnap = await getDoc(userRef);
            const freshData = newSnap.data();
            DataManager.saveProfile(freshData);
            
            // 6. Update UI
            btn.innerText = "Owned";
            btn.style.background = "#00C853"; 
            btn.style.color = "white";
            
            const shopBal = document.getElementById('shop-balance');
            const walletBal = document.getElementById('wallet-orb-balance');
            if (shopBal) shopBal.innerText = freshData.orbs || 0;
            if (walletBal) walletBal.innerText = freshData.orbs || 0;

            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);

            if (document.getElementById('wallet-page').classList.contains('active')) {
                App.openWalletPage();
            }
            App.openShopPage();

        } catch (e) {
            console.error("Post-Payment Error:", e);
            App.showToast("âŒ Error updating profile.");
            btn.innerText = originalText;
            btn.style.background = originalBg;
            btn.disabled = false;
        }
    });

    setTimeout(() => {
        if (btn.innerText === "Processing...") {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }, 10000); 
},
checkVerificationExpiry: async (profile) => {
    // 1. Check if they even have a subscription
    if (profile.isVerified && profile.verificationExpires) {
        
        // 2. Compare current time to expiry time
        if (Date.now() > profile.verificationExpires) {
            console.log("Subscription expired. Removing badge...");
            
            try {
                const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userRef = doc(db, "users", profile.uid);

                // 3. Update Database
                await updateDoc(userRef, { isVerified: false });

                // 4. Update Local Memory
                profile.isVerified = false;
                DataManager.saveProfile(profile);
                
                App.showToast("Your verification has expired.");
                return false;
            } catch (e) {
                console.error("Expiry Sync Error:", e);
            }
        }
    }
    return profile.isVerified;
},


// --- ðŸž SYSTEM TOAST NOTIFICATIONS ---

showToast: (text) => {
    // Remove existing toast if any
    const oldToast = document.querySelector('.app-toast');
    if (oldToast) oldToast.remove();

    const toast = document.createElement('div');
    toast.className = 'app-toast';
    toast.innerText = text;
    
    // WhatsApp/Telegram styled toast
    toast.style.cssText = `
        position: fixed; 
        top: 25px; 
        left: 50%; 
        transform: translateX(-50%); 
        background: #232e3c; 
        color: white; 
        padding: 12px 24px; 
        border-radius: 30px; 
        z-index: 9999; 
        font-size: 14px; 
        font-weight: 500;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
        border: 1px solid #5865F2;
        transition: opacity 0.4s ease, transform 0.4s ease;
        pointer-events: none;
    `;
    
    document.body.appendChild(toast);

    // Animate out
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
 },

                        // --- ðŸ”´ LIVE & GAMING ENGINE ---
    openLivePage: async () => {
    // 1. Switch to the Prep Page first (TikTok flow)
    App.goToPage('live-prep-page');
    
    // 2. Link the camera stream to the prep video element
    const prepVideo = document.getElementById('live-prep-video');
    try {
        if (!state.cameraStream) {
            state.cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' }, 
                audio: true 
            });
        }
        if (prepVideo) prepVideo.srcObject = state.cameraStream;
    } catch (e) {
        App.showToast("Camera needed for LIVE");
    }
},

// Proceeds from Prep Page to actual choices (Battle, Streaming, Gaming)
openLiveSelection: () => {
    App.goToPage('live-selection-page');
}, 

                        // --- ðŸ”´ START LIVE BROADCAST ---
                        startLive: async (mode) => {
    // --- 1. THE ARENA SWITCH (Battle Mode / No Video) ---
    if (mode === 'battle') {
        App.showToast("âš”ï¸ Creating Fresh Battle Arena...");
        
        const profile = DataManager.getProfile();
        
        // ðŸŒŸ UNIQUE ID FIX: Adds timestamp so comments/viewers are always reset
        const liveId = "battle_" + state.currentUser.uid + "_" + Date.now(); 
        state.currentLiveId = liveId;
        state.battleDuration = state.battleDuration || 5; 

        // ðŸŒŸ LANDING FIX: Land directly on the Arena Page
        App.goToPage('arena-broadcast-page'); 

        // ðŸ›¡ï¸ UI SETUP: Show Kelvin's profile immediately and reveal Host Tools
        const hostImg = document.getElementById('arena-host-img');
        const hostTools = document.getElementById('arena-host-tools');
        const endBtn = document.getElementById('arena-end-btn');

        if (hostImg) hostImg.src = profile.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        if (hostTools) hostTools.style.display = 'flex';
        if (endBtn) endBtn.style.display = 'block';

        const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        // Register the fresh battle session in Firebase
        await setDoc(doc(db, "lives", liveId), {
            hostId: state.currentUser.uid,
            hostName: profile.name,
            hostAvatar: profile.photo,
            active: true,
            type: 'battle',
            p1_score: 0,
            p2_score: 0,
            p2_id: null, 
            viewerCount: 1,
            totalLikes: 0,
            timestamp: Date.now(),
            durationMinutes: state.battleDuration
        });

        // Initialize Arena Listeners
        App.loadArenaComments(); // Clears and starts fresh arena chat
        App.listenToViewerCount();
        App.listenToLiveLikes();
        App.listenToArenaBattle(liveId); 
        return;
    }

    // --- 2. THE YOUTUBE CDN SWITCH (Scalable Streaming) ---
    if (mode === 'streaming') {
        App.showToast("Opening YouTube Handshake...");
        window.location.href = '/api/auth';
        return; 
    }

    // --- 3. THE ORIGINAL P2P ENGINE (For Gaming Mode) ---
    App.goToPage('live-broadcast-page'); 
    const video = document.getElementById('live-video-element'); 
    if(video) video.style.display = 'block'; 
    
    const profile = DataManager.getProfile(); 
    const followBtn = document.getElementById('live-follow-btn');
    const sidebar = document.getElementById('host-exclusive-controls');
    const endBtn = document.getElementById('live-end-btn');

    if (followBtn) followBtn.style.display = 'none';
    if (sidebar) sidebar.style.display = 'flex';     
    if (endBtn) endBtn.style.display = 'block';       

    document.getElementById('live-host-avatar').src = profile.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 
    document.getElementById('live-host-name').innerText = profile.name; 

    try {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            throw new Error("Camera/Screen capture requires HTTPS or localhost.");
        }

        let stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }); 
        
        if(video) {
            video.muted = true;            
            video.srcObject = stream; 
            video.play();
        }
        
        state.liveStream = stream; 
        const liveId = "live_" + state.currentUser.uid; 
        state.currentLiveId = liveId;

        const { doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"); 
        
        await deleteDoc(doc(db, "lives", liveId, "broadcast_signal", "main")).catch(()=>{});

        const liveRef = doc(db, "lives", liveId);
        const liveSnap = await getDoc(liveRef);

        if (liveSnap.exists() && liveSnap.data().active === true) {
            await updateDoc(liveRef, { active: true, hostName: profile.name });
            App.showToast("ðŸ”„ Resuming session...");
        } else {
            await setDoc(liveRef, {
                hostId: state.currentUser.uid,  
                hostName: profile.name,  
                hostAvatar: profile.photo,  
                active: true,  
                type: 'gaming',
                viewerCount: 1,
                totalLikes: 0, 
                timestamp: Date.now()
            });
            App.showToast("ðŸš€ You are now LIVE!"); 
        }

        const pc = new RTCPeerConnection({ 
            iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }, { urls: 'stun:stun2.l.google.com:19302' }] 
        });
        
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        pc.onicecandidate = (e) => {
            if (e.candidate) {
                addDoc(collection(db, "lives", liveId, "host_candidates"), e.candidate.toJSON());
            }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        await setDoc(doc(db, "lives", liveId, "broadcast_signal", "main"), {
            offer: { type: offer.type, sdp: offer.sdp },
            timestamp: Date.now()
        });

        onSnapshot(doc(db, "lives", liveId, "broadcast_signal", "main"), async (snap) => {
            const data = snap.data();
            if (data && data.answer && !pc.currentRemoteDescription) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        });

        App.loadLiveComments();     
        App.listenToViewerCount();  
        App.listenToLiveLikes();    
        
    } catch (e) {
        console.error("Live Start Error:", e);
        alert("System Error: " + e.message);
        App.goToPage('home-page'); 
    }
  } ,

    renderCoHostStream: async (coHostUid) => {
        const cohostBox = document.getElementById('cohost-container');
        const cohostVideo = document.getElementById('cohost-video-element');
        if (!coHostUid) return;

        const signalPath = `lives/${state.currentLiveId}/cohost_signals/${coHostUid}`;
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });

        pc.ontrack = (event) => {
            cohostVideo.srcObject = event.streams[0];
            cohostBox.style.display = 'block'; 
        };

        const { doc, onSnapshot, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        onSnapshot(doc(db, signalPath), async (snapshot) => {
            const data = snapshot.data();
            if (data && data.offer && !pc.currentRemoteDescription) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                await updateDoc(doc(db, signalPath), { 
                    answer: { type: answer.type, sdp: answer.sdp } 
                });
            }
        });
        state.coHostPeerConnection = pc;
    }, 

    sendLiveComment: async () => {
        const input = document.getElementById('live-comment-input'); 
        const text = input.value.trim(); 
        if (!text) return;

        const profile = DataManager.getProfile(); 
        const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"); 
        
        await addDoc(collection(db, "lives", state.currentLiveId, "comments"), {
            uid: state.currentUser.uid,  
            name: profile.name,  
            text: text,  
            timestamp: Date.now()
        }); 
        input.value = ""; 
    }, 

    loadLiveComments: async () => { // FIX: Added async here
        const container = document.getElementById('live-comments-container'); 
        const { query, collection, orderBy, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"); 
        
        const q = query(collection(db, "lives", state.currentLiveId, "comments"), orderBy("timestamp", "asc")); 
        
        onSnapshot(q, (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const c = change.doc.data(); 
                    const pill = document.createElement('div'); 
                    pill.style.cssText = "background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 15px; color: white; font-size: 13px; width: fit-content; margin-bottom: 5px; animation: slideUp 0.3s ease-out;"; 
                    pill.innerHTML = `<span style="color: #ff4b7d; font-weight: bold;">${c.name}:</span> ${c.text}`; 
                    container.appendChild(pill); 
                    container.scrollTop = container.scrollHeight; 
                    setTimeout(() => {
                        pill.style.opacity = '0'; 
                        pill.style.transition = '0.5s'; 
                        setTimeout(() => pill.remove(), 500); 
                    }, 8000); 
                }
            }); 
        }); 
    }, 

    listenToViewerCount: async () => { // FIX: Added async here
        const { doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"); 
        onSnapshot(doc(db, "lives", state.currentLiveId), (doc) => {
            if (doc.exists()) {
                const viewerEl = document.getElementById('live-viewer-count'); 
                if (viewerEl) viewerEl.innerText = doc.data().viewerCount || 0; 
            }
        }); 
    }, 

        openViewerInviteList: async () => {
        const modal = document.getElementById('viewer-invite-modal'); 
        const listContainer = document.getElementById('active-viewer-list'); 
        modal.style.display = 'flex'; 
        listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:white;"><i class="fa-solid fa-spinner fa-spin"></i> Searching for opponents...</div>'; 

        try {
            const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"); 
            
            // Fetch users who are currently watching this specific battle session
            const viewersSnap = await getDocs(collection(db, "lives", state.currentLiveId, "viewers")); 
            listContainer.innerHTML = ""; 
            
            if (viewersSnap.empty) {
                listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No viewers in the Arena yet</div>';
                return;
            }

            viewersSnap.forEach(doc => {
                const v = doc.data(); 
                // Don't show yourself in the challenge list
                if (v.uid === state.currentUser.uid) return;

                const div = document.createElement('div');
                div.className = "list-item";
                div.style.cssText = "border-bottom: 1px solid #333; padding: 10px 0; display: flex; align-items: center; gap: 15px;";
                div.innerHTML = `
                    <img src="${v.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="list-avatar" style="width:40px; height:40px; border-radius:50%; border: 1px solid #444;">
                    <div style="flex:1; color:white; font-weight: 500; font-size: 15px;">${v.name}</div>
                    
                    <button onclick="app.inviteViewerAsOpponent('${v.uid}', '${v.name}')" 
                            style="background:#f1c40f; color:black; border:none; padding:8px 16px; border-radius:20px; font-size:11px; font-weight:800; cursor:pointer; text-transform: uppercase;">
                        Challenge
                    </button>
                `;
                listContainer.appendChild(div);
            });
        } catch (e) {
            console.error("Invite List Error:", e);
            listContainer.innerHTML = '<div style="color:red; padding:20px; text-align:center;">Connection lost.</div>';
        }
    },

    sendCoHostInvite: async (uid, name) => {
        const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await addDoc(collection(db, "live_invites"), {
            liveId: state.currentLiveId,  
            viewerId: uid,  
            hostName: DataManager.getProfile().name,  
            status: 'pending',  
            timestamp: Date.now()
        });
        App.showToast("Invite sent to " + name);
        document.getElementById('viewer-invite-modal').style.display = 'none';
    },

            initLiveInviteListener: async () => {
        const { collection, query, where, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // Listen only for invites sent to ME that are still PENDING
        const q = query(
            collection(db, "live_invites"), 
            where("viewerId", "==", state.currentUser.uid), 
            where("status", "==", "pending")
        );
        
        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    const invite = change.doc.data();
                    state.activeInviteId = change.doc.id;
                    state.targetLiveId = invite.liveId;
                    
                    // Show the invite modal to User B
                    document.getElementById('invite-host-name').innerText = invite.hostName;
                    document.getElementById('cohost-invite-modal').style.display = 'flex';
                    
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            });
        });
    } ,

    acceptCoHostInvite: async () => {
        document.getElementById('cohost-invite-modal').style.display = 'none';
        App.showToast("Connecting...");
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            state.coHostLocalStream = stream;
            
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });
            stream.getTracks().forEach(track => pc.addTrack(track, stream));
            
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const { doc, setDoc, updateDoc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const signalPath = `lives/${state.targetLiveId}/cohost_signals/${state.currentUser.uid}`;
            
            await setDoc(doc(db, signalPath), { 
                offer: { type: offer.type, sdp: offer.sdp },  
                viewerName: DataManager.getProfile().name,  
                timestamp: Date.now() 
            });
            
            await updateDoc(doc(db, "lives", state.targetLiveId), { coHostId: state.currentUser.uid });
            
            onSnapshot(doc(db, signalPath), async (snap) => {
                const data = snap.data(); // FIX: Added data check here
                if (data && data.answer && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    App.goToPage('live-broadcast-page');
                }
            });
            await updateDoc(doc(db, "live_invites", state.activeInviteId), { status: 'accepted' });
        } catch (e) { 
            console.error(e);
            App.showToast("Failed to join"); 
        }
    },

        openShareContactPicker: async () => {
        // 1. Switch to selection page
        App.goToPage('create-group-select-page'); 
        
        // 2. Setup UI Labels
        document.getElementById('cg-page-title').innerText = "Share Live Link"; 
        document.getElementById('cg-selected-count').innerText = "Select contacts to invite";
        
        // 3. Fix Back Button (Ensures you return to Live, not Chat List)
        document.getElementById('cg-back-btn').onclick = () => App.goToPage('live-broadcast-page');

        const list = document.getElementById('cg-contact-list');
        list.innerHTML = '<div style="padding:20px; text-align:center; color:gray;">Loading saved contacts...</div>';

        // 4. Get your Saved Contacts from Local Storage
        const savedContactIds = JSON.parse(localStorage.getItem('saved_contacts') || '[]');

        if (savedContactIds.length === 0) {
            list.innerHTML = `
                <div style="padding:40px; text-align:center; color:#8696a0;">
                    <i class="fa-solid fa-address-book" style="font-size:40px; margin-bottom:15px; opacity:0.3;"></i>
                    <p>No saved contacts found. Save people from their profiles to share links with them.</p>
                </div>`;
            return;
        }

        try {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            list.innerHTML = "";
            state.allContacts = []; 
            state.groupParticipants = []; // Clear previous selection

            // 5. Fetch details for ONLY the IDs you have saved
            for (const uid of savedContactIds) {
                const userSnap = await getDoc(doc(db, "users", uid));
                if (userSnap.exists()) {
                    const userData = { uid: uid, ...userSnap.data() };
                    state.allContacts.push(userData);
                    App.renderContactItem(userData, list);
                }
            }

            // 6. Update the "Send" button logic
            const nextBtn = document.getElementById('cg-next-btn');
            nextBtn.style.display = 'none'; // Hidden until someone is selected
            
            nextBtn.onclick = async () => {
                const liveLink = `${window.location.origin}/?live=${state.currentLiveId}`;
                const shareText = `ðŸ‘‹ I'm LIVE! Join me here: \n${liveLink}`;
                
                App.showToast(`Sending to ${state.groupParticipants.length} contacts...`);

                // Send the link to every selected person
                for (const contact of state.groupParticipants) {
                    // Force the currentChatId to the contact's ID temporarily to send the message
                    const originalChatId = state.currentChatId;
                    state.currentChatId = contact.uid;
                    await App.sendMessage(shareText);
                    state.currentChatId = originalChatId;
                }

                App.showToast("Links Sent Successfully!");
                state.groupParticipants = []; 
                App.goToPage('live-broadcast-page'); 
            };

        } catch (e) {
            console.error("Share Picker Error:", e);
            list.innerHTML = '<div style="padding:20px; text-align:center; color:red;">Error loading contacts.</div>';
        }
    },           

    exitCoHost: async () => {
        // 1. Stop Viewer's local camera/mic tracks
        if (state.coHostLocalStream) {
            state.coHostLocalStream.getTracks().forEach(track => track.stop());
        }

        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const liveId = state.currentLiveId || state.targetLiveId;
        if (liveId) {
            // Remove co-host ID from the live session so the UI updates for everyone
            await updateDoc(doc(db, "lives", liveId), {
                coHostId: null
            });
        }
        
        // 2. Close WebRTC Connection
        if (state.coHostPeerConnection) {
            state.coHostPeerConnection.close();
            state.coHostPeerConnection = null;
        }
        
        // 3. Redirect and Hide UI
        if (state.targetLiveId) {
            App.goToPage('home-page'); 
        } else {
            const coBox = document.getElementById('cohost-container');
            if (coBox) coBox.style.display = 'none';
        }
        
        App.showToast("Co-hosting ended");
    },
            // --- â¤ï¸ LIVE INTERACTION ENGINE ---

    // 1. Double-Tap Explosion Handler
    sendLiveHeart: async (event) => {
        const area = document.getElementById('live-tap-area');
        if (!area || !state.currentLiveId) return;

        // Get tap coordinates to center the explosion
        const rect = area.getBoundingClientRect();
        // Handle both mouse clicks and touch events
        const clientX = event.touches && event.touches[0] ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches && event.touches[0] ? event.touches[0].clientY : event.clientY;
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        // A. Create Visual Explosion (Spawn multiple hearts)
        const burstCount = 3; // Adjust number of hearts per tap here
        for (let i = 0; i < burstCount; i++) {
            const heart = document.createElement('i');
            heart.className = "fa-solid fa-heart floating-heart";
            
            // Position heart where tapped
            heart.style.left = `${x - 15}px`; // Offset to center heart icon
            heart.style.top = `${y - 15}px`;

            // Calculate Random Explosion Trajectories
            // tx: Random horizontal movement (left or right)
            const tx = (Math.random() * 200 - 100) + "px"; 
            // ty: Random upward movement (always negative to go up)
            const ty = (Math.random() * -250 - 80) + "px"; 
            // tr: Random rotation spread
            const tr = (Math.random() * 120 - 60) + "deg";   

            // Apply trajectory variables for the CSS animation to use
            heart.style.setProperty('--tx', tx);
            heart.style.setProperty('--ty', ty);
            heart.style.setProperty('--tr', tr);
            
            // Slight delay between hearts for a more dynamic burst feel
            setTimeout(() => {
                 area.appendChild(heart);
                 // Remove from DOM after animation finishes (1s matches CSS duration)
                 setTimeout(() => heart.remove(), 1000);
            }, i * 30);
        }

        // B. Update Firestore (Sync count with everyone)
        // We only increment by 1 per tap, regardless of how many visual hearts burst
        const { doc, updateDoc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        try {
            await updateDoc(doc(db, "lives", state.currentLiveId), {
                totalLikes: increment(1)
            });
            if (navigator.vibrate) navigator.vibrate(30); // Crisp haptic feedback
        } catch (e) { console.error("Like failed", e); }
    },

    // 2. Real-time Like Listener
    listenToLiveLikes: async () => {
        const { doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const likeEl = document.getElementById('live-like-count');

        onSnapshot(doc(db, "lives", state.currentLiveId), (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.data();
                const total = data.totalLikes || 0;
                // Format: 1500 -> 1.5k
                likeEl.innerText = App.formatLikeCount(total);
            }
        });
    },

    // 3. Number Formatter (TikTok Style)
    formatLikeCount: (num) => {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
        return num;
    },
            
    joinLiveAsViewer: async (liveId) => {
    App.showToast("Joining session...");
    
    try {
        const { doc, getDoc, setDoc, updateDoc, increment, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const liveRef = doc(db, "lives", liveId);
        const snap = await getDoc(liveRef);

        if (snap.exists() && snap.data().active === true) {
            const data = snap.data();
            const myUid = state.currentUser.uid;
            const profile = DataManager.getProfile();
            state.currentLiveId = liveId;

            // 1. ROUTING LOGIC: Battle vs Normal Streaming
            if (data.type === 'battle') {
                // âš”ï¸ Route directly to Arena
                App.goToPage('arena-broadcast-page');
                
                // Sync Host Visuals in Arena (Fixes black screen for viewers)
                const hostImg = document.getElementById('arena-host-img');
                if (hostImg) hostImg.src = data.hostAvatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                
                // Initialize Battle Sync
                App.listenToArenaBattle(liveId);
                App.loadArenaComments();
            } else {
                // ðŸ“¹ Route to standard Live Player
                App.goToPage('live-broadcast-page');
                
                // Reset standard player visibility
                document.getElementById('live-video-element').style.display = 'none';
                document.getElementById('youtube-player').style.display = 'none';
                
                document.getElementById('live-host-name').innerText = data.hostName;
                document.getElementById('live-host-avatar').src = data.hostAvatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                
                App.connectToHostStream(liveId, data.hostId);
                App.loadLiveComments();
            }

            // 2. Viewer Registration
            await setDoc(doc(db, "lives", liveId, "viewers", myUid), {
                uid: myUid,
                name: profile.name || "User",
                photo: profile.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                timestamp: Date.now()
            });

            // 3. Session Life Monitor (Auto-exit if host ends live)
            onSnapshot(liveRef, (s) => {
                if (!s.exists() || s.data().active === false) {
                    App.showToast("The live session has ended.");
                    App.goToPage('home-page');
                    const yt = document.getElementById('youtube-player');
                    if (yt) yt.src = "";
                }
            });

            // 4. Common HUD Listeners
            App.listenToViewerCount();
            App.listenToLiveLikes();

            await updateDoc(liveRef, { viewerCount: increment(1) });

        } else {
            alert("This live session has ended.");
            App.goToPage('home-page');
        }
    } catch (e) {
        console.error("Join Live Error:", e);
        App.showToast("Failed to join session.");
       }
  } ,
 connectToHostStream: async (liveId, hostId) => {
    const videoEl = document.getElementById('live-video-element');
    const ytPlayer = document.getElementById('youtube-player');
    const { doc, getDoc, onSnapshot, updateDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

    // 1. Fetch the Live Data once to check the engine type
    const liveSnap = await getDoc(doc(db, "lives", liveId));
    if (!liveSnap.exists()) return;
    const liveData = liveSnap.data();

    // --- ðŸŸ¢ SCENARIO A: YOUTUBE SCALABLE ENGINE (Millions of Viewers) ---
    if (liveData.youtubeVideoId) {
        // Hide standard video, show YouTube iframe
        videoEl.style.display = 'none';
        ytPlayer.style.display = 'block';
        
        // Load the YouTube stream using the Video ID saved by the host
        ytPlayer.src = `https://www.youtube.com/embed/${liveData.youtubeVideoId}?autoplay=1&controls=0&modestbranding=1&rel=0&iv_load_policy=3`;
        return; 
    }

    // --- ðŸ”µ SCENARIO B: P2P WEBRTC ENGINE (Gaming / Small Groups) ---
    videoEl.style.display = 'block';
    ytPlayer.style.display = 'none';

    const pc = new RTCPeerConnection({ 
        iceServers: [
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' }
        ] 
    });
    
    // Listen for Host's Network Path (ICE Candidates)
    onSnapshot(collection(db, "lives", liveId, "host_candidates"), (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const candidateData = change.doc.data();
                if (candidateData) {
                    pc.addIceCandidate(new RTCIceCandidate(candidateData)).catch(e => console.error("ICE error", e));
                }
            }
        });
    });

    pc.ontrack = (event) => {
        if (videoEl) {
            videoEl.srcObject = event.streams[0];
            videoEl.muted = false; 
            videoEl.play().catch(e => console.log("Autoplay blocked, waiting for interaction"));
        }
    };

    // Listen for the Host's broadcast offer
    onSnapshot(doc(db, "lives", liveId, "broadcast_signal", "main"), async (snap) => {
        if (snap.exists()) {
            const data = snap.data();
            if (data.offer && !pc.currentRemoteDescription) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                // Send the Answer back to the Host so they can start the stream
                await updateDoc(doc(db, "lives", liveId, "broadcast_signal", "main"), {
                    answer: { type: answer.type, sdp: answer.sdp }
                });
             }
          }
      });
   } ,
   updateArenaScore: (p1_score, p2_score) => {
    const total = p1_score + p2_score;
    let p1_width = 50;
    let p2_width = 50;

    if (total > 0) {
        p1_width = (p1_score / total) * 100;
        p2_width = (p2_score / total) * 100;
    }

    // Move the bars visually
    const bar1 = document.getElementById('p1-power-bar');
    const bar2 = document.getElementById('p2-power-bar');
    
    if (bar1 && bar2) {
        bar1.style.width = p1_width + "%";
        bar2.style.width = p2_width + "%";
        document.getElementById('p1-score-val').innerText = p1_score;
        document.getElementById('p2-score-val').innerText = p2_score;
    }

    // Haptic feedback when the lead changes
    if (navigator.vibrate) navigator.vibrate(50);
} ,

listenToArenaBattle: async (battleId) => {
    const { doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    onSnapshot(doc(db, "lives", battleId), (snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.data();
            const myUid = state.currentUser.uid;
            const isHost = myUid === data.hostId;

            // 1. SYNC HUD STATS & SCORES
            App.updateArenaScore(data.p1_score || 0, data.p2_score || 0);
            
            const viewCountEl = document.getElementById('arena-viewer-count');
            if (viewCountEl) viewCountEl.innerText = data.viewerCount || 0;

            // 2. HOST PROFILE SYNC
            const hostImg = document.getElementById('arena-host-img');
            if (hostImg) hostImg.src = data.hostAvatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";

            // 3. SHOW HOST-ONLY CONTROLS
            const hostTools = document.getElementById('arena-host-tools');
            const endBtn = document.getElementById('arena-end-btn');
            
            if (isHost) {
                if (hostTools) hostTools.style.display = 'flex';
                if (endBtn) endBtn.style.display = 'block';
            }

            // 4. DETECT CHALLENGER JOINING
            if (data.p2_id && !state.arenaActive) {
                state.arenaActive = true;
                state.currentOpponentId = data.p2_id;
                
                // --- ðŸŽ™ï¸ START REAL-TIME VOICE BRIDGE ---
                // This activates the microphone and connects Host and Challenger
                App.initBattleAudio(isHost); 

                // Show Scoreboard & Reveal Opponent Side
                const scoreboard = document.getElementById('arena-scoreboard');
                const opponentArea = document.getElementById('p2-fighter-area');
                const oppImg = document.getElementById('arena-opponent-img');
                const followP2 = document.getElementById('follow-p2');

                if (scoreboard) scoreboard.style.opacity = '1';
                if (opponentArea) opponentArea.style.opacity = '1';
                if (oppImg) {
                    oppImg.src = data.p2_photo;
                    oppImg.style.filter = 'none';
                }
                if (followP2) followP2.style.display = 'block';

                // ðŸ”Š VOICE ANNOUNCEMENT & ANIMATION
                App.triggerBattleStartAnimation(data.p2_name, data.hostName);
                
                // Start the Battle Timer
                const duration = data.durationMinutes || 5;
                App.startArenaTimer(Date.now() + (duration * 60 * 1000));
            }
        }
    });
 },


    // --- âš”ï¸ SEND BATTLE CHALLENGE ENGINE ---
  inviteViewerAsOpponent: async (viewerUid, viewerName) => {
    // 1. Safety Check: Ensure the Host actually has an active Arena session ID
    if (!state.currentLiveId) {
        App.showToast("Error: Arena session ID missing. Restart Live.");
        return;
    }

    // 2. Dynamic Firebase Imports
    const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    // 3. Get Host Profile Data for the Invite Card
    const myProfile = DataManager.getProfile();
    const hostName = myProfile.name || "A Host";
    
    App.showToast(`âš”ï¸ Sending Challenge to ${viewerName}...`);

    try {
        // 4. Create the Invite Document in the 'battle_invites' collection.
        // VITAL: 'targetUid' and 'status' must match your Global Radar query exactly.
        await addDoc(collection(db, "battle_invites"), {
            battleId: state.currentLiveId,         // ID of the Arena session to join
            hostId: state.currentUser.uid,        // Your ID (The Challenger)
            hostName: hostName,                   // Your Name (For the popup)
            targetUid: viewerUid,                 // The user you are inviting
            status: 'pending',                    // Must be 'pending' for the Radar to fire
            timestamp: Date.now(),                // Local time for sorting
            serverTime: serverTimestamp()         // Database time for security
        });

        // 5. UI Cleanup: Close the viewer list so you can see the Arena stage
        const inviteModal = document.getElementById('viewer-invite-modal');
        if (inviteModal) {
            inviteModal.style.display = 'none';
        }
        
        // 6. Success Feedback
        App.showToast("Challenge Delivered âœ…");
        
        // Haptic feedback for a "heavy" action
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);

    } catch (e) {
        console.error("Critical Invite Error:", e);
        App.showToast("Network Error: Could not reach user.");
    }
 },


  // --- 2. ACCEPT BATTLE CHALLENGE ---
    acceptBattleChallenge: async (inviteId, battleId) => {
    const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const profile = DataManager.getProfile();

    App.showToast("âš”ï¸ Entering Arena...");

    try {
        // 1. Update the Main Live Document
        await updateDoc(doc(db, "lives", battleId), {
            p2_id: state.currentUser.uid,
            p2_name: profile.name || "Opponent",
            p2_photo: profile.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png",
            battleStarted: true,
            endTime: Date.now() + (5 * 60 * 1000) 
        });

        // 2. Update Invite Status
        await updateDoc(doc(db, "battle_invites", inviteId), { 
            status: 'accepted' 
        });

        // 3. ðŸš€ NAVIGATION & UI SYNC
        state.currentLiveId = battleId;
        App.goToPage('arena-broadcast-page');

        // --- ðŸŽ™ï¸ START REAL-TIME VOICE BRIDGE ---
        // As the opponent, we initialize the audio engine in "receiver" mode
        App.initBattleAudio(false); 

        // Reset the Opponent UI
        const opponentArea = document.getElementById('p2-fighter-area');
        const statusLabel = document.getElementById('p2-status-label');
        if (opponentArea) opponentArea.style.opacity = '1';
        if (statusLabel) statusLabel.innerText = "CHALLENGER";

        // 4. CONNECT REAL-TIME ARENA LOGIC
        App.listenToArenaBattle(battleId);
        App.loadArenaComments();

    } catch (e) {
        console.error("Accept Battle Error:", e);
        App.showToast("Could not join the battle.");
    }
  },

triggerBattleStartAnimation: (challengerName, hostName) => {
    // ðŸ”Š VOICE ANNOUNCEMENT
    const msg = new SpeechSynthesisUtterance(`${challengerName} challenges ${hostName}!`);
    window.speechSynthesis.speak(msg);

    // ðŸŽ¬ ANIMATION SWITCH: Reveal the Arena UI
    const arenaPage = document.getElementById('arena-broadcast-page');
    if (arenaPage) {
        arenaPage.style.display = 'block';
        arenaPage.classList.add('slide-in-up'); 
    }

    // ðŸ•’ Start the 5-minute countdown visuals
    const endTime = Date.now() + (5 * 60 * 1000);
    App.startArenaTimer(endTime);
    
    // ðŸ›¡ï¸ UI CLEANUP: Hide Host's own follow button on their screen
    const followP1 = document.getElementById('follow-p1');
    if (state.currentUser.uid === state.currentHostId && followP1) {
        followP1.style.display = 'none';
    }
  } ,

sendArenaComment: async () => {
    const input = document.getElementById('arena-comment-input');
    const text = input.value.trim();
    if (!text) return;

    const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const profile = DataManager.getProfile();

    await addDoc(collection(db, "lives", state.currentLiveId, "comments"), {
        uid: state.currentUser.uid,
        name: profile.name,
        text: text,
        timestamp: Date.now()
    });

    input.value = "";
} ,

  // --- ðŸ”´ EXIT & CLEANUP ENGINE ---
    endLiveSession: async () => {
    const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    if (confirm("End this session?")) {
        // 1. SECURE HARDWARE & TIMERS
        if (state.battleInterval) {
            clearInterval(state.battleInterval);
            state.battleInterval = null;
        }

        // --- ðŸŽ™ï¸ AUDIO HARDWARE CLEANUP ---
        // Explicitly stop the microphone and close the P2P connection
        if (state.arenaAudioStream) {
            state.arenaAudioStream.getTracks().forEach(track => track.stop());
            state.arenaAudioStream = null;
        }
        if (state.arenaPeerConnection) {
            state.arenaPeerConnection.close();
            state.arenaPeerConnection = null;
        }

        // 2. DATABASE SYNC
        if (state.currentLiveId) {
            try {
                await updateDoc(doc(db, "lives", state.currentLiveId), { 
                    active: false,
                    endedAt: Date.now()
                });
            } catch (err) {
                console.error("Firebase update failed during exit:", err);
            }
        }
        
        // 3. RESET LOCAL BATTLE FLAGS
        state.arenaActive = false; 
        state.currentOpponentId = null;
        state.battleDuration = 5; 

        // 4. UI CLEANUP
        const arenaComments = document.getElementById('arena-comments-container');
        const liveComments = document.getElementById('live-comments-container');
        const viewerCountEl = document.getElementById('arena-viewer-count');
        
        if (arenaComments) arenaComments.innerHTML = "";
        if (liveComments) liveComments.innerHTML = "";
        if (viewerCountEl) viewerCountEl.innerText = "0";

        const p1Bar = document.getElementById('p1-power-bar');
        const p2Bar = document.getElementById('p2-power-bar');
        if (p1Bar) p1Bar.style.width = "50%";
        if (p2Bar) p2Bar.style.width = "50%";

        // 5. NAVIGATION & SESSION REFRESH
        App.goToPage('home-page');
        App.showToast("Session Closed Successfully");

        setTimeout(() => {
            location.reload(); 
        }, 500);
    }
  },


  sendArenaComment: async () => {
    const input = document.getElementById('arena-comment-input');
    const text = input.value.trim();
    if (!text) return;

    const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const profile = DataManager.getProfile();

    await addDoc(collection(db, "lives", state.currentLiveId, "comments"), {
        uid: state.currentUser.uid,
        name: profile.name,
        text: text,
        timestamp: Date.now()
    });

    input.value = "";
  } ,
  loadArenaComments: async () => {
    const container = document.getElementById('arena-comments-container');
    if (!container) return;

    const { collection, query, orderBy, limit, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    const q = query(
        collection(db, "lives", state.currentLiveId, "comments"),
        orderBy("timestamp", "asc"),
        limit(20)
    );

    onSnapshot(q, (snapshot) => {
        container.innerHTML = ""; 
        snapshot.forEach((doc) => {
            const data = doc.data();
            const commentDiv = document.createElement('div');
            commentDiv.style.cssText = "background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 15px; color: white; font-size: 13px; margin-bottom: 5px; width: fit-content;";
            commentDiv.innerHTML = `<span style="color: #ff4b7d; font-weight: bold;">${data.name}:</span> ${data.text}`;
            container.appendChild(commentDiv);
        });
        container.scrollTop = container.scrollHeight;
    });
  } ,
  openBattleSettings: () => {
    const time = prompt("Set Battle Time (minutes):", "5");
    if (time && !isNaN(time)) {
        state.battleDuration = parseInt(time);
        const { doc, updateDoc } = import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        updateDoc(doc(db, "lives", state.currentLiveId), { durationMinutes: state.battleDuration });
        App.showToast(`Duration: ${time}m`);
    }
  } ,
  initBattleInviteListener: async () => {
    // ðŸ›¡ï¸ AUTH CHECK & RETRY: Ensures the user's UID is ready before the query starts
    if (!state.currentUser) {
        console.warn("â³ Battle Listener: User auth not ready, retrying in 2s...");
        setTimeout(() => App.initBattleInviteListener(), 2000);
        return;
    }

    const { collection, query, where, onSnapshot, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    console.log("ðŸ‘‚ Battle Ear Active for UID:", state.currentUser.uid);

    // Filter for invites where THIS user is the target and the challenge is still pending
    // We add orderBy to ensure we always get the absolute latest invite first
    const q = query(
        collection(db, "battle_invites"), 
        where("targetUid", "==", state.currentUser.uid), 
        where("status", "==", "pending")
    );
    
    // ðŸ“¡ ACTIVE SNAPSHOT: Listens for real-time database changes
    onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach(change => {
            // Logic fires only when a NEW invite is added to the database
            if (change.type === "added") {
                const invite = change.doc.data();
                const inviteId = change.doc.id;

                console.log("âš”ï¸ CHALLENGE DETECTED FROM:", invite.hostName);

                // 1. POPULATE & SHOW CUSTOM MODAL
                const nameLabel = document.getElementById('battle-challenger-name');
                const modal = document.getElementById('battle-invite-modal');
                const acceptBtn = document.getElementById('battle-confirm-btn');

                if (modal && nameLabel) {
                    nameLabel.innerText = invite.hostName;
                    
                    // FORCE VISIBILITY: Overrides any other hidden state
                    modal.style.display = 'flex';
                    modal.style.zIndex = '99999'; 

                    // 2. ATTACH LOGIC TO CUSTOM BUTTON
                    acceptBtn.onclick = () => {
                        modal.style.display = 'none';
                        App.acceptBattleChallenge(inviteId, invite.battleId);
                    };

                    // 3. AUTO-REJECT LOGIC (Optional)
                    // If they don't answer in 20 seconds, hide it so it doesn't stay on screen
                    setTimeout(() => {
                        if(modal.style.display === 'flex') {
                            modal.style.display = 'none';
                            App.showToast("Invite from " + invite.hostName + " expired");
                        }
                    }, 20000);
                }

                // 4. HAPTIC & AUDIO FEEDBACK
                // Vibrate the phone (TikTok style alert)
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
                // Play a subtle "ping" sound if available
                const alertSound = new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3");
                alertSound.volume = 0.5;
                alertSound.play().catch(() => { /* Browser blocked autoplay */ });
            }
        });
    }, (err) => {
        // âš ï¸ CATCHING PERMISSION OR INDEX ERRORS
        console.error("ðŸ”¥ BATTLE LISTENER ERROR:", err.code, err.message);
        if (err.code === 'permission-denied') {
            console.error("Security Rule Error: Ensure 'battle_invites' is readable by authenticated users.");
        }
    });
 },

  toggleVideoLike: async () => {
        // ðŸŒŸ FIX: We use state.clips and state.clipIndex for the Movie Page
        const video = state.clips[state.clipIndex];
        if (!video || !video.id) return;

        const myUid = state.currentUser.uid;
        const { doc, updateDoc, arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const videoRef = doc(db, "videos", video.id);
        
        // Safety check to ensure likes is an array
        if (!video.likes) video.likes = [];
        const isLiked = video.likes.includes(myUid);

        if (navigator.vibrate) navigator.vibrate(40);

        try {
            if (isLiked) {
                // UNLIKE: Remove your UID from Firebase and local memory
                await updateDoc(videoRef, { likes: arrayRemove(myUid) });
                video.likes = video.likes.filter(id => id !== myUid);
            } else {
                // LIKE: Add your UID to Firebase and local memory
                await updateDoc(videoRef, { likes: arrayUnion(myUid) });
                video.likes.push(myUid);

                // Small "Pop" animation on the side heart
                const heart = document.getElementById('movie-like-heart');
                if (heart) {
                    heart.style.transform = "scale(1.5)";
                    setTimeout(() => heart.style.transform = "scale(1)", 200);
                }
            }

            // Update UI Colors and Numbers immediately
            const heartIcon = document.getElementById('movie-like-heart');
            const countLabel = document.getElementById('movie-like-count');

            if (heartIcon) heartIcon.style.color = !isLiked ? "#ff4b7d" : "white";
            if (countLabel) countLabel.innerText = App.formatLikeCount(video.likes.length);

        } catch (e) { 
            console.error("Like Error:", e);
            App.showToast("Sync Error");
        }
    } ,
        handleVideoDoubleTap: (event) => {
        // 1. Trigger the actual Like logic
        const video = state.clips[state.clipIndex];
        if (!video.likes.includes(state.currentUser.uid)) {
            App.toggleVideoLike();
        }

        // 2. Create the Visual Heart Explosion
        const container = document.getElementById('movie-container');
        const heart = document.createElement('i');
        heart.className = "fa-solid fa-heart";
        
        // TikTok Styling
        heart.style.cssText = `
            position: absolute;
            color: white;
            font-size: 80px;
            opacity: 0.8;
            z-index: 100;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            text-shadow: 0 0 20px rgba(255, 75, 125, 0.5);
            animation: heartExplode 0.8s ease-out forwards;
            pointer-events: none;
        `;

        container.appendChild(heart);
        setTimeout(() => heart.remove(), 800);
    } ,
        prevMovie: () => {
        state.clipIndex--;
        // If we go past the first video, loop to the very last one
        if (state.clipIndex < 0) {
            state.clipIndex = state.clips.length - 1;
        }

        // Clean up video memory before switch
        const videoEl = document.getElementById('movie-player');
        if (videoEl) {
            videoEl.pause();
            videoEl.removeAttribute('src');
            videoEl.load();
        }

        App.renderMovie();
    } ,

                initMovieGestures: () => {
    const container = document.getElementById('movie-container');
    if (!container) return;

    let touchStartY = 0;

    // 1. Capture the start
    container.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
    }, { passive: true });

    // 2. Prevent browser from scrolling or bouncing
    container.addEventListener('touchmove', (e) => {
        if (e.cancelable) e.preventDefault();
        e.stopPropagation();
    }, { passive: false });

    // 3. Detect the direction on release
    container.addEventListener('touchend', (e) => {
        const touchEndY = e.changedTouches[0].clientY;
        const diff = touchStartY - touchEndY;
        const threshold = 50; 

        if (Math.abs(diff) > threshold) {
            if (diff > 0) {
                // Swiped UP -> Next
                App.nextMovie();
            } else {
                // Swiped DOWN -> Previous
                App.prevMovie();
            }
        }
    }, { passive: true });
    
    // 4. FIXED GESTURE LISTENER
    // We call toggleMoviePlayback directly so the music follows the video
    container.onclick = () => {
        const v = document.getElementById('movie-player');
        App.toggleMoviePlayback(v);
    };
 },

            openComments: async () => {
        const video = state.clips[state.clipIndex];
        document.getElementById('movie-comment-drawer').classList.add('open');
        app.loadVideoComments(video.id);
    } ,

    closeComments: () => {
        document.getElementById('movie-comment-drawer').classList.remove('open');
        if (state.activeCommentListener) {
            state.activeCommentListener(); // Stop listening to Firebase sync
        }
    } ,

    loadVideoComments: async (videoId) => {
        const list = document.getElementById('movie-comment-list');
        const { collection, query, orderBy, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const q = query(collection(db, "videos", videoId, "comments"), orderBy("timestamp", "desc"));
        
        state.activeCommentListener = onSnapshot(q, (snap) => {
            list.innerHTML = "";
            const count = snap.size;
            document.getElementById('comment-count-title').innerText = `${count} Comments`;
            
            // Update the count label on the movie page icon
            const countLabel = document.getElementById('movie-comment-count-label');
            if (countLabel) countLabel.innerText = count;

            if (count === 0) {
                list.innerHTML = `<div style="text-align:center; margin-top:50px; color:#999; font-size:13px;">No comments yet.</div>`;
                return;
            }

            snap.forEach(docSnap => {
                const c = docSnap.data();
                const isLiked = c.likes && c.likes.includes(state.currentUser.uid);
                const timeStr = app.getTimeAgo(c.timestamp);
                
                const div = document.createElement('div');
                div.className = "comment-item";
                div.innerHTML = `
                    <img src="${c.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="comment-avatar">
                    <div class="comment-content">
                        <div class="comment-user-name">${c.name}</div>
                        <div class="comment-text">${app.formatMessageText(c.text || "")}</div>
                        ${c.image ? `<img src="${c.image}" class="comment-image">` : ""}
                        <div class="comment-meta">
                            <span>${timeStr}</span>
                            <span onclick="app.replyComment('${docSnap.id}', '${c.name}')" style="cursor:pointer;">Reply</span>
                        </div>
                    </div>
                    <div class="comment-like-btn ${isLiked ? 'active' : ''}" onclick="app.toggleCommentLike('${docSnap.id}')">
                        <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i>
                        <div style="font-size:10px;">${c.likes ? c.likes.length : 0}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    } ,

    postComment: async () => {
        const video = state.clips[state.clipIndex];
        const input = document.getElementById('movie-comment-input');
        const text = input.value.trim();
        const img = state.tempCommentImage;

        if (!text && !img) return;

        const profile = DataManager.getProfile();
        const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        try {
            await addDoc(collection(db, "videos", video.id, "comments"), {
                uid: state.currentUser.uid,
                name: profile.name || "User",
                photo: profile.photo || "",
                text: text,
                image: img || null,
                timestamp: Date.now(),
                likes: [],
                replyTo: state.replyingToCommentId || null
            });

            // RESET UI & STATE
            input.value = "";
            state.tempCommentImage = null;
            if (document.getElementById('comment-img-preview-bar')) {
                document.getElementById('comment-img-preview-bar').style.display = 'none';
            }
            app.cancelCommentReply();
        } catch (e) {
            console.error("Post Error:", e);
            app.showToast("Failed to post comment");
        }
    } ,

    toggleCommentLike: async (commentId) => {
        const videoId = state.clips[state.clipIndex].id;
        const myUid = state.currentUser.uid;
        const { doc, getDoc, updateDoc, arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const ref = doc(db, "videos", videoId, "comments", commentId);
        
        try {
            const snap = await getDoc(ref);
            if (!snap.exists()) return;
            
            const likes = snap.data().likes || [];
            const isLiked = likes.includes(myUid);

            await updateDoc(ref, {
                likes: isLiked ? arrayRemove(myUid) : arrayUnion(myUid)
            });

            if (!isLiked && navigator.vibrate) navigator.vibrate(30);
        } catch (e) {
            console.error("Like Error:", e);
        }
    } ,

    handleCommentInput: (el) => {
        const val = el.value;
        const popover = document.getElementById('mention-popover');
        
        if (val.endsWith('@')) {
            const savedContacts = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
            if (savedContacts.length === 0) return;

            popover.style.display = 'block';
            popover.innerHTML = `<div style="padding:10px; font-size:11px; color:#999; border-bottom:1px solid #eee;">TAG CONTACTS</div>`;
            
            savedContacts.forEach(async (uid) => {
                const uSnap = await getDoc(doc(db, "users", uid));
                if (uSnap.exists()) {
                    const u = uSnap.data();
                    const item = document.createElement('div');
                    item.className = "mention-item";
                    item.innerHTML = `<img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" style="width:25px;height:25px;border-radius:50%;"> ${u.name}`;
                    item.onclick = () => {
                        el.value = el.value.slice(0, -1) + "@" + u.name.replace(/\s/g, '') + " ";
                        popover.style.display = 'none';
                        el.focus();
                    };
                    popover.appendChild(item);
                }
            });
        } else {
            popover.style.display = 'none';
        }
    } ,

    handleCommentImage: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.tempCommentImage = e.target.result;
                
                // Show the preview bar if you have one
                const previewBar = document.getElementById('comment-img-preview-bar');
                if (previewBar) {
                    previewBar.style.display = 'flex';
                    document.getElementById('comment-preview-target').src = e.target.result;
                } else {
                    app.showToast("Sticker ready to send");
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    } ,

    replyComment: (id, name) => {
        state.replyingToCommentId = id;
        const bar = document.getElementById('reply-context-bar');
        if (bar) {
            bar.style.display = 'block';
            document.getElementById('reply-user-name').innerText = name;
        }
        document.getElementById('movie-comment-input').focus();
    } ,

    cancelCommentReply: () => {
        state.replyingToCommentId = null;
        const bar = document.getElementById('reply-context-bar');
        if (bar) bar.style.display = 'none';
    } ,
        // --- ðŸŽ MOVIE GIFT SYSTEM ---
    
            toggleGiftDrawer: () => {
        const drawer = document.getElementById('gift-drawer-mini');
        const btn = document.getElementById('comment-gift-btn');
        
        if (drawer.style.display === 'grid') {
            drawer.style.display = 'none';
            btn.style.color = '#ffd700';
        } else {
            drawer.style.display = 'grid';
            btn.style.color = 'var(--primary)';
            app.renderMiniGifts(); // Calls the function below
        }
    } ,

    renderMiniGifts: () => {
        const container = document.getElementById('gift-drawer-mini');
        if (container.innerHTML !== "") return; // Prevents reloading 50 images every tap

        const baseUrl = "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis";
        
        // ðŸŒŸ FULL 50 GIFT MAPPING
        const gifts = [
            { n: "Beating Heart", c: "Smilies" }, { n: "Rocket", c: "Travel and Places" },
            { n: "Fire", c: "Travel and Places" }, { n: "Sparkles", c: "Activities" },
            { n: "Star", c: "Activities" }, { n: "Party Popper", c: "Activities" },
            { n: "Crown", c: "Objects" }, { n: "Gem Stone", c: "Objects" },
            { n: "Money Bag", c: "Objects" }, { n: "Diamond", c: "Objects" },
            { n: "Rose", c: "Animals and Nature" }, { n: "Unicorn", c: "Animals and Nature" },
            { n: "Alien", c: "Smilies" }, { n: "Robot", c: "Smilies" },
            { n: "Ghost", c: "Smilies" }, { n: "Skull", c: "Smilies" },
            { n: "Pizza", c: "Food and Drink" }, { n: "Burger", c: "Food and Drink" },
            { n: "Cake", c: "Food and Drink" }, { n: "Beer Mug", c: "Food and Drink" },
            { n: "Wine Glass", c: "Food and Drink" }, { n: "Trophy", c: "Activities" },
            { n: "Medal", c: "Activities" }, { n: "Guitar", c: "Objects" },
            { n: "Video Game", c: "Activities" }, { n: "Basketball", c: "Activities" },
            { n: "Football", c: "Activities" }, { n: "Boxing Glove", c: "Activities" },
            { n: "Magic Wand", c: "Objects" }, { n: "Balloon", c: "Activities" },
            { n: "Wrapped Gift", c: "Activities" }, { n: "Confetti Ball", c: "Activities" },
            { n: "Rainbow", c: "Travel and Places" }, { n: "Sun", c: "Travel and Places" },
            { n: "Moon", c: "Travel and Places" }, { n: "Lightning", c: "Travel and Places" },
            { n: "Crystal Ball", c: "Objects" }, { n: "Dove", c: "Animals and Nature" },
            { n: "Butterfly", c: "Animals and Nature" }, { n: "Cat Face", c: "Animals and Nature" },
            { n: "Dog Face", c: "Animals and Nature" }, { n: "Panda", c: "Animals and Nature" },
            { n: "Lion", c: "Animals and Nature" }, { n: "Dragon", c: "Animals and Nature" },
            { n: "Flying Saucer", c: "Travel and Places" }, { n: "Clover", c: "Animals and Nature" },
            { n: "Hourglass Done", c: "Objects" }, { n: "Heart with Ribbon", c: "Smilies" },
            { n: "Money-Mouth Face", c: "Smilies" }, { n: "Smiling Face with Sunglasses", c: "Smilies" }
        ];

        let html = "";
        gifts.forEach((gift, i) => {
            const price = (i + 1) * 5; // Price logic (5, 10, 15...)
            const finalUrl = `${baseUrl}/${encodeURIComponent(gift.c)}/${encodeURIComponent(gift.n)}.png`;

            html += `
                <div class="mini-gift-item" onclick="app.sendMovieGift('${gift.n}', ${price}, '${finalUrl}')">
                    <img src="${finalUrl}" onerror="this.src='https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Beating%20Heart.png'">
                    <div class="mini-gift-price">${price}</div>
                </div>`;
        });
        container.innerHTML = html;
    } ,

    sendMovieGift: async (giftName, price, giftUrl) => {
        const video = state.clips[state.clipIndex];
        const profile = DataManager.getProfile();
        const myUid = state.currentUser.uid;
        
        if ((profile.orbs || 0) < price) {
            alert("Not enough Orbs! Buy more in your Wallet.");
            return app.openWalletPage();
        }

        try {
            const { doc, updateDoc, increment, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // ðŸ’° Deduct Orbs and convert to USD earnings for the video creator
            const usdValue = price / 100;

            await updateDoc(doc(db, "users", myUid), { orbs: increment(-price) });
            await updateDoc(doc(db, "users", video.uid), { earnings: increment(usdValue) });

            // Post the gift as a comment
            await addDoc(collection(db, "videos", video.id, "comments"), {
                uid: myUid,
                name: profile.name || "User",
                photo: profile.photo || "",
                text: `Sent a ${giftName}! ðŸŽ`,
                image: giftUrl,
                timestamp: Date.now(),
                isGift: true
            });

            profile.orbs -= price;
            DataManager.saveProfile(profile);
            
            app.showToast(`âœ… Gifted ${giftName}!`);
            app.toggleGiftDrawer(); // Close the emoji pack

        } catch (e) {
            console.error("Gift failed:", e);
            app.showToast("Failed to send gift.");
        }
    } ,

    // Update closeComments to ensure gift drawer closes too
    closeComments: () => {
        document.getElementById('movie-comment-drawer').classList.remove('open');
        document.getElementById('gift-drawer-mini').style.display = 'none';
        document.getElementById('comment-gift-btn').style.color = '#ffd700';
        if (state.activeCommentListener) state.activeCommentListener(); 
    } ,
        closeProfilePlayer: () => {
        const videoEl = document.getElementById('movie-player');
        if (videoEl) videoEl.pause();
        
        // Return to the profile page
        App.goToPage('public-profile-page');
    } ,
                // --- PROFILE & ANALYTICS ---

    openMyProfilePage: async () => {
    // 1. Switch Page and Get Local Data
    App.goToPage('my-profile-page');
    const profile = DataManager.getProfile();
    const myUid = state.currentUser.uid;
    
    // 2. Target the unique Profile IDs
    const nameEl = document.getElementById('my-profile-name');
    const avatarEl = document.getElementById('my-profile-avatar');
    const bioEl = document.getElementById('my-profile-bio');
    const handleEl = document.getElementById('my-profile-handle');
    const emptyState = document.getElementById('my-empty-state');
    const grid = document.getElementById('my-video-grid');

    // 3. Set Profile Info Instantly from Memory
    if (profile) {
        if (nameEl) nameEl.innerText = profile.name || "User";
        if (avatarEl) avatarEl.src = profile.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
        if (bioEl) bioEl.innerText = profile.bio || "Available";
        if (handleEl) {
            const handle = (profile.name ? profile.name.replace(/\s/g, '').toLowerCase() : "user");
            handleEl.innerText = "@" + handle;
        }
        
        // Update Followers Count (Profile Visitors)
        const followersEl = document.getElementById('my-profile-followers');
        if (followersEl) {
            followersEl.innerText = profile.profileVisitors ? profile.profileVisitors.length : 0;
        }
    }

    // 4. Fetch Real-time Video Grid and Analytics
    try {
        const { getDocs, collection, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const vQuery = query(
            collection(db, "videos"), 
            where("ownerId", "==", myUid),
            orderBy("timestamp", "desc")
        );
        
        const vSnap = await getDocs(vQuery);

        let totalLikes = 0;

        if (grid) {
            grid.innerHTML = "";

            if (vSnap.empty) {
                // Show empty state if no videos found
                if (emptyState) emptyState.style.display = 'block';
            } else {
                if (emptyState) emptyState.style.display = 'none';

                vSnap.forEach(doc => {
                    const v = doc.data();
                    // Calculate total likes for analytics
                    totalLikes += (v.likes ? (Array.isArray(v.likes) ? v.likes.length : v.likes) : 0);
                    
                    // Render grid item (TikTok style)
                    const item = document.createElement('div');
                    item.className = "profile-video-item";
                    
                    // Note: #t=0.1 forces the browser to load a frame as a thumbnail
                    item.innerHTML = `
                        <video src="${v.videoUrl}#t=0.1" muted playsinline></video>
                        <div class="profile-video-stats">
                            <i class="fa-solid fa-play"></i> ${v.views || 0}
                        </div>`;
                    
                    // Optional: click to play video logic
                    item.onclick = () => {
                        state.clips = [v]; // Temporary focus
                        state.clipIndex = 0;
                        state.movieViewMode = 'profile';
                        App.goToPage('movie-page');
                        App.renderMovie();
                    };

                    grid.appendChild(item);
                });
            }
        }

        // 5. Update Total Likes Count
        const likesEl = document.getElementById('my-profile-likes');
        if (likesEl) {
            likesEl.innerText = App.formatLikeCount(totalLikes);
        }

    } catch (error) {
        console.error("Error loading profile videos:", error);
        // Fallback for Firestore Index building
        if (error.message.includes("index")) {
            console.warn("Firestore index is still building. Video sorting might be limited.");
        }
    }
 },

    

    incrementViewCount: async (videoId) => {
        if (!videoId) return;
        const { doc, updateDoc, increment, arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        try {
            // 1. Increment the view count on the video document
            await updateDoc(doc(db, "videos", videoId), { 
                views: increment(1) 
            });

            // 2. Track unique profile visitors
            if (state.clips && state.clips[state.clipIndex]) {
                const videoOwnerId = state.clips[state.clipIndex].ownerId;
                if (videoOwnerId !== state.currentUser.uid) {
                    await updateDoc(doc(db, "users", videoOwnerId), {
                        profileVisitors: arrayUnion(state.currentUser.uid)
                    });
                }
            }
        } catch (e) { 
            console.log("Analytics error:", e); 
        }
    },

    togglePostMenu: () => {
        const menu = document.getElementById('post-management-menu');
        if (menu) {
            menu.classList.toggle('active');
        }
    },

                                        downloadVideo: async () => {
        const video = state.clips[state.clipIndex];
        if (!video || !video.videoUrl) return App.showToast("Video source not found");

        app.togglePostMenu(); 

        // 1. Show the Pulsing Outro Screen
        const outro = document.getElementById('download-outro-overlay');
        if (outro) {
            outro.style.display = 'flex';
            outro.innerHTML = `
                <img src="https://cdn-icons-png.flaticon.com/512/4359/4359959.png" class="outro-logo" style="width:100px; height:100px; border-radius:20px; animation: pulse 1.5s infinite; box-shadow: 0 0 30px #ff4b7d;">
                <div class="outro-text" style="color: white; font-size: 24px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin-top: 25px;">Saving to Gallery...</div>

                <div class="outro-corner-brand" style="position: absolute; bottom: 40px; right: 30px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <img src="https://cdn-icons-png.flaticon.com/512/4359/4359959.png" style="width: 35px; height: 35px; border-radius: 8px;">
                    <span style="color: white; font-size: 10px; font-weight: bold; opacity: 0.7;">Global Connection</span>
                </div>
            `;
        }

        // ðŸŒŸ 2. HYBRID DOWNLOAD LOGIC (Web + Capacitor)
        const isNative = window.Capacitor && window.Capacitor.isNativePlatform();

        if (isNative) {
            // --- CAPACITOR NATIVE PATH ---
            try {
                // This will only run when you eventually build with Capacitor
                const { Filesystem, Directory } = await import('@capacitor/filesystem');
                
                await Filesystem.downloadFile({
                    url: video.videoUrl,
                    path: `GlobalConnect_${Date.now()}.mp4`,
                    directory: Directory.Documents // Saves to phone's Documents folder
                });
                
                App.showToast("âœ… Downloaded to Files");
            } catch (err) {
                console.error("Native download failed", err);
                App.showToast("Native save failed");
            }
        } else {
            // --- BROWSER WEB PATH (What you use now) ---
            const link = document.createElement('a');
            link.href = video.videoUrl;
            link.setAttribute('download', `GlobalConnect_${Date.now()}.mp4`);
            link.target = "_blank"; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 3. Finalize Visuals
        setTimeout(() => {
            if (outro) outro.style.display = 'none';
            if (!isNative) App.showToast("âœ… Check your Downloads");
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        }, 3000);
    },
            executeContactShare: async () => {
                if (state.groupParticipants.length === 0) return;

                const contactToShare = state.pendingContactToShare;
                if (!contactToShare) {
                        App.showToast("No contact selected to share");
                        return;
                }

                const cardLink = `${window.location.origin}/?user_card=${contactToShare.id}`;
                App.showToast(`Forwarding to ${state.groupParticipants.length} recipients...`);

                try {
                        for (const recipient of state.groupParticipants) {
                                // ðŸŒŸ Loop through each person selected and send the card
                                const originalChatId = state.currentChatId;
                                state.currentChatId = recipient.uid;
                                await App.sendMessage(cardLink);
                                state.currentChatId = originalChatId;
                        }

                        // Cleanup state after sending
                        state.isShareMode = false;
                        state.groupParticipants = [];
                        state.pendingContactToShare = null;

                        App.showToast("âœ… Contact Shared Successfully");
                        App.goToPage('chat-list-page');

                } catch (e) {
                        console.error("Share Execution Error:", e);
                        App.showToast("Failed to share contact");
                }
        },
        handleStatusInput: (el) => {
                const val = el.value.trim();
                const heartIcon = document.getElementById('status-heart-icon');
                
                if (val.length > 0) {
                        // Change to Send Arrow
                        heartIcon.className = "fa-solid fa-paper-plane";
                        heartIcon.style.color = "var(--primary)";
                        // Change the parent click action to send instead of like
                        heartIcon.parentElement.onclick = () => App.sendReply('text', val);
                } else {
                        // Change back to Heart
                        heartIcon.className = "fa-regular fa-heart";
                        heartIcon.style.color = "white";
                        heartIcon.parentElement.onclick = () => App.toggleStatusLove();
                }
        },
        jumpToStatus: async (statusId, userId) => {
                App.showToast("Opening status...");
                
                try {
                        const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                        
                        // 1. Get all active statuses for that user from the last 24h
                        const yesterday = Date.now() - (24 * 60 * 60 * 1000);
                        const q = query(
                                collection(db, "statuses"), 
                                where("uid", "==", userId), 
                                where("timestamp", ">", yesterday),
                                orderBy("timestamp", "asc")
                        );
                        
                        const snap = await getDocs(q);
                        if (snap.empty) {
                                App.showToast("This status has expired");
                                return;
                        }

                        // 2. Load the stories into the viewer state
                        state.activeStories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        
                        // 3. Find the index of the specific status Kelvin tapped on
                        const targetIndex = state.activeStories.findIndex(s => s.id === statusId);
                        state.storyIndex = targetIndex !== -1 ? targetIndex : 0;

                        // 4. Launch Viewer
                        App.goToPage('status-viewer-page');
                        App.renderStatusSlide();

                } catch (e) {
                        console.error("Jump Error:", e);
                        App.showToast("Could not load status");
                }
        },
        toggleStatusMenu: () => {
    const menu = document.getElementById('status-viewer-menu');
    const isVisible = menu.classList.contains('active');
    const s = state.activeStories[state.storyIndex];
    const isOwner = s.uid === state.currentUser.uid;

    if (!isVisible) {
        // ðŸŒŸ DYNAMIC MENU CONTENT ðŸŒŸ
        // If Kelvin is the owner, show management tools. If not, show interaction tools.
        if (isOwner) {
            menu.innerHTML = `
                <div class="menu-item" onclick="App.forwardStatus('${s.id}')">
                    <i class="fa-solid fa-share"></i> Forward
                </div>
                <div class="menu-item" onclick="App.deleteStatus('${s.id}')" style="color: #ff4757;">
                    <i class="fa-solid fa-trash"></i> Delete
                </div>
            `;
        } else {
            menu.innerHTML = `
                <div class="menu-item" onclick="App.handleStatusMenuAction('message')">Message</div>
                <div class="menu-item" onclick="App.handleStatusMenuAction('voice')">Voice call</div>
                <div class="menu-item" onclick="App.handleStatusMenuAction('video')">Video call</div>
                <div class="menu-item" onclick="App.handleStatusMenuAction('info')">View contact</div>
                <div class="menu-item" onclick="App.handleStatusMenuAction('report')" style="color: #ff4757;">Report</div>
            `;
        }

        menu.classList.add('active');
        // Pause status while menu is open
        state.isStatusPaused = true;
        clearTimeout(state.storyTimer);
        const fill = document.getElementById(`fill-${state.storyIndex}`);
        if (fill) fill.style.transition = "none";
    } else {
        menu.classList.remove('active');
        // Resume status playback
        App.startStatusTimer(true);
       }
   },


        handleStatusMenuAction: (action) => {
                const s = state.activeStories[state.storyIndex];
                document.getElementById('status-viewer-menu').classList.remove('active');

                if (action === 'message') {
                        App.openChat(s.uid, s.name, s.photo);
                } 
                else if (action === 'voice') {
                        webrtc.startCall(s.uid, false);
                } 
                else if (action === 'video') {
                        webrtc.startCall(s.uid, true);
                } 
                else if (action === 'info') {
                        state.currentChatPartner = { id: s.uid, name: s.name, avatar: s.photo };
                        App.viewContactInfo();
                } 
                else if (action === 'report') {
                        document.getElementById('status-report-modal').style.display = 'flex';
                }
        },

        submitStatusReport: async () => {
                const s = state.activeStories[state.storyIndex];
                const shouldBlock = document.getElementById('report-block-user').checked;
                
                App.showToast("Sending report...");

                try {
                        const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                        
                        // 1. Send report to Firebase
                        await addDoc(collection(db, "reports"), {
                                type: "status_report",
                                reporterId: state.currentUser.uid,
                                reportedUserId: s.uid,
                                statusId: s.id,
                                statusContent: s.image,
                                timestamp: Date.now()
                        });

                        // 2. Handle Blocking logic if checked
                        if (shouldBlock) {
                                await App.blockUser(s.uid);
                        }

                        document.getElementById('status-report-modal').style.display = 'none';
                        App.showToast("Report sent");
                        App.closeStatusViewer(); // Close viewer after reporting
                        
                } catch (e) {
                        console.error("Report failed", e);
                        App.showToast("Failed to send report");
                }
        },
        openBlockModal: () => {
                const partner = state.currentChatPartner;
                if (!partner) return;
                document.getElementById('block-modal-title').innerText = `Block ${partner.name}?`;
                document.getElementById('user-block-modal').style.display = 'flex';
        },

        closeBlockModal: () => {
                document.getElementById('user-block-modal').style.display = 'none';
        },

        executeUserBlock: async () => {
        const partnerId = state.currentChatPartner.id;
        const shouldReport = document.getElementById('block-report-check').checked;
        
        App.showToast("Blocking...");
        App.closeBlockModal();

        try {
                const { doc, updateDoc, arrayUnion, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // 1. Update Database
                await updateDoc(doc(db, "users", state.currentUser.uid), {
                        blocked: arrayUnion(partnerId)
                });

                if (shouldReport) {
                        await addDoc(collection(db, "reports"), { 
                            type: "user_report", 
                            reporter: state.currentUser.uid, 
                            target: partnerId, 
                            timestamp: Date.now() 
                        });
                }

                // 2. ðŸŒŸ LOCAL STATE UPDATE: Add to local list so UI knows it's blocked
                if (!state.blockedUsers) state.blockedUsers = [];
                if (!state.blockedUsers.includes(partnerId)) state.blockedUsers.push(partnerId);

                // 3. Refresh the UI elements
                App.refreshChatFooter();
                App.updateInfoPageButtons(partnerId);
                App.showToast("Contact blocked");
          } catch (e) { 
                console.error(e); 
                App.showToast("Block failed");
          }
    },


        // --- UPDATED RENDER FOOTER LOGIC ---
        refreshChatFooter: () => {
        const inputBar = document.getElementById('chat-input-bar');
        const blockedFooter = document.getElementById('blocked-chat-footer');
        const partnerId = state.currentChatId;

        if (!inputBar || !blockedFooter) return;

        const isBlocked = state.blockedUsers && state.blockedUsers.includes(partnerId);

        if (isBlocked) {
                inputBar.style.display = 'none';
                blockedFooter.style.display = 'flex';
        } else {
                inputBar.style.display = 'flex';
                blockedFooter.style.display = 'none';
          }
    },
        updateInfoPageButtons: (targetId) => {
        const isBlocked = state.blockedUsers && state.blockedUsers.includes(targetId);
        const blockBtnRow = document.querySelector('#user-info-page .list-item[onclick*="BlockModal"]');
        
        if (blockBtnRow) {
                if (isBlocked) {
                        blockBtnRow.style.color = "#00a884"; // Green for Unblock
                        blockBtnRow.innerHTML = `<i class="fa-solid fa-ban" style="width: 30px; text-align: center;"></i><span>Unblock User</span>`;
                        blockBtnRow.onclick = () => App.unblockUser(targetId);
                } else {
                        blockBtnRow.style.color = "#d32f2f"; // Red for Block
                        blockBtnRow.innerHTML = `<i class="fa-solid fa-ban" style="width: 30px; text-align: center;"></i><span>Block User</span>`;
                        blockBtnRow.onclick = () => App.openBlockModal();
                }
          }
    },
    clearChatHistory: async () => {
    const chatId = state.currentChatId;
    if (!chatId) return;

    if (confirm("Are you sure you want to delete all messages in this chat? This cannot be undone.")) {
        // 1. Clear Local Storage for this specific chat
        localStorage.removeItem(`chat_${chatId}`);
        
        // 2. Update the main chat list to remove the preview text
        let chats = DataManager.getChatList();
        const index = chats.findIndex(c => c.id === chatId);
        if (index > -1) {
            chats[index].lastMsg = "Messages cleared";
            localStorage.setItem('wa_chats_array', JSON.stringify(chats));
        }

        // 3. Refresh UI
        App.renderMessages(chatId);
        App.renderChatList();
        App.showToast("Chat history cleared");
       }
   },
   deleteSelectedChats: () => {
    if (state.selectedChats.size === 0) return;

    if (confirm(`Delete ${state.selectedChats.size} selected chat(s)?`)) {
        let chats = DataManager.getChatList();
        
        // Convert Set to Array and filter out selected IDs
        const selectedIds = Array.from(state.selectedChats);
        const updatedChats = chats.filter(c => !selectedIds.includes(c.id));

        // Remove the actual message history from storage for each
        selectedIds.forEach(id => {
            localStorage.removeItem(`chat_${id}`);
        });

        // Save updated list and exit selection mode
        localStorage.setItem('wa_chats_array', JSON.stringify(updatedChats));
        App.exitSelectionMode();
        App.showToast("Chats deleted");
       }
   },
   openViewerList: async (statusId) => {
    const listContainer = document.getElementById('status-viewers-list');
    const countLabel = document.getElementById('viewer-count-total');
    
    document.getElementById('modal-status-viewers').style.display = 'flex';
    listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:gray;"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';

    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const statusSnap = await getDoc(doc(db, "statuses", statusId));
        
        if (!statusSnap.exists()) return;
        const statusData = statusSnap.data();
        const viewerIds = statusData.views || [];

        countLabel.innerText = viewerIds.length;
        listContainer.innerHTML = "";

        if (viewerIds.length === 0) {
            listContainer.innerHTML = '<div style="padding:40px; text-align:center; color:gray;">No views yet</div>';
            return;
           }

        for (const uid of viewerIds) {
            const userSnap = await getDoc(doc(db, "users", uid));
            if (userSnap.exists()) {
                const u = userSnap.data();
                const div = document.createElement('div');
                div.className = "list-item";
                div.style.borderBottom = "none";
                div.innerHTML = `
                    <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="list-avatar" style="width:40px; height:40px;">
                    <div style="flex:1;">
                        <div style="font-weight: 500; color: #111;">${u.name}</div>
                        <div style="font-size: 12px; color: #8696a0;">Just now</div>
                    </div>
                `;
                listContainer.appendChild(div);
               }
           }
    } catch (e) {
        console.error("Error loading viewers:", e);
        listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:red;">Connection error</div>';
       }
   },
   viewMyOwnStatus: async (statusId) => {
    const myUid = state.currentUser.uid;
    const yesterday = Date.now() - (24 * 60 * 60 * 1000);
    const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    // 1. Fetch all your own active statuses
    const q = query(collection(db, "statuses"), where("uid", "==", myUid), where("timestamp", ">", yesterday), orderBy("timestamp", "asc"));
    const snap = await getDocs(q);
    
    if (snap.empty) return;
    
    // 2. Load the stack into the viewer
    state.activeStories = snap.docs.map(d => ({id: d.id, ...d.data()}));
    
    // 3. Find the index of the specific status Kelvin clicked on
    const targetIndex = state.activeStories.findIndex(s => s.id === statusId);
    state.storyIndex = targetIndex !== -1 ? targetIndex : 0;

    // 4. Launch the viewer page
    App.goToPage('status-viewer-page');
    App.renderStatusSlide();
   },
   // --- ðŸ” CHAT LIST SEARCH & FILTER LOGIC ---

toggleChatSearch: () => {
    const title = document.getElementById('chat-title-text');
    const searchCont = document.getElementById('chat-search-container');
    const input = document.getElementById('chat-user-search-input');
    const trigger = document.getElementById('chat-search-trigger');

    if (searchCont.style.display === 'none') {
        // Switch to Search Mode
        title.style.display = 'none';
        searchCont.style.display = 'block';
        trigger.className = "fa-solid fa-xmark"; // Change glass to X
        input.focus();
    } else {
        // Exit Search Mode
        title.style.display = 'block';
        searchCont.style.display = 'none';
        trigger.className = "fa-solid fa-magnifying-glass";
        input.value = "";
        app.renderChatList(); // Reset list to show everyone
    }
},

filterChatList: (query) => {
    const term = query.toLowerCase().trim();
    const allChats = DataManager.getChatList(); // Gets chats from local phone memory
    
    // Filter the array by user name
    const filtered = allChats.filter(chat => 
        chat.name.toLowerCase().includes(term)
    );

    // Render the new list
    app.renderFilteredChatList(filtered);
},

renderFilteredChatList: (chats) => {
    const container = document.getElementById('chat-list-container');
    if (!container) return;
    container.innerHTML = "";

    if (chats.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:gray;">No users found</div>`;
        return;
    }

    // This uses your existing chat list design
    chats.forEach(data => {
        const div = document.createElement('div');
        div.className = "list-item";
        div.style.cssText = "display:flex; align-items:center; gap:15px; cursor:pointer; padding: 12px 15px; border-bottom: 1px solid #f0f0f0;";
        div.onclick = () => app.openChat(data.id, data.name, data.avatar);
        
        div.innerHTML = `
            <img src="${data.avatar}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
            <div style="flex: 1;"> 
                <h4 style="margin:0; font-size:16px;">${data.name}</h4>
                <p style="margin:0; color:gray; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${data.lastMsg}</p>
            </div>`;
        container.appendChild(div);
      });
   },
   // --- ðŸ›¡ï¸ MAX PRIVACY OTP ENGINE ---

initEmailJS: () => {
    // Initializing with your Public Key
    emailjs.init("a5kAk-ktmTEhKCo54");
},

            sendVerificationEmail: async (email) => {
        if (!email || typeof email !== 'string' || !email.includes('@')) return false;

        const cleanEmail = email.trim();
        const otp = Math.floor(100000 + Math.random() * 900000);
        state.generatedOTP = otp;

        // ðŸ”„ Loop through all 3 accounts until one works
        for (let i = 0; i < emailConfig.length; i++) {
            const currentAcc = emailConfig[i];
            
            try {
                console.log(`ðŸ“¡ Attempting Email via Server ${i + 1}...`);
                
                // Initialize the specific Public Key for this account
                emailjs.init(currentAcc.userId);

                await emailjs.send(currentAcc.service, currentAcc.template, {
                    to_email: cleanEmail,   // Variable in your Dashboard
                    otp_code: otp,          // Variable in your Dashboard
                    name: "Global Connect User"
                });

                console.log(`âœ… Success! Server ${i + 1} sent the OTP.`);
                App.startOTPCountdown();
                return true; // Stop loop and exit function

            } catch (error) {
                console.warn(`âš ï¸ Server ${i + 1} failed (Limit reached or config error). Trying next...`);
                
                // If this was the 3rd and final account, show the error toast
                if (i === emailConfig.length - 1) {
                    App.showToast("All verification servers are busy. Try again later.");
                }
            }
        }
        return false;
    },

startOTPCountdown: () => {
    let timeLeft = 120; // 2 Minutes
    const timerDisplay = document.getElementById('otp-countdown');
    const resendBtn = document.getElementById('resend-btn');
    const timerCont = document.getElementById('otp-timer-container');
    
    if (resendBtn) resendBtn.style.display = 'none';
    if (timerCont) timerCont.style.display = 'block';

    if (state.otpTimer) clearInterval(state.otpTimer);

    state.otpTimer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        if (timeLeft <= 0) {
            clearInterval(state.otpTimer);
            if (resendBtn) {
                resendBtn.style.display = 'block';
                resendBtn.style.color = 'var(--primary)';
            }
            if (timerCont) timerCont.style.display = 'none';
        }
        timeLeft--;
    }, 1000);
},

verifyEmailOTP: async () => {
    const input = document.getElementById('otp-input').value;
    
    if (input == state.generatedOTP) {
        if (state.otpTimer) clearInterval(state.otpTimer);
        
        // ðŸŒŸ VITAL: Save verified status to phone memory so it persists after reload
        localStorage.setItem('gc_otp_verified', 'true');
        
        App.showToast("Identity Verified âœ…");
        
        // ðŸš€ SMART REDIRECT LOGIC
        try {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const userRef = doc(db, "users", state.currentUser.uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                // User is already registered -> Go to main app
                App.goToPage('chat-list-page');
                App.renderChatList();
                
                // ðŸ”„ Slight delay then reload to trigger the verified logic in your auth listener
                setTimeout(() => location.reload(), 500);
            } else {
                // New User -> Go to Onboarding
                App.goToPage('onboard-1');
            }
        } catch (e) {
            console.error("Verification sync error", e);
            App.goToPage('onboard-1'); // Fallback to onboarding
        }
    } else {
        App.showToast("Incorrect code. Try again.");
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]); // Error vibration
        document.getElementById('otp-input').value = ""; // Clear for retry
      }
  },
      // --- ðŸšª SECURE LOGOUT LOGIC ---
    logout: async () => {
        if (!confirm("Are you sure you want to log out?")) return;

        try {
            // 1. Log out of Firebase
            await auth.signOut();

            // 2. ðŸŒŸ VITAL: Remove the permanent verification flag ðŸŒŸ
            localStorage.removeItem('gc_otp_verified');

            // 3. Optional: Clear the generated OTP from memory
            state.generatedOTP = null;

            App.showToast("Logged out successfully");

            // 4. Reload the app to return to the landing page
            location.reload(); 
        } catch (e) {
            console.error("Logout Error:", e);
            App.showToast("Logout failed. Try again.");
        }
    },
        // --- ðŸ” ACCOUNT MANAGEMENT SYSTEM ---

    openMyAccountDetail: () => {
        document.getElementById('acc-display-email').innerText = state.currentUser.email;
        App.goToPage('my-account-page');
    },

    initSecurityChange: async (action) => {
        state.pendingAccountAction = action; // 'email' or 'password'
        App.showToast("Security code sending...");
        
        // Use your existing 3-account failover to send the code
        const sent = await App.sendVerificationEmail(state.currentUser.email);
        if (sent) {
            document.getElementById('acc-otp-input').value = "";
            App.goToPage('account-security-otp-page');
        }
    },

    verifyAccountOTP: () => {
        const input = document.getElementById('acc-otp-input').value;
        if (input == state.generatedOTP) {
            // Success! Reveal the update page
            const action = state.pendingAccountAction;
            document.getElementById('update-page-title').innerText = action === 'email' ? "Change Email" : "Change Password";
            document.getElementById('update-page-desc').innerText = action === 'email' ? "Enter your new email address." : "Enter your new secure password.";
            
            const inputField = document.getElementById('acc-new-value-input');
            inputField.value = "";
            inputField.type = action === 'email' ? "email" : "password";
            inputField.placeholder = action === 'email' ? "new@email.com" : "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢";

            document.getElementById('acc-update-final-btn').onclick = () => App.executeAccountUpdate();
            
            App.goToPage('account-update-input-page');
        } else {
            App.showToast("Invalid security code");
            document.getElementById('acc-otp-input').value = "";
        }
    },

        executeAccountUpdate: async () => {
        const newValue = document.getElementById('acc-new-value-input').value.trim();
        if(!newValue) return alert("Please enter a value");

        const action = state.pendingAccountAction;
        const btn = document.getElementById('acc-update-final-btn');
        btn.innerText = "Processing...";

        try {
            // ðŸŒŸ Use verifyBeforeUpdateEmail for a professional verification flow
            const { verifyBeforeUpdateEmail, updatePassword } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");

            if (action === 'email') {
                // ðŸ›¡ï¸ Sends a link to the NEW email. Change only completes after they click it.
                await verifyBeforeUpdateEmail(state.currentUser, newValue);
                App.showToast("Verification link sent to new email!");
                alert("Please check your NEW email inbox and click the link to confirm the change.");
                App.goToPage('settings-page'); 
            } else {
                await updatePassword(state.currentUser, newValue);
                App.showToast("Password updated successfully");
                App.openMyAccountDetail();
            }

            btn.innerText = "Save Changes";
        } catch (e) {
            console.error(e);
            if(e.code === 'auth/requires-recent-login') {
                alert("Security timeout. Please log out and back in to change this.");
                App.logout();
            } else {
                alert("Update failed: " + e.message);
            }
            btn.innerText = "Save Changes";
        }
    },
        // --- ðŸ“± DEVICE & SESSION MANAGEMENT ---

        // --- ðŸ›¡ï¸ SECURITY & SESSION ENGINE ---

    trackSession: async () => {
        const user = state.currentUser;
        if (!user) return;

        // 1. Identify the device name
        const ua = navigator.userAgent;
        let deviceName = "Web Browser";
        if (ua.includes("Android")) deviceName = "Android Device";
        else if (ua.includes("iPhone")) deviceName = "iPhone";
        else if (ua.includes("Windows")) deviceName = "Windows PC";

        // 2. Generate a unique ID for THIS specific login session
        const sessionId = "sess_" + Date.now();
        localStorage.setItem('current_session_id', sessionId);

        const sessionData = {
            id: sessionId,
            name: deviceName,
            lastActive: Date.now(),
            platform: navigator.platform,
            isCurrent: true
        };

        try {
            const { doc, setDoc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // 3. Save session to Firestore so the Device Page can see it
            // Path: users/{Kelvin_ID}/sessions/{session_ID}
            await setDoc(doc(db, "users", user.uid, "sessions", sessionId), sessionData);

            // 4. Trigger the Security Alert DM
            App.sendSecurityAlert(deviceName);

            // 5. ðŸ›‘ REMOTE LOGOUT LISTENER: 
            // If you delete this session from another phone, this device kicks you out.
            onSnapshot(doc(db, "users", user.uid, "sessions", sessionId), (snap) => {
                if (!snap.exists()) {
                    alert("Your session has been terminated by the account owner.");
                    App.logout();
                }
            });
        } catch (e) { console.error("Session Tracking Error:", e); }
    },

        sendSecurityAlert: async (deviceName) => {
        const securityId = "global_connect_security"; // The "Official" Sender
        const myUid = state.currentUser.uid;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const date = new Date().toLocaleDateString();

        const alertText = `ðŸš¨ *New Login Detected*\n\nYour account was just logged into from a new device.\n\n*Device:* ${deviceName}\n*Time:* ${time}\n*Date:* ${date}\n\nIf this was not you, logout the device immediately.`;

        try {
            const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // ðŸŒŸ THE FIX: senderId is the Bot, receiverId is YOU
            const msgData = {
                text: alertText,
                senderId: securityId, 
                receiverId: myUid,
                timestamp: Date.now(),
                time: time,
                type: 'security_alert',
                status: 'delivered',
                isBotMsg: true
            };

            // Save to Firestore
            await addDoc(collection(db, "messages"), msgData);
            
            // Update local chat list so it shows up at the top
            DataManager.updateChatList(securityId, msgData, "Global Connect Security", "https://cdn-icons-png.flaticon.com/512/4359/4359959.png");
            
        } catch (e) { console.error("Alert failed:", e); }
    },

            openDevicesPage: async () => {
        // ðŸŒŸ 1. Ensure this device is tracked BEFORE showing the list
        // This avoids having to logout/login to see the current phone
        await App.trackSession();

        App.goToPage('devices-management-page');
        const container = document.getElementById('device-list-container');
        container.innerHTML = '<div style="padding:40px; text-align:center;"><i class="fa-solid fa-spinner fa-spin"></i></div>';

        const { collection, onSnapshot, query } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const q = query(collection(db, "users", state.currentUser.uid, "sessions"));
        
        onSnapshot(q, (snap) => {
            container.innerHTML = "";
            const currentSess = localStorage.getItem('current_session_id');

            if (snap.empty) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:gray;">No active sessions.</div>';
                return;
            }

            snap.forEach(docSnap => {
                const d = docSnap.data();
                const isCurrent = d.id === currentSess;
                const icon = d.name.includes("PC") ? "fa-laptop" : "fa-mobile-screen";

                const div = document.createElement('div');
                div.className = "list-item";
                div.style.padding = "15px";
                div.style.borderBottom = "1px solid #f8f9fa";
                div.onclick = () => App.promptDeviceLogout(d);
                div.innerHTML = `
                    <i class="fa-solid ${icon}" style="font-size: 20px; width: 40px; color: #54656f;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111;">${d.name}</div>
                        <div style="font-size: 12px; color: ${isCurrent ? '#00a884' : '#888'};">
                            ${isCurrent ? 'Current Device' : 'Active'}
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
                `;
                container.appendChild(div);
            });
        });
    },

    promptDeviceLogout: (device) => {
        // Prevent Kelvin from accidentally logging out the phone he is currently using
        if (device.id === localStorage.getItem('current_session_id')) {
            return App.showToast("To logout this device, use the main Log Out button.");
        }
        
        document.getElementById('logout-device-name').innerText = device.name;
        document.getElementById('logout-device-meta').innerText = "Logged in: " + new Date().toLocaleDateString();
        document.getElementById('logout-device-icon').className = device.name.includes("PC") ? "fa-solid fa-laptop" : "fa-solid fa-mobile-screen";
        
        document.getElementById('confirm-device-logout-btn').onclick = async () => {
            const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            await deleteDoc(doc(db, "users", state.currentUser.uid, "sessions", device.id));
            App.closeModal('modal-device-logout');
            App.openDevicesPage();
            App.showToast("Device Logged Out");
        };
        
        document.getElementById('modal-device-logout').style.display = 'flex';
    },
        // --- ðŸ‘¥ MULTI-ACCOUNT ENGINE ---

    openMultiAccountPicker: () => {
        App.goToPage('multi-account-page');
        App.renderLinkedAccounts();
    },

    renderLinkedAccounts: () => {
        const container = document.getElementById('linked-accounts-list');
        const accounts = JSON.parse(localStorage.getItem('gc_linked_accounts') || '[]');
        const currentUid = state.currentUser.uid;
        
        container.innerHTML = "";

        // 1. Show the "Active" Account first
        const profile = DataManager.getProfile();
        App.buildAccountRow(profile, true, container);

        // 2. Show the "Stashed" Accounts
        accounts.forEach(acc => {
            if (acc.uid !== currentUid) {
                App.buildAccountRow(acc, false, container);
            }
        });

        // 3. Limit to 2 accounts total
        const addRow = document.getElementById('add-account-row');
        if (accounts.length >= 2 || (accounts.length === 1 && accounts[0].uid !== currentUid)) {
            addRow.style.display = 'none';
        } else {
            addRow.style.display = 'flex';
        }
    },

    buildAccountRow: (acc, isActive, container) => {
        const div = document.createElement('div');
        div.className = "list-item";
        div.style.padding = "15px";
        div.onclick = () => isActive ? null : App.switchAccount(acc.uid);
        
        div.innerHTML = `
            <div style="position: relative;">
                <img src="${acc.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" 
                     style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 15px;">
                ${isActive ? '<div style="position: absolute; bottom: 0; right: 12px; width: 14px; height: 14px; background: #00C853; border-radius: 50%; border: 2px solid white;"></div>' : ''}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #111;">${acc.name}</div>
                <div style="font-size: 12px; color: ${isActive ? '#00a884' : '#666'};">
                    ${isActive ? 'Active now' : 'Tap to switch'}
                </div>
            </div>
            ${isActive ? '<i class="fa-solid fa-circle-check" style="color: #008069;"></i>' : ''}
        `;
        container.appendChild(div);
    },

    startNewAccountAuth: async () => {
        // Save current user to stash before leaving
        App.stashCurrentAccount();
        
        // Log out of Firebase to allow new login
        const { getAuth, signOut } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
        await signOut(auth);
        
        // Clear current local profile
        localStorage.removeItem('user_profile');
        localStorage.removeItem('gc_otp_verified');
        
        App.showToast("Add new account...");
        location.reload(); // Returns to landing page
    },

    stashCurrentAccount: () => {
        const profile = DataManager.getProfile();
        if (!profile || !profile.uid) return;

        let accounts = JSON.parse(localStorage.getItem('gc_linked_accounts') || '[]');
        const exists = accounts.find(a => a.uid === profile.uid);
        
        if (!exists) {
            accounts.push(profile);
            localStorage.setItem('gc_linked_accounts', JSON.stringify(accounts));
        }
    },

        // --- ðŸ‘¥ UPDATED MULTI-ACCOUNT SWITCHER ---
    switchAccount: async (targetUid) => {
        App.showToast("Switching...");

        // 1. Get the account data from your stash
        const accounts = JSON.parse(localStorage.getItem('gc_linked_accounts') || '[]');
        const target = accounts.find(a => a.uid === targetUid);

        if (target) {
            // 2. Set the "Switching Intent" so the app doesn't reset on reload
            localStorage.setItem('gc_switch_intent', 'true');
            localStorage.setItem('gc_target_email', target.email);

            // 3. Sign out of current Firebase session
            const { signOut } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
            await signOut(auth);

            // 4. Force reload to the Landing Page
            location.reload();
        }
    },
        renderAccountPicker: () => {
        const targetEmail = localStorage.getItem('gc_target_email');
        if (!targetEmail) return;

        const landingBox = document.querySelector('#landing-page .welcome-box');
        
        // Add a "Continue as..." button specifically for the switch
        const switchBtn = document.createElement('button');
        switchBtn.className = "btn btn-primary";
        switchBtn.style.background = "#5865F2"; // Discord Blurple for distinction
        switchBtn.innerHTML = `<i class="fa-solid fa-user-check"></i> Continue as ${targetEmail.split('@')[0]}`;
        
        switchBtn.onclick = () => {
            // Pre-fill the login form for them
            App.goToPage('auth-page');
            document.getElementById('email-input').value = targetEmail;
            App.showToast("Enter password to finish switch");
            
            // Clear the intent now that they are logging in
            localStorage.removeItem('gc_switch_intent');
        };

        // Insert it above the "Get Started" button
        landingBox.insertBefore(switchBtn, landingBox.querySelector('.btn-primary'));
    },
           // --- ðŸ“± REAL SYSTEM TONE PICKER ---
    triggerSystemTonePicker: async (type) => {
        state.activeToneSelectionType = type;

        // Check if we are running as a Native App (Android/iOS)
        const isNative = window.Capacitor && window.Capacitor.isNativePlatform();

        if (isNative) {
            try {
                // This triggers the ACTUAL Android/iOS Ringtone List
                const { NativeRingtonePicker } = await import('capacitor-ringtone-picker');
                const result = await NativeRingtonePicker.open({
                    type: type === 'call' ? 'ringtone' : 'notification',
                    title: 'Select Tone',
                });

                if (result && result.uri) {
                    // Update UI with the System Name (e.g., "Over the Horizon")
                    document.getElementById(`disp-${type}-tone-label`).innerText = result.name;
                    localStorage.setItem(`system_${type}_tone_uri`, result.uri);
                    App.showToast("System tone saved");
                }
            } catch (err) {
                console.error("Native Picker Error:", err);
                // Fallback to file picker if plugin fails
                document.getElementById('hidden-tone-input').click();
            }
        } else {
            // ðŸŒ WEB FALLBACK: If Kelvin is testing in Chrome/Safari
            App.showToast("Opening File Explorer (System Tones require APK)");
            document.getElementById('hidden-tone-input').click();
        }
    },
    // Helper to check status state for a user
getStatusState: (uid) => {
    // 1. Get all active statuses from the global state
    // Note: Make sure state.activeStoriesGlobal is updated whenever you load the stories rail
    const userStatuses = state.activeStoriesGlobal?.filter(s => s.uid === uid) || [];
    
    // If the user has no active posts in the last 24h, show no ring
    if (userStatuses.length === 0) return 'none';

    // 2. Retrieve the IDs of statuses Kelvin has already clicked on from local memory
    const viewedIds = JSON.parse(localStorage.getItem('viewed_status_ids') || '[]');
    
    // 3. If even one status ID from this user is NOT in the viewed list, the ring stays green
    const hasUnread = userStatuses.some(s => !viewedIds.includes(s.id));
    
    return hasUnread ? 'unread' : 'viewed';
    },
    // --- ðŸ“¥ REPLY MANAGEMENT SYSTEM ---

initiateReply: (msg) => {
    // 1. Trigger subtle haptic feedback for the swipe/action
    if (navigator.vibrate) navigator.vibrate(30); 
    
    // 2. Store the reply context in the global state
    state.replyingTo = {
        id: msg.id,
        // Fallback text if the message is media (image/audio)
        text: msg.text || (msg.type === 'image' ? 'ðŸ“· Photo' : 'ðŸŽ¤ Voice Note'),
        senderName: msg.senderName || "User"
    };

    // 3. Update the UI Preview Bar elements
    const bar = document.getElementById('reply-preview-bar');
    const nameLabel = document.getElementById('reply-to-name');
    const textSnippet = document.getElementById('reply-to-text');

    if (nameLabel) nameLabel.innerText = state.replyingTo.senderName;
    if (textSnippet) textSnippet.innerText = state.replyingTo.text;
    
    // 4. Reveal the bar and focus the keyboard for Kelvin
    if (bar) bar.style.display = 'block';
    const input = document.getElementById('msg-input');
    if (input) input.focus();
},

cancelReply: () => {
    // 1. Wipe the reply context from memory
    state.replyingTo = null;

    // 2. Hide the preview bar from the screen
    const bar = document.getElementById('reply-preview-bar');
    if (bar) bar.style.display = 'none';
     },
     // --- ðŸ” STATUS PRIVACY LOGIC ---

openStatusPrivacy: async () => {
    App.goToPage('status-privacy-page');
    const profile = DataManager.getProfile();
    const p = profile.privacy || {};
    const blacklist = p.statusBlacklist || [];

    // Reset visual checks to ensure a clean state
    document.getElementById('status-check-all').classList.add('hidden');
    document.getElementById('status-check-except').classList.add('hidden');

    if (blacklist.length > 0) {
        document.getElementById('status-check-except').classList.remove('hidden');
        document.getElementById('status-exclude-count').innerText = `${blacklist.length} contacts excluded`;
    } else {
        document.getElementById('status-check-all').classList.remove('hidden');
        document.getElementById('status-exclude-count').innerText = "None excluded";
    }
},

setStatusPrivacy: async (type) => {
    if (type === 'all') {
        const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await updateDoc(doc(db, "users", state.currentUser.uid), {
            "privacy.statusBlacklist": [] // Empty the mute list to allow all contacts
        });
        
        // Sync local memory
        const profile = DataManager.getProfile();
        if(!profile.privacy) profile.privacy = {};
        profile.privacy.statusBlacklist = [];
        DataManager.saveProfile(profile);

        App.showToast("Privacy updated: My contacts");
        App.openStatusPrivacy(); // Refresh the UI view
    }
},

openStatusExclusionPicker: async () => {
    App.goToPage('status-exclusion-picker');
    const container = document.getElementById('exclusion-list-container');
    container.innerHTML = '<div style="padding:20px;text-align:center;">Loading contacts...</div>';

    const profile = DataManager.getProfile();
    const blacklist = profile.privacy?.statusBlacklist || [];
    
    // Use a Set for faster toggling during selection
    state.tempExclusionList = new Set(blacklist);

    const savedIds = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
    container.innerHTML = "";

    if (savedIds.length === 0) {
        container.innerHTML = '<div style="padding:40px; text-align:center; color:gray;">No saved contacts found.</div>';
        return;
    }

    for (const uid of savedIds) {
        const uSnap = await getDoc(doc(db, "users", uid));
        if (uSnap.exists()) {
            const u = uSnap.data();
            const isSelected = state.tempExclusionList.has(uid);
            
            const div = document.createElement('div');
            div.className = `list-item exclusion-item ${isSelected ? 'selected' : ''}`;
            
            div.onclick = () => {
                if (state.tempExclusionList.has(uid)) {
                    state.tempExclusionList.delete(uid);
                    div.classList.remove('selected');
                } else {
                    state.tempExclusionList.add(uid);
                    div.classList.add('selected');
                }
                document.getElementById('exclusion-count-label').innerText = `${state.tempExclusionList.size} contacts selected`;
            };

            div.innerHTML = `
                <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="list-avatar">
                <div style="flex:1; font-weight:500;">${u.name}</div>
                <div class="select-checkbox" style="border-radius: 4px;"></div>
            `;
            container.appendChild(div);
        }
    }
    document.getElementById('exclusion-count-label').innerText = `${state.tempExclusionList.size} contacts selected`;
},

saveStatusExclusions: async () => {
    const newList = Array.from(state.tempExclusionList);
    const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

    try {
        await updateDoc(doc(db, "users", state.currentUser.uid), {
            "privacy.statusBlacklist": newList
        });
        
        // Update local phone memory
        const profile = DataManager.getProfile();
        if(!profile.privacy) profile.privacy = {};
        profile.privacy.statusBlacklist = newList;
        DataManager.saveProfile(profile);

        App.showToast("Exclusion list saved");
        App.openStatusPrivacy(); // Return to the selection menu
    } catch (e) {
        console.error("Privacy Save Error:", e);
        App.showToast("Failed to save settings");
      }
   },
   deleteStatus: async (statusId) => {
    if (!confirm("Delete this status update?")) return;
    try {
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await deleteDoc(doc(db, "statuses", statusId));
        App.showToast("Status deleted");
        App.closeStatusViewer(); // Close the viewer after deleting
        App.loadStoriesRail();   // Refresh the home rail
    } catch (e) {
        App.showToast("Failed to delete");
      }
   },
   // --- ðŸ’¾ STORAGE & AUTO-DOWNLOAD ENGINE ---

openStorageData: () => {
    app.goToPage('storage-data-page');
    // Simple calculation: sum of string lengths in localStorage
    let totalChars = 0;
    for (let i = 0; i < localStorage.length; i++) {
        totalChars += localStorage.getItem(localStorage.key(i)).length;
    }
    const mb = (totalChars / (1024 * 1024)).toFixed(1);
    document.getElementById('storage-summary-mb').innerText = mb + " MB";
},

openManageStorage: () => {
    app.goToPage('manage-storage-page');
    const chats = DataManager.getChatList();
    const listCont = document.getElementById('chat-usage-list');
    listCont.innerHTML = "";

    let totalUsed = 0;
    chats.forEach(chat => {
        // Calculate real data size for this specific chat
        const rawData = localStorage.getItem(`chat_${chat.id}`) || "[]";
        const bytes = rawData.length;
        const mb = (bytes / (1024 * 1024)).toFixed(1);
        totalUsed += bytes;

        if (bytes > 1000) { // Only show chats with actual data
            const div = document.createElement('div');
            div.className = "storage-detail-item";
            div.onclick = () => alert("Chat cleaner for " + chat.name + " coming in next update!");
            div.innerHTML = `
                <img src="${chat.avatar}" class="list-avatar" style="width:40px; height:40px;">
                <div style="font-weight: 500; margin-left:10px;">${chat.name}</div>
                <div class="storage-size-label">${mb} MB</div>
            `;
            listCont.appendChild(div);
        }
    });

    const totalMb = (totalUsed / (1024 * 1024)).toFixed(1);
    document.getElementById('total-app-mb').innerText = totalMb;
    document.getElementById('app-bar-fill').style.width = Math.min(totalMb, 100) + "%";
},

// --- ðŸ“± DIALOG LOGIC ---

openAutoDownloadDialog: (mode) => {
    state.currentDialogMode = mode; // 'mobile' or 'wifi'
    state.tempChecks = { photos: false, audio: false, videos: false, docs: false };
    
    document.getElementById('media-dialog-title').innerText = 
        mode === 'mobile' ? "When using mobile data" : "When connected on Wi-Fi";
    
    document.getElementById('media-dialog-overlay').style.display = 'flex';
    app.refreshDialogUI();
},

toggleDialogCheck: (key) => {
    state.tempChecks[key] = !state.tempChecks[key];
    app.refreshDialogUI();
},

refreshDialogUI: () => {
    const rows = document.querySelectorAll('.check-row');
    const keys = ['photos', 'audio', 'videos', 'docs'];
    rows.forEach((row, i) => {
        if (state.tempChecks[keys[i]]) row.classList.add('active');
        else row.classList.remove('active');
    });
},

saveMediaDialog: () => {
    const active = Object.keys(state.tempChecks).filter(k => state.tempChecks[k]);
    const labelText = active.length === 0 ? "No media" : 
                    active.length === 4 ? "All media" : 
                    active.map(k => k.charAt(0).toUpperCase() + k.slice(1)).join(", ");
    
    document.getElementById(`label-auto-${state.currentDialogMode}`).innerText = labelText;
    app.closeMediaDialog();
    app.showToast("Settings saved");
},

closeMediaDialog: () => {
    document.getElementById('media-dialog-overlay').style.display = 'none';
    },
    // --- ðŸ› ï¸ BOT UTILITY ACTIONS ---

botDeleteMessage: async (chatId, msgId, reason) => {
    try {
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // Construct path for group messages
        const msgRef = doc(db, "chats", chatId, "messages", msgId);
        await deleteDoc(msgRef);

        // Send a temporary notification that the bot took action
        if (reason) {
            await App.sendMessage(`ðŸ¤– *Bot Action:* ${reason}`);
        }
    } catch (e) {
        console.error("Bot Delete Error:", e);
    }
},

sendWelcome: async (chatId, newUser) => {
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const chatSnap = await getDoc(doc(db, "chats", chatId));
        const config = chatSnap.data().botConfig;

        if (!config || !config.welcomeMsg) return;

        // Replace the @user placeholder with the real name
        const finalMsg = config.welcomeMsg.replace("@user", `*${newUser.name}*`);
        
        // Send the welcome message (including image if configured)
        // Using the 8-parameter sendMessage engine
        await App.sendMessage(finalMsg, config.welcomeImg, true); 
    } catch (e) {
        console.error("Welcome Error:", e);
    }
 },
 // --- ðŸ¤– GROUP BOT ENGINE (UI & Config) ---

openBotManagement: async () => {
    const chatId = state.currentChatId;
    App.goToPage('bot-management-page');
    
    // 1. Fetch current config from Firestore
    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const snap = await getDoc(doc(db, "chats", chatId));
    const data = snap.data().botConfig || { activeCommands: [], token: "" };
    
    // 2. Initialize temporary state for editing
    state.tempBotConfig = {
        token: data.token || "",
        welcomeMsg: data.welcomeMsg || "",
        badWords: data.badWords || [],
        activeCommands: [...(data.activeCommands || [])] // Deep copy
    };

    // 3. Fill UI Inputs
    document.getElementById('group-bot-token').value = state.tempBotConfig.token;
    document.getElementById('welcome-msg-input').value = state.tempBotConfig.welcomeMsg;
    document.getElementById('bad-words-input').value = state.tempBotConfig.badWords ? state.tempBotConfig.badWords.join(", ") : "";
    
    // 4. Update the visual checkboxes
    App.refreshBotCheckboxes();
},

toggleBotCommand: (cmd) => {
    if (!state.tempBotConfig.activeCommands) state.tempBotConfig.activeCommands = [];
    
    const index = state.tempBotConfig.activeCommands.indexOf(cmd);
    if (index === -1) {
        state.tempBotConfig.activeCommands.push(cmd);
    } else {
        state.tempBotConfig.activeCommands.splice(index, 1);
    }
    
    // Refresh visual state
    App.refreshBotCheckboxes();
    if (navigator.vibrate) navigator.vibrate(30);
},

handleWelcomeImage: (input) => {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('welcome-preview').src = e.target.result;
            document.getElementById('welcome-preview').style.display = 'block';
            document.getElementById('welcome-placeholder').style.display = 'none';
            state.tempWelcomeImage = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
},

saveGroupBotConfig: async () => {
    const chatId = state.currentChatId;
    const token = document.getElementById('group-bot-token').value.trim();
    const welcomeMsg = document.getElementById('welcome-msg-input').value.trim();
    const badWordsRaw = document.getElementById('bad-words-input').value;
    
    const config = {
        token: token,
        activeCommands: state.tempBotConfig.activeCommands,
        welcomeMsg: welcomeMsg,
        welcomeImg: state.tempWelcomeImage || state.tempBotConfig.welcomeImg || null,
        badWords: badWordsRaw.split(",").map(w => w.trim().toLowerCase()).filter(w => w !== "")
    };

    try {
        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await updateDoc(doc(db, "chats", chatId), { botConfig: config });
        App.showToast("Bot Configuration Saved âœ…");
        App.openGroupInfo();
    } catch (e) { 
        App.showToast("Failed to save"); 
    }
},

// --- âš™ï¸ BOT BRAIN (Command Logic) ---

processGroupBot: async (chatId, msg) => {
    const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const chatSnap = await getDoc(doc(db, "chats", chatId));
    const config = chatSnap.data().botConfig;
    
    // Safety check: Exit if bot is not configured for this group
    if (!config || !config.token) return;

    const text = msg.text ? msg.text.trim() : "";
    const senderId = msg.senderId;
    const admins = chatSnap.data().admins || [];
    const isAdmin = admins.includes(senderId);

    // 1. Anti-Link Filter (Non-admins only)
    if (config.activeCommands.includes('antilink') && !isAdmin && text.match(/https?:\/\/[^\s]+/)) {
        await App.botDeleteMessage(chatId, msg.id, "Links are not allowed here! ðŸš«");
        return;
    }

    // 2. Bad Words Filter (Non-admins only)
    if (config.badWords && !isAdmin && config.badWords.some(word => text.toLowerCase().includes(word))) {
        await App.removeMemberFromGroup(senderId, "Bot Filter");
        await App.sendMessage("User removed for sending forbidden words. ðŸ›‘", null, true);
        return;
    }

    // 3. Command Execution (.tagall)
    if (text === ".tagall" && isAdmin && config.activeCommands.includes('tagall')) {
        const members = chatSnap.data().participants || [];
        let tagText = "ðŸ“¢ *Attention Everyone!*\n\n";
        for (const uid of members) {
            const u = await getDoc(doc(db, "users", uid));
            tagText += `@${u.data().name} `;
        }
        await App.sendMessage(tagText);
    }

    // 4. Group Lock (.lock group)
    if (text.startsWith(".lock group") && isAdmin && config.activeCommands.includes('lock')) {
        await updateDoc(doc(db, "chats", chatId), { "settings.sendMessages": false });
        await App.sendMessage("ðŸ”’ *Group Locked:* Only admins can send messages.");
    }

    // 5. Group Unlock (.unlock group)
    if (text.startsWith(".unlock group") && isAdmin && config.activeCommands.includes('lock')) {
        await updateDoc(doc(db, "chats", chatId), { "settings.sendMessages": true });
        await App.sendMessage("ðŸ”“ *Group Unlocked:* Everyone can now send messages.");
    }

    // 6. Change Group Profile Picture (.changepp - Reply to Image)
    if (text === ".changepp" && isAdmin && config.activeCommands.includes('pp')) {
        // Check if the user is replying to a message
        if (state.replyingTo) {
            // Retrieve full message data from local history to get the base64/URL image string
            const history = DataManager.getMessages(chatId);
            const targetMsg = history.find(m => m.id === state.replyingTo.id);

            if (targetMsg && targetMsg.img) {
                try {
                    // Update the Group Icon in Firestore
                    await updateDoc(doc(db, "chats", chatId), {
                        "groupInfo.photo": targetMsg.img
                    });

                    // Update local UI immediately for a seamless feel
                    const iconEl = document.getElementById('gi-icon');
                    if (iconEl) iconEl.src = targetMsg.img;

                    await App.sendMessage("âœ… *Bot Action:* Group profile picture has been updated!");
                    
                    // Clear the reply context
                    if (typeof App.cancelReply === 'function') App.cancelReply(); 
                } catch (e) {
                    console.error("Change PP Error:", e);
                    await App.sendMessage("âŒ Failed to update profile picture.");
                }
            } else {
                await App.sendMessage("âš ï¸ The message you replied to does not contain an image.");
            }
        } else {
            await App.sendMessage("âš ï¸ Please reply to an image with `.changepp` to update the group icon.");
        }
    }
},


// --- ðŸ§ª BOT TESTING LOGIC ---

testGroupBot: async () => {
    const token = document.getElementById('group-bot-token').value.trim();
    const chatId = state.currentChatId;

    if (!token) return alert("Enter a Bot Token first.");
    App.showToast("â³ Bot is connecting...");

    try {
        const { doc, getDoc, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // 1. Verify Token exists in the BotFather Registry
        const tokenSnap = await getDoc(doc(db, "bot_tokens", token));
        if (!tokenSnap.exists()) {
            alert("âŒ Invalid Token. Bot not found.");
            return;
        }

        const botId = tokenSnap.data().botId;
        const botSnap = await getDoc(doc(db, "users", botId));
        const botData = botSnap.data();

        // 2. SEND MESSAGE AS THE BOT (Left Side)
        await addDoc(collection(db, "chats", chatId, "messages"), {
            text: `ðŸ¤– *Bot Connection Test*\nStatus: Online âœ…\nReady for ${botData.name}`,
            senderId: botId, 
            senderName: botData.name,
            senderPhoto: botData.photo,
            type: 'bot_reply',
            timestamp: Date.now(),
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });

        App.showToast("âœ… Bot is live! Check the chat.");
    } catch (e) {
        console.error(e);
        App.showToast("âŒ Connection failed.");
    }
},

// --- ðŸŽ¨ VISUAL HELPERS ---

refreshBotCheckboxes: () => {
    const commands = ['tagall', 'lock', 'pp', 'kick', 'antilink'];
    commands.forEach(cmd => {
        const el = document.getElementById(`check-bot-${cmd}`);
        if (el) {
            const isActive = state.tempBotConfig.activeCommands.includes(cmd);
            if (isActive) {
                el.classList.add('selected');
                el.style.backgroundColor = "var(--primary)";
                el.style.borderColor = "var(--primary)";
            } else {
                el.classList.remove('selected');
                el.style.backgroundColor = "transparent";
                el.style.borderColor = "#ccc";
            }
        }
    });
 },
 // --- âœ‰ï¸ BOT WELCOME ENGINE ---

triggerBotWelcome: async (chatId, newUserUid) => {
    try {
        const { doc, getDoc, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // 1. Get Group Data & Bot Config
        const chatSnap = await getDoc(doc(db, "chats", chatId));
        const chatData = chatSnap.data();
        const config = chatData.botConfig;

        // 2. Safety Check: Is the bot active and is Welcome enabled?
        if (!config || !config.token || !config.welcomeMsg) return;

        // 3. Get Bot Identity (to send the message from the bot)
        const tokenSnap = await getDoc(doc(db, "bot_tokens", config.token));
        if (!tokenSnap.exists()) return;
        const botId = tokenSnap.data().botId;
        const botSnap = await getDoc(doc(db, "users", botId));
        const botData = botSnap.data();

        // 4. Get New User Info
        const userSnap = await getDoc(doc(db, "users", newUserUid));
        const userData = userSnap.data();
        const userName = userData ? userData.name : "New Member";

        // 5. Format the Message
        const finalMsg = config.welcomeMsg.replace("@user", `*${userName}*`);

        // 6. Send the Welcome Message as the Bot
        await addDoc(collection(db, "chats", chatId, "messages"), {
            text: finalMsg,
            img: config.welcomeImg || null, // Include the uploaded image if it exists
            senderId: botId,
            senderName: botData.name,
            senderPhoto: botData.photo,
            type: config.welcomeImg ? 'image' : 'text',
            timestamp: Date.now(),
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });

    } catch (e) {
        console.error("Welcome System Error:", e);
    }
 },
 // --- ðŸŽ¨ STICKER ADVANCED TOOLS ---

openStickerTextTool: () => {
    document.getElementById('sticker-text-tool-overlay').style.display = 'flex';
    document.getElementById('sticker-text-input').focus();
},

closeStickerTextTool: () => {
    document.getElementById('sticker-text-tool-overlay').style.display = 'none';
},

setStickerTextSize: (size, el) => {
    document.getElementById('sticker-text-input').style.fontSize = size;
    document.querySelectorAll('#sticker-text-tool-overlay .status-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
},

applyStickerText: () => {
    const text = document.getElementById('sticker-text-input').value;
    if(!text) return App.closeStickerTextTool();
    
    // In a real app, we would use a Canvas to draw this text onto the image
    // For this prototype, we'll notify Kelvin and close
    App.showToast("Text Applied to Sticker");
    App.closeStickerTextTool();
},

openStickerColorTool: () => {
    App.goToPage('sticker-color-tool-page');
    document.getElementById('color-sticker-text').focus();
},

toggleStickerBgColor: () => {
    const colors = ['#5c6bc0', '#e91e63', '#00a884', '#ff9800', '#212121'];
    const current = document.getElementById('sticker-color-tool-page').style.background;
    // Simple rotation logic
    let nextIndex = (colors.indexOf(rgbToHex(current)) + 1) % colors.length;
    document.getElementById('sticker-color-tool-page').style.background = colors[nextIndex];
},

saveColorSticker: () => {
    const text = document.getElementById('color-sticker-text').value;
    if(!text) return alert("Write something first!");
    
    // Simulate converting the colored background + text into a sticker image
    App.showToast("Color Sticker Created!");
    App.goToPage('chat-room');
 },
 // --- ðŸš© USER REPORTING ENGINE ---

openReportUserModal: () => {
    const partner = state.currentChatPartner;
    if (!partner) return;
    document.getElementById('report-modal-title').innerText = `Report ${partner.name}?`;
    document.getElementById('user-report-modal').style.display = 'flex';
},

closeReportUserModal: () => {
    document.getElementById('user-report-modal').style.display = 'none';
},

submitUserReport: async () => {
    const targetId = state.currentChatPartner.id;
    const shouldBlock = document.getElementById('report-also-block').checked;
    
    App.showToast("Submitting report...");
    App.closeReportUserModal();

    try {
        const { collection, query, where, orderBy, limit, getDocs, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        // 1. Fetch last 5 messages for evidence
        // This queries the direct messages between Kelvin and the target
        const msgQuery = query(
            collection(db, "messages"),
            where("senderId", "in", [state.currentUser.uid, targetId]),
            where("receiverId", "in", [state.currentUser.uid, targetId]),
            orderBy("timestamp", "desc"),
            limit(5)
        );
        
        const snap = await getDocs(msgQuery);
        const evidence = snap.docs.map(d => ({
            text: d.data().text,
            sender: d.data().senderId,
            time: d.data().timestamp
        }));

        // 2. Send report to Firebase
        await addDoc(collection(db, "reports"), {
            type: "user_harassment",
            reportedUserId: targetId,
            reporterId: state.currentUser.uid,
            timestamp: Date.now(),
            chatEvidence: evidence,
            status: "pending"
        });

        // 3. Optional: Block if checked
        if (shouldBlock) {
            await App.executeUserBlock(); // Reuses your existing block logic
            App.goToPage('chat-list-page');
        }

        App.showToast("Thank you. Report received. âœ…");

    } catch (e) {
        console.error("Reporting Error:", e);
        App.showToast("Report failed. Try again.");
    }
 },
 openImagePreview: (src, name, time) => {
    const overlay = document.createElement('div');
    overlay.id = 'image-viewer-overlay';
    overlay.className = 'image-viewer-overlay';
    
    overlay.innerHTML = `
        <div class="viewer-header">
            <div class="viewer-left">
                <i class="fa-solid fa-arrow-left" onclick="App.closeImagePreview()"></i>
                <div class="viewer-meta">
                    <div class="viewer-name">${name}</div>
                    <div class="viewer-time">Today at ${time}</div>
                </div>
            </div>
            <div class="viewer-actions">
                <i class="fa-solid fa-pencil"></i>
                <i class="fa-solid fa-share-nodes"></i>
                <i class="fa-solid fa-ellipsis-vertical" onclick="event.stopPropagation(); document.getElementById('iv-context-menu').classList.toggle('hidden')"></i>
            </div>
        </div>

        <div class="viewer-content">
            <img src="${src}" class="viewer-img">
        </div>

        <div id="iv-context-menu" class="iv-menu hidden">
            <div class="iv-menu-item" onclick="App.saveToGallery('${src}')">
                <i class="fa-solid fa-download"></i> <span>Save to Gallery</span>
            </div>
            <div class="iv-menu-item">
                <i class="fa-solid fa-grip"></i> <span>Show All Media</span>
            </div>
            <div class="iv-menu-item">
                <i class="fa-solid fa-eye"></i> <span>Show in chat</span>
            </div>
            <div class="iv-menu-item" onclick="App.initiateReplyFromViewer('${src}')">
                <i class="fa-solid fa-reply"></i> <span>Reply</span>
            </div>
            <div class="iv-menu-item">
                <i class="fa-solid fa-share-nodes"></i> <span>Share</span>
            </div>
            <div class="iv-menu-item">
                <i class="fa-solid fa-trash"></i> <span>Delete</span>
            </div>
        </div>
    `;

    document.body.appendChild(overlay);

    overlay.onclick = (e) => {
        const menu = document.getElementById('iv-context-menu');
        if (menu && !menu.contains(e.target)) {
            menu.classList.add('hidden');
        }
    };

    window.history.pushState({viewingImage: true}, "");
    window.onpopstate = () => {
        App.closeImagePreview();
    };
},

closeImagePreview: () => {
    const overlay = document.getElementById('image-viewer-overlay');
    if (overlay) {
        overlay.remove();
        window.onpopstate = null;
    }
},

saveToGallery: async (url) => {
    const isApp = !!window.Capacitor;

    if (isApp) {
        // --- ðŸ“± CAPACITOR APP LOGIC ---
        try {
            // This assumes you have @capacitor/filesystem and @capacitor-community/media installed
            App.showToast("Saving to gallery...");
            
            // 1. Download file to temporary folder
            // 2. Use Media.savePhoto({ path: ... }) 
            
            // Example bridge call (update this once your plugins are installed):
            // const response = await fetch(url);
            // const blob = await response.blob();
            // ... (conversion to base64 and saving)
            
            App.showToast("Saved to Photos");
        } catch (e) {
            console.error("App Save Error:", e);
            App.showToast("Failed to save image");
        }
    } else {
        // --- ðŸŒ WEB BROWSER LOGIC ---
        const link = document.createElement('a');
        link.href = url;
        link.download = `GlobalConnect_${Date.now()}.jpg`;
        link.target = "_blank";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        App.showToast("Download started");
    }
 },
 // --- MANAGE CHAT STORAGE LOGIC ---

// 1. OPEN THE DETAIL PAGE
openChatStorage: (chatId) => {
    state.currentStorageChatId = chatId;
    state.storageSelection = []; // Reset any previous selections
    
    // Find the specific chat and its media (Images & Videos)
    const chat = state.chats.find(c => c.id === chatId);
    const mediaMessages = state.messages.filter(m => 
        (m.chatId === chatId) && (m.type === 'image' || m.type === 'video')
    );

    // Update Header Text
    const nameEl = document.getElementById('storage-chat-name');
    const sizeEl = document.getElementById('storage-chat-size');
    
    if (nameEl) nameEl.innerText = chat ? chat.name : "Chat Media";
    if (sizeEl) {
        // Calculate total size (mock calculation: 0.5MB per file)
        const totalMB = (mediaMessages.length * 0.5).toFixed(1);
        sizeEl.innerText = `${mediaMessages.length} files (${totalMB} MB)`;
    }
    
    // Render the grid and reset the delete bar
    App.renderStorageGrid(mediaMessages);
    App.updateStorageDeleteBar();
    
    // Switch to the detail page
    App.goToPage('manage-chat-storage-page');
},

// 2. RENDER THE MEDIA GRID
renderStorageGrid: (mediaList) => {
    const grid = document.getElementById('storage-media-grid');
    if (!grid) return;
    grid.innerHTML = "";

    mediaList.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'storage-item';
        div.id = `storage-item-${msg.id}`;
        div.onclick = () => App.toggleStorageItem(msg.id, div);

        // Define content based on type
        let mediaHTML = '';
        if (msg.type === 'video') {
            mediaHTML = `
                <video src="${msg.image}"></video>
                <i class="fa-solid fa-video" style="position: absolute; top: 8px; right: 8px; color: white; font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></i>
            `;
        } else {
            mediaHTML = `<img src="${msg.image}" loading="lazy">`;
        }

        div.innerHTML = `
            ${mediaHTML}
            <div class="overlay"></div>
            <div class="checkmark"></div>
        `;
        grid.appendChild(div);
    });
},

// 3. TOGGLE ITEM SELECTION
toggleStorageItem: (msgId, element) => {
    const index = state.storageSelection.indexOf(msgId);
    
    if (index === -1) {
        state.storageSelection.push(msgId);
        element.classList.add('selected');
    } else {
        state.storageSelection.splice(index, 1);
        element.classList.remove('selected');
    }
    
    App.updateStorageDeleteBar();
},

// 4. SELECT ALL FUNCTIONALITY
selectAllStorage: () => {
    const items = document.querySelectorAll('.storage-item');
    state.storageSelection = []; // Clear current
    
    items.forEach(item => {
        const id = item.id.replace('storage-item-', '');
        state.storageSelection.push(id);
        item.classList.add('selected');
    });
    
    App.updateStorageDeleteBar();
},

// 5. UPDATE DELETE BAR UI
updateStorageDeleteBar: () => {
    const bar = document.getElementById('storage-delete-bar');
    const countLabel = document.getElementById('storage-selected-count');
    if (!bar || !countLabel) return;

    if (state.storageSelection.length > 0) {
        bar.style.bottom = "0px"; // Slide into view
        countLabel.innerText = `${state.storageSelection.length} selected`;
    } else {
        bar.style.bottom = "-100px"; // Hide below screen
    }
},

// 6. DELETE ACTION
deleteSelectedStorageItems: () => {
    const count = state.storageSelection.length;
    if (count === 0) return;

    if (confirm(`Are you sure you want to delete these ${count} items from your storage? This cannot be undone.`)) {
        // Remove from the global messages state
        state.messages = state.messages.filter(m => !state.storageSelection.includes(m.id));
        
        // Clear selection and refresh the current view
        const currentChatId = state.currentStorageChatId;
        state.storageSelection = [];
        
        // Update the main storage usage calculation
        App.calculateStorageUsage(); 
        
        // Stay on page but refresh list
        App.openChatStorage(currentChatId);
        
        // Optional: Show a small success toast
        console.log(`${count} items deleted successfully.`);
    }
},

// 7. CLOSE PAGE
closeChatStorage: () => {
    state.storageSelection = [];
    App.goToPage('manage-storage-page');
 },
 initInviteRadar: async () => {
    if (!state.currentUser) return;

    const { collection, query, where, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const myUid = state.currentUser.uid;
    
    console.log("ðŸ‘‚ Radar is listening for UID:", myUid);

    // BATTLE RADAR
    const qBattle = query(
        collection(db, "battle_invites"), 
        where("targetUid", "==", myUid), 
        where("status", "==", "pending")
    );
    
    onSnapshot(qBattle, (snapshot) => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const invite = change.doc.data();
                console.log("âš”ï¸ Battle Invite Detected!", invite);

                const modal = document.getElementById('battle-invite-modal');
                const nameLabel = document.getElementById('battle-challenger-name');
                const acceptBtn = document.getElementById('battle-confirm-btn');

                if (modal && nameLabel) {
                    nameLabel.innerText = invite.hostName;
                    
                    // FORCE VISIBILITY
                    modal.style.display = 'flex';
                    modal.style.setProperty('z-index', '100000', 'important'); 
                    
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

                    acceptBtn.onclick = () => {
                        modal.style.display = 'none';
                        App.acceptBattleChallenge(change.doc.id, invite.battleId);
                    };
                }
            }
        });
    });

    // CO-HOST RADAR (Gaming)
    const qCoHost = query(
        collection(db, "live_invites"), 
        where("viewerId", "==", myUid), 
        where("status", "==", "pending")
    );
    
    onSnapshot(qCoHost, (snapshot) => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const invite = change.doc.data();
                state.activeInviteId = change.doc.id;
                state.targetLiveId = invite.liveId;

                const modal = document.getElementById('cohost-invite-modal');
                if (modal) {
                    document.getElementById('invite-host-name').innerText = invite.hostName;
                    modal.style.display = 'flex';
                    modal.style.setProperty('z-index', '100000', 'important');
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }
            }
        });
    });
 },
   // --- ðŸ•’ ARENA COUNTDOWN ENGINE ---
    startArenaTimer: (endTime) => {
    if (state.battleInterval) clearInterval(state.battleInterval);
    const timerEl = document.getElementById('arena-timer-display');
    
    state.battleInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;

        if (remaining <= 0) {
            clearInterval(state.battleInterval);
            timerEl.innerText = "00:00";
            // ðŸš€ TRIGGER THE WINNER SCREEN
            App.declareBattleWinner();
            return;
        }

        const m = Math.floor(remaining / 60000);
        const s = Math.floor((remaining % 60000) / 1000);
        timerEl.innerText = `${m}:${s < 10 ? '0' + s : s}`;
    }, 1000);
  },
      // --- ðŸ† FINAL INTEGRATED WINNER LOGIC ---
  declareBattleWinner: async () => {
    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    // 1. Fetch final scores from DB to be 100% accurate
    const snap = await getDoc(doc(db, "lives", state.currentLiveId));
    if (!snap.exists()) return;
    const data = snap.data();

    const p1Score = data.p1_score || 0;
    const p2Score = data.p2_score || 0;
    
    let winnerName = "";
    let finalAmount = 0;
    let winnerPhoto = "";
    let winnerUid = null;

    // 2. Determine Winner details
    if (p1Score > p2Score) {
        winnerName = data.hostName;
        finalAmount = p1Score;
        winnerPhoto = data.hostAvatar;
        winnerUid = data.hostId;
    } else if (p2Score > p1Score) {
        winnerName = data.p2_name;
        finalAmount = p2Score;
        winnerPhoto = data.p2_photo;
        winnerUid = data.p2_id;
    } else {
        winnerName = "Both of you! It's a Tie";
        finalAmount = p1Score;
        winnerPhoto = "https://cdn-icons-png.flaticon.com/512/1021/1021204.png";
    }

    // ðŸŒŸ AUTOMATIC STATUS POST INTEGRATION ðŸŒŸ
    // If the local user is the winner, trigger the canvas generator and status upload
    if (winnerUid === state.currentUser.uid) {
        App.shareWinningMomentToStatus(winnerName, winnerPhoto, finalAmount);
        
        // ðŸ† Update Win Count for Leaderboard
        const { updateDoc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await updateDoc(doc(db, "users", winnerUid), {
            battleWins: increment(1),
            totalBattleEarnings: increment(finalAmount)
        });
    }

    // 3. ðŸ”Š AI VOICE ANNOUNCEMENT
    const speechText = `Congratulations ${winnerName}! You are the winner of today's battle with a total gift of ${finalAmount} orbs!`;
    const utterance = new SpeechSynthesisUtterance(speechText);
    utterance.rate = 0.9;
    window.speechSynthesis.speak(utterance);

    // 4. âœ¨ CREATE VISUAL WIN SCREEN OVERLAY
    const winOverlay = document.createElement('div');
    winOverlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.95); z-index: 200000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        animation: fadeIn 0.5s ease-out; text-align: center; color: white;
        backdrop-filter: blur(15px);
    `;

    winOverlay.innerHTML = `
        <div style="background: linear-gradient(135deg, #ffd700, #ff9500); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 50px #ffd700;">
            <i class="fa-solid fa-trophy" style="font-size: 60px; color: white;"></i>
        </div>
        <h1 style="font-size: 32px; font-weight: 900; color: #ffd700; margin-bottom: 10px;">BATTLE WINNER!</h1>
        <img src="${winnerPhoto}" style="width: 150px; height: 150px; border-radius: 50%; border: 5px solid #ffd700; object-fit: cover; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h2 style="font-size: 24px; font-weight: 800;">${winnerName}</h2>
        <div style="font-size: 18px; color: #00ff88; font-weight: bold; margin-top: 10px; background: rgba(0,255,136,0.1); padding: 5px 20px; border-radius: 20px;">
            <i class="fa-solid fa-gem"></i> ${finalAmount} Total Orbs
        </div>
        <button class="btn btn-primary" onclick="this.parentElement.remove(); App.endLiveSession()" style="margin-top: 40px; width: 220px; background: #ffd700; color: black; border: none; font-weight: 900; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);">RETURN TO HOME</button>
    `;

    document.body.appendChild(winOverlay);
    
    // Confetti effect (Simulated with vibration)
    if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 500]);
  },

    // --- ðŸ† WINNING MOMENT GENERATOR ---
  shareWinningMomentToStatus: async (name, photo, score) => {
    App.showToast("Posting victory to Status... ðŸš€");
    
    // 1. Create a hidden canvas for the graphic
    const canvas = document.createElement('canvas');
    canvas.width = 1080;
    canvas.height = 1920; // 9:16 Portrait Ratio
    const ctx = canvas.getContext('2d');

    // 2. Draw Gradient Background
    const grad = ctx.createLinearGradient(0, 0, 0, 1920);
    grad.addColorStop(0, '#1a1f25');
    grad.addColorStop(0.5, '#ff4b7d');
    grad.addColorStop(1, '#000000');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 1080, 1920);

    // 3. Load and Draw User Photo (with circular clipping)
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
    
    await new Promise(res => img.onload = res);
    
    ctx.save();
    ctx.beginPath();
    ctx.arc(540, 700, 250, 0, Math.PI * 2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(img, 290, 450, 500, 500);
    ctx.restore();

    // 4. Draw Professional Text
    ctx.fillStyle = "#ffffff";
    ctx.textAlign = "center";
    
    // Title
    ctx.font = "bold 80px Arial";
    ctx.fillText("ARENA BATTLE WINNER", 540, 1100);
    
    // Name
    ctx.fillStyle = "#ffd700";
    ctx.font = "900 120px Arial";
    ctx.fillText(name.toUpperCase(), 540, 1250);
    
    // Score
    ctx.fillStyle = "#ffffff";
    ctx.font = "60px Arial";
    ctx.fillText("TOTAL GIFTS RECEIVED", 540, 1400);
    
    ctx.fillStyle = "#00ff88";
    ctx.font = "bold 100px Arial";
    ctx.fillText(`ðŸ’Ž ${score} ORBS`, 540, 1550);

    // 5. Convert to Base64 and Upload to Firestore
    const finalGraphic = canvas.toDataURL('image/jpeg', 0.8);
    const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

    try {
        await addDoc(collection(db, "statuses"), {
            uid: state.currentUser.uid,
            name: name,
            photo: DataManager.getProfile().photo || "",
            image: finalGraphic,
            type: 'media',
            caption: `I just won an Arena Battle with ${score} Orbs! âš”ï¸ðŸ†`,
            timestamp: Date.now(),
            expiresAt: Date.now() + (24 * 60 * 60 * 1000),
            views: []
        });
        App.showToast("Winning moment is live on Status! âœ…");
        App.loadStoriesRail(); // Refresh local rail
    } catch (e) {
        console.error("Status post failed", e);
    }
  },
    renderLeaderboard: async () => {
    App.goToPage('leaderboard-page');
    const listCont = document.getElementById('league-list');
    const podiumCont = document.getElementById('league-podium');
    
    listCont.innerHTML = '<div style="padding:30px; text-align:center;"><i class="fa-solid fa-spinner fa-spin"></i> Loading League...</div>';

    try {
        const { collection, query, orderBy, limit, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // 1. Fetch top users by wins
        const q = query(collection(db, "users"), orderBy("battleWins", "desc"), limit(20));
        const snap = await getDocs(q);
        
        let users = [];
        snap.forEach(d => users.push(d.data()));

        // 2. Render Podium (Top 3)
        podiumCont.innerHTML = "";
        const podiumOrder = [1, 0, 2]; // 2nd, 1st, 3rd position
        podiumOrder.forEach((idx, pos) => {
            const u = users[idx];
            if(!u) return;
            const h = idx === 0 ? '120px' : (idx === 1 ? '90px' : '70px');
            const crown = idx === 0 ? '<i class="fa-solid fa-crown" style="color:#ffd700; margin-bottom:5px;"></i>' : '';
            
            podiumCont.innerHTML += `
                <div style="display:flex; flex-direction:column; align-items:center; width:30%;">
                    ${crown}
                    <img src="${u.photo}" style="width:60px; height:60px; border-radius:50%; border:3px solid ${idx===0 ? '#ffd700' : '#8696a0'}; object-fit:cover;">
                    <div style="font-size:11px; font-weight:bold; margin-top:5px; text-align:center; overflow:hidden; white-space:nowrap; width:100%;">${u.name}</div>
                    <div style="background:${idx===0 ? '#ffd700' : '#1c2733'}; width:100%; height:${h}; margin-top:10px; border-radius:10px 10px 0 0; display:flex; align-items:center; justify-content:center; color:${idx===0?'black':'white'}; font-weight:900; font-size:24px;">${idx+1}</div>
                </div>`;
        });

        // 3. Render List (4-20)
        listCont.innerHTML = "";
        users.slice(3).forEach((u, i) => {
            const div = document.createElement('div');
            div.style.cssText = "display:flex; align-items:center; padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); gap:15px;";
            div.innerHTML = `
                <div style="width:25px; color:#8696a0; font-weight:bold; font-size:14px;">${i+4}</div>
                <img src="${u.photo}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:14px;">${u.name}</div>
                    <div style="font-size:11px; color:#8696a0;">${u.battleWins || 0} Wins</div>
                </div>
                <div style="color:#00ff88; font-weight:bold; font-size:13px;"><i class="fa-solid fa-gem"></i> ${u.totalBattleEarnings || 0}</div>
            `;
            listCont.appendChild(div);
        });

    } catch (e) { console.error(e); }
  },
      // --- ðŸŽ™ï¸ INTEGRATED ARENA VOICE ENGINE ---
  initBattleAudio: async (isHost) => {
    const remoteAudio = document.getElementById('arena-remote-audio');
    const { doc, setDoc, onSnapshot, updateDoc, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

    try {
        // 1. Capture Local Microphone
        const localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        state.arenaAudioStream = localStream; // Store for cleanup

        const pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }]
        });

        // 2. Attach Local Audio to Connection
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        // 3. Handle Incoming Remote Audio & Voice Detection
        pc.ontrack = (event) => {
            if (remoteAudio) {
                remoteAudio.srcObject = event.streams[0];
                // Start pulse detection for the remote user
                const remotePulseId = isHost ? 'opp-pulse' : 'host-pulse';
                App.startVoiceDetection(event.streams[0], remotePulseId);
            }
        };

        // 4. Reveal Mute Button (Only for Host and Challenger)
        const micControl = document.getElementById('arena-mic-control');
        if (micControl) micControl.style.display = 'flex';

        // 5. Start Pulse detection for Self
        const myPulseId = isHost ? 'host-pulse' : 'opp-pulse';
        App.startVoiceDetection(localStream, myPulseId);

        // 6. Handle Signaling (Handshake)
        const signalRef = doc(db, "lives", state.currentLiveId, "audio_signals", isHost ? "host" : "opponent");

        if (isHost) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await setDoc(signalRef, { offer: { type: offer.type, sdp: offer.sdp } });

            onSnapshot(doc(db, "lives", state.currentLiveId, "audio_signals", "opponent"), async (snap) => {
                const data = snap.data();
                if (data && data.answer && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
        } else {
            onSnapshot(doc(db, "lives", state.currentLiveId, "audio_signals", "host"), async (snap) => {
                const data = snap.data();
                if (data && data.offer && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await setDoc(signalRef, { answer: { type: answer.type, sdp: answer.sdp } });
                }
            });
        }

        // 7. ICE Candidate Exchange (Network Bridge)
        pc.onicecandidate = (e) => {
            if (e.candidate) {
                const candPath = isHost ? "host_candidates" : "opp_candidates";
                addDoc(collection(db, "lives", state.currentLiveId, candPath), e.candidate.toJSON());
            }
        };

        onSnapshot(collection(db, "lives", state.currentLiveId, isHost ? "opp_candidates" : "host_candidates"), (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    pc.addIceCandidate(new RTCIceCandidate(change.doc.data())).catch(e => {});
                }
            });
        });

        state.arenaPeerConnection = pc;

    } catch (err) {
        console.error("Audio initialization failed:", err);
        App.showToast("Mic Error: Battle will be silent.");
    }
  },

    // --- ðŸŽ¤ MIC TOGGLE ENGINE ---
  toggleArenaMic: () => {
    if (!state.arenaAudioStream) return;
    
    const audioTrack = state.arenaAudioStream.getAudioTracks()[0];
    const icon = document.getElementById('arena-mic-icon');
    const btn = document.getElementById('arena-mic-control');

    audioTrack.enabled = !audioTrack.enabled;
    
    if (audioTrack.enabled) {
        icon.className = "fa-solid fa-microphone";
        btn.style.background = "rgba(255,255,255,0.2)";
        App.showToast("Microphone On");
    } else {
        icon.className = "fa-solid fa-microphone-slash";
        btn.style.background = "#ff4757"; // Red when muted
        App.showToast("Microphone Muted");
    }
  },

  // --- ðŸ”Š VOICE DETECTION (ON-AIR PULSE) ---
  startVoiceDetection: (stream, elementId) => {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(stream);
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    source.connect(analyser);

    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    const pulseEl = document.getElementById(elementId);

    const checkVolume = () => {
        if (!state.arenaActive) return; // Stop if battle ends
        analyser.getByteFrequencyData(dataArray);
        
        // Calculate average volume
        let values = 0;
        for (let i = 0; i < dataArray.length; i++) { values += dataArray[i]; }
        const average = values / dataArray.length;

        // If volume is above threshold, show the pulse
        if (average > 30) {
            pulseEl.style.display = 'block';
        } else {
            pulseEl.style.display = 'none';
        }
        requestAnimationFrame(checkVolume);
    };
    checkVolume();
  },
  openProfilePopup: () => {
    const partner = state.currentChatPartner;
    if (!partner) return;

    document.getElementById('popup-user-name').innerText = partner.name;
    document.getElementById('popup-user-img').src = partner.avatar;
    document.getElementById('profile-popup-overlay').style.display = 'flex';
},

closeProfilePopup: () => {
    document.getElementById('profile-popup-overlay').style.display = 'none';
},

openChatFromPopup: () => {
    const partner = state.currentChatPartner;
    App.closeProfilePopup();
    App.openChat(partner.id, partner.name, partner.avatar);
 },
 // --- Inside your App = { ... } object ---

initSecuritySystem: async () => {
    // 1. Detect if running as Native App (Android/iOS) or Web
    const isNative = window.Capacitor && Capacitor.isNativePlatform();

    if (isNative) {
        // ðŸ“± NATIVE HARD-BLOCK: Hardware capture prevention
        try {
            // Requires: npm install @capacitor/privacy-screen
            const { PrivacyScreen } = await import('@capacitor/privacy-screen');
            await PrivacyScreen.enable();
            console.log("Native hardware screenshot block enabled.");
        } catch (e) {
            console.warn("PrivacyScreen plugin missing, using web fallback.");
            App.initWebDeterrents();
        }
    } else {
        // ðŸŒ WEB SOFT-BLOCK: Visual deterrents
        App.initWebDeterrents();
    }
},

initWebDeterrents: () => {
    const overlay = document.getElementById('security-lock-overlay');
    const sensitivePages = ['user-info-page', 'public-profile-page'];

    // A. Blur on Focus Loss (When mobile screenshot UI appears)
    window.addEventListener('blur', () => {
        const activePage = document.querySelector('.page.active');
        const isPopupOpen = document.getElementById('profile-popup-overlay')?.style.display === 'flex';

        if ((activePage && sensitivePages.includes(activePage.id)) || isPopupOpen) {
            document.getElementById('app-frame').classList.add('security-blur');
            overlay.style.display = 'flex';
        }
    });

    // B. Restore on Focus
    window.addEventListener('focus', () => {
        document.getElementById('app-frame').classList.remove('security-blur');
        overlay.style.display = 'none';
    });

    // C. Block "Print Screen" Key (PC)
    window.addEventListener('keyup', (e) => {
        if (e.key === 'PrintScreen') {
            navigator.clipboard.writeText("Content Protected");
            App.showToast("Screenshots are restricted.");
        }
    });

    // D. Prevent context menu on profile photos
    document.addEventListener('contextmenu', (e) => {
        if (e.target.closest('#info-avatar') || e.target.closest('#popup-user-img')) {
            e.preventDefault();
        }
    });
 },
 
getUserInfo: async (uid) => {
    // 1. Check local chat cache first
    const chats = DataManager.getChatList();
    const cached = chats.find(c => c.id === uid);
    if (cached) return { name: cached.name, photo: cached.avatar };

    // 2. Fetch from Firestore if not in cache
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const snap = await getDoc(doc(db, "users", uid));
        if (snap.exists()) return snap.data();
    } catch (e) { console.error(e); }
    
    return { name: "User", photo: "https://cdn-icons-png.flaticon.com/512/847/847969.png" };
 },

 openPicker: () => {
        GameEngine.renderHub();
    },
    // --- ðŸŽµ FINAL INTEGRATED MUSIC ENGINE (YouTube Powered) ---

openMusicPicker: () => {
    // ðŸŒŸ Uses the page router to handle the !important CSS rule
    App.goToPage('music-picker-page'); 
    App.switchMusicTab('foryou');
},

switchMusicTab: (tab) => {
    // 1. UI Tab Highlight
    document.querySelectorAll('.music-tab').forEach(el => {
        el.style.color = '#888'; 
        el.style.borderBottom = 'none';
    });
    
    const active = document.getElementById('tab-' + tab);
    if(active) {
        active.style.color = 'var(--primary)'; 
        active.style.borderBottom = '2px solid var(--primary)';
    }

    // 2. ðŸŒŸ SMART ROUTING: Dynamic Content Loading
    if(tab === 'foryou') {
        // Triggers the real YouTube 'mostPopular' Chart
        App.fetchMusic("trending_global"); 
    }
    if(tab === 'hot') {
        // Broad search for viral hits
        App.fetchMusic("Top 50 Global Hits 2026");
    }
    if(tab === 'recent') {
        App.renderRecentMusic();
    }
},

fetchMusic: async (query) => {
    const list = document.getElementById('music-results-list');
    list.innerHTML = '<div style="text-align:center; padding:30px;"><div class="sending-spinner" style="margin:0 auto;"></div></div>';
    
    let url;
    
    // ðŸŒŸ LOGIC SWITCH: Chart API vs Search API
    if (query === "trending_global") {
        url = `https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10&maxResults=15&key=${YT_KEY}`;
    } else {
        const searchQuery = `${query} official audio`;
        url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=15&q=${encodeURIComponent(searchQuery)}&type=video&videoCategoryId=10&key=${YT_KEY}`;
    }

    try {
        const res = await fetch(url);
        const data = await res.json();
        
        if (!data.items || data.items.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:gray;">No sounds found.</div>`;
            return;
        }

        const songs = data.items.map(item => {
            const id = item.id.videoId || item.id; 
            const snippet = item.snippet;

            return {
                id: id,
                name: snippet.title.replace(/official audio|official video|\[.*?\]|\(.*?\)/gi, '').trim(),
                artist_name: snippet.channelTitle.replace('- Topic', '').trim(),
                image: snippet.thumbnails.medium.url,
                audio: id 
            };
        });

        // ðŸŒŸ CACHE IMAGES: This is the critical fix for the movie disc art
        state.lastMusicResults = songs; 
        
        App.renderMusicList(songs);
    } catch (e) {
        list.innerHTML = `<div style="text-align:center; color:red; padding:20px;">Connection Failed</div>`;
    }
},


searchMusic: (query) => {
    // ðŸŒŸ Debounce: waits for user to stop typing to save API quota
    clearTimeout(state.musicSearchTimeout);
    if (query.trim().length < 2) return;
    
    state.musicSearchTimeout = setTimeout(() => {
        App.fetchMusic(query);
    }, 600); 
},

renderMusicList: (songs) => {
    const container = document.getElementById('music-results-list');
    if (!container) return;
    container.innerHTML = songs.map(s => `
        <div class="list-item" style="border-bottom: 1px solid #f9f9f9; padding: 12px 0; display: flex; align-items: center;">
            <img src="${s.image}" style="width:50px; height:50px; border-radius:8px; object-fit:cover; margin-right:15px;">
            <div style="flex:1; overflow: hidden;">
                <div style="font-weight:bold; color:#111; font-size:15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name}</div>
                <div style="font-size:12px; color:gray;">${s.artist_name}</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="app.previewSong('${s.id}')" style="background:#f0f2f5; border:none; width:35px; height:35px; border-radius:50%; cursor: pointer;"><i class="fa-solid fa-play"></i></button>
                <button onclick="app.selectMusicForVideo('${s.id}', '${s.name.replace(/'/g, "")}')" style="background:var(--primary); color:white; border:none; border-radius:20px; padding:5px 15px; font-size:12px; font-weight:bold; cursor: pointer;">Use</button>
            </div>
        </div>
    `).join('');
},

// --- ðŸŽµ PERSISTENT SYNC BRIDGE ---
previewSong: (videoId, action = 'play') => {
    let playerDiv = document.getElementById('hidden-youtube-audio');
    if (!playerDiv) {
        playerDiv = document.createElement('div');
        playerDiv.id = 'hidden-youtube-audio';
        playerDiv.style.cssText = "position:absolute; top:-999px; left:-999px; width:1px; height:1px; visibility:hidden;"; 
        document.body.appendChild(playerDiv);
    }

    const frame = playerDiv.querySelector('iframe');
    const origin = window.location.origin;

    // ðŸŒŸ THE SYNC LOGIC: Talk to the existing iframe if it's the same song
    if (frame && state.currentMusicId === videoId) {
        if (action === 'restart') {
            frame.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'seekTo', args: [0, true] }), '*');
            frame.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'playVideo' }), '*');
        } else {
            const cmd = (action === 'pause') ? 'pauseVideo' : 'playVideo';
            frame.contentWindow.postMessage(JSON.stringify({ event: 'command', func: cmd, args: '' }), '*');
        }
        return;
    }

    // INITIAL LOAD: Create player only when song changes
    state.currentMusicId = videoId;
    playerDiv.innerHTML = `
        <iframe width="1" height="1" 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&enablejsapi=1&origin=${origin}" 
                allow="autoplay">
        </iframe>`;
 },

// --- ðŸŽµ FINAL INTEGRATED MUSIC SELECTION ENGINE ---

selectMusicForVideo: (videoId, songName) => {
    // 1. Update Global State
    state.selectedMusicId = videoId; 
    state.selectedMusicName = songName;
    
    // ðŸŒŸ THE IMAGE FIX: Capture the thumbnail from the cached search results
    // This allows the movie page to show the album art on the rotating disc later
    const songData = state.lastMusicResults ? state.lastMusicResults.find(s => s.id === videoId) : null;
    state.selectedMusicImage = songData ? songData.image : "https://cdn-icons-png.flaticon.com/512/461/461238.png";

    // 2. Play preview instantly so the uploader hears the vibe
    App.previewSong(videoId); 

    // 3. PERSISTENCE: Save to "Recent" list in phone memory for future use
    let recents = JSON.parse(localStorage.getItem('recent_music') || '[]');
    recents = recents.filter(item => item.id !== videoId); // Prevent duplicates
    recents.unshift({ 
        name: songName, 
        id: videoId, 
        image: state.selectedMusicImage // Saving the real thumbnail to the recents list
    });
    localStorage.setItem('recent_music', JSON.stringify(recents.slice(0, 10)));

    // 4. UI UPDATE: Switch from the "Add Sound" prompt to the active Music Pill
    const pill = document.getElementById('music-pill-display');
    const prompt = document.getElementById('music-add-prompt');
    const nameLabel = document.getElementById('music-pill-name');

    if (pill && prompt && nameLabel) {
        nameLabel.innerText = songName;
        pill.style.display = 'flex';   // Reveal the floating pill
        prompt.style.display = 'none'; // Hide the original prompt
    }

    // 5. Feedback & Cleanup
    App.showToast(`âœ… Sound Added: ${songName}`);
    App.closeMusicPicker();
},



removeSelectedMusic: () => {
    // 1. Reset the global state
    state.selectedMusicId = null;
    state.selectedMusicName = null;
    
    // 2. Kill the background audio immediately
    const ytFrame = document.getElementById('hidden-youtube-audio');
    if (ytFrame) ytFrame.innerHTML = ""; 

    // ðŸŒŸ 3. UI RESET: Revert back to the default state
    const pill = document.getElementById('music-pill-display');
    const prompt = document.getElementById('music-add-prompt');

    if (pill) pill.style.display = 'none';
    if (prompt) prompt.style.display = 'block';
    
    App.showToast("Sound removed");
    
    // Subtle haptic feedback for the deletion
    if (navigator.vibrate) navigator.vibrate(30);
},


renderRecentMusic: () => {
    const recents = JSON.parse(localStorage.getItem('recent_music') || '[]');
    const container = document.getElementById('music-results-list');
    if (recents.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:50px; color:gray;">No recent sounds.</div>`;
        return;
    }
    App.renderMusicList(recents.map(r => ({ ...r, artist_name: "Recent" })));
 },
     // --- ðŸ”™ NAVIGATION CLEANUP ---
    exitEditor: () => {
        // Stop the video
        const video = document.getElementById('editor-preview');
        if (video) video.pause();

        // Kill the YouTube background audio
        const ytFrame = document.getElementById('hidden-youtube-audio');
        if (ytFrame) ytFrame.innerHTML = ""; 

        // Go back to record screen
        App.goToPage('upload-page');
        App.openUploadPage(); // Restart camera
    },
   // --- ðŸŽ¬ SIMPLIFIED PLAYBACK CONTROLLER ---
// This version trusts the video element listeners to handle the music sync
toggleMoviePlayback: (videoEl) => {
    if (videoEl.paused) {
        // Triggers videoEl.onplay -> tells bridge to 'play'
        videoEl.play(); 
    } else {
        // Triggers videoEl.onpause -> tells bridge to 'pause'
        videoEl.pause(); 
    }
 },




 // --- ðŸŽ™ï¸ AUTO-CAPTION ENGINE ---
toggleAutoCaptions: () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        return App.showToast("Captions not supported on this browser.");
    }

    if (state.isCaptionsActive) {
        state.recognition.stop();
        state.isCaptionsActive = false;
        document.getElementById('video-caption-overlay').style.display = 'none';
        document.getElementById('caption-status-label').innerText = "Captions Off";
        return;
    }

    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
        let transcript = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            transcript += event.results[i][0].transcript;
        }
        
        const box = document.getElementById('caption-text-box');
        box.innerText = transcript;
        document.getElementById('video-caption-overlay').style.display = 'block';
    };

    recognition.onerror = (e) => console.log("Caption Error:", e);
    
    recognition.start();
    state.recognition = recognition;
    state.isCaptionsActive = true;
    document.getElementById('caption-status-label').innerText = "Captions On";
    App.showToast("Listening for speech... ðŸŽ¤");
},

 // --- ðŸ”„ CAMERA FLIP ENGINE ---
flipCamera: async () => {
    state.facingMode = state.facingMode === 'user' ? 'environment' : 'user';

    if (state.cameraStream) {
        state.cameraStream.getTracks().forEach(track => track.stop());
    }

    const videoEl = document.getElementById('camera-preview');
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: state.facingMode }, 
            audio: true 
        });

        videoEl.srcObject = stream;
        state.cameraStream = stream;

        if (state.facingMode === 'user') {
            videoEl.style.transform = 'scaleX(-1)';
        } else {
            videoEl.style.transform = 'scaleX(1)';
        }

        App.showToast(`Switched to ${state.facingMode === 'user' ? 'Front' : 'Back'} Camera`);
    } catch (e) {
        console.error("Camera Flip Error:", e);
        App.showToast("Could not switch camera");
    }
},

 // --- ðŸŽµ MUSIC LOGIC ---
closeMusicPicker: () => {
    const ytFrame = document.getElementById('hidden-youtube-audio');
    if (ytFrame) ytFrame.innerHTML = ""; 
    
    if (state.previewAudio) {
        state.previewAudio.pause();
        state.previewAudio.currentTime = 0;
        state.previewAudio = null; 
    }
    
    App.goToPage('upload-page'); 
},

openMusicDetail: async (musicId, name, image, artist) => {
    App.goToPage('music-detail-page');
    
    document.getElementById('md-title').innerText = name || "Original Sound";
    document.getElementById('md-image').src = image || "https://cdn-icons-png.flaticon.com/512/461/461238.png";
    document.getElementById('md-artist').innerText = artist || "Unknown Artist";
    
    state.activeDetailMusic = { id: musicId, name: name, image: image };

    const grid = document.getElementById('md-video-grid');
    grid.innerHTML = '<div style="grid-column: span 3; text-align: center; padding: 50px; color: #ccc;"><i class="fa-solid fa-spinner fa-spin"></i></div>';

    try {
        const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const q = query(collection(db, "videos"), where("musicId", "==", musicId), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        
        document.getElementById('md-post-count').innerText = `${App.formatLikeCount(snap.size)} posts`;
        grid.innerHTML = "";

        if (snap.empty) {
            grid.innerHTML = '<div style="grid-column: span 3; text-align:center; padding:50px; color:gray;">No videos using this sound yet.</div>';
            return;
        }

        snap.forEach(docSnap => {
            const v = docSnap.data();
            const div = document.createElement('div');
            div.style.cssText = "aspect-ratio: 3/4; background: #000; overflow: hidden; cursor: pointer; border: 1px solid #fff;";
            div.onclick = () => App.playSpecificVideo(docSnap.id);
            div.innerHTML = `<video src="${v.videoUrl}#t=0.1" style="width: 100%; height: 100%; object-fit: cover;" muted playsinline></video>`;
            grid.appendChild(div);
        });

    } catch (e) { console.error("Detail Error:", e); }
},

useSoundFromDetail: () => {
    const m = state.activeDetailMusic;
    // Set sound globally for the upload page
    state.selectedMusicId = m.id;
    state.selectedMusicName = m.name;
    state.selectedMusicImage = m.image;
    
    // Update the upload UI pill
    const pill = document.getElementById('music-pill-display');
    const prompt = document.getElementById('music-add-prompt');
    const nameLabel = document.getElementById('music-pill-name');

    if (pill && prompt && nameLabel) {
        nameLabel.innerText = m.name;
        pill.style.display = 'flex';
        prompt.style.display = 'none';
    }

    App.openUploadPage();
    App.showToast(`Sound Ready: ${m.name}`);
},

addMusicToStory: async () => {
    const m = state.activeDetailMusic;
    const profile = DataManager.getProfile();
    
    App.showToast("Sharing to status...");

    try {
        const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        await addDoc(collection(db, "statuses"), {
            uid: state.currentUser.uid,
            name: profile.name,
            photo: profile.photo || "",
            type: 'text',
            image: `Check out this sound: ${m.name}`,
            background: '#ff4b7d',
            timestamp: Date.now(),
            expiresAt: Date.now() + (24 * 60 * 60 * 1000),
            views: []
        });

        App.showToast("Posted to Status âœ…");
        App.loadStoriesRail();
    } catch (e) { App.showToast("Failed to post"); }
 },
 // --- ðŸ§­ FEED MODE LOGIC ---

switchFeedMode: async (mode) => {
    state.feedMode = mode; // 'following', 'friends', or 'foryou'
    
    // Update Tab UI
    const tabs = document.querySelectorAll('.movie-tabs span');
    tabs.forEach(span => {
        span.classList.remove('active');
        if(span.innerText.toLowerCase().replace(" ", "") === mode) span.classList.add('active');
    });

    App.showToast(`Switching to ${mode} feed...`);
    await App.loadClips(mode);
},

loadClips: async (mode = 'foryou') => {
    try {
        const { getDocs, collection, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const myUid = state.currentUser.uid;
        
        // 1. Get IDs for Filtering
        const followDocs = await getDocs(query(collection(db, "likes"), where("from", "==", myUid)));
        const followingIds = followDocs.docs.map(d => d.data().to);

        // Friends = Mutual Follows
        let friendIds = [];
        if (mode === 'friends') {
            const followedMeDocs = await getDocs(query(collection(db, "likes"), where("to", "==", myUid)));
            const peopleWhoFollowMe = followedMeDocs.docs.map(d => d.data().from);
            friendIds = followingIds.filter(id => peopleWhoFollowMe.includes(id));
        }

        // 2. Query Videos
        let vQuery = query(collection(db, "videos"), orderBy("timestamp", "desc"));
        
        const snap = await getDocs(vQuery);
        let tempClips = [];

        snap.forEach(doc => {
            const v = doc.data();
            const ownerId = v.ownerId;

            if (mode === 'following' && !followingIds.includes(ownerId)) return;
            if (mode === 'friends' && !friendIds.includes(ownerId)) return;

            tempClips.push({ id: doc.id, ...v });
        });

        state.clips = tempClips;
        state.clipIndex = 0;
        App.renderMovie();
    } catch (e) { console.error(e); }
 },
 toggleVideoFavorite: async () => {
    const video = state.clips[state.clipIndex];
    if (!video || !video.id) return;

    const myUid = state.currentUser.uid;
    const { doc, updateDoc, arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    
    const videoRef = doc(db, "videos", video.id);
    
    // Safety check for local state
    if (!video.favorites) video.favorites = [];
    const isFavorited = video.favorites.includes(myUid);

    // Haptic feedback
    if (navigator.vibrate) navigator.vibrate(40);

    try {
        if (isFavorited) {
            // REMOVE FROM FAVORITES
            await updateDoc(videoRef, { favorites: arrayRemove(myUid) });
            video.favorites = video.favorites.filter(id => id !== myUid);
            App.showToast("Removed from Favorites");
        } else {
            // ADD TO FAVORITES
            await updateDoc(videoRef, { favorites: arrayUnion(myUid) });
            video.favorites.push(myUid);
            
            // Pop animation
            const icon = document.getElementById('movie-favorite-icon');
            icon.style.transform = "scale(1.4)";
            setTimeout(() => icon.style.transform = "scale(1)", 200);
            App.showToast("Added to Favorites â­");
        }

        // Update UI immediately
        const favIcon = document.getElementById('movie-favorite-icon');
        const favCountLabel = document.getElementById('movie-favorite-count');
        
        favIcon.style.color = !isFavorited ? "#face15" : "white";
        favCountLabel.innerText = App.formatLikeCount(video.favorites.length);

    } catch (e) {
        console.error("Favorite Error:", e);
        App.showToast("Error updating favorites");
    }
 },
 // --- ðŸ“¤ SHARE & DEEP LINK ENGINE ---

// 1. OPEN SHARE MENU
openShareMenu: async () => {
    const modal = document.getElementById('share-modal-overlay');
    modal.style.display = 'flex';
    
    // Load local contacts for DM sharing
    const rail = document.getElementById('share-contacts-rail');
    const savedIds = JSON.parse(localStorage.getItem('saved_contacts') || '[]');
    rail.innerHTML = "";

    if (savedIds.length === 0) {
        rail.innerHTML = `<div style="font-size:12px; color:gray; padding:10px;">No contacts saved</div>`;
    }

    for (const uid of savedIds) {
        const user = await DataManager.getUserInfo(uid);
        const div = document.createElement('div');
        div.style.cssText = "display: flex; flex-direction: column; align-items: center; min-width: 70px; cursor: pointer;";
        div.onclick = () => app.shareVideoInDM(uid);
        div.innerHTML = `
            <img src="${user.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" 
                 style="width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <span style="font-size: 11px; margin-top: 5px; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${user.name.split(' ')[0]}</span>
        `;
        rail.appendChild(div);
    }
},

closeShareMenu: () => {
    document.getElementById('share-modal-overlay').style.display = 'none';
},

// 2. SOCIAL REDIRECTS
copyVideoLink: () => {
    const videoId = state.clips[state.clipIndex].id;
    const link = `${window.location.origin}/?video=${videoId}`;
    navigator.clipboard.writeText(link);
    App.showToast("Link copied to clipboard!");
    app.closeShareMenu();
},

shareToWhatsApp: (type) => {
    const videoId = state.clips[state.clipIndex].id;
    const link = `${window.location.origin}/?video=${videoId}`;
    const text = encodeURIComponent(`Check out this video on Global Connect: ${link}`);
    const url = type === 'business' ? `https://wa.me/?text=${text}` : `whatsapp://send?text=${text}`;
    window.open(url, '_blank');
},

shareToApp: (platform) => {
    const videoId = state.clips[state.clipIndex].id;
    const link = `${window.location.origin}/?video=${videoId}`;
    App.showToast(`Opening ${platform}...`);
    window.open(`https://www.google.com/search?q=share+to+${platform}+${link}`, '_blank');
},

// 3. DEEP LINKING (Direct to Video)
// Add this inside your checkInviteLink logic
checkDeepLinks: async () => {
    const urlParams = new URLSearchParams(window.location.search);
    // 1. Check URL first, then check sessionStorage (saved from before login)
    const videoId = urlParams.get('video') || sessionStorage.getItem('pending_video_id');

    if (videoId) {
        // Clean up both the URL and Storage to prevent loops
        window.history.replaceState({}, document.title, "/");
        sessionStorage.removeItem('pending_video_id');

        // 2. SECURITY: If not logged in, save the ID and go to Auth
        if (!state.currentUser) {
            sessionStorage.setItem('pending_video_id', videoId);
            App.showToast("Login to view this clip");
            App.goToPage('auth-page');
            return;
        }

        // 3. LOAD THE VIDEO
        App.showToast("Loading clip...");
        try {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const videoSnap = await getDoc(doc(db, "videos", videoId));
            
            if (videoSnap.exists()) {
                const videoData = { id: videoSnap.id, ...videoSnap.data() };
                
                // Force state to only show this specific video
                state.clips = [videoData]; 
                state.clipIndex = 0;
                state.movieViewMode = 'discovery'; // Ensure nav bars show
                
                App.goToPage('movie-page');
                App.renderMovie();
            } else {
                App.showToast("Video no longer available");
                App.goToPage('chat-list-page');
            }
        } catch (e) { 
            console.error("Deep Link Error:", e);
            App.goToPage('chat-list-page');
        }
    }
 },

// 4. DM SHARING
shareVideoInDM: async (targetUid) => {
    const videoId = state.clips[state.clipIndex].id;
    const link = `${window.location.origin}/?video=${videoId}`;
    const originalChat = state.currentChatId;
    
    state.currentChatId = targetUid;
    await App.sendMessage(`ðŸŽ¬ Shared a video link: ${link}`);
    state.currentChatId = originalChat;
    
    App.showToast("Video shared in DM!");
    app.closeShareMenu();
 },
 // --- ðŸ” MOVIE SEARCH LOGIC ---
performGlobalSearch: () => {
    const query = document.getElementById('global-movie-search-input').value.trim();
    if (!query) return;

    App.showToast(`Searching for: ${query}`);
    // We will build the filtering/results logic here in the next step
},

// Add listener to show the 'X' clear button only when typing
initSearchListeners: () => {
    const input = document.getElementById('global-movie-search-input');
    const clearBtn = document.getElementById('clear-movie-search');
    
    if (input && clearBtn) {
        input.oninput = () => {
            clearBtn.style.display = input.value.length > 0 ? 'block' : 'none';
        };
        // Trigger search on 'Enter' key
        input.onkeypress = (e) => {
            if (e.key === 'Enter') App.performGlobalSearch();
        };
    }
 },
 // --- ðŸ“ˆ TRENDING & DISCOVERY ENGINE ---

loadTrendingVideos: async () => {
    const grid = document.getElementById('trending-video-grid');
    if (!grid) return;

    grid.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i></div>';

    try {
        const { collection, query, orderBy, limit, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // ðŸŒŸ TRENDING LOGIC: Sort by highest views first
        const q = query(collection(db, "videos"), orderBy("views", "desc"), limit(10));
        const snap = await getDocs(q);
        
        grid.innerHTML = "";
        
        if (snap.empty) {
            grid.innerHTML = '<p style="grid-column: span 2; text-align: center; color: gray;">No trends yet!</p>';
            return;
        }

        snap.forEach(docSnap => {
            const v = docSnap.data();
            const viewCount = App.formatLikeCount(v.views || 0);
            
            const div = document.createElement('div');
            div.style.cssText = "position: relative; aspect-ratio: 3/4; border-radius: 8px; overflow: hidden; background: #000; cursor: pointer;";
            div.onclick = () => App.playSpecificVideo(docSnap.id);
            
            div.innerHTML = `
                <video src="${v.videoUrl}#t=0.1" style="width: 100%; height: 100%; object-fit: cover;" muted playsinline></video>
                <div style="position: absolute; bottom: 8px; left: 8px; color: white; font-size: 11px; font-weight: bold; text-shadow: 0 1px 2px black;">
                    <i class="fa-solid fa-play"></i> ${viewCount}
                </div>
            `;
            grid.appendChild(div);
        });
    } catch (e) {
        console.error("Trending Error:", e);
        grid.innerHTML = '<p style="grid-column: span 2; text-align: center; color: red;">Failed to load trends</p>';
    }
},

// --- ðŸ” ACTIVE SEARCH FILTERING ---
performGlobalSearch: async () => {
    const input = document.getElementById('global-movie-search-input');
    const queryStr = input.value.trim().toLowerCase();
    
    const initialView = document.getElementById('initial-search-view');
    const resultsView = document.getElementById('search-results-view');
    const resultsList = document.getElementById('active-search-list');

    if (!queryStr) {
        initialView.classList.remove('hidden');
        resultsView.classList.add('hidden');
        return;
    }

    // Switch Views
    initialView.classList.add('hidden');
    resultsView.classList.remove('hidden');
    resultsList.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

    try {
        const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const snap = await getDocs(collection(db, "videos"));
        
        resultsList.innerHTML = "";
        let found = 0;

        snap.forEach(docSnap => {
            const v = docSnap.data();
            const caption = (v.caption || "").toLowerCase();
            
            // Filter by caption keywords
            if (caption.includes(queryStr)) {
                found++;
                const div = document.createElement('div');
                div.className = "list-item";
                div.style.cssText = "display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f9f9f9;";
                div.onclick = () => App.playSpecificVideo(docSnap.id);
                
                div.innerHTML = `
                    <img src="${v.videoUrl}#t=0.1" style="width: 50px; height: 50px; border-radius: 4px; object-fit: cover; background: #000;">
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-size: 14px; font-weight: 500; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">${v.caption}</div>
                        <div style="font-size: 12px; color: #8a8b91;">Video â€¢ ${App.formatLikeCount(v.views || 0)} views</div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: #ccc; font-size: 12px;"></i>
                `;
                resultsList.appendChild(div);
            }
        });

        if (found === 0) {
            resultsList.innerHTML = '<p style="text-align: center; color: gray; padding: 20px;">No results found for "' + queryStr + '"</p>';
        }
    } catch (e) { console.error(e); }
 },
 // --- ðŸ“ VIDEO POST LOGIC ---

// 1. Move from Preview to Metadata Page
openVideoPostSettings: () => {
    App.goToPage('video-post-page');
    
    // Generate a thumbnail preview from the video source
    const videoPreview = document.getElementById('upload-preview-player');
    const canvas = document.getElementById('video-thumbnail-preview');
    if (videoPreview && canvas) {
        const ctx = canvas.getContext('2d');
        canvas.width = videoPreview.videoWidth;
        canvas.height = videoPreview.videoHeight;
        ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
    }
},

insertTag: (tag) => {
    const input = document.getElementById('video-description-input');
    input.value += (input.value.endsWith(' ') || input.value === '' ? '' : ' ') + tag;
    input.focus();
},

handleFinalPost: async (event) => { 
    // ðŸŒŸ THE FIX: Accept the 'event' parameter to pass to the publisher
    const btn = document.getElementById('final-post-btn');
    const captionInput = document.getElementById('video-description-input');
    const caption = captionInput ? captionInput.value.trim() : "";
    
    // 1. UI Safety: Prevent multiple taps while processing
    if (btn.disabled) return;
    btn.disabled = true;
    btn.innerText = "Posting...";

    // 2. State Management: Store the custom caption
    state.pendingCaption = caption;

    // ðŸŒŸ 3. SAVE TEXT STYLES TO METADATA 
    // This captures what Kelvin typed and styled in the editor
    const previewEl = document.getElementById('preview-text-content');
    state.pendingTextMetadata = {
        content: state.textOverlay.content,
        color: previewEl ? previewEl.style.color : "#ffffff",
        background: previewEl ? previewEl.style.background : "transparent"
    };
    
    // 4. Trigger Publish: Pass the event object forward
    // This allows App.publishVideo to access the button via event.target
    await App.publishVideo(event); 
 },
 // --- âœ‚ï¸ VIDEO & MUSIC EDITING LOGIC ---

openTrimTool: () => {
    const video = document.getElementById('editor-preview');
    const handleStart = document.getElementById('handle-start');
    const handleEnd = document.getElementById('handle-end');
    const slider = document.getElementById('trim-slider');
    const timeline = document.getElementById('trim-timeline');

    if (!video || !timeline) return;

    // ðŸŒŸ DEFAULT VALUES ðŸŒŸ
    // Ensures that if Kelvin doesn't move the handles, the full video is saved/played
    state.trimStart = 0;
    state.trimEnd = video.duration;

    App.showToast("Drag handles to trim");

    // ðŸ› ï¸ Simple Drag Logic for Trimming
    const updateTrim = (handle, type) => {
        let isDragging = false;

        handle.onmousedown = handle.ontouchstart = (e) => {
            isDragging = true;
            e.preventDefault();
        };

        window.onmousemove = window.ontouchmove = (e) => {
            if (!isDragging) return;
            const rect = timeline.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            
            // Calculate percentage position (0.0 to 1.0)
            let pos = (clientX - rect.left) / rect.width;
            pos = Math.max(0, Math.min(1, pos));

            if (type === 'start') {
                state.trimStart = pos * video.duration;
                handle.style.left = (pos * 100) + "%";
                slider.style.left = (pos * 100) + "%";
            } else {
                state.trimEnd = pos * video.duration;
                handle.style.right = (100 - (pos * 100)) + "%";
                slider.style.right = (100 - (pos * 100)) + "%";
            }

            // Preview the cut instantly by seeking the video
            video.currentTime = type === 'start' ? state.trimStart : state.trimEnd;
        };

        window.onmouseup = window.ontouchend = () => { 
            isDragging = false; 
        };
    };

    // Initialize both handles
    updateTrim(handleStart, 'start');
    updateTrim(handleEnd, 'end');

    // ðŸ”„ Force the video to loop ONLY between the trim points during preview
    video.ontimeupdate = () => {
        if (video.currentTime >= state.trimEnd) {
            video.currentTime = state.trimStart;
        }
    };
 },

 // --- âŒ¨ï¸ TYPING STATUS ENGINE ---
handleTyping: () => {
    if (!state.currentChatId) return;

    const myUid = state.currentUser.uid;
    const chatId = state.currentChatId; // Assuming this is the Doc ID for the chat
    const chatRef = doc(db, "chats", chatId);

    // 1. Set typing to true in the database
    if (!state.isCurrentlyTyping) {
        state.isCurrentlyTyping = true;
        updateDoc(chatRef, { [`typing.${myUid}`]: true });
    }

    // 2. Clear previous timeout
    if (state.typingTimeout) clearTimeout(state.typingTimeout);

    // 3. Set timeout to clear typing status after 3 seconds of inactivity
    state.typingTimeout = setTimeout(() => {
        state.isCurrentlyTyping = false;
        updateDoc(chatRef, { [`typing.${myUid}`]: false });
    }, 3000);
 },
 // --- ðŸ› ï¸ Logic within App object ---
toggleFiltersUI: () => {
    const drawer = document.getElementById('filters-drawer');
    const modes = document.getElementById('camera-modes-container');
    
    if (drawer.style.display === 'none') {
        drawer.style.display = 'block';
        modes.style.display = 'none'; // Hide bottom labels while filtering
        app.renderFiltersList(); // Keep 'app.' prefix if calling from global object
    } else {
        drawer.style.display = 'none';
        modes.style.display = 'flex';
    }
},

renderFiltersList: () => {
    const list = document.getElementById('filters-scroll-list');
    list.innerHTML = state.filterPresets.map((f, index) => `
        <div class="filter-item" onclick="app.applyCameraFilter('${f.filter}', this)">
            <div class="filter-preview-circle">
                <img src="https://images.unsplash.com/photo-1580489944761-15a19d654956?w=100" 
                     style="width:100%; height:100%; object-fit:cover; filter: ${f.filter};">
            </div>
            <span class="filter-label">${f.name}</span>
        </div>
    `).join('');
},

applyCameraFilter: (filterCSS, element) => {
    const video = document.getElementById('camera-preview');
    const editorVid = document.getElementById('editor-preview');
    
    // Apply to UI
    if (video) video.style.filter = filterCSS;
    if (editorVid) editorVid.style.filter = filterCSS;

    // ðŸŒŸ THE FIX: Save the filter string to state for the database
    state.activeFilter = filterCSS; 

    document.querySelectorAll('.filter-item').forEach(el => el.classList.remove('active'));
    if (element) element.classList.add('active');
},
// --- ðŸ•’ INTEGRATED TIMER & EDITOR ENGINE ---

openCountdownDrawer: () => {
    document.getElementById('countdown-drawer').style.display = 'flex';
},

updateLimitLabel: (val) => {
    state.recordingLimit = parseInt(val);
    document.getElementById('limit-label').innerText = val + ".0s";
},

startCountdownSequence: () => {
    document.getElementById('countdown-drawer').style.display = 'none';
    const overlay = document.getElementById('countdown-overlay');
    const numEl = document.getElementById('countdown-number');
    overlay.style.display = 'flex';

    let count = state.countdownDuration;
    numEl.innerText = count;

    const timer = setInterval(() => {
        count--;
        if (count > 0) {
            numEl.innerText = count;
            if (navigator.vibrate) navigator.vibrate(50);
        } else {
            clearInterval(timer);
            overlay.style.display = 'none';
            // ðŸš€ TRIGGER ACTION
            App.triggerAutoAction(); 
        }
    }, 1000);
},

openPhotoInEditor: (imgSrc) => {
    App.goToPage('editor-page');
    const editorPreview = document.getElementById('editor-preview');
    // Hide video element, show img element (you may need to add an <img> tag to your editor-page HTML)
    editorPreview.style.display = 'none';
    
    let imgPreview = document.getElementById('editor-img-preview');
    if(!imgPreview) {
        imgPreview = document.createElement('img');
        imgPreview.id = 'editor-img-preview';
        imgPreview.style.cssText = "width:100%; height:100%; object-fit:contain;";
        editorPreview.parentElement.appendChild(imgPreview);
    }
    imgPreview.src = imgSrc;
    imgPreview.style.display = 'block';
    App.showToast("Edit your photo âœ¨");
},
 // --- ðŸ“¹ VIDEO RECORDING ENGINE (With Auto-Editor) ---

toggleRecording: async () => {
    const shutterBtn = document.getElementById('shutter-btn');
    const uploadPage = document.getElementById('upload-page');

    // --- ðŸ›‘ SCENARIO A: STOP RECORDING ---
    if (state.isRecordingVideo) {
        state.isRecordingVideo = false;
        state.videoRecorder.stop(); // ðŸŒŸ This triggers the onstop logic below
        
        // UI Reset
        if(shutterBtn) shutterBtn.parentElement.classList.remove('recording');
        if(uploadPage) uploadPage.classList.remove('recording-active');
        App.showToast("Processing video...");
        return;
    }

    // --- ðŸŸ¢ SCENARIO B: START RECORDING ---
    if (!state.cameraStream) {
        App.showToast("Camera not ready");
        return;
    }

    state.videoChunks = []; // Clear old data
    state.isRecordingVideo = true;

    // Initialize MediaRecorder
    // We use mp4 for standard compatibility across devices
    state.videoRecorder = new MediaRecorder(state.cameraStream, {
        mimeType: 'video/mp4' 
    });

    // 1. Data Handling: Capture video stream segments
    state.videoRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) state.videoChunks.push(e.data);
    };

    // ðŸŒŸ 2. THE FIX: SAVE TO STATE & AUTO-EDITOR ðŸŒŸ
    state.videoRecorder.onstop = () => {
        if (state.videoChunks.length > 0) {
            const blob = new Blob(state.videoChunks, { type: 'video/mp4' });
            
            // ðŸ›¡ï¸ CRITICAL FIX: Stashing the blob so the publisher can find it
            state.currentUploadFile = blob; 
            
            const videoUrl = URL.createObjectURL(blob);
            
            // Cleanup local chunks
            state.videoChunks = [];
            
            // ðŸš€ AUTO JUMP TO EDITOR
            App.openEditor(videoUrl); 
        } else {
            App.showToast("Recording failed: No data captured.");
        }
    };

    // 3. Visual Feedback: Enable "Live" recording styles
    if(shutterBtn) shutterBtn.parentElement.classList.add('recording');
    if(uploadPage) uploadPage.classList.add('recording-active');
    
    // 4. Start the Hardware
    state.videoRecorder.start();
    
    // Haptic Feedback for a premium feel
    if (navigator.vibrate) navigator.vibrate(100); 
    App.showToast("Recording...");
 },
 // --- ðŸŽµ MUSIC SYNC & VOLUME ENGINE ---

openMusicSync: () => {
    const drawer = document.getElementById('music-edit-drawer');
    const area = document.getElementById('added-music-control-area');
    drawer.style.display = 'flex';

    if (state.selectedMusicId) {
        // SCENARIO: Music is already added
        area.innerHTML = `
            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 10px; color: #8e8e93;">
                <span>Added sound (${state.selectedMusicName})</span>
                <span id="label-vol-added">100%</span>
            </div>
            <input type="range" id="vol-added-range" min="0" max="100" value="100" 
                   style="width: 100%; accent-color: #ff4b7d;" oninput="app.updateSoundVolumes()">
        `;
    } else {
        // SCENARIO: No music yet -> Show Add button
        area.innerHTML = `
            <button class="btn" style="background: #3a3a3c; color: white; width: 100%; border-radius: 8px; font-weight: bold;" 
                    onclick="app.openMusicPicker()">
                <i class="fa-solid fa-plus" style="margin-right: 8px;"></i> Add Sound
            </button>
        `;
    }
},

updateSoundVolumes: () => {
    const video = document.getElementById('editor-preview');
    const origRange = document.getElementById('vol-original-range');
    const addedRange = document.getElementById('vol-added-range');
    
    // 1. Update Original Sound (Video Element)
    const origVol = origRange.value / 100;
    video.volume = origVol;
    document.getElementById('label-vol-original').innerText = origRange.value + "%";

    // 2. Update Added Sound (YouTube Iframe)
    if (addedRange && state.selectedMusicId) {
        const addedVol = addedRange.value;
        document.getElementById('label-vol-added').innerText = addedVol + "%";
        
        // ðŸŒŸ Use postMessage to talk to your YouTube Bridge
        const frame = document.querySelector('#hidden-youtube-audio iframe');
        if (frame) {
            frame.contentWindow.postMessage(JSON.stringify({
                event: 'command',
                func: 'setVolume',
                args: [addedVol]
            }), '*');
        }
    }
},

closeMusicSync: () => {
    document.getElementById('music-edit-drawer').style.display = 'none';
    App.showToast("Volume levels saved");
},

// --- ðŸ•’ UPDATED: AUTO-ACTION LOGIC (Per your request) ---

triggerAutoAction: () => {
    if (state.recordingLimit === 0) {
        // ðŸ“¸ PATH 1: PHOTO
        App.autoCapturePhoto();
    } else {
        // ðŸ“¹ PATH 2: VIDEO (17s limit)
        App.autoRecordVideo();
    }
},

autoCapturePhoto: () => {
    const video = document.getElementById('camera-preview');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Pass captured image to editor
    App.openEditor(canvas.toDataURL('image/jpeg'), true); 
},

autoRecordVideo: () => {
    App.showToast(`Recording: 17s limit`);
    App.toggleRecording(); // Start
    
    setTimeout(() => {
        if (state.isRecordingVideo) {
            App.toggleRecording(); // Stop & auto-triggers editor
        }
    }, 17000); // ðŸŒŸ Changed to 17 seconds as requested
 },
// --- ðŸŽ¨ TEXT OVERLAY & EDITOR ENGINE ---

openEditorText: () => {
    const modal = document.getElementById('text-editor-modal');
    modal.style.display = 'flex';
    const input = document.getElementById('main-text-input');
    input.value = state.textOverlay.content;
    input.focus();
    App.renderTextColorPicker();
},

// ðŸŒŸ NEW: Fix for the "Clean" (Cancel) button
cancelTextEdit: () => {
    document.getElementById('text-editor-modal').style.display = 'none';
},

saveTextToVideo: () => {
    const text = document.getElementById('main-text-input').value.trim();
    const inputEl = document.getElementById('main-text-input');
    const preview = document.getElementById('text-overlay-preview');
    const content = document.getElementById('preview-text-content');
    
    state.textOverlay.content = text;

    if (text) {
        content.innerText = text;
        content.style.color = inputEl.style.color;
        content.style.background = inputEl.style.background;
        preview.style.display = 'block';
        preview.style.pointerEvents = 'auto'; // Enable dragging
        App.initTextDragging(); // ðŸš€ Start move logic
    } else {
        preview.style.display = 'none';
    }
    
    document.getElementById('text-editor-modal').style.display = 'none';
},

// ðŸŒŸ NEW: Movable Text Logic (Touch & Drag)
initTextDragging: () => {
    const el = document.getElementById('text-overlay-preview');
    let isDragging = false;
    let startPos = { x: 0, y: 0 };

    const onStart = (e) => {
        isDragging = true;
        const touch = e.touches ? e.touches[0] : e;
        startPos.x = touch.clientX - el.offsetLeft;
        startPos.y = touch.clientY - el.offsetTop;
        el.style.transition = 'none'; // Stop animations during drag
    };

    const onMove = (e) => {
        if (!isDragging) return;
        const touch = e.touches ? e.touches[0] : e;
        el.style.left = (touch.clientX - startPos.x) + 'px';
        el.style.top = (touch.clientY - startPos.y) + 'px';
        el.style.transform = 'translate(0, 0)'; // Clear the centering transform
    };

    const onEnd = () => {
        isDragging = false;
    };

    el.onmousedown = el.ontouchstart = onStart;
    window.onmousemove = window.ontouchmove = onMove;
    window.onmouseup = window.ontouchend = onEnd;
},

// Updated Cycling logic for the "A" button
cycleTextBackground: () => {
    state.textOverlay.bgMode = (state.textOverlay.bgMode + 1) % 3;
    const input = document.getElementById('main-text-input');
    const color = state.textOverlay.color;
    
    if (state.textOverlay.bgMode === 0) { // Text Only
        input.style.background = "transparent";
        input.style.color = color;
    } else if (state.textOverlay.bgMode === 1) { // Solid Background
        input.style.background = color;
        input.style.color = (color === '#ffffff' || color === '#ffeb3b') ? '#000000' : '#ffffff';
    } else { // Glass/Translucent
        input.style.background = color + "80"; // Add 50% transparency
        input.style.color = '#ffffff';
    }
},

renderTextColorPicker: () => {
    const colors = ['#ffffff', '#000000', '#ff4b7d', '#ffeb3b', '#4caf50', '#2196f3', '#9c27b0', '#ff5722'];
    const rail = document.getElementById('text-color-rail');
    rail.innerHTML = colors.map(c => `
        <div onclick="app.setTextStyleColor('${c}')" 
             style="width:30px; height:30px; border-radius:50%; background:${c}; border:2px solid ${state.textOverlay.color === c ? 'white' : 'transparent'}; cursor:pointer; flex-shrink:0;">
        </div>
    `).join('');
},

setTextStyleColor: (color) => {
    state.textOverlay.color = color;
    const input = document.getElementById('main-text-input');
    // Apply immediately to editor
    if (state.textOverlay.bgMode === 0) {
        input.style.color = color;
    } else {
        input.style.background = (state.textOverlay.bgMode === 2) ? color + "80" : color;
        input.style.color = (color === '#ffffff' || color === '#ffeb3b') ? '#000000' : '#ffffff';
    }
    App.renderTextColorPicker();
 },
 // --- ðŸ“± PROFILE TAB ENGINE ---

switchProfileTab: (tab) => {
    // 1. Toggle UI Colors
    const postsTab = document.getElementById('tab-my-videos');
    const likedTab = document.getElementById('tab-liked-videos');
    
    if(tab === 'liked') {
        likedTab.style.color = "#1a1a1a";
        postsTab.style.color = "#ccc";
        App.renderLikedVideos();
    } else {
        postsTab.style.color = "#1a1a1a";
        likedTab.style.color = "#ccc";
        App.openMyProfilePage(); // Reloads original posts
    }
},

renderLikedVideos: async () => {
    const grid = document.getElementById('my-video-grid');
    const myUid = state.currentUser.uid;
    grid.innerHTML = '<div style="grid-column: span 3; text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin"></i></div>';

    try {
        const { getDocs, collection, query, where } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        // ðŸŒŸ Query for all videos where MY UID is in the likes array
        const q = query(collection(db, "videos"), where("likes", "array-contains", myUid));
        const snap = await getDocs(q);
        
        grid.innerHTML = "";
        if (snap.empty) {
            grid.innerHTML = '<div style="grid-column: span 3; text-align:center; padding:50px; color:gray;">No liked videos yet â¤ï¸</div>';
            return;
        }

        snap.forEach(docSnap => {
            const v = docSnap.data();
            const item = document.createElement('div');
            item.className = "profile-video-item";
            item.onclick = () => {
                state.clips = [v]; // Focus on this video
                state.clipIndex = 0;
                App.goToPage('movie-page');
                App.renderMovie();
            };
            // #t=0.1 generates the thumbnail
            item.innerHTML = `
                <video src="${v.videoUrl}#t=0.1" muted playsinline></video>
                <div class="profile-video-stats"><i class="fa-solid fa-heart"></i> ${v.likes.length}</div>
            `;
            grid.appendChild(item);
        });
    } catch (e) {
        console.error("Liked Load Error:", e);
        grid.innerHTML = '<p style="padding:20px; color:red;">Failed to load likes.</p>';
    }
 },
 // --- ðŸ–¼ï¸ MULTI-IMAGE GESTURE ENGINE ---

initCarouselGestures: () => {
    const track = document.getElementById('image-slider-track');
    if (!track) return;

    let startX = 0;
    let isMoving = false;

    // 1. Capture where the finger first touches the screen
    track.ontouchstart = (e) => {
        startX = e.touches[0].clientX;
        isMoving = true;
        track.style.transition = 'none'; // Disable transition for instant feedback
    };

    // 2. Handle the swipe end
    track.ontouchend = (e) => {
        if (!isMoving) return;
        isMoving = false;
        
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX; // Positive = Swipe Left, Negative = Swipe Right
        const images = state.clips[state.clipIndex].images;
        const threshold = 50; // Minimum swipe distance to trigger a change

        track.style.transition = 'transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)';

        if (Math.abs(diff) > threshold) {
            if (diff > 0 && state.currentSlideIndex < images.length - 1) {
                // MOVE NEXT
                state.currentSlideIndex++;
            } else if (diff < 0 && state.currentSlideIndex > 0) {
                // MOVE PREVIOUS
                state.currentSlideIndex--;
            }
        }

        // 3. Physically move the track
        track.style.transform = `translateX(-${state.currentSlideIndex * 100}%)`;
        
        // 4. Update the visual Dots
        App.updateCarouselDots();
        
        // Light vibration for professional feel
        if (navigator.vibrate) navigator.vibrate(8);
    };
},

// Helper to update the dot indicators
updateCarouselDots: () => {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((dot, i) => {
        if (i === state.currentSlideIndex) {
            dot.style.background = 'white';
            dot.style.transform = 'scale(1.3)';
            dot.style.opacity = '1';
        } else {
            dot.style.background = 'rgba(255,255,255,0.4)';
            dot.style.transform = 'scale(1)';
            dot.style.opacity = '0.7';
        }
    });
 },
 // --- ðŸŽ® DISCORD ACTIVITY FRAME ENGINE ---

openGameFrame: (gameName) => {
    const frame = document.getElementById('discord-game-frame');
    frame.style.display = 'flex';
    
    // Set user data
    document.getElementById('game-frame-avatar').src = state.currentUser.photo;
    
    // ðŸŒŸ Reset Three.js Container
    document.getElementById('threejs-canvas-target').innerHTML = "";
    document.getElementById('game-start-modal').style.display = 'flex';
    
    // Light haptic entrance
    if (navigator.vibrate) navigator.vibrate(15);
},

closeGameFrame: () => {
    document.getElementById('discord-game-frame').style.display = 'none';
    // Logic to kill Three.js engine and save progress
},

inviteFriendsToGame: () => {
    // Uses native share to send a lobby link
    if (navigator.share) {
        navigator.share({
            title: 'Join my Combat Lobby!',
            text: 'I am playing Free Fire 3D. Join me in the Discord Activity!',
            url: window.location.href
        }).catch(err => console.log("Share failed", err));
    } else {
        App.showToast("Invite link copied to clipboard!");
    }
},

launchGame: (mode) => {
    document.getElementById('game-start-modal').style.display = 'none';
    App.showToast(`Launching ${mode}...`);
    
    // ðŸš€ Start your Three.js engine here
    // app.initThreeJsEngine('threejs-canvas-target');
 },
 // --- ðŸ“¹ DM VIDEO ENGINE (Cloudflare R2) ---

handleDMVideoUpload: async (input) => {
    const file = input.files[0];
    if (!file) return;

    const isViewOnce = state.isViewOnce; 
    App.showToast("Sending Video...");
    
    try {
        const fileKey = `dm_vid_${Date.now()}_${state.currentUser.uid}.mp4`;
        const workerUrl = `https://r2-media-manager.ozokelvin293.workers.dev/?key=${fileKey}`;
        
        // 1. Upload to R2 Basket
        const res = await fetch(workerUrl, {
            method: 'PUT',
            body: file,
            headers: { 'Content-Type': file.type }
        });

        if (!res.ok) throw new Error("Upload failed");

        const publicUrl = `https://pub-b9751f865fe143b6a091d53cc21895de.r2.dev/${fileKey}`;

        // ðŸŒŸ THE PROFESSIONAL FIX FOR THE SENDER:
        // Create a local blob URL so the sender sees their own video immediately
        const localPreviewUrl = window.URL.createObjectURL(file);
        
        // 2. Send the message to Firebase
        const msgId = "temp_" + Date.now(); // Firebase will replace this with a real ID
        
        // 3. Mark as ready locally for the SENDER so they don't need R2 anymore
        localStorage.setItem(`file_ready_${msgId}`, 'true');
        localStorage.setItem(`file_path_${msgId}`, localPreviewUrl);

        await App.sendMessage("ðŸŽ¥ Video", null, false, null, false, false, 'video', {
            url: publicUrl,
            r2Key: fileKey,
            viewOnce: isViewOnce,
            originalSenderId: state.currentUser.uid // Track who sent it
        });

        App.showToast("Sent! âœ…");

    } catch (e) {
        App.showToast("Upload failed");
    }
},

 toggleMsgVideo: (overlay) => {
    const container = overlay.parentElement;
    const video = container.querySelector('video');
    const icon = overlay.querySelector('i');

    if (video.paused) {
        video.play();
        overlay.style.background = "transparent";
        icon.style.display = "none";
    } else {
        video.pause();
        overlay.style.background = "rgba(0,0,0,0.2)";
        icon.style.display = "flex";
        icon.className = "fa-solid fa-play";
    }
    
    // Auto-reset when video ends
    video.onended = () => {
        overlay.style.background = "rgba(0,0,0,0.2)";
        icon.style.display = "flex";
        icon.className = "fa-solid fa-play";
    };
 },
 // --- ðŸ“¹ FULL-SCREEN VIDEO VIEWER ENGINE ---

openFullVideoPlayer: async (src, name, time, msgId, isViewOnce) => {
    // ðŸŒŸ 1. Save state for later cleanup
    state.activeViewOnce = isViewOnce ? { src, msgId } : null;
    const isNative = window.Capacitor && window.Capacitor.isNativePlatform();

    // ðŸ›¡ï¸ 2. NATIVE PROTECTION: Block Screenshots/Recording for View-Once
    if (isViewOnce && isNative) {
        try {
            const { PrivacyScreen } = await import('@capacitor/privacy-screen');
            await PrivacyScreen.enable(); 
            console.log("Privacy Shield: ACTIVATED");
        } catch (e) { 
            console.error("Privacy Plugin Error:", e); 
        }
    }

    // ðŸŽ¥ 3. Create the UI Overlay
    const overlay = document.createElement('div');
    overlay.id = 'video-viewer-overlay';
    overlay.className = 'image-viewer-overlay'; 
    overlay.style.zIndex = "10000";

    overlay.innerHTML = `
        <div class="viewer-header" style="background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); padding: 25px 20px;">
            <div class="viewer-left" style="display:flex; align-items:center; gap:15px;">
                <i class="fa-solid fa-arrow-left" onclick="App.closeVideoPlayer()" style="color:white; font-size:20px; cursor:pointer;"></i>
                <div class="viewer-meta">
                    <div class="viewer-name" style="color:white; font-weight:bold; font-size:16px;">${name}</div>
                    <div class="viewer-time" style="color:rgba(255,255,255,0.7); font-size:12px;">${time}</div>
                </div>
            </div>
            <div class="viewer-actions" style="color:white; font-size:18px;">
                <i class="fa-solid fa-ellipsis-vertical"></i>
            </div>
        </div>

        <div class="viewer-content" style="background: black; height: 100%; display:flex; align-items:center; justify-content:center;">
            <video id="full-player" src="${src}" style="width: 100%; max-height: 80vh; object-fit: contain;" controls autoplay playsinline></video>
        </div>

        ${isViewOnce ? `
        <div style="position: absolute; bottom: 60px; width: 100%; text-align: center; color: #fff; font-size: 13px; font-weight:500; text-shadow:0 1px 3px black;">
            <i class="fa-solid fa-shield-halved" style="color:#ff4b7d; margin-right:8px;"></i> Protected: Screenshots are disabled
        </div>` : ''}
    `;

    document.body.appendChild(overlay);

    const video = document.getElementById('full-player');
    
    // ðŸŒŸ Handle View-Once ending
    video.onended = () => {
        if (isViewOnce) {
            video.pause();
            App.showToast("Video finished. It will expire when you leave.");
        }
    };

    // Mobile Back-Button Support
    window.history.pushState({viewingVideo: true}, "");
    window.onpopstate = () => App.closeVideoPlayer();
},


closeVideoPlayer: async () => {
    const overlay = document.getElementById('video-viewer-overlay');
    if (!overlay) return;

    const isNative = window.Capacitor && window.Capacitor.isNativePlatform();

    // ðŸ”“ 1. RELEASE PROTECTION: Restore screenshot ability for the rest of the app
    if (state.activeViewOnce && isNative) {
        try {
            const { PrivacyScreen } = await import('@capacitor-community/privacy-screen');
            await PrivacyScreen.disable();
            console.log("Privacy Shield: DEACTIVATED");
        } catch (e) { 
            console.error("Privacy Shield release failed:", e); 
        }
    }

    const video = overlay.querySelector('video');
    if (video) video.pause(); 

    // ðŸ—‘ï¸ 2. CLOUD CLEANUP: Wipe from R2 if it was View-Once
    if (state.activeViewOnce) {
        const { msgId } = state.activeViewOnce;
        const history = DataManager.getMessages(state.currentChatId);
        const msgObj = history.find(m => m.id === msgId);
        
        if (msgObj && msgObj.pollData && msgObj.pollData.r2Key) {
            // Background trigger to clear R2 basket
            App.triggerR2Deletion(msgObj.pollData.r2Key, msgId);
        }
        state.activeViewOnce = null;
    }

    // ðŸ  3. UI Cleanup
    overlay.remove();
    window.onpopstate = null;
},


 triggerR2Deletion: async (fileKey, msgId) => {
    const workerUrl = `https://r2-media-manager.ozokelvin293.workers.dev/?key=${fileKey}`;

    try {
        // 1. Physically delete the file from your R2 storage basket via Worker
        const res = await fetch(workerUrl, { method: 'DELETE' });

        if (res.ok) {
            console.log(`R2 Freed: ${fileKey} deleted âœ…`);
            
            const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const chatId = state.currentChatId;
            // Determine path based on chat type (Direct Message vs Group/Channel)
            const path = chatId.startsWith('group_') || chatId.startsWith('channel_') ? `chats/${chatId}/messages` : `messages`;
            const msgRef = doc(db, path, msgId);

            // 2. Fetch fresh metadata to determine how to update the UI
            const snap = await getDoc(msgRef);
            if (!snap.exists()) return;
            const msgData = snap.data();

            // ðŸŒŸ THE LOGIC MERGE ðŸŒŸ
            // Default: Always wipe the cloud URL so it can't be fetched again from R2
            let dbUpdates = { 
                "pollData.url": null,
                "pollData.isLocalOnly": true 
            };

            // SCENARIO A: View-Once Media â€” Security requirement to block all viewing
            if (msgData.pollData?.viewOnce === true) {
                dbUpdates.type = "expired_video";
                dbUpdates.text = "ðŸš« Video has expired";
                dbUpdates["pollData.r2Key"] = null; // Wipe key for safety
            } 
            // SCENARIO B: Normal Media â€” Remove cloud link but leave type as 'video' or 'audio'
            else {
                // By NOT changing the type, the renderer continues to show the play button
                // using the local file stored on the user's phone.
                dbUpdates["pollData.isCloudCleared"] = true;
            }

            // 3. Update Firebase Database
            await updateDoc(msgRef, dbUpdates);

            // 4. Synchronize Local History for instant UI responsiveness
            const history = DataManager.getMessages(chatId);
            const msgIdx = history.findIndex(m => m.id === msgId);
            if (msgIdx !== -1) {
                if (msgData.pollData?.viewOnce === true) {
                    history[msgIdx].type = "expired_video";
                    history[msgIdx].text = "ðŸš« Video has expired";
                }
                history[msgIdx].pollData.url = null;
                history[msgIdx].pollData.isLocalOnly = true;
                localStorage.setItem(`chat_${chatId}`, JSON.stringify(history));
            }

            // 5. Refresh the UI to reflect the changes (e.g., hiding cloud-only indicators)
            App.renderMessages(chatId);

        } else {
            console.error("Cloudflare Worker rejected the deletion request.");
        }
    } catch (e) {
        console.error("Critical Deletion Error:", e);
    }
},


handleFileInteraction: async (msgId, url, fileName, r2Key, mediaType = 'document') => {
    // ðŸŒŸ 1. Check local device status
    const isLocal = localStorage.getItem(`file_ready_${msgId}`) === 'true';
    const btn = document.getElementById(`play-btn-${msgId}`);
    const isNative = window.Capacitor && window.Capacitor.isNativePlatform();

    // ðŸŒŸ 2. Get Metadata for View-Once & Sender Identity
    const history = DataManager.getMessages(state.currentChatId);
    const msgData = history.find(m => m.id === msgId);
    const isViewOnce = msgData?.pollData?.viewOnce === true;
    const isSender = msgData?.senderId === state.currentUser.uid;

    // --- CASE 1: ALREADY LOCAL (TRIGGER PLAY) ---
    if (isLocal) {
        const localPath = localStorage.getItem(`file_path_${msgId}`);
        if (mediaType === 'video') {
            App.openFullVideoPlayer(localPath, msgData?.senderName || "Video", msgData?.time || "Now", msgId, false);
        } else {
            App.playAudio(msgId, localPath);
        }
        return;
    }

    // --- CASE 2: VIEW-ONCE SPECIAL PATH (STREAM & DESTROY) ---
    if (isViewOnce && (mediaType === 'video' || mediaType === 'audio')) {
        App.showToast("Opening View-Once Media...");
        if (mediaType === 'video') {
            App.openFullVideoPlayer(url, msgData.senderName, msgData.time, msgId, true);
        } else {
            App.playAudio(msgId, url); 
        }
        return; 
    }

    // --- CASE 3: SILENT DOWNLOAD & PLAY (Default for Audio/Video/Files) ---
    if (btn) btn.className = "fa-solid fa-circle-notch fa-spin";

    try {
        // ðŸŒŸ UPDATED FETCH LOGIC WITH CORS SHIELD
        const response = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            headers: { 'Accept': 'audio/*, video/*' }
        });

        if (!response.ok) {
            // ðŸš« THE 404 EXPIRED HANDLER
            if (response.status === 404) {
                App.showToast("File expired from cloud storage ðŸš«");
                
                const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const chatId = state.currentChatId;
                const path = chatId.startsWith('group_') || chatId.startsWith('channel_') ? `chats/${chatId}/messages` : `messages`;
                
                await updateDoc(doc(db, path, msgId), {
                    type: "expired_media",
                    text: "ðŸš« This file has expired"
                });
                
                App.renderMessages(chatId);
                throw new Error("File no longer exists");
            }
            
            if (response.status === 403) throw new Error("Cloud access denied (Check CORS)");
            throw new Error(`Cloud Error: ${response.status}`);
        }

        const blob = await response.blob();
        let finalPath = "";

        const finalizeLocalSave = async (path) => {
            localStorage.setItem(`file_path_${msgId}`, path);
            localStorage.setItem(`file_ready_${msgId}`, 'true');

            // âœ… Wipe progress memory to prevent sticking at 100%
            if (state.downloadProgress) delete state.downloadProgress[msgId];

            // ðŸš€ TRIGGER ACTION
            if (mediaType === 'video') {
                App.openFullVideoPlayer(path, msgData?.senderName || "Video", "Now", msgId, false);
            } else {
                App.playAudio(msgId, path);
            }

            // Restore UI Icon
            if (btn) btn.className = "fa-solid fa-play";
            App.renderMessages(state.currentChatId);

            // â˜ï¸ CLOUD CLEANUP: ðŸŒŸ ONLY DELETE IF USER IS THE RECEIVER ðŸŒŸ
            // This ensures both users get a chance to download the local copy.
            const isGroup = state.currentChatId.startsWith('group_') || state.currentChatId.startsWith('channel_');
            if (r2Key && !isGroup && !isSender) {
                App.triggerR2Deletion(r2Key, msgId);
            }
            
            App.showToast("Media Saved Locally âœ…");
        };

        if (isNative) {
            // ðŸ“± MOBILE SAVING
            const { Filesystem, Directory } = await import('@capacitor/filesystem');
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const savedFile = await Filesystem.writeFile({
                    path: fileName,
                    data: base64Data,
                    directory: Directory.Data 
                });
                await finalizeLocalSave(savedFile.uri);
            };
        } else {
            // ðŸŒ WEB SAVING
            const localUrl = window.URL.createObjectURL(blob);
            await finalizeLocalSave(localUrl);
        }

    } catch (e) {
        console.error("Interaction Error:", e);
        if (btn) btn.className = "fa-solid fa-play";
        if (!e.message.includes("exists") && !e.message.includes("denied")) {
            App.showToast("Connection Error");
        }
    }
},


                         
            renderMatches: () => {
        const container = document.getElementById('matches-list-container');
        if (!container) return;

        // Get the list of people you liked
        let likes = DataManager.getLikes();

        // ðŸŒŸ THE PRIVATE FILTER: Get the list of hidden user IDs
        const hiddenChats = JSON.parse(localStorage.getItem('hidden_chats') || '[]');

        // Filter out any ID that is currently marked as "Private"
        const visibleLikes = likes.filter(id => id !== 'undefined' && !hiddenChats.includes(id));

        // Display "No matches" if the list is empty after filtering
        container.innerHTML = visibleLikes.length ? '' : 
            '<p style="grid-column: span 2; text-align: center; color: gray; margin-top: 20px;">No matches yet.</p>';

        visibleLikes.forEach(id => {
            container.innerHTML += `
                <div style="background: #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div style="height:150px; background:#eee; display:flex; align-items:center; justify-content:center; color:grey; font-size:40px;">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div style="padding: 10px; text-align: center; font-weight: bold;">Match</div>
                    <button class="btn btn-primary" style="width:100%; border-radius:0;" onclick="App.openChat('${id}', 'Match', '')">
                        Chat
                    </button>
                </div>`;
        });
    },

            clearLocalStorage: () => {
        // Warning before deleting everything
        if (confirm("Clear local data? This will remove all chat history and settings on this device.")) {
            DataManager.clear();
            alert("Storage cleared.");
            location.reload(); // Refresh the app to show landing page
        }
    },

        saveSettings: () => App.saveSettings(), 

                loadProfileData: async () => {
            const data = DataManager.getProfile();
            if(data && data.uid) {
                // ðŸŒŸ 1. Check if the Monthly Verification has expired
                await App.checkVerificationExpiry(data);

                // ðŸŒŸ 2. Re-fetch data in case the check updated the status
                const freshData = DataManager.getProfile();

                if(document.getElementById('edit-bio')) document.getElementById('edit-bio').value = freshData.bio || '';
                if(document.getElementById('edit-job')) document.getElementById('edit-job').value = freshData.job || '';
                if(document.getElementById('edit-company')) document.getElementById('edit-company').value = freshData.company || '';
                if(document.getElementById('edit-school')) document.getElementById('edit-school').value = freshData.school || '';
                if(document.getElementById('edit-city')) document.getElementById('edit-city').value = freshData.city || '';
                if(freshData.photo && document.getElementById('edit-profile-preview')) {
                    document.getElementById('edit-profile-preview').src = freshData.photo;
                }
            }
        }
    };

    // --- WEBRTC (VIDEO/VOICE CALLS) ---
    const webrtc = {
        pc: null, localStream: null, currentCallDocId: null, isVideo: true, isConnected: false,
        
        init: () => {
            const q = query(collection(db, 'calls'), where("calleeId", "==", state.currentUser.uid));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' && !change.doc.data().answer) {
                        webrtc.showIncomingCall(change.doc.id, change.doc.data());
                    }
                    if (change.type === 'removed') {
                        if (webrtc.currentCallDocId === change.doc.id) {
                            webrtc.hangUp(false); 
                        }
                    }
                });
            });
        },

        startCall: async (calleeId, video = true) => {
            if(!calleeId) return alert("Select a user to chat with first!");
            webrtc.isVideo = video;
            webrtc.isConnected = false;
            document.getElementById('call-status').innerText = video ? "Calling..." : "Calling...";
            document.getElementById('call-partner').innerText = state.currentChatPartner.name;
            document.getElementById('call-overlay').style.display = 'flex';
            
            webrtc.localStream = await navigator.mediaDevices.getUserMedia({ video: video, audio: true });
            document.getElementById('localVideo').srcObject = webrtc.localStream;
            if(!video) document.getElementById('localVideo').style.opacity = 0;

            webrtc.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });
            webrtc.localStream.getTracks().forEach(track => webrtc.pc.addTrack(track, webrtc.localStream));
            webrtc.pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

            const offer = await webrtc.pc.createOffer();
            await webrtc.pc.setLocalDescription(offer);

            const callDoc = doc(collection(db, 'calls'));
            webrtc.currentCallDocId = callDoc.id;
            await setDoc(callDoc, { callerId: state.currentUser.uid, calleeId: calleeId, offer: { type: offer.type, sdp: offer.sdp }, isVideo: video });

            webrtc.pc.onicecandidate = e => { if(e.candidate) addDoc(collection(callDoc, 'callerCandidates'), e.candidate.toJSON()); };

            onSnapshot(callDoc, async snapshot => {
                if (!snapshot.exists()) {
                    webrtc.hangUp(false);
                    return;
                }
                const data = snapshot.data();
                if (data && data.answer && !webrtc.pc.currentRemoteDescription) {
                    webrtc.isConnected = true;
                    document.getElementById('call-status').innerText = "Connected";
                    await webrtc.pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    onSnapshot(collection(callDoc, 'calleeCandidates'), snap => snap.docChanges().forEach(c => { if(c.type === 'added') webrtc.pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); }));
                }
            });
        },

        showIncomingCall: (callId, data) => {
            webrtc.currentCallDocId = callId;
            webrtc.isVideo = data.isVideo;
            webrtc.isConnected = false;
            document.getElementById('incoming-name').innerText = `${data.isVideo ? 'Video' : 'Voice'} call from...`;
            document.getElementById('incoming-call-modal').style.display = 'flex';
        },

        acceptCall: async () => {
            document.getElementById('incoming-call-modal').style.display = 'none';
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('call-status').innerText = "Connecting...";
            
            const callDoc = doc(db, 'calls', webrtc.currentCallDocId);
            const callData = (await getDoc(callDoc)).data();

            webrtc.localStream = await navigator.mediaDevices.getUserMedia({ video: webrtc.isVideo, audio: true });
            document.getElementById('localVideo').srcObject = webrtc.localStream;
            if(!webrtc.isVideo) document.getElementById('localVideo').style.opacity = 0;

            webrtc.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });
            webrtc.localStream.getTracks().forEach(track => webrtc.pc.addTrack(track, webrtc.localStream));
            webrtc.pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            webrtc.pc.onicecandidate = e => { if(e.candidate) addDoc(collection(callDoc, 'calleeCandidates'), e.candidate.toJSON()); };

            await webrtc.pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
            const answer = await webrtc.pc.createAnswer();
            await webrtc.pc.setLocalDescription(answer);
            await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp } });
            
            webrtc.isConnected = true;
            document.getElementById('call-status').innerText = "Connected";
            
            onSnapshot(collection(callDoc, 'callerCandidates'), snap => snap.docChanges().forEach(c => { if(c.type === 'added') webrtc.pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); }));
            onSnapshot(callDoc, snapshot => { if(!snapshot.exists()) webrtc.hangUp(false); });
        },

        rejectCall: () => {
            document.getElementById('incoming-call-modal').style.display = 'none';
            if(webrtc.currentCallDocId) deleteDoc(doc(db, 'calls', webrtc.currentCallDocId));
        },

        hangUp: (deleteDocFromDb = true) => {
            if(webrtc.localStream) webrtc.localStream.getTracks().forEach(track => track.stop());
            if(webrtc.pc) webrtc.pc.close();
            
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('incoming-call-modal').style.display = 'none'; 
            
            if(deleteDocFromDb && webrtc.currentCallDocId) {
                let msg = "";
                if(webrtc.isConnected) {
                    msg = webrtc.isVideo ? "ðŸ“¹ Video Call Ended" : "ðŸ“ž Voice Call Ended";
                } else {
                    msg = webrtc.isVideo ? "ðŸ“¹ Missed Video Call" : "ðŸ“ž Missed Voice Call";
                }
                
                App.sendMessage(msg, null, true);
                deleteDoc(doc(db, 'calls', webrtc.currentCallDocId));
            }
            
            webrtc.pc = null; 
            webrtc.localStream = null; 
            webrtc.currentCallDocId = null;
            webrtc.isConnected = false;
        },

        toggleAudio: () => {
            webrtc.localStream.getAudioTracks()[0].enabled = !webrtc.localStream.getAudioTracks()[0].enabled;
            document.getElementById('mic-icon').className = webrtc.localStream.getAudioTracks()[0].enabled ? 'fa-solid fa-microphone' : 'fa-solid fa-microphone-slash';
        },
        toggleVideo: () => {
            if(!webrtc.isVideo) return;
            webrtc.localStream.getVideoTracks()[0].enabled = !webrtc.localStream.getVideoTracks()[0].enabled;
            document.getElementById('cam-icon').className = webrtc.localStream.getVideoTracks()[0].enabled ? 'fa-solid fa-video' : 'fa-solid fa-video-slash';
        }
    };
      

// --- ðŸŒ GLOBAL WINDOW ASSIGNMENTS ---
// Connects your logic to the HTML 'onclick' events
window.app = App;
window.App = App;
window.webrtc = webrtc;
window.state = state;
window.auth = auth;

// --- ðŸš€ BOOST WIZARD MAPPINGS (With Pause Logic) ---
window.app.startBoost = () => { 
    // 1. Pause Logic: Set flag and clear the active status timer
    state.isStatusPaused = true; 
    if (state.storyTimer) clearTimeout(state.storyTimer);
    
    // 2. Visual Pause: Freeze the progress bar at its current width
    const fill = document.getElementById(`fill-${state.storyIndex}`);
    if (fill) {
        const currentWidth = window.getComputedStyle(fill).width;
        fill.style.transition = "none";
        fill.style.width = currentWidth;
    }

    // 3. Open the Wizard
    state.boostStep = 1; 
    App.goToPage('boost-wizard-page'); 
    BoostEngine.renderStep(); 
};

window.app.exitBoostWizard = () => {
    // Return to the viewer and resume playback
    App.goToPage('status-viewer-page');
    state.isStatusPaused = false;
    App.startStatusTimer(true); 
};

window.app.nextBoostStep = BoostEngine.nextStep;

window.app.prevBoostStep = () => { 
    if(state.boostStep > 1) { 
        state.boostStep--; 
        BoostEngine.renderStep(); 
    } 
};

window.app.selectBoostOption = (val, el) => { 
    // Context-aware selection
    if (state.boostStep === 1) state.boostData.goal = val;
    if (state.boostStep === 8) state.boostData.paymentMethod = val;

    // UI Feedback
    document.querySelectorAll('.boost-option').forEach(opt => opt.classList.remove('active'));
    el.classList.add('active');
    App.showToast("Selected: " + val); 
};

// --- ðŸ FINAL EXECUTION CALLS ---
// These trigger the start of the application
App.init();
App.initLanguage();
</script>
</body>
</html>
